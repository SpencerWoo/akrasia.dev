<!doctype html><html lang=en class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=zh-cn href=https://kubernetes.io/zh-cn/docs/tasks/><link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/tasks/><link rel=alternate hreflang=ja href=https://kubernetes.io/ja/docs/tasks/><link rel=alternate hreflang=fr href=https://kubernetes.io/fr/docs/tasks/><link rel=alternate hreflang=de href=https://kubernetes.io/de/docs/tasks/><link rel=alternate hreflang=es href=https://kubernetes.io/es/docs/tasks/><link rel=alternate hreflang=pt-br href=https://kubernetes.io/pt-br/docs/tasks/><link rel=alternate hreflang=id href=https://kubernetes.io/id/docs/tasks/><link rel=alternate hreflang=hi href=https://kubernetes.io/hi/docs/tasks/><link rel=alternate hreflang=pl href=https://kubernetes.io/pl/docs/tasks/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://kubernetes.io/docs/tasks/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>Tasks | Kubernetes</title><meta property="og:title" content="Tasks"><meta property="og:description" content="Production-Grade Container Orchestration"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/docs/tasks/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="Tasks"><meta itemprop=description content="Production-Grade Container Orchestration"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tasks"><meta name=twitter:description content="Production-Grade Container Orchestration"><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content="This section of the Kubernetes documentation contains pages that show how to do individual tasks. A task page shows how to do a single thing, typically by giving a short sequence of steps.
If you would like to write a task page, see Creating a Documentation Pull Request."><meta property="og:description" content="This section of the Kubernetes documentation contains pages that show how to do individual tasks. A task page shows how to do a single thing, typically by giving a short sequence of steps.
If you would like to write a task page, see Creating a Documentation Pull Request."><meta name=twitter:description content="This section of the Kubernetes documentation contains pages that show how to do individual tasks. A task page shows how to do a single thing, typically by giving a short sequence of steps.
If you would like to write a task page, see Creating a Documentation Pull Request."><meta property="og:url" content="https://kubernetes.io/docs/tasks/"><meta property="og:title" content="Tasks"><meta name=twitter:title content="Tasks"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/docs/>Documentation</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/blog/>Kubernetes Blog</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/training/>Training</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/partners/>Partners</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/community/>Community</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/case-studies/>Case Studies</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/docs/tasks/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/docs/tasks/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/docs/tasks/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/docs/tasks/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/docs/tasks/>v1.21</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/docs/tasks/>中文 (Chinese)</a>
<a class=dropdown-item href=/ko/docs/tasks/>한국어 (Korean)</a>
<a class=dropdown-item href=/ja/docs/tasks/>日本語 (Japanese)</a>
<a class=dropdown-item href=/fr/docs/tasks/>Français (French)</a>
<a class=dropdown-item href=/de/docs/tasks/>Deutsch (German)</a>
<a class=dropdown-item href=/es/docs/tasks/>Español (Spanish)</a>
<a class=dropdown-item href=/pt-br/docs/tasks/>Português (Portuguese)</a>
<a class=dropdown-item href=/id/docs/tasks/>Bahasa Indonesia</a>
<a class=dropdown-item href=/hi/docs/tasks/>हिन्दी (Hindi)</a>
<a class=dropdown-item href=/pl/docs/tasks/>Polski (Polish)</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/tasks/>Return to the regular view of this page</a>.</p></div><h1 class=title>Tasks</h1><ul><li>1: <a href=#pg-57bf66f59d9a642b82eebeabbc66470b>Install Tools</a></li><ul><li>1.1: <a href=#pg-37b6179f23c8ad977cb9daa6d2da748a>Install and Set Up kubectl on Linux</a></li><li>1.2: <a href=#pg-961fc70b732cb8df4fd11a3463b6545c>Install and Set Up kubectl on macOS</a></li><li>1.3: <a href=#pg-2cc93d3011d707aeb6564bab02048f7a>Install and Set Up kubectl on Windows</a></li><li>1.4: <a href=#pg-91639f08dfa86a6c88cf0099b2e097bc>Tools Included</a></li><ul><li>1.4.1: <a href=#pg-2d600cc8ec4dec69673b5f9577b6da22>bash auto-completion on Linux</a></li><li>1.4.2: <a href=#pg-68808b3ec5807517ed64fd8ae32a7d1b>bash auto-completion on macOS</a></li><li>1.4.3: <a href=#pg-643b1104b7b31ae10b173acfb447843a>fish auto-completion</a></li><li>1.4.4: <a href=#pg-d4ebbbe0a2ddce15850a36dfede9ba52>kubectl-convert overview</a></li><li>1.4.5: <a href=#pg-730f5a835775a8e94bd1c481d3f1a349>PowerShell auto-completion</a></li><li>1.4.6: <a href=#pg-b2d43b2ae3e8f26eefa83de2db4ba782>verify kubectl install</a></li><li>1.4.7: <a href=#pg-99d563e9521796074ba3ca7f15a613ce>What's next?</a></li><li>1.4.8: <a href=#pg-9ab27577326839cb4793fd670a916364>zsh auto-completion</a></li></ul></ul><li>2: <a href=#pg-34a810f1516ad9d99b2697e36e9b0d0f>Administer a Cluster</a></li><ul><li>2.1: <a href=#pg-8e16d69617b175d61e2e7a6e1642c9d6>Administration with kubeadm</a></li><ul><li>2.1.1: <a href=#pg-f62fba1de4084f3be070785757c8079c>Certificate Management with kubeadm</a></li><li>2.1.2: <a href=#pg-6134c5061298affa145ddb801b5c29da>Configuring a cgroup driver</a></li><li>2.1.3: <a href=#pg-98530eb3653d28fef34bff4543364aa7>Reconfiguring a kubeadm cluster</a></li><li>2.1.4: <a href=#pg-2e173356df5179cab9eec90a606f0aa4>Upgrading kubeadm clusters</a></li><li>2.1.5: <a href=#pg-e805c7d8d4ad6195cb82dbbc843bfc29>Upgrading Windows nodes</a></li></ul><li>2.2: <a href=#pg-adb6c52e773f4d890595e14a9251f59b>Migrating from dockershim</a></li><ul><li>2.2.1: <a href=#pg-b8acce0768c2f92cdb8eaa31e8072353>Changing the Container Runtime on a Node from Docker Engine to containerd</a></li><li>2.2.2: <a href=#pg-d81ef0973a7bb4813e1797a452864742>Migrate Docker Engine nodes from dockershim to cri-dockerd</a></li><li>2.2.3: <a href=#pg-d79db9ed1698f75ec5f2228987290e49>Find Out What Container Runtime is Used on a Node</a></li><li>2.2.4: <a href=#pg-c4b5bb78bc6c59690d21c44e41f12270>Troubleshooting CNI plugin-related errors</a></li><li>2.2.5: <a href=#pg-cbd252cc297e67c1b73a84d5882474fb>Check whether dockershim removal affects you</a></li><li>2.2.6: <a href=#pg-eb3e279a6c5e1224e744080a52ee3f28>Migrating telemetry and security agents from dockershim</a></li></ul><li>2.3: <a href=#pg-7743f043c43f7b12e8654e2227dbc658>Generate Certificates Manually</a></li><li>2.4: <a href=#pg-47be5dd51f686017f1766e6ec7aa6f41>Manage Memory, CPU, and API Resources</a></li><ul><li>2.4.1: <a href=#pg-337620c76587e4aeb32009cb23be46de>Configure Default Memory Requests and Limits for a Namespace</a></li><li>2.4.2: <a href=#pg-320af95e480962c538ebef7ae205845c>Configure Default CPU Requests and Limits for a Namespace</a></li><li>2.4.3: <a href=#pg-adb489b1ab985c9215657b0d4c6ae92b>Configure Minimum and Maximum Memory Constraints for a Namespace</a></li><li>2.4.4: <a href=#pg-a87cbd1f9379dac7a48ae320da68a9ad>Configure Minimum and Maximum CPU Constraints for a Namespace</a></li><li>2.4.5: <a href=#pg-fe3283559a3df299aae3ee00ecea2fad>Configure Memory and CPU Quotas for a Namespace</a></li><li>2.4.6: <a href=#pg-40e30a9209e0c9f4153707e43243e9d7>Configure a Pod Quota for a Namespace</a></li></ul><li>2.5: <a href=#pg-8c31aafd38fad5b0de0bd191758d6f93>Install a Network Policy Provider</a></li><ul><li>2.5.1: <a href=#pg-b4418905b0c14630e4e9cb1368241534>Use Antrea for NetworkPolicy</a></li><li>2.5.2: <a href=#pg-1239a77618c6278373832a142cd85519>Use Calico for NetworkPolicy</a></li><li>2.5.3: <a href=#pg-95039241255a31df196beaa405b68eba>Use Cilium for NetworkPolicy</a></li><li>2.5.4: <a href=#pg-505a0a6a7e6eff361bbb3be81c84b2e0>Use Kube-router for NetworkPolicy</a></li><li>2.5.5: <a href=#pg-2842eac98aa0e229a5c6755c4c83d2a7>Romana for NetworkPolicy</a></li><li>2.5.6: <a href=#pg-ac075c3fdfd0d41aa753cc70e42be064>Weave Net for NetworkPolicy</a></li></ul><li>2.6: <a href=#pg-e77685d5b88d2db5c7631a27b9472eea>Access Clusters Using the Kubernetes API</a></li><li>2.7: <a href=#pg-a8f6511197efcd7d0db80ade49620f9d>Advertise Extended Resources for a Node</a></li><li>2.8: <a href=#pg-966cd1cc69c69410d8698b3ac74abce2>Autoscale the DNS Service in a Cluster</a></li><li>2.9: <a href=#pg-2bffd7f3571cdd609bd97fb2e1bdb2fe>Change the default StorageClass</a></li><li>2.10: <a href=#pg-fbc9136f53eccd6eb8c80f4bbea3b8f4>Change the Reclaim Policy of a PersistentVolume</a></li><li>2.11: <a href=#pg-ce4cd28c8feb9faa783e79b48af37961>Cloud Controller Manager Administration</a></li><li>2.12: <a href=#pg-5e59f5575dce11fdaed640afdbeedfc1>Configure Quotas for API Objects</a></li><li>2.13: <a href=#pg-7127e6b7344b315b30b1ce8c4d8bfc55>Control CPU Management Policies on the Node</a></li><li>2.14: <a href=#pg-8060aed5bf1172fa62199a4c306a4cd1>Control Topology Management Policies on a node</a></li><li>2.15: <a href=#pg-3d0cd7d2f13d4759094f281504cf57b8>Customizing DNS Service</a></li><li>2.16: <a href=#pg-8bcf4aeb5bbb6d6969a146e5ab97557b>Debugging DNS Resolution</a></li><li>2.17: <a href=#pg-a3790dfb57271d13517e549dffa805b9>Declare Network Policy</a></li><li>2.18: <a href=#pg-9585dc0efb0450fd68728e7511754717>Developing Cloud Controller Manager</a></li><li>2.19: <a href=#pg-09cc2cf3e0f23a3996e6cb31dc4d867c>Enable Or Disable A Kubernetes API</a></li><li>2.20: <a href=#pg-6b4e7ca6586f448c8533a120c29bdd25>Encrypting Secret Data at Rest</a></li><li>2.21: <a href=#pg-4a02bcca41439e16655f43fa37c81da4>Guaranteed Scheduling For Critical Add-On Pods</a></li><li>2.22: <a href=#pg-b45f024608e1b367cdacb1fd9d77278a>IP Masquerade Agent User Guide</a></li><li>2.23: <a href=#pg-a02f35804917d7a269c38d7e2c475005>Limit Storage Consumption</a></li><li>2.24: <a href=#pg-a24171610b6ea75a142cb9c8c7882390>Migrate Replicated Control Plane To Use Cloud Controller Manager</a></li><li>2.25: <a href=#pg-56de8c25b1486599777034111645b803>Namespaces Walkthrough</a></li><li>2.26: <a href=#pg-c4d0832845adc92b7ccd54aed63fc932>Operating etcd clusters for Kubernetes</a></li><li>2.27: <a href=#pg-eec61e72c300dbfbf7302400ca966432>Reconfigure a Node's Kubelet in a Live Cluster</a></li><li>2.28: <a href=#pg-b64a1d2bb3f4ed9f7021134e09a75c36>Reserve Compute Resources for System Daemons</a></li><li>2.29: <a href=#pg-f6f3b8f9789fda4286bf410b8e108f69>Running Kubernetes Node Components as a Non-root User</a></li><li>2.30: <a href=#pg-b35b8ddb9bbc15620ce9636f4346c05c>Safely Drain a Node</a></li><li>2.31: <a href=#pg-12001be83d15fcd7f3242313a55777df>Securing a Cluster</a></li><li>2.32: <a href=#pg-f58763cc9447491b6c40f939a02d441d>Set Kubelet parameters via a config file</a></li><li>2.33: <a href=#pg-1e966f5d0540bbee0876f9d0d08d54dc>Share a Cluster with Namespaces</a></li><li>2.34: <a href=#pg-fe6b50655c29ab0b7c1ee549ff64c138>Upgrade A Cluster</a></li><li>2.35: <a href=#pg-4e9de5bc3973e5d2bb8f09ff940c3319>Use Cascading Deletion in a Cluster</a></li><li>2.36: <a href=#pg-669c88964b4a9eb2b040057266e4b60d>Using a KMS provider for data encryption</a></li><li>2.37: <a href=#pg-e1afcdac8d5e8458274b3c481c5ebcda>Using CoreDNS for Service Discovery</a></li><li>2.38: <a href=#pg-9ceed97f912df7289ed8872e290cfbad>Using NodeLocal DNSCache in Kubernetes Clusters</a></li><li>2.39: <a href=#pg-fe5ad73163d38596340536ec03a205f0>Using sysctls in a Kubernetes Cluster</a></li><li>2.40: <a href=#pg-778055e4a4415ca195169b42cd42ddf9>Utilizing the NUMA-aware Memory Manager</a></li><li>2.41: <a href=#pg-096540b253fc2fdc306a85eb3ecf4885>Verify Signed Container Images</a></li></ul><li>3: <a href=#pg-f5da33b976758a9183018c421eb83f58>Configure Pods and Containers</a></li><ul><li>3.1: <a href=#pg-e6dd9300cf3a955f7cdfe77fb5d15292>Assign Memory Resources to Containers and Pods</a></li><li>3.2: <a href=#pg-8555af270ae7122cc0464bab3f5d1609>Assign CPU Resources to Containers and Pods</a></li><li>3.3: <a href=#pg-aa522472483f900008124a2809f2114b>Configure GMSA for Windows Pods and containers</a></li><li>3.4: <a href=#pg-f5da7517bee8a8807431d9fc65263b39>Configure RunAsUserName for Windows pods and containers</a></li><li>3.5: <a href=#pg-3fbf113e9e5f4b46f8ccb91a048509c0>Create a Windows HostProcess Pod</a></li><li>3.6: <a href=#pg-904cea8c8efd5c0d33adbfe579ec2dd2>Configure Quality of Service for Pods</a></li><li>3.7: <a href=#pg-4219ac6ab56a3b88d20305083d57d03c>Assign Extended Resources to a Container</a></li><li>3.8: <a href=#pg-484833fb880d1e179cc2965d15f84da5>Configure a Pod to Use a Volume for Storage</a></li><li>3.9: <a href=#pg-528d2422215cb9632b7b45e886b023b5>Configure a Pod to Use a PersistentVolume for Storage</a></li><li>3.10: <a href=#pg-4621938ba53c04a77f51b5938a583439>Configure a Pod to Use a Projected Volume for Storage</a></li><li>3.11: <a href=#pg-abd895c0803315e9717e6ff9ec4e3d30>Configure a Security Context for a Pod or Container</a></li><li>3.12: <a href=#pg-2c0d882359718c4c69c67099bed2156c>Configure Service Accounts for Pods</a></li><li>3.13: <a href=#pg-d385b86a7cb496d3b1c3b2a47280ca70>Pull an Image from a Private Registry</a></li><li>3.14: <a href=#pg-eb54daf87df373096b5e830680194dfc>Configure Liveness, Readiness and Startup Probes</a></li><li>3.15: <a href=#pg-bbc17480da6d051c696489654c64064a>Assign Pods to Nodes</a></li><li>3.16: <a href=#pg-fc3f4777ae8ea685d2b54e175277ac01>Assign Pods to Nodes using Node Affinity</a></li><li>3.17: <a href=#pg-1e7baac1825631a5af5d2aebcf059249>Configure Pod Initialization</a></li><li>3.18: <a href=#pg-efbc43486296f0439d1a89c12d944d94>Attach Handlers to Container Lifecycle Events</a></li><li>3.19: <a href=#pg-ed34e761c3dbd00fa79577fa78e30020>Configure a Pod to Use a ConfigMap</a></li><li>3.20: <a href=#pg-3d7b9cb24a647c36ba63f7a02ec49010>Share Process Namespace between Containers in a Pod</a></li><li>3.21: <a href=#pg-18935633a984586fbb68b727f3f339bb>Use a User Namespace With a Pod</a></li><li>3.22: <a href=#pg-42a59b878d4c58e5c6f4bb87483dda93>Create static Pods</a></li><li>3.23: <a href=#pg-1bb997c61a85de753d9994e7a312a291>Translate a Docker Compose File to Kubernetes Resources</a></li><li>3.24: <a href=#pg-108be708e50a97cae1cc0b67d5f360b7>Enforce Pod Security Standards by Configuring the Built-in Admission Controller</a></li><li>3.25: <a href=#pg-9c9966a13899846a35113763603cd6db>Enforce Pod Security Standards with Namespace Labels</a></li><li>3.26: <a href=#pg-0a91fdc1445a8c7f3563c41a9b9b3370>Migrate from PodSecurityPolicy to the Built-In PodSecurity Admission Controller</a></li></ul><li>4: <a href=#pg-61e6bd39c782b924943d60fc8387afe4>Monitoring, Logging, and Debugging</a></li><ul><li>4.1: <a href=#pg-4a26f4e7f9ffe4b86dea8b77906d3d5c>Troubleshooting Applications</a></li><ul><li>4.1.1: <a href=#pg-abb72792fa997869a6d241ca28ea225e>Debug Pods</a></li><li>4.1.2: <a href=#pg-68c4fd0542b7d39f8d36435ef83bd57b>Debug Services</a></li><li>4.1.3: <a href=#pg-089001d4003f033e21602adcb11cd277>Debug a StatefulSet</a></li><li>4.1.4: <a href=#pg-655b47c523b6f1b52d25e520625abccb>Determine the Reason for Pod Failure</a></li><li>4.1.5: <a href=#pg-43445f3208669d4078e87dbdbeed8473>Debug Init Containers</a></li><li>4.1.6: <a href=#pg-132acc7efbd72bd677945eda3b6c6d38>Debug Running Pods</a></li><li>4.1.7: <a href=#pg-09530217eead8a801ead3ef165c2f591>Get a Shell to a Running Container</a></li></ul><li>4.2: <a href=#pg-ce321f5c35198a1d9b64d52a98ba705c>Troubleshooting Clusters</a></li><ul><li>4.2.1: <a href=#pg-5ff0cdcf7701f887e45d629f5cfe0424>Resource metrics pipeline</a></li><li>4.2.2: <a href=#pg-cb9e28c208c6cfbabdb15ba2e42e9ef0>Tools for Monitoring Resources</a></li><li>4.2.3: <a href=#pg-20165c8269bed123bfb94fb6e7f85643>Monitor Node Health</a></li><li>4.2.4: <a href=#pg-6ca4f22ef4d1713577ada4815f0a3b5a>Debugging Kubernetes nodes with crictl</a></li><li>4.2.5: <a href=#pg-38387ad04dd284933cb502944ea3515b>Auditing</a></li><li>4.2.6: <a href=#pg-60dca0ec8d41f0045e7d73e1d6bd7bce>Developing and debugging services locally using telepresence</a></li><li>4.2.7: <a href=#pg-34f51c9306a166418b33355c09e672be>Windows debugging tips</a></li></ul></ul><li>5: <a href=#pg-aa0731e8aa8e2f6cc9e3c1a5e9895863>Manage Kubernetes Objects</a></li><ul><li>5.1: <a href=#pg-df206392be6f4d19bd8da41cee7170fa>Declarative Management of Kubernetes Objects Using Configuration Files</a></li><li>5.2: <a href=#pg-11aa6950fcb203094823c8e2cbdd517f>Declarative Management of Kubernetes Objects Using Kustomize</a></li><li>5.3: <a href=#pg-80c83fe9b80d0fef2681c8d59c0aa197>Managing Kubernetes Objects Using Imperative Commands</a></li><li>5.4: <a href=#pg-b18886277c410fc6f32ce068e2160537>Imperative Management of Kubernetes Objects Using Configuration Files</a></li><li>5.5: <a href=#pg-d4d4414dc91b63cfe0f65ca4f0c2fe31>Update API Objects in Place Using kubectl patch</a></li></ul><li>6: <a href=#pg-94f49ece137035764368f22a98942872>Managing Secrets</a></li><ul><li>6.1: <a href=#pg-0ed63ce3c9665aed7ff5a560ff1da843>Managing Secrets using kubectl</a></li><li>6.2: <a href=#pg-e841cf91fd3566db1e86143ed7a9e13c>Managing Secrets using Configuration File</a></li><li>6.3: <a href=#pg-a0ff2e3ba8af5670d5dc3d94c4bd0a68>Managing Secrets using Kustomize</a></li></ul><li>7: <a href=#pg-866924fa095f897ede8dfdcab9e97942>Inject Data Into Applications</a></li><ul><li>7.1: <a href=#pg-c9af1e81bb6e109f6c41febe44f0931b>Define a Command and Arguments for a Container</a></li><li>7.2: <a href=#pg-eff97c25c917cdb414eda016df0e2bca>Define Dependent Environment Variables</a></li><li>7.3: <a href=#pg-82c93897176489678232542102daea40>Define Environment Variables for a Container</a></li><li>7.4: <a href=#pg-66c0456fdbef5e5116dd606d1e6f73cc>Expose Pod Information to Containers Through Environment Variables</a></li><li>7.5: <a href=#pg-bcf93d1cd019501fd0b7649e9fbcaf60>Expose Pod Information to Containers Through Files</a></li><li>7.6: <a href=#pg-7f9454a1e775548c23ee5b300a9218a3>Distribute Credentials Securely Using Secrets</a></li></ul><li>8: <a href=#pg-a78a5e7e765fd8c49c8f7c0d72499f72>Run Applications</a></li><ul><li>8.1: <a href=#pg-790ea02857492b3a822e981e93e3a98b>Run a Stateless Application Using a Deployment</a></li><li>8.2: <a href=#pg-43398a6f5dc7ce19df59f5f4c2e7922d>Run a Single-Instance Stateful Application</a></li><li>8.3: <a href=#pg-95b3d561509c573e53bec2368264cf6a>Run a Replicated Stateful Application</a></li><li>8.4: <a href=#pg-7a9b5779e228083ba3fdeaf414fe704e>Scale a StatefulSet</a></li><li>8.5: <a href=#pg-c43537b0ee1da992ecb7488f87e6c934>Delete a StatefulSet</a></li><li>8.6: <a href=#pg-f5f2f7a74377a9d45325c5253353fa8f>Force Delete StatefulSet Pods</a></li><li>8.7: <a href=#pg-0c0bb1bd76d2a9069e50e2cec6d20c2a>Horizontal Pod Autoscaling</a></li><li>8.8: <a href=#pg-8138226ce9660ac8e3e82ff86fff8ad2>HorizontalPodAutoscaler Walkthrough</a></li><li>8.9: <a href=#pg-fbe2744f00d1aa4df4cdf4eea6a082d4>Specifying a Disruption Budget for your Application</a></li><li>8.10: <a href=#pg-52cd10ee3fc7c74a6c31043a2d489878>Accessing the Kubernetes API from a Pod</a></li></ul><li>9: <a href=#pg-ca3bc4e31dfe46d5044a3b93eb804ee9>Run Jobs</a></li><ul><li>9.1: <a href=#pg-964bdff888520740e5e221695245678d>Running Automated Tasks with a CronJob</a></li><li>9.2: <a href=#pg-1058efa4d70f13c015e6a2094ff85068>Coarse Parallel Processing Using a Work Queue</a></li><li>9.3: <a href=#pg-457c9dd93aed2b05615ed28dc38075d3>Fine Parallel Processing Using a Work Queue</a></li><li>9.4: <a href=#pg-9e63850014876afaebd1561f70bb8f6b>Indexed Job for Parallel Processing with Static Work Assignment</a></li><li>9.5: <a href=#pg-d65c40e1d2df81b94a09634c2432b055>Job with Pod-to-Pod Communication</a></li><li>9.6: <a href=#pg-da7c2b067953d239eb4457e8978ad8f6>Parallel Processing using Expansions</a></li><li>9.7: <a href=#pg-ecb5ec00bbce2e57292c6687437beae0>Handling retriable and non-retriable pod failures with Pod failure policy</a></li></ul><li>10: <a href=#pg-b74b959f5a531003dd0653dfbfc2e88b>Access Applications in a Cluster</a></li><ul><li>10.1: <a href=#pg-777447042cd4e81df3fa5beb3357a485>Deploy and Access the Kubernetes Dashboard</a></li><li>10.2: <a href=#pg-6a8d9e9e05f2b6825afbb8889c957370>Accessing Clusters</a></li><li>10.3: <a href=#pg-5a233e14205d77fe1294917d2da6f876>Configure Access to Multiple Clusters</a></li><li>10.4: <a href=#pg-72d3dddbc0c166c9a364e753d2b31ff0>Use Port Forwarding to Access Applications in a Cluster</a></li><li>10.5: <a href=#pg-312f29f850826b74618634cd877aa065>Use a Service to Access an Application in a Cluster</a></li><li>10.6: <a href=#pg-f3dac629bea950fc026d920306f09fb4>Connect a Frontend to a Backend Using Services</a></li><li>10.7: <a href=#pg-21cd8f87563675fb0278d3694ba9ecb0>Create an External Load Balancer</a></li><li>10.8: <a href=#pg-48e8f306f919c5b81265e265a2b76ab4>List All Container Images Running in a Cluster</a></li><li>10.9: <a href=#pg-1839d8468a083839ed1cc8d18fe1142e>Set up Ingress on Minikube with the NGINX Ingress Controller</a></li><li>10.10: <a href=#pg-7c319a9981586e5fbcfa21b392720650>Communicate Between Containers in the Same Pod Using a Shared Volume</a></li><li>10.11: <a href=#pg-322786b38586b210fab68f785259c5f6>Configure DNS for a Cluster</a></li><li>10.12: <a href=#pg-43591bb11cc02c39e278cf07f6546810>Access Services Running on Clusters</a></li></ul><li>11: <a href=#pg-11a6d16334428909c99e7208ab8fa5e9>Extend Kubernetes</a></li><ul><li>11.1: <a href=#pg-2bd28753e62a14a597073fa8ea18a5d8>Configure the Aggregation Layer</a></li><li>11.2: <a href=#pg-8f1f7f0d3a1cc21537506bd4f9103a29>Use Custom Resources</a></li><ul><li>11.2.1: <a href=#pg-dc64883f1fd119402b112d3ff6733452>Extend the Kubernetes API with CustomResourceDefinitions</a></li><li>11.2.2: <a href=#pg-7d2e2400f208b1637530752794e5a3bd>Versions in CustomResourceDefinitions</a></li></ul><li>11.3: <a href=#pg-c4798e42eaccc051e396542befb3c57b>Set up an Extension API Server</a></li><li>11.4: <a href=#pg-c00a2767fac9dbfafce583cf489cc423>Configure Multiple Schedulers</a></li><li>11.5: <a href=#pg-1707517970dd390995f760308c2e2de6>Use an HTTP Proxy to Access the Kubernetes API</a></li><li>11.6: <a href=#pg-46417c7cdd2da2c530aaeddca1861e5c>Use a SOCKS5 Proxy to Access the Kubernetes API</a></li><li>11.7: <a href=#pg-61cf1f2f0fbe98e7635fce65f04a775f>Set up Konnectivity service</a></li></ul><li>12: <a href=#pg-d3c88a8663f58e9ec0bed73faff5b670>TLS</a></li><ul><li>12.1: <a href=#pg-1272b18ac0c008f6ffc2c62a29fa929f>Configure Certificate Rotation for the Kubelet</a></li><li>12.2: <a href=#pg-9a87de8ee8332cb487f34a05debb1125>Manage TLS Certificates in a Cluster</a></li><li>12.3: <a href=#pg-43d5e2b1fc2a7e104e66d481d08578dc>Manual Rotation of CA Certificates</a></li></ul><li>13: <a href=#pg-ba58efa15c6d46f10e34d799be220965>Manage Cluster Daemons</a></li><ul><li>13.1: <a href=#pg-bcfd795e4b59420f7db275a0482af37c>Perform a Rolling Update on a DaemonSet</a></li><li>13.2: <a href=#pg-f1bf7e426f482a85e1a417d1fd9ea7b7>Perform a Rollback on a DaemonSet</a></li></ul><li>14: <a href=#pg-a701e71f3b32dae474c63ae4c596c856>Networking</a></li><ul><li>14.1: <a href=#pg-2edb5b02ea1e646c333c9fe4d5f02ff1>Adding entries to Pod /etc/hosts with HostAliases</a></li><li>14.2: <a href=#pg-eebac062766222247063d6513f95c7b2>Validate IPv4/IPv6 dual-stack</a></li></ul><li>15: <a href=#pg-0c4484d31ad3902880897e694bbd306f>Configure a kubelet image credential provider</a></li><li>16: <a href=#pg-f34d6e348a8e677d6c6eb155cd1a99aa>Extend kubectl with plugins</a></li><li>17: <a href=#pg-fdfb2a2cba62a1e624897eaebac0168e>Manage HugePages</a></li><li>18: <a href=#pg-5ab7bc7f14942c5c4b29d19f4a87271c>Schedule GPUs</a></li></ul><div class=content><p>This section of the Kubernetes documentation contains pages that
show how to do individual tasks. A task page shows how to do a
single thing, typically by giving a short sequence of steps.</p><p>If you would like to write a task page, see
<a href=/docs/contribute/new-content/open-a-pr/>Creating a Documentation Pull Request</a>.</p></div></div><div class=td-content><h1 id=pg-57bf66f59d9a642b82eebeabbc66470b>1 - Install Tools</h1><div class=lead>Set up Kubernetes tools on your computer.</div><h2 id=kubectl>kubectl</h2><p>The Kubernetes command-line tool, <a href=/docs/reference/kubectl/kubectl/>kubectl</a>, allows
you to run commands against Kubernetes clusters.
You can use kubectl to deploy applications, inspect and manage cluster resources,
and view logs. For more information including a complete list of kubectl operations, see the
<a href=/docs/reference/kubectl/><code>kubectl</code> reference documentation</a>.</p><p>kubectl is installable on a variety of Linux platforms, macOS and Windows.
Find your preferred operating system below.</p><ul><li><a href=/docs/tasks/tools/install-kubectl-linux>Install kubectl on Linux</a></li><li><a href=/docs/tasks/tools/install-kubectl-macos>Install kubectl on macOS</a></li><li><a href=/docs/tasks/tools/install-kubectl-windows>Install kubectl on Windows</a></li></ul><h2 id=kind>kind</h2><p><a href=https://kind.sigs.k8s.io/docs/><code>kind</code></a> lets you run Kubernetes on
your local computer. This tool requires that you have
<a href=https://docs.docker.com/get-docker/>Docker</a> installed and configured.</p><p>The kind <a href=https://kind.sigs.k8s.io/docs/user/quick-start/>Quick Start</a> page
shows you what you need to do to get up and running with kind.</p><p><a class="btn btn-primary" href=https://kind.sigs.k8s.io/docs/user/quick-start/ role=button aria-label="View kind Quick Start Guide">View kind Quick Start Guide</a></p><h2 id=minikube>minikube</h2><p>Like <code>kind</code>, <a href=https://minikube.sigs.k8s.io/><code>minikube</code></a> is a tool that lets you run Kubernetes
locally. <code>minikube</code> runs a single-node Kubernetes cluster on your personal
computer (including Windows, macOS and Linux PCs) so that you can try out
Kubernetes, or for daily development work.</p><p>You can follow the official
<a href=https://minikube.sigs.k8s.io/docs/start/>Get Started!</a> guide if your focus is
on getting the tool installed.</p><p><a class="btn btn-primary" href=https://minikube.sigs.k8s.io/docs/start/ role=button aria-label="View minikube Get Started! Guide">View minikube Get Started! Guide</a></p><p>Once you have <code>minikube</code> working, you can use it to
<a href=/docs/tutorials/hello-minikube/>run a sample application</a>.</p><h2 id=kubeadm>kubeadm</h2><p>You can use the <a class=glossary-tooltip title='A tool for quickly installing Kubernetes and setting up a secure cluster.' data-toggle=tooltip data-placement=top href=/docs/admin/kubeadm/ target=_blank aria-label=kubeadm>kubeadm</a> tool to create and manage Kubernetes clusters.
It performs the actions necessary to get a minimum viable, secure cluster up and running in a user friendly way.</p><p><a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>Installing kubeadm</a> shows you how to install kubeadm.
Once installed, you can use it to <a href=/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/>create a cluster</a>.</p><p><a class="btn btn-primary" href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/ role=button aria-label="View kubeadm Install Guide">View kubeadm Install Guide</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-37b6179f23c8ad977cb9daa6d2da748a>1.1 - Install and Set Up kubectl on Linux</h1><h2 id=before-you-begin>Before you begin</h2><p>You must use a kubectl version that is within one minor version difference of your cluster. For example, a v1.25 client can communicate with v1.24, v1.25, and v1.26 control planes.
Using the latest compatible version of kubectl helps avoid unforeseen issues.</p><h2 id=install-kubectl-on-linux>Install kubectl on Linux</h2><p>The following methods exist for installing kubectl on Linux:</p><ul><li><a href=#install-kubectl-binary-with-curl-on-linux>Install kubectl binary with curl on Linux</a></li><li><a href=#install-using-native-package-management>Install using native package management</a></li><li><a href=#install-using-other-package-management>Install using other package management</a></li></ul><h3 id=install-kubectl-binary-with-curl-on-linux>Install kubectl binary with curl on Linux</h3><ol><li><p>Download the latest release with the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/linux/amd64/kubectl&#34;</span>
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>To download a specific version, replace the <code>$(curl -L -s https://dl.k8s.io/release/stable.txt)</code> portion of the command with the specific version.</p><p>For example, to download version v1.25.0 on Linux, type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO https://dl.k8s.io/release/v1.25.0/bin/linux/amd64/kubectl
</span></span></code></pre></div></div></li><li><p>Validate the binary (optional)</p><p>Download the kubectl checksum file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/linux/amd64/kubectl.sha256&#34;</span>
</span></span></code></pre></div><p>Validate the kubectl binary against the checksum file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#a2f;font-weight:700>$(</span>cat kubectl.sha256<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>  kubectl&#34;</span> | sha256sum --check
</span></span></code></pre></div><p>If valid, the output is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl: OK
</span></span></span></code></pre></div><p>If the check fails, <code>sha256</code> exits with nonzero status and prints output similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl: FAILED
</span></span><span style=display:flex><span>sha256sum: WARNING: <span style=color:#666>1</span> computed checksum did NOT match
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Download the same version of the binary and checksum.</div></li><li><p>Install kubectl</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo install -o root -g root -m <span style=color:#666>0755</span> kubectl /usr/local/bin/kubectl
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>If you do not have root access on the target system, you can still install kubectl to the <code>~/.local/bin</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x kubectl
</span></span><span style=display:flex><span>mkdir -p ~/.local/bin
</span></span><span style=display:flex><span>mv ./kubectl ~/.local/bin/kubectl
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># and then append (or prepend) ~/.local/bin to $PATH</span>
</span></span></code></pre></div></div></li><li><p>Test to ensure the version you installed is up-to-date:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl version --client
</span></span></code></pre></div><p>Or use this for detailed view of version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>kubectl version --client --output=yaml    
</span></span></code></pre></div></li></ol><h3 id=install-using-native-package-management>Install using native package management</h3><ul class="nav nav-tabs" id=kubectl-install role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#kubectl-install-0 role=tab aria-controls=kubectl-install-0 aria-selected=true>Debian-based distributions</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-install-1 role=tab aria-controls=kubectl-install-1>Red Hat-based distributions</a></li></ul><div class=tab-content id=kubectl-install><div id=kubectl-install-0 class="tab-pane show active" role=tabpanel aria-labelledby=kubectl-install-0><p><ol><li><p>Update the <code>apt</code> package index and install packages needed to use the Kubernetes <code>apt</code> repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y ca-certificates curl
</span></span></code></pre></div><p>If you use Debian 9 (stretch) or earlier you would also need to install <code>apt-transport-https</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get install -y apt-transport-https
</span></span></code></pre></div></li><li><p>Download the Google Cloud public signing key:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo curl -fsSLo /etc/apt/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
</span></span></code></pre></div></li><li><p>Add the Kubernetes <code>apt</code> repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span></code></pre></div></li><li><p>Update <code>apt</code> package index with the new repository and install kubectl:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y kubectl
</span></span></code></pre></div></li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In releases older than Debian 12 and Ubuntu 22.04, <code>/etc/apt/keyrings</code> does not exist by default.
You can create this directory if you need to, making it world-readable but writeable only by admins.</div></div><div id=kubectl-install-1 class=tab-pane role=tabpanel aria-labelledby=kubectl-install-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style=display:flex><span><span style=color:#b44>[kubernetes]
</span></span></span><span style=display:flex><span><span style=color:#b44>name=Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#b44>baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span></span><span style=display:flex><span><span style=color:#b44>enabled=1
</span></span></span><span style=display:flex><span><span style=color:#b44>gpgcheck=1
</span></span></span><span style=display:flex><span><span style=color:#b44>gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>sudo yum install -y kubectl
</span></span></code></pre></div></div></div><h3 id=install-using-other-package-management>Install using other package management</h3><ul class="nav nav-tabs" id=other-kubectl-install role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#other-kubectl-install-0 role=tab aria-controls=other-kubectl-install-0 aria-selected=true>Snap</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#other-kubectl-install-1 role=tab aria-controls=other-kubectl-install-1>Homebrew</a></li></ul><div class=tab-content id=other-kubectl-install><div id=other-kubectl-install-0 class="tab-pane show active" role=tabpanel aria-labelledby=other-kubectl-install-0><p><p>If you are on Ubuntu or another Linux distribution that supports the <a href=https://snapcraft.io/docs/core/install>snap</a> package manager, kubectl is available as a <a href=https://snapcraft.io/>snap</a> application.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>snap install kubectl --classic
</span></span><span style=display:flex><span>kubectl version --client
</span></span></code></pre></div></div><div id=other-kubectl-install-1 class=tab-pane role=tabpanel aria-labelledby=other-kubectl-install-1><p><p>If you are on Linux and using <a href=https://docs.brew.sh/Homebrew-on-Linux>Homebrew</a> package manager, kubectl is available for <a href=https://docs.brew.sh/Homebrew-on-Linux#install>installation</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>brew install kubectl
</span></span><span style=display:flex><span>kubectl version --client
</span></span></code></pre></div></div></div><h2 id=verify-kubectl-configuration>Verify kubectl configuration</h2><p>In order for kubectl to find and access a Kubernetes cluster, it needs a
<a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>,
which is created automatically when you create a cluster using
<a href=https://github.com/kubernetes/kubernetes/blob/master/cluster/kube-up.sh>kube-up.sh</a>
or successfully deploy a Minikube cluster.
By default, kubectl configuration is located at <code>~/.kube/config</code>.</p><p>Check that kubectl is properly configured by getting the cluster state:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info
</span></span></code></pre></div><p>If you see a URL response, kubectl is correctly configured to access your cluster.</p><p>If you see a message similar to the following, kubectl is not configured correctly or is not able to connect to a Kubernetes cluster.</p><pre tabindex=0><code>The connection to the server &lt;server-name:port&gt; was refused - did you specify the right host or port?
</code></pre><p>For example, if you are intending to run a Kubernetes cluster on your laptop (locally), you will need a tool like Minikube to be installed first and then re-run the commands stated above.</p><p>If kubectl cluster-info returns the url response but you can't access your cluster, to check whether it is configured properly, use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info dump
</span></span></code></pre></div><h2 id=optional-kubectl-configurations-and-plugins>Optional kubectl configurations and plugins</h2><h3 id=enable-shell-autocompletion>Enable shell autocompletion</h3><p>kubectl provides autocompletion support for Bash, Zsh, Fish, and PowerShell, which can save you a lot of typing.</p><p>Below are the procedures to set up autocompletion for Bash, Fish, and Zsh.</p><ul class="nav nav-tabs" id=kubectl-autocompletion role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#kubectl-autocompletion-0 role=tab aria-controls=kubectl-autocompletion-0 aria-selected=true>Bash</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-autocompletion-1 role=tab aria-controls=kubectl-autocompletion-1>Fish</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-autocompletion-2 role=tab aria-controls=kubectl-autocompletion-2>Zsh</a></li></ul><div class=tab-content id=kubectl-autocompletion><div id=kubectl-autocompletion-0 class="tab-pane show active" role=tabpanel aria-labelledby=kubectl-autocompletion-0><p><h3 id=introduction>Introduction</h3><p>The kubectl completion script for Bash can be generated with the command <code>kubectl completion bash</code>. Sourcing the completion script in your shell enables kubectl autocompletion.</p><p>However, the completion script depends on <a href=https://github.com/scop/bash-completion><strong>bash-completion</strong></a>, which means that you have to install this software first (you can test if you have bash-completion already installed by running <code>type _init_completion</code>).</p><h3 id=install-bash-completion>Install bash-completion</h3><p>bash-completion is provided by many package managers (see <a href=https://github.com/scop/bash-completion#installation>here</a>). You can install it with <code>apt-get install bash-completion</code> or <code>yum install bash-completion</code>, etc.</p><p>The above commands create <code>/usr/share/bash-completion/bash_completion</code>, which is the main script of bash-completion. Depending on your package manager, you have to manually source this file in your <code>~/.bashrc</code> file.</p><p>To find out, reload your shell and run <code>type _init_completion</code>. If the command succeeds, you're already set, otherwise add the following to your <code>~/.bashrc</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>source</span> /usr/share/bash-completion/bash_completion
</span></span></code></pre></div><p>Reload your shell and verify that bash-completion is correctly installed by typing <code>type _init_completion</code>.</p><h3 id=enable-kubectl-autocompletion>Enable kubectl autocompletion</h3><h4 id=bash>Bash</h4><p>You now need to ensure that the kubectl completion script gets sourced in all your shell sessions. There are two ways in which you can do this:</p><ul class="nav nav-tabs" id=kubectl-bash-autocompletion role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#kubectl-bash-autocompletion-0 role=tab aria-controls=kubectl-bash-autocompletion-0 aria-selected=true>User</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-bash-autocompletion-1 role=tab aria-controls=kubectl-bash-autocompletion-1>System</a></li></ul><div class=tab-content id=kubectl-bash-autocompletion><div id=kubectl-bash-autocompletion-0 class="tab-pane show active" role=tabpanel aria-labelledby=kubectl-bash-autocompletion-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;source &lt;(kubectl completion bash)&#39;</span> &gt;&gt;~/.bashrc
</span></span></code></pre></div></div><div id=kubectl-bash-autocompletion-1 class=tab-pane role=tabpanel aria-labelledby=kubectl-bash-autocompletion-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl completion bash | sudo tee /etc/bash_completion.d/kubectl &gt; /dev/null
</span></span></code></pre></div></div></div><p>If you have an alias for kubectl, you can extend shell completion to work with that alias:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;alias k=kubectl&#39;</span> &gt;&gt;~/.bashrc
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;complete -o default -F __start_kubectl k&#39;</span> &gt;&gt;~/.bashrc
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> bash-completion sources all completion scripts in <code>/etc/bash_completion.d</code>.</div><p>Both approaches are equivalent. After reloading your shell, kubectl autocompletion should be working.
To enable bash autocompletion in current session of shell, run <code>exec bash</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>exec</span> bash
</span></span></code></pre></div></div><div id=kubectl-autocompletion-1 class=tab-pane role=tabpanel aria-labelledby=kubectl-autocompletion-1><p><p>The kubectl completion script for Fish can be generated with the command <code>kubectl completion fish</code>. Sourcing the completion script in your shell enables kubectl autocompletion.</p><p>To do so in all your shell sessions, add the following line to your <code>~/.config/fish/config.fish</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl completion fish | <span style=color:#a2f>source</span>
</span></span></code></pre></div><p>After reloading your shell, kubectl autocompletion should be working.</p></div><div id=kubectl-autocompletion-2 class=tab-pane role=tabpanel aria-labelledby=kubectl-autocompletion-2><p><p>The kubectl completion script for Zsh can be generated with the command <code>kubectl completion zsh</code>. Sourcing the completion script in your shell enables kubectl autocompletion.</p><p>To do so in all your shell sessions, add the following to your <code>~/.zshrc</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#a2f>source</span> &lt;<span style=color:#666>(</span>kubectl completion zsh<span style=color:#666>)</span>
</span></span></code></pre></div><p>If you have an alias for kubectl, kubectl autocompletion will automatically work with it.</p><p>After reloading your shell, kubectl autocompletion should be working.</p><p>If you get an error like <code>2: command not found: compdef</code>, then add the following to the beginning of your <code>~/.zshrc</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>autoload -Uz compinit
</span></span><span style=display:flex><span>compinit
</span></span></code></pre></div></div></div><h3 id=install-kubectl-convert-plugin>Install <code>kubectl convert</code> plugin</h3><p>A plugin for Kubernetes command-line tool <code>kubectl</code>, which allows you to convert manifests between different API
versions. This can be particularly helpful to migrate manifests to a non-deprecated api version with newer Kubernetes release.
For more info, visit <a href=/docs/reference/using-api/deprecation-guide/#migrate-to-non-deprecated-apis>migrate to non deprecated apis</a></p><ol><li><p>Download the latest release with the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/linux/amd64/kubectl-convert&#34;</span>
</span></span></code></pre></div></li><li><p>Validate the binary (optional)</p><p>Download the kubectl-convert checksum file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/linux/amd64/kubectl-convert.sha256&#34;</span>
</span></span></code></pre></div><p>Validate the kubectl-convert binary against the checksum file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#a2f;font-weight:700>$(</span>cat kubectl-convert.sha256<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44> kubectl-convert&#34;</span> | sha256sum --check
</span></span></code></pre></div><p>If valid, the output is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl-convert: OK
</span></span></span></code></pre></div><p>If the check fails, <code>sha256</code> exits with nonzero status and prints output similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl-convert: FAILED
</span></span><span style=display:flex><span>sha256sum: WARNING: <span style=color:#666>1</span> computed checksum did NOT match
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Download the same version of the binary and checksum.</div></li><li><p>Install kubectl-convert</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo install -o root -g root -m <span style=color:#666>0755</span> kubectl-convert /usr/local/bin/kubectl-convert
</span></span></code></pre></div></li><li><p>Verify plugin is successfully installed</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl convert --help
</span></span></code></pre></div><p>If you do not see an error, it means the plugin is successfully installed.</p></li></ol><h2 id=what-s-next>What's next</h2><ul><li><a href=https://minikube.sigs.k8s.io/docs/start/>Install Minikube</a></li><li>See the <a href=/docs/setup/>getting started guides</a> for more about creating clusters.</li><li><a href=/docs/tasks/access-application-cluster/service-access-application-cluster/>Learn how to launch and expose your application.</a></li><li>If you need access to a cluster you didn't create, see the
<a href=/docs/tasks/access-application-cluster/configure-access-multiple-clusters/>Sharing Cluster Access document</a>.</li><li>Read the <a href=/docs/reference/kubectl/kubectl/>kubectl reference docs</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-961fc70b732cb8df4fd11a3463b6545c>1.2 - Install and Set Up kubectl on macOS</h1><h2 id=before-you-begin>Before you begin</h2><p>You must use a kubectl version that is within one minor version difference of your cluster. For example, a v1.25 client can communicate with v1.24, v1.25, and v1.26 control planes.
Using the latest compatible version of kubectl helps avoid unforeseen issues.</p><h2 id=install-kubectl-on-macos>Install kubectl on macOS</h2><p>The following methods exist for installing kubectl on macOS:</p><ul><li><a href=#install-kubectl-binary-with-curl-on-macos>Install kubectl binary with curl on macOS</a></li><li><a href=#install-with-homebrew-on-macos>Install with Homebrew on macOS</a></li><li><a href=#install-with-macports-on-macos>Install with Macports on macOS</a></li></ul><h3 id=install-kubectl-binary-with-curl-on-macos>Install kubectl binary with curl on macOS</h3><ol><li><p>Download the latest release:</p><ul class="nav nav-tabs" id=download-binary-macos role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#download-binary-macos-0 role=tab aria-controls=download-binary-macos-0 aria-selected=true>Intel</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#download-binary-macos-1 role=tab aria-controls=download-binary-macos-1>Apple Silicon</a></li></ul><div class=tab-content id=download-binary-macos><div id=download-binary-macos-0 class="tab-pane show active" role=tabpanel aria-labelledby=download-binary-macos-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>   curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/darwin/amd64/kubectl&#34;</span>
</span></span><span style=display:flex><span>   </span></span></code></pre></div></div><div id=download-binary-macos-1 class=tab-pane role=tabpanel aria-labelledby=download-binary-macos-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>   curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/darwin/arm64/kubectl&#34;</span>
</span></span><span style=display:flex><span>   </span></span></code></pre></div></div></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>To download a specific version, replace the <code>$(curl -L -s https://dl.k8s.io/release/stable.txt)</code> portion of the command with the specific version.</p><p>For example, to download version v1.25.0 on Intel macOS, type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/v1.25.0/bin/darwin/amd64/kubectl&#34;</span>
</span></span></code></pre></div><p>And for macOS on Apple Silicon, type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/v1.25.0/bin/darwin/arm64/kubectl&#34;</span>
</span></span></code></pre></div></div></li><li><p>Validate the binary (optional)</p><p>Download the kubectl checksum file:</p><ul class="nav nav-tabs" id=download-checksum-macos role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#download-checksum-macos-0 role=tab aria-controls=download-checksum-macos-0 aria-selected=true>Intel</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#download-checksum-macos-1 role=tab aria-controls=download-checksum-macos-1>Apple Silicon</a></li></ul><div class=tab-content id=download-checksum-macos><div id=download-checksum-macos-0 class="tab-pane show active" role=tabpanel aria-labelledby=download-checksum-macos-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>   curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/darwin/amd64/kubectl.sha256&#34;</span>
</span></span><span style=display:flex><span>   </span></span></code></pre></div></div><div id=download-checksum-macos-1 class=tab-pane role=tabpanel aria-labelledby=download-checksum-macos-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>   curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/darwin/arm64/kubectl.sha256&#34;</span>
</span></span><span style=display:flex><span>   </span></span></code></pre></div></div></div><p>Validate the kubectl binary against the checksum file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#a2f;font-weight:700>$(</span>cat kubectl.sha256<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>  kubectl&#34;</span> | shasum -a <span style=color:#666>256</span> --check
</span></span></code></pre></div><p>If valid, the output is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl: OK
</span></span></span></code></pre></div><p>If the check fails, <code>shasum</code> exits with nonzero status and prints output similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl: FAILED
</span></span><span style=display:flex><span>shasum: WARNING: <span style=color:#666>1</span> computed checksum did NOT match
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Download the same version of the binary and checksum.</div></li><li><p>Make the kubectl binary executable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x ./kubectl
</span></span></code></pre></div></li><li><p>Move the kubectl binary to a file location on your system <code>PATH</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mv ./kubectl /usr/local/bin/kubectl
</span></span><span style=display:flex><span>sudo chown root: /usr/local/bin/kubectl
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Make sure <code>/usr/local/bin</code> is in your PATH environment variable.</div></li><li><p>Test to ensure the version you installed is up-to-date:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl version --client
</span></span></code></pre></div><p>Or use this for detailed view of version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>kubectl version --client --output=yaml
</span></span></code></pre></div></li></ol><h3 id=install-with-homebrew-on-macos>Install with Homebrew on macOS</h3><p>If you are on macOS and using <a href=https://brew.sh/>Homebrew</a> package manager, you can install kubectl with Homebrew.</p><ol><li><p>Run the installation command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install kubectl
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install kubernetes-cli
</span></span></code></pre></div></li><li><p>Test to ensure the version you installed is up-to-date:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl version --client
</span></span></code></pre></div></li></ol><h3 id=install-with-macports-on-macos>Install with Macports on macOS</h3><p>If you are on macOS and using <a href=https://macports.org/>Macports</a> package manager, you can install kubectl with Macports.</p><ol><li><p>Run the installation command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo port selfupdate
</span></span><span style=display:flex><span>sudo port install kubectl
</span></span></code></pre></div></li><li><p>Test to ensure the version you installed is up-to-date:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl version --client
</span></span></code></pre></div></li></ol><h2 id=verify-kubectl-configuration>Verify kubectl configuration</h2><p>In order for kubectl to find and access a Kubernetes cluster, it needs a
<a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>,
which is created automatically when you create a cluster using
<a href=https://github.com/kubernetes/kubernetes/blob/master/cluster/kube-up.sh>kube-up.sh</a>
or successfully deploy a Minikube cluster.
By default, kubectl configuration is located at <code>~/.kube/config</code>.</p><p>Check that kubectl is properly configured by getting the cluster state:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info
</span></span></code></pre></div><p>If you see a URL response, kubectl is correctly configured to access your cluster.</p><p>If you see a message similar to the following, kubectl is not configured correctly or is not able to connect to a Kubernetes cluster.</p><pre tabindex=0><code>The connection to the server &lt;server-name:port&gt; was refused - did you specify the right host or port?
</code></pre><p>For example, if you are intending to run a Kubernetes cluster on your laptop (locally), you will need a tool like Minikube to be installed first and then re-run the commands stated above.</p><p>If kubectl cluster-info returns the url response but you can't access your cluster, to check whether it is configured properly, use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info dump
</span></span></code></pre></div><h2 id=optional-kubectl-configurations-and-plugins>Optional kubectl configurations and plugins</h2><h3 id=enable-shell-autocompletion>Enable shell autocompletion</h3><p>kubectl provides autocompletion support for Bash, Zsh, Fish, and PowerShell which can save you a lot of typing.</p><p>Below are the procedures to set up autocompletion for Bash, Fish, and Zsh.</p><ul class="nav nav-tabs" id=kubectl-autocompletion role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#kubectl-autocompletion-0 role=tab aria-controls=kubectl-autocompletion-0 aria-selected=true>Bash</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-autocompletion-1 role=tab aria-controls=kubectl-autocompletion-1>Fish</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-autocompletion-2 role=tab aria-controls=kubectl-autocompletion-2>Zsh</a></li></ul><div class=tab-content id=kubectl-autocompletion><div id=kubectl-autocompletion-0 class="tab-pane show active" role=tabpanel aria-labelledby=kubectl-autocompletion-0><p><h3 id=introduction>Introduction</h3><p>The kubectl completion script for Bash can be generated with <code>kubectl completion bash</code>. Sourcing this script in your shell enables kubectl completion.</p><p>However, the kubectl completion script depends on <a href=https://github.com/scop/bash-completion><strong>bash-completion</strong></a> which you thus have to previously install.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> There are two versions of bash-completion, v1 and v2. V1 is for Bash 3.2 (which is the default on macOS), and v2 is for Bash 4.1+. The kubectl completion script <strong>doesn't work</strong> correctly with bash-completion v1 and Bash 3.2. It requires <strong>bash-completion v2</strong> and <strong>Bash 4.1+</strong>. Thus, to be able to correctly use kubectl completion on macOS, you have to install and use Bash 4.1+ (<a href=https://itnext.io/upgrading-bash-on-macos-7138bd1066ba><em>instructions</em></a>). The following instructions assume that you use Bash 4.1+ (that is, any Bash version of 4.1 or newer).</div><h3 id=upgrade-bash>Upgrade Bash</h3><p>The instructions here assume you use Bash 4.1+. You can check your Bash's version by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b8860b>$BASH_VERSION</span>
</span></span></code></pre></div><p>If it is too old, you can install/upgrade it using Homebrew:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install bash
</span></span></code></pre></div><p>Reload your shell and verify that the desired version is being used:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b8860b>$BASH_VERSION</span> <span style=color:#b8860b>$SHELL</span>
</span></span></code></pre></div><p>Homebrew usually installs it at <code>/usr/local/bin/bash</code>.</p><h3 id=install-bash-completion>Install bash-completion</h3><div class="alert alert-info note callout" role=alert><strong>Note:</strong> As mentioned, these instructions assume you use Bash 4.1+, which means you will install bash-completion v2 (in contrast to Bash 3.2 and bash-completion v1, in which case kubectl completion won't work).</div><p>You can test if you have bash-completion v2 already installed with <code>type _init_completion</code>. If not, you can install it with Homebrew:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install bash-completion@2
</span></span></code></pre></div><p>As stated in the output of this command, add the following to your <code>~/.bash_profile</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>BASH_COMPLETION_COMPAT_DIR</span><span style=color:#666>=</span><span style=color:#b44>&#34;/usr/local/etc/bash_completion.d&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[[</span> -r <span style=color:#b44>&#34;/usr/local/etc/profile.d/bash_completion.sh&#34;</span> <span style=color:#666>]]</span> <span style=color:#666>&amp;&amp;</span> . <span style=color:#b44>&#34;/usr/local/etc/profile.d/bash_completion.sh&#34;</span>
</span></span></code></pre></div><p>Reload your shell and verify that bash-completion v2 is correctly installed with <code>type _init_completion</code>.</p><h3 id=enable-kubectl-autocompletion>Enable kubectl autocompletion</h3><p>You now have to ensure that the kubectl completion script gets sourced in all your shell sessions. There are multiple ways to achieve this:</p><ul><li><p>Source the completion script in your <code>~/.bash_profile</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;source &lt;(kubectl completion bash)&#39;</span> &gt;&gt;~/.bash_profile
</span></span></code></pre></div></li><li><p>Add the completion script to the <code>/usr/local/etc/bash_completion.d</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl completion bash &gt;/usr/local/etc/bash_completion.d/kubectl
</span></span></code></pre></div></li><li><p>If you have an alias for kubectl, you can extend shell completion to work with that alias:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;alias k=kubectl&#39;</span> &gt;&gt;~/.bash_profile
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;complete -o default -F __start_kubectl k&#39;</span> &gt;&gt;~/.bash_profile
</span></span></code></pre></div></li><li><p>If you installed kubectl with Homebrew (as explained <a href=/docs/tasks/tools/install-kubectl-macos/#install-with-homebrew-on-macos>here</a>), then the kubectl completion script should already be in <code>/usr/local/etc/bash_completion.d/kubectl</code>. In that case, you don't need to do anything.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The Homebrew installation of bash-completion v2 sources all the files in the <code>BASH_COMPLETION_COMPAT_DIR</code> directory, that's why the latter two methods work.</div></li></ul><p>In any case, after reloading your shell, kubectl completion should be working.</p></div><div id=kubectl-autocompletion-1 class=tab-pane role=tabpanel aria-labelledby=kubectl-autocompletion-1><p><p>The kubectl completion script for Fish can be generated with the command <code>kubectl completion fish</code>. Sourcing the completion script in your shell enables kubectl autocompletion.</p><p>To do so in all your shell sessions, add the following line to your <code>~/.config/fish/config.fish</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl completion fish | <span style=color:#a2f>source</span>
</span></span></code></pre></div><p>After reloading your shell, kubectl autocompletion should be working.</p></div><div id=kubectl-autocompletion-2 class=tab-pane role=tabpanel aria-labelledby=kubectl-autocompletion-2><p><p>The kubectl completion script for Zsh can be generated with the command <code>kubectl completion zsh</code>. Sourcing the completion script in your shell enables kubectl autocompletion.</p><p>To do so in all your shell sessions, add the following to your <code>~/.zshrc</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#a2f>source</span> &lt;<span style=color:#666>(</span>kubectl completion zsh<span style=color:#666>)</span>
</span></span></code></pre></div><p>If you have an alias for kubectl, kubectl autocompletion will automatically work with it.</p><p>After reloading your shell, kubectl autocompletion should be working.</p><p>If you get an error like <code>2: command not found: compdef</code>, then add the following to the beginning of your <code>~/.zshrc</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>autoload -Uz compinit
</span></span><span style=display:flex><span>compinit
</span></span></code></pre></div></div></div><h3 id=install-kubectl-convert-plugin>Install <code>kubectl convert</code> plugin</h3><p>A plugin for Kubernetes command-line tool <code>kubectl</code>, which allows you to convert manifests between different API
versions. This can be particularly helpful to migrate manifests to a non-deprecated api version with newer Kubernetes release.
For more info, visit <a href=/docs/reference/using-api/deprecation-guide/#migrate-to-non-deprecated-apis>migrate to non deprecated apis</a></p><ol><li><p>Download the latest release with the command:</p><ul class="nav nav-tabs" id=download-convert-binary-macos role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#download-convert-binary-macos-0 role=tab aria-controls=download-convert-binary-macos-0 aria-selected=true>Intel</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#download-convert-binary-macos-1 role=tab aria-controls=download-convert-binary-macos-1>Apple Silicon</a></li></ul><div class=tab-content id=download-convert-binary-macos><div id=download-convert-binary-macos-0 class="tab-pane show active" role=tabpanel aria-labelledby=download-convert-binary-macos-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>   curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/darwin/amd64/kubectl-convert&#34;</span>
</span></span><span style=display:flex><span>   </span></span></code></pre></div></div><div id=download-convert-binary-macos-1 class=tab-pane role=tabpanel aria-labelledby=download-convert-binary-macos-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>   curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/darwin/arm64/kubectl-convert&#34;</span>
</span></span><span style=display:flex><span>   </span></span></code></pre></div></div></div></li><li><p>Validate the binary (optional)</p><p>Download the kubectl-convert checksum file:</p><ul class="nav nav-tabs" id=download-convert-checksum-macos role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#download-convert-checksum-macos-0 role=tab aria-controls=download-convert-checksum-macos-0 aria-selected=true>Intel</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#download-convert-checksum-macos-1 role=tab aria-controls=download-convert-checksum-macos-1>Apple Silicon</a></li></ul><div class=tab-content id=download-convert-checksum-macos><div id=download-convert-checksum-macos-0 class="tab-pane show active" role=tabpanel aria-labelledby=download-convert-checksum-macos-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>   curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/darwin/amd64/kubectl-convert.sha256&#34;</span>
</span></span><span style=display:flex><span>   </span></span></code></pre></div></div><div id=download-convert-checksum-macos-1 class=tab-pane role=tabpanel aria-labelledby=download-convert-checksum-macos-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>   curl -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/</span><span style=color:#a2f;font-weight:700>$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>/bin/darwin/arm64/kubectl-convert.sha256&#34;</span>
</span></span><span style=display:flex><span>   </span></span></code></pre></div></div></div><p>Validate the kubectl-convert binary against the checksum file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#a2f;font-weight:700>$(</span>cat kubectl-convert.sha256<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>  kubectl-convert&#34;</span> | shasum -a <span style=color:#666>256</span> --check
</span></span></code></pre></div><p>If valid, the output is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl-convert: OK
</span></span></span></code></pre></div><p>If the check fails, <code>shasum</code> exits with nonzero status and prints output similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl-convert: FAILED
</span></span><span style=display:flex><span>shasum: WARNING: <span style=color:#666>1</span> computed checksum did NOT match
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Download the same version of the binary and checksum.</div></li><li><p>Make kubectl-convert binary executable</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x ./kubectl-convert
</span></span></code></pre></div></li><li><p>Move the kubectl-convert binary to a file location on your system <code>PATH</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mv ./kubectl-convert /usr/local/bin/kubectl-convert
</span></span><span style=display:flex><span>sudo chown root: /usr/local/bin/kubectl-convert
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Make sure <code>/usr/local/bin</code> is in your PATH environment variable.</div></li><li><p>Verify plugin is successfully installed</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl convert --help
</span></span></code></pre></div><p>If you do not see an error, it means the plugin is successfully installed.</p></li></ol><h2 id=what-s-next>What's next</h2><ul><li><a href=https://minikube.sigs.k8s.io/docs/start/>Install Minikube</a></li><li>See the <a href=/docs/setup/>getting started guides</a> for more about creating clusters.</li><li><a href=/docs/tasks/access-application-cluster/service-access-application-cluster/>Learn how to launch and expose your application.</a></li><li>If you need access to a cluster you didn't create, see the
<a href=/docs/tasks/access-application-cluster/configure-access-multiple-clusters/>Sharing Cluster Access document</a>.</li><li>Read the <a href=/docs/reference/kubectl/kubectl/>kubectl reference docs</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2cc93d3011d707aeb6564bab02048f7a>1.3 - Install and Set Up kubectl on Windows</h1><h2 id=before-you-begin>Before you begin</h2><p>You must use a kubectl version that is within one minor version difference of your cluster. For example, a v1.25 client can communicate with v1.24, v1.25, and v1.26 control planes.
Using the latest compatible version of kubectl helps avoid unforeseen issues.</p><h2 id=install-kubectl-on-windows>Install kubectl on Windows</h2><p>The following methods exist for installing kubectl on Windows:</p><ul><li><a href=#install-kubectl-binary-with-curl-on-windows>Install kubectl binary with curl on Windows</a></li><li><a href=#install-nonstandard-package-tools>Install on Windows using Chocolatey, Scoop, or Winget</a></li></ul><h3 id=install-kubectl-binary-with-curl-on-windows>Install kubectl binary with curl on Windows</h3><ol><li><p>Download the <a href=https://dl.k8s.io/release/v1.25.0/bin/windows/amd64/kubectl.exe>latest release v1.25.0</a>.</p><p>Or if you have <code>curl</code> installed, use this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>curl.exe -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/v1.25.0/bin/windows/amd64/kubectl.exe&#34;</span>
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> To find out the latest stable version (for example, for scripting), take a look at <a href=https://dl.k8s.io/release/stable.txt>https://dl.k8s.io/release/stable.txt</a>.</div></li><li><p>Validate the binary (optional)</p><p>Download the <code>kubectl</code> checksum file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>curl.exe -LO <span style=color:#b44>&#34;https://dl.k8s.io/v1.25.0/bin/windows/amd64/kubectl.exe.sha256&#34;</span>
</span></span></code></pre></div><p>Validate the <code>kubectl</code> binary against the checksum file:</p><ul><li><p>Using Command Prompt to manually compare <code>CertUtil</code>'s output to the checksum file downloaded:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>CertUtil -hashfile kubectl.exe SHA256
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>type</span> kubectl.exe.sha256
</span></span></code></pre></div></li><li><p>Using PowerShell to automate the verification using the <code>-eq</code> operator to get a <code>True</code> or <code>False</code> result:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$($(CertUtil -hashfile .\kubectl.exe SHA256)[<span style=color:#666>1</span>] <span style=color:#666>-replace</span> <span style=color:#b44>&#34; &#34;</span>, <span style=color:#b44>&#34;&#34;</span>) <span style=color:#666>-eq</span> $(<span style=color:#a2f>type </span>.\kubectl.exe.sha256)
</span></span></code></pre></div></li></ul></li><li><p>Append or prepend the <code>kubectl</code> binary folder to your <code>PATH</code> environment variable.</p></li><li><p>Test to ensure the version of <code>kubectl</code> is the same as downloaded:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>kubectl version --client
</span></span></code></pre></div><p>Or use this for detailed view of version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>kubectl version --client --output=yaml
</span></span></code></pre></div></li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <a href=https://docs.docker.com/docker-for-windows/#kubernetes>Docker Desktop for Windows</a> adds its own version of <code>kubectl</code> to <code>PATH</code>.
If you have installed Docker Desktop before, you may need to place your <code>PATH</code> entry before the one added by the Docker Desktop installer or remove the Docker Desktop's <code>kubectl</code>.</div><h3 id=install-nonstandard-package-tools>Install on Windows using Chocolatey, Scoop, or Winget</h3><ol><li><p>To install kubectl on Windows you can use either <a href=https://chocolatey.org>Chocolatey</a> package manager, <a href=https://scoop.sh>Scoop</a> command-line installer, or <a href=https://winget.run/>Winget</a> package manager.</p><ul class="nav nav-tabs" id=kubectl-win-install role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#kubectl-win-install-0 role=tab aria-controls=kubectl-win-install-0 aria-selected=true>choco</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-win-install-1 role=tab aria-controls=kubectl-win-install-1>scoop</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-win-install-2 role=tab aria-controls=kubectl-win-install-2>winget</a></li></ul><div class=tab-content id=kubectl-win-install><div id=kubectl-win-install-0 class="tab-pane show active" role=tabpanel aria-labelledby=kubectl-win-install-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>choco install <span style=color:#a2f>kubernetes-cli</span>
</span></span></code></pre></div></div><div id=kubectl-win-install-1 class=tab-pane role=tabpanel aria-labelledby=kubectl-win-install-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>scoop install kubectl
</span></span></code></pre></div></div><div id=kubectl-win-install-2 class=tab-pane role=tabpanel aria-labelledby=kubectl-win-install-2><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>winget install -e --id Kubernetes.kubectl
</span></span></code></pre></div></div></div></li><li><p>Test to ensure the version you installed is up-to-date:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>kubectl version --client
</span></span></code></pre></div></li><li><p>Navigate to your home directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#080;font-style:italic># If you&#39;re using cmd.exe, run: cd %USERPROFILE%</span>
</span></span><span style=display:flex><span><span style=color:#a2f>cd </span>~
</span></span></code></pre></div></li><li><p>Create the <code>.kube</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>mkdir .kube
</span></span></code></pre></div></li><li><p>Change to the <code>.kube</code> directory you just created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>cd </span>.kube
</span></span></code></pre></div></li><li><p>Configure kubectl to use a remote Kubernetes cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>New-Item</span> config -type file
</span></span></code></pre></div></li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Edit the config file with a text editor of your choice, such as Notepad.</div><h2 id=verify-kubectl-configuration>Verify kubectl configuration</h2><p>In order for kubectl to find and access a Kubernetes cluster, it needs a
<a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>,
which is created automatically when you create a cluster using
<a href=https://github.com/kubernetes/kubernetes/blob/master/cluster/kube-up.sh>kube-up.sh</a>
or successfully deploy a Minikube cluster.
By default, kubectl configuration is located at <code>~/.kube/config</code>.</p><p>Check that kubectl is properly configured by getting the cluster state:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info
</span></span></code></pre></div><p>If you see a URL response, kubectl is correctly configured to access your cluster.</p><p>If you see a message similar to the following, kubectl is not configured correctly or is not able to connect to a Kubernetes cluster.</p><pre tabindex=0><code>The connection to the server &lt;server-name:port&gt; was refused - did you specify the right host or port?
</code></pre><p>For example, if you are intending to run a Kubernetes cluster on your laptop (locally), you will need a tool like Minikube to be installed first and then re-run the commands stated above.</p><p>If kubectl cluster-info returns the url response but you can't access your cluster, to check whether it is configured properly, use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info dump
</span></span></code></pre></div><h2 id=optional-kubectl-configurations-and-plugins>Optional kubectl configurations and plugins</h2><h3 id=enable-shell-autocompletion>Enable shell autocompletion</h3><p>kubectl provides autocompletion support for Bash, Zsh, Fish, and PowerShell, which can save you a lot of typing.</p><p>Below are the procedures to set up autocompletion for PowerShell.</p><p>The kubectl completion script for PowerShell can be generated with the command <code>kubectl completion powershell</code>.</p><p>To do so in all your shell sessions, add the following line to your <code>$PROFILE</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>kubectl completion powershell | <span style=color:#a2f>Out-String</span> | <span style=color:#a2f>Invoke-Expression</span>
</span></span></code></pre></div><p>This command will regenerate the auto-completion script on every PowerShell start up. You can also add the generated script directly to your <code>$PROFILE</code> file.</p><p>To add the generated script to your <code>$PROFILE</code> file, run the following line in your powershell prompt:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>kubectl completion powershell &gt;&gt; <span style=color:#b8860b>$PROFILE</span>
</span></span></code></pre></div><p>After reloading your shell, kubectl autocompletion should be working.</p><h3 id=install-kubectl-convert-plugin>Install <code>kubectl convert</code> plugin</h3><p>A plugin for Kubernetes command-line tool <code>kubectl</code>, which allows you to convert manifests between different API
versions. This can be particularly helpful to migrate manifests to a non-deprecated api version with newer Kubernetes release.
For more info, visit <a href=/docs/reference/using-api/deprecation-guide/#migrate-to-non-deprecated-apis>migrate to non deprecated apis</a></p><ol><li><p>Download the latest release with the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>curl.exe -LO <span style=color:#b44>&#34;https://dl.k8s.io/release/v1.25.0/bin/windows/amd64/kubectl-convert.exe&#34;</span>
</span></span></code></pre></div></li><li><p>Validate the binary (optional).</p><p>Download the <code>kubectl-convert</code> checksum file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>curl.exe -LO <span style=color:#b44>&#34;https://dl.k8s.io/v1.25.0/bin/windows/amd64/kubectl-convert.exe.sha256&#34;</span>
</span></span></code></pre></div><p>Validate the <code>kubectl-convert</code> binary against the checksum file:</p><ul><li><p>Using Command Prompt to manually compare <code>CertUtil</code>'s output to the checksum file downloaded:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>CertUtil -hashfile kubectl-convert.exe SHA256
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>type</span> kubectl-convert.exe.sha256
</span></span></code></pre></div></li><li><p>Using PowerShell to automate the verification using the <code>-eq</code> operator to get a <code>True</code> or <code>False</code> result:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$($(CertUtil -hashfile .\<span style=color:#a2f>kubectl-convert</span>.exe SHA256)[<span style=color:#666>1</span>] <span style=color:#666>-replace</span> <span style=color:#b44>&#34; &#34;</span>, <span style=color:#b44>&#34;&#34;</span>) <span style=color:#666>-eq</span> $(<span style=color:#a2f>type </span>.\<span style=color:#a2f>kubectl-convert</span>.exe.sha256)
</span></span></code></pre></div></li></ul></li><li><p>Append or prepend the <code>kubectl-convert</code> binary folder to your <code>PATH</code> environment variable.</p></li><li><p>Verify the plugin is successfully installed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl convert --help
</span></span></code></pre></div><p>If you do not see an error, it means the plugin is successfully installed.</p></li></ol><h2 id=what-s-next>What's next</h2><ul><li><a href=https://minikube.sigs.k8s.io/docs/start/>Install Minikube</a></li><li>See the <a href=/docs/setup/>getting started guides</a> for more about creating clusters.</li><li><a href=/docs/tasks/access-application-cluster/service-access-application-cluster/>Learn how to launch and expose your application.</a></li><li>If you need access to a cluster you didn't create, see the
<a href=/docs/tasks/access-application-cluster/configure-access-multiple-clusters/>Sharing Cluster Access document</a>.</li><li>Read the <a href=/docs/reference/kubectl/kubectl/>kubectl reference docs</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-91639f08dfa86a6c88cf0099b2e097bc>1.4 - Tools Included</h1><div class=lead>Snippets to be included in the main kubectl-installs-*.md pages.</div></div><div class=td-content><h1 id=pg-2d600cc8ec4dec69673b5f9577b6da22>1.4.1 - bash auto-completion on Linux</h1><div class=lead>Some optional configuration for bash auto-completion on Linux.</div><h3 id=introduction>Introduction</h3><p>The kubectl completion script for Bash can be generated with the command <code>kubectl completion bash</code>. Sourcing the completion script in your shell enables kubectl autocompletion.</p><p>However, the completion script depends on <a href=https://github.com/scop/bash-completion><strong>bash-completion</strong></a>, which means that you have to install this software first (you can test if you have bash-completion already installed by running <code>type _init_completion</code>).</p><h3 id=install-bash-completion>Install bash-completion</h3><p>bash-completion is provided by many package managers (see <a href=https://github.com/scop/bash-completion#installation>here</a>). You can install it with <code>apt-get install bash-completion</code> or <code>yum install bash-completion</code>, etc.</p><p>The above commands create <code>/usr/share/bash-completion/bash_completion</code>, which is the main script of bash-completion. Depending on your package manager, you have to manually source this file in your <code>~/.bashrc</code> file.</p><p>To find out, reload your shell and run <code>type _init_completion</code>. If the command succeeds, you're already set, otherwise add the following to your <code>~/.bashrc</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>source</span> /usr/share/bash-completion/bash_completion
</span></span></code></pre></div><p>Reload your shell and verify that bash-completion is correctly installed by typing <code>type _init_completion</code>.</p><h3 id=enable-kubectl-autocompletion>Enable kubectl autocompletion</h3><h4 id=bash>Bash</h4><p>You now need to ensure that the kubectl completion script gets sourced in all your shell sessions. There are two ways in which you can do this:</p><ul class="nav nav-tabs" id=kubectl-bash-autocompletion role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#kubectl-bash-autocompletion-0 role=tab aria-controls=kubectl-bash-autocompletion-0 aria-selected=true>User</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#kubectl-bash-autocompletion-1 role=tab aria-controls=kubectl-bash-autocompletion-1>System</a></li></ul><div class=tab-content id=kubectl-bash-autocompletion><div id=kubectl-bash-autocompletion-0 class="tab-pane show active" role=tabpanel aria-labelledby=kubectl-bash-autocompletion-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;source &lt;(kubectl completion bash)&#39;</span> &gt;&gt;~/.bashrc
</span></span></code></pre></div></div><div id=kubectl-bash-autocompletion-1 class=tab-pane role=tabpanel aria-labelledby=kubectl-bash-autocompletion-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl completion bash | sudo tee /etc/bash_completion.d/kubectl &gt; /dev/null
</span></span></code></pre></div></div></div><p>If you have an alias for kubectl, you can extend shell completion to work with that alias:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;alias k=kubectl&#39;</span> &gt;&gt;~/.bashrc
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;complete -o default -F __start_kubectl k&#39;</span> &gt;&gt;~/.bashrc
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> bash-completion sources all completion scripts in <code>/etc/bash_completion.d</code>.</div><p>Both approaches are equivalent. After reloading your shell, kubectl autocompletion should be working.
To enable bash autocompletion in current session of shell, run <code>exec bash</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>exec</span> bash
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-68808b3ec5807517ed64fd8ae32a7d1b>1.4.2 - bash auto-completion on macOS</h1><div class=lead>Some optional configuration for bash auto-completion on macOS.</div><h3 id=introduction>Introduction</h3><p>The kubectl completion script for Bash can be generated with <code>kubectl completion bash</code>. Sourcing this script in your shell enables kubectl completion.</p><p>However, the kubectl completion script depends on <a href=https://github.com/scop/bash-completion><strong>bash-completion</strong></a> which you thus have to previously install.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> There are two versions of bash-completion, v1 and v2. V1 is for Bash 3.2 (which is the default on macOS), and v2 is for Bash 4.1+. The kubectl completion script <strong>doesn't work</strong> correctly with bash-completion v1 and Bash 3.2. It requires <strong>bash-completion v2</strong> and <strong>Bash 4.1+</strong>. Thus, to be able to correctly use kubectl completion on macOS, you have to install and use Bash 4.1+ (<a href=https://itnext.io/upgrading-bash-on-macos-7138bd1066ba><em>instructions</em></a>). The following instructions assume that you use Bash 4.1+ (that is, any Bash version of 4.1 or newer).</div><h3 id=upgrade-bash>Upgrade Bash</h3><p>The instructions here assume you use Bash 4.1+. You can check your Bash's version by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b8860b>$BASH_VERSION</span>
</span></span></code></pre></div><p>If it is too old, you can install/upgrade it using Homebrew:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install bash
</span></span></code></pre></div><p>Reload your shell and verify that the desired version is being used:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b8860b>$BASH_VERSION</span> <span style=color:#b8860b>$SHELL</span>
</span></span></code></pre></div><p>Homebrew usually installs it at <code>/usr/local/bin/bash</code>.</p><h3 id=install-bash-completion>Install bash-completion</h3><div class="alert alert-info note callout" role=alert><strong>Note:</strong> As mentioned, these instructions assume you use Bash 4.1+, which means you will install bash-completion v2 (in contrast to Bash 3.2 and bash-completion v1, in which case kubectl completion won't work).</div><p>You can test if you have bash-completion v2 already installed with <code>type _init_completion</code>. If not, you can install it with Homebrew:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install bash-completion@2
</span></span></code></pre></div><p>As stated in the output of this command, add the following to your <code>~/.bash_profile</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>BASH_COMPLETION_COMPAT_DIR</span><span style=color:#666>=</span><span style=color:#b44>&#34;/usr/local/etc/bash_completion.d&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>[[</span> -r <span style=color:#b44>&#34;/usr/local/etc/profile.d/bash_completion.sh&#34;</span> <span style=color:#666>]]</span> <span style=color:#666>&amp;&amp;</span> . <span style=color:#b44>&#34;/usr/local/etc/profile.d/bash_completion.sh&#34;</span>
</span></span></code></pre></div><p>Reload your shell and verify that bash-completion v2 is correctly installed with <code>type _init_completion</code>.</p><h3 id=enable-kubectl-autocompletion>Enable kubectl autocompletion</h3><p>You now have to ensure that the kubectl completion script gets sourced in all your shell sessions. There are multiple ways to achieve this:</p><ul><li><p>Source the completion script in your <code>~/.bash_profile</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;source &lt;(kubectl completion bash)&#39;</span> &gt;&gt;~/.bash_profile
</span></span></code></pre></div></li><li><p>Add the completion script to the <code>/usr/local/etc/bash_completion.d</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl completion bash &gt;/usr/local/etc/bash_completion.d/kubectl
</span></span></code></pre></div></li><li><p>If you have an alias for kubectl, you can extend shell completion to work with that alias:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;alias k=kubectl&#39;</span> &gt;&gt;~/.bash_profile
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;complete -o default -F __start_kubectl k&#39;</span> &gt;&gt;~/.bash_profile
</span></span></code></pre></div></li><li><p>If you installed kubectl with Homebrew (as explained <a href=/docs/tasks/tools/install-kubectl-macos/#install-with-homebrew-on-macos>here</a>), then the kubectl completion script should already be in <code>/usr/local/etc/bash_completion.d/kubectl</code>. In that case, you don't need to do anything.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The Homebrew installation of bash-completion v2 sources all the files in the <code>BASH_COMPLETION_COMPAT_DIR</code> directory, that's why the latter two methods work.</div></li></ul><p>In any case, after reloading your shell, kubectl completion should be working.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-643b1104b7b31ae10b173acfb447843a>1.4.3 - fish auto-completion</h1><div class=lead>Optional configuration to enable fish shell auto-completion.</div><p>The kubectl completion script for Fish can be generated with the command <code>kubectl completion fish</code>. Sourcing the completion script in your shell enables kubectl autocompletion.</p><p>To do so in all your shell sessions, add the following line to your <code>~/.config/fish/config.fish</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl completion fish | <span style=color:#a2f>source</span>
</span></span></code></pre></div><p>After reloading your shell, kubectl autocompletion should be working.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d4ebbbe0a2ddce15850a36dfede9ba52>1.4.4 - kubectl-convert overview</h1><div class=lead>A kubectl plugin that allows you to convert manifests from one version of a Kubernetes API to a different version.</div><p>A plugin for Kubernetes command-line tool <code>kubectl</code>, which allows you to convert manifests between different API
versions. This can be particularly helpful to migrate manifests to a non-deprecated api version with newer Kubernetes release.
For more info, visit <a href=/docs/reference/using-api/deprecation-guide/#migrate-to-non-deprecated-apis>migrate to non deprecated apis</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-730f5a835775a8e94bd1c481d3f1a349>1.4.5 - PowerShell auto-completion</h1><div class=lead>Some optional configuration for powershell auto-completion.</div><p>The kubectl completion script for PowerShell can be generated with the command <code>kubectl completion powershell</code>.</p><p>To do so in all your shell sessions, add the following line to your <code>$PROFILE</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>kubectl completion powershell | <span style=color:#a2f>Out-String</span> | <span style=color:#a2f>Invoke-Expression</span>
</span></span></code></pre></div><p>This command will regenerate the auto-completion script on every PowerShell start up. You can also add the generated script directly to your <code>$PROFILE</code> file.</p><p>To add the generated script to your <code>$PROFILE</code> file, run the following line in your powershell prompt:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>kubectl completion powershell &gt;&gt; <span style=color:#b8860b>$PROFILE</span>
</span></span></code></pre></div><p>After reloading your shell, kubectl autocompletion should be working.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b2d43b2ae3e8f26eefa83de2db4ba782>1.4.6 - verify kubectl install</h1><div class=lead>How to verify kubectl.</div><p>In order for kubectl to find and access a Kubernetes cluster, it needs a
<a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>,
which is created automatically when you create a cluster using
<a href=https://github.com/kubernetes/kubernetes/blob/master/cluster/kube-up.sh>kube-up.sh</a>
or successfully deploy a Minikube cluster.
By default, kubectl configuration is located at <code>~/.kube/config</code>.</p><p>Check that kubectl is properly configured by getting the cluster state:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info
</span></span></code></pre></div><p>If you see a URL response, kubectl is correctly configured to access your cluster.</p><p>If you see a message similar to the following, kubectl is not configured correctly or is not able to connect to a Kubernetes cluster.</p><pre tabindex=0><code>The connection to the server &lt;server-name:port&gt; was refused - did you specify the right host or port?
</code></pre><p>For example, if you are intending to run a Kubernetes cluster on your laptop (locally), you will need a tool like Minikube to be installed first and then re-run the commands stated above.</p><p>If kubectl cluster-info returns the url response but you can't access your cluster, to check whether it is configured properly, use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info dump
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-99d563e9521796074ba3ca7f15a613ce>1.4.7 - What's next?</h1><div class=lead>What's next after installing kubectl.</div><ul><li><a href=https://minikube.sigs.k8s.io/docs/start/>Install Minikube</a></li><li>See the <a href=/docs/setup/>getting started guides</a> for more about creating clusters.</li><li><a href=/docs/tasks/access-application-cluster/service-access-application-cluster/>Learn how to launch and expose your application.</a></li><li>If you need access to a cluster you didn't create, see the
<a href=/docs/tasks/access-application-cluster/configure-access-multiple-clusters/>Sharing Cluster Access document</a>.</li><li>Read the <a href=/docs/reference/kubectl/kubectl/>kubectl reference docs</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9ab27577326839cb4793fd670a916364>1.4.8 - zsh auto-completion</h1><div class=lead>Some optional configuration for zsh auto-completion.</div><p>The kubectl completion script for Zsh can be generated with the command <code>kubectl completion zsh</code>. Sourcing the completion script in your shell enables kubectl autocompletion.</p><p>To do so in all your shell sessions, add the following to your <code>~/.zshrc</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#a2f>source</span> &lt;<span style=color:#666>(</span>kubectl completion zsh<span style=color:#666>)</span>
</span></span></code></pre></div><p>If you have an alias for kubectl, kubectl autocompletion will automatically work with it.</p><p>After reloading your shell, kubectl autocompletion should be working.</p><p>If you get an error like <code>2: command not found: compdef</code>, then add the following to the beginning of your <code>~/.zshrc</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>autoload -Uz compinit
</span></span><span style=display:flex><span>compinit
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-34a810f1516ad9d99b2697e36e9b0d0f>2 - Administer a Cluster</h1><div class=lead>Learn common tasks for administering a cluster.</div></div><div class=td-content><h1 id=pg-8e16d69617b175d61e2e7a6e1642c9d6>2.1 - Administration with kubeadm</h1></div><div class=td-content><h1 id=pg-f62fba1de4084f3be070785757c8079c>2.1.1 - Certificate Management with kubeadm</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.15 [stable]</code></div><p>Client certificates generated by <a href=/docs/reference/setup-tools/kubeadm/>kubeadm</a> expire after 1 year.
This page explains how to manage certificate renewals with kubeadm. It also covers other tasks related
to kubeadm certificate management.</p><h2 id=before-you-begin>Before you begin</h2><p>You should be familiar with <a href=/docs/setup/best-practices/certificates/>PKI certificates and requirements in Kubernetes</a>.</p><h2 id=custom-certificates>Using custom certificates</h2><p>By default, kubeadm generates all the certificates needed for a cluster to run.
You can override this behavior by providing your own certificates.</p><p>To do so, you must place them in whatever directory is specified by the
<code>--cert-dir</code> flag or the <code>certificatesDir</code> field of kubeadm's <code>ClusterConfiguration</code>.
By default this is <code>/etc/kubernetes/pki</code>.</p><p>If a given certificate and private key pair exists before running <code>kubeadm init</code>,
kubeadm does not overwrite them. This means you can, for example, copy an existing
CA into <code>/etc/kubernetes/pki/ca.crt</code> and <code>/etc/kubernetes/pki/ca.key</code>,
and kubeadm will use this CA for signing the rest of the certificates.</p><h2 id=external-ca-mode>External CA mode</h2><p>It is also possible to provide only the <code>ca.crt</code> file and not the
<code>ca.key</code> file (this is only available for the root CA file, not other cert pairs).
If all other certificates and kubeconfig files are in place, kubeadm recognizes
this condition and activates the "External CA" mode. kubeadm will proceed without the
CA key on disk.</p><p>Instead, run the controller-manager standalone with <code>--controllers=csrsigner</code> and
point to the CA certificate and key.</p><p><a href=/docs/setup/best-practices/certificates/>PKI certificates and requirements</a> includes guidance on
setting up a cluster to use an external CA.</p><h2 id=check-certificate-expiration>Check certificate expiration</h2><p>You can use the <code>check-expiration</code> subcommand to check when certificates expire:</p><pre tabindex=0><code>kubeadm certs check-expiration
</code></pre><p>The output is similar to this:</p><pre tabindex=0><code>CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Dec 30, 2020 23:36 UTC   364d                                    no
apiserver                  Dec 30, 2020 23:36 UTC   364d            ca                      no
apiserver-etcd-client      Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
apiserver-kubelet-client   Dec 30, 2020 23:36 UTC   364d            ca                      no
controller-manager.conf    Dec 30, 2020 23:36 UTC   364d                                    no
etcd-healthcheck-client    Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-peer                  Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-server                Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
front-proxy-client         Dec 30, 2020 23:36 UTC   364d            front-proxy-ca          no
scheduler.conf             Dec 30, 2020 23:36 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Dec 28, 2029 23:36 UTC   9y              no
etcd-ca                 Dec 28, 2029 23:36 UTC   9y              no
front-proxy-ca          Dec 28, 2029 23:36 UTC   9y              no
</code></pre><p>The command shows expiration/residual time for the client certificates in the <code>/etc/kubernetes/pki</code> folder and for the client certificate embedded in the KUBECONFIG files used by kubeadm (<code>admin.conf</code>, <code>controller-manager.conf</code> and <code>scheduler.conf</code>).</p><p>Additionally, kubeadm informs the user if the certificate is externally managed; in this case, the user should take care of managing certificate renewal manually/using other tools.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> <code>kubeadm</code> cannot manage certificates signed by an external CA.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>kubelet.conf</code> is not included in the list above because kubeadm configures kubelet
for <a href=/docs/tasks/tls/certificate-rotation/>automatic certificate renewal</a>
with rotatable certificates under <code>/var/lib/kubelet/pki</code>.
To repair an expired kubelet client certificate see
<a href=/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/#kubelet-client-cert>Kubelet client certificate rotation fails</a>.</div><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong><p>On nodes created with <code>kubeadm init</code>, prior to kubeadm version 1.17, there is a
<a href=https://github.com/kubernetes/kubeadm/issues/1753>bug</a> where you manually have to modify the contents of <code>kubelet.conf</code>. After <code>kubeadm init</code> finishes, you should update <code>kubelet.conf</code> to point to the
rotated kubelet client certificates, by replacing <code>client-certificate-data</code> and <code>client-key-data</code> with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>client-certificate</span>:<span style=color:#bbb> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>client-key</span>:<span style=color:#bbb> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style=color:#bbb>
</span></span></span></code></pre></div></div><h2 id=automatic-certificate-renewal>Automatic certificate renewal</h2><p>kubeadm renews all the certificates during control plane <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>upgrade</a>.</p><p>This feature is designed for addressing the simplest use cases;
if you don't have specific requirements on certificate renewal and perform Kubernetes version upgrades regularly (less than 1 year in between each upgrade), kubeadm will take care of keeping your cluster up to date and reasonably secure.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> It is a best practice to upgrade your cluster frequently in order to stay secure.</div><p>If you have more complex requirements for certificate renewal, you can opt out from the default behavior by passing <code>--certificate-renewal=false</code> to <code>kubeadm upgrade apply</code> or to <code>kubeadm upgrade node</code>.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Prior to kubeadm version 1.17 there is a <a href=https://github.com/kubernetes/kubeadm/issues/1818>bug</a>
where the default value for <code>--certificate-renewal</code> is <code>false</code> for the <code>kubeadm upgrade node</code>
command. In that case, you should explicitly set <code>--certificate-renewal=true</code>.</div><h2 id=manual-certificate-renewal>Manual certificate renewal</h2><p>You can renew your certificates manually at any time with the <code>kubeadm certs renew</code> command.</p><p>This command performs the renewal using CA (or front-proxy-CA) certificate and key stored in <code>/etc/kubernetes/pki</code>.</p><p>After running the command you should restart the control plane Pods. This is required since
dynamic certificate reload is currently not supported for all components and certificates.
<a href=/docs/tasks/configure-pod-container/static-pod/>Static Pods</a> are managed by the local kubelet
and not by the API Server, thus kubectl cannot be used to delete and restart them.
To restart a static Pod you can temporarily remove its manifest file from <code>/etc/kubernetes/manifests/</code>
and wait for 20 seconds (see the <code>fileCheckFrequency</code> value in <a href=/docs/reference/config-api/kubelet-config.v1beta1/>KubeletConfiguration struct</a>.
The kubelet will terminate the Pod if it's no longer in the manifest directory.
You can then move the file back and after another <code>fileCheckFrequency</code> period, the kubelet will recreate
the Pod and the certificate renewal for the component can complete.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> If you are running an HA cluster, this command needs to be executed on all the control-plane nodes.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>certs renew</code> uses the existing certificates as the authoritative source for attributes (Common Name, Organization, SAN, etc.) instead of the kubeadm-config ConfigMap. It is strongly recommended to keep them both in sync.</div><p><code>kubeadm certs renew</code> provides the following options:</p><p>The Kubernetes certificates normally reach their expiration date after one year.</p><ul><li><p><code>--csr-only</code> can be used to renew certificates with an external CA by generating certificate signing requests (without actually renewing certificates in place); see next paragraph for more information.</p></li><li><p>It's also possible to renew a single certificate instead of all.</p></li></ul><h2 id=renew-certificates-with-the-kubernetes-certificates-api>Renew certificates with the Kubernetes certificates API</h2><p>This section provides more details about how to execute manual certificate renewal using the Kubernetes certificates API.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> These are advanced topics for users who need to integrate their organization's certificate infrastructure into a kubeadm-built cluster. If the default kubeadm configuration satisfies your needs, you should let kubeadm manage certificates instead.</div><h3 id=set-up-a-signer>Set up a signer</h3><p>The Kubernetes Certificate Authority does not work out of the box.
You can configure an external signer such as <a href=https://cert-manager.io/docs/configuration/ca/>cert-manager</a>, or you can use the built-in signer.</p><p>The built-in signer is part of <a href=/docs/reference/command-line-tools-reference/kube-controller-manager/><code>kube-controller-manager</code></a>.</p><p>To activate the built-in signer, you must pass the <code>--cluster-signing-cert-file</code> and <code>--cluster-signing-key-file</code> flags.</p><p>If you're creating a new cluster, you can use a kubeadm <a href=https://pkg.go.dev/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta3>configuration file</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerManager</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraArgs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster-signing-cert-file</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/ca.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster-signing-key-file</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/ca.key<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=create-certificate-signing-requests-csr>Create certificate signing requests (CSR)</h3><p>See <a href=/docs/reference/access-authn-authz/certificate-signing-requests/#create-certificatesigningrequest>Create CertificateSigningRequest</a> for creating CSRs with the Kubernetes API.</p><h2 id=renew-certificates-with-external-ca>Renew certificates with external CA</h2><p>This section provide more details about how to execute manual certificate renewal using an external CA.</p><p>To better integrate with external CAs, kubeadm can also produce certificate signing requests (CSRs).
A CSR represents a request to a CA for a signed certificate for a client.
In kubeadm terms, any certificate that would normally be signed by an on-disk CA can be produced as a CSR instead. A CA, however, cannot be produced as a CSR.</p><h3 id=create-certificate-signing-requests-csr-1>Create certificate signing requests (CSR)</h3><p>You can create certificate signing requests with <code>kubeadm certs renew --csr-only</code>.</p><p>Both the CSR and the accompanying private key are given in the output.
You can pass in a directory with <code>--csr-dir</code> to output the CSRs to the specified location.
If <code>--csr-dir</code> is not specified, the default certificate directory (<code>/etc/kubernetes/pki</code>) is used.</p><p>Certificates can be renewed with <code>kubeadm certs renew --csr-only</code>.
As with <code>kubeadm init</code>, an output directory can be specified with the <code>--csr-dir</code> flag.</p><p>A CSR contains a certificate's name, domains, and IPs, but it does not specify usages.
It is the responsibility of the CA to specify <a href=/docs/setup/best-practices/certificates/#all-certificates>the correct cert usages</a>
when issuing a certificate.</p><ul><li>In <code>openssl</code> this is done with the
<a href=https://superuser.com/questions/738612/openssl-ca-keyusage-extension><code>openssl ca</code> command</a>.</li><li>In <code>cfssl</code> you specify
<a href=https://github.com/cloudflare/cfssl/blob/master/doc/cmd/cfssl.txt#L170>usages in the config file</a>.</li></ul><p>After a certificate is signed using your preferred method, the certificate and the private key must be copied to the PKI directory (by default <code>/etc/kubernetes/pki</code>).</p><h2 id=certificate-authority-rotation>Certificate authority (CA) rotation</h2><p>Kubeadm does not support rotation or replacement of CA certificates out of the box.</p><p>For more information about manual rotation or replacement of CA, see <a href=/docs/tasks/tls/manual-rotation-of-ca-certificates/>manual rotation of CA certificates</a>.</p><h2 id=kubelet-serving-certs>Enabling signed kubelet serving certificates</h2><p>By default the kubelet serving certificate deployed by kubeadm is self-signed.
This means a connection from external services like the
<a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a> to a
kubelet cannot be secured with TLS.</p><p>To configure the kubelets in a new kubeadm cluster to obtain properly signed serving
certificates you must pass the following minimal configuration to <code>kubeadm init</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubelet.config.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>KubeletConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>serverTLSBootstrap</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>If you have already created the cluster you must adapt it by doing the following:</p><ul><li>Find and edit the <code>kubelet-config-1.25</code> ConfigMap in the <code>kube-system</code> namespace.
In that ConfigMap, the <code>kubelet</code> key has a
<a href=/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration>KubeletConfiguration</a>
document as its value. Edit the KubeletConfiguration document to set <code>serverTLSBootstrap: true</code>.</li><li>On each node, add the <code>serverTLSBootstrap: true</code> field in <code>/var/lib/kubelet/config.yaml</code>
and restart the kubelet with <code>systemctl restart kubelet</code></li></ul><p>The field <code>serverTLSBootstrap: true</code> will enable the bootstrap of kubelet serving
certificates by requesting them from the <code>certificates.k8s.io</code> API. One known limitation
is that the CSRs (Certificate Signing Requests) for these certificates cannot be automatically
approved by the default signer in the kube-controller-manager -
<a href=/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers><code>kubernetes.io/kubelet-serving</code></a>.
This will require action from the user or a third party controller.</p><p>These CSRs can be viewed using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get csr
</span></span><span style=display:flex><span>NAME        AGE     SIGNERNAME                        REQUESTOR                      CONDITION
</span></span><span style=display:flex><span>csr-9wvgt   112s    kubernetes.io/kubelet-serving     system:node:worker-1           Pending
</span></span><span style=display:flex><span>csr-lz97v   1m58s   kubernetes.io/kubelet-serving     system:node:control-plane-1    Pending
</span></span></code></pre></div><p>To approve them you can do the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl certificate approve &lt;CSR-name&gt;
</span></span></code></pre></div><p>By default, these serving certificate will expire after one year. Kubeadm sets the
<code>KubeletConfiguration</code> field <code>rotateCertificates</code> to <code>true</code>, which means that close
to expiration a new set of CSRs for the serving certificates will be created and must
be approved to complete the rotation. To understand more see
<a href=/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/#certificate-rotation>Certificate Rotation</a>.</p><p>If you are looking for a solution for automatic approval of these CSRs it is recommended
that you contact your cloud provider and ask if they have a CSR signer that verifies
the node identity with an out of band mechanism.</p><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>Third party custom controllers can be used:</p><ul><li><a href=https://github.com/postfinance/kubelet-csr-approver>kubelet-csr-approver</a></li></ul><p>Such a controller is not a secure mechanism unless it not only verifies the CommonName
in the CSR but also verifies the requested IPs and domain names. This would prevent
a malicious actor that has access to a kubelet client certificate to create
CSRs requesting serving certificates for any IP or domain name.</p><h2 id=kubeconfig-additional-users>Generating kubeconfig files for additional users</h2><p>During cluster creation, kubeadm signs the certificate in the <code>admin.conf</code> to have
<code>Subject: O = system:masters, CN = kubernetes-admin</code>.
<a href=/docs/reference/access-authn-authz/rbac/#user-facing-roles><code>system:masters</code></a>
is a break-glass, super user group that bypasses the authorization layer (e.g. RBAC).
Sharing the <code>admin.conf</code> with additional users is <strong>not recommended</strong>!</p><p>Instead, you can use the <a href=/docs/reference/setup-tools/kubeadm/kubeadm-kubeconfig><code>kubeadm kubeconfig user</code></a>
command to generate kubeconfig files for additional users.
The command accepts a mixture of command line flags and
<a href=/docs/reference/config-api/kubeadm-config.v1beta3/>kubeadm configuration</a> options.
The generated kubeconfig will be written to stdout and can be piped to a file
using <code>kubeadm kubeconfig user ... > somefile.conf</code>.</p><p>Example configuration file that can be used with <code>--config</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># example.yaml</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Will be used as the target &#34;cluster&#34; in the kubeconfig</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>clusterName</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;kubernetes&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Will be used as the &#34;server&#34; (IP or DNS name) of this cluster in the kubeconfig</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>controlPlaneEndpoint</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;some-dns-address:6443&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># The cluster CA key and certificate will be loaded from this local directory</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>certificatesDir</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/etc/kubernetes/pki&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Make sure that these settings match the desired target cluster settings.
To see the settings of an existing cluster use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get cm kubeadm-config -n kube-system -o<span style=color:#666>=</span><span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{.data.ClusterConfiguration}&#34;</span>
</span></span></code></pre></div><p>The following example will generate a kubeconfig file with credentials valid for 24 hours
for a new user <code>johndoe</code> that is part of the <code>appdevs</code> group:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm kubeconfig user --config example.yaml --org appdevs --client-name johndoe --validity-period 24h
</span></span></code></pre></div><p>The following example will generate a kubeconfig file with administrator credentials valid for 1 week:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm kubeconfig user --config example.yaml --client-name admin --validity-period 168h
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6134c5061298affa145ddb801b5c29da>2.1.2 - Configuring a cgroup driver</h1><p>This page explains how to configure the kubelet cgroup driver to match the container
runtime cgroup driver for kubeadm clusters.</p><h2 id=before-you-begin>Before you begin</h2><p>You should be familiar with the Kubernetes
<a href=/docs/setup/production-environment/container-runtimes>container runtime requirements</a>.</p><h2 id=configuring-the-container-runtime-cgroup-driver>Configuring the container runtime cgroup driver</h2><p>The <a href=/docs/setup/production-environment/container-runtimes>Container runtimes</a> page
explains that the <code>systemd</code> driver is recommended for kubeadm based setups instead
of the <code>cgroupfs</code> driver, because kubeadm manages the kubelet as a systemd service.</p><p>The page also provides details on how to set up a number of different container runtimes with the
<code>systemd</code> driver by default.</p><h2 id=configuring-the-kubelet-cgroup-driver>Configuring the kubelet cgroup driver</h2><p>kubeadm allows you to pass a <code>KubeletConfiguration</code> structure during <code>kubeadm init</code>.
This <code>KubeletConfiguration</code> can include the <code>cgroupDriver</code> field which controls the cgroup
driver of the kubelet.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In v1.22, if the user is not setting the <code>cgroupDriver</code> field under <code>KubeletConfiguration</code>,
<code>kubeadm</code> will default it to <code>systemd</code>.</div><p>A minimal example of configuring the field explicitly:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># kubeadm-config.yaml</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kubernetesVersion</span>:<span style=color:#bbb> </span>v1.21.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>KubeletConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubelet.config.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>cgroupDriver</span>:<span style=color:#bbb> </span>systemd<span style=color:#bbb>
</span></span></span></code></pre></div><p>Such a configuration file can then be passed to the kubeadm command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm init --config kubeadm-config.yaml
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>Kubeadm uses the same <code>KubeletConfiguration</code> for all nodes in the cluster.
The <code>KubeletConfiguration</code> is stored in a <a href=/docs/concepts/configuration/configmap>ConfigMap</a>
object under the <code>kube-system</code> namespace.</p><p>Executing the sub commands <code>init</code>, <code>join</code> and <code>upgrade</code> would result in kubeadm
writing the <code>KubeletConfiguration</code> as a file under <code>/var/lib/kubelet/config.yaml</code>
and passing it to the local node kubelet.</p></div><h2 id=using-the-cgroupfs-driver>Using the <code>cgroupfs</code> driver</h2><p>To use <code>cgroupfs</code> and to prevent <code>kubeadm upgrade</code> from modifying the
<code>KubeletConfiguration</code> cgroup driver on existing setups, you must be explicit
about its value. This applies to a case where you do not wish future versions
of kubeadm to apply the <code>systemd</code> driver by default.</p><p>See the below section on "<a href=#modify-the-kubelet-configmap>Modify the kubelet ConfigMap</a>" for details on
how to be explicit about the value.</p><p>If you wish to configure a container runtime to use the <code>cgroupfs</code> driver,
you must refer to the documentation of the container runtime of your choice.</p><h2 id=migrating-to-the-systemd-driver>Migrating to the <code>systemd</code> driver</h2><p>To change the cgroup driver of an existing kubeadm cluster to <code>systemd</code> in-place,
a similar procedure to a kubelet upgrade is required. This must include both
steps outlined below.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Alternatively, it is possible to replace the old nodes in the cluster with new ones
that use the <code>systemd</code> driver. This requires executing only the first step below
before joining the new nodes and ensuring the workloads can safely move to the new
nodes before deleting the old nodes.</div><h3 id=modify-the-kubelet-configmap>Modify the kubelet ConfigMap</h3><ul><li><p>Call <code>kubectl edit cm kubelet-config -n kube-system</code>.</p></li><li><p>Either modify the existing <code>cgroupDriver</code> value or add a new field that looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>cgroupDriver</span>:<span style=color:#bbb> </span>systemd<span style=color:#bbb>
</span></span></span></code></pre></div><p>This field must be present under the <code>kubelet:</code> section of the ConfigMap.</p></li></ul><h3 id=update-the-cgroup-driver-on-all-nodes>Update the cgroup driver on all nodes</h3><p>For each node in the cluster:</p><ul><li><a href=/docs/tasks/administer-cluster/safely-drain-node>Drain the node</a> using <code>kubectl drain &lt;node-name> --ignore-daemonsets</code></li><li>Stop the kubelet using <code>systemctl stop kubelet</code></li><li>Stop the container runtime</li><li>Modify the container runtime cgroup driver to <code>systemd</code></li><li>Set <code>cgroupDriver: systemd</code> in <code>/var/lib/kubelet/config.yaml</code></li><li>Start the container runtime</li><li>Start the kubelet using <code>systemctl start kubelet</code></li><li><a href=/docs/tasks/administer-cluster/safely-drain-node>Uncordon the node</a> using <code>kubectl uncordon &lt;node-name></code></li></ul><p>Execute these steps on nodes one at a time to ensure workloads
have sufficient time to schedule on different nodes.</p><p>Once the process is complete ensure that all nodes and workloads are healthy.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-98530eb3653d28fef34bff4543364aa7>2.1.3 - Reconfiguring a kubeadm cluster</h1><p>kubeadm does not support automated ways of reconfiguring components that
were deployed on managed nodes. One way of automating this would be
by using a custom <a href=/docs/concepts/extend-kubernetes/operator/>operator</a>.</p><p>To modify the components configuration you must manually edit associated cluster
objects and files on disk.</p><p>This guide shows the correct sequence of steps that need to be performed
to achieve kubeadm cluster reconfiguration.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>You need a cluster that was deployed using kubeadm</li><li>Have administrator credentials (<code>/etc/kubernetes/admin.conf</code>) and network connectivity
to a running kube-apiserver in the cluster from a host that has kubectl installed</li><li>Have a text editor installed on all hosts</li></ul><h2 id=reconfiguring-the-cluster>Reconfiguring the cluster</h2><p>kubeadm writes a set of cluster wide component configuration options in
ConfigMaps and other objects. These objects must be manually edited. The command <code>kubectl edit</code>
can be used for that.</p><p>The <code>kubectl edit</code> command will open a text editor where you can edit and save the object directly.</p><p>You can use the environment variables <code>KUBECONFIG</code> and <code>KUBE_EDITOR</code> to specify the location of
the kubectl consumed kubeconfig file and preferred text editor.</p><p>For example:</p><pre tabindex=0><code>KUBECONFIG=/etc/kubernetes/admin.conf KUBE_EDITOR=nano kubectl edit &lt;parameters&gt;
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Upon saving any changes to these cluster objects, components running on nodes may not be
automatically updated. The steps below instruct you on how to perform that manually.</div><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Component configuration in ConfigMaps is stored as unstructured data (YAML string).
This means that validation will not be performed upon updating the contents of a ConfigMap.
You have to be careful to follow the documented API format for a particular
component configuration and avoid introducing typos and YAML indentation mistakes.</div><h3 id=applying-cluster-configuration-changes>Applying cluster configuration changes</h3><h4 id=updating-the-clusterconfiguration>Updating the <code>ClusterConfiguration</code></h4><p>During cluster creation and upgrade, kubeadm writes its
<a href=/docs/reference/config-api/kubeadm-config.v1beta3/><code>ClusterConfiguration</code></a>
in a ConfigMap called <code>kubeadm-config</code> in the <code>kube-system</code> namespace.</p><p>To change a particular option in the <code>ClusterConfiguration</code> you can edit the ConfigMap with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit cm -n kube-system kubeadm-config
</span></span></code></pre></div><p>The configuration is located under the <code>data.ClusterConfiguration</code> key.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The <code>ClusterConfiguration</code> includes a variety of options that affect the configuration of individual
components such as kube-apiserver, kube-scheduler, kube-controller-manager, CoreDNS, etcd and kube-proxy.
Changes to the configuration must be reflected on node components manually.</div><h4 id=reflecting-clusterconfiguration-changes-on-control-plane-nodes>Reflecting <code>ClusterConfiguration</code> changes on control plane nodes</h4><p>kubeadm manages the control plane components as static Pod manifests located in
the directory <code>/etc/kubernetes/manifests</code>.
Any changes to the <code>ClusterConfiguration</code> under the <code>apiServer</code>, <code>controllerManager</code>, <code>scheduler</code> or <code>etcd</code>
keys must be reflected in the associated files in the manifests directory on a control plane node.</p><p>Such changes may include:</p><ul><li><code>extraArgs</code> - requires updating the list of flags passed to a component container</li><li><code>extraMounts</code> - requires updated the volume mounts for a component container</li><li><code>*SANs</code> - requires writing new certificates with updated Subject Alternative Names.</li></ul><p>Before proceeding with these changes, make sure you have backed up the directory <code>/etc/kubernetes/</code>.</p><p>To write new certificates you can use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm init phase certs &lt;component-name&gt; --config &lt;config-file&gt;
</span></span></code></pre></div><p>To write new manifest files in <code>/etc/kubernetes/manifests</code> you can use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm init phase control-plane &lt;component-name&gt; --config &lt;config-file&gt;
</span></span></code></pre></div><p>The <code>&lt;config-file></code> contents must match the updated <code>ClusterConfiguration</code>.
The <code>&lt;component-name></code> value must be the name of the component.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Updating a file in <code>/etc/kubernetes/manifests</code> will tell the kubelet to restart the static Pod for the corresponding component.
Try doing these changes one node at a time to leave the cluster without downtime.</div><h3 id=applying-kubelet-configuration-changes>Applying kubelet configuration changes</h3><h4 id=updating-the-kubeletconfiguration>Updating the <code>KubeletConfiguration</code></h4><p>During cluster creation and upgrade, kubeadm writes its
<a href=/docs/reference/config-api/kubelet-config.v1beta1/><code>KubeletConfiguration</code></a>
in a ConfigMap called <code>kubelet-config</code> in the <code>kube-system</code> namespace.</p><p>You can edit the ConfigMap with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit cm -n kube-system kubelet-config
</span></span></code></pre></div><p>The configuration is located under the <code>data.kubelet</code> key.</p><h4 id=reflecting-the-kubelet-changes>Reflecting the kubelet changes</h4><p>To reflect the change on kubeadm nodes you must do the following:</p><ul><li>Log in to a kubeadm node</li><li>Run <code>kubeadm upgrade node phase kubelet-config</code> to download the latest <code>kubelet-config</code>
ConfigMap contents into the local file <code>/var/lib/kubelet/config.conf</code></li><li>Edit the file <code>/var/lib/kubelet/kubeadm-flags.env</code> to apply additional configuration with
flags</li><li>Restart the kubelet service with <code>systemctl restart kubelet</code></li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Do these changes one node at a time to allow workloads to be rescheduled properly.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> During <code>kubeadm upgrade</code>, kubeadm downloads the <code>KubeletConfiguration</code> from the
<code>kubelet-config</code> ConfigMap and overwrite the contents of <code>/var/lib/kubelet/config.conf</code>.
This means that node local configuration must be applied either by flags in
<code>/var/lib/kubelet/kubeadm-flags.env</code> or by manually updating the contents of
<code>/var/lib/kubelet/config.conf</code> after <code>kubeadm upgrade</code>, and then restarting the kubelet.</div><h3 id=applying-kube-proxy-configuration-changes>Applying kube-proxy configuration changes</h3><h4 id=updating-the-kubeproxyconfiguration>Updating the <code>KubeProxyConfiguration</code></h4><p>During cluster creation and upgrade, kubeadm writes its
<a href=/docs/reference/config-api/kube-proxy-config.v1alpha1/><code>KubeProxyConfiguration</code></a>
in a ConfigMap in the <code>kube-system</code> namespace called <code>kube-proxy</code>.</p><p>This ConfigMap is used by the <code>kube-proxy</code> DaemonSet in the <code>kube-system</code> namespace.</p><p>To change a particular option in the <code>KubeProxyConfiguration</code>, you can edit the ConfigMap with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit cm -n kube-system kube-proxy
</span></span></code></pre></div><p>The configuration is located under the <code>data.config.conf</code> key.</p><h4 id=reflecting-the-kube-proxy-changes>Reflecting the kube-proxy changes</h4><p>Once the <code>kube-proxy</code> ConfigMap is updated, you can restart all kube-proxy Pods:</p><p>Obtain the Pod names:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get po -n kube-system | grep kube-proxy
</span></span></code></pre></div><p>Delete a Pod with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete po -n kube-system &lt;pod-name&gt;
</span></span></code></pre></div><p>New Pods that use the updated ConfigMap will be created.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Because kubeadm deploys kube-proxy as a DaemonSet, node specific configuration is unsupported.</div><h3 id=applying-coredns-configuration-changes>Applying CoreDNS configuration changes</h3><h4 id=updating-the-coredns-deployment-and-service>Updating the CoreDNS Deployment and Service</h4><p>kubeadm deploys CoreDNS as a Deployment called <code>coredns</code> and with a Service <code>kube-dns</code>,
both in the <code>kube-system</code> namespace.</p><p>To update any of the CoreDNS settings, you can edit the Deployment and
Service objects:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit deployment -n kube-system coredns
</span></span><span style=display:flex><span>kubectl edit service -n kube-system kube-dns
</span></span></code></pre></div><h4 id=reflecting-the-coredns-changes>Reflecting the CoreDNS changes</h4><p>Once the CoreDNS changes are applied you can delete the CoreDNS Pods:</p><p>Obtain the Pod names:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get po -n kube-system | grep coredns
</span></span></code></pre></div><p>Delete a Pod with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete po -n kube-system &lt;pod-name&gt;
</span></span></code></pre></div><p>New Pods with the updated CoreDNS configuration will be created.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> kubeadm does not allow CoreDNS configuration during cluster creation and upgrade.
This means that if you execute <code>kubeadm upgrade apply</code>, your changes to the CoreDNS
objects will be lost and must be reapplied.</div><h2 id=persisting-the-reconfiguration>Persisting the reconfiguration</h2><p>During the execution of <code>kubeadm upgrade</code> on a managed node, kubeadm might overwrite configuration
that was applied after the cluster was created (reconfiguration).</p><h3 id=persisting-node-object-reconfiguration>Persisting Node object reconfiguration</h3><p>kubeadm writes Labels, Taints, CRI socket and other information on the Node object for a particular
Kubernetes node. To change any of the contents of this Node object you can use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit no &lt;node-name&gt;
</span></span></code></pre></div><p>During <code>kubeadm upgrade</code> the contents of such a Node might get overwritten.
If you would like to persist your modifications to the Node object after upgrade,
you can prepare a <a href=/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/>kubectl patch</a>
and apply it to the Node object:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch no &lt;node-name&gt; --patch-file &lt;patch-file&gt;
</span></span></code></pre></div><h4 id=persisting-control-plane-component-reconfiguration>Persisting control plane component reconfiguration</h4><p>The main source of control plane configuration is the <code>ClusterConfiguration</code>
object stored in the cluster. To extend the static Pod manifests configuration,
<a href=/docs/setup/production-environment/tools/kubeadm/control-plane-flags/#patches>patches</a> can be used.</p><p>These patch files must remain as files on the control plane nodes to ensure that
they can be used by the <code>kubeadm upgrade ... --patches &lt;directory></code>.</p><p>If reconfiguration is done to the <code>ClusterConfiguration</code> and static Pod manifests on disk,
the set of node specific patches must be updated accordingly.</p><h4 id=persisting-kubelet-reconfiguration>Persisting kubelet reconfiguration</h4><p>Any changes to the <code>KubeletConfiguration</code> stored in <code>/var/lib/kubelet/config.conf</code> will be overwritten on
<code>kubeadm upgrade</code> by downloading the contents of the cluster wide <code>kubelet-config</code> ConfigMap.
To persist kubelet node specific configuration either the file <code>/var/lib/kubelet/config.conf</code>
has to be updated manually post-upgrade or the file <code>/var/lib/kubelet/kubeadm-flags.env</code> can include flags.
The kubelet flags override the associated <code>KubeletConfiguration</code> options, but note that
some of the flags are deprecated.</p><p>A kubelet restart will be required after changing <code>/var/lib/kubelet/config.conf</code> or
<code>/var/lib/kubelet/kubeadm-flags.env</code>.</p><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade>Upgrading kubeadm clusters</a></li><li><a href=/docs/setup/production-environment/tools/kubeadm/control-plane-flags>Customizing components with the kubeadm API</a></li><li><a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-certs>Certificate management with kubeadm</a></li><li><a href=/docs/reference/setup-tools/kubeadm/>Find more about kubeadm set-up</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2e173356df5179cab9eec90a606f0aa4>2.1.4 - Upgrading kubeadm clusters</h1><p>This page explains how to upgrade a Kubernetes cluster created with kubeadm from version
1.24.x to version 1.25.x, and from version
1.25.x to 1.25.y (where <code>y > x</code>). Skipping MINOR versions
when upgrading is unsupported. For more details, please visit <a href=/releases/version-skew-policy/>Version Skew Policy</a>.</p><p>To see information about upgrading clusters created using older versions of kubeadm,
please refer to following pages instead:</p><ul><li><a href=https://v1-24.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading a kubeadm cluster from 1.23 to 1.24</a></li><li><a href=https://v1-23.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading a kubeadm cluster from 1.22 to 1.23</a></li><li><a href=https://v1-22.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading a kubeadm cluster from 1.21 to 1.22</a></li><li><a href=https://v1-21.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading a kubeadm cluster from 1.20 to 1.21</a></li></ul><p>The upgrade workflow at high level is the following:</p><ol><li>Upgrade a primary control plane node.</li><li>Upgrade additional control plane nodes.</li><li>Upgrade worker nodes.</li></ol><h2 id=before-you-begin>Before you begin</h2><ul><li>Make sure you read the <a href=https://git.k8s.io/kubernetes/CHANGELOG>release notes</a> carefully.</li><li>The cluster should use a static control plane and etcd pods or external etcd.</li><li>Make sure to back up any important components, such as app-level state stored in a database.
<code>kubeadm upgrade</code> does not touch your workloads, only components internal to Kubernetes, but backups are always a best practice.</li><li><a href=https://serverfault.com/questions/684771/best-way-to-disable-swap-in-linux>Swap must be disabled</a>.</li></ul><h3 id=additional-information>Additional information</h3><ul><li>The instructions below outline when to drain each node during the upgrade process.
If you are performing a <strong>minor</strong> version upgrade for any kubelet, you <strong>must</strong>
first drain the node (or nodes) that you are upgrading. In the case of control plane nodes,
they could be running CoreDNS Pods or other critical workloads. For more information see
<a href=/docs/tasks/administer-cluster/safely-drain-node/>Draining nodes</a>.</li><li>All containers are restarted after upgrade, because the container spec hash value is changed.</li><li>To verify that the kubelet service has successfully restarted after the kubelet has been upgraded,
you can execute <code>systemctl status kubelet</code> or view the service logs with <code>journalctl -xeu kubelet</code>.</li><li>Usage of the <code>--config</code> flag of <code>kubeadm upgrade</code> with
<a href=/docs/reference/config-api/kubeadm-config.v1beta3>kubeadm configuration API types</a>
with the purpose of reconfiguring the cluster is not recommended and can have unexpected results. Follow the steps in
<a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-reconfigure>Reconfiguring a kubeadm cluster</a> instead.</li></ul><h2 id=determine-which-version-to-upgrade-to>Determine which version to upgrade to</h2><p>Find the latest patch release for Kubernetes 1.25 using the OS package manager:</p><ul class="nav nav-tabs" id=k8s-install-versions role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-versions-0 role=tab aria-controls=k8s-install-versions-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-versions-1 role=tab aria-controls=k8s-install-versions-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-install-versions><div id=k8s-install-versions-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-versions-0><p><pre><code>apt update
apt-cache madison kubeadm
# find the latest 1.25 version in the list
# it should look like 1.25.x-00, where x is the latest patch
</code></pre></div><div id=k8s-install-versions-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-versions-1><p><pre><code>yum list --showduplicates kubeadm --disableexcludes=kubernetes
# find the latest 1.25 version in the list
# it should look like 1.25.x-0, where x is the latest patch
</code></pre></div></div><h2 id=upgrading-control-plane-nodes>Upgrading control plane nodes</h2><p>The upgrade procedure on control plane nodes should be executed one node at a time.
Pick a control plane node that you wish to upgrade first. It must have the <code>/etc/kubernetes/admin.conf</code> file.</p><h3 id=call-kubeadm-upgrade>Call "kubeadm upgrade"</h3><p><strong>For the first control plane node</strong></p><ul><li><p>Upgrade kubeadm:</p><p><ul class="nav nav-tabs" id=k8s-install-kubeadm-first-cp role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-kubeadm-first-cp-0 role=tab aria-controls=k8s-install-kubeadm-first-cp-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-kubeadm-first-cp-1 role=tab aria-controls=k8s-install-kubeadm-first-cp-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-install-kubeadm-first-cp><div id=k8s-install-kubeadm-first-cp-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-kubeadm-first-cp-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> <span style=color:#080;font-style:italic># replace x in 1.25.x-00 with the latest patch version</span>
</span></span><span style=display:flex><span> apt-mark unhold kubeadm <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> apt-get update <span style=color:#666>&amp;&amp;</span> apt-get install -y <span style=color:#b8860b>kubeadm</span><span style=color:#666>=</span>1.25.x-00 <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span> apt-mark hold kubeadm
</span></span></code></pre></div></div><div id=k8s-install-kubeadm-first-cp-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-kubeadm-first-cp-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace x in 1.25.x-0 with the latest patch version</span>
</span></span><span style=display:flex><span>yum install -y kubeadm-1.25.x-0 --disableexcludes<span style=color:#666>=</span>kubernetes
</span></span></code></pre></div></div></div><br></p></li><li><p>Verify that the download works and has the expected version:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm version
</span></span></code></pre></div></li><li><p>Verify the upgrade plan:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm upgrade plan
</span></span></code></pre></div><p>This command checks that your cluster can be upgraded, and fetches the versions you can upgrade to.
It also shows a table with the component config version states.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>kubeadm upgrade</code> also automatically renews the certificates that it manages on this node.
To opt-out of certificate renewal the flag <code>--certificate-renewal=false</code> can be used.
For more information see the <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-certs>certificate management guide</a>.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If <code>kubeadm upgrade plan</code> shows any component configs that require manual upgrade, users must provide
a config file with replacement configs to <code>kubeadm upgrade apply</code> via the <code>--config</code> command line flag.
Failing to do so will cause <code>kubeadm upgrade apply</code> to exit with an error and not perform an upgrade.</div></li><li><p>Choose a version to upgrade to, and run the appropriate command. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace x with the patch version you picked for this upgrade</span>
</span></span><span style=display:flex><span>sudo kubeadm upgrade apply v1.25.x
</span></span></code></pre></div><p>Once the command finishes you should see:</p><pre tabindex=0><code>[upgrade/successful] SUCCESS! Your cluster was upgraded to &#34;v1.25.x&#34;. Enjoy!

[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven&#39;t already done so.
</code></pre></li><li><p>Manually upgrade your CNI provider plugin.</p><p>Your Container Network Interface (CNI) provider may have its own upgrade instructions to follow.
Check the <a href=/docs/concepts/cluster-administration/addons/>addons</a> page to
find your CNI provider and see whether additional upgrade steps are required.</p><p>This step is not required on additional control plane nodes if the CNI provider runs as a DaemonSet.</p></li></ul><p><strong>For the other control plane nodes</strong></p><p>Same as the first control plane node but use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo kubeadm upgrade node
</span></span></code></pre></div><p>instead of:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo kubeadm upgrade apply
</span></span></code></pre></div><p>Also calling <code>kubeadm upgrade plan</code> and upgrading the CNI provider plugin is no longer needed.</p><h3 id=drain-the-node>Drain the node</h3><ul><li><p>Prepare the node for maintenance by marking it unschedulable and evicting the workloads:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node you are draining</span>
</span></span><span style=display:flex><span>kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</span></span></code></pre></div></li></ul><h3 id=upgrade-kubelet-and-kubectl>Upgrade kubelet and kubectl</h3><ul><li><p>Upgrade the kubelet and kubectl:</p><p><ul class="nav nav-tabs" id=k8s-install-kubelet role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-kubelet-0 role=tab aria-controls=k8s-install-kubelet-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-kubelet-1 role=tab aria-controls=k8s-install-kubelet-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-install-kubelet><div id=k8s-install-kubelet-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-kubelet-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace x in 1.25.x-00 with the latest patch version</span>
</span></span><span style=display:flex><span>apt-mark unhold kubelet kubectl <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>apt-get update <span style=color:#666>&amp;&amp;</span> apt-get install -y <span style=color:#b8860b>kubelet</span><span style=color:#666>=</span>1.25.x-00 <span style=color:#b8860b>kubectl</span><span style=color:#666>=</span>1.25.x-00 <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>apt-mark hold kubelet kubectl
</span></span></code></pre></div></div><div id=k8s-install-kubelet-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-kubelet-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace x in 1.25.x-0 with the latest patch version</span>
</span></span><span style=display:flex><span>yum install -y kubelet-1.25.x-0 kubectl-1.25.x-0 --disableexcludes<span style=color:#666>=</span>kubernetes
</span></span></code></pre></div></div></div><br></p></li><li><p>Restart the kubelet:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl restart kubelet
</span></span></code></pre></div></li></ul><h3 id=uncordon-the-node>Uncordon the node</h3><ul><li><p>Bring the node back online by marking it schedulable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace &lt;node-to-uncordon&gt; with the name of your node</span>
</span></span><span style=display:flex><span>kubectl uncordon &lt;node-to-uncordon&gt;
</span></span></code></pre></div></li></ul><h2 id=upgrade-worker-nodes>Upgrade worker nodes</h2><p>The upgrade procedure on worker nodes should be executed one node at a time or few nodes at a time,
without compromising the minimum required capacity for running your workloads.</p><h3 id=upgrade-kubeadm>Upgrade kubeadm</h3><ul><li><p>Upgrade kubeadm:</p><ul class="nav nav-tabs" id=k8s-install-kubeadm-worker-nodes role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-kubeadm-worker-nodes-0 role=tab aria-controls=k8s-install-kubeadm-worker-nodes-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-kubeadm-worker-nodes-1 role=tab aria-controls=k8s-install-kubeadm-worker-nodes-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-install-kubeadm-worker-nodes><div id=k8s-install-kubeadm-worker-nodes-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-kubeadm-worker-nodes-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace x in 1.25.x-00 with the latest patch version</span>
</span></span><span style=display:flex><span>apt-mark unhold kubeadm <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>apt-get update <span style=color:#666>&amp;&amp;</span> apt-get install -y <span style=color:#b8860b>kubeadm</span><span style=color:#666>=</span>1.25.x-00 <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>apt-mark hold kubeadm
</span></span></code></pre></div></div><div id=k8s-install-kubeadm-worker-nodes-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-kubeadm-worker-nodes-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace x in 1.25.x-0 with the latest patch version</span>
</span></span><span style=display:flex><span>yum install -y kubeadm-1.25.x-0 --disableexcludes<span style=color:#666>=</span>kubernetes
</span></span></code></pre></div></div></div></li></ul><h3 id=call-kubeadm-upgrade-1>Call "kubeadm upgrade"</h3><ul><li><p>For worker nodes this upgrades the local kubelet configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo kubeadm upgrade node
</span></span></code></pre></div></li></ul><h3 id=drain-the-node-1>Drain the node</h3><ul><li><p>Prepare the node for maintenance by marking it unschedulable and evicting the workloads:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node you are draining</span>
</span></span><span style=display:flex><span>kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</span></span></code></pre></div></li></ul><h3 id=upgrade-kubelet-and-kubectl-1>Upgrade kubelet and kubectl</h3><ul><li><p>Upgrade the kubelet and kubectl:</p><p><ul class="nav nav-tabs" id=k8s-kubelet-and-kubectl role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-kubelet-and-kubectl-0 role=tab aria-controls=k8s-kubelet-and-kubectl-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-kubelet-and-kubectl-1 role=tab aria-controls=k8s-kubelet-and-kubectl-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-kubelet-and-kubectl><div id=k8s-kubelet-and-kubectl-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-kubelet-and-kubectl-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace x in 1.25.x-00 with the latest patch version</span>
</span></span><span style=display:flex><span>apt-mark unhold kubelet kubectl <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>apt-get update <span style=color:#666>&amp;&amp;</span> apt-get install -y <span style=color:#b8860b>kubelet</span><span style=color:#666>=</span>1.25.x-00 <span style=color:#b8860b>kubectl</span><span style=color:#666>=</span>1.25.x-00 <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>apt-mark hold kubelet kubectl
</span></span></code></pre></div></div><div id=k8s-kubelet-and-kubectl-1 class=tab-pane role=tabpanel aria-labelledby=k8s-kubelet-and-kubectl-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace x in 1.25.x-0 with the latest patch version</span>
</span></span><span style=display:flex><span>yum install -y kubelet-1.25.x-0 kubectl-1.25.x-0 --disableexcludes<span style=color:#666>=</span>kubernetes
</span></span></code></pre></div></div></div><br></p></li><li><p>Restart the kubelet:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl restart kubelet
</span></span></code></pre></div></li></ul><h3 id=uncordon-the-node-1>Uncordon the node</h3><ul><li><p>Bring the node back online by marking it schedulable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace &lt;node-to-uncordon&gt; with the name of your node</span>
</span></span><span style=display:flex><span>kubectl uncordon &lt;node-to-uncordon&gt;
</span></span></code></pre></div></li></ul><h2 id=verify-the-status-of-the-cluster>Verify the status of the cluster</h2><p>After the kubelet is upgraded on all nodes verify that all nodes are available again by running
the following command from anywhere kubectl can access the cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p>The <code>STATUS</code> column should show <code>Ready</code> for all your nodes, and the version number should be updated.</p><h2 id=recovering-from-a-failure-state>Recovering from a failure state</h2><p>If <code>kubeadm upgrade</code> fails and does not roll back, for example because of an unexpected shutdown during execution, you can run <code>kubeadm upgrade</code> again.
This command is idempotent and eventually makes sure that the actual state is the desired state you declare.</p><p>To recover from a bad state, you can also run <code>kubeadm upgrade apply --force</code> without changing the version that your cluster is running.</p><p>During upgrade kubeadm writes the following backup folders under <code>/etc/kubernetes/tmp</code>:</p><ul><li><code>kubeadm-backup-etcd-&lt;date>-&lt;time></code></li><li><code>kubeadm-backup-manifests-&lt;date>-&lt;time></code></li></ul><p><code>kubeadm-backup-etcd</code> contains a backup of the local etcd member data for this control plane Node.
In case of an etcd upgrade failure and if the automatic rollback does not work, the contents of this folder
can be manually restored in <code>/var/lib/etcd</code>. In case external etcd is used this backup folder will be empty.</p><p><code>kubeadm-backup-manifests</code> contains a backup of the static Pod manifest files for this control plane Node.
In case of a upgrade failure and if the automatic rollback does not work, the contents of this folder can be
manually restored in <code>/etc/kubernetes/manifests</code>. If for some reason there is no difference between a pre-upgrade
and post-upgrade manifest file for a certain component, a backup file for it will not be written.</p><h2 id=how-it-works>How it works</h2><p><code>kubeadm upgrade apply</code> does the following:</p><ul><li>Checks that your cluster is in an upgradeable state:<ul><li>The API server is reachable</li><li>All nodes are in the <code>Ready</code> state</li><li>The control plane is healthy</li></ul></li><li>Enforces the version skew policies.</li><li>Makes sure the control plane images are available or available to pull to the machine.</li><li>Generates replacements and/or uses user supplied overwrites if component configs require version upgrades.</li><li>Upgrades the control plane components or rollbacks if any of them fails to come up.</li><li>Applies the new <code>CoreDNS</code> and <code>kube-proxy</code> manifests and makes sure that all necessary RBAC rules are created.</li><li>Creates new certificate and key files of the API server and backs up old files if they're about to expire in 180 days.</li></ul><p><code>kubeadm upgrade node</code> does the following on additional control plane nodes:</p><ul><li>Fetches the kubeadm <code>ClusterConfiguration</code> from the cluster.</li><li>Optionally backups the kube-apiserver certificate.</li><li>Upgrades the static Pod manifests for the control plane components.</li><li>Upgrades the kubelet configuration for this node.</li></ul><p><code>kubeadm upgrade node</code> does the following on worker nodes:</p><ul><li>Fetches the kubeadm <code>ClusterConfiguration</code> from the cluster.</li><li>Upgrades the kubelet configuration for this node.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e805c7d8d4ad6195cb82dbbc843bfc29>2.1.5 - Upgrading Windows nodes</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [beta]</code></div><p>This page explains how to upgrade a Windows node <a href=/docs/tasks/administer-cluster/kubeadm/adding-windows-nodes>created with kubeadm</a>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.17.
To check the version, enter <code>kubectl version</code>.</p><ul><li>Familiarize yourself with <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade>the process for upgrading the rest of your kubeadm
cluster</a>. You will want to
upgrade the control plane nodes before upgrading your Windows nodes.</li></ul><h2 id=upgrading-worker-nodes>Upgrading worker nodes</h2><h3 id=upgrade-kubeadm>Upgrade kubeadm</h3><ol><li><p>From the Windows node, upgrade kubeadm:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#080;font-style:italic># replace v1.25.0 with your desired version</span>
</span></span><span style=display:flex><span>curl.exe -Lo &lt;<span style=color:#a2f>path-to</span>-kubeadm.exe&gt;  <span style=color:#b44>&#34;https://dl.k8s.io/v1.25.0/bin/windows/amd64/kubeadm.exe&#34;</span>
</span></span></code></pre></div></li></ol><h3 id=drain-the-node>Drain the node</h3><ol><li><p>From a machine with access to the Kubernetes API,
prepare the node for maintenance by marking it unschedulable and evicting the workloads:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node you are draining</span>
</span></span><span style=display:flex><span>kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</span></span></code></pre></div><p>You should see output similar to this:</p><pre tabindex=0><code>node/ip-172-31-85-18 cordoned
node/ip-172-31-85-18 drained
</code></pre></li></ol><h3 id=upgrade-the-kubelet-configuration>Upgrade the kubelet configuration</h3><ol><li><p>From the Windows node, call the following command to sync new kubelet configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>kubeadm upgrade node
</span></span></code></pre></div></li></ol><h3 id=upgrade-kubelet-and-kube-proxy>Upgrade kubelet and kube-proxy</h3><ol><li><p>From the Windows node, upgrade and restart the kubelet:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>stop-service</span> kubelet
</span></span><span style=display:flex><span>curl.exe -Lo &lt;<span style=color:#a2f>path-to</span>-kubelet.exe&gt; <span style=color:#b44>&#34;https://dl.k8s.io/v1.25.0/bin/windows/amd64/kubelet.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f>restart-service</span> kubelet
</span></span></code></pre></div></li><li><p>From the Windows node, upgrade and restart the kube-proxy.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>stop-service</span> <span style=color:#a2f>kube-proxy</span>
</span></span><span style=display:flex><span>curl.exe -Lo &lt;<span style=color:#a2f>path-to</span>-kube-proxy.exe&gt; <span style=color:#b44>&#34;https://dl.k8s.io/v1.25.0/bin/windows/amd64/kube-proxy.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f>restart-service</span> <span style=color:#a2f>kube-proxy</span>
</span></span></code></pre></div></li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you are running kube-proxy in a HostProcess container within a Pod, and not as a Windows Service, you can upgrade kube-proxy by applying a newer version of your kube-proxy manifests.</div><h3 id=uncordon-the-node>Uncordon the node</h3><ol><li><p>From a machine with access to the Kubernetes API,
bring the node back online by marking it schedulable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node</span>
</span></span><span style=display:flex><span>kubectl uncordon &lt;node-to-drain&gt;
</span></span></code></pre></div></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-adb6c52e773f4d890595e14a9251f59b>2.2 - Migrating from dockershim</h1><p>This section presents information you need to know when migrating from
dockershim to other container runtimes.</p><p>Since the announcement of <a href=/blog/2020/12/08/kubernetes-1-20-release-announcement/#dockershim-deprecation>dockershim deprecation</a>
in Kubernetes 1.20, there were questions on how this will affect various workloads and Kubernetes
installations. Our <a href=/blog/2022/02/17/dockershim-faq/>Dockershim Removal FAQ</a> is there to help you
to understand the problem better.</p><p>Dockershim was removed from Kubernetes with the release of v1.24.
If you use Docker Engine via dockershim as your container runtime, and wish to upgrade to v1.24,
it is recommended that you either migrate to another runtime or find an alternative means to obtain Docker Engine support.
Check out <a href=/docs/setup/production-environment/container-runtimes/>container runtimes</a>
section to know your options. Make sure to
<a href=https://github.com/kubernetes/kubernetes/issues>report issues</a> you encountered
with the migration. So the issue can be fixed in a timely manner and your cluster would be
ready for dockershim removal.</p><p>Your cluster might have more than one kind of node, although this is not a common
configuration.</p><p>These tasks will help you to migrate:</p><ul><li><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/check-if-dockershim-removal-affects-you/>Check whether Dockershim removal affects you</a></li><li><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/migrate-dockershim-dockerd/>Migrate Docker Engine nodes from dockershim to cri-dockerd</a></li><li><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/migrating-telemetry-and-security-agents/>Migrating telemetry and security agents from dockershim</a></li></ul><h2 id=what-s-next>What's next</h2><ul><li>Check out <a href=/docs/setup/production-environment/container-runtimes/>container runtimes</a>
to understand your options for a container runtime.</li><li>There is a
<a href=https://github.com/kubernetes/kubernetes/issues/106917>GitHub issue</a>
to track discussion about the deprecation and removal of dockershim.</li><li>If you found a defect or other technical concern relating to migrating away from dockershim,
you can <a href=https://github.com/kubernetes/kubernetes/issues/new/choose>report an issue</a>
to the Kubernetes project.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b8acce0768c2f92cdb8eaa31e8072353>2.2.1 - Changing the Container Runtime on a Node from Docker Engine to containerd</h1><p>This task outlines the steps needed to update your container runtime to containerd from Docker. It
is applicable for cluster operators running Kubernetes 1.23 or earlier. This also covers an
example scenario for migrating from dockershim to containerd. Alternative container runtimes
can be picked from this <a href=/docs/setup/production-environment/container-runtimes/>page</a>.</p><h2 id=before-you-begin>Before you begin</h2><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>Install containerd. For more information see
<a href=https://containerd.io/docs/getting-started/>containerd's installation documentation</a>
and for specific prerequisite follow
<a href=/docs/setup/production-environment/container-runtimes/#containerd>the containerd guide</a>.</p><h2 id=drain-the-node>Drain the node</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</span></span></code></pre></div><p>Replace <code>&lt;node-to-drain></code> with the name of your node you are draining.</p><h2 id=stop-the-docker-daemon>Stop the Docker daemon</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl stop kubelet
</span></span><span style=display:flex><span>systemctl disable docker.service --now
</span></span></code></pre></div><h2 id=install-containerd>Install Containerd</h2><p>Follow the <a href=/docs/setup/production-environment/container-runtimes/#containerd>guide</a>
for detailed steps to install containerd.</p><ul class="nav nav-tabs" id=tab-cri-containerd-installation role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tab-cri-containerd-installation-0 role=tab aria-controls=tab-cri-containerd-installation-0 aria-selected=true>Linux</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-cri-containerd-installation-1 role=tab aria-controls=tab-cri-containerd-installation-1>Windows (PowerShell)</a></li></ul><div class=tab-content id=tab-cri-containerd-installation><div id=tab-cri-containerd-installation-0 class="tab-pane show active" role=tabpanel aria-labelledby=tab-cri-containerd-installation-0><p><ol><li><p>Install the <code>containerd.io</code> package from the official Docker repositories.
Instructions for setting up the Docker repository for your respective Linux distribution and
installing the <code>containerd.io</code> package can be found at
<a href=https://github.com/containerd/containerd/blob/main/docs/getting-started.md>Getting started with containerd</a>.</p></li><li><p>Configure containerd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo mkdir -p /etc/containerd
</span></span><span style=display:flex><span>containerd config default | sudo tee /etc/containerd/config.toml
</span></span></code></pre></div></li><li><p>Restart containerd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl restart containerd
</span></span></code></pre></div></li></ol></div><div id=tab-cri-containerd-installation-1 class=tab-pane role=tabpanel aria-labelledby=tab-cri-containerd-installation-1><p><p>Start a Powershell session, set <code>$Version</code> to the desired version (ex: <code>$Version="1.4.3"</code>), and
then run the following commands:</p><ol><li><p>Download containerd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>curl.exe -L https<span>:</span>//github.com/containerd/containerd/releases/download/v<span style=color:#b8860b>$Version</span>/containerd-<span style=color:#b8860b>$Version</span>-windows-amd64.tar.gz -o <span style=color:#a2f>containerd-windows</span>-amd64.tar.gz
</span></span><span style=display:flex><span>tar.exe xvf .\<span style=color:#a2f>containerd-windows</span>-amd64.tar.gz
</span></span></code></pre></div></li><li><p>Extract and configure:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>Copy-Item</span> -Path <span style=color:#b44>&#34;.\bin\&#34;</span> -Destination <span style=color:#b44>&#34;</span><span style=color:#b8860b>$Env:ProgramFiles</span><span style=color:#b44>\containerd&#34;</span> -Recurse -Force
</span></span><span style=display:flex><span><span style=color:#a2f>cd </span><span style=color:#b8860b>$Env:ProgramFiles</span>\containerd\
</span></span><span style=display:flex><span>.\containerd.exe config <span style=color:#a2f;font-weight:700>default</span> | <span style=color:#a2f>Out-File</span> config.toml -Encoding ascii
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Review the configuration. Depending on setup you may want to adjust:</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># - the sandbox_image (Kubernetes pause image)</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># - cni bin_dir and conf_dir locations</span>
</span></span><span style=display:flex><span><span style=color:#a2f>Get-Content</span> config.toml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># (Optional - but highly recommended) Exclude containerd from Windows Defender Scans</span>
</span></span><span style=display:flex><span><span style=color:#a2f>Add-MpPreference</span> -ExclusionProcess <span style=color:#b44>&#34;</span><span style=color:#b8860b>$Env:ProgramFiles</span><span style=color:#b44>\containerd\containerd.exe&#34;</span>
</span></span></code></pre></div></li><li><p>Start containerd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\containerd.exe --register-service
</span></span><span style=display:flex><span><span style=color:#a2f>Start-Service</span> containerd
</span></span></code></pre></div></li></ol></div></div><h2 id=configure-the-kubelet-to-use-containerd-as-its-container-runtime>Configure the kubelet to use containerd as its container runtime</h2><p>Edit the file <code>/var/lib/kubelet/kubeadm-flags.env</code> and add the containerd runtime to the flags.
<code>--container-runtime=remote</code> and
<code>--container-runtime-endpoint=unix:///run/containerd/containerd.sock</code>.</p><p>Users using kubeadm should be aware that the <code>kubeadm</code> tool stores the CRI socket for each host as
an annotation in the Node object for that host. To change it you can execute the following command
on a machine that has the kubeadm <code>/etc/kubernetes/admin.conf</code> file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit no &lt;node-name&gt;
</span></span></code></pre></div><p>This will start a text editor where you can edit the Node object.
To choose a text editor you can set the <code>KUBE_EDITOR</code> environment variable.</p><ul><li><p>Change the value of <code>kubeadm.alpha.kubernetes.io/cri-socket</code> from <code>/var/run/dockershim.sock</code>
to the CRI socket path of your choice (for example <code>unix:///run/containerd/containerd.sock</code>).</p><p>Note that new CRI socket paths must be prefixed with <code>unix://</code> ideally.</p></li><li><p>Save the changes in the text editor, which will update the Node object.</p></li></ul><h2 id=restart-the-kubelet>Restart the kubelet</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start kubelet
</span></span></code></pre></div><h2 id=verify-that-the-node-is-healthy>Verify that the node is healthy</h2><p>Run <code>kubectl get nodes -o wide</code> and containerd appears as the runtime for the node we just changed.</p><h2 id=remove-docker-engine>Remove Docker Engine</h2><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>Finally if everything goes well, remove Docker.</p><ul class="nav nav-tabs" id=tab-remove-docker-engine role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tab-remove-docker-engine-0 role=tab aria-controls=tab-remove-docker-engine-0 aria-selected=true>CentOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-remove-docker-engine-1 role=tab aria-controls=tab-remove-docker-engine-1>Debian</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-remove-docker-engine-2 role=tab aria-controls=tab-remove-docker-engine-2>Fedora</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-remove-docker-engine-3 role=tab aria-controls=tab-remove-docker-engine-3>Ubuntu</a></li></ul><div class=tab-content id=tab-remove-docker-engine><div id=tab-remove-docker-engine-0 class="tab-pane show active" role=tabpanel aria-labelledby=tab-remove-docker-engine-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum remove docker-ce docker-ce-cli
</span></span></code></pre></div></div><div id=tab-remove-docker-engine-1 class=tab-pane role=tabpanel aria-labelledby=tab-remove-docker-engine-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get purge docker-ce docker-ce-cli
</span></span></code></pre></div></div><div id=tab-remove-docker-engine-2 class=tab-pane role=tabpanel aria-labelledby=tab-remove-docker-engine-2><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo dnf remove docker-ce docker-ce-cli
</span></span></code></pre></div></div><div id=tab-remove-docker-engine-3 class=tab-pane role=tabpanel aria-labelledby=tab-remove-docker-engine-3><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get purge docker-ce docker-ce-cli
</span></span></code></pre></div></div></div><p>The preceding commands don't remove images, containers, volumes, or customized configuration files on your host.
To delete them, follow Docker's instructions to <a href=https://docs.docker.com/engine/install/ubuntu/#uninstall-docker-engine>Uninstall Docker Engine</a>.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Docker's instructions for uninstalling Docker Engine create a risk of deleting containerd. Be careful when executing commands.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-d81ef0973a7bb4813e1797a452864742>2.2.2 - Migrate Docker Engine nodes from dockershim to cri-dockerd</h1><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>This page shows you how to migrate your Docker Engine nodes to use <code>cri-dockerd</code>
instead of dockershim. You should follow these steps in these scenarios:</p><ul><li>You want to switch away from dockershim and still use Docker Engine to run
containers in Kubernetes.</li><li>You want to upgrade to Kubernetes v1.25 and your
existing cluster relies on dockershim, in which case you must migrate
from dockershim and <code>cri-dockerd</code> is one of your options.</li></ul><p>To learn more about the removal of dockershim, read the <a href=/dockershim>FAQ page</a>.</p><h2 id=what-is-cri-dockerd>What is cri-dockerd?</h2><p>In Kubernetes 1.23 and earlier, you could use Docker Engine with Kubernetes,
relying on a built-in component of Kubernetes named <em>dockershim</em>.
The dockershim component was removed in the Kubernetes 1.24 release; however,
a third-party replacement, <code>cri-dockerd</code>, is available. The <code>cri-dockerd</code> adapter
lets you use Docker Engine through the <a class=glossary-tooltip title='An API for container runtimes to integrate with kubelet' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/components/#container-runtime target=_blank aria-label='Container Runtime Interface'>Container Runtime Interface</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you already use <code>cri-dockerd</code>, you aren't affected by the dockershim removal.
Before you begin, <a href=/docs/tasks/administer-cluster/migrating-from-dockershim/find-out-runtime-you-use/>Check whether your nodes use the dockershim</a>.</div><p>If you want to migrate to <code>cri-dockerd</code> so that you can continue using Docker
Engine as your container runtime, you should do the following for each affected
node:</p><ol><li>Install <code>cri-dockerd</code>.</li><li>Cordon and drain the node.</li><li>Configure the kubelet to use <code>cri-dockerd</code>.</li><li>Restart the kubelet.</li><li>Verify that the node is healthy.</li></ol><p>Test the migration on non-critical nodes first.</p><p>You should perform the following steps for each node that you want to migrate
to <code>cri-dockerd</code>.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><a href=https://github.com/mirantis/cri-dockerd#build-and-install><code>cri-dockerd</code></a>
installed and started on each node.</li><li>A <a href=/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/>network plugin</a>.</li></ul><h2 id=cordon-and-drain-the-node>Cordon and drain the node</h2><ol><li><p>Cordon the node to stop new Pods scheduling on it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cordon &lt;NODE_NAME&gt;
</span></span></code></pre></div><p>Replace <code>&lt;NODE_NAME></code> with the name of the node.</p></li><li><p>Drain the node to safely evict running Pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl drain &lt;NODE_NAME&gt; <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --ignore-daemonsets
</span></span></code></pre></div></li></ol><h2 id=configure-the-kubelet-to-use-cri-dockerd>Configure the kubelet to use cri-dockerd</h2><p>The following steps apply to clusters set up using the kubeadm tool. If you use
a different tool, you should modify the kubelet using the configuration
instructions for that tool.</p><ol><li>Open <code>/var/lib/kubelet/kubeadm-flags.env</code> on each affected node.</li><li>Modify the <code>--container-runtime-endpoint</code> flag to
<code>unix:///var/run/cri-dockerd.sock</code>.</li></ol><p>The kubeadm tool stores the node's socket as an annotation on the <code>Node</code> object
in the control plane. To modify this socket for each affected node:</p><ol><li><p>Edit the YAML representation of the <code>Node</code> object:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span>/path/to/admin.conf kubectl edit no &lt;NODE_NAME&gt;
</span></span></code></pre></div><p>Replace the following:</p><ul><li><code>/path/to/admin.conf</code>: the path to the kubectl configuration file,
<code>admin.conf</code>.</li><li><code>&lt;NODE_NAME></code>: the name of the node you want to modify.</li></ul></li><li><p>Change <code>kubeadm.alpha.kubernetes.io/cri-socket</code> from
<code>/var/run/dockershim.sock</code> to <code>unix:///var/run/cri-dockerd.sock</code>.</p></li><li><p>Save the changes. The <code>Node</code> object is updated on save.</p></li></ol><h2 id=restart-the-kubelet>Restart the kubelet</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl restart kubelet
</span></span></code></pre></div><h2 id=verify-that-the-node-is-healthy>Verify that the node is healthy</h2><p>To check whether the node uses the <code>cri-dockerd</code> endpoint, follow the
instructions in <a href=/docs/tasks/administer-cluster/migrating-from-dockershim/find-out-runtime-you-use/>Find out which runtime you use</a>.
The <code>--container-runtime-endpoint</code> flag for the kubelet should be <code>unix:///var/run/cri-dockerd.sock</code>.</p><h2 id=uncordon-the-node>Uncordon the node</h2><p>Uncordon the node to let Pods schedule on it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl uncordon &lt;NODE_NAME&gt;
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Read the <a href=/dockershim/>dockershim removal FAQ</a>.</li><li><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/change-runtime-containerd/>Learn how to migrate from Docker Engine with dockershim to containerd</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d79db9ed1698f75ec5f2228987290e49>2.2.3 - Find Out What Container Runtime is Used on a Node</h1><p>This page outlines steps to find out what <a href=/docs/setup/production-environment/container-runtimes/>container runtime</a>
the nodes in your cluster use.</p><p>Depending on the way you run your cluster, the container runtime for the nodes may
have been pre-configured or you need to configure it. If you're using a managed
Kubernetes service, there might be vendor-specific ways to check what container runtime is
configured for the nodes. The method described on this page should work whenever
the execution of <code>kubectl</code> is allowed.</p><h2 id=before-you-begin>Before you begin</h2><p>Install and configure <code>kubectl</code>. See <a href=/docs/tasks/tools/#kubectl>Install Tools</a> section for details.</p><h2 id=find-out-the-container-runtime-used-on-a-node>Find out the container runtime used on a Node</h2><p>Use <code>kubectl</code> to fetch and show node information:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes -o wide
</span></span></code></pre></div><p>The output is similar to the following. The column <code>CONTAINER-RUNTIME</code> outputs
the runtime and its version.</p><p>For Docker Engine, the output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>NAME         STATUS   VERSION    CONTAINER-RUNTIME
node-1       Ready    v1.16.15   docker://19.3.1
node-2       Ready    v1.16.15   docker://19.3.1
node-3       Ready    v1.16.15   docker://19.3.1
</code></pre><p>If your runtime shows as Docker Engine, you still might not be affected by the
removal of dockershim in Kubernetes v1.24. <a href=#which-endpoint>Check the runtime
endpoint</a> to see if you use dockershim. If you don't use
dockershim, you aren't affected.</p><p>For containerd, the output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>NAME         STATUS   VERSION   CONTAINER-RUNTIME
node-1       Ready    v1.19.6   containerd://1.4.1
node-2       Ready    v1.19.6   containerd://1.4.1
node-3       Ready    v1.19.6   containerd://1.4.1
</code></pre><p>Find out more information about container runtimes
on <a href=/docs/setup/production-environment/container-runtimes/>Container Runtimes</a>
page.</p><h2 id=which-endpoint>Find out what container runtime endpoint you use</h2><p>The container runtime talks to the kubelet over a Unix socket using the <a href=/docs/concepts/architecture/cri/>CRI
protocol</a>, which is based on the gRPC
framework. The kubelet acts as a client, and the runtime acts as the server.
In some cases, you might find it useful to know which socket your nodes use. For
example, with the removal of dockershim in Kubernetes v1.24 and later, you might
want to know whether you use Docker Engine with dockershim.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you currently use Docker Engine in your nodes with <code>cri-dockerd</code>, you aren't
affected by the dockershim removal.</div><p>You can check which socket you use by checking the kubelet configuration on your
nodes.</p><ol><li><p>Read the starting commands for the kubelet process:</p><pre tabindex=0><code>tr \\0 &#39; &#39; &lt; /proc/&#34;$(pgrep kubelet)&#34;/cmdline
</code></pre><p>If you don't have <code>tr</code> or <code>pgrep</code>, check the command line for the kubelet
process manually.</p></li><li><p>In the output, look for the <code>--container-runtime</code> flag and the
<code>--container-runtime-endpoint</code> flag.</p><ul><li>If your nodes use Kubernetes v1.23 and earlier and these flags aren't
present or if the <code>--container-runtime</code> flag is not <code>remote</code>,
you use the dockershim socket with Docker Engine.</li><li>If the <code>--container-runtime-endpoint</code> flag is present, check the socket
name to find out which runtime you use. For example,
<code>unix:///run/containerd/containerd.sock</code> is the containerd endpoint.</li></ul></li></ol><p>If you want to change the Container Runtime on a Node from Docker Engine to containerd,
you can find out more information on <a href=/docs/tasks/administer-cluster/migrating-from-dockershim/change-runtime-containerd/>migrating from Docker Engine to containerd</a>,
or, if you want to continue using Docker Engine in Kubernetes v1.24 and later, migrate to a
CRI-compatible adapter like <a href=https://github.com/Mirantis/cri-dockerd><code>cri-dockerd</code></a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c4b5bb78bc6c59690d21c44e41f12270>2.2.4 - Troubleshooting CNI plugin-related errors</h1><p>To avoid CNI plugin-related errors, verify that you are using or upgrading to a
container runtime that has been tested to work correctly with your version of
Kubernetes.</p><h2 id=about-the-incompatible-cni-versions-and-failed-to-destroy-network-for-sandbox-errors>About the "Incompatible CNI versions" and "Failed to destroy network for sandbox" errors</h2><p>Service issues exist for pod CNI network setup and tear down in containerd
v1.6.0-v1.6.3 when the CNI plugins have not been upgraded and/or the CNI config
version is not declared in the CNI config files. The containerd team reports, "these issues are resolved in containerd v1.6.4."</p><p>With containerd v1.6.0-v1.6.3, if you do not upgrade the CNI plugins and/or
declare the CNI config version, you might encounter the following "Incompatible
CNI versions" or "Failed to destroy network for sandbox" error conditions.</p><h3 id=incompatible-cni-versions-error>Incompatible CNI versions error</h3><p>If the version of your CNI plugin does not correctly match the plugin version in
the config because the config version is later than the plugin version, the
containerd log will likely show an error message on startup of a pod similar
to:</p><pre tabindex=0><code>incompatible CNI versions; config is \&#34;1.0.0\&#34;, plugin supports [\&#34;0.1.0\&#34; \&#34;0.2.0\&#34; \&#34;0.3.0\&#34; \&#34;0.3.1\&#34; \&#34;0.4.0\&#34;]&#34;
</code></pre><p>To fix this issue, <a href=#updating-your-cni-plugins-and-cni-config-files>update your CNI plugins and CNI config files</a>.</p><h3 id=failed-to-destroy-network-for-sandbox-error>Failed to destroy network for sandbox error</h3><p>If the version of the plugin is missing in the CNI plugin config, the pod may
run. However, stopping the pod generates an error similar to:</p><pre tabindex=0><code>ERRO[2022-04-26T00:43:24.518165483Z] StopPodSandbox for &#34;b&#34; failed
error=&#34;failed to destroy network for sandbox \&#34;bbc85f891eaf060c5a879e27bba9b6b06450210161dfdecfbb2732959fb6500a\&#34;: invalid version \&#34;\&#34;: the version is empty&#34;
</code></pre><p>This error leaves the pod in the not-ready state with a network namespace still
attached. To recover from this problem, <a href=#updating-your-cni-plugins-and-cni-config-files>edit the CNI config file</a> to add
the missing version information. The next attempt to stop the pod should
be successful.</p><h3 id=updating-your-cni-plugins-and-cni-config-files>Updating your CNI plugins and CNI config files</h3><p>If you're using containerd v1.6.0-v1.6.3 and encountered "Incompatible CNI
versions" or "Failed to destroy network for sandbox" errors, consider updating
your CNI plugins and editing the CNI config files.</p><p>Here's an overview of the typical steps for each node:</p><ol><li><a href=/docs/tasks/administer-cluster/safely-drain-node/>Safely drain and cordon the
node</a>.</li><li>After stopping your container runtime and kubelet services, perform the
following upgrade operations:</li></ol><ul><li>If you're running CNI plugins, upgrade them to the latest version.</li><li>If you're using non-CNI plugins, replace them with CNI plugins. Use the
latest version of the plugins.</li><li>Update the plugin configuration file to specify or match a version of the
CNI specification that the plugin supports, as shown in the following <a href=#an-example-containerd-configuration-file>"An
example containerd configuration
file"</a> section.</li><li>For <code>containerd</code>, ensure that you have installed the latest version (v1.0.0
or later) of the CNI loopback plugin.</li><li>Upgrade node components (for example, the kubelet) to Kubernetes v1.24</li><li>Upgrade to or install the most current version of the container runtime.</li></ul><ol start=3><li>Bring the node back into your cluster by restarting your container runtime
and kubelet. Uncordon the node (<code>kubectl uncordon &lt;nodename></code>).</li></ol><h2 id=an-example-containerd-configuration-file>An example containerd configuration file</h2><p>The following example shows a configuration for <code>containerd</code> runtime v1.6.x,
which supports a recent version of the CNI specification (v1.0.0).</p><p>Please see the documentation from your plugin and networking provider for
further instructions on configuring your system.</p><p>On Kubernetes, containerd runtime adds a loopback interface, <code>lo</code>, to pods as a
default behavior. The containerd runtime configures the loopback interface via a
CNI plugin, <code>loopback</code>. The <code>loopback</code> plugin is distributed as part of the
<code>containerd</code> release packages that have the <code>cni</code> designation. <code>containerd</code>
v1.6.0 and later includes a CNI v1.0.0-compatible loopback plugin as well as
other default CNI plugins. The configuration for the loopback plugin is done
internally by containerd, and is set to use CNI v1.0.0. This also means that the
version of the <code>loopback</code> plugin must be v1.0.0 or later when this newer version
<code>containerd</code> is started.</p><p>The following bash command generates an example CNI config. Here, the 1.0.0
value for the config version is assigned to the <code>cniVersion</code> field for use when
<code>containerd</code> invokes the CNI bridge plugin.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt; EOF | tee /etc/cni/net.d/10-containerd-net.conflist
</span></span></span><span style=display:flex><span><span style=color:#b44>{
</span></span></span><span style=display:flex><span><span style=color:#b44> &#34;cniVersion&#34;: &#34;1.0.0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44> &#34;name&#34;: &#34;containerd-net&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44> &#34;plugins&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#b44>   {
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;type&#34;: &#34;bridge&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;bridge&#34;: &#34;cni0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;isGateway&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;ipMasq&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;promiscMode&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;ipam&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#b44>       &#34;type&#34;: &#34;host-local&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>       &#34;ranges&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#b44>         [{
</span></span></span><span style=display:flex><span><span style=color:#b44>           &#34;subnet&#34;: &#34;10.88.0.0/16&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44>         }],
</span></span></span><span style=display:flex><span><span style=color:#b44>         [{
</span></span></span><span style=display:flex><span><span style=color:#b44>           &#34;subnet&#34;: &#34;2001:db8:4860::/64&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44>         }]
</span></span></span><span style=display:flex><span><span style=color:#b44>       ],
</span></span></span><span style=display:flex><span><span style=color:#b44>       &#34;routes&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#b44>         { &#34;dst&#34;: &#34;0.0.0.0/0&#34; },
</span></span></span><span style=display:flex><span><span style=color:#b44>         { &#34;dst&#34;: &#34;::/0&#34; }
</span></span></span><span style=display:flex><span><span style=color:#b44>       ]
</span></span></span><span style=display:flex><span><span style=color:#b44>     }
</span></span></span><span style=display:flex><span><span style=color:#b44>   },
</span></span></span><span style=display:flex><span><span style=color:#b44>   {
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;type&#34;: &#34;portmap&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;capabilities&#34;: {&#34;portMappings&#34;: true}
</span></span></span><span style=display:flex><span><span style=color:#b44>   }
</span></span></span><span style=display:flex><span><span style=color:#b44> ]
</span></span></span><span style=display:flex><span><span style=color:#b44>}
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Update the IP address ranges in the preceding example with ones that are based
on your use case and network addressing plan.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cbd252cc297e67c1b73a84d5882474fb>2.2.5 - Check whether dockershim removal affects you</h1><p>The <code>dockershim</code> component of Kubernetes allows to use Docker as a Kubernetes's
<a class=glossary-tooltip title='The container runtime is the software that is responsible for running containers.' data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label='container runtime'>container runtime</a>.
Kubernetes' built-in <code>dockershim</code> component was removed in release v1.24.</p><p>This page explains how your cluster could be using Docker as a container runtime,
provides details on the role that <code>dockershim</code> plays when in use, and shows steps
you can take to check whether any workloads could be affected by <code>dockershim</code> removal.</p><h2 id=find-docker-dependencies>Finding if your app has a dependencies on Docker</h2><p>If you are using Docker for building your application containers, you can still
run these containers on any container runtime. This use of Docker does not count
as a dependency on Docker as a container runtime.</p><p>When alternative container runtime is used, executing Docker commands may either
not work or yield unexpected output. This is how you can find whether you have a
dependency on Docker:</p><ol><li>Make sure no privileged Pods execute Docker commands (like <code>docker ps</code>),
restart the Docker service (commands such as <code>systemctl restart docker.service</code>),
or modify Docker-specific files such as <code>/etc/docker/daemon.json</code>.</li><li>Check for any private registries or image mirror settings in the Docker
configuration file (like <code>/etc/docker/daemon.json</code>). Those typically need to
be reconfigured for another container runtime.</li><li>Check that scripts and apps running on nodes outside of your Kubernetes
infrastructure do not execute Docker commands. It might be:<ul><li>SSH to nodes to troubleshoot;</li><li>Node startup scripts;</li><li>Monitoring and security agents installed on nodes directly.</li></ul></li><li>Third-party tools that perform above mentioned privileged operations. See
<a href=/docs/tasks/administer-cluster/migrating-from-dockershim/migrating-telemetry-and-security-agents>Migrating telemetry and security agents from dockershim</a>
for more information.</li><li>Make sure there is no indirect dependencies on dockershim behavior.
This is an edge case and unlikely to affect your application. Some tooling may be configured
to react to Docker-specific behaviors, for example, raise alert on specific metrics or search for
a specific log message as part of troubleshooting instructions.
If you have such tooling configured, test the behavior on test
cluster before migration.</li></ol><h2 id=role-of-dockershim>Dependency on Docker explained</h2><p>A <a href=/docs/concepts/containers/#container-runtimes>container runtime</a> is software that can
execute the containers that make up a Kubernetes pod. Kubernetes is responsible for orchestration
and scheduling of Pods; on each node, the <a class=glossary-tooltip title='An agent that runs on each node in the cluster. It makes sure that containers are running in a pod.' data-toggle=tooltip data-placement=top href=/docs/reference/generated/kubelet target=_blank aria-label=kubelet>kubelet</a>
uses the container runtime interface as an abstraction so that you can use any compatible
container runtime.</p><p>In its earliest releases, Kubernetes offered compatibility with one container runtime: Docker.
Later in the Kubernetes project's history, cluster operators wanted to adopt additional container runtimes.
The CRI was designed to allow this kind of flexibility - and the kubelet began supporting CRI. However,
because Docker existed before the CRI specification was invented, the Kubernetes project created an
adapter component, <code>dockershim</code>. The dockershim adapter allows the kubelet to interact with Docker as
if Docker were a CRI compatible runtime.</p><p>You can read about it in <a href=/blog/2018/05/24/kubernetes-containerd-integration-goes-ga/>Kubernetes Containerd integration goes GA</a> blog post.</p><p><img src=/images/blog/2018-05-24-kubernetes-containerd-integration-goes-ga/cri-containerd.png alt="Dockershim vs. CRI with Containerd"></p><p>Switching to Containerd as a container runtime eliminates the middleman. All the
same containers can be run by container runtimes like Containerd as before. But
now, since containers schedule directly with the container runtime, they are not visible to Docker.
So any Docker tooling or fancy UI you might have used
before to check on these containers is no longer available.</p><p>You cannot get container information using <code>docker ps</code> or <code>docker inspect</code>
commands. As you cannot list containers, you cannot get logs, stop containers,
or execute something inside container using <code>docker exec</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you're running workloads via Kubernetes, the best way to stop a container is through
the Kubernetes API rather than directly through the container runtime (this advice applies
for all container runtimes, not only Docker).</div><p>You can still pull images or build them using <code>docker build</code> command. But images
built or pulled by Docker would not be visible to container runtime and
Kubernetes. They needed to be pushed to some registry to allow them to be used
by Kubernetes.</p><h2 id=what-s-next>What's next</h2><ul><li>Read <a href=/docs/tasks/administer-cluster/migrating-from-dockershim/>Migrating from dockershim</a> to understand your next steps</li><li>Read the <a href=/blog/2020/12/02/dockershim-faq/>dockershim deprecation FAQ</a> article for more information.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-eb3e279a6c5e1224e744080a52ee3f28>2.2.6 - Migrating telemetry and security agents from dockershim</h1><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>Kubernetes' support for direct integration with Docker Engine is deprecated and
has been removed. Most apps do not have a direct dependency on runtime hosting
containers. However, there are still a lot of telemetry and monitoring agents
that have a dependency on Docker to collect containers metadata, logs, and
metrics. This document aggregates information on how to detect these
dependencies as well as links on how to migrate these agents to use generic tools or
alternative runtimes.</p><h2 id=telemetry-and-security-agents>Telemetry and security agents</h2><p>Within a Kubernetes cluster there are a few different ways to run telemetry or
security agents. Some agents have a direct dependency on Docker Engine when
they run as DaemonSets or directly on nodes.</p><h3 id=why-do-some-telemetry-agents-communicate-with-docker-engine>Why do some telemetry agents communicate with Docker Engine?</h3><p>Historically, Kubernetes was written to work specifically with Docker Engine.
Kubernetes took care of networking and scheduling, relying on Docker Engine for
launching and running containers (within Pods) on a node. Some information that
is relevant to telemetry, such as a pod name, is only available from Kubernetes
components. Other data, such as container metrics, is not the responsibility of
the container runtime. Early telemetry agents needed to query the container
runtime <em>and</em> Kubernetes to report an accurate picture. Over time, Kubernetes
gained the ability to support multiple runtimes, and now supports any runtime
that is compatible with the <a href=/docs/concepts/architecture/cri/>container runtime interface</a>.</p><p>Some telemetry agents rely specifically on Docker Engine tooling. For example, an agent
might run a command such as
<a href=https://docs.docker.com/engine/reference/commandline/ps/><code>docker ps</code></a>
or <a href=https://docs.docker.com/engine/reference/commandline/top/><code>docker top</code></a> to list
containers and processes or <a href=https://docs.docker.com/engine/reference/commandline/logs/><code>docker logs</code></a>
to receive streamed logs. If nodes in your existing cluster use
Docker Engine, and you switch to a different container runtime,
these commands will not work any longer.</p><h3 id=identify-docker-dependency>Identify DaemonSets that depend on Docker Engine</h3><p>If a pod wants to make calls to the <code>dockerd</code> running on the node, the pod must either:</p><ul><li>mount the filesystem containing the Docker daemon's privileged socket, as a
<a class=glossary-tooltip title='A directory containing data, accessible to the containers in a pod.' data-toggle=tooltip data-placement=top href=/docs/concepts/storage/volumes/ target=_blank aria-label=volume>volume</a>; or</li><li>mount the specific path of the Docker daemon's privileged socket directly, also as a volume.</li></ul><p>For example: on COS images, Docker exposes its Unix domain socket at
<code>/var/run/docker.sock</code> This means that the pod spec will include a
<code>hostPath</code> volume mount of <code>/var/run/docker.sock</code>.</p><p>Here's a sample shell script to find Pods that have a mount directly mapping the
Docker socket. This script outputs the namespace and name of the pod. You can
remove the <code>grep '/var/run/docker.sock'</code> to review other mounts.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods --all-namespaces <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-o<span style=color:#666>=</span><span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{range .items[*]}{&#34;\n&#34;}{.metadata.namespace}{&#34;:\t&#34;}{.metadata.name}{&#34;:\t&#34;}{range .spec.volumes[*]}{.hostPath.path}{&#34;, &#34;}{end}{end}&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>| sort <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>| grep <span style=color:#b44>&#39;/var/run/docker.sock&#39;</span>
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> There are alternative ways for a pod to access Docker on the host. For instance, the parent
directory <code>/var/run</code> may be mounted instead of the full path (like in <a href=https://gist.github.com/itaysk/7bc3e56d69c4d72a549286d98fd557dd>this
example</a>).
The script above only detects the most common uses.</div><h3 id=detecting-docker-dependency-from-node-agents>Detecting Docker dependency from node agents</h3><p>If your cluster nodes are customized and install additional security and
telemetry agents on the node, check with the agent vendor
to verify whether it has any dependency on Docker.</p><h3 id=telemetry-and-security-agent-vendors>Telemetry and security agent vendors</h3><p>This section is intended to aggregate information about various telemetry and
security agents that may have a dependency on container runtimes.</p><p>We keep the work in progress version of migration instructions for various telemetry and security agent vendors
in <a href=https://docs.google.com/document/d/1ZFi4uKit63ga5sxEiZblfb-c23lFhvy6RXVPikS8wf0/edit#>Google doc</a>.
Please contact the vendor to get up to date instructions for migrating from dockershim.</p><h2 id=migration-from-dockershim>Migration from dockershim</h2><h3 id=aqua-https-www-aquasec-com><a href=https://www.aquasec.com>Aqua</a></h3><p>No changes are needed: everything should work seamlessly on the runtime switch.</p><h3 id=datadog-https-www-datadoghq-com-product><a href=https://www.datadoghq.com/product/>Datadog</a></h3><p>How to migrate:
<a href=https://docs.datadoghq.com/agent/guide/docker-deprecation/>Docker deprecation in Kubernetes</a>
The pod that accesses Docker Engine may have a name containing any of:</p><ul><li><code>datadog-agent</code></li><li><code>datadog</code></li><li><code>dd-agent</code></li></ul><h3 id=dynatrace-https-www-dynatrace-com><a href=https://www.dynatrace.com/>Dynatrace</a></h3><p>How to migrate:
<a href=https://community.dynatrace.com/t5/Best-practices/Migrating-from-Docker-only-to-generic-container-metrics-in/m-p/167030#M49>Migrating from Docker-only to generic container metrics in Dynatrace</a></p><p>Containerd support announcement: <a href=https://www.dynatrace.com/news/blog/get-automated-full-stack-visibility-into-containerd-based-kubernetes-environments/>Get automated full-stack visibility into
containerd-based Kubernetes
environments</a></p><p>CRI-O support announcement: <a href=https://www.dynatrace.com/news/blog/get-automated-full-stack-visibility-into-your-cri-o-kubernetes-containers-beta/>Get automated full-stack visibility into your CRI-O Kubernetes containers (Beta)</a></p><p>The pod accessing Docker may have name containing:</p><ul><li><code>dynatrace-oneagent</code></li></ul><h3 id=falco-https-falco-org><a href=https://falco.org>Falco</a></h3><p>How to migrate:</p><p><a href=https://falco.org/docs/getting-started/deployment/#docker-deprecation-in-kubernetes>Migrate Falco from dockershim</a>
Falco supports any CRI-compatible runtime (containerd is used in the default configuration); the documentation explains all details.
The pod accessing Docker may have name containing:</p><ul><li><code>falco</code></li></ul><h3 id=prisma-cloud-compute-https-docs-paloaltonetworks-com-prisma-prisma-cloud-html><a href=https://docs.paloaltonetworks.com/prisma/prisma-cloud.html>Prisma Cloud Compute</a></h3><p>Check <a href=https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin-compute/install/install_kubernetes.html>documentation for Prisma Cloud</a>,
under the "Install Prisma Cloud on a CRI (non-Docker) cluster" section.
The pod accessing Docker may be named like:</p><ul><li><code>twistlock-defender-ds</code></li></ul><h3 id=signalfx-splunk-https-www-splunk-com-en-us-investor-relations-acquisitions-signalfx-html><a href=https://www.splunk.com/en_us/investor-relations/acquisitions/signalfx.html>SignalFx (Splunk)</a></h3><p>The SignalFx Smart Agent (deprecated) uses several different monitors for Kubernetes including
<code>kubernetes-cluster</code>, <code>kubelet-stats/kubelet-metrics</code>, and <code>docker-container-stats</code>.
The <code>kubelet-stats</code> monitor was previously deprecated by the vendor, in favor of <code>kubelet-metrics</code>.
The <code>docker-container-stats</code> monitor is the one affected by dockershim removal.
Do not use the <code>docker-container-stats</code> with container runtimes other than Docker Engine.</p><p>How to migrate from dockershim-dependent agent:</p><ol><li>Remove <code>docker-container-stats</code> from the list of <a href=https://github.com/signalfx/signalfx-agent/blob/main/docs/monitor-config.md>configured monitors</a>.
Note, keeping this monitor enabled with non-dockershim runtime will result in incorrect metrics
being reported when docker is installed on node and no metrics when docker is not installed.</li><li><a href=https://github.com/signalfx/signalfx-agent/blob/main/docs/monitors/kubelet-metrics.md>Enable and configure <code>kubelet-metrics</code></a> monitor.</li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The set of collected metrics will change. Review your alerting rules and dashboards.</div><p>The Pod accessing Docker may be named something like:</p><ul><li><code>signalfx-agent</code></li></ul><h3 id=yahoo-kubectl-flame>Yahoo Kubectl Flame</h3><p>Flame does not support container runtimes other than Docker. See
<a href=https://github.com/yahoo/kubectl-flame/issues/51>https://github.com/yahoo/kubectl-flame/issues/51</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7743f043c43f7b12e8654e2227dbc658>2.3 - Generate Certificates Manually</h1><p>When using client certificate authentication, you can generate certificates
manually through <a href=https://github.com/OpenVPN/easy-rsa><code>easyrsa</code></a>, <a href=https://github.com/openssl/openssl><code>openssl</code></a> or <a href=https://github.com/cloudflare/cfssl><code>cfssl</code></a>.</p><h3 id=easyrsa>easyrsa</h3><p><strong>easyrsa</strong> can manually generate certificates for your cluster.</p><ol><li><p>Download, unpack, and initialize the patched version of <code>easyrsa3</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -LO https://storage.googleapis.com/kubernetes-release/easy-rsa/easy-rsa.tar.gz
</span></span><span style=display:flex><span>tar xzf easy-rsa.tar.gz
</span></span><span style=display:flex><span><span style=color:#a2f>cd</span> easy-rsa-master/easyrsa3
</span></span><span style=display:flex><span>./easyrsa init-pki
</span></span></code></pre></div></li><li><p>Generate a new certificate authority (CA). <code>--batch</code> sets automatic mode;
<code>--req-cn</code> specifies the Common Name (CN) for the CA's new root certificate.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./easyrsa --batch <span style=color:#b44>&#34;--req-cn=</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>MASTER_IP</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>@`date +%s`&#34;</span> build-ca nopass
</span></span></code></pre></div></li><li><p>Generate server certificate and key.</p><p>The argument <code>--subject-alt-name</code> sets the possible IPs and DNS names the API server will
be accessed with. The <code>MASTER_CLUSTER_IP</code> is usually the first IP from the service CIDR
that is specified as the <code>--service-cluster-ip-range</code> argument for both the API server and
the controller manager component. The argument <code>--days</code> is used to set the number of days
after which the certificate expires.
The sample below also assumes that you are using <code>cluster.local</code> as the default
DNS domain name.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./easyrsa --subject-alt-name<span style=color:#666>=</span><span style=color:#b44>&#34;IP:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>MASTER_IP</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>,&#34;</span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#b44>&#34;IP:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>MASTER_CLUSTER_IP</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>,&#34;</span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#b44>&#34;DNS:kubernetes,&#34;</span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#b44>&#34;DNS:kubernetes.default,&#34;</span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#b44>&#34;DNS:kubernetes.default.svc,&#34;</span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#b44>&#34;DNS:kubernetes.default.svc.cluster,&#34;</span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#b44>&#34;DNS:kubernetes.default.svc.cluster.local&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--days<span style=color:#666>=</span><span style=color:#666>10000</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>build-server-full server nopass
</span></span></code></pre></div></li><li><p>Copy <code>pki/ca.crt</code>, <code>pki/issued/server.crt</code>, and <code>pki/private/server.key</code> to your directory.</p></li><li><p>Fill in and add the following parameters into the API server start parameters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>--client-ca-file<span style=color:#666>=</span>/yourdirectory/ca.crt
</span></span><span style=display:flex><span>--tls-cert-file<span style=color:#666>=</span>/yourdirectory/server.crt
</span></span><span style=display:flex><span>--tls-private-key-file<span style=color:#666>=</span>/yourdirectory/server.key
</span></span></code></pre></div></li></ol><h3 id=openssl>openssl</h3><p><strong>openssl</strong> can manually generate certificates for your cluster.</p><ol><li><p>Generate a ca.key with 2048bit:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl genrsa -out ca.key <span style=color:#666>2048</span>
</span></span></code></pre></div></li><li><p>According to the ca.key generate a ca.crt (use <code>-days</code> to set the certificate effective time):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -new -nodes -key ca.key -subj <span style=color:#b44>&#34;/CN=</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>MASTER_IP</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span> -days <span style=color:#666>10000</span> -out ca.crt
</span></span></code></pre></div></li><li><p>Generate a server.key with 2048bit:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl genrsa -out server.key <span style=color:#666>2048</span>
</span></span></code></pre></div></li><li><p>Create a config file for generating a Certificate Signing Request (CSR).</p><p>Be sure to substitute the values marked with angle brackets (e.g. <code>&lt;MASTER_IP></code>)
with real values before saving this to a file (e.g. <code>csr.conf</code>).
Note that the value for <code>MASTER_CLUSTER_IP</code> is the service cluster IP for the
API server as described in previous subsection.
The sample below also assumes that you are using <code>cluster.local</code> as the default
DNS domain name.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a2f;font-weight:700>[ req ]</span>
</span></span><span style=display:flex><span><span style=color:#b44>default_bits</span> <span style=color:#666>=</span> <span style=color:#b44>2048</span>
</span></span><span style=display:flex><span><span style=color:#b44>prompt</span> <span style=color:#666>=</span> <span style=color:#b44>no</span>
</span></span><span style=display:flex><span><span style=color:#b44>default_md</span> <span style=color:#666>=</span> <span style=color:#b44>sha256</span>
</span></span><span style=display:flex><span><span style=color:#b44>req_extensions</span> <span style=color:#666>=</span> <span style=color:#b44>req_ext</span>
</span></span><span style=display:flex><span><span style=color:#b44>distinguished_name</span> <span style=color:#666>=</span> <span style=color:#b44>dn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[ dn ]</span>
</span></span><span style=display:flex><span><span style=color:#b44>C</span> <span style=color:#666>=</span> <span style=color:#b44>&lt;country&gt;</span>
</span></span><span style=display:flex><span><span style=color:#b44>ST</span> <span style=color:#666>=</span> <span style=color:#b44>&lt;state&gt;</span>
</span></span><span style=display:flex><span><span style=color:#b44>L</span> <span style=color:#666>=</span> <span style=color:#b44>&lt;city&gt;</span>
</span></span><span style=display:flex><span><span style=color:#b44>O</span> <span style=color:#666>=</span> <span style=color:#b44>&lt;organization&gt;</span>
</span></span><span style=display:flex><span><span style=color:#b44>OU</span> <span style=color:#666>=</span> <span style=color:#b44>&lt;organization unit&gt;</span>
</span></span><span style=display:flex><span><span style=color:#b44>CN</span> <span style=color:#666>=</span> <span style=color:#b44>&lt;MASTER_IP&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[ req_ext ]</span>
</span></span><span style=display:flex><span><span style=color:#b44>subjectAltName</span> <span style=color:#666>=</span> <span style=color:#b44>@alt_names</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[ alt_names ]</span>
</span></span><span style=display:flex><span><span style=color:#b44>DNS.1</span> <span style=color:#666>=</span> <span style=color:#b44>kubernetes</span>
</span></span><span style=display:flex><span><span style=color:#b44>DNS.2</span> <span style=color:#666>=</span> <span style=color:#b44>kubernetes.default</span>
</span></span><span style=display:flex><span><span style=color:#b44>DNS.3</span> <span style=color:#666>=</span> <span style=color:#b44>kubernetes.default.svc</span>
</span></span><span style=display:flex><span><span style=color:#b44>DNS.4</span> <span style=color:#666>=</span> <span style=color:#b44>kubernetes.default.svc.cluster</span>
</span></span><span style=display:flex><span><span style=color:#b44>DNS.5</span> <span style=color:#666>=</span> <span style=color:#b44>kubernetes.default.svc.cluster.local</span>
</span></span><span style=display:flex><span><span style=color:#b44>IP.1</span> <span style=color:#666>=</span> <span style=color:#b44>&lt;MASTER_IP&gt;</span>
</span></span><span style=display:flex><span><span style=color:#b44>IP.2</span> <span style=color:#666>=</span> <span style=color:#b44>&lt;MASTER_CLUSTER_IP&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[ v3_ext ]</span>
</span></span><span style=display:flex><span><span style=color:#b44>authorityKeyIdentifier</span><span style=color:#666>=</span><span style=color:#b44>keyid,issuer:always</span>
</span></span><span style=display:flex><span><span style=color:#b44>basicConstraints</span><span style=color:#666>=</span><span style=color:#b44>CA:FALSE</span>
</span></span><span style=display:flex><span><span style=color:#b44>keyUsage</span><span style=color:#666>=</span><span style=color:#b44>keyEncipherment,dataEncipherment</span>
</span></span><span style=display:flex><span><span style=color:#b44>extendedKeyUsage</span><span style=color:#666>=</span><span style=color:#b44>serverAuth,clientAuth</span>
</span></span><span style=display:flex><span><span style=color:#b44>subjectAltName</span><span style=color:#666>=</span><span style=color:#b44>@alt_names</span>
</span></span></code></pre></div></li><li><p>Generate the certificate signing request based on the config file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -new -key server.key -out server.csr -config csr.conf
</span></span></code></pre></div></li><li><p>Generate the server certificate using the ca.key, ca.crt and server.csr:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -CAcreateserial -out server.crt -days <span style=color:#666>10000</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -extensions v3_ext -extfile csr.conf -sha256
</span></span></code></pre></div></li><li><p>View the certificate signing request:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req  -noout -text -in ./server.csr
</span></span></code></pre></div></li><li><p>View the certificate:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl x509  -noout -text -in ./server.crt
</span></span></code></pre></div></li></ol><p>Finally, add the same parameters into the API server start parameters.</p><h3 id=cfssl>cfssl</h3><p><strong>cfssl</strong> is another tool for certificate generation.</p><ol><li><p>Download, unpack and prepare the command line tools as shown below.</p><p>Note that you may need to adapt the sample commands based on the hardware
architecture and cfssl version you are using.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl_1.5.0_linux_amd64 -o cfssl
</span></span><span style=display:flex><span>chmod +x cfssl
</span></span><span style=display:flex><span>curl -L https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssljson_1.5.0_linux_amd64 -o cfssljson
</span></span><span style=display:flex><span>chmod +x cfssljson
</span></span><span style=display:flex><span>curl -L https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl-certinfo_1.5.0_linux_amd64 -o cfssl-certinfo
</span></span><span style=display:flex><span>chmod +x cfssl-certinfo
</span></span></code></pre></div></li><li><p>Create a directory to hold the artifacts and initialize cfssl:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir cert
</span></span><span style=display:flex><span><span style=color:#a2f>cd</span> cert
</span></span><span style=display:flex><span>../cfssl print-defaults config &gt; config.json
</span></span><span style=display:flex><span>../cfssl print-defaults csr &gt; csr.json
</span></span></code></pre></div></li><li><p>Create a JSON config file for generating the CA file, for example, <code>ca-config.json</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;signing&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;default&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;expiry&#34;</span>: <span style=color:#b44>&#34;8760h&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;profiles&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;kubernetes&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;usages&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#b44>&#34;signing&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#b44>&#34;key encipherment&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#b44>&#34;server auth&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#b44>&#34;client auth&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;expiry&#34;</span>: <span style=color:#b44>&#34;8760h&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>Create a JSON config file for CA certificate signing request (CSR), for example,
<code>ca-csr.json</code>. Be sure to replace the values marked with angle brackets with
real values you want to use.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;CN&#34;</span>: <span style=color:#b44>&#34;kubernetes&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;key&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;algo&#34;</span>: <span style=color:#b44>&#34;rsa&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;size&#34;</span>: <span style=color:#666>2048</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;names&#34;</span>:[{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;C&#34;</span>: <span style=color:#b44>&#34;&lt;country&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;ST&#34;</span>: <span style=color:#b44>&#34;&lt;state&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;L&#34;</span>: <span style=color:#b44>&#34;&lt;city&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;O&#34;</span>: <span style=color:#b44>&#34;&lt;organization&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;OU&#34;</span>: <span style=color:#b44>&#34;&lt;organization unit&gt;&#34;</span>
</span></span><span style=display:flex><span>  }]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>Generate CA key (<code>ca-key.pem</code>) and certificate (<code>ca.pem</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>../cfssl gencert -initca ca-csr.json | ../cfssljson -bare ca
</span></span></code></pre></div></li><li><p>Create a JSON config file for generating keys and certificates for the API
server, for example, <code>server-csr.json</code>. Be sure to replace the values in angle brackets with
real values you want to use. The <code>&lt;MASTER_CLUSTER_IP></code> is the service cluster
IP for the API server as described in previous subsection.
The sample below also assumes that you are using <code>cluster.local</code> as the default
DNS domain name.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;CN&#34;</span>: <span style=color:#b44>&#34;kubernetes&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;hosts&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;&lt;MASTER_IP&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;&lt;MASTER_CLUSTER_IP&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;kubernetes&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;kubernetes.default&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;kubernetes.default.svc&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;kubernetes.default.svc.cluster&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;kubernetes.default.svc.cluster.local&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;key&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;algo&#34;</span>: <span style=color:#b44>&#34;rsa&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;size&#34;</span>: <span style=color:#666>2048</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;names&#34;</span>: [{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;C&#34;</span>: <span style=color:#b44>&#34;&lt;country&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;ST&#34;</span>: <span style=color:#b44>&#34;&lt;state&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;L&#34;</span>: <span style=color:#b44>&#34;&lt;city&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;O&#34;</span>: <span style=color:#b44>&#34;&lt;organization&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;OU&#34;</span>: <span style=color:#b44>&#34;&lt;organization unit&gt;&#34;</span>
</span></span><span style=display:flex><span>  }]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>Generate the key and certificate for the API server, which are by default
saved into file <code>server-key.pem</code> and <code>server.pem</code> respectively:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>../cfssl gencert -ca<span style=color:#666>=</span>ca.pem -ca-key<span style=color:#666>=</span>ca-key.pem <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>     --config<span style=color:#666>=</span>ca-config.json -profile<span style=color:#666>=</span>kubernetes <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>     server-csr.json | ../cfssljson -bare server
</span></span></code></pre></div></li></ol><h2 id=distributing-self-signed-ca-certificate>Distributing Self-Signed CA Certificate</h2><p>A client node may refuse to recognize a self-signed CA certificate as valid.
For a non-production deployment, or for a deployment that runs behind a company
firewall, you can distribute a self-signed CA certificate to all clients and
refresh the local list for valid certificates.</p><p>On each client, perform the following operations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo cp ca.crt /usr/local/share/ca-certificates/kubernetes.crt
</span></span><span style=display:flex><span>sudo update-ca-certificates
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Updating certificates in /etc/ssl/certs...
1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....
done.
</code></pre><h2 id=certificates-api>Certificates API</h2><p>You can use the <code>certificates.k8s.io</code> API to provision
x509 certificates to use for authentication as documented
in the <a href=/docs/tasks/tls/managing-tls-in-a-cluster>Managing TLS in a cluster</a>
task page.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-47be5dd51f686017f1766e6ec7aa6f41>2.4 - Manage Memory, CPU, and API Resources</h1></div><div class=td-content><h1 id=pg-337620c76587e4aeb32009cb23be46de>2.4.1 - Configure Default Memory Requests and Limits for a Namespace</h1><div class=lead>Define a default memory resource limit for a namespace, so that every new Pod in that namespace has a memory resource limit configured.</div><p>This page shows how to configure default memory requests and limits for a
<a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespace>namespace</a>.</p><p>A Kubernetes cluster can be divided into namespaces. Once you have a namespace that
has a default memory
<a href=/docs/concepts/configuration/manage-resources-containers/#requests-and-limits>limit</a>,
and you then try to create a Pod with a container that does not specify its own memory
limit, then the
<a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a> assigns the default
memory limit to that container.</p><p>Kubernetes assigns a default memory request under certain conditions that are explained later in this topic.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You must have access to create namespaces in your cluster.</p><p>Each node in your cluster must have at least 2 GiB of memory.</p><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace default-mem-example
</span></span></code></pre></div><h2 id=create-a-limitrange-and-a-pod>Create a LimitRange and a Pod</h2><p>Here's a manifest for an example <a class=glossary-tooltip title='Provides constraints to limit resource consumption per Containers or Pods in a namespace.' data-toggle=tooltip data-placement=top href=/docs/concepts/policy/limit-range/ target=_blank aria-label=LimitRange>LimitRange</a>.
The manifest specifies a default memory
request and a default memory limit.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-defaults.yaml download=admin/resource/memory-defaults.yaml><code>admin/resource/memory-defaults.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-defaults-yaml")' title="Copy admin/resource/memory-defaults.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-defaults-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LimitRange<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mem-limit-range<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>default</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>512Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>defaultRequest</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>256Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Container<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the LimitRange in the default-mem-example namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-defaults.yaml --namespace<span style=color:#666>=</span>default-mem-example
</span></span></code></pre></div><p>Now if you create a Pod in the default-mem-example namespace, and any container
within that Pod does not specify its own values for memory request and memory limit,
then the <a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a>
applies default values: a memory request of 256MiB and a memory limit of 512MiB.</p><p>Here's an example manifest for a Pod that has one container. The container
does not specify a memory request and limit.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-defaults-pod.yaml download=admin/resource/memory-defaults-pod.yaml><code>admin/resource/memory-defaults-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-defaults-pod-yaml")' title="Copy admin/resource/memory-defaults-pod.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-defaults-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-mem-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-mem-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-defaults-pod.yaml --namespace<span style=color:#666>=</span>default-mem-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod default-mem-demo --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>default-mem-example
</span></span></code></pre></div><p>The output shows that the Pod's container has a memory request of 256 MiB and
a memory limit of 512 MiB. These are the default values specified by the LimitRange.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>containers:
</span></span><span style=display:flex><span>- image: nginx
</span></span><span style=display:flex><span>  imagePullPolicy: Always
</span></span><span style=display:flex><span>  name: default-mem-demo-ctr
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    limits:
</span></span><span style=display:flex><span>      memory: 512Mi
</span></span><span style=display:flex><span>    requests:
</span></span><span style=display:flex><span>      memory: 256Mi
</span></span></code></pre></div><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod default-mem-demo --namespace<span style=color:#666>=</span>default-mem-example
</span></span></code></pre></div><h2 id=what-if-you-specify-a-container-s-limit-but-not-its-request>What if you specify a container's limit, but not its request?</h2><p>Here's a manifest for a Pod that has one container. The container
specifies a memory limit, but not a request:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-defaults-pod-2.yaml download=admin/resource/memory-defaults-pod-2.yaml><code>admin/resource/memory-defaults-pod-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-defaults-pod-2-yaml")' title="Copy admin/resource/memory-defaults-pod-2.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-defaults-pod-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-mem-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-mem-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1Gi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-defaults-pod-2.yaml --namespace<span style=color:#666>=</span>default-mem-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod default-mem-demo-2 --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>default-mem-example
</span></span></code></pre></div><p>The output shows that the container's memory request is set to match its memory limit.
Notice that the container was not assigned the default memory request value of 256Mi.</p><pre tabindex=0><code>resources:
  limits:
    memory: 1Gi
  requests:
    memory: 1Gi
</code></pre><h2 id=what-if-you-specify-a-container-s-request-but-not-its-limit>What if you specify a container's request, but not its limit?</h2><p>Here's a manifest for a Pod that has one container. The container
specifies a memory request, but not a limit:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-defaults-pod-3.yaml download=admin/resource/memory-defaults-pod-3.yaml><code>admin/resource/memory-defaults-pod-3.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-defaults-pod-3-yaml")' title="Copy admin/resource/memory-defaults-pod-3.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-defaults-pod-3-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-mem-demo-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-mem-demo-3-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;128Mi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-defaults-pod-3.yaml --namespace<span style=color:#666>=</span>default-mem-example
</span></span></code></pre></div><p>View the Pod's specification:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod default-mem-demo-3 --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>default-mem-example
</span></span></code></pre></div><p>The output shows that the container's memory request is set to the value specified in the
container's manifest. The container is limited to use no more than 512MiB of
memory, which matches the default memory limit for the namespace.</p><pre tabindex=0><code>resources:
  limits:
    memory: 512Mi
  requests:
    memory: 128Mi
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> A <code>LimitRange</code> does <strong>not</strong> check the consistency of the default values it applies. This means that a default value for the <em>limit</em> that is set by <code>LimitRange</code> may be less than the <em>request</em> value specified for the container in the spec that a client submits to the API server. If that happens, the final Pod will not be scheduleable.
See <a href=/docs/concepts/policy/limit-range/#constraints-on-resource-limits-and-requests>Constraints on resource limits and requests</a> for more details.</div><h2 id=motivation-for-default-memory-limits-and-requests>Motivation for default memory limits and requests</h2><p>If your namespace has a memory <a class=glossary-tooltip title='Provides constraints that limit aggregate resource consumption per namespace.' data-toggle=tooltip data-placement=top href=/docs/concepts/policy/resource-quotas/ target=_blank aria-label='resource quota'>resource quota</a>
configured,
it is helpful to have a default value in place for memory limit.
Here are three of the restrictions that a resource quota imposes on a namespace:</p><ul><li>For every Pod that runs in the namespace, the Pod and each of its containers must have a memory limit.
(If you specify a memory limit for every container in a Pod, Kubernetes can infer the Pod-level memory
limit by adding up the limits for its containers).</li><li>Memory limits apply a resource reservation on the node where the Pod in question is scheduled.
The total amount of memory reserved for all Pods in the namespace must not exceed a specified limit.</li><li>The total amount of memory actually used by all Pods in the namespace must also not exceed a specified limit.</li></ul><p>When you add a LimitRange:</p><p>If any Pod in that namespace that includes a container does not specify its own memory limit,
the control plane applies the default memory limit to that container, and the Pod can be
allowed to run in a namespace that is restricted by a memory ResourceQuota.</p><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace default-mem-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li></ul><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-320af95e480962c538ebef7ae205845c>2.4.2 - Configure Default CPU Requests and Limits for a Namespace</h1><div class=lead>Define a default CPU resource limits for a namespace, so that every new Pod in that namespace has a CPU resource limit configured.</div><p>This page shows how to configure default CPU requests and limits for a
<a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespace>namespace</a>.</p><p>A Kubernetes cluster can be divided into namespaces. If you create a Pod within a
namespace that has a default CPU
<a href=/docs/concepts/configuration/manage-resources-containers/#requests-and-limits>limit</a>, and any container in that Pod does not specify
its own CPU limit, then the
<a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a> assigns the default
CPU limit to that container.</p><p>Kubernetes assigns a default CPU
<a href=/docs/concepts/configuration/manage-resources-containers/#requests-and-limits>request</a>,
but only under certain conditions that are explained later in this page.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You must have access to create namespaces in your cluster.</p><p>If you're not already familiar with what Kubernetes means by 1.0 CPU,
read <a href=/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu>meaning of CPU</a>.</p><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace default-cpu-example
</span></span></code></pre></div><h2 id=create-a-limitrange-and-a-pod>Create a LimitRange and a Pod</h2><p>Here's a manifest for an example <a class=glossary-tooltip title='Provides constraints to limit resource consumption per Containers or Pods in a namespace.' data-toggle=tooltip data-placement=top href=/docs/concepts/policy/limit-range/ target=_blank aria-label=LimitRange>LimitRange</a>.
The manifest specifies a default CPU request and a default CPU limit.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-defaults.yaml download=admin/resource/cpu-defaults.yaml><code>admin/resource/cpu-defaults.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-defaults-yaml")' title="Copy admin/resource/cpu-defaults.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-defaults-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LimitRange<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu-limit-range<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>default</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>defaultRequest</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#666>0.5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Container<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the LimitRange in the default-cpu-example namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-defaults.yaml --namespace<span style=color:#666>=</span>default-cpu-example
</span></span></code></pre></div><p>Now if you create a Pod in the default-cpu-example namespace, and any container
in that Pod does not specify its own values for CPU request and CPU limit,
then the control plane applies default values: a CPU request of 0.5 and a default
CPU limit of 1.</p><p>Here's a manifest for a Pod that has one container. The container
does not specify a CPU request and limit.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-defaults-pod.yaml download=admin/resource/cpu-defaults-pod.yaml><code>admin/resource/cpu-defaults-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-defaults-pod-yaml")' title="Copy admin/resource/cpu-defaults-pod.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-defaults-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-cpu-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-cpu-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-defaults-pod.yaml --namespace<span style=color:#666>=</span>default-cpu-example
</span></span></code></pre></div><p>View the Pod's specification:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod default-cpu-demo --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>default-cpu-example
</span></span></code></pre></div><p>The output shows that the Pod's only container has a CPU request of 500m <code>cpu</code>
(which you can read as “500 millicpu”), and a CPU limit of 1 <code>cpu</code>.
These are the default values specified by the LimitRange.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>containers:
</span></span><span style=display:flex><span>- image: nginx
</span></span><span style=display:flex><span>  imagePullPolicy: Always
</span></span><span style=display:flex><span>  name: default-cpu-demo-ctr
</span></span><span style=display:flex><span>  resources:
</span></span><span style=display:flex><span>    limits:
</span></span><span style=display:flex><span>      cpu: <span style=color:#b44>&#34;1&#34;</span>
</span></span><span style=display:flex><span>    requests:
</span></span><span style=display:flex><span>      cpu: 500m
</span></span></code></pre></div><h2 id=what-if-you-specify-a-container-s-limit-but-not-its-request>What if you specify a container's limit, but not its request?</h2><p>Here's a manifest for a Pod that has one container. The container
specifies a CPU limit, but not a request:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-defaults-pod-2.yaml download=admin/resource/cpu-defaults-pod-2.yaml><code>admin/resource/cpu-defaults-pod-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-defaults-pod-2-yaml")' title="Copy admin/resource/cpu-defaults-pod-2.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-defaults-pod-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-cpu-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-cpu-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-defaults-pod-2.yaml --namespace<span style=color:#666>=</span>default-cpu-example
</span></span></code></pre></div><p>View the <a href=/docs/concepts/overview/working-with-objects/kubernetes-objects/#object-spec-and-status>specification</a>
of the Pod that you created:</p><pre tabindex=0><code>kubectl get pod default-cpu-demo-2 --output=yaml --namespace=default-cpu-example
</code></pre><p>The output shows that the container's CPU request is set to match its CPU limit.
Notice that the container was not assigned the default CPU request value of 0.5 <code>cpu</code>:</p><pre tabindex=0><code>resources:
  limits:
    cpu: &#34;1&#34;
  requests:
    cpu: &#34;1&#34;
</code></pre><h2 id=what-if-you-specify-a-container-s-request-but-not-its-limit>What if you specify a container's request, but not its limit?</h2><p>Here's an example manifest for a Pod that has one container. The container
specifies a CPU request, but not a limit:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-defaults-pod-3.yaml download=admin/resource/cpu-defaults-pod-3.yaml><code>admin/resource/cpu-defaults-pod-3.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-defaults-pod-3-yaml")' title="Copy admin/resource/cpu-defaults-pod-3.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-defaults-pod-3-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-cpu-demo-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-cpu-demo-3-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0.75&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-defaults-pod-3.yaml --namespace<span style=color:#666>=</span>default-cpu-example
</span></span></code></pre></div><p>View the <a href=/docs/concepts/overview/working-with-objects/kubernetes-objects/#object-spec-and-status>specification</a>
of the Pod that you created:</p><pre tabindex=0><code>kubectl get pod default-cpu-demo-3 --output=yaml --namespace=default-cpu-example
</code></pre><p>The output shows that the container's CPU request is set to the value you specified at
the time you created the Pod (in other words: it matches the manifest).
However, the same container's CPU limit is set to 1 <code>cpu</code>, which is the default CPU limit
for that namespace.</p><pre tabindex=0><code>resources:
  limits:
    cpu: &#34;1&#34;
  requests:
    cpu: 750m
</code></pre><h2 id=motivation-for-default-cpu-limits-and-requests>Motivation for default CPU limits and requests</h2><p>If your namespace has a CPU <a class=glossary-tooltip title='Provides constraints that limit aggregate resource consumption per namespace.' data-toggle=tooltip data-placement=top href=/docs/concepts/policy/resource-quotas/ target=_blank aria-label='resource quota'>resource quota</a>
configured,
it is helpful to have a default value in place for CPU limit.
Here are two of the restrictions that a CPU resource quota imposes on a namespace:</p><ul><li>For every Pod that runs in the namespace, each of its containers must have a CPU limit.</li><li>CPU limits apply a resource reservation on the node where the Pod in question is scheduled.
The total amount of CPU that is reserved for use by all Pods in the namespace must not
exceed a specified limit.</li></ul><p>When you add a LimitRange:</p><p>If any Pod in that namespace that includes a container does not specify its own CPU limit,
the control plane applies the default CPU limit to that container, and the Pod can be
allowed to run in a namespace that is restricted by a CPU ResourceQuota.</p><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace default-cpu-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li></ul><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-adb489b1ab985c9215657b0d4c6ae92b>2.4.3 - Configure Minimum and Maximum Memory Constraints for a Namespace</h1><div class=lead>Define a range of valid memory resource limits for a namespace, so that every new Pod in that namespace falls within the range you configure.</div><p>This page shows how to set minimum and maximum values for memory used by containers
running in a <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespace>namespace</a>.
You specify minimum and maximum memory values in a
<a href=/docs/reference/kubernetes-api/policy-resources/limit-range-v1/>LimitRange</a>
object. If a Pod does not meet the constraints imposed by the LimitRange,
it cannot be created in the namespace.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You must have access to create namespaces in your cluster.</p><p>Each node in your cluster must have at least 1 GiB of memory available for Pods.</p><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace constraints-mem-example
</span></span></code></pre></div><h2 id=create-a-limitrange-and-a-pod>Create a LimitRange and a Pod</h2><p>Here's an example manifest for a LimitRange:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-constraints.yaml download=admin/resource/memory-constraints.yaml><code>admin/resource/memory-constraints.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-constraints-yaml")' title="Copy admin/resource/memory-constraints.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-constraints-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LimitRange<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mem-min-max-demo-lr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>max</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>1Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>min</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>500Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Container<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the LimitRange:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-constraints.yaml --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><p>View detailed information about the LimitRange:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get limitrange mem-min-max-demo-lr --namespace<span style=color:#666>=</span>constraints-mem-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows the minimum and maximum memory constraints as expected. But
notice that even though you didn't specify default values in the configuration
file for the LimitRange, they were created automatically.</p><pre tabindex=0><code>  limits:
  - default:
      memory: 1Gi
    defaultRequest:
      memory: 1Gi
    max:
      memory: 1Gi
    min:
      memory: 500Mi
    type: Container
</code></pre><p>Now whenever you define a Pod within the constraints-mem-example namespace, Kubernetes
performs these steps:</p><ul><li><p>If any container in that Pod does not specify its own memory request and limit,
the control plane assigns the default memory request and limit to that container.</p></li><li><p>Verify that every container in that Pod requests at least 500 MiB of memory.</p></li><li><p>Verify that every container in that Pod requests no more than 1024 MiB (1 GiB)
of memory.</p></li></ul><p>Here's a manifest for a Pod that has one container. Within the Pod spec, the sole
container specifies a memory request of 600 MiB and a memory limit of 800 MiB. These satisfy the
minimum and maximum memory constraints imposed by the LimitRange.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-constraints-pod.yaml download=admin/resource/memory-constraints-pod.yaml><code>admin/resource/memory-constraints-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-constraints-pod-yaml")' title="Copy admin/resource/memory-constraints-pod.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-constraints-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-mem-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-mem-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;600Mi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-constraints-pod.yaml --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><p>Verify that the Pod is running and that its container is healthy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod constraints-mem-demo --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod constraints-mem-demo --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><p>The output shows that the container within that Pod has a memory request of 600 MiB and
a memory limit of 800 MiB. These satisfy the constraints imposed by the LimitRange for
this namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>800Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>600Mi<span style=color:#bbb>
</span></span></span></code></pre></div><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod constraints-mem-demo --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><h2 id=attempt-to-create-a-pod-that-exceeds-the-maximum-memory-constraint>Attempt to create a Pod that exceeds the maximum memory constraint</h2><p>Here's a manifest for a Pod that has one container. The container specifies a
memory request of 800 MiB and a memory limit of 1.5 GiB.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-constraints-pod-2.yaml download=admin/resource/memory-constraints-pod-2.yaml><code>admin/resource/memory-constraints-pod-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-constraints-pod-2-yaml")' title="Copy admin/resource/memory-constraints-pod-2.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-constraints-pod-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-mem-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-mem-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1.5Gi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800Mi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Attempt to create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-constraints-pod-2.yaml --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><p>The output shows that the Pod does not get created, because it defines a container that
requests more memory than is allowed:</p><pre tabindex=0><code>Error from server (Forbidden): error when creating &#34;examples/admin/resource/memory-constraints-pod-2.yaml&#34;:
pods &#34;constraints-mem-demo-2&#34; is forbidden: maximum memory usage per Container is 1Gi, but limit is 1536Mi.
</code></pre><h2 id=attempt-to-create-a-pod-that-does-not-meet-the-minimum-memory-request>Attempt to create a Pod that does not meet the minimum memory request</h2><p>Here's a manifest for a Pod that has one container. That container specifies a
memory request of 100 MiB and a memory limit of 800 MiB.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-constraints-pod-3.yaml download=admin/resource/memory-constraints-pod-3.yaml><code>admin/resource/memory-constraints-pod-3.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-constraints-pod-3-yaml")' title="Copy admin/resource/memory-constraints-pod-3.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-constraints-pod-3-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-mem-demo-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-mem-demo-3-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Attempt to create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-constraints-pod-3.yaml --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><p>The output shows that the Pod does not get created, because it defines a container
that requests less memory than the enforced minimum:</p><pre tabindex=0><code>Error from server (Forbidden): error when creating &#34;examples/admin/resource/memory-constraints-pod-3.yaml&#34;:
pods &#34;constraints-mem-demo-3&#34; is forbidden: minimum memory usage per Container is 500Mi, but request is 100Mi.
</code></pre><h2 id=create-a-pod-that-does-not-specify-any-memory-request-or-limit>Create a Pod that does not specify any memory request or limit</h2><p>Here's a manifest for a Pod that has one container. The container does not
specify a memory request, and it does not specify a memory limit.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/memory-constraints-pod-4.yaml download=admin/resource/memory-constraints-pod-4.yaml><code>admin/resource/memory-constraints-pod-4.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-memory-constraints-pod-4-yaml")' title="Copy admin/resource/memory-constraints-pod-4.yaml to clipboard"></img></div><div class=includecode id=admin-resource-memory-constraints-pod-4-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-mem-demo-4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-mem-demo-4-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/memory-constraints-pod-4.yaml --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod constraints-mem-demo-4 --namespace<span style=color:#666>=</span>constraints-mem-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows that the Pod's only container has a memory request of 1 GiB and a memory limit of 1 GiB.
How did that container get those values?</p><pre tabindex=0><code>resources:
  limits:
    memory: 1Gi
  requests:
    memory: 1Gi
</code></pre><p>Because your Pod did not define any memory request and limit for that container, the cluster
applied a
<a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>default memory request and limit</a>
from the LimitRange.</p><p>This means that the definition of that Pod shows those values. You can check it using
<code>kubectl describe</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Look for the &#34;Requests:&#34; section of the output</span>
</span></span><span style=display:flex><span>kubectl describe pod constraints-mem-demo-4 --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><p>At this point, your Pod might be running or it might not be running. Recall that a prerequisite
for this task is that your Nodes have at least 1 GiB of memory. If each of your Nodes has only
1 GiB of memory, then there is not enough allocatable memory on any Node to accommodate a memory
request of 1 GiB. If you happen to be using Nodes with 2 GiB of memory, then you probably have
enough space to accommodate the 1 GiB request.</p><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod constraints-mem-demo-4 --namespace<span style=color:#666>=</span>constraints-mem-example
</span></span></code></pre></div><h2 id=enforcement-of-minimum-and-maximum-memory-constraints>Enforcement of minimum and maximum memory constraints</h2><p>The maximum and minimum memory constraints imposed on a namespace by a LimitRange are enforced only
when a Pod is created or updated. If you change the LimitRange, it does not affect
Pods that were created previously.</p><h2 id=motivation-for-minimum-and-maximum-memory-constraints>Motivation for minimum and maximum memory constraints</h2><p>As a cluster administrator, you might want to impose restrictions on the amount of memory that Pods can use.
For example:</p><ul><li><p>Each Node in a cluster has 2 GiB of memory. You do not want to accept any Pod that requests
more than 2 GiB of memory, because no Node in the cluster can support the request.</p></li><li><p>A cluster is shared by your production and development departments.
You want to allow production workloads to consume up to 8 GiB of memory, but
you want development workloads to be limited to 512 MiB. You create separate namespaces
for production and development, and you apply memory constraints to each namespace.</p></li></ul><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace constraints-mem-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li></ul><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a87cbd1f9379dac7a48ae320da68a9ad>2.4.4 - Configure Minimum and Maximum CPU Constraints for a Namespace</h1><div class=lead>Define a range of valid CPU resource limits for a namespace, so that every new Pod in that namespace falls within the range you configure.</div><p>This page shows how to set minimum and maximum values for the CPU resources used by containers
and Pods in a <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespace>namespace</a>. You specify minimum
and maximum CPU values in a
<a href=/docs/reference/kubernetes-api/policy-resources/limit-range-v1/>LimitRange</a>
object. If a Pod does not meet the constraints imposed by the LimitRange, it cannot be created
in the namespace.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You must have access to create namespaces in your cluster.</p><p>Each node in your cluster must have at least 1.0 CPU available for Pods.
See <a href=/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu>meaning of CPU</a>
to learn what Kubernetes means by “1 CPU”.</p><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace constraints-cpu-example
</span></span></code></pre></div><h2 id=create-a-limitrange-and-a-pod>Create a LimitRange and a Pod</h2><p>Here's a manifest for an example <a class=glossary-tooltip title='Provides constraints to limit resource consumption per Containers or Pods in a namespace.' data-toggle=tooltip data-placement=top href=/docs/concepts/policy/limit-range/ target=_blank aria-label=LimitRange>LimitRange</a>:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-constraints.yaml download=admin/resource/cpu-constraints.yaml><code>admin/resource/cpu-constraints.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-constraints-yaml")' title="Copy admin/resource/cpu-constraints.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-constraints-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LimitRange<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu-min-max-demo-lr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>max</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>min</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Container<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the LimitRange:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-constraints.yaml --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><p>View detailed information about the LimitRange:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get limitrange cpu-min-max-demo-lr --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><p>The output shows the minimum and maximum CPU constraints as expected. But
notice that even though you didn't specify default values in the configuration
file for the LimitRange, they were created automatically.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>default</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>800m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>defaultRequest</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>800m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>max</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>800m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>min</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>200m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Container<span style=color:#bbb>
</span></span></span></code></pre></div><p>Now whenever you create a Pod in the constraints-cpu-example namespace (or some other client
of the Kubernetes API creates an equivalent Pod), Kubernetes performs these steps:</p><ul><li><p>If any container in that Pod does not specify its own CPU request and limit, the control plane
assigns the default CPU request and limit to that container.</p></li><li><p>Verify that every container in that Pod specifies a CPU request that is greater than or equal to 200 millicpu.</p></li><li><p>Verify that every container in that Pod specifies a CPU limit that is less than or equal to 800 millicpu.</p></li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> When creating a <code>LimitRange</code> object, you can specify limits on huge-pages
or GPUs as well. However, when both <code>default</code> and <code>defaultRequest</code> are specified
on these resources, the two values must be the same.</div><p>Here's a manifest for a Pod that has one container. The container manifest
specifies a CPU request of 500 millicpu and a CPU limit of 800 millicpu. These satisfy the
minimum and maximum CPU constraints imposed by the LimitRange for this namespace.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-constraints-pod.yaml download=admin/resource/cpu-constraints-pod.yaml><code>admin/resource/cpu-constraints-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-constraints-pod-yaml")' title="Copy admin/resource/cpu-constraints-pod.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-constraints-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-cpu-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-cpu-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;500m&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-constraints-pod.yaml --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><p>Verify that the Pod is running and that its container is healthy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod constraints-cpu-demo --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod constraints-cpu-demo --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><p>The output shows that the Pod's only container has a CPU request of 500 millicpu and CPU limit
of 800 millicpu. These satisfy the constraints imposed by the LimitRange.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>800m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>500m<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=delete-the-pod>Delete the Pod</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod constraints-cpu-demo --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><h2 id=attempt-to-create-a-pod-that-exceeds-the-maximum-cpu-constraint>Attempt to create a Pod that exceeds the maximum CPU constraint</h2><p>Here's a manifest for a Pod that has one container. The container specifies a
CPU request of 500 millicpu and a cpu limit of 1.5 cpu.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-constraints-pod-2.yaml download=admin/resource/cpu-constraints-pod-2.yaml><code>admin/resource/cpu-constraints-pod-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-constraints-pod-2-yaml")' title="Copy admin/resource/cpu-constraints-pod-2.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-constraints-pod-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-cpu-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-cpu-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1.5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;500m&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Attempt to create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-constraints-pod-2.yaml --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><p>The output shows that the Pod does not get created, because it defines an unacceptable container.
That container is not acceptable because it specifies a CPU limit that is too large:</p><pre tabindex=0><code>Error from server (Forbidden): error when creating &#34;examples/admin/resource/cpu-constraints-pod-2.yaml&#34;:
pods &#34;constraints-cpu-demo-2&#34; is forbidden: maximum cpu usage per Container is 800m, but limit is 1500m.
</code></pre><h2 id=attempt-to-create-a-pod-that-does-not-meet-the-minimum-cpu-request>Attempt to create a Pod that does not meet the minimum CPU request</h2><p>Here's a manifest for a Pod that has one container. The container specifies a
CPU request of 100 millicpu and a CPU limit of 800 millicpu.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-constraints-pod-3.yaml download=admin/resource/cpu-constraints-pod-3.yaml><code>admin/resource/cpu-constraints-pod-3.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-constraints-pod-3-yaml")' title="Copy admin/resource/cpu-constraints-pod-3.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-constraints-pod-3-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-cpu-demo-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-cpu-demo-3-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100m&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Attempt to create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-constraints-pod-3.yaml --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><p>The output shows that the Pod does not get created, because it defines an unacceptable container.
That container is not acceptable because it specifies a CPU request that is lower than the
enforced minimum:</p><pre tabindex=0><code>Error from server (Forbidden): error when creating &#34;examples/admin/resource/cpu-constraints-pod-3.yaml&#34;:
pods &#34;constraints-cpu-demo-3&#34; is forbidden: minimum cpu usage per Container is 200m, but request is 100m.
</code></pre><h2 id=create-a-pod-that-does-not-specify-any-cpu-request-or-limit>Create a Pod that does not specify any CPU request or limit</h2><p>Here's a manifest for a Pod that has one container. The container does not
specify a CPU request, nor does it specify a CPU limit.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/cpu-constraints-pod-4.yaml download=admin/resource/cpu-constraints-pod-4.yaml><code>admin/resource/cpu-constraints-pod-4.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-cpu-constraints-pod-4-yaml")' title="Copy admin/resource/cpu-constraints-pod-4.yaml to clipboard"></img></div><div class=includecode id=admin-resource-cpu-constraints-pod-4-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-cpu-demo-4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>constraints-cpu-demo-4-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>vish/stress<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/cpu-constraints-pod-4.yaml --namespace<span style=color:#666>=</span>constraints-cpu-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><pre tabindex=0><code>kubectl get pod constraints-cpu-demo-4 --namespace=constraints-cpu-example --output=yaml
</code></pre><p>The output shows that the Pod's single container has a CPU request of 800 millicpu and a
CPU limit of 800 millicpu.
How did that container get those values?</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>800m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>800m<span style=color:#bbb>
</span></span></span></code></pre></div><p>Because that container did not specify its own CPU request and limit, the control plane
applied the
<a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>default CPU request and limit</a>
from the LimitRange for this namespace.</p><p>At this point, your Pod may or may not be running. Recall that a prerequisite for
this task is that your Nodes must have at least 1 CPU available for use. If each of your Nodes has only 1 CPU,
then there might not be enough allocatable CPU on any Node to accommodate a request of 800 millicpu.
If you happen to be using Nodes with 2 CPU, then you probably have enough CPU to accommodate the 800 millicpu request.</p><p>Delete your Pod:</p><pre tabindex=0><code>kubectl delete pod constraints-cpu-demo-4 --namespace=constraints-cpu-example
</code></pre><h2 id=enforcement-of-minimum-and-maximum-cpu-constraints>Enforcement of minimum and maximum CPU constraints</h2><p>The maximum and minimum CPU constraints imposed on a namespace by a LimitRange are enforced only
when a Pod is created or updated. If you change the LimitRange, it does not affect
Pods that were created previously.</p><h2 id=motivation-for-minimum-and-maximum-cpu-constraints>Motivation for minimum and maximum CPU constraints</h2><p>As a cluster administrator, you might want to impose restrictions on the CPU resources that Pods can use.
For example:</p><ul><li><p>Each Node in a cluster has 2 CPU. You do not want to accept any Pod that requests
more than 2 CPU, because no Node in the cluster can support the request.</p></li><li><p>A cluster is shared by your production and development departments.
You want to allow production workloads to consume up to 3 CPU, but you want development workloads to be limited
to 1 CPU. You create separate namespaces for production and development, and you apply CPU constraints to
each namespace.</p></li></ul><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace constraints-cpu-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li></ul><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fe3283559a3df299aae3ee00ecea2fad>2.4.5 - Configure Memory and CPU Quotas for a Namespace</h1><div class=lead>Define overall memory and CPU resource limits for a namespace.</div><p>This page shows how to set quotas for the total amount memory and CPU that
can be used by all Pods running in a <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespace>namespace</a>.
You specify quotas in a
<a href=/docs/reference/kubernetes-api/policy-resources/resource-quota-v1/>ResourceQuota</a>
object.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You must have access to create namespaces in your cluster.</p><p>Each node in your cluster must have at least 1 GiB of memory.</p><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace quota-mem-cpu-example
</span></span></code></pre></div><h2 id=create-a-resourcequota>Create a ResourceQuota</h2><p>Here is a manifest for an example ResourceQuota:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/quota-mem-cpu.yaml download=admin/resource/quota-mem-cpu.yaml><code>admin/resource/quota-mem-cpu.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-quota-mem-cpu-yaml")' title="Copy admin/resource/quota-mem-cpu.yaml to clipboard"></img></div><div class=includecode id=admin-resource-quota-mem-cpu-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ResourceQuota<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mem-cpu-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hard</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>requests.cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>requests.memory</span>:<span style=color:#bbb> </span>1Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>limits.cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>limits.memory</span>:<span style=color:#bbb> </span>2Gi<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the ResourceQuota:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/quota-mem-cpu.yaml --namespace<span style=color:#666>=</span>quota-mem-cpu-example
</span></span></code></pre></div><p>View detailed information about the ResourceQuota:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get resourcequota mem-cpu-demo --namespace<span style=color:#666>=</span>quota-mem-cpu-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The ResourceQuota places these requirements on the quota-mem-cpu-example namespace:</p><ul><li>For every Pod in the namespace, each container must have a memory request, memory limit, cpu request, and cpu limit.</li><li>The memory request total for all Pods in that namespace must not exceed 1 GiB.</li><li>The memory limit total for all Pods in that namespace must not exceed 2 GiB.</li><li>The CPU request total for all Pods in that namespace must not exceed 1 cpu.</li><li>The CPU limit total for all Pods in that namespace must not exceed 2 cpu.</li></ul><p>See <a href=/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu>meaning of CPU</a>
to learn what Kubernetes means by “1 CPU”.</p><h2 id=create-a-pod>Create a Pod</h2><p>Here is a manifest for an example Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/quota-mem-cpu-pod.yaml download=admin/resource/quota-mem-cpu-pod.yaml><code>admin/resource/quota-mem-cpu-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-quota-mem-cpu-pod-yaml")' title="Copy admin/resource/quota-mem-cpu-pod.yaml to clipboard"></img></div><div class=includecode id=admin-resource-quota-mem-cpu-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>quota-mem-cpu-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>quota-mem-cpu-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;600Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;400m&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/quota-mem-cpu-pod.yaml --namespace<span style=color:#666>=</span>quota-mem-cpu-example
</span></span></code></pre></div><p>Verify that the Pod is running and that its (only) container is healthy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod quota-mem-cpu-demo --namespace<span style=color:#666>=</span>quota-mem-cpu-example
</span></span></code></pre></div><p>Once again, view detailed information about the ResourceQuota:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get resourcequota mem-cpu-demo --namespace<span style=color:#666>=</span>quota-mem-cpu-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows the quota along with how much of the quota has been used.
You can see that the memory and CPU requests and limits for your Pod do not
exceed the quota.</p><pre tabindex=0><code>status:
  hard:
    limits.cpu: &#34;2&#34;
    limits.memory: 2Gi
    requests.cpu: &#34;1&#34;
    requests.memory: 1Gi
  used:
    limits.cpu: 800m
    limits.memory: 800Mi
    requests.cpu: 400m
    requests.memory: 600Mi
</code></pre><p>If you have the <code>jq</code> tool, you can also query (using <a href=/docs/reference/kubectl/jsonpath/>JSONPath</a>)
for just the <code>used</code> values, <strong>and</strong> pretty-print that that of the output. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get resourcequota mem-cpu-demo --namespace<span style=color:#666>=</span>quota-mem-cpu-example -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{ .status.used }&#39;</span> | jq .
</span></span></code></pre></div><h2 id=attempt-to-create-a-second-pod>Attempt to create a second Pod</h2><p>Here is a manifest for a second Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/quota-mem-cpu-pod-2.yaml download=admin/resource/quota-mem-cpu-pod-2.yaml><code>admin/resource/quota-mem-cpu-pod-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-quota-mem-cpu-pod-2-yaml")' title="Copy admin/resource/quota-mem-cpu-pod-2.yaml to clipboard"></img></div><div class=includecode id=admin-resource-quota-mem-cpu-pod-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>quota-mem-cpu-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>quota-mem-cpu-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>redis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1Gi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;800m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;700Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;400m&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the manifest, you can see that the Pod has a memory request of 700 MiB.
Notice that the sum of the used memory request and this new memory
request exceeds the memory request quota: 600 MiB + 700 MiB > 1 GiB.</p><p>Attempt to create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/quota-mem-cpu-pod-2.yaml --namespace<span style=color:#666>=</span>quota-mem-cpu-example
</span></span></code></pre></div><p>The second Pod does not get created. The output shows that creating the second Pod
would cause the memory request total to exceed the memory request quota.</p><pre tabindex=0><code>Error from server (Forbidden): error when creating &#34;examples/admin/resource/quota-mem-cpu-pod-2.yaml&#34;:
pods &#34;quota-mem-cpu-demo-2&#34; is forbidden: exceeded quota: mem-cpu-demo,
requested: requests.memory=700Mi,used: requests.memory=600Mi, limited: requests.memory=1Gi
</code></pre><h2 id=discussion>Discussion</h2><p>As you have seen in this exercise, you can use a ResourceQuota to restrict
the memory request total for all Pods running in a namespace.
You can also restrict the totals for memory limit, cpu request, and cpu limit.</p><p>Instead of managing total resource use within a namespace, you might want to restrict
individual Pods, or the containers in those Pods. To achieve that kind of limiting, use a
<a href=/docs/concepts/policy/limit-range/>LimitRange</a>.</p><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace quota-mem-cpu-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li></ul><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-40e30a9209e0c9f4153707e43243e9d7>2.4.6 - Configure a Pod Quota for a Namespace</h1><div class=lead>Restrict how many Pods you can create within a namespace.</div><p>This page shows how to set a quota for the total number of Pods that can run
in a <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=Namespace>Namespace</a>. You specify quotas in a
<a href=/docs/reference/kubernetes-api/policy-resources/resource-quota-v1/>ResourceQuota</a>
object.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You must have access to create namespaces in your cluster.</p><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace quota-pod-example
</span></span></code></pre></div><h2 id=create-a-resourcequota>Create a ResourceQuota</h2><p>Here is an example manifest for a ResourceQuota:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/quota-pod.yaml download=admin/resource/quota-pod.yaml><code>admin/resource/quota-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-quota-pod-yaml")' title="Copy admin/resource/quota-pod.yaml to clipboard"></img></div><div class=includecode id=admin-resource-quota-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ResourceQuota<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hard</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pods</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the ResourceQuota:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/quota-pod.yaml --namespace<span style=color:#666>=</span>quota-pod-example
</span></span></code></pre></div><p>View detailed information about the ResourceQuota:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get resourcequota pod-demo --namespace<span style=color:#666>=</span>quota-pod-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows that the namespace has a quota of two Pods, and that currently there are
no Pods; that is, none of the quota is used.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hard</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pods</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hard</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pods</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>used</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pods</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Here is an example manifest for a <a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployment>Deployment</a>:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/quota-pod-deployment.yaml download=admin/resource/quota-pod-deployment.yaml><code>admin/resource/quota-pod-deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-quota-pod-deployment-yaml")' title="Copy admin/resource/quota-pod-deployment.yaml to clipboard"></img></div><div class=includecode id=admin-resource-quota-pod-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-quota-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>purpose</span>:<span style=color:#bbb> </span>quota-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>purpose</span>:<span style=color:#bbb> </span>quota-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-quota-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In that manifest, <code>replicas: 3</code> tells Kubernetes to attempt to create three new Pods, all
running the same application.</p><p>Create the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/quota-pod-deployment.yaml --namespace<span style=color:#666>=</span>quota-pod-example
</span></span></code></pre></div><p>View detailed information about the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment pod-quota-demo --namespace<span style=color:#666>=</span>quota-pod-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows that even though the Deployment specifies three replicas, only two
Pods were created because of the quota you defined earlier:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>availableReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>lastUpdateTime</span>:<span style=color:#bbb> </span>2021-04-02T20:57:05Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>message: &#39;unable to create pods</span>:<span style=color:#bbb> </span>pods &#34;pod-quota-demo-1650323038-&#34; is forbidden:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>exceeded quota: pod-demo, requested: pods=1, used: pods=2, limited</span>:<span style=color:#bbb> </span>pods=2&#39;<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=choice-of-resource>Choice of resource</h3><p>In this task you have defined a ResourceQuota that limited the total number of Pods, but
you could also limit the total number of other kinds of object. For example, you
might decide to limit how many <a class=glossary-tooltip title='A repeating task (a Job) that runs on a regular schedule.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/cron-jobs/ target=_blank aria-label=CronJobs>CronJobs</a>
that can live in a single namespace.</p><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace quota-pod-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li></ul><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8c31aafd38fad5b0de0bd191758d6f93>2.5 - Install a Network Policy Provider</h1></div><div class=td-content><h1 id=pg-b4418905b0c14630e4e9cb1368241534>2.5.1 - Use Antrea for NetworkPolicy</h1><p>This page shows how to install and use Antrea CNI plugin on Kubernetes.
For background on Project Antrea, read the <a href=https://antrea.io/docs/>Introduction to Antrea</a>.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster. Follow the
<a href=/docs/reference/setup-tools/kubeadm/>kubeadm getting started guide</a> to bootstrap one.</p><h2 id=deploying-antrea-with-kubeadm>Deploying Antrea with kubeadm</h2><p>Follow <a href=https://github.com/vmware-tanzu/antrea/blob/main/docs/getting-started.md>Getting Started</a> guide to deploy Antrea for kubeadm.</p><h2 id=what-s-next>What's next</h2><p>Once your cluster is running, you can follow the <a href=/docs/tasks/administer-cluster/declare-network-policy/>Declare Network Policy</a> to try out Kubernetes NetworkPolicy.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1239a77618c6278373832a142cd85519>2.5.2 - Use Calico for NetworkPolicy</h1><p>This page shows a couple of quick ways to create a Calico cluster on Kubernetes.</p><h2 id=before-you-begin>Before you begin</h2><p>Decide whether you want to deploy a <a href=#creating-a-calico-cluster-with-google-kubernetes-engine-gke>cloud</a> or <a href=#creating-a-local-calico-cluster-with-kubeadm>local</a> cluster.</p><h2 id=creating-a-calico-cluster-with-google-kubernetes-engine-gke>Creating a Calico cluster with Google Kubernetes Engine (GKE)</h2><p><strong>Prerequisite</strong>: <a href=https://cloud.google.com/sdk/docs/quickstarts>gcloud</a>.</p><ol><li><p>To launch a GKE cluster with Calico, include the <code>--enable-network-policy</code> flag.</p><p><strong>Syntax</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcloud container clusters create <span style=color:#666>[</span>CLUSTER_NAME<span style=color:#666>]</span> --enable-network-policy
</span></span></code></pre></div><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gcloud container clusters create my-calico-cluster --enable-network-policy
</span></span></code></pre></div></li><li><p>To verify the deployment, use the following command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>The Calico pods begin with <code>calico</code>. Check to make sure each one has a status of <code>Running</code>.</p></li></ol><h2 id=creating-a-local-calico-cluster-with-kubeadm>Creating a local Calico cluster with kubeadm</h2><p>To get a local single-host Calico cluster in fifteen minutes using kubeadm, refer to the
<a href=https://docs.projectcalico.org/latest/getting-started/kubernetes/>Calico Quickstart</a>.</p><h2 id=what-s-next>What's next</h2><p>Once your cluster is running, you can follow the <a href=/docs/tasks/administer-cluster/declare-network-policy/>Declare Network Policy</a> to try out Kubernetes NetworkPolicy.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-95039241255a31df196beaa405b68eba>2.5.3 - Use Cilium for NetworkPolicy</h1><p>This page shows how to use Cilium for NetworkPolicy.</p><p>For background on Cilium, read the <a href=https://docs.cilium.io/en/stable/intro>Introduction to Cilium</a>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=deploying-cilium-on-minikube-for-basic-testing>Deploying Cilium on Minikube for Basic Testing</h2><p>To get familiar with Cilium easily you can follow the
<a href=https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/>Cilium Kubernetes Getting Started Guide</a>
to perform a basic DaemonSet installation of Cilium in minikube.</p><p>To start minikube, minimal version required is >= v1.5.2, run the with the
following arguments:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube version
</span></span></code></pre></div><pre tabindex=0><code>minikube version: v1.5.2
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube start --network-plugin<span style=color:#666>=</span>cni
</span></span></code></pre></div><p>For minikube you can install Cilium using its CLI tool. To do so, first download the latest
version of the CLI with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -LO https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
</span></span></code></pre></div><p>Then extract the downloaded file to your <code>/usr/local/bin</code> directory with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
</span></span><span style=display:flex><span>rm cilium-linux-amd64.tar.gz
</span></span></code></pre></div><p>After running the above commands, you can now install Cilium with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cilium install
</span></span></code></pre></div><p>Cilium will then automatically detect the cluster configuration and create and
install the appropriate components for a successful installation.
The components are:</p><ul><li>Certificate Authority (CA) in Secret <code>cilium-ca</code> and certificates for Hubble (Cilium's observability layer).</li><li>Service accounts.</li><li>Cluster roles.</li><li>ConfigMap.</li><li>Agent DaemonSet and an Operator Deployment.</li></ul><p>After the installation, you can view the overall status of the Cilium deployment with the <code>cilium status</code> command.
See the expected output of the <code>status</code> command
<a href=https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#validate-the-installation>here</a>.</p><p>The remainder of the Getting Started Guide explains how to enforce both L3/L4
(i.e., IP address + port) security policies, as well as L7 (e.g., HTTP) security
policies using an example application.</p><h2 id=deploying-cilium-for-production-use>Deploying Cilium for Production Use</h2><p>For detailed instructions around deploying Cilium for production, see:
<a href=https://docs.cilium.io/en/stable/concepts/kubernetes/intro/>Cilium Kubernetes Installation Guide</a>
This documentation includes detailed requirements, instructions and example
production DaemonSet files.</p><h2 id=understanding-cilium-components>Understanding Cilium components</h2><p>Deploying a cluster with Cilium adds Pods to the <code>kube-system</code> namespace. To see
this list of Pods run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --namespace<span style=color:#666>=</span>kube-system -l k8s-app<span style=color:#666>=</span>cilium
</span></span></code></pre></div><p>You'll see a list of Pods similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>NAME           READY   STATUS    RESTARTS   AGE
</span></span></span><span style=display:flex><span><span style=color:#888>cilium-kkdhz   1/1     Running   0          3m23s
</span></span></span><span style=display:flex><span><span style=color:#888>...
</span></span></span></code></pre></div><p>A <code>cilium</code> Pod runs on each node in your cluster and enforces network policy
on the traffic to/from Pods on that node using Linux BPF.</p><h2 id=what-s-next>What's next</h2><p>Once your cluster is running, you can follow the
<a href=/docs/tasks/administer-cluster/declare-network-policy/>Declare Network Policy</a>
to try out Kubernetes NetworkPolicy with Cilium.
Have fun, and if you have questions, contact us using the
<a href=https://cilium.herokuapp.com/>Cilium Slack Channel</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-505a0a6a7e6eff361bbb3be81c84b2e0>2.5.4 - Use Kube-router for NetworkPolicy</h1><p>This page shows how to use <a href=https://github.com/cloudnativelabs/kube-router>Kube-router</a> for NetworkPolicy.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster running. If you do not already have a cluster, you can create one by using any of the cluster installers like Kops, Bootkube, Kubeadm etc.</p><h2 id=installing-kube-router-addon>Installing Kube-router addon</h2><p>The Kube-router Addon comes with a Network Policy Controller that watches Kubernetes API server for any NetworkPolicy and pods updated and configures iptables rules and ipsets to allow or block traffic as directed by the policies. Please follow the <a href=https://www.kube-router.io/docs/user-guide/#try-kube-router-with-cluster-installers>trying Kube-router with cluster installers</a> guide to install Kube-router addon.</p><h2 id=what-s-next>What's next</h2><p>Once you have installed the Kube-router addon, you can follow the <a href=/docs/tasks/administer-cluster/declare-network-policy/>Declare Network Policy</a> to try out Kubernetes NetworkPolicy.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2842eac98aa0e229a5c6755c4c83d2a7>2.5.5 - Romana for NetworkPolicy</h1><p>This page shows how to use Romana for NetworkPolicy.</p><h2 id=before-you-begin>Before you begin</h2><p>Complete steps 1, 2, and 3 of the <a href=/docs/reference/setup-tools/kubeadm/>kubeadm getting started guide</a>.</p><h2 id=installing-romana-with-kubeadm>Installing Romana with kubeadm</h2><p>Follow the <a href=https://github.com/romana/romana/tree/master/containerize>containerized installation guide</a> for kubeadm.</p><h2 id=applying-network-policies>Applying network policies</h2><p>To apply network policies use one of the following:</p><ul><li><a href=https://github.com/romana/romana/wiki/Romana-policies>Romana network policies</a>.<ul><li><a href=https://github.com/romana/core/blob/master/doc/policy.md>Example of Romana network policy</a>.</li></ul></li><li>The NetworkPolicy API.</li></ul><h2 id=what-s-next>What's next</h2><p>Once you have installed Romana, you can follow the
<a href=/docs/tasks/administer-cluster/declare-network-policy/>Declare Network Policy</a>
to try out Kubernetes NetworkPolicy.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ac075c3fdfd0d41aa753cc70e42be064>2.5.6 - Weave Net for NetworkPolicy</h1><p>This page shows how to use Weave Net for NetworkPolicy.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster. Follow the
<a href=/docs/reference/setup-tools/kubeadm/>kubeadm getting started guide</a> to bootstrap one.</p><h2 id=install-the-weave-net-addon>Install the Weave Net addon</h2><p>Follow the <a href=https://www.weave.works/docs/net/latest/kubernetes/kube-addon/>Integrating Kubernetes via the Addon</a> guide.</p><p>The Weave Net addon for Kubernetes comes with a
<a href=https://www.weave.works/docs/net/latest/kubernetes/kube-addon/#npc>Network Policy Controller</a>
that automatically monitors Kubernetes for any NetworkPolicy annotations on all
namespaces and configures <code>iptables</code> rules to allow or block traffic as directed by the policies.</p><h2 id=test-the-installation>Test the installation</h2><p>Verify that the weave works.</p><p>Enter the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -n kube-system -o wide
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME                                    READY     STATUS    RESTARTS   AGE       IP              NODE
weave-net-1t1qg                         2/2       Running   0          9d        192.168.2.10    worknode3
weave-net-231d7                         2/2       Running   1          7d        10.2.0.17       worknodegpu
weave-net-7nmwt                         2/2       Running   3          9d        192.168.2.131   masternode
weave-net-pmw8w                         2/2       Running   0          9d        192.168.2.216   worknode2
</code></pre><p>Each Node has a weave Pod, and all Pods are <code>Running</code> and <code>2/2 READY</code>. (<code>2/2</code> means that each Pod has <code>weave</code> and <code>weave-npc</code>.)</p><h2 id=what-s-next>What's next</h2><p>Once you have installed the Weave Net addon, you can follow the
<a href=/docs/tasks/administer-cluster/declare-network-policy/>Declare Network Policy</a>
to try out Kubernetes NetworkPolicy. If you have any question, contact us at
<a href=https://github.com/weaveworks/weave#getting-help>#weave-community on Slack or Weave User Group</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e77685d5b88d2db5c7631a27b9472eea>2.6 - Access Clusters Using the Kubernetes API</h1><p>This page shows how to access clusters using the Kubernetes API.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=accessing-the-kubernetes-api>Accessing the Kubernetes API</h2><h3 id=accessing-for-the-first-time-with-kubectl>Accessing for the first time with kubectl</h3><p>When accessing the Kubernetes API for the first time, use the
Kubernetes command-line tool, <code>kubectl</code>.</p><p>To access a cluster, you need to know the location of the cluster and have credentials
to access it. Typically, this is automatically set-up when you work through
a <a href=/docs/setup/>Getting started guide</a>,
or someone else set up the cluster and provided you with credentials and a location.</p><p>Check the location and credentials that kubectl knows about with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config view
</span></span></code></pre></div><p>Many of the <a href=https://github.com/kubernetes/examples/tree/master/>examples</a> provide an introduction to using
kubectl. Complete documentation is found in the <a href=/docs/reference/kubectl/>kubectl manual</a>.</p><h3 id=directly-accessing-the-rest-api>Directly accessing the REST API</h3><p>kubectl handles locating and authenticating to the API server. If you want to directly access the REST API with an http client like
<code>curl</code> or <code>wget</code>, or a browser, there are multiple ways you can locate and authenticate against the API server:</p><ol><li>Run kubectl in proxy mode (recommended). This method is recommended, since it uses the stored apiserver location and verifies the identity of the API server using a self-signed cert. No man-in-the-middle (MITM) attack is possible using this method.</li><li>Alternatively, you can provide the location and credentials directly to the http client. This works with client code that is confused by proxies. To protect against man in the middle attacks, you'll need to import a root cert into your browser.</li></ol><p>Using the Go or Python client libraries provides accessing kubectl in proxy mode.</p><h4 id=using-kubectl-proxy>Using kubectl proxy</h4><p>The following command runs kubectl in a mode where it acts as a reverse proxy. It handles
locating the API server and authenticating.</p><p>Run it like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl proxy --port<span style=color:#666>=</span><span style=color:#666>8080</span> &amp;
</span></span></code></pre></div><p>See <a href=/docs/reference/generated/kubectl/kubectl-commands/#proxy>kubectl proxy</a> for more details.</p><p>Then you can explore the API with curl, wget, or a browser, like so:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl http://localhost:8080/api/
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;versions&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;v1&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;serverAddressByClientCIDRs&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;clientCIDR&#34;</span>: <span style=color:#b44>&#34;0.0.0.0/0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;serverAddress&#34;</span>: <span style=color:#b44>&#34;10.0.1.149:443&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=without-kubectl-proxy>Without kubectl proxy</h4><p>It is possible to avoid using kubectl proxy by passing an authentication token
directly to the API server, like this:</p><p>Using <code>grep/cut</code> approach:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Check all possible clusters, as your .KUBECONFIG may have multiple contexts:</span>
</span></span><span style=display:flex><span>kubectl config view -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{&#34;Cluster name\tServer\n&#34;}{range .clusters[*]}{.name}{&#34;\t&#34;}{.cluster.server}{&#34;\n&#34;}{end}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Select name of cluster you want to interact with from above output:</span>
</span></span><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>CLUSTER_NAME</span><span style=color:#666>=</span><span style=color:#b44>&#34;some_server_name&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Point to the API server referring the cluster name</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>APISERVER</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl config view -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{.clusters[?(@.name==\&#34;</span><span style=color:#b8860b>$CLUSTER_NAME</span><span style=color:#b44>\&#34;)].cluster.server}&#34;</span><span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a secret to hold a token for the default service account</span>
</span></span><span style=display:flex><span>kubectl apply -f - <span style=color:#b44>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: default-token
</span></span></span><span style=display:flex><span><span style=color:#b44>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#b44>    kubernetes.io/service-account.name: default
</span></span></span><span style=display:flex><span><span style=color:#b44>type: kubernetes.io/service-account-token
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Wait for the token controller to populate the secret with a token:</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>while</span> ! kubectl describe secret default-token | grep -E <span style=color:#b44>&#39;^token&#39;</span> &gt;/dev/null; <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>  <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;waiting for token...&#34;</span> &gt;&amp;<span style=color:#666>2</span>
</span></span><span style=display:flex><span>  sleep <span style=color:#666>1</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Get the token value</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>TOKEN</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get secret default-token -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.data.token}&#39;</span> | base64 --decode<span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Explore the API with TOKEN</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#b8860b>$APISERVER</span>/api --header <span style=color:#b44>&#34;Authorization: Bearer </span><span style=color:#b8860b>$TOKEN</span><span style=color:#b44>&#34;</span> --insecure
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;kind&#34;</span>: <span style=color:#b44>&#34;APIVersions&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;versions&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;v1&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;serverAddressByClientCIDRs&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;clientCIDR&#34;</span>: <span style=color:#b44>&#34;0.0.0.0/0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;serverAddress&#34;</span>: <span style=color:#b44>&#34;10.0.1.149:443&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The above example uses the <code>--insecure</code> flag. This leaves it subject to MITM
attacks. When kubectl accesses the cluster it uses a stored root certificate
and client certificates to access the server. (These are installed in the
<code>~/.kube</code> directory). Since cluster certificates are typically self-signed, it
may take special configuration to get your http client to use root
certificate.</p><p>On some clusters, the API server does not require authentication; it may serve
on localhost, or be protected by a firewall. There is not a standard
for this. <a href=/docs/concepts/security/controlling-access>Controlling Access to the Kubernetes API</a>
describes how you can configure this as a cluster administrator.</p><h3 id=programmatic-access-to-the-api>Programmatic access to the API</h3><p>Kubernetes officially supports client libraries for <a href=#go-client>Go</a>, <a href=#python-client>Python</a>, <a href=#java-client>Java</a>, <a href=#dotnet-client>dotnet</a>, <a href=#javascript-client>JavaScript</a>, and <a href=#haskell-client>Haskell</a>. There are other client libraries that are provided and maintained by their authors, not the Kubernetes team. See <a href=/docs/reference/using-api/client-libraries/>client libraries</a> for accessing the API from other languages and how they authenticate.</p><h4 id=go-client>Go client</h4><ul><li>To get the library, run the following command: <code>go get k8s.io/client-go@kubernetes-&lt;kubernetes-version-number></code> See <a href=https://github.com/kubernetes/client-go/releases>https://github.com/kubernetes/client-go/releases</a> to see which versions are supported.</li><li>Write an application atop of the client-go clients.</li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> client-go defines its own API objects, so if needed, import API definitions from client-go rather than from the main repository. For example, <code>import "k8s.io/client-go/kubernetes"</code> is correct.</div><p>The Go client can use the same <a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>
as the kubectl CLI does to locate and authenticate to the API server. See this <a href=https://git.k8s.io/client-go/examples/out-of-cluster-client-configuration/main.go>example</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a2f;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#b44>&#34;context&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#b44>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#b44>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#b44>&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#b44>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>func</span> <span style=color:#00a000>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>// uses the current context in kubeconfig
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  <span style=color:#080;font-style:italic>// path-to-kubeconfig -- for example, /root/.kube/config
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  config, _ <span style=color:#666>:=</span> clientcmd.<span style=color:#00a000>BuildConfigFromFlags</span>(<span style=color:#b44>&#34;&#34;</span>, <span style=color:#b44>&#34;&lt;path-to-kubeconfig&gt;&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>// creates the clientset
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  clientset, _ <span style=color:#666>:=</span> kubernetes.<span style=color:#00a000>NewForConfig</span>(config)
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>// access the API to list pods
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  pods, _ <span style=color:#666>:=</span> clientset.<span style=color:#00a000>CoreV1</span>().<span style=color:#00a000>Pods</span>(<span style=color:#b44>&#34;&#34;</span>).<span style=color:#00a000>List</span>(context.<span style=color:#00a000>TODO</span>(), v1.ListOptions{})
</span></span><span style=display:flex><span>  fmt.<span style=color:#00a000>Printf</span>(<span style=color:#b44>&#34;There are %d pods in the cluster\n&#34;</span>, <span style=color:#a2f>len</span>(pods.Items))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If the application is deployed as a Pod in the cluster, see <a href=/docs/tasks/access-application-cluster/access-cluster/#accessing-the-api-from-a-pod>Accessing the API from within a Pod</a>.</p><h4 id=python-client>Python client</h4><p>To use <a href=https://github.com/kubernetes-client/python>Python client</a>, run the following command: <code>pip install kubernetes</code>. See <a href=https://github.com/kubernetes-client/python>Python Client Library page</a> for more installation options.</p><p>The Python client can use the same <a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>
as the kubectl CLI does to locate and authenticate to the API server. See this <a href=https://github.com/kubernetes-client/python/blob/master/examples/out_of_cluster_config.py>example</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a2f;font-weight:700>from</span> <span style=color:#00f;font-weight:700>kubernetes</span> <span style=color:#a2f;font-weight:700>import</span> client, config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>config<span style=color:#666>.</span>load_kube_config()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>v1<span style=color:#666>=</span>client<span style=color:#666>.</span>CoreV1Api()
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Listing pods with their IPs:&#34;</span>)
</span></span><span style=display:flex><span>ret <span style=color:#666>=</span> v1<span style=color:#666>.</span>list_pod_for_all_namespaces(watch<span style=color:#666>=</span><span style=color:#a2f;font-weight:700>False</span>)
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> i <span style=color:#a2f;font-weight:700>in</span> ret<span style=color:#666>.</span>items:
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(<span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>%s</span><span style=color:#b62;font-weight:700>\t</span><span style=color:#b68;font-weight:700>%s</span><span style=color:#b62;font-weight:700>\t</span><span style=color:#b68;font-weight:700>%s</span><span style=color:#b44>&#34;</span> <span style=color:#666>%</span> (i<span style=color:#666>.</span>status<span style=color:#666>.</span>pod_ip, i<span style=color:#666>.</span>metadata<span style=color:#666>.</span>namespace, i<span style=color:#666>.</span>metadata<span style=color:#666>.</span>name))
</span></span></code></pre></div><h4 id=java-client>Java client</h4><p>To install the <a href=https://github.com/kubernetes-client/java>Java Client</a>, run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Clone java library</span>
</span></span><span style=display:flex><span>git clone --recursive https://github.com/kubernetes-client/java
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Installing project artifacts, POM etc:</span>
</span></span><span style=display:flex><span><span style=color:#a2f>cd</span> java
</span></span><span style=display:flex><span>mvn install
</span></span></code></pre></div><p>See <a href=https://github.com/kubernetes-client/java/releases>https://github.com/kubernetes-client/java/releases</a> to see which versions are supported.</p><p>The Java client can use the same <a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>
as the kubectl CLI does to locate and authenticate to the API server. See this <a href=https://github.com/kubernetes-client/java/blob/master/examples/examples-release-15/src/main/java/io/kubernetes/client/examples/KubeConfigFileClientExample.java>example</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a2f;font-weight:700>package</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.examples</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.ApiClient</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.ApiException</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.Configuration</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.apis.CoreV1Api</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.models.V1Pod</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.models.V1PodList</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.util.ClientBuilder</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>io.kubernetes.client.util.KubeConfig</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>java.io.FileReader</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>java.io.IOException</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * A simple example of how to use the Java API from an application outside a kubernetes cluster
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> *
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * &lt;p&gt;Easiest way to run this: mvn exec:java
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> * -Dexec.mainClass=&#34;io.kubernetes.client.examples.KubeConfigFileClientExample&#34;
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> *
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>KubeConfigFileClientExample</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>public</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#0b0;font-weight:700>void</span> <span style=color:#00a000>main</span><span style=color:#666>(</span>String<span style=color:#666>[]</span> args<span style=color:#666>)</span> <span style=color:#a2f;font-weight:700>throws</span> IOException<span style=color:#666>,</span> ApiException <span style=color:#666>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// file path to your KubeConfig
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    String kubeConfigPath <span style=color:#666>=</span> <span style=color:#b44>&#34;~/.kube/config&#34;</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// loading the out-of-cluster config, a kubeconfig from file-system
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    ApiClient client <span style=color:#666>=</span>
</span></span><span style=display:flex><span>        ClientBuilder<span style=color:#666>.</span><span style=color:#b44>kubeconfig</span><span style=color:#666>(</span>KubeConfig<span style=color:#666>.</span><span style=color:#b44>loadKubeConfig</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>new</span> FileReader<span style=color:#666>(</span>kubeConfigPath<span style=color:#666>))).</span><span style=color:#b44>build</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// set the global default api-client to the in-cluster one from above
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    Configuration<span style=color:#666>.</span><span style=color:#b44>setDefaultApiClient</span><span style=color:#666>(</span>client<span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// the CoreV1Api loads default api-client from global configuration.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    CoreV1Api api <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> CoreV1Api<span style=color:#666>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>// invokes the CoreV1Api client
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>    V1PodList list <span style=color:#666>=</span> api<span style=color:#666>.</span><span style=color:#b44>listPodForAllNamespaces</span><span style=color:#666>(</span><span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:#a2f;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span><span style=color:#b44>&#34;Listing all pods: &#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>for</span> <span style=color:#666>(</span>V1Pod item <span style=color:#666>:</span> list<span style=color:#666>.</span><span style=color:#b44>getItems</span><span style=color:#666>())</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      System<span style=color:#666>.</span><span style=color:#b44>out</span><span style=color:#666>.</span><span style=color:#b44>println</span><span style=color:#666>(</span>item<span style=color:#666>.</span><span style=color:#b44>getMetadata</span><span style=color:#666>().</span><span style=color:#b44>getName</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><h4 id=dotnet-client>dotnet client</h4><p>To use <a href=https://github.com/kubernetes-client/csharp>dotnet client</a>, run the following command: <code>dotnet add package KubernetesClient --version 1.6.1</code> See <a href=https://github.com/kubernetes-client/csharp>dotnet Client Library page</a> for more installation options. See <a href=https://github.com/kubernetes-client/csharp/releases>https://github.com/kubernetes-client/csharp/releases</a> to see which versions are supported.</p><p>The dotnet client can use the same <a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>
as the kubectl CLI does to locate and authenticate to the API server. See this <a href=https://github.com/kubernetes-client/csharp/blob/master/examples/simple/PodList.cs>example</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a2f;font-weight:700>using</span> <span style=color:#00f;font-weight:700>System</span>;
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>using</span> <span style=color:#00f;font-weight:700>k8s</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>namespace</span> <span style=color:#00f;font-weight:700>simple</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>internal</span> <span style=color:#a2f;font-weight:700>class</span> <span style=color:#00f>PodList</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>private</span> <span style=color:#a2f;font-weight:700>static</span> <span style=color:#a2f;font-weight:700>void</span> Main(<span style=color:#0b0;font-weight:700>string</span>[] args)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#0b0;font-weight:700>var</span> config = KubernetesClientConfiguration.BuildDefaultConfig();
</span></span><span style=display:flex><span>            IKubernetes client = <span style=color:#a2f;font-weight:700>new</span> Kubernetes(config);
</span></span><span style=display:flex><span>            Console.WriteLine(<span style=color:#b44>&#34;Starting Request!&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#0b0;font-weight:700>var</span> list = client.ListNamespacedPod(<span style=color:#b44>&#34;default&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>foreach</span> (<span style=color:#0b0;font-weight:700>var</span> item <span style=color:#a2f;font-weight:700>in</span> list.Items)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                Console.WriteLine(item.Metadata.Name);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a2f;font-weight:700>if</span> (list.Items.Count == <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                Console.WriteLine(<span style=color:#b44>&#34;Empty!&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=javascript-client>JavaScript client</h4><p>To install <a href=https://github.com/kubernetes-client/javascript>JavaScript client</a>, run the following command: <code>npm install @kubernetes/client-node</code>. See <a href=https://github.com/kubernetes-client/javascript/releases>https://github.com/kubernetes-client/javascript/releases</a> to see which versions are supported.</p><p>The JavaScript client can use the same <a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>
as the kubectl CLI does to locate and authenticate to the API server. See this <a href=https://github.com/kubernetes-client/javascript/blob/master/examples/example.js>example</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a2f;font-weight:700>const</span> k8s <span style=color:#666>=</span> require(<span style=color:#b44>&#39;@kubernetes/client-node&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>const</span> kc <span style=color:#666>=</span> <span style=color:#a2f;font-weight:700>new</span> k8s.KubeConfig();
</span></span><span style=display:flex><span>kc.loadFromDefault();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>const</span> k8sApi <span style=color:#666>=</span> kc.makeApiClient(k8s.CoreV1Api);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>k8sApi.listNamespacedPod(<span style=color:#b44>&#39;default&#39;</span>).then((res) =&gt; {
</span></span><span style=display:flex><span>    console.log(res.body);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h4 id=haskell-client>Haskell client</h4><p>See <a href=https://github.com/kubernetes-client/haskell/releases>https://github.com/kubernetes-client/haskell/releases</a> to see which versions are supported.</p><p>The <a href=https://github.com/kubernetes-client/haskell>Haskell client</a> can use the same <a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>
as the kubectl CLI does to locate and authenticate to the API server. See this <a href=https://github.com/kubernetes-client/haskell/blob/master/kubernetes-client/example/App.hs>example</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#00a000>exampleWithKubeConfig</span> <span style=color:#a2f;font-weight:700>::</span> <span style=color:#0b0;font-weight:700>IO</span> <span style=color:#a2f>()</span>
</span></span><span style=display:flex><span><span style=color:#00a000>exampleWithKubeConfig</span> <span style=color:#a2f;font-weight:700>=</span> <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>    oidcCache <span style=color:#a2f;font-weight:700>&lt;-</span> atomically <span style=color:#666>$</span> newTVar <span style=color:#666>$</span> <span style=color:#0b0;font-weight:700>Map</span><span style=color:#666>.</span>fromList <span style=color:#0b0;font-weight:700>[]</span>
</span></span><span style=display:flex><span>    (mgr, kcfg) <span style=color:#a2f;font-weight:700>&lt;-</span> mkKubeClientConfig oidcCache <span style=color:#666>$</span> <span style=color:#0b0;font-weight:700>KubeConfigFile</span> <span style=color:#b44>&#34;/path/to/kubeconfig&#34;</span>
</span></span><span style=display:flex><span>    dispatchMime
</span></span><span style=display:flex><span>            mgr
</span></span><span style=display:flex><span>            kcfg
</span></span><span style=display:flex><span>            (<span style=color:#0b0;font-weight:700>CoreV1</span><span style=color:#666>.</span>listPodForAllNamespaces (<span style=color:#0b0;font-weight:700>Accept</span> <span style=color:#0b0;font-weight:700>MimeJSON</span>))
</span></span><span style=display:flex><span>        <span style=color:#666>&gt;&gt;=</span> print
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/tasks/run-application/access-api-from-pod/>Accessing the Kubernetes API from a Pod</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a8f6511197efcd7d0db80ade49620f9d>2.7 - Advertise Extended Resources for a Node</h1><p>This page shows how to specify extended resources for a Node.
Extended resources allow cluster administrators to advertise node-level
resources that would otherwise be unknown to Kubernetes.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=get-the-names-of-your-nodes>Get the names of your Nodes</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p>Choose one of your Nodes to use for this exercise.</p><h2 id=advertise-a-new-extended-resource-on-one-of-your-nodes>Advertise a new extended resource on one of your Nodes</h2><p>To advertise a new extended resource on a Node, send an HTTP PATCH request to
the Kubernetes API server. For example, suppose one of your Nodes has four dongles
attached. Here's an example of a PATCH request that advertises four dongle resources
for your Node.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PATCH /api/v1/nodes/&lt;your-node-name&gt;/status HTTP/1.1
</span></span><span style=display:flex><span>Accept: application/json
</span></span><span style=display:flex><span>Content-Type: application/json-patch+json
</span></span><span style=display:flex><span>Host: k8s-master:8080
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>
</span></span><span style=display:flex><span>  <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;op&#34;</span>: <span style=color:#b44>&#34;add&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;path&#34;</span>: <span style=color:#b44>&#34;/status/capacity/example.com~1dongle&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;value&#34;</span>: <span style=color:#b44>&#34;4&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>]</span>
</span></span></code></pre></div><p>Note that Kubernetes does not need to know what a dongle is or what a dongle is for.
The preceding PATCH request tells Kubernetes that your Node has four things that
you call dongles.</p><p>Start a proxy, so that you can easily send requests to the Kubernetes API server:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl proxy
</span></span></code></pre></div><p>In another command window, send the HTTP PATCH request.
Replace <code>&lt;your-node-name></code> with the name of your Node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#b44>&#34;Content-Type: application/json-patch+json&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--request PATCH <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--data <span style=color:#b44>&#39;[{&#34;op&#34;: &#34;add&#34;, &#34;path&#34;: &#34;/status/capacity/example.com~1dongle&#34;, &#34;value&#34;: &#34;4&#34;}]&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>http://localhost:8001/api/v1/nodes/&lt;your-node-name&gt;/status
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In the preceding request, <code>~1</code> is the encoding for the character / in
the patch path. The operation path value in JSON-Patch is interpreted as a
JSON-Pointer. For more details, see
<a href=https://tools.ietf.org/html/rfc6901>IETF RFC 6901</a>, section 3.</div><p>The output shows that the Node has a capacity of 4 dongles:</p><pre tabindex=0><code>&#34;capacity&#34;: {
  &#34;cpu&#34;: &#34;2&#34;,
  &#34;memory&#34;: &#34;2049008Ki&#34;,
  &#34;example.com/dongle&#34;: &#34;4&#34;,
</code></pre><p>Describe your Node:</p><pre tabindex=0><code>kubectl describe node &lt;your-node-name&gt;
</code></pre><p>Once again, the output shows the dongle resource:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>Capacity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb>  </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb>  </span>2049008Ki<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span style=color:green;font-weight:700>example.com/dongle</span>:<span style=color:#bbb>  </span><span style=color:#666>4</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Now, application developers can create Pods that request a certain
number of dongles. See
<a href=/docs/tasks/configure-pod-container/extended-resource/>Assign Extended Resources to a Container</a>.</p><h2 id=discussion>Discussion</h2><p>Extended resources are similar to memory and CPU resources. For example,
just as a Node has a certain amount of memory and CPU to be shared by all components
running on the Node, it can have a certain number of dongles to be shared
by all components running on the Node. And just as application developers
can create Pods that request a certain amount of memory and CPU, they can
create Pods that request a certain number of dongles.</p><p>Extended resources are opaque to Kubernetes; Kubernetes does not
know anything about what they are. Kubernetes knows only that a Node
has a certain number of them. Extended resources must be advertised in integer
amounts. For example, a Node can advertise four dongles, but not 4.5 dongles.</p><h3 id=storage-example>Storage example</h3><p>Suppose a Node has 800 GiB of a special kind of disk storage. You could
create a name for the special storage, say example.com/special-storage.
Then you could advertise it in chunks of a certain size, say 100 GiB. In that case,
your Node would advertise that it has eight resources of type
example.com/special-storage.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>Capacity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span style=color:green;font-weight:700>example.com/special-storage</span>:<span style=color:#bbb> </span><span style=color:#666>8</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>If you want to allow arbitrary requests for special storage, you
could advertise special storage in chunks of size 1 byte. In that case, you would advertise
800Gi resources of type example.com/special-storage.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>Capacity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span style=color:green;font-weight:700>example.com/special-storage</span>:<span style=color:#bbb>  </span>800Gi<span style=color:#bbb>
</span></span></span></code></pre></div><p>Then a Container could request any number of bytes of special storage, up to 800Gi.</p><h2 id=clean-up>Clean up</h2><p>Here is a PATCH request that removes the dongle advertisement from a Node.</p><pre tabindex=0><code>PATCH /api/v1/nodes/&lt;your-node-name&gt;/status HTTP/1.1
Accept: application/json
Content-Type: application/json-patch+json
Host: k8s-master:8080

[
  {
    &#34;op&#34;: &#34;remove&#34;,
    &#34;path&#34;: &#34;/status/capacity/example.com~1dongle&#34;,
  }
]
</code></pre><p>Start a proxy, so that you can easily send requests to the Kubernetes API server:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl proxy
</span></span></code></pre></div><p>In another command window, send the HTTP PATCH request.
Replace <code>&lt;your-node-name></code> with the name of your Node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --header <span style=color:#b44>&#34;Content-Type: application/json-patch+json&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--request PATCH <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>--data <span style=color:#b44>&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/status/capacity/example.com~1dongle&#34;}]&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>http://localhost:8001/api/v1/nodes/&lt;your-node-name&gt;/status
</span></span></code></pre></div><p>Verify that the dongle advertisement has been removed:</p><pre tabindex=0><code>kubectl describe node &lt;your-node-name&gt; | grep dongle
</code></pre><p>(you should not see any output)</p><h2 id=what-s-next>What's next</h2><h3 id=for-application-developers>For application developers</h3><ul><li><a href=/docs/tasks/configure-pod-container/extended-resource/>Assign Extended Resources to a Container</a></li></ul><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></li><li><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-966cd1cc69c69410d8698b3ac74abce2>2.8 - Autoscale the DNS Service in a Cluster</h1><p>This page shows how to enable and configure autoscaling of the DNS service in
your Kubernetes cluster.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p></li><li><p>This guide assumes your nodes use the AMD64 or Intel 64 CPU architecture.</p></li><li><p>Make sure <a href=/docs/concepts/services-networking/dns-pod-service/>Kubernetes DNS</a> is enabled.</p></li></ul><h2 id=determining-whether-dns-horizontal-autoscaling-is-already-enabled>Determine whether DNS horizontal autoscaling is already enabled</h2><p>List the <a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployments>Deployments</a>
in your cluster in the kube-system <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespace>namespace</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>The output is similar to this:</p><pre><code>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
...
dns-autoscaler            1/1     1            1           ...
...
</code></pre><p>If you see "dns-autoscaler" in the output, DNS horizontal autoscaling is
already enabled, and you can skip to
<a href=#tuning-autoscaling-parameters>Tuning autoscaling parameters</a>.</p><h2 id=find-scaling-target>Get the name of your DNS Deployment</h2><p>List the DNS deployments in your cluster in the kube-system namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment -l k8s-app<span style=color:#666>=</span>kube-dns --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>The output is similar to this:</p><pre><code>NAME      READY   UP-TO-DATE   AVAILABLE   AGE
...
coredns   2/2     2            2           ...
...
</code></pre><p>If you don't see a Deployment for DNS services, you can also look for it by name:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>and look for a deployment named <code>coredns</code> or <code>kube-dns</code>.</p><p>Your scale target is</p><pre><code>Deployment/&lt;your-deployment-name&gt;
</code></pre><p>where <code>&lt;your-deployment-name></code> is the name of your DNS Deployment. For example, if
the name of your Deployment for DNS is coredns, your scale target is Deployment/coredns.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> CoreDNS is the default DNS service for Kubernetes. CoreDNS sets the label
<code>k8s-app=kube-dns</code> so that it can work in clusters that originally used
kube-dns.</div><h2 id=enablng-dns-horizontal-autoscaling>Enable DNS horizontal autoscaling</h2><p>In this section, you create a new Deployment. The Pods in the Deployment run a
container based on the <code>cluster-proportional-autoscaler-amd64</code> image.</p><p>Create a file named <code>dns-horizontal-autoscaler.yaml</code> with this content:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/dns/dns-horizontal-autoscaler.yaml download=admin/dns/dns-horizontal-autoscaler.yaml><code>admin/dns/dns-horizontal-autoscaler.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-dns-dns-horizontal-autoscaler-yaml")' title="Copy admin/dns/dns-horizontal-autoscaler.yaml to clipboard"></img></div><div class=includecode id=admin-dns-dns-horizontal-autoscaler-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;nodes&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;list&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;watch&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;replicationcontrollers/scale&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;get&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;update&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;apps&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;deployments/scale&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;replicasets/scale&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;get&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;update&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Remove the configmaps rule once below issue is fixed:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># kubernetes-incubator/cluster-proportional-autoscaler#16</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;configmaps&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;get&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;create&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>priorityClassName</span>:<span style=color:#bbb> </span>system-cluster-critical<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>seccompProfile</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>RuntimeDefault<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>supplementalGroups</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#666>65534</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>fsGroup</span>:<span style=color:#bbb> </span><span style=color:#666>65534</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>linux<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/cpa/cluster-proportional-autoscaler:1.8.4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;10Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- /cluster-proportional-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- --namespace=kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- --configmap=kube-dns-autoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># Should keep target in sync with cluster/addons/dns/kube-dns.yaml.base</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- --target=&lt;SCALE_TARGET&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># When cluster is using large nodes(with more cores), &#34;coresPerReplica&#34; should dominate.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># If using small nodes, &#34;nodesPerReplica&#34; should dominate.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- --default-params={&#34;linear&#34;:{&#34;coresPerReplica&#34;:256,&#34;nodesPerReplica&#34;:16,&#34;preventSinglePointFailure&#34;:true,&#34;includeUnschedulableNodes&#34;:true}}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- --logtostderr=true<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- --v=2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;CriticalAddonsOnly&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Exists&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>kube-dns-autoscaler<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the file, replace <code>&lt;SCALE_TARGET></code> with your scale target.</p><p>Go to the directory that contains your configuration file, and enter this
command to create the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f dns-horizontal-autoscaler.yaml
</span></span></code></pre></div><p>The output of a successful command is:</p><pre><code>deployment.apps/dns-autoscaler created
</code></pre><p>DNS horizontal autoscaling is now enabled.</p><h2 id=tuning-autoscaling-parameters>Tune DNS autoscaling parameters</h2><p>Verify that the dns-autoscaler <a class=glossary-tooltip title='An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a> exists:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get configmap --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>The output is similar to this:</p><pre><code>NAME                  DATA      AGE
...
dns-autoscaler        1         ...
...
</code></pre><p>Modify the data in the ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit configmap dns-autoscaler --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>Look for this line:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>linear</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;{&#34;coresPerReplica&#34;:256,&#34;min&#34;:1,&#34;nodesPerReplica&#34;:16}&#39;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Modify the fields according to your needs. The "min" field indicates the
minimal number of DNS backends. The actual number of backends is
calculated using this equation:</p><pre><code>replicas = max( ceil( cores × 1/coresPerReplica ) , ceil( nodes × 1/nodesPerReplica ) )
</code></pre><p>Note that the values of both <code>coresPerReplica</code> and <code>nodesPerReplica</code> are
floats.</p><p>The idea is that when a cluster is using nodes that have many cores,
<code>coresPerReplica</code> dominates. When a cluster is using nodes that have fewer
cores, <code>nodesPerReplica</code> dominates.</p><p>There are other supported scaling patterns. For details, see
<a href=https://github.com/kubernetes-sigs/cluster-proportional-autoscaler>cluster-proportional-autoscaler</a>.</p><h2 id=disable-dns-horizontal-autoscaling>Disable DNS horizontal autoscaling</h2><p>There are a few options for tuning DNS horizontal autoscaling. Which option to
use depends on different conditions.</p><h3 id=option-1-scale-down-the-dns-autoscaler-deployment-to-0-replicas>Option 1: Scale down the dns-autoscaler deployment to 0 replicas</h3><p>This option works for all situations. Enter this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl scale deployment --replicas<span style=color:#666>=</span><span style=color:#666>0</span> dns-autoscaler --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>The output is:</p><pre><code>deployment.apps/dns-autoscaler scaled
</code></pre><p>Verify that the replica count is zero:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get rs --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>The output displays 0 in the DESIRED and CURRENT columns:</p><pre><code>NAME                                 DESIRED   CURRENT   READY   AGE
...
dns-autoscaler-6b59789fc8            0         0         0       ...
...
</code></pre><h3 id=option-2-delete-the-dns-autoscaler-deployment>Option 2: Delete the dns-autoscaler deployment</h3><p>This option works if dns-autoscaler is under your own control, which means
no one will re-create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deployment dns-autoscaler --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>The output is:</p><pre><code>deployment.apps &quot;dns-autoscaler&quot; deleted
</code></pre><h3 id=option-3-delete-the-dns-autoscaler-manifest-file-from-the-master-node>Option 3: Delete the dns-autoscaler manifest file from the master node</h3><p>This option works if dns-autoscaler is under control of the (deprecated)
<a href=https://git.k8s.io/kubernetes/cluster/addons/README.md>Addon Manager</a>,
and you have write access to the master node.</p><p>Sign in to the master node and delete the corresponding manifest file.
The common path for this dns-autoscaler is:</p><pre><code>/etc/kubernetes/addons/dns-horizontal-autoscaler/dns-horizontal-autoscaler.yaml
</code></pre><p>After the manifest file is deleted, the Addon Manager will delete the
dns-autoscaler Deployment.</p><h2 id=understanding-how-dns-horizontal-autoscaling-works>Understanding how DNS horizontal autoscaling works</h2><ul><li><p>The cluster-proportional-autoscaler application is deployed separately from
the DNS service.</p></li><li><p>An autoscaler Pod runs a client that polls the Kubernetes API server for the
number of nodes and cores in the cluster.</p></li><li><p>A desired replica count is calculated and applied to the DNS backends based on
the current schedulable nodes and cores and the given scaling parameters.</p></li><li><p>The scaling parameters and data points are provided via a ConfigMap to the
autoscaler, and it refreshes its parameters table every poll interval to be up
to date with the latest desired scaling parameters.</p></li><li><p>Changes to the scaling parameters are allowed without rebuilding or restarting
the autoscaler Pod.</p></li><li><p>The autoscaler provides a controller interface to support two control
patterns: <em>linear</em> and <em>ladder</em>.</p></li></ul><h2 id=what-s-next>What's next</h2><ul><li>Read about <a href=/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/>Guaranteed Scheduling For Critical Add-On Pods</a>.</li><li>Learn more about the
<a href=https://github.com/kubernetes-sigs/cluster-proportional-autoscaler>implementation of cluster-proportional-autoscaler</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2bffd7f3571cdd609bd97fb2e1bdb2fe>2.9 - Change the default StorageClass</h1><p>This page shows how to change the default Storage Class that is used to
provision volumes for PersistentVolumeClaims that have no special requirements.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=why-change-the-default-storage-class>Why change the default storage class?</h2><p>Depending on the installation method, your Kubernetes cluster may be deployed with
an existing StorageClass that is marked as default. This default StorageClass
is then used to dynamically provision storage for PersistentVolumeClaims
that do not require any specific storage class. See
<a href=/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims>PersistentVolumeClaim documentation</a>
for details.</p><p>The pre-installed default StorageClass may not fit well with your expected workload;
for example, it might provision storage that is too expensive. If this is the case,
you can either change the default StorageClass or disable it completely to avoid
dynamic provisioning of storage.</p><p>Deleting the default StorageClass may not work, as it may be re-created
automatically by the addon manager running in your cluster. Please consult the docs for your installation
for details about addon manager and how to disable individual addons.</p><h2 id=changing-the-default-storageclass>Changing the default StorageClass</h2><ol><li><p>List the StorageClasses in your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get storageclass
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME                 PROVISIONER               AGE
</span></span><span style=display:flex><span>standard <span style=color:#666>(</span>default<span style=color:#666>)</span>   kubernetes.io/gce-pd      1d
</span></span><span style=display:flex><span>gold                 kubernetes.io/gce-pd      1d
</span></span></code></pre></div><p>The default StorageClass is marked by <code>(default)</code>.</p></li><li><p>Mark the default StorageClass as non-default:</p><p>The default StorageClass has an annotation
<code>storageclass.kubernetes.io/is-default-class</code> set to <code>true</code>. Any other value
or absence of the annotation is interpreted as <code>false</code>.</p><p>To mark a StorageClass as non-default, you need to change its value to <code>false</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch storageclass standard -p <span style=color:#b44>&#39;{&#34;metadata&#34;: {&#34;annotations&#34;:{&#34;storageclass.kubernetes.io/is-default-class&#34;:&#34;false&#34;}}}&#39;</span>
</span></span></code></pre></div><p>where <code>standard</code> is the name of your chosen StorageClass.</p></li><li><p>Mark a StorageClass as default:</p><p>Similar to the previous step, you need to add/set the annotation
<code>storageclass.kubernetes.io/is-default-class=true</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch storageclass gold -p <span style=color:#b44>&#39;{&#34;metadata&#34;: {&#34;annotations&#34;:{&#34;storageclass.kubernetes.io/is-default-class&#34;:&#34;true&#34;}}}&#39;</span>
</span></span></code></pre></div><p>Please note that at most one StorageClass can be marked as default. If two
or more of them are marked as default, a <code>PersistentVolumeClaim</code> without <code>storageClassName</code> explicitly specified cannot be created.</p></li><li><p>Verify that your chosen StorageClass is default:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get storageclass
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME             PROVISIONER               AGE
</span></span><span style=display:flex><span>standard         kubernetes.io/gce-pd      1d
</span></span><span style=display:flex><span>gold <span style=color:#666>(</span>default<span style=color:#666>)</span>   kubernetes.io/gce-pd      1d
</span></span></code></pre></div></li></ol><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/storage/persistent-volumes/>PersistentVolumes</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fbc9136f53eccd6eb8c80f4bbea3b8f4>2.10 - Change the Reclaim Policy of a PersistentVolume</h1><p>This page shows how to change the reclaim policy of a Kubernetes
PersistentVolume.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=why-change-reclaim-policy-of-a-persistentvolume>Why change reclaim policy of a PersistentVolume</h2><p>PersistentVolumes can have various reclaim policies, including "Retain",
"Recycle", and "Delete". For dynamically provisioned PersistentVolumes,
the default reclaim policy is "Delete". This means that a dynamically provisioned
volume is automatically deleted when a user deletes the corresponding
PersistentVolumeClaim. This automatic behavior might be inappropriate if the volume
contains precious data. In that case, it is more appropriate to use the "Retain"
policy. With the "Retain" policy, if a user deletes a PersistentVolumeClaim,
the corresponding PersistentVolume will not be deleted. Instead, it is moved to the
Released phase, where all of its data can be manually recovered.</p><h2 id=changing-the-reclaim-policy-of-a-persistentvolume>Changing the reclaim policy of a PersistentVolume</h2><ol><li><p>List the PersistentVolumes in your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pv
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>NAME                                       CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS    CLAIM             STORAGECLASS     REASON    AGE
pvc-b6efd8da-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim1    manual                     10s
pvc-b95650f8-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim2    manual                     6s
pvc-bb3ca71d-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim3    manual                     3s
</code></pre><p>This list also includes the name of the claims that are bound to each volume
for easier identification of dynamically provisioned volumes.</p></li><li><p>Choose one of your PersistentVolumes and change its reclaim policy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch pv &lt;your-pv-name&gt; -p <span style=color:#b44>&#39;{&#34;spec&#34;:{&#34;persistentVolumeReclaimPolicy&#34;:&#34;Retain&#34;}}&#39;</span>
</span></span></code></pre></div><p>where <code>&lt;your-pv-name></code> is the name of your chosen PersistentVolume.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>On Windows, you must <em>double</em> quote any JSONPath template that contains spaces (not single
quote as shown above for bash). This in turn means that you must use a single quote or escaped
double quote around any literals in the template. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>kubectl patch pv &lt;your-pv-name&gt; -p <span style=color:#b44>&#34;{\&#34;</span>spec\<span style=color:#b44>&#34;:{\&#34;</span>persistentVolumeReclaimPolicy\<span style=color:#b44>&#34;:\&#34;</span>Retain\<span style=color:#b44>&#34;}}&#34;</span>
</span></span></code></pre></div></div></li><li><p>Verify that your chosen PersistentVolume has the right policy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pv
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>NAME                                       CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS    CLAIM             STORAGECLASS     REASON    AGE
pvc-b6efd8da-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim1    manual                     40s
pvc-b95650f8-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim2    manual                     36s
pvc-bb3ca71d-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Retain          Bound     default/claim3    manual                     33s
</code></pre><p>In the preceding output, you can see that the volume bound to claim
<code>default/claim3</code> has reclaim policy <code>Retain</code>. It will not be automatically
deleted when a user deletes claim <code>default/claim3</code>.</p></li></ol><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/storage/persistent-volumes/>PersistentVolumes</a>.</li><li>Learn more about <a href=/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims>PersistentVolumeClaims</a>.</li></ul><h3 id=reference>References</h3><ul><li><a href=/docs/reference/kubernetes-api/config-and-storage-resources/persistent-volume-v1/>PersistentVolume</a><ul><li>Pay attention to the <code>.spec.persistentVolumeReclaimPolicy</code>
<a href=/docs/reference/kubernetes-api/config-and-storage-resources/persistent-volume-v1/#PersistentVolumeSpec>field</a>
of PersistentVolume.</li></ul></li><li><a href=/docs/reference/kubernetes-api/config-and-storage-resources/persistent-volume-claim-v1/>PersistentVolumeClaim</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ce4cd28c8feb9faa783e79b48af37961>2.11 - Cloud Controller Manager Administration</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.11 [beta]</code></div><p>Since cloud providers develop and release at a different pace compared to the Kubernetes project, abstracting the provider-specific code to the <code><a class=glossary-tooltip title='Control plane component that integrates Kubernetes with third-party cloud providers.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/cloud-controller/ target=_blank aria-label=cloud-controller-manager>cloud-controller-manager</a></code> binary allows cloud vendors to evolve independently from the core Kubernetes code.</p><p>The <code>cloud-controller-manager</code> can be linked to any cloud provider that satisfies <a href=https://github.com/kubernetes/cloud-provider/blob/master/cloud.go>cloudprovider.Interface</a>. For backwards compatibility, the <a href=https://github.com/kubernetes/kubernetes/tree/master/cmd/cloud-controller-manager>cloud-controller-manager</a> provided in the core Kubernetes project uses the same cloud libraries as <code>kube-controller-manager</code>. Cloud providers already supported in Kubernetes core are expected to use the in-tree cloud-controller-manager to transition out of Kubernetes core.</p><h2 id=administration>Administration</h2><h3 id=requirements>Requirements</h3><p>Every cloud has their own set of requirements for running their own cloud provider integration, it should not be too different from the requirements when running <code>kube-controller-manager</code>. As a general rule of thumb you'll need:</p><ul><li>cloud authentication/authorization: your cloud may require a token or IAM rules to allow access to their APIs</li><li>kubernetes authentication/authorization: cloud-controller-manager may need RBAC rules set to speak to the kubernetes apiserver</li><li>high availability: like kube-controller-manager, you may want a high available setup for cloud controller manager using leader election (on by default).</li></ul><h3 id=running-cloud-controller-manager>Running cloud-controller-manager</h3><p>Successfully running cloud-controller-manager requires some changes to your cluster configuration.</p><ul><li><code>kube-apiserver</code> and <code>kube-controller-manager</code> MUST NOT specify the <code>--cloud-provider</code> flag. This ensures that it does not run any cloud specific loops that would be run by cloud controller manager. In the future, this flag will be deprecated and removed.</li><li><code>kubelet</code> must run with <code>--cloud-provider=external</code>. This is to ensure that the kubelet is aware that it must be initialized by the cloud controller manager before it is scheduled any work.</li></ul><p>Keep in mind that setting up your cluster to use cloud controller manager will change your cluster behaviour in a few ways:</p><ul><li>kubelets specifying <code>--cloud-provider=external</code> will add a taint <code>node.cloudprovider.kubernetes.io/uninitialized</code> with an effect <code>NoSchedule</code> during initialization. This marks the node as needing a second initialization from an external controller before it can be scheduled work. Note that in the event that cloud controller manager is not available, new nodes in the cluster will be left unschedulable. The taint is important since the scheduler may require cloud specific information about nodes such as their region or type (high cpu, gpu, high memory, spot instance, etc).</li><li>cloud information about nodes in the cluster will no longer be retrieved using local metadata, but instead all API calls to retrieve node information will go through cloud controller manager. This may mean you can restrict access to your cloud API on the kubelets for better security. For larger clusters you may want to consider if cloud controller manager will hit rate limits since it is now responsible for almost all API calls to your cloud from within the cluster.</li></ul><p>The cloud controller manager can implement:</p><ul><li>Node controller - responsible for updating kubernetes nodes using cloud APIs and deleting kubernetes nodes that were deleted on your cloud.</li><li>Service controller - responsible for loadbalancers on your cloud against services of type LoadBalancer.</li><li>Route controller - responsible for setting up network routes on your cloud</li><li>any other features you would like to implement if you are running an out-of-tree provider.</li></ul><h2 id=examples>Examples</h2><p>If you are using a cloud that is currently supported in Kubernetes core and would like to adopt cloud controller manager, see the <a href=https://github.com/kubernetes/kubernetes/tree/master/cmd/cloud-controller-manager>cloud controller manager in kubernetes core</a>.</p><p>For cloud controller managers not in Kubernetes core, you can find the respective projects in repositories maintained by cloud vendors or by SIGs.</p><p>For providers already in Kubernetes core, you can run the in-tree cloud controller manager as a DaemonSet in your cluster, use the following as a guideline:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/cloud/ccm-example.yaml download=admin/cloud/ccm-example.yaml><code>admin/cloud/ccm-example.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-cloud-ccm-example-yaml")' title="Copy admin/cloud/ccm-example.yaml to clipboard"></img></div><div class=includecode id=admin-cloud-ccm-example-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># This is an example of how to set up cloud-controller-manager as a Daemonset in your cluster.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># It assumes that your masters can run pods and has the role node-role.kubernetes.io/master</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Note that this Daemonset will not work straight out of the box for your cloud, this is</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># meant to be a guideline.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cluster-admin<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># for in-tree providers we use registry.k8s.io/cloud-controller-manager</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># this can be replaced with any other image for out-of-tree providers</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/cloud-controller-manager:v1.8.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- /usr/local/bin/cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- --cloud-provider=[YOUR_CLOUD_PROVIDER] <span style=color:#bbb> </span><span style=color:#080;font-style:italic># Add your own cloud provider here!</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- --leader-elect=true<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- --use-service-account-credentials<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># these flags will vary for every cloud provider</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- --allocate-node-cidrs=true<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- --configure-cloud-routes=true<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- --cluster-cidr=172.17.0.0/16<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># this is required so CCM can bootstrap itself</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node.cloudprovider.kubernetes.io/uninitialized<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># these tolerations are to have the daemonset runnable on control plane nodes</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># remove them if your control plane nodes should not run pods</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node-role.kubernetes.io/control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exists<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node-role.kubernetes.io/master<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exists<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># this is to restrict CCM to only run on master nodes</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># the node selector may vary depending on your cluster setup</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>node-role.kubernetes.io/master</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h2 id=limitations>Limitations</h2><p>Running cloud controller manager comes with a few possible limitations. Although these limitations are being addressed in upcoming releases, it's important that you are aware of these limitations for production workloads.</p><h3 id=support-for-volumes>Support for Volumes</h3><p>Cloud controller manager does not implement any of the volume controllers found in <code>kube-controller-manager</code> as the volume integrations also require coordination with kubelets. As we evolve CSI (container storage interface) and add stronger support for flex volume plugins, necessary support will be added to cloud controller manager so that clouds can fully integrate with volumes. Learn more about out-of-tree CSI volume plugins <a href=https://github.com/kubernetes/features/issues/178>here</a>.</p><h3 id=scalability>Scalability</h3><p>The cloud-controller-manager queries your cloud provider's APIs to retrieve information for all nodes. For very large clusters, consider possible bottlenecks such as resource requirements and API rate limiting.</p><h3 id=chicken-and-egg>Chicken and Egg</h3><p>The goal of the cloud controller manager project is to decouple development of cloud features from the core Kubernetes project. Unfortunately, many aspects of the Kubernetes project has assumptions that cloud provider features are tightly integrated into the project. As a result, adopting this new architecture can create several situations where a request is being made for information from a cloud provider, but the cloud controller manager may not be able to return that information without the original request being complete.</p><p>A good example of this is the TLS bootstrapping feature in the Kubelet. TLS bootstrapping assumes that the Kubelet has the ability to ask the cloud provider (or a local metadata service) for all its address types (private, public, etc) but cloud controller manager cannot set a node's address types without being initialized in the first place which requires that the kubelet has TLS certificates to communicate with the apiserver.</p><p>As this initiative evolves, changes will be made to address these issues in upcoming releases.</p><h2 id=what-s-next>What's next</h2><p>To build and develop your own cloud controller manager, read <a href=/docs/tasks/administer-cluster/developing-cloud-controller-manager/>Developing Cloud Controller Manager</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5e59f5575dce11fdaed640afdbeedfc1>2.12 - Configure Quotas for API Objects</h1><p>This page shows how to configure quotas for API objects, including
PersistentVolumeClaims and Services. A quota restricts the number of
objects, of a particular type, that can be created in a namespace.
You specify quotas in a
<a href=/docs/reference/generated/kubernetes-api/v1.25/#resourcequota-v1-core>ResourceQuota</a>
object.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace quota-object-example
</span></span></code></pre></div><h2 id=create-a-resourcequota>Create a ResourceQuota</h2><p>Here is the configuration file for a ResourceQuota object:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/quota-objects.yaml download=admin/resource/quota-objects.yaml><code>admin/resource/quota-objects.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-quota-objects-yaml")' title="Copy admin/resource/quota-objects.yaml to clipboard"></img></div><div class=includecode id=admin-resource-quota-objects-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ResourceQuota<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>object-quota-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hard</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>persistentvolumeclaims</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>services.loadbalancers</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>services.nodeports</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the ResourceQuota:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/quota-objects.yaml --namespace<span style=color:#666>=</span>quota-object-example
</span></span></code></pre></div><p>View detailed information about the ResourceQuota:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get resourcequota object-quota-demo --namespace<span style=color:#666>=</span>quota-object-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows that in the quota-object-example namespace, there can be at most
one PersistentVolumeClaim, at most two Services of type LoadBalancer, and no Services
of type NodePort.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hard</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>persistentvolumeclaims</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>services.loadbalancers</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>services.nodeports</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>used</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>persistentvolumeclaims</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>services.loadbalancers</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>services.nodeports</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=create-a-persistentvolumeclaim>Create a PersistentVolumeClaim</h2><p>Here is the configuration file for a PersistentVolumeClaim object:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/quota-objects-pvc.yaml download=admin/resource/quota-objects-pvc.yaml><code>admin/resource/quota-objects-pvc.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-quota-objects-pvc-yaml")' title="Copy admin/resource/quota-objects-pvc.yaml to clipboard"></img></div><div class=includecode id=admin-resource-quota-objects-pvc-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PersistentVolumeClaim<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pvc-quota-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>storageClassName</span>:<span style=color:#bbb> </span>manual<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>accessModes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ReadWriteOnce<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>3Gi<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the PersistentVolumeClaim:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/quota-objects-pvc.yaml --namespace<span style=color:#666>=</span>quota-object-example
</span></span></code></pre></div><p>Verify that the PersistentVolumeClaim was created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get persistentvolumeclaims --namespace<span style=color:#666>=</span>quota-object-example
</span></span></code></pre></div><p>The output shows that the PersistentVolumeClaim exists and has status Pending:</p><pre tabindex=0><code>NAME             STATUS
pvc-quota-demo   Pending
</code></pre><h2 id=attempt-to-create-a-second-persistentvolumeclaim>Attempt to create a second PersistentVolumeClaim</h2><p>Here is the configuration file for a second PersistentVolumeClaim:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/resource/quota-objects-pvc-2.yaml download=admin/resource/quota-objects-pvc-2.yaml><code>admin/resource/quota-objects-pvc-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-resource-quota-objects-pvc-2-yaml")' title="Copy admin/resource/quota-objects-pvc-2.yaml to clipboard"></img></div><div class=includecode id=admin-resource-quota-objects-pvc-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PersistentVolumeClaim<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pvc-quota-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>storageClassName</span>:<span style=color:#bbb> </span>manual<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>accessModes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ReadWriteOnce<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>4Gi<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Attempt to create the second PersistentVolumeClaim:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/resource/quota-objects-pvc-2.yaml --namespace<span style=color:#666>=</span>quota-object-example
</span></span></code></pre></div><p>The output shows that the second PersistentVolumeClaim was not created,
because it would have exceeded the quota for the namespace.</p><pre tabindex=0><code>persistentvolumeclaims &#34;pvc-quota-demo-2&#34; is forbidden:
exceeded quota: object-quota-demo, requested: persistentvolumeclaims=1,
used: persistentvolumeclaims=1, limited: persistentvolumeclaims=1
</code></pre><h2 id=notes>Notes</h2><p>These are the strings used to identify API resources that can be constrained
by quotas:</p><table><tr><th>String</th><th>API Object</th></tr><tr><td>"pods"</td><td>Pod</td></tr><tr><td>"services"</td><td>Service</td></tr><tr><td>"replicationcontrollers"</td><td>ReplicationController</td></tr><tr><td>"resourcequotas"</td><td>ResourceQuota</td></tr><tr><td>"secrets"</td><td>Secret</td></tr><tr><td>"configmaps"</td><td>ConfigMap</td></tr><tr><td>"persistentvolumeclaims"</td><td>PersistentVolumeClaim</td></tr><tr><td>"services.nodeports"</td><td>Service of type NodePort</td></tr><tr><td>"services.loadbalancers"</td><td>Service of type LoadBalancer</td></tr></table><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace quota-object-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li></ul><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7127e6b7344b315b30b1ce8c4d8bfc55>2.13 - Control CPU Management Policies on the Node</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.12 [beta]</code></div><p>Kubernetes keeps many aspects of how pods execute on nodes abstracted
from the user. This is by design.  However, some workloads require
stronger guarantees in terms of latency and/or performance in order to operate
acceptably. The kubelet provides methods to enable more complex workload
placement policies while keeping the abstraction free from explicit placement
directives.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=cpu-management-policies>CPU Management Policies</h2><p>By default, the kubelet uses <a href=https://en.wikipedia.org/wiki/Completely_Fair_Scheduler>CFS quota</a>
to enforce pod CPU limits.  When the node runs many CPU-bound pods,
the workload can move to different CPU cores depending on
whether the pod is throttled and which CPU cores are available at
scheduling time. Many workloads are not sensitive to this migration and thus
work fine without any intervention.</p><p>However, in workloads where CPU cache affinity and scheduling latency
significantly affect workload performance, the kubelet allows alternative CPU
management policies to determine some placement preferences on the node.</p><h3 id=configuration>Configuration</h3><p>The CPU Manager policy is set with the <code>--cpu-manager-policy</code> kubelet
flag or the <code>cpuManagerPolicy</code> field in <a href=/docs/reference/config-api/kubelet-config.v1beta1/>KubeletConfiguration</a>.
There are two supported policies:</p><ul><li><a href=#none-policy><code>none</code></a>: the default policy.</li><li><a href=#static-policy><code>static</code></a>: allows pods with certain resource characteristics to be
granted increased CPU affinity and exclusivity on the node.</li></ul><p>The CPU manager periodically writes resource updates through the CRI in
order to reconcile in-memory CPU assignments with cgroupfs. The reconcile
frequency is set through a new Kubelet configuration value
<code>--cpu-manager-reconcile-period</code>. If not specified, it defaults to the same
duration as <code>--node-status-update-frequency</code>.</p><p>The behavior of the static policy can be fine-tuned using the <code>--cpu-manager-policy-options</code> flag.
The flag takes a comma-separated list of <code>key=value</code> policy options.
This feature can be disabled completely using the <code>CPUManagerPolicyOptions</code> feature gate.</p><p>The policy options are split into two groups: alpha quality (hidden by default) and beta quality
(visible by default). The groups are guarded respectively by the <code>CPUManagerPolicyAlphaOptions</code>
and <code>CPUManagerPolicyBetaOptions</code> feature gates. Diverging from the Kubernetes standard, these
feature gates guard groups of options, because it would have been too cumbersome to add a feature
gate for each individual option.</p><h3 id=changing-the-cpu-manager-policy>Changing the CPU Manager Policy</h3><p>Since the CPU manager policy can only be applied when kubelet spawns new pods, simply changing from
"none" to "static" won't apply to existing pods. So in order to properly change the CPU manager
policy on a node, perform the following steps:</p><ol><li><a href=/docs/tasks/administer-cluster/safely-drain-node>Drain</a> the node.</li><li>Stop kubelet.</li><li>Remove the old CPU manager state file. The path to this file is
<code>/var/lib/kubelet/cpu_manager_state</code> by default. This clears the state maintained by the
CPUManager so that the cpu-sets set up by the new policy won’t conflict with it.</li><li>Edit the kubelet configuration to change the CPU manager policy to the desired value.</li><li>Start kubelet.</li></ol><p>Repeat this process for every node that needs its CPU manager policy changed. Skipping this
process will result in kubelet crashlooping with the following error:</p><pre tabindex=0><code>could not restore state from checkpoint: configured policy &#34;static&#34; differs from state checkpoint policy &#34;none&#34;, please drain this node and delete the CPU manager checkpoint file &#34;/var/lib/kubelet/cpu_manager_state&#34; before restarting Kubelet
</code></pre><h3 id=none-policy>None policy</h3><p>The <code>none</code> policy explicitly enables the existing default CPU
affinity scheme, providing no affinity beyond what the OS scheduler does
automatically.  Limits on CPU usage for
<a href=/docs/tasks/configure-pod-container/quality-service-pod/>Guaranteed pods</a> and
<a href=/docs/tasks/configure-pod-container/quality-service-pod/>Burstable pods</a>
are enforced using CFS quota.</p><h3 id=static-policy>Static policy</h3><p>The <code>static</code> policy allows containers in <code>Guaranteed</code> pods with integer CPU
<code>requests</code> access to exclusive CPUs on the node. This exclusivity is enforced
using the <a href=https://www.kernel.org/doc/Documentation/cgroup-v1/cpusets.txt>cpuset cgroup controller</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> System services such as the container runtime and the kubelet itself can continue to run on these exclusive CPUs.  The exclusivity only extends to other pods.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> CPU Manager doesn't support offlining and onlining of
CPUs at runtime. Also, if the set of online CPUs changes on the node,
the node must be drained and CPU manager manually reset by deleting the
state file <code>cpu_manager_state</code> in the kubelet root directory.</div><p>This policy manages a shared pool of CPUs that initially contains all CPUs in the
node. The amount of exclusively allocatable CPUs is equal to the total
number of CPUs in the node minus any CPU reservations by the kubelet <code>--kube-reserved</code> or
<code>--system-reserved</code> options. From 1.17, the CPU reservation list can be specified
explicitly by kubelet <code>--reserved-cpus</code> option. The explicit CPU list specified by
<code>--reserved-cpus</code> takes precedence over the CPU reservation specified by
<code>--kube-reserved</code> and <code>--system-reserved</code>. CPUs reserved by these options are taken, in
integer quantity, from the initial shared pool in ascending order by physical
core ID.  This shared pool is the set of CPUs on which any containers in
<code>BestEffort</code> and <code>Burstable</code> pods run. Containers in <code>Guaranteed</code> pods with fractional
CPU <code>requests</code> also run on CPUs in the shared pool. Only containers that are
both part of a <code>Guaranteed</code> pod and have integer CPU <code>requests</code> are assigned
exclusive CPUs.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The kubelet requires a CPU reservation greater than zero be made
using either <code>--kube-reserved</code> and/or <code>--system-reserved</code> or <code>--reserved-cpus</code> when
the static policy is enabled. This is because zero CPU reservation would allow the shared
pool to become empty.</div><p>As <code>Guaranteed</code> pods whose containers fit the requirements for being statically
assigned are scheduled to the node, CPUs are removed from the shared pool and
placed in the cpuset for the container. CFS quota is not used to bound
the CPU usage of these containers as their usage is bound by the scheduling domain
itself. In others words, the number of CPUs in the container cpuset is equal to the integer
CPU <code>limit</code> specified in the pod spec. This static assignment increases CPU
affinity and decreases context switches due to throttling for the CPU-bound
workload.</p><p>Consider the containers in the following pod specs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>BestEffort</code> QoS class because no resource <code>requests</code> or
<code>limits</code> are specified. It runs in the shared pool.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>Burstable</code> QoS class because resource <code>requests</code> do not
equal <code>limits</code> and the <code>cpu</code> quantity is not specified. It runs in the shared
pool.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>Burstable</code> QoS class because resource <code>requests</code> do not
equal <code>limits</code>. It runs in the shared pool.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>Guaranteed</code> QoS class because <code>requests</code> are equal to <code>limits</code>.
And the container's resource limit for the CPU resource is an integer greater than
or equal to one. The <code>nginx</code> container is granted 2 exclusive CPUs.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1.5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1.5&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>Guaranteed</code> QoS class because <code>requests</code> are equal to <code>limits</code>.
But the container's resource limit for the CPU resource is a fraction. It runs in
the shared pool.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>Guaranteed</code> QoS class because only <code>limits</code> are specified
and <code>requests</code> are set equal to <code>limits</code> when not explicitly specified. And the
container's resource limit for the CPU resource is an integer greater than or
equal to one. The <code>nginx</code> container is granted 2 exclusive CPUs.</p><h4 id=static-policy-options>Static policy options</h4><p>You can toggle groups of options on and off based upon their maturity level
using the following feature gates:</p><ul><li><code>CPUManagerPolicyBetaOptions</code> default enabled. Disable to hide beta-level options.</li><li><code>CPUManagerPolicyAlphaOptions</code> default disabled. Enable to show alpha-level options.
You will still have to enable each option using the <code>CPUManagerPolicyOptions</code> kubelet option.</li></ul><p>The following policy options exist for the static <code>CPUManager</code> policy:</p><ul><li><code>full-pcpus-only</code> (beta, visible by default) (1.22 or higher)</li><li><code>distribute-cpus-across-numa</code> (alpha, hidden by default) (1.23 or higher)</li><li><code>align-by-socket</code> (alpha, hidden by default) (1.25 or higher)</li></ul><p>If the <code>full-pcpus-only</code> policy option is specified, the static policy will always allocate full physical cores.
By default, without this option, the static policy allocates CPUs using a topology-aware best-fit allocation.
On SMT enabled systems, the policy can allocate individual virtual cores, which correspond to hardware threads.
This can lead to different containers sharing the same physical cores; this behaviour in turn contributes
to the <a href=https://en.wikipedia.org/wiki/Cloud_computing_issues#Performance_interference_and_noisy_neighbors>noisy neighbours problem</a>.
With the option enabled, the pod will be admitted by the kubelet only if the CPU request of all its containers
can be fulfilled by allocating full physical cores.
If the pod does not pass the admission, it will be put in Failed state with the message <code>SMTAlignmentError</code>.</p><p>If the <code>distribute-cpus-across-numa</code>policy option is specified, the static
policy will evenly distribute CPUs across NUMA nodes in cases where more than
one NUMA node is required to satisfy the allocation.
By default, the <code>CPUManager</code> will pack CPUs onto one NUMA node until it is
filled, with any remaining CPUs simply spilling over to the next NUMA node.
This can cause undesired bottlenecks in parallel code relying on barriers (and
similar synchronization primitives), as this type of code tends to run only as
fast as its slowest worker (which is slowed down by the fact that fewer CPUs
are available on at least one NUMA node).
By distributing CPUs evenly across NUMA nodes, application developers can more
easily ensure that no single worker suffers from NUMA effects more than any
other, improving the overall performance of these types of applications.</p><p>If the <code>align-by-socket</code> policy option is specified, CPUs will be considered
aligned at the socket boundary when deciding how to allocate CPUs to a
container. By default, the <code>CPUManager</code> aligns CPU allocations at the NUMA
boundary, which could result in performance degradation if CPUs need to be
pulled from more than one NUMA node to satisfy the allocation. Although it
tries to ensure that all CPUs are allocated from the <em>minimum</em> number of NUMA
nodes, there is no guarantee that those NUMA nodes will be on the same socket.
By directing the <code>CPUManager</code> to explicitly align CPUs at the socket boundary
rather than the NUMA boundary, we are able to avoid such issues. Note, this
policy option is not compatible with <code>TopologyManager</code> <code>single-numa-node</code>
policy and does not apply to hardware where the number of sockets is greater
than number of NUMA nodes.</p><p>The <code>full-pcpus-only</code> option can be enabled by adding <code>full-pcpus-only=true</code> to
the CPUManager policy options.
Likewise, the <code>distribute-cpus-across-numa</code> option can be enabled by adding
<code>distribute-cpus-across-numa=true</code> to the CPUManager policy options.
When both are set, they are "additive" in the sense that CPUs will be
distributed across NUMA nodes in chunks of full-pcpus rather than individual
cores.
The <code>align-by-socket</code> policy option can be enabled by adding <code>align-by-socket=true</code>
to the <code>CPUManager</code> policy options. It is also additive to the <code>full-pcpus-only</code>
and <code>distribute-cpus-across-numa</code> policy options.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8060aed5bf1172fa62199a4c306a4cd1>2.14 - Control Topology Management Policies on a node</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [beta]</code></div><p>An increasing number of systems leverage a combination of CPUs and hardware accelerators to
support latency-critical execution and high-throughput parallel computation. These include
workloads in fields such as telecommunications, scientific computing, machine learning, financial
services and data analytics. Such hybrid systems comprise a high performance environment.</p><p>In order to extract the best performance, optimizations related to CPU isolation, memory and
device locality are required. However, in Kubernetes, these optimizations are handled by a
disjoint set of components.</p><p><em>Topology Manager</em> is a Kubelet component that aims to coordinate the set of components that are
responsible for these optimizations.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.18.
To check the version, enter <code>kubectl version</code>.</p><h2 id=how-topology-manager-works>How Topology Manager Works</h2><p>Prior to the introduction of Topology Manager, the CPU and Device Manager in Kubernetes make
resource allocation decisions independently of each other. This can result in undesirable
allocations on multiple-socketed systems, performance/latency sensitive applications will suffer
due to these undesirable allocations. Undesirable in this case meaning for example, CPUs and
devices being allocated from different NUMA Nodes thus, incurring additional latency.</p><p>The Topology Manager is a Kubelet component, which acts as a source of truth so that other Kubelet
components can make topology aligned resource allocation choices.</p><p>The Topology Manager provides an interface for components, called <em>Hint Providers</em>, to send and
receive topology information. Topology Manager has a set of node level policies which are
explained below.</p><p>The Topology manager receives Topology information from the <em>Hint Providers</em> as a bitmask denoting
NUMA Nodes available and a preferred allocation indication. The Topology Manager policies perform
a set of operations on the hints provided and converge on the hint determined by the policy to
give the optimal result, if an undesirable hint is stored the preferred field for the hint will be
set to false. In the current policies preferred is the narrowest preferred mask.
The selected hint is stored as part of the Topology Manager. Depending on the policy configured
the pod can be accepted or rejected from the node based on the selected hint.
The hint is then stored in the Topology Manager for use by the <em>Hint Providers</em> when making the
resource allocation decisions.</p><h3 id=enable-the-topology-manager-feature>Enable the Topology Manager feature</h3><p>Support for the Topology Manager requires <code>TopologyManager</code>
<a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gate</a> to be enabled.
It is enabled by default starting with Kubernetes 1.18.</p><h2 id=topology-manager-scopes-and-policies>Topology Manager Scopes and Policies</h2><p>The Topology Manager currently:</p><ul><li>Aligns Pods of all QoS classes.</li><li>Aligns the requested resources that Hint Provider provides topology hints for.</li></ul><p>If these conditions are met, the Topology Manager will align the requested resources.</p><p>In order to customise how this alignment is carried out, the Topology Manager provides two
distinct knobs: <code>scope</code> and <code>policy</code>.</p><p>The <code>scope</code> defines the granularity at which you would like resource alignment to be performed
(e.g. at the <code>pod</code> or <code>container</code> level). And the <code>policy</code> defines the actual strategy used to
carry out the alignment (e.g. <code>best-effort</code>, <code>restricted</code>, <code>single-numa-node</code>, etc.).
Details on the various <code>scopes</code> and <code>policies</code> available today can be found below.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> To align CPU resources with other requested resources in a Pod Spec, the CPU Manager should be
enabled and proper CPU Manager policy should be configured on a Node.
See <a href=/docs/tasks/administer-cluster/cpu-management-policies/>control CPU Management Policies</a>.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> To align memory (and hugepages) resources with other requested resources in a Pod Spec, the Memory
Manager should be enabled and proper Memory Manager policy should be configured on a Node. Examine
<a href=/docs/tasks/administer-cluster/memory-manager/>Memory Manager</a> documentation.</div><h3 id=topology-manager-scopes>Topology Manager Scopes</h3><p>The Topology Manager can deal with the alignment of resources in a couple of distinct scopes:</p><ul><li><code>container</code> (default)</li><li><code>pod</code></li></ul><p>Either option can be selected at a time of the kubelet startup, with <code>--topology-manager-scope</code>
flag.</p><h3 id=container-scope>container scope</h3><p>The <code>container</code> scope is used by default.</p><p>Within this scope, the Topology Manager performs a number of sequential resource alignments, i.e.,
for each container (in a pod) a separate alignment is computed. In other words, there is no notion
of grouping the containers to a specific set of NUMA nodes, for this particular scope. In effect,
the Topology Manager performs an arbitrary alignment of individual containers to NUMA nodes.</p><p>The notion of grouping the containers was endorsed and implemented on purpose in the following
scope, for example the <code>pod</code> scope.</p><h3 id=pod-scope>pod scope</h3><p>To select the <code>pod</code> scope, start the kubelet with the command line option <code>--topology-manager-scope=pod</code>.</p><p>This scope allows for grouping all containers in a pod to a common set of NUMA nodes. That is, the
Topology Manager treats a pod as a whole and attempts to allocate the entire pod (all containers)
to either a single NUMA node or a common set of NUMA nodes. The following examples illustrate the
alignments produced by the Topology Manager on different occasions:</p><ul><li>all containers can be and are allocated to a single NUMA node;</li><li>all containers can be and are allocated to a shared set of NUMA nodes.</li></ul><p>The total amount of particular resource demanded for the entire pod is calculated according to
<a href=/docs/concepts/workloads/pods/init-containers/#resources>effective requests/limits</a> formula, and
thus, this total value is equal to the maximum of:</p><ul><li>the sum of all app container requests,</li><li>the maximum of init container requests,</li></ul><p>for a resource.</p><p>Using the <code>pod</code> scope in tandem with <code>single-numa-node</code> Topology Manager policy is specifically
valuable for workloads that are latency sensitive or for high-throughput applications that perform
IPC. By combining both options, you are able to place all containers in a pod onto a single NUMA
node; hence, the inter-NUMA communication overhead can be eliminated for that pod.</p><p>In the case of <code>single-numa-node</code> policy, a pod is accepted only if a suitable set of NUMA nodes
is present among possible allocations. Reconsider the example above:</p><ul><li>a set containing only a single NUMA node - it leads to pod being admitted,</li><li>whereas a set containing more NUMA nodes - it results in pod rejection (because instead of one
NUMA node, two or more NUMA nodes are required to satisfy the allocation).</li></ul><p>To recap, Topology Manager first computes a set of NUMA nodes and then tests it against Topology
Manager policy, which either leads to the rejection or admission of the pod.</p><h3 id=topology-manager-policies>Topology Manager Policies</h3><p>Topology Manager supports four allocation policies. You can set a policy via a Kubelet flag,
<code>--topology-manager-policy</code>. There are four supported policies:</p><ul><li><code>none</code> (default)</li><li><code>best-effort</code></li><li><code>restricted</code></li><li><code>single-numa-node</code></li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If Topology Manager is configured with the <strong>pod</strong> scope, the container, which is considered by
the policy, is reflecting requirements of the entire pod, and thus each container from the pod
will result with <strong>the same</strong> topology alignment decision.</div><h3 id=policy-none>none policy</h3><p>This is the default policy and does not perform any topology alignment.</p><h3 id=policy-best-effort>best-effort policy</h3><p>For each container in a Pod, the kubelet, with <code>best-effort</code> topology management policy, calls
each Hint Provider to discover their resource availability. Using this information, the Topology
Manager stores the preferred NUMA Node affinity for that container. If the affinity is not
preferred, Topology Manager will store this and admit the pod to the node anyway.</p><p>The <em>Hint Providers</em> can then use this information when making the
resource allocation decision.</p><h3 id=policy-restricted>restricted policy</h3><p>For each container in a Pod, the kubelet, with <code>restricted</code> topology management policy, calls each
Hint Provider to discover their resource availability. Using this information, the Topology
Manager stores the preferred NUMA Node affinity for that container. If the affinity is not
preferred, Topology Manager will reject this pod from the node. This will result in a pod in a
<code>Terminated</code> state with a pod admission failure.</p><p>Once the pod is in a <code>Terminated</code> state, the Kubernetes scheduler will <strong>not</strong> attempt to
reschedule the pod. It is recommended to use a ReplicaSet or Deployment to trigger a redeploy of
the pod. An external control loop could be also implemented to trigger a redeployment of pods that
have the <code>Topology Affinity</code> error.</p><p>If the pod is admitted, the <em>Hint Providers</em> can then use this information when making the
resource allocation decision.</p><h3 id=policy-single-numa-node>single-numa-node policy</h3><p>For each container in a Pod, the kubelet, with <code>single-numa-node</code> topology management policy,
calls each Hint Provider to discover their resource availability. Using this information, the
Topology Manager determines if a single NUMA Node affinity is possible. If it is, Topology
Manager will store this and the <em>Hint Providers</em> can then use this information when making the
resource allocation decision. If, however, this is not possible then the Topology Manager will
reject the pod from the node. This will result in a pod in a <code>Terminated</code> state with a pod
admission failure.</p><p>Once the pod is in a <code>Terminated</code> state, the Kubernetes scheduler will <strong>not</strong> attempt to
reschedule the pod. It is recommended to use a Deployment with replicas to trigger a redeploy of
the Pod.An external control loop could be also implemented to trigger a redeployment of pods
that have the <code>Topology Affinity</code> error.</p><h3 id=pod-interactions-with-topology-manager-policies>Pod Interactions with Topology Manager Policies</h3><p>Consider the containers in the following pod specs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>BestEffort</code> QoS class because no resource <code>requests</code> or <code>limits</code> are specified.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>Burstable</code> QoS class because requests are less than limits.</p><p>If the selected policy is anything other than <code>none</code>, Topology Manager would consider these Pod
specifications. The Topology Manager would consult the Hint Providers to get topology hints.
In the case of the <code>static</code>, the CPU Manager policy would return default topology hint, because
these Pods do not have explicitly request CPU resources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/device</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/device</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod with integer CPU request runs in the <code>Guaranteed</code> QoS class because <code>requests</code> are equal
to <code>limits</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;300m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/device</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;300m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/device</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod with sharing CPU request runs in the <code>Guaranteed</code> QoS class because <code>requests</code> are equal
to <code>limits</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/deviceA</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/deviceB</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/deviceA</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/deviceB</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This pod runs in the <code>BestEffort</code> QoS class because there are no CPU and memory requests.</p><p>The Topology Manager would consider the above pods. The Topology Manager would consult the Hint
Providers, which are CPU and Device Manager to get topology hints for the pods.</p><p>In the case of the <code>Guaranteed</code> pod with integer CPU request, the <code>static</code> CPU Manager policy
would return topology hints relating to the exclusive CPU and the Device Manager would send back
hints for the requested device.</p><p>In the case of the <code>Guaranteed</code> pod with sharing CPU request, the <code>static</code> CPU Manager policy
would return default topology hint as there is no exclusive CPU request and the Device Manager
would send back hints for the requested device.</p><p>In the above two cases of the <code>Guaranteed</code> pod, the <code>none</code> CPU Manager policy would return default
topology hint.</p><p>In the case of the <code>BestEffort</code> pod, the <code>static</code> CPU Manager policy would send back the default
topology hint as there is no CPU request and the Device Manager would send back the hints for each
of the requested devices.</p><p>Using this information the Topology Manager calculates the optimal hint for the pod and stores
this information, which will be used by the Hint Providers when they are making their resource
assignments.</p><h3 id=known-limitations>Known Limitations</h3><ol><li><p>The maximum number of NUMA nodes that Topology Manager allows is 8. With more than 8 NUMA nodes
there will be a state explosion when trying to enumerate the possible NUMA affinities and
generating their hints.</p></li><li><p>The scheduler is not topology-aware, so it is possible to be scheduled on a node and then fail
on the node due to the Topology Manager.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-3d0cd7d2f13d4759094f281504cf57b8>2.15 - Customizing DNS Service</h1><p>This page explains how to configure your DNS
<a class=glossary-tooltip title='A Pod represents a set of running containers in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pod(s)>Pod(s)</a> and customize the
DNS resolution process in your cluster.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>Your cluster must be running the CoreDNS add-on.</p><p>Your Kubernetes server must be at or later than version v1.12.
To check the version, enter <code>kubectl version</code>.</p><h2 id=introduction>Introduction</h2><p>DNS is a built-in Kubernetes service launched automatically
using the <em>addon manager</em> <a href=http://releases.k8s.io/master/cluster/addons/README.md>cluster add-on</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The CoreDNS Service is named <code>kube-dns</code> in the <code>metadata.name</code> field.<br>The intent is to ensure greater interoperability with workloads that relied on
the legacy <code>kube-dns</code> Service name to resolve addresses internal to the cluster.
Using a Service named <code>kube-dns</code> abstracts away the implementation detail of
which DNS provider is running behind that common name.</div><p>If you are running CoreDNS as a Deployment, it will typically be exposed as
a Kubernetes Service with a static IP address.
The kubelet passes DNS resolver information to each container with the
<code>--cluster-dns=&lt;dns-service-ip></code> flag.</p><p>DNS names also need domains. You configure the local domain in the kubelet
with the flag <code>--cluster-domain=&lt;default-local-domain></code>.</p><p>The DNS server supports forward lookups (A and AAAA records), port lookups (SRV records),
reverse IP address lookups (PTR records), and more. For more information, see
<a href=/docs/concepts/services-networking/dns-pod-service/>DNS for Services and Pods</a>.</p><p>If a Pod's <code>dnsPolicy</code> is set to <code>default</code>, it inherits the name resolution
configuration from the node that the Pod runs on. The Pod's DNS resolution
should behave the same as the node.
But see <a href=/docs/tasks/administer-cluster/dns-debugging-resolution/#known-issues>Known issues</a>.</p><p>If you don't want this, or if you want a different DNS config for pods, you can
use the kubelet's <code>--resolv-conf</code> flag. Set this flag to "" to prevent Pods from
inheriting DNS. Set it to a valid file path to specify a file other than
<code>/etc/resolv.conf</code> for DNS inheritance.</p><h2 id=coredns>CoreDNS</h2><p>CoreDNS is a general-purpose authoritative DNS server that can serve as cluster DNS,
complying with the <a href=https://github.com/kubernetes/dns/blob/master/docs/specification.md>DNS specifications</a>.</p><h3 id=coredns-configmap-options>CoreDNS ConfigMap options</h3><p>CoreDNS is a DNS server that is modular and pluggable, with plugins adding new functionalities.
The CoreDNS server can be configured by maintaining a <a href=https://coredns.io/2017/07/23/corefile-explained/>Corefile</a>,
which is the CoreDNS configuration file. As a cluster administrator, you can modify the
<a class=glossary-tooltip title='An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a> for the CoreDNS Corefile to
change how DNS service discovery behaves for that cluster.</p><p>In Kubernetes, CoreDNS is installed with the following default Corefile configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>coredns<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>Corefile</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    .:53 {
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        errors
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        health {
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            lameduck 5s
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        }
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        ready
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        kubernetes cluster.local in-addr.arpa ip6.arpa {
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            pods insecure
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            fallthrough in-addr.arpa ip6.arpa
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            ttl 30
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        }
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        prometheus :9153
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        forward . /etc/resolv.conf
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        cache 30
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        loop
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        reload
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        loadbalance
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    }</span><span style=color:#bbb>    
</span></span></span></code></pre></div><p>The Corefile configuration includes the following <a href=https://coredns.io/plugins/>plugins</a> of CoreDNS:</p><ul><li><a href=https://coredns.io/plugins/errors/>errors</a>: Errors are logged to stdout.</li><li><a href=https://coredns.io/plugins/health/>health</a>: Health of CoreDNS is reported to
<code>http://localhost:8080/health</code>. In this extended syntax <code>lameduck</code> will make theuprocess
unhealthy then wait for 5 seconds before the process is shut down.</li><li><a href=https://coredns.io/plugins/ready/>ready</a>: An HTTP endpoint on port 8181 will return 200 OK,
when all plugins that are able to signal readiness have done so.</li><li><a href=https://coredns.io/plugins/kubernetes/>kubernetes</a>: CoreDNS will reply to DNS queries
based on IP of the Services and Pods. You can find <a href=https://coredns.io/plugins/kubernetes/>more details</a>
about this plugin on the CoreDNS website.<ul><li><code>ttl</code> allows you to set a custom TTL for responses. The default is 5 seconds.
The minimum TTL allowed is 0 seconds, and the maximum is capped at 3600 seconds.
Setting TTL to 0 will prevent records from being cached.</li><li>The <code>pods insecure</code> option is provided for backward compatibility with <code>kube-dns</code>.</li><li>You can use the <code>pods verified</code> option, which returns an A record only if there exists a pod
in the same namespace with a matching IP.</li><li>The <code>pods disabled</code> option can be used if you don't use pod records.</li></ul></li><li><a href=https://coredns.io/plugins/metrics/>prometheus</a>: Metrics of CoreDNS are available at
<code>http://localhost:9153/metrics</code> in the <a href=https://prometheus.io/>Prometheus</a> format
(also known as OpenMetrics).</li><li><a href=https://coredns.io/plugins/forward/>forward</a>: Any queries that are not within the Kubernetes
cluster domain are forwarded to predefined resolvers (/etc/resolv.conf).</li><li><a href=https://coredns.io/plugins/cache/>cache</a>: This enables a frontend cache.</li><li><a href=https://coredns.io/plugins/loop/>loop</a>: Detects simple forwarding loops and
halts the CoreDNS process if a loop is found.</li><li><a href=https://coredns.io/plugins/reload>reload</a>: Allows automatic reload of a changed Corefile.
After you edit the ConfigMap configuration, allow two minutes for your changes to take effect.</li><li><a href=https://coredns.io/plugins/loadbalance>loadbalance</a>: This is a round-robin DNS loadbalancer
that randomizes the order of A, AAAA, and MX records in the answer.</li></ul><p>You can modify the default CoreDNS behavior by modifying the ConfigMap.</p><h3 id=configuration-of-stub-domain-and-upstream-nameserver-using-coredns>Configuration of Stub-domain and upstream nameserver using CoreDNS</h3><p>CoreDNS has the ability to configure stub-domains and upstream nameservers
using the <a href=https://coredns.io/plugins/forward/>forward plugin</a>.</p><h4 id=example>Example</h4><p>If a cluster operator has a <a href=https://www.consul.io/>Consul</a> domain server located at "10.150.0.1",
and all Consul names have the suffix ".consul.local". To configure it in CoreDNS,
the cluster administrator creates the following stanza in the CoreDNS ConfigMap.</p><pre tabindex=0><code>consul.local:53 {
    errors
    cache 30
    forward . 10.150.0.1
}
</code></pre><p>To explicitly force all non-cluster DNS lookups to go through a specific nameserver at 172.16.0.1,
point the <code>forward</code> to the nameserver instead of <code>/etc/resolv.conf</code></p><pre tabindex=0><code>forward .  172.16.0.1
</code></pre><p>The final ConfigMap along with the default <code>Corefile</code> configuration looks like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>coredns<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>Corefile</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    .:53 {
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        errors
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        health
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        kubernetes cluster.local in-addr.arpa ip6.arpa {
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>           pods insecure
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>           fallthrough in-addr.arpa ip6.arpa
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        }
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        prometheus :9153
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        forward . 172.16.0.1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        cache 30
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        loop
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        reload
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        loadbalance
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    }
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    consul.local:53 {
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        errors
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        cache 30
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        forward . 10.150.0.1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    }</span><span style=color:#bbb>    
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> CoreDNS does not support FQDNs for stub-domains and nameservers (eg: "ns.foo.com").
During translation, all FQDN nameservers will be omitted from the CoreDNS config.</div><h2 id=what-s-next>What's next</h2><ul><li>Read <a href=/docs/tasks/administer-cluster/dns-debugging-resolution/>Debugging DNS Resolution</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8bcf4aeb5bbb6d6969a146e5ab97557b>2.16 - Debugging DNS Resolution</h1><p>This page provides hints on diagnosing DNS problems.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><br>Your cluster must be configured to use the CoreDNS
<a class=glossary-tooltip title='Resources that extend the functionality of Kubernetes.' data-toggle=tooltip data-placement=top href=/docs/concepts/cluster-administration/addons/ target=_blank aria-label=addon>addon</a> or its precursor,
kube-dns.</p><p>Your Kubernetes server must be at or later than version v1.6.
To check the version, enter <code>kubectl version</code>.</p><h3 id=create-a-simple-pod-to-use-as-a-test-environment>Create a simple Pod to use as a test environment</h3><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/dns/dnsutils.yaml download=admin/dns/dnsutils.yaml><code>admin/dns/dnsutils.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-dns-dnsutils-yaml")' title="Copy admin/dns/dnsutils.yaml to clipboard"></img></div><div class=includecode id=admin-dns-dnsutils-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dnsutils<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dnsutils<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/e2e-test-images/jessie-dnsutils:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- sleep<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;infinity&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This example creates a pod in the <code>default</code> namespace. DNS name resolution for
services depends on the namespace of the pod. For more information, review
<a href=/docs/concepts/services-networking/dns-pod-service/#what-things-get-dns-names>DNS for Services and Pods</a>.</div><p>Use that manifest to create a Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/dns/dnsutils.yaml
</span></span></code></pre></div><pre tabindex=0><code>pod/dnsutils created
</code></pre><p>…and verify its status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods dnsutils
</span></span></code></pre></div><pre tabindex=0><code>NAME      READY     STATUS    RESTARTS   AGE
dnsutils   1/1       Running   0          &lt;some-time&gt;
</code></pre><p>Once that Pod is running, you can exec <code>nslookup</code> in that environment.
If you see something like the following, DNS is working correctly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t dnsutils -- nslookup kubernetes.default
</span></span></code></pre></div><pre tabindex=0><code>Server:    10.0.0.10
Address 1: 10.0.0.10

Name:      kubernetes.default
Address 1: 10.0.0.1
</code></pre><p>If the <code>nslookup</code> command fails, check the following:</p><h3 id=check-the-local-dns-configuration-first>Check the local DNS configuration first</h3><p>Take a look inside the resolv.conf file.
(See <a href=/docs/tasks/administer-cluster/dns-custom-nameservers>Customizing DNS Service</a> and
<a href=#known-issues>Known issues</a> below for more information)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -ti dnsutils -- cat /etc/resolv.conf
</span></span></code></pre></div><p>Verify that the search path and name server are set up like the following
(note that search path may vary for different cloud providers):</p><pre tabindex=0><code>search default.svc.cluster.local svc.cluster.local cluster.local google.internal c.gce_project_id.internal
nameserver 10.0.0.10
options ndots:5
</code></pre><p>Errors such as the following indicate a problem with the CoreDNS (or kube-dns)
add-on or with associated Services:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t dnsutils -- nslookup kubernetes.default
</span></span></code></pre></div><pre tabindex=0><code>Server:    10.0.0.10
Address 1: 10.0.0.10

nslookup: can&#39;t resolve &#39;kubernetes.default&#39;
</code></pre><p>or</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t dnsutils -- nslookup kubernetes.default
</span></span></code></pre></div><pre tabindex=0><code>Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

nslookup: can&#39;t resolve &#39;kubernetes.default&#39;
</code></pre><h3 id=check-if-the-dns-pod-is-running>Check if the DNS pod is running</h3><p>Use the <code>kubectl get pods</code> command to verify that the DNS pod is running.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --namespace<span style=color:#666>=</span>kube-system -l k8s-app<span style=color:#666>=</span>kube-dns
</span></span></code></pre></div><pre tabindex=0><code>NAME                       READY     STATUS    RESTARTS   AGE
...
coredns-7b96bf9f76-5hsxb   1/1       Running   0           1h
coredns-7b96bf9f76-mvmmt   1/1       Running   0           1h
...
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The value for label <code>k8s-app</code> is <code>kube-dns</code> for both CoreDNS and kube-dns deployments.</div><p>If you see that no CoreDNS Pod is running or that the Pod has failed/completed,
the DNS add-on may not be deployed by default in your current environment and you
will have to deploy it manually.</p><h3 id=check-for-errors-in-the-dns-pod>Check for errors in the DNS pod</h3><p>Use the <code>kubectl logs</code> command to see logs for the DNS containers.</p><p>For CoreDNS:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs --namespace<span style=color:#666>=</span>kube-system -l k8s-app<span style=color:#666>=</span>kube-dns
</span></span></code></pre></div><p>Here is an example of a healthy CoreDNS log:</p><pre tabindex=0><code>.:53
2018/08/15 14:37:17 [INFO] CoreDNS-1.2.2
2018/08/15 14:37:17 [INFO] linux/amd64, go1.10.3, 2e322f6
CoreDNS-1.2.2
linux/amd64, go1.10.3, 2e322f6
2018/08/15 14:37:17 [INFO] plugin/reload: Running configuration MD5 = 24e6c59e83ce706f07bcc82c31b1ea1c
</code></pre><p>See if there are any suspicious or unexpected messages in the logs.</p><h3 id=is-dns-service-up>Is DNS service up?</h3><p>Verify that the DNS service is up by using the <code>kubectl get service</code> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><pre tabindex=0><code>NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE
...
kube-dns     ClusterIP   10.0.0.10      &lt;none&gt;        53/UDP,53/TCP        1h
...
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The service name is <code>kube-dns</code> for both CoreDNS and kube-dns deployments.</div><p>If you have created the Service or in the case it should be created by default
but it does not appear, see
<a href=/docs/tasks/debug/debug-application/debug-service/>debugging Services</a> for
more information.</p><h3 id=are-dns-endpoints-exposed>Are DNS endpoints exposed?</h3><p>You can verify that DNS endpoints are exposed by using the <code>kubectl get endpoints</code>
command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get endpoints kube-dns --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><pre tabindex=0><code>NAME       ENDPOINTS                       AGE
kube-dns   10.180.3.17:53,10.180.3.17:53    1h
</code></pre><p>If you do not see the endpoints, see the endpoints section in the
<a href=/docs/tasks/debug/debug-application/debug-service/>debugging Services</a> documentation.</p><p>For additional Kubernetes DNS examples, see the
<a href=https://github.com/kubernetes/examples/tree/master/staging/cluster-dns>cluster-dns examples</a>
in the Kubernetes GitHub repository.</p><h3 id=are-dns-queries-being-received-processed>Are DNS queries being received/processed?</h3><p>You can verify if queries are being received by CoreDNS by adding the <code>log</code> plugin to the CoreDNS configuration (aka Corefile).
The CoreDNS Corefile is held in a <a class=glossary-tooltip title='An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a> named <code>coredns</code>. To edit it, use the command:</p><pre tabindex=0><code>kubectl -n kube-system edit configmap coredns
</code></pre><p>Then add <code>log</code> in the Corefile section per the example below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>coredns<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>Corefile</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    .:53 {
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        log
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        errors
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        health
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        kubernetes cluster.local in-addr.arpa ip6.arpa {
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          pods insecure
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          upstream
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          fallthrough in-addr.arpa ip6.arpa
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        }
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        prometheus :9153
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        forward . /etc/resolv.conf
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        cache 30
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        loop
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        reload
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        loadbalance
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    }</span><span style=color:#bbb>    
</span></span></span></code></pre></div><p>After saving the changes, it may take up to minute or two for Kubernetes to propagate these changes to the CoreDNS pods.</p><p>Next, make some queries and view the logs per the sections above in this document. If CoreDNS pods are receiving the queries, you should see them in the logs.</p><p>Here is an example of a query in the log:</p><pre tabindex=0><code>.:53
2018/08/15 14:37:15 [INFO] CoreDNS-1.2.0
2018/08/15 14:37:15 [INFO] linux/amd64, go1.10.3, 2e322f6
CoreDNS-1.2.0
linux/amd64, go1.10.3, 2e322f6
2018/09/07 15:29:04 [INFO] plugin/reload: Running configuration MD5 = 162475cdf272d8aa601e6fe67a6ad42f
2018/09/07 15:29:04 [INFO] Reloading complete
172.17.0.18:41675 - [07/Sep/2018:15:29:11 +0000] 59925 &#34;A IN kubernetes.default.svc.cluster.local. udp 54 false 512&#34; NOERROR qr,aa,rd,ra 106 0.000066649s
</code></pre><h3 id=does-coredns-have-sufficient-permissions>Does CoreDNS have sufficient permissions?</h3><p>CoreDNS must be able to list <a class=glossary-tooltip title='A way to expose an application running on a set of Pods as a network service.' data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=service>service</a> and <a class=glossary-tooltip title='Endpoints track the IP addresses of Pods with matching Service selectors.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-endpoint' target=_blank aria-label=endpoint>endpoint</a> related resources to properly resolve service names.</p><p>Sample error message:</p><pre tabindex=0><code>2022-03-18T07:12:15.699431183Z [INFO] 10.96.144.227:52299 - 3686 &#34;A IN serverproxy.contoso.net.cluster.local. udp 52 false 512&#34; SERVFAIL qr,aa,rd 145 0.000091221s
</code></pre><p>First, get the current ClusterRole of <code>system:coredns</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe clusterrole system:coredns -n kube-system
</span></span></code></pre></div><p>Expected output:</p><pre tabindex=0><code>PolicyRule:
  Resources                        Non-Resource URLs  Resource Names  Verbs
  ---------                        -----------------  --------------  -----
  nodes                            []                 []              [get]
  endpoints                        []                 []              [list watch]
  namespaces                       []                 []              [list watch]
  pods                             []                 []              [list watch]
  services                         []                 []              [list watch]
  endpointslices.discovery.k8s.io  []                 []              [list watch]
</code></pre><p>If any permissions are missing, edit the ClusterRole to add them:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit clusterrole system:coredns -n kube-system
</span></span></code></pre></div><p>Example insertion of EndpointSlices permissions:</p><pre tabindex=0><code>...
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - list
  - watch
...
</code></pre><h3 id=are-you-in-the-right-namespace-for-the-service>Are you in the right namespace for the service?</h3><p>DNS queries that don't specify a namespace are limited to the pod's
namespace.</p><p>If the namespace of the pod and service differ, the DNS query must include
the namespace of the service.</p><p>This query is limited to the pod's namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t dnsutils -- nslookup &lt;service-name&gt;
</span></span></code></pre></div><p>This query specifies the namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t dnsutils -- nslookup &lt;service-name&gt;.&lt;namespace&gt;
</span></span></code></pre></div><p>To learn more about name resolution, see
<a href=/docs/concepts/services-networking/dns-pod-service/#what-things-get-dns-names>DNS for Services and Pods</a>.</p><h2 id=known-issues>Known issues</h2><p>Some Linux distributions (e.g. Ubuntu) use a local DNS resolver by default (systemd-resolved).
Systemd-resolved moves and replaces <code>/etc/resolv.conf</code> with a stub file that can cause a fatal forwarding
loop when resolving names in upstream servers. This can be fixed manually by using kubelet's <code>--resolv-conf</code> flag
to point to the correct <code>resolv.conf</code> (With <code>systemd-resolved</code>, this is <code>/run/systemd/resolve/resolv.conf</code>).
kubeadm automatically detects <code>systemd-resolved</code>, and adjusts the kubelet flags accordingly.</p><p>Kubernetes installs do not configure the nodes' <code>resolv.conf</code> files to use the
cluster DNS by default, because that process is inherently distribution-specific.
This should probably be implemented eventually.</p><p>Linux's libc (a.k.a. glibc) has a limit for the DNS <code>nameserver</code> records to 3 by default. What's more, for the glibc versions which are older than glibc-2.17-222 (<a href=https://access.redhat.com/solutions/58028>the new versions update see this issue</a>), the allowed number of DNS <code>search</code> records has been limited to 6 (<a href="https://bugzilla.redhat.com/show_bug.cgi?id=168253">see this bug from 2005</a>). Kubernetes needs to consume 1 <code>nameserver</code> record and 3 <code>search</code> records. This means that if a local installation already uses 3 <code>nameserver</code>s or uses more than 3 <code>search</code>es while your glibc version is in the affected list, some of those settings will be lost. To work around the DNS <code>nameserver</code> records limit, the node can run <code>dnsmasq</code>, which will provide more <code>nameserver</code> entries. You can also use kubelet's <code>--resolv-conf</code> flag. To fix the DNS <code>search</code> records limit, consider upgrading your linux distribution or upgrading to an unaffected version of glibc.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> With <a href=/docs/concepts/services-networking/dns-pod-service/#expanded-dns-configuration>Expanded DNS Configuration</a>,
Kubernetes allows more DNS <code>search</code> records.</div><p>If you are using Alpine version 3.3 or earlier as your base image, DNS may not
work properly due to a known issue with Alpine.
Kubernetes <a href=https://github.com/kubernetes/kubernetes/issues/30215>issue 30215</a>
details more information on this.</p><h2 id=what-s-next>What's next</h2><ul><li>See <a href=/docs/tasks/administer-cluster/dns-horizontal-autoscaling/>Autoscaling the DNS Service in a Cluster</a>.</li><li>Read <a href=/docs/concepts/services-networking/dns-pod-service/>DNS for Services and Pods</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a3790dfb57271d13517e549dffa805b9>2.17 - Declare Network Policy</h1><p>This document helps you get started using the Kubernetes <a href=/docs/concepts/services-networking/network-policies/>NetworkPolicy API</a> to declare network policies that govern how pods communicate with each other.</p><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.8.
To check the version, enter <code>kubectl version</code>.</p><p>Make sure you've configured a network provider with network policy support. There are a number of network providers that support NetworkPolicy, including:</p><ul><li><a href=/docs/tasks/administer-cluster/network-policy-provider/antrea-network-policy/>Antrea</a></li><li><a href=/docs/tasks/administer-cluster/network-policy-provider/calico-network-policy/>Calico</a></li><li><a href=/docs/tasks/administer-cluster/network-policy-provider/cilium-network-policy/>Cilium</a></li><li><a href=/docs/tasks/administer-cluster/network-policy-provider/kube-router-network-policy/>Kube-router</a></li><li><a href=/docs/tasks/administer-cluster/network-policy-provider/romana-network-policy/>Romana</a></li><li><a href=/docs/tasks/administer-cluster/network-policy-provider/weave-network-policy/>Weave Net</a></li></ul><h2 id=create-an-nginx-deployment-and-expose-it-via-a-service>Create an <code>nginx</code> deployment and expose it via a service</h2><p>To see how Kubernetes network policy works, start off by creating an <code>nginx</code> Deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl create deployment nginx --image=nginx
</span></span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>deployment.apps/nginx created
</code></pre><p>Expose the Deployment through a Service called <code>nginx</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl expose deployment nginx --port=80
</span></span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>service/nginx exposed
</code></pre><p>The above commands create a Deployment with an nginx Pod and expose the Deployment through a Service named <code>nginx</code>. The <code>nginx</code> Pod and Deployment are found in the <code>default</code> namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl get svc,pod
</span></span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME                        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
service/kubernetes          10.100.0.1    &lt;none&gt;        443/TCP    46m
service/nginx               10.100.0.16   &lt;none&gt;        80/TCP     33s

NAME                        READY         STATUS        RESTARTS   AGE
pod/nginx-701339712-e0qfq   1/1           Running       0          35s
</code></pre><h2 id=test-the-service-by-accessing-it-from-another-pod>Test the service by accessing it from another Pod</h2><p>You should be able to access the new <code>nginx</code> service from other Pods. To access the <code>nginx</code> Service from another Pod in the <code>default</code> namespace, start a busybox container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl run busybox --rm -ti --image=busybox:1.28 -- /bin/sh
</span></span></span></code></pre></div><p>In your shell, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget --spider --timeout<span style=color:#666>=</span><span style=color:#666>1</span> nginx
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Connecting to nginx (10.100.0.16:80)
remote file exists
</code></pre><h2 id=limit-access-to-the-nginx-service>Limit access to the <code>nginx</code> service</h2><p>To limit the access to the <code>nginx</code> service so that only Pods with the label <code>access: true</code> can query it, create a NetworkPolicy object as follows:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/nginx-policy.yaml download=service/networking/nginx-policy.yaml><code>service/networking/nginx-policy.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-networking-nginx-policy-yaml")' title="Copy service/networking/nginx-policy.yaml to clipboard"></img></div><div class=includecode id=service-networking-nginx-policy-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>networking.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>NetworkPolicy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>access-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ingress</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>from</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>podSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>access</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>The name of a NetworkPolicy object must be a valid
<a href=/docs/concepts/overview/working-with-objects/names#dns-subdomain-names>DNS subdomain name</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> NetworkPolicy includes a <code>podSelector</code> which selects the grouping of Pods to which the policy applies. You can see this policy selects Pods with the label <code>app=nginx</code>. The label was automatically added to the Pod in the <code>nginx</code> Deployment. An empty <code>podSelector</code> selects all pods in the namespace.</div><h2 id=assign-the-policy-to-the-service>Assign the policy to the service</h2><p>Use kubectl to create a NetworkPolicy from the above <code>nginx-policy.yaml</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl apply -f https://k8s.io/examples/service/networking/nginx-policy.yaml
</span></span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>networkpolicy.networking.k8s.io/access-nginx created
</code></pre><h2 id=test-access-to-the-service-when-access-label-is-not-defined>Test access to the service when access label is not defined</h2><p>When you attempt to access the <code>nginx</code> Service from a Pod without the correct labels, the request times out:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl run busybox --rm -ti --image=busybox:1.28 -- /bin/sh
</span></span></span></code></pre></div><p>In your shell, run the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget --spider --timeout<span style=color:#666>=</span><span style=color:#666>1</span> nginx
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Connecting to nginx (10.100.0.16:80)
wget: download timed out
</code></pre><h2 id=define-access-label-and-test-again>Define access label and test again</h2><p>You can create a Pod with the correct labels to see that the request is allowed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>kubectl run busybox --rm -ti --labels=&#34;access=true&#34; --image=busybox:1.28 -- /bin/sh
</span></span></span></code></pre></div><p>In your shell, run the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget --spider --timeout<span style=color:#666>=</span><span style=color:#666>1</span> nginx
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Connecting to nginx (10.100.0.16:80)
remote file exists
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-9585dc0efb0450fd68728e7511754717>2.18 - Developing Cloud Controller Manager</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.11 [beta]</code></div><p><p>The cloud-controller-manager is a Kubernetes <a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a> component
that embeds cloud-specific control logic. The cloud controller manager lets you link your
cluster into your cloud provider's API, and separates out the components that interact
with that cloud platform from components that only interact with your cluster.</p></p><p>By decoupling the interoperability logic between Kubernetes and the underlying cloud
infrastructure, the cloud-controller-manager component enables cloud providers to release
features at a different pace compared to the main Kubernetes project.</p><h2 id=background>Background</h2><p>Since cloud providers develop and release at a different pace compared to the Kubernetes project, abstracting the provider-specific code to the <code>cloud-controller-manager</code> binary allows cloud vendors to evolve independently from the core Kubernetes code.</p><p>The Kubernetes project provides skeleton cloud-controller-manager code with Go interfaces to allow you (or your cloud provider) to plug in your own implementations. This means that a cloud provider can implement a cloud-controller-manager by importing packages from Kubernetes core; each cloudprovider will register their own code by calling <code>cloudprovider.RegisterCloudProvider</code> to update a global variable of available cloud providers.</p><h2 id=developing>Developing</h2><h3 id=out-of-tree>Out of tree</h3><p>To build an out-of-tree cloud-controller-manager for your cloud:</p><ol><li>Create a go package with an implementation that satisfies <a href=https://github.com/kubernetes/cloud-provider/blob/master/cloud.go>cloudprovider.Interface</a>.</li><li>Use <a href=https://github.com/kubernetes/kubernetes/blob/master/cmd/cloud-controller-manager/main.go><code>main.go</code> in cloud-controller-manager</a> from Kubernetes core as a template for your <code>main.go</code>. As mentioned above, the only difference should be the cloud package that will be imported.</li><li>Import your cloud package in <code>main.go</code>, ensure your package has an <code>init</code> block to run <a href=https://github.com/kubernetes/cloud-provider/blob/master/plugins.go><code>cloudprovider.RegisterCloudProvider</code></a>.</li></ol><p>Many cloud providers publish their controller manager code as open source. If you are creating
a new cloud-controller-manager from scratch, you could take an existing out-of-tree cloud
controller manager as your starting point.</p><h3 id=in-tree>In tree</h3><p>For in-tree cloud providers, you can run the in-tree cloud controller manager as a <a class=glossary-tooltip title='Ensures a copy of a Pod is running across a set of nodes in a cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/daemonset target=_blank aria-label=DaemonSet>DaemonSet</a> in your cluster. See <a href=/docs/tasks/administer-cluster/running-cloud-controller/>Cloud Controller Manager Administration</a> for more details.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-09cc2cf3e0f23a3996e6cb31dc4d867c>2.19 - Enable Or Disable A Kubernetes API</h1><p>This page shows how to enable or disable an API version from your cluster's
<a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a>.</p><p>Specific API versions can be turned on or off by passing <code>--runtime-config=api/&lt;version></code> as a
command line argument to the API server. The values for this argument are a comma-separated
list of API versions. Later values override earlier values.</p><p>The <code>runtime-config</code> command line argument also supports 2 special keys:</p><ul><li><code>api/all</code>, representing all known APIs</li><li><code>api/legacy</code>, representing only legacy APIs. Legacy APIs are any APIs that have been
explicitly <a href=/docs/reference/using-api/deprecation-policy/>deprecated</a>.</li></ul><p>For example, to turning off all API versions except v1, pass <code>--runtime-config=api/all=false,api/v1=true</code>
to the <code>kube-apiserver</code>.</p><h2 id=what-s-next>What's next</h2><p>Read the <a href=/docs/reference/command-line-tools-reference/kube-apiserver/>full documentation</a>
for the <code>kube-apiserver</code> component.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6b4e7ca6586f448c8533a120c29bdd25>2.20 - Encrypting Secret Data at Rest</h1><p>This page shows how to enable and configure encryption of secret data at rest.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.13.
To check the version, enter <code>kubectl version</code>.</p></li><li><p>etcd v3.0 or later is required</p></li></ul><h2 id=configuration-and-determining-whether-encryption-at-rest-is-already-enabled>Configuration and determining whether encryption at rest is already enabled</h2><p>The <code>kube-apiserver</code> process accepts an argument <code>--encryption-provider-config</code>
that controls how API data is encrypted in etcd.
The configuration is provided as an API named
<a href=/docs/reference/config-api/apiserver-encryption.v1/><code>EncryptionConfiguration</code></a>.
An example configuration is provided below.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> <strong>IMPORTANT:</strong> For high-availability configurations (with two or more control plane nodes), the
encryption configuration file must be the same! Otherwise, the <code>kube-apiserver</code> component cannot
decrypt data stored in the etcd.</div><h2 id=understanding-the-encryption-at-rest-configuration>Understanding the encryption at rest configuration.</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EncryptionConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- secrets<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>providers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>identity</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>aesgcm</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>keys</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>key1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb> </span>c2VjcmV0IGlzIHNlY3VyZQ==<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>key2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb> </span>dGhpcyBpcyBwYXNzd29yZA==<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>aescbc</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>keys</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>key1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb> </span>c2VjcmV0IGlzIHNlY3VyZQ==<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>key2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb> </span>dGhpcyBpcyBwYXNzd29yZA==<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>secretbox</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>keys</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>key1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb> </span>YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXoxMjM0NTY=<span style=color:#bbb>
</span></span></span></code></pre></div><p>Each <code>resources</code> array item is a separate config and contains a complete configuration. The
<code>resources.resources</code> field is an array of Kubernetes resource names (<code>resource</code> or <code>resource.group</code>)
that should be encrypted. The <code>providers</code> array is an ordered list of the possible encryption
providers.</p><p>Only one provider type may be specified per entry (<code>identity</code> or <code>aescbc</code> may be provided,
but not both in the same item).
The first provider in the list is used to encrypt resources written into the storage. When reading
resources from storage, each provider that matches the stored data attempts in order to decrypt the
data. If no provider can read the stored data due to a mismatch in format or secret key, an error
is returned which prevents clients from accessing that resource.</p><p>For more detailed information about the <code>EncryptionConfiguration</code> struct, please refer to the
<a href=/docs/reference/config-api/apiserver-encryption.v1/>encryption configuration API</a>.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> If any resource is not readable via the encryption config (because keys were changed),
the only recourse is to delete that key from the underlying etcd directly. Calls that attempt to
read that resource will fail until it is deleted or a valid decryption key is provided.</div><h3 id=providers>Providers:</h3><table><caption style=display:none>Providers for Kubernetes encryption at rest</caption><thead><tr><th>Name</th><th>Encryption</th><th>Strength</th><th>Speed</th><th>Key Length</th><th>Other Considerations</th></tr></thead><tbody><tr><td><code>identity</code></td><td>None</td><td>N/A</td><td>N/A</td><td>N/A</td><td>Resources written as-is without encryption. When set as the first provider, the resource will be decrypted as new values are written.</td></tr><tr><td><code>secretbox</code></td><td>XSalsa20 and Poly1305</td><td>Strong</td><td>Faster</td><td>32-byte</td><td>A newer standard and may not be considered acceptable in environments that require high levels of review.</td></tr><tr><td><code>aesgcm</code></td><td>AES-GCM with random nonce</td><td>Must be rotated every 200k writes</td><td>Fastest</td><td>16, 24, or 32-byte</td><td>Is not recommended for use except when an automated key rotation scheme is implemented.</td></tr><tr><td><code>aescbc</code></td><td>AES-CBC with <a href=https://datatracker.ietf.org/doc/html/rfc2315>PKCS#7</a> padding</td><td>Weak</td><td>Fast</td><td>32-byte</td><td>Not recommended due to CBC's vulnerability to padding oracle attacks.</td></tr><tr><td><code>kms</code></td><td>Uses envelope encryption scheme: Data is encrypted by data encryption keys (DEKs) using AES-CBC with <a href=https://datatracker.ietf.org/doc/html/rfc2315>PKCS#7</a> padding (prior to v1.25), using AES-GCM starting from v1.25, DEKs are encrypted by key encryption keys (KEKs) according to configuration in Key Management Service (KMS)</td><td>Strongest</td><td>Fast</td><td>32-bytes</td><td>The recommended choice for using a third party tool for key management. Simplifies key rotation, with a new DEK generated for each encryption, and KEK rotation controlled by the user. <a href=/docs/tasks/administer-cluster/kms-provider/>Configure the KMS provider</a></td></tr></tbody></table><p>Each provider supports multiple keys - the keys are tried in order for decryption, and if the provider
is the first provider, the first key is used for encryption.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Storing the raw encryption key in the EncryptionConfig only moderately improves your security
posture, compared to no encryption. Please use <code>kms</code> provider for additional security.</div><p>By default, the <code>identity</code> provider is used to protect Secrets in etcd, which provides no
encryption. <code>EncryptionConfiguration</code> was introduced to encrypt Secrets locally, with a locally
managed key.</p><p>Encrypting Secrets with a locally managed key protects against an etcd compromise, but it fails to
protect against a host compromise. Since the encryption keys are stored on the host in the
EncryptionConfiguration YAML file, a skilled attacker can access that file and extract the encryption
keys.</p><p>Envelope encryption creates dependence on a separate key, not stored in Kubernetes. In this case,
an attacker would need to compromise etcd, the <code>kubeapi-server</code>, and the third-party KMS provider to
retrieve the plaintext values, providing a higher level of security than locally stored encryption keys.</p><h2 id=encrypting-your-data>Encrypting your data</h2><p>Create a new encryption config file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EncryptionConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- secrets<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>providers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>aescbc</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>keys</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>key1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb> </span>&lt;BASE 64 ENCODED SECRET&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>identity</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span></code></pre></div><p>To create a new Secret, perform the following steps:</p><ol><li><p>Generate a 32-byte random key and base64 encode it. If you're on Linux or macOS, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>head -c <span style=color:#666>32</span> /dev/urandom | base64
</span></span></code></pre></div></li><li><p>Place that value in the <code>secret</code> field of the <code>EncryptionConfiguration</code> struct.</p></li><li><p>Set the <code>--encryption-provider-config</code> flag on the <code>kube-apiserver</code> to point to
the location of the config file.</p><p>You will need to mount the new encryption config file to the <code>kube-apiserver</code> static pod. Here is an example on how to do that:</p><ol><li>Save the new encryption config file to <code>/etc/kubernetes/enc/enc.yaml</code> on the control-plane node.</li><li>Edit the manifest for the <code>kube-apiserver</code> static pod: <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> similarly to this:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint</span>:<span style=color:#bbb> </span><span style=color:#666>10.10.30.4</span>:<span style=color:#666>6443</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>kube-apiserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-apiserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- kube-apiserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- --encryption-provider-config=/etc/kubernetes/enc/enc.yaml <span style=color:#bbb> </span><span style=color:#080;font-style:italic># &lt;-- add this line</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>enc                          <span style=color:#bbb> </span><span style=color:#080;font-style:italic># &lt;-- add this line</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/enc     <span style=color:#bbb> </span><span style=color:#080;font-style:italic># &lt;-- add this line</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readonly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>                      </span><span style=color:#080;font-style:italic># &lt;-- add this line</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>enc                            <span style=color:#bbb> </span><span style=color:#080;font-style:italic># &lt;-- add this line</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>                             </span><span style=color:#080;font-style:italic># &lt;-- add this line</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/enc          <span style=color:#bbb> </span><span style=color:#080;font-style:italic># &lt;-- add this line</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DirectoryOrCreate            <span style=color:#bbb> </span><span style=color:#080;font-style:italic># &lt;-- add this line</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Restart your API server.</p></li></ol><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Your config file contains keys that can decrypt the contents in etcd, so you must properly restrict
permissions on your control-plane nodes so only the user who runs the <code>kube-apiserver</code> can read it.</div><h2 id=verifying-that-data-is-encrypted>Verifying that data is encrypted</h2><p>Data is encrypted when written to etcd. After restarting your <code>kube-apiserver</code>, any newly created or
updated Secret should be encrypted when stored. To check this, you can use the <code>etcdctl</code> command line
program to retrieve the contents of your Secret.</p><ol><li><p>Create a new Secret called <code>secret1</code> in the <code>default</code> namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic secret1 -n default --from-literal<span style=color:#666>=</span><span style=color:#b8860b>mykey</span><span style=color:#666>=</span>mydata
</span></span></code></pre></div></li><li><p>Using the <code>etcdctl</code> command line, read that Secret out of etcd:</p><p><code>ETCDCTL_API=3 etcdctl get /registry/secrets/default/secret1 [...] | hexdump -C</code></p><p>where <code>[...]</code> must be the additional arguments for connecting to the etcd server.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span> etcdctl <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>   --cacert<span style=color:#666>=</span>/etc/kubernetes/pki/etcd/ca.crt   <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>   --cert<span style=color:#666>=</span>/etc/kubernetes/pki/etcd/server.crt <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>   --key<span style=color:#666>=</span>/etc/kubernetes/pki/etcd/server.key  <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>   get /registry/secrets/default/secret1 | hexdump -C
</span></span></code></pre></div><p>The output is similar to this (abbreviated):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hexdump data-lang=hexdump><span style=display:flex><span><span style=color:#a0a000>00000000</span>  <span style=color:#666>2f</span> <span style=color:#666>72</span> <span style=color:#666>65</span> <span style=color:#666>67</span> <span style=color:#666>69</span> <span style=color:#666>73</span> <span style=color:#666>74</span> <span style=color:#666>72</span>  <span style=color:#666>79</span> <span style=color:#666>2f</span> <span style=color:#666>73</span> <span style=color:#666>65</span> <span style=color:#666>63</span> <span style=color:#666>72</span> <span style=color:#666>65</span> <span style=color:#666>74</span>  |<span style=color:#b44>/registry/secret</span>|
</span></span><span style=display:flex><span><span style=color:#a0a000>00000010</span>  <span style=color:#666>73</span> <span style=color:#666>2f</span> <span style=color:#666>64</span> <span style=color:#666>65</span> <span style=color:#666>66</span> <span style=color:#666>61</span> <span style=color:#666>75</span> <span style=color:#666>6c</span>  <span style=color:#666>74</span> <span style=color:#666>2f</span> <span style=color:#666>73</span> <span style=color:#666>65</span> <span style=color:#666>63</span> <span style=color:#666>72</span> <span style=color:#666>65</span> <span style=color:#666>74</span>  |<span style=color:#b44>s/default/secret</span>|
</span></span><span style=display:flex><span><span style=color:#a0a000>00000020</span>  <span style=color:#666>31</span> <span style=color:#666>0a</span> <span style=color:#666>6b</span> <span style=color:#666>38</span> <span style=color:#666>73</span> <span style=color:#666>3a</span> <span style=color:#666>65</span> <span style=color:#666>6e</span>  <span style=color:#666>63</span> <span style=color:#666>3a</span> <span style=color:#666>61</span> <span style=color:#666>65</span> <span style=color:#666>73</span> <span style=color:#666>63</span> <span style=color:#666>62</span> <span style=color:#666>63</span>  |<span style=color:#b44>1.k8s:enc:aescbc</span>|
</span></span><span style=display:flex><span><span style=color:#a0a000>00000030</span>  <span style=color:#666>3a</span> <span style=color:#666>76</span> <span style=color:#666>31</span> <span style=color:#666>3a</span> <span style=color:#666>6b</span> <span style=color:#666>65</span> <span style=color:#666>79</span> <span style=color:#666>31</span>  <span style=color:#666>3a</span> <span style=color:#666>c7</span> <span style=color:#666>6c</span> <span style=color:#666>e7</span> <span style=color:#666>d3</span> <span style=color:#666>09</span> <span style=color:#666>bc</span> <span style=color:#666>06</span>  |<span style=color:#b44>:v1:key1:.l.....</span>|
</span></span><span style=display:flex><span><span style=color:#a0a000>00000040</span>  <span style=color:#666>25</span> <span style=color:#666>51</span> <span style=color:#666>91</span> <span style=color:#666>e4</span> <span style=color:#666>e0</span> <span style=color:#666>6c</span> <span style=color:#666>e5</span> <span style=color:#666>b1</span>  <span style=color:#666>4d</span> <span style=color:#666>7a</span> <span style=color:#666>8b</span> <span style=color:#666>3d</span> <span style=color:#666>b9</span> <span style=color:#666>c2</span> <span style=color:#666>7c</span> <span style=color:#666>6e</span>  |<span style=color:#b44>%Q...l..Mz.=..|n</span>|
</span></span><span style=display:flex><span><span style=color:#a0a000>00000050</span>  <span style=color:#666>b4</span> <span style=color:#666>79</span> <span style=color:#666>df</span> <span style=color:#666>05</span> <span style=color:#666>28</span> <span style=color:#666>ae</span> <span style=color:#666>0d</span> <span style=color:#666>8e</span>  <span style=color:#666>5f</span> <span style=color:#666>35</span> <span style=color:#666>13</span> <span style=color:#666>2c</span> <span style=color:#666>c0</span> <span style=color:#666>18</span> <span style=color:#666>99</span> <span style=color:#666>3e</span>  |<span style=color:#b44>.y..(..._5.,...&gt;</span>|
</span></span><span style=display:flex><span><span>[...]</span>
</span></span><span style=display:flex><span><span style=color:#a0a000>00000110</span>  <span style=color:#666>23</span> <span style=color:#666>3a</span> <span style=color:#666>0d</span> <span style=color:#666>fc</span> <span style=color:#666>28</span> <span style=color:#666>ca</span> <span style=color:#666>48</span> <span style=color:#666>2d</span>  <span style=color:#666>6b</span> <span style=color:#666>2d</span> <span style=color:#666>46</span> <span style=color:#666>cc</span> <span style=color:#666>72</span> <span style=color:#666>0b</span> <span style=color:#666>70</span> <span style=color:#666>4c</span>  |<span style=color:#b44>#:..(.H-k-F.r.pL</span>|
</span></span><span style=display:flex><span><span style=color:#a0a000>00000120</span>  <span style=color:#666>a5</span> <span style=color:#666>fc</span> <span style=color:#666>35</span> <span style=color:#666>43</span> <span style=color:#666>12</span> <span style=color:#666>4e</span> <span style=color:#666>60</span> <span style=color:#666>ef</span>  <span style=color:#666>bf</span> <span style=color:#666>6f</span> <span style=color:#666>fe</span> <span style=color:#666>cf</span> <span style=color:#666>df</span> <span style=color:#666>0b</span> <span style=color:#666>ad</span> <span style=color:#666>1f</span>  |<span style=color:#b44>..5C.N`..o......</span>|
</span></span><span style=display:flex><span><span style=color:#a0a000>00000130</span>  <span style=color:#666>82</span> <span style=color:#666>c4</span> <span style=color:#666>88</span> <span style=color:#666>53</span> <span style=color:#666>02</span> <span style=color:#666>da</span> <span style=color:#666>3e</span> <span style=color:#666>66</span>  <span style=color:#666>ff</span> <span style=color:#666>0a</span>                    |<span style=color:#b44>...S..&gt;f..</span>|
</span></span><span style=display:flex><span><span style=color:#a0a000>0000013a</span>
</span></span></code></pre></div></li><li><p>Verify the stored Secret is prefixed with <code>k8s:enc:aescbc:v1:</code> which indicates
the <code>aescbc</code> provider has encrypted the resulting data. Confirm that the key name shown in <code>etcd</code>
matches the key name specified in the <code>EncryptionConfiguration</code> mentioned above. In this example,
you can see that the encryption key named <code>key1</code> is used in <code>etcd</code> and in <code>EncryptionConfiguration</code>.</p></li><li><p>Verify the Secret is correctly decrypted when retrieved via the API:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret secret1 -n default -o yaml
</span></span></code></pre></div><p>The output should contain <code>mykey: bXlkYXRh</code>, with contents of <code>mydata</code> encoded, check
<a href=/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret>decoding a Secret</a>
to completely decode the Secret.</p></li></ol><h2 id=ensure-all-secrets-are-encrypted>Ensure all Secrets are encrypted</h2><p>Since Secrets are encrypted on write, performing an update on a Secret will encrypt that content.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secrets --all-namespaces -o json | kubectl replace -f -
</span></span></code></pre></div><p>The command above reads all Secrets and then updates them to apply server side encryption.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If an error occurs due to a conflicting write, retry the command.
For larger clusters, you may wish to subdivide the secrets by namespace or script an update.</div><h2 id=rotating-a-decryption-key>Rotating a decryption key</h2><p>Changing a Secret without incurring downtime requires a multi-step operation, especially in
the presence of a highly-available deployment where multiple <code>kube-apiserver</code> processes are running.</p><ol><li>Generate a new key and add it as the second key entry for the current provider on all servers</li><li>Restart all <code>kube-apiserver</code> processes to ensure each server can decrypt using the new key</li><li>Make the new key the first entry in the <code>keys</code> array so that it is used for encryption in the config</li><li>Restart all <code>kube-apiserver</code> processes to ensure each server now encrypts using the new key</li><li>Run <code>kubectl get secrets --all-namespaces -o json | kubectl replace -f -</code> to encrypt all
existing Secrets with the new key</li><li>Remove the old decryption key from the config after you have backed up etcd with the new key in use
and updated all Secrets</li></ol><p>When running a single <code>kube-apiserver</code> instance, step 2 may be skipped.</p><h2 id=decrypting-all-data>Decrypting all data</h2><p>To disable encryption at rest, place the <code>identity</code> provider as the first entry in the config
and restart all <code>kube-apiserver</code> processes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EncryptionConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- secrets<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>providers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>identity</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>aescbc</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>keys</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>key1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb> </span>&lt;BASE 64 ENCODED SECRET&gt;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Then run the following command to force decrypt
all Secrets:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secrets --all-namespaces -o json | kubectl replace -f -
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Learn more about the <a href=/docs/reference/config-api/apiserver-encryption.v1/>EncryptionConfiguration configuration API (v1)</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4a02bcca41439e16655f43fa37c81da4>2.21 - Guaranteed Scheduling For Critical Add-On Pods</h1><p>Kubernetes core components such as the API server, scheduler, and controller-manager run on a control plane node. However, add-ons must run on a regular cluster node.
Some of these add-ons are critical to a fully functional cluster, such as metrics-server, DNS, and UI.
A cluster may stop working properly if a critical add-on is evicted (either manually or as a side effect of another operation like upgrade)
and becomes pending (for example when the cluster is highly utilized and either there are other pending pods that schedule into the space
vacated by the evicted critical add-on pod or the amount of resources available on the node changed for some other reason).</p><p>Note that marking a pod as critical is not meant to prevent evictions entirely; it only prevents the pod from becoming permanently unavailable.
A static pod marked as critical, can't be evicted. However, a non-static pods marked as critical are always rescheduled.</p><h3 id=marking-pod-as-critical>Marking pod as critical</h3><p>To mark a Pod as critical, set priorityClassName for that Pod to <code>system-cluster-critical</code> or <code>system-node-critical</code>. <code>system-node-critical</code> is the highest available priority, even higher than <code>system-cluster-critical</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b45f024608e1b367cdacb1fd9d77278a>2.22 - IP Masquerade Agent User Guide</h1><p>This page shows how to configure and enable the <code>ip-masq-agent</code>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=ip-masquerade-agent-user-guide>IP Masquerade Agent User Guide</h2><p>The <code>ip-masq-agent</code> configures iptables rules to hide a pod's IP address behind the cluster node's IP address. This is typically done when sending traffic to destinations outside the cluster's pod <a href=https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing>CIDR</a> range.</p><h3 id=key-terms><strong>Key Terms</strong></h3><ul><li><strong>NAT (Network Address Translation)</strong>
Is a method of remapping one IP address to another by modifying either the source and/or destination address information in the IP header. Typically performed by a device doing IP routing.</li><li><strong>Masquerading</strong>
A form of NAT that is typically used to perform a many to one address translation, where multiple source IP addresses are masked behind a single address, which is typically the device doing the IP routing. In Kubernetes this is the Node's IP address.</li><li><strong>CIDR (Classless Inter-Domain Routing)</strong>
Based on the variable-length subnet masking, allows specifying arbitrary-length prefixes. CIDR introduced a new method of representation for IP addresses, now commonly known as <strong>CIDR notation</strong>, in which an address or routing prefix is written with a suffix indicating the number of bits of the prefix, such as 192.168.2.0/24.</li><li><strong>Link Local</strong>
A link-local address is a network address that is valid only for communications within the network segment or the broadcast domain that the host is connected to. Link-local addresses for IPv4 are defined in the address block 169.254.0.0/16 in CIDR notation.</li></ul><p>The ip-masq-agent configures iptables rules to handle masquerading node/pod IP addresses when sending traffic to destinations outside the cluster node's IP and the Cluster IP range. This essentially hides pod IP addresses behind the cluster node's IP address. In some environments, traffic to "external" addresses must come from a known machine address. For example, in Google Cloud, any traffic to the internet must come from a VM's IP. When containers are used, as in Google Kubernetes Engine, the Pod IP will be rejected for egress. To avoid this, we must hide the Pod IP behind the VM's own IP address - generally known as "masquerade". By default, the agent is configured to treat the three private IP ranges specified by <a href=https://tools.ietf.org/html/rfc1918>RFC 1918</a> as non-masquerade <a href=https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing>CIDR</a>. These ranges are 10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16. The agent will also treat link-local (169.254.0.0/16) as a non-masquerade CIDR by default. The agent is configured to reload its configuration from the location <em>/etc/config/ip-masq-agent</em> every 60 seconds, which is also configurable.</p><p><img src=/images/docs/ip-masq.png alt="masq/non-masq example"></p><p>The agent configuration file must be written in YAML or JSON syntax, and may contain three optional keys:</p><ul><li><code>nonMasqueradeCIDRs</code>: A list of strings in
<a href=https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing>CIDR</a> notation that specify the non-masquerade ranges.</li><li><code>masqLinkLocal</code>: A Boolean (true/false) which indicates whether to masquerade traffic to the
link local prefix <code>169.254.0.0/16</code>. False by default.</li><li><code>resyncInterval</code>: A time interval at which the agent attempts to reload config from disk.
For example: '30s', where 's' means seconds, 'ms' means milliseconds.</li></ul><p>Traffic to 10.0.0.0/8, 172.16.0.0/12 and 192.168.0.0/16) ranges will NOT be masqueraded. Any other traffic (assumed to be internet) will be masqueraded. An example of a local destination from a pod could be its Node's IP address as well as another node's address or one of the IP addresses in Cluster's IP range. Any other traffic will be masqueraded by default. The below entries show the default set of rules that are applied by the ip-masq-agent:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>iptables -t nat -L IP-MASQ-AGENT
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>RETURN     all  --  anywhere             169.254.0.0/16       /* ip-masq-agent: cluster-local traffic should not be subject to MASQUERADE */ ADDRTYPE match dst-type !LOCAL
RETURN     all  --  anywhere             10.0.0.0/8           /* ip-masq-agent: cluster-local traffic should not be subject to MASQUERADE */ ADDRTYPE match dst-type !LOCAL
RETURN     all  --  anywhere             172.16.0.0/12        /* ip-masq-agent: cluster-local traffic should not be subject to MASQUERADE */ ADDRTYPE match dst-type !LOCAL
RETURN     all  --  anywhere             192.168.0.0/16       /* ip-masq-agent: cluster-local traffic should not be subject to MASQUERADE */ ADDRTYPE match dst-type !LOCAL
MASQUERADE  all  --  anywhere             anywhere             /* ip-masq-agent: outbound traffic should be subject to MASQUERADE (this match must come after cluster-local CIDR matches) */ ADDRTYPE match dst-type !LOCAL
</code></pre><p>By default, in GCE/Google Kubernetes Engine, if network policy is enabled or
you are using a cluster CIDR not in the 10.0.0.0/8 range, the <code>ip-masq-agent</code>
will run in your cluster. If you are running in another environment,
you can add the <code>ip-masq-agent</code> <a href=/docs/concepts/workloads/controllers/daemonset/>DaemonSet</a>
to your cluster.</p><h2 id=create-an-ip-masq-agent>Create an ip-masq-agent</h2><p>To create an ip-masq-agent, run the following kubectl command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/ip-masq-agent/master/ip-masq-agent.yaml
</span></span></code></pre></div><p>You must also apply the appropriate node label to any nodes in your cluster that you want the agent to run on.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label nodes my-node node.kubernetes.io/masq-agent-ds-ready<span style=color:#666>=</span><span style=color:#a2f>true</span>
</span></span></code></pre></div><p>More information can be found in the ip-masq-agent documentation <a href=https://github.com/kubernetes-sigs/ip-masq-agent>here</a></p><p>In most cases, the default set of rules should be sufficient; however, if this is not the case for your cluster, you can create and apply a <a href=/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMap</a> to customize the IP ranges that are affected. For example, to allow only 10.0.0.0/8 to be considered by the ip-masq-agent, you can create the following <a href=/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMap</a> in a file called "config".</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>It is important that the file is called config since, by default, that will be used as the key for lookup by the <code>ip-masq-agent</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>nonMasqueradeCIDRs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:#666>10.0.0.0</span>/8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resyncInterval</span>:<span style=color:#bbb> </span>60s<span style=color:#bbb>
</span></span></span></code></pre></div></div><p>Run the following command to add the config map to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap ip-masq-agent --from-file<span style=color:#666>=</span>config --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><p>This will update a file located at <code>/etc/config/ip-masq-agent</code> which is periodically checked every <code>resyncInterval</code> and applied to the cluster node.
After the resync interval has expired, you should see the iptables rules reflect your changes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>iptables -t nat -L IP-MASQ-AGENT
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Chain IP-MASQ-AGENT (1 references)
target     prot opt source               destination
RETURN     all  --  anywhere             169.254.0.0/16       /* ip-masq-agent: cluster-local traffic should not be subject to MASQUERADE */ ADDRTYPE match dst-type !LOCAL
RETURN     all  --  anywhere             10.0.0.0/8           /* ip-masq-agent: cluster-local
MASQUERADE  all  --  anywhere             anywhere             /* ip-masq-agent: outbound traffic should be subject to MASQUERADE (this match must come after cluster-local CIDR matches) */ ADDRTYPE match dst-type !LOCAL
</code></pre><p>By default, the link local range (169.254.0.0/16) is also handled by the ip-masq agent, which sets up the appropriate iptables rules. To have the ip-masq-agent ignore link local, you can set <code>masqLinkLocal</code> to true in the ConfigMap.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>nonMasqueradeCIDRs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:#666>10.0.0.0</span>/8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resyncInterval</span>:<span style=color:#bbb> </span>60s<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>masqLinkLocal</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a02f35804917d7a269c38d7e2c475005>2.23 - Limit Storage Consumption</h1><p>This example demonstrates how to limit the amount of storage consumed in a namespace.</p><p>The following resources are used in the demonstration: <a href=/docs/concepts/policy/resource-quotas/>ResourceQuota</a>,
<a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>LimitRange</a>,
and <a href=/docs/concepts/storage/persistent-volumes/>PersistentVolumeClaim</a>.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</li></ul><h2 id=scenario-limiting-storage-consumption>Scenario: Limiting Storage Consumption</h2><p>The cluster-admin is operating a cluster on behalf of a user population and the admin wants to control
how much storage a single namespace can consume in order to control cost.</p><p>The admin would like to limit:</p><ol><li>The number of persistent volume claims in a namespace</li><li>The amount of storage each claim can request</li><li>The amount of cumulative storage the namespace can have</li></ol><h2 id=limitrange-to-limit-requests-for-storage>LimitRange to limit requests for storage</h2><p>Adding a <code>LimitRange</code> to a namespace enforces storage request sizes to a minimum and maximum. Storage is requested
via <code>PersistentVolumeClaim</code>. The admission controller that enforces limit ranges will reject any PVC that is above or below
the values set by the admin.</p><p>In this example, a PVC requesting 10Gi of storage would be rejected because it exceeds the 2Gi max.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LimitRange<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>storagelimits<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>PersistentVolumeClaim<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>max</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>2Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>min</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>1Gi<span style=color:#bbb>
</span></span></span></code></pre></div><p>Minimum storage requests are used when the underlying storage provider requires certain minimums. For example,
AWS EBS volumes have a 1Gi minimum requirement.</p><h2 id=storagequota-to-limit-pvc-count-and-cumulative-storage-capacity>StorageQuota to limit PVC count and cumulative storage capacity</h2><p>Admins can limit the number of PVCs in a namespace as well as the cumulative capacity of those PVCs. New PVCs that exceed
either maximum value will be rejected.</p><p>In this example, a 6th PVC in the namespace would be rejected because it exceeds the maximum count of 5. Alternatively,
a 5Gi maximum quota when combined with the 2Gi max limit above, cannot have 3 PVCs where each has 2Gi. That would be 6Gi requested
for a namespace capped at 5Gi.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ResourceQuota<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>storagequota<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hard</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>persistentvolumeclaims</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>requests.storage</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;5Gi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=summary>Summary</h2><p>A limit range can put a ceiling on how much storage is requested while a resource quota can effectively cap the storage
consumed by a namespace through claim counts and cumulative storage capacity. The allows a cluster-admin to plan their
cluster's storage budget without risk of any one project going over their allotment.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a24171610b6ea75a142cb9c8c7882390>2.24 - Migrate Replicated Control Plane To Use Cloud Controller Manager</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.24 [stable]</code></div><p><p>The cloud-controller-manager is a Kubernetes <a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a> component
that embeds cloud-specific control logic. The cloud controller manager lets you link your
cluster into your cloud provider's API, and separates out the components that interact
with that cloud platform from components that only interact with your cluster.</p></p><p>By decoupling the interoperability logic between Kubernetes and the underlying cloud
infrastructure, the cloud-controller-manager component enables cloud providers to release
features at a different pace compared to the main Kubernetes project.</p><h2 id=background>Background</h2><p>As part of the <a href=/blog/2019/04/17/the-future-of-cloud-providers-in-kubernetes/>cloud provider extraction effort</a>, all cloud specific controllers must be moved out of the <code>kube-controller-manager</code>. All existing clusters that run cloud controllers in the <code>kube-controller-manager</code> must migrate to instead run the controllers in a cloud provider specific <code>cloud-controller-manager</code>.</p><p>Leader Migration provides a mechanism in which HA clusters can safely migrate "cloud specific" controllers between the <code>kube-controller-manager</code> and the <code>cloud-controller-manager</code> via a shared resource lock between the two components while upgrading the replicated control plane. For a single-node control plane, or if unavailability of controller managers can be tolerated during the upgrade, Leader Migration is not needed and this guide can be ignored.</p><p>Leader Migration can be enabled by setting <code>--enable-leader-migration</code> on <code>kube-controller-manager</code> or <code>cloud-controller-manager</code>. Leader Migration only applies during the upgrade and can be safely disabled or left enabled after the upgrade is complete.</p><p>This guide walks you through the manual process of upgrading the control plane from <code>kube-controller-manager</code> with built-in cloud provider to running both <code>kube-controller-manager</code> and <code>cloud-controller-manager</code>. If you use a tool to deploy and manage the cluster, please refer to the documentation of the tool and the cloud provider for specific instructions of the migration.</p><h2 id=before-you-begin>Before you begin</h2><p>It is assumed that the control plane is running Kubernetes version N and to be upgraded to version N + 1. Although it is possible to migrate within the same version, ideally the migration should be performed as part of an upgrade so that changes of configuration can be aligned to each release. The exact versions of N and N + 1 depend on each cloud provider. For example, if a cloud provider builds a <code>cloud-controller-manager</code> to work with Kubernetes 1.24, then N can be 1.23 and N + 1 can be 1.24.</p><p>The control plane nodes should run <code>kube-controller-manager</code> with Leader Election enabled, which is the default. As of version N, an in-tree cloud provider must be set with <code>--cloud-provider</code> flag and <code>cloud-controller-manager</code> should not yet be deployed.</p><p>The out-of-tree cloud provider must have built a <code>cloud-controller-manager</code> with Leader Migration implementation. If the cloud provider imports <code>k8s.io/cloud-provider</code> and <code>k8s.io/controller-manager</code> of version v0.21.0 or later, Leader Migration will be available. However, for version before v0.22.0, Leader Migration is alpha and requires feature gate <code>ControllerManagerLeaderMigration</code> to be enabled in <code>cloud-controller-manager</code>.</p><p>This guide assumes that kubelet of each control plane node starts <code>kube-controller-manager</code> and <code>cloud-controller-manager</code> as static pods defined by their manifests. If the components run in a different setting, please adjust the steps accordingly.</p><p>For authorization, this guide assumes that the cluster uses RBAC. If another authorization mode grants permissions to <code>kube-controller-manager</code> and <code>cloud-controller-manager</code> components, please grant the needed access in a way that matches the mode.</p><h3 id=grant-access-to-migration-lease>Grant access to Migration Lease</h3><p>The default permissions of the controller manager allow only accesses to their main Lease. In order for the migration to work, accesses to another Lease are required.</p><p>You can grant <code>kube-controller-manager</code> full access to the leases API by modifying the <code>system::leader-locking-kube-controller-manager</code> role. This task guide assumes that the name of the migration lease is <code>cloud-provider-extraction-migration</code>.</p><p><code>kubectl patch -n kube-system role 'system::leader-locking-kube-controller-manager' -p '{"rules": [ {"apiGroups":[ "coordination.k8s.io"], "resources": ["leases"], "resourceNames": ["cloud-provider-extraction-migration"], "verbs": ["create", "list", "get", "update"] } ]}' --type=merge</code></p><p>Do the same to the <code>system::leader-locking-cloud-controller-manager</code> role.</p><p><code>kubectl patch -n kube-system role 'system::leader-locking-cloud-controller-manager' -p '{"rules": [ {"apiGroups":[ "coordination.k8s.io"], "resources": ["leases"], "resourceNames": ["cloud-provider-extraction-migration"], "verbs": ["create", "list", "get", "update"] } ]}' --type=merge</code></p><h3 id=initial-leader-migration-configuration>Initial Leader Migration configuration</h3><p>Leader Migration optionally takes a configuration file representing the state of controller-to-manager assignment. At this moment, with in-tree cloud provider, <code>kube-controller-manager</code> runs <code>route</code>, <code>service</code>, and <code>cloud-node-lifecycle</code>. The following example configuration shows the assignment.</p><p>Leader Migration can be enabled without a configuration. Please see <a href=#default-configuration>Default Configuration</a> for details.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LeaderMigrationConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>controllermanager.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>leaderName</span>:<span style=color:#bbb> </span>cloud-provider-extraction-migration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerLeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>kube-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>kube-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cloud-node-lifecycle<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>kube-controller-manager<span style=color:#bbb>
</span></span></span></code></pre></div><p>Alternatively, because the controllers can run under either controller managers, setting <code>component</code> to <code>*</code>
for both sides makes the configuration file consistent between both parties of the migration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># wildcard version</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LeaderMigrationConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>controllermanager.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>leaderName</span>:<span style=color:#bbb> </span>cloud-provider-extraction-migration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerLeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>*<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>*<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cloud-node-lifecycle<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>*<span style=color:#bbb>
</span></span></span></code></pre></div><p>On each control plane node, save the content to <code>/etc/leadermigration.conf</code>, and update the manifest of <code>kube-controller-manager</code> so that the file is mounted inside the container at the same location. Also, update the same manifest to add the following arguments:</p><ul><li><code>--enable-leader-migration</code> to enable Leader Migration on the controller manager</li><li><code>--leader-migration-config=/etc/leadermigration.conf</code> to set configuration file</li></ul><p>Restart <code>kube-controller-manager</code> on each node. At this moment, <code>kube-controller-manager</code> has leader migration enabled and is ready for the migration.</p><h3 id=deploy-cloud-controller-manager>Deploy Cloud Controller Manager</h3><p>In version N + 1, the desired state of controller-to-manager assignment can be represented by a new configuration file, shown as follows. Please note <code>component</code> field of each <code>controllerLeaders</code> changing from <code>kube-controller-manager</code> to <code>cloud-controller-manager</code>. Alternatively, use the wildcard version mentioned above, which has the same effect.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LeaderMigrationConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>controllermanager.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>leaderName</span>:<span style=color:#bbb> </span>cloud-provider-extraction-migration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerLeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cloud-node-lifecycle<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>cloud-controller-manager<span style=color:#bbb>
</span></span></span></code></pre></div><p>When creating control plane nodes of version N + 1, the content should be deployed to <code>/etc/leadermigration.conf</code>. The manifest of <code>cloud-controller-manager</code> should be updated to mount the configuration file in the same manner as <code>kube-controller-manager</code> of version N. Similarly, add <code>--enable-leader-migration</code> and <code>--leader-migration-config=/etc/leadermigration.conf</code> to the arguments of <code>cloud-controller-manager</code>.</p><p>Create a new control plane node of version N + 1 with the updated <code>cloud-controller-manager</code> manifest, and with the <code>--cloud-provider</code> flag set to <code>external</code> for <code>kube-controller-manager</code>. <code>kube-controller-manager</code> of version N + 1 MUST NOT have Leader Migration enabled because, with an external cloud provider, it does not run the migrated controllers anymore, and thus it is not involved in the migration.</p><p>Please refer to <a href=/docs/tasks/administer-cluster/running-cloud-controller/>Cloud Controller Manager Administration</a> for more detail on how to deploy <code>cloud-controller-manager</code>.</p><h3 id=upgrade-control-plane>Upgrade Control Plane</h3><p>The control plane now contains nodes of both version N and N + 1. The nodes of version N run <code>kube-controller-manager</code> only, and these of version N + 1 run both <code>kube-controller-manager</code> and <code>cloud-controller-manager</code>. The migrated controllers, as specified in the configuration, are running under either <code>kube-controller-manager</code> of version N or <code>cloud-controller-manager</code> of version N + 1 depending on which controller manager holds the migration lease. No controller will ever be running under both controller managers at any time.</p><p>In a rolling manner, create a new control plane node of version N + 1 and bring down one of version N + 1 until the control plane contains only nodes of version N + 1.
If a rollback from version N + 1 to N is required, add nodes of version N with Leader Migration enabled for <code>kube-controller-manager</code> back to the control plane, replacing one of version N + 1 each time until there are only nodes of version N.</p><h3 id=disable-leader-migration>(Optional) Disable Leader Migration</h3><p>Now that the control plane has been upgraded to run both <code>kube-controller-manager</code> and <code>cloud-controller-manager</code> of version N + 1, Leader Migration has finished its job and can be safely disabled to save one Lease resource. It is safe to re-enable Leader Migration for the rollback in the future.</p><p>In a rolling manager, update manifest of <code>cloud-controller-manager</code> to unset both <code>--enable-leader-migration</code> and <code>--leader-migration-config=</code> flag, also remove the mount of <code>/etc/leadermigration.conf</code>, and finally remove <code>/etc/leadermigration.conf</code>. To re-enable Leader Migration, recreate the configuration file and add its mount and the flags that enable Leader Migration back to <code>cloud-controller-manager</code>.</p><h3 id=default-configuration>Default Configuration</h3><p>Starting Kubernetes 1.22, Leader Migration provides a default configuration suitable for the default controller-to-manager assignment.
The default configuration can be enabled by setting <code>--enable-leader-migration</code> but without <code>--leader-migration-config=</code>.</p><p>For <code>kube-controller-manager</code> and <code>cloud-controller-manager</code>, if there are no flags that enable any in-tree cloud provider or change ownership of controllers, the default configuration can be used to avoid manual creation of the configuration file.</p><h3 id=node-ipam-controller-migration>Special case: migrating the Node IPAM controller</h3><p>If your cloud provider provides an implementation of Node IPAM controller, you should switch to the implementation in <code>cloud-controller-manager</code>. Disable Node IPAM controller in <code>kube-controller-manager</code> of version N + 1 by adding <code>--controllers=*,-nodeipam</code> to its flags. Then add <code>nodeipam</code> to the list of migrated controllers.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># wildcard version, with nodeipam</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>LeaderMigrationConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>controllermanager.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>leaderName</span>:<span style=color:#bbb> </span>cloud-provider-extraction-migration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerLeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>*<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>*<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cloud-node-lifecycle<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>*<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nodeipam<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:#bbb>  </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>*<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Read the <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-cloud-provider/2436-controller-manager-leader-migration>Controller Manager Leader Migration</a> enhancement proposal.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-56de8c25b1486599777034111645b803>2.25 - Namespaces Walkthrough</h1><p>Kubernetes <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespaces>namespaces</a>
help different projects, teams, or customers to share a Kubernetes cluster.</p><p>It does this by providing the following:</p><ol><li>A scope for <a href=/docs/concepts/overview/working-with-objects/names/>Names</a>.</li><li>A mechanism to attach authorization and policy to a subsection of the cluster.</li></ol><p>Use of multiple namespaces is optional.</p><p>This example demonstrates how to use Kubernetes namespaces to subdivide your cluster.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=prerequisites>Prerequisites</h2><p>This example assumes the following:</p><ol><li>You have an <a href=/docs/setup/>existing Kubernetes cluster</a>.</li><li>You have a basic understanding of Kubernetes <a class=glossary-tooltip title='A Pod represents a set of running containers in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pods>Pods</a>, <a class=glossary-tooltip title='A way to expose an application running on a set of Pods as a network service.' data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=Services>Services</a>, and <a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployments>Deployments</a>.</li></ol><h2 id=understand-the-default-namespace>Understand the default namespace</h2><p>By default, a Kubernetes cluster will instantiate a default namespace when provisioning the cluster to hold the default set of Pods,
Services, and Deployments used by the cluster.</p><p>Assuming you have a fresh cluster, you can inspect the available namespaces by doing the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get namespaces
</span></span></code></pre></div><pre tabindex=0><code>NAME      STATUS    AGE
default   Active    13m
</code></pre><h2 id=create-new-namespaces>Create new namespaces</h2><p>For this exercise, we will create two additional Kubernetes namespaces to hold our content.</p><p>Let's imagine a scenario where an organization is using a shared Kubernetes cluster for development and production use cases.</p><p>The development team would like to maintain a space in the cluster where they can get a view on the list of Pods, Services, and Deployments
they use to build and run their application. In this space, Kubernetes resources come and go, and the restrictions on who can or cannot modify resources
are relaxed to enable agile development.</p><p>The operations team would like to maintain a space in the cluster where they can enforce strict procedures on who can or cannot manipulate the set of
Pods, Services, and Deployments that run the production site.</p><p>One pattern this organization could follow is to partition the Kubernetes cluster into two namespaces: <code>development</code> and <code>production</code>.</p><p>Let's create two new namespaces to hold our work.</p><p>Use the file <a href=/examples/admin/namespace-dev.yaml><code>namespace-dev.yaml</code></a> which describes a <code>development</code> namespace:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/namespace-dev.yaml download=admin/namespace-dev.yaml><code>admin/namespace-dev.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-namespace-dev-yaml")' title="Copy admin/namespace-dev.yaml to clipboard"></img></div><div class=includecode id=admin-namespace-dev-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the <code>development</code> namespace using kubectl.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/admin/namespace-dev.yaml
</span></span></code></pre></div><p>Save the following contents into file <a href=/examples/admin/namespace-prod.yaml><code>namespace-prod.yaml</code></a> which describes a <code>production</code> namespace:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/namespace-prod.yaml download=admin/namespace-prod.yaml><code>admin/namespace-prod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-namespace-prod-yaml")' title="Copy admin/namespace-prod.yaml to clipboard"></img></div><div class=includecode id=admin-namespace-prod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>production<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>production<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>And then let's create the <code>production</code> namespace using kubectl.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/admin/namespace-prod.yaml
</span></span></code></pre></div><p>To be sure things are right, let's list all of the namespaces in our cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get namespaces --show-labels
</span></span></code></pre></div><pre tabindex=0><code>NAME          STATUS    AGE       LABELS
default       Active    32m       &lt;none&gt;
development   Active    29s       name=development
production    Active    23s       name=production
</code></pre><h2 id=create-pods-in-each-namespace>Create pods in each namespace</h2><p>A Kubernetes namespace provides the scope for Pods, Services, and Deployments in the cluster.</p><p>Users interacting with one namespace do not see the content in another namespace.</p><p>To demonstrate this, let's spin up a simple Deployment and Pods in the <code>development</code> namespace.</p><p>We first check what is the current context:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config view
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>clusters</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>certificate-authority-data</span>:<span style=color:#bbb> </span>REDACTED<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>server</span>:<span style=color:#bbb> </span>https://130.211.122.180<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>contexts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>current-context</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>preferences</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-certificate-data</span>:<span style=color:#bbb> </span>REDACTED<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-key-data</span>:<span style=color:#bbb> </span>REDACTED<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>token</span>:<span style=color:#bbb> </span>65rZW78y8HbwXXtSXuUw9DbP4FLjHi4b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes-basic-auth<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>h5M0FtUUIflBSdI7<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>admin<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config current-context
</span></span></code></pre></div><pre tabindex=0><code>lithe-cocoa-92103_kubernetes
</code></pre><p>The next step is to define a context for the kubectl client to work in each namespace. The value of "cluster" and "user" fields are copied from the current context.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config set-context dev --namespace<span style=color:#666>=</span>development <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  --cluster<span style=color:#666>=</span>lithe-cocoa-92103_kubernetes <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  --user<span style=color:#666>=</span>lithe-cocoa-92103_kubernetes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl config set-context prod --namespace<span style=color:#666>=</span>production <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  --cluster<span style=color:#666>=</span>lithe-cocoa-92103_kubernetes <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  --user<span style=color:#666>=</span>lithe-cocoa-92103_kubernetes
</span></span></code></pre></div><p>By default, the above commands adds two contexts that are saved into file
<code>.kube/config</code>. You can now view the contexts and alternate against the two
new request contexts depending on which namespace you wish to work against.</p><p>To view the new contexts:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config view
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>clusters</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>certificate-authority-data</span>:<span style=color:#bbb> </span>REDACTED<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>server</span>:<span style=color:#bbb> </span>https://130.211.122.180<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>contexts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>production<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>prod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>current-context</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>preferences</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-certificate-data</span>:<span style=color:#bbb> </span>REDACTED<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-key-data</span>:<span style=color:#bbb> </span>REDACTED<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>token</span>:<span style=color:#bbb> </span>65rZW78y8HbwXXtSXuUw9DbP4FLjHi4b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lithe-cocoa-92103_kubernetes-basic-auth<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>h5M0FtUUIflBSdI7<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>admin<span style=color:#bbb>
</span></span></span></code></pre></div><p>Let's switch to operate in the <code>development</code> namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config use-context dev
</span></span></code></pre></div><p>You can verify your current context by doing the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config current-context
</span></span></code></pre></div><pre tabindex=0><code>dev
</code></pre><p>At this point, all requests we make to the Kubernetes cluster from the command line are scoped to the <code>development</code> namespace.</p><p>Let's create some contents.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/snowflake-deployment.yaml download=admin/snowflake-deployment.yaml><code>admin/snowflake-deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-snowflake-deployment-yaml")' title="Copy admin/snowflake-deployment.yaml to clipboard"></img></div><div class=includecode id=admin-snowflake-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>snowflake<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>snowflake<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>snowflake<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>snowflake<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/serve_hostname<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>snowflake<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Apply the manifest to create a Deployment</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/admin/snowflake-deployment.yaml
</span></span></code></pre></div><p>We have created a deployment whose replica size is 2 that is running the pod called <code>snowflake</code> with a basic container that serves the hostname.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment
</span></span></code></pre></div><pre tabindex=0><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
snowflake    2/2     2            2           2m
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>snowflake
</span></span></code></pre></div><pre tabindex=0><code>NAME                         READY     STATUS    RESTARTS   AGE
snowflake-3968820950-9dgr8   1/1       Running   0          2m
snowflake-3968820950-vgc4n   1/1       Running   0          2m
</code></pre><p>And this is great, developers are able to do what they want, and they do not have to worry about affecting content in the <code>production</code> namespace.</p><p>Let's switch to the <code>production</code> namespace and show how resources in one namespace are hidden from the other.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config use-context prod
</span></span></code></pre></div><p>The <code>production</code> namespace should be empty, and the following commands should return nothing.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment
</span></span><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>Production likes to run cattle, so let's create some cattle pods.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create deployment cattle --image<span style=color:#666>=</span>registry.k8s.io/serve_hostname --replicas<span style=color:#666>=</span><span style=color:#666>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get deployment
</span></span></code></pre></div><pre tabindex=0><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
cattle       5/5     5            5           10s
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>cattle
</span></span></code></pre></div><pre tabindex=0><code>NAME                      READY     STATUS    RESTARTS   AGE
cattle-2263376956-41xy6   1/1       Running   0          34s
cattle-2263376956-kw466   1/1       Running   0          34s
cattle-2263376956-n4v97   1/1       Running   0          34s
cattle-2263376956-p5p3i   1/1       Running   0          34s
cattle-2263376956-sxpth   1/1       Running   0          34s
</code></pre><p>At this point, it should be clear that the resources users create in one namespace are hidden from the other namespace.</p><p>As the policy support in Kubernetes evolves, we will extend this scenario to show how you can provide different
authorization rules for each namespace.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c4d0832845adc92b7ccd54aed63fc932>2.26 - Operating etcd clusters for Kubernetes</h1><p><p>etcd is a consistent and highly-available key value store used as Kubernetes' backing store for all cluster data.</p></p><p>If your Kubernetes cluster uses etcd as its backing store, make sure you have a
<a href=/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster>back up</a> plan
for those data.</p><p>You can find in-depth information about etcd in the official <a href=https://etcd.io/docs/>documentation</a>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Run etcd as a cluster of odd members.</p></li><li><p>etcd is a leader-based distributed system. Ensure that the leader
periodically send heartbeats on time to all followers to keep the cluster
stable.</p></li><li><p>Ensure that no resource starvation occurs.</p><p>Performance and stability of the cluster is sensitive to network and disk
I/O. Any resource starvation can lead to heartbeat timeout, causing instability
of the cluster. An unstable etcd indicates that no leader is elected. Under
such circumstances, a cluster cannot make any changes to its current state,
which implies no new pods can be scheduled.</p></li><li><p>Keeping etcd clusters stable is critical to the stability of Kubernetes
clusters. Therefore, run etcd clusters on dedicated machines or isolated
environments for <a href=https://etcd.io/docs/current/op-guide/hardware/>guaranteed resource requirements</a>.</p></li><li><p>The minimum recommended version of etcd to run in production is <code>3.2.10+</code>.</p></li></ul><h2 id=resource-requirements>Resource requirements</h2><p>Operating etcd with limited resources is suitable only for testing purposes.
For deploying in production, advanced hardware configuration is required.
Before deploying etcd in production, see
<a href=https://etcd.io/docs/current/op-guide/hardware/#example-hardware-configurations>resource requirement reference</a>.</p><h2 id=starting-etcd-clusters>Starting etcd clusters</h2><p>This section covers starting a single-node and multi-node etcd cluster.</p><h3 id=single-node-etcd-cluster>Single-node etcd cluster</h3><p>Use a single-node etcd cluster only for testing purpose.</p><ol><li><p>Run the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>etcd --listen-client-urls<span style=color:#666>=</span>http://<span style=color:#b8860b>$PRIVATE_IP</span>:2379 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>   --advertise-client-urls<span style=color:#666>=</span>http://<span style=color:#b8860b>$PRIVATE_IP</span>:2379
</span></span></code></pre></div></li><li><p>Start the Kubernetes API server with the flag
<code>--etcd-servers=$PRIVATE_IP:2379</code>.</p><p>Make sure <code>PRIVATE_IP</code> is set to your etcd client IP.</p></li></ol><h3 id=multi-node-etcd-cluster>Multi-node etcd cluster</h3><p>For durability and high availability, run etcd as a multi-node cluster in
production and back it up periodically. A five-member cluster is recommended
in production. For more information, see
<a href=https://etcd.io/docs/current/faq/#what-is-failure-tolerance>FAQ documentation</a>.</p><p>Configure an etcd cluster either by static member information or by dynamic
discovery. For more information on clustering, see
<a href=https://etcd.io/docs/current/op-guide/clustering/>etcd clustering documentation</a>.</p><p>For an example, consider a five-member etcd cluster running with the following
client URLs: <code>http://$IP1:2379</code>, <code>http://$IP2:2379</code>, <code>http://$IP3:2379</code>,
<code>http://$IP4:2379</code>, and <code>http://$IP5:2379</code>. To start a Kubernetes API server:</p><ol><li><p>Run the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>etcd --listen-client-urls<span style=color:#666>=</span>http://<span style=color:#b8860b>$IP1</span>:2379,http://<span style=color:#b8860b>$IP2</span>:2379,http://<span style=color:#b8860b>$IP3</span>:2379,http://<span style=color:#b8860b>$IP4</span>:2379,http://<span style=color:#b8860b>$IP5</span>:2379 --advertise-client-urls<span style=color:#666>=</span>http://<span style=color:#b8860b>$IP1</span>:2379,http://<span style=color:#b8860b>$IP2</span>:2379,http://<span style=color:#b8860b>$IP3</span>:2379,http://<span style=color:#b8860b>$IP4</span>:2379,http://<span style=color:#b8860b>$IP5</span>:2379
</span></span></code></pre></div></li><li><p>Start the Kubernetes API servers with the flag
<code>--etcd-servers=$IP1:2379,$IP2:2379,$IP3:2379,$IP4:2379,$IP5:2379</code>.</p><p>Make sure the <code>IP&lt;n></code> variables are set to your client IP addresses.</p></li></ol><h3 id=multi-node-etcd-cluster-with-load-balancer>Multi-node etcd cluster with load balancer</h3><p>To run a load balancing etcd cluster:</p><ol><li>Set up an etcd cluster.</li><li>Configure a load balancer in front of the etcd cluster.
For example, let the address of the load balancer be <code>$LB</code>.</li><li>Start Kubernetes API Servers with the flag <code>--etcd-servers=$LB:2379</code>.</li></ol><h2 id=securing-etcd-clusters>Securing etcd clusters</h2><p>Access to etcd is equivalent to root permission in the cluster so ideally only
the API server should have access to it. Considering the sensitivity of the
data, it is recommended to grant permission to only those nodes that require
access to etcd clusters.</p><p>To secure etcd, either set up firewall rules or use the security features
provided by etcd. etcd security features depend on x509 Public Key
Infrastructure (PKI). To begin, establish secure communication channels by
generating a key and certificate pair. For example, use key pairs <code>peer.key</code>
and <code>peer.cert</code> for securing communication between etcd members, and
<code>client.key</code> and <code>client.cert</code> for securing communication between etcd and its
clients. See the <a href=https://github.com/coreos/etcd/tree/master/hack/tls-setup>example scripts</a>
provided by the etcd project to generate key pairs and CA files for client
authentication.</p><h3 id=securing-communication>Securing communication</h3><p>To configure etcd with secure peer communication, specify flags
<code>--peer-key-file=peer.key</code> and <code>--peer-cert-file=peer.cert</code>, and use HTTPS as
the URL schema.</p><p>Similarly, to configure etcd with secure client communication, specify flags
<code>--key-file=k8sclient.key</code> and <code>--cert-file=k8sclient.cert</code>, and use HTTPS as
the URL schema. Here is an example on a client command that uses secure
communication:</p><pre tabindex=0><code>ETCDCTL_API=3 etcdctl --endpoints 10.2.0.9:2379 \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  member list
</code></pre><h3 id=limiting-access-of-etcd-clusters>Limiting access of etcd clusters</h3><p>After configuring secure communication, restrict the access of etcd cluster to
only the Kubernetes API servers. Use TLS authentication to do so.</p><p>For example, consider key pairs <code>k8sclient.key</code> and <code>k8sclient.cert</code> that are
trusted by the CA <code>etcd.ca</code>. When etcd is configured with <code>--client-cert-auth</code>
along with TLS, it verifies the certificates from clients by using system CAs
or the CA passed in by <code>--trusted-ca-file</code> flag. Specifying flags
<code>--client-cert-auth=true</code> and <code>--trusted-ca-file=etcd.ca</code> will restrict the
access to clients with the certificate <code>k8sclient.cert</code>.</p><p>Once etcd is configured correctly, only clients with valid certificates can
access it. To give Kubernetes API servers the access, configure them with the
flags <code>--etcd-certfile=k8sclient.cert</code>, <code>--etcd-keyfile=k8sclient.key</code> and
<code>--etcd-cafile=ca.cert</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> etcd authentication is not currently supported by Kubernetes. For more
information, see the related issue
<a href=https://github.com/kubernetes/kubernetes/issues/23398>Support Basic Auth for Etcd v2</a>.</div><h2 id=replacing-a-failed-etcd-member>Replacing a failed etcd member</h2><p>etcd cluster achieves high availability by tolerating minor member failures.
However, to improve the overall health of the cluster, replace failed members
immediately. When multiple members fail, replace them one by one. Replacing a
failed member involves two steps: removing the failed member and adding a new
member.</p><p>Though etcd keeps unique member IDs internally, it is recommended to use a
unique name for each member to avoid human errors. For example, consider a
three-member etcd cluster. Let the URLs be, <code>member1=http://10.0.0.1</code>,
<code>member2=http://10.0.0.2</code>, and <code>member3=http://10.0.0.3</code>. When <code>member1</code> fails,
replace it with <code>member4=http://10.0.0.4</code>.</p><ol><li><p>Get the member ID of the failed <code>member1</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>etcdctl --endpoints<span style=color:#666>=</span>http://10.0.0.2,http://10.0.0.3 member list
</span></span></code></pre></div><p>The following message is displayed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>8211f1d0f64f3269, started, member1, http://10.0.0.1:2380, http://10.0.0.1:2379
</span></span></span><span style=display:flex><span><span style=color:#888>91bc3c398fb3c146, started, member2, http://10.0.0.2:2380, http://10.0.0.2:2379
</span></span></span><span style=display:flex><span><span style=color:#888>fd422379fda50e48, started, member3, http://10.0.0.3:2380, http://10.0.0.3:2379
</span></span></span></code></pre></div></li><li><p>Do either of the following:</p><ol><li>If each Kubernetes API server is configured to communicate with all etcd
members, remove the failed member from the <code>--etcd-servers</code> flag, then
restart each Kubernetes API server.</li><li>If each Kubernetes API server communicates with a single etcd member,
then stop the Kubernetes API server that communicates with the failed
etcd.</li></ol></li><li><p>Stop the etcd server on the broken node. It is possible that other
clients besides the Kubernetes API server is causing traffic to etcd
and it is desirable to stop all traffic to prevent writes to the data
dir.</p></li><li><p>Remove the failed member:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>etcdctl member remove 8211f1d0f64f3269
</span></span></code></pre></div><p>The following message is displayed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>Removed member 8211f1d0f64f3269 from cluster
</span></span></span></code></pre></div></li><li><p>Add the new member:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>etcdctl member add member4 --peer-urls<span style=color:#666>=</span>http://10.0.0.4:2380
</span></span></code></pre></div><p>The following message is displayed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>Member 2be1eb8f84b7f63e added to cluster ef37ad9dc622a7c4
</span></span></span></code></pre></div></li><li><p>Start the newly added member on a machine with the IP <code>10.0.0.4</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>ETCD_NAME</span><span style=color:#666>=</span><span style=color:#b44>&#34;member4&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>ETCD_INITIAL_CLUSTER</span><span style=color:#666>=</span><span style=color:#b44>&#34;member2=http://10.0.0.2:2380,member3=http://10.0.0.3:2380,member4=http://10.0.0.4:2380&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>ETCD_INITIAL_CLUSTER_STATE</span><span style=color:#666>=</span>existing
</span></span><span style=display:flex><span>etcd <span style=color:#666>[</span>flags<span style=color:#666>]</span>
</span></span></code></pre></div></li><li><p>Do either of the following:</p><ol><li>If each Kubernetes API server is configured to communicate with all etcd
members, add the newly added member to the <code>--etcd-servers</code> flag, then
restart each Kubernetes API server.</li><li>If each Kubernetes API server communicates with a single etcd member,
start the Kubernetes API server that was stopped in step 2. Then
configure Kubernetes API server clients to again route requests to the
Kubernetes API server that was stopped. This can often be done by
configuring a load balancer.</li></ol></li></ol><p>For more information on cluster reconfiguration, see
<a href=https://etcd.io/docs/current/op-guide/runtime-configuration/#remove-a-member>etcd reconfiguration documentation</a>.</p><h2 id=backing-up-an-etcd-cluster>Backing up an etcd cluster</h2><p>All Kubernetes objects are stored on etcd. Periodically backing up the etcd
cluster data is important to recover Kubernetes clusters under disaster
scenarios, such as losing all control plane nodes. The snapshot file contains
all the Kubernetes states and critical information. In order to keep the
sensitive Kubernetes data safe, encrypt the snapshot files.</p><p>Backing up an etcd cluster can be accomplished in two ways: etcd built-in
snapshot and volume snapshot.</p><h3 id=built-in-snapshot>Built-in snapshot</h3><p>etcd supports built-in snapshot. A snapshot may either be taken from a live
member with the <code>etcdctl snapshot save</code> command or by copying the
<code>member/snap/db</code> file from an etcd
<a href=https://etcd.io/docs/current/op-guide/configuration/#--data-dir>data directory</a>
that is not currently used by an etcd process. Taking the snapshot will
not affect the performance of the member.</p><p>Below is an example for taking a snapshot of the keyspace served by
<code>$ENDPOINT</code> to the file <code>snapshotdb</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span> etcdctl --endpoints <span style=color:#b8860b>$ENDPOINT</span> snapshot save snapshotdb
</span></span></code></pre></div><p>Verify the snapshot:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span> etcdctl --write-out<span style=color:#666>=</span>table snapshot status snapshotdb
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>+----------+----------+------------+------------+
</span></span></span><span style=display:flex><span><span style=color:#888>|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |
</span></span></span><span style=display:flex><span><span style=color:#888>+----------+----------+------------+------------+
</span></span></span><span style=display:flex><span><span style=color:#888>| fe01cf57 |       10 |          7 | 2.1 MB     |
</span></span></span><span style=display:flex><span><span style=color:#888>+----------+----------+------------+------------+
</span></span></span></code></pre></div><h3 id=volume-snapshot>Volume snapshot</h3><p>If etcd is running on a storage volume that supports backup, such as Amazon
Elastic Block Store, back up etcd data by taking a snapshot of the storage
volume.</p><h3 id=snapshot-using-etcdctl-options>Snapshot using etcdctl options</h3><p>We can also take the snapshot using various options given by etcdctl. For example</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span> etcdctl -h 
</span></span></code></pre></div><p>will list various options available from etcdctl. For example, you can take a snapshot by specifying
the endpoint, certificates etc as shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span> etcdctl --endpoints<span style=color:#666>=</span>https://127.0.0.1:2379 <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  --cacert<span style=color:#666>=</span>&lt;trusted-ca-file&gt; --cert<span style=color:#666>=</span>&lt;cert-file&gt; --key<span style=color:#666>=</span>&lt;key-file&gt; <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  snapshot save &lt;backup-file-location&gt;
</span></span></code></pre></div><p>where <code>trusted-ca-file</code>, <code>cert-file</code> and <code>key-file</code> can be obtained from the description of the etcd Pod.</p><h2 id=scaling-out-etcd-clusters>Scaling out etcd clusters</h2><p>Scaling out etcd clusters increases availability by trading off performance.
Scaling does not increase cluster performance nor capability. A general rule
is not to scale out or in etcd clusters. Do not configure any auto scaling
groups for etcd clusters. It is highly recommended to always run a static
five-member etcd cluster for production Kubernetes clusters at any officially
supported scale.</p><p>A reasonable scaling is to upgrade a three-member cluster to a five-member
one, when more reliability is desired. See
<a href=https://etcd.io/docs/current/op-guide/runtime-configuration/#remove-a-member>etcd reconfiguration documentation</a>
for information on how to add members into an existing cluster.</p><h2 id=restoring-an-etcd-cluster>Restoring an etcd cluster</h2><p>etcd supports restoring from snapshots that are taken from an etcd process of
the <a href=http://semver.org/>major.minor</a> version. Restoring a version from a
different patch version of etcd also is supported. A restore operation is
employed to recover the data of a failed cluster.</p><p>Before starting the restore operation, a snapshot file must be present. It can
either be a snapshot file from a previous backup operation, or from a remaining
<a href=https://etcd.io/docs/current/op-guide/configuration/#--data-dir>data directory</a>.
Here is an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span> etcdctl --endpoints 10.2.0.9:2379 snapshot restore snapshotdb
</span></span></code></pre></div><p>Another example for restoring using etcdctl options:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span> etcdctl snapshot restore --data-dir &lt;data-dir-location&gt; snapshotdb
</span></span></code></pre></div><p>Yet another example would be to first export the environment variable</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span>
</span></span><span style=display:flex><span>etcdctl snapshot restore --data-dir &lt;data-dir-location&gt; snapshotdb
</span></span></code></pre></div><p>For more information and examples on restoring a cluster from a snapshot file, see
<a href=https://etcd.io/docs/current/op-guide/recovery/#restoring-a-cluster>etcd disaster recovery documentation</a>.</p><p>If the access URLs of the restored cluster is changed from the previous
cluster, the Kubernetes API server must be reconfigured accordingly. In this
case, restart Kubernetes API servers with the flag
<code>--etcd-servers=$NEW_ETCD_CLUSTER</code> instead of the flag
<code>--etcd-servers=$OLD_ETCD_CLUSTER</code>. Replace <code>$NEW_ETCD_CLUSTER</code> and
<code>$OLD_ETCD_CLUSTER</code> with the respective IP addresses. If a load balancer is
used in front of an etcd cluster, you might need to update the load balancer
instead.</p><p>If the majority of etcd members have permanently failed, the etcd cluster is
considered failed. In this scenario, Kubernetes cannot make any changes to its
current state. Although the scheduled pods might continue to run, no new pods
can be scheduled. In such cases, recover the etcd cluster and potentially
reconfigure Kubernetes API servers to fix the issue.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>If any API servers are running in your cluster, you should not attempt to
restore instances of etcd. Instead, follow these steps to restore etcd:</p><ul><li>stop <em>all</em> API server instances</li><li>restore state in all etcd instances</li><li>restart all API server instances</li></ul><p>We also recommend restarting any components (e.g. <code>kube-scheduler</code>,
<code>kube-controller-manager</code>, <code>kubelet</code>) to ensure that they don't rely on some
stale data. Note that in practice, the restore takes a bit of time. During the
restoration, critical components will lose leader lock and restart themselves.</p></div><h2 id=upgrading-etcd-clusters>Upgrading etcd clusters</h2><p>For more details on etcd upgrade, please refer to the <a href=https://etcd.io/docs/latest/upgrades/>etcd upgrades</a> documentation.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Before you start an upgrade, please back up your etcd cluster first.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-eec61e72c300dbfbf7302400ca966432>2.27 - Reconfigure a Node's Kubelet in a Live Cluster</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.22 [deprecated]</code></div><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> The <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/281-dynamic-kubelet-configuration>Dynamic Kubelet Configuration</a>
feature is deprecated in 1.22 and removed in 1.24.
Please switch to alternative means distributing configuration to the Nodes of your cluster.</div><p><a href=https://github.com/kubernetes/enhancements/issues/281>Dynamic Kubelet Configuration</a>
allowed you to change the configuration of each
<a class=glossary-tooltip title='An agent that runs on each node in the cluster. It makes sure that containers are running in a pod.' data-toggle=tooltip data-placement=top href=/docs/reference/generated/kubelet target=_blank aria-label=kubelet>kubelet</a> in a running Kubernetes cluster,
by deploying a <a class=glossary-tooltip title='An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a> and configuring
each <a class=glossary-tooltip title='A node is a worker machine in Kubernetes.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/nodes/ target=_blank aria-label=Node>Node</a> to use it.</p><p>Please find documentation on this feature in <a href=https://v1-23.docs.kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/>earlier versions of documentation</a>.</p><h2 id=migrating-from-using-dynamic-kubelet-configuration>Migrating from using Dynamic Kubelet Configuration</h2><p>There is no recommended replacement for this feature that works generically
across various Kubernetes distributions. If you are using managed Kubernetes
version, please consult with the vendor hosting Kubernetes for the best
practices for customizing your Kubernetes. If you are using <code>kubeadm</code>, refer to
<a href=/docs/setup/production-environment/tools/kubeadm/kubelet-integration/>Configuring each kubelet in your cluster using kubeadm</a>.</p><p>In order to migrate off the Dynamic Kubelet Configuration feature, the
alternative mechanism should be used to distribute kubelet configuration files.
In order to apply configuration, config file must be updated and kubelet restarted.
See the <a href=/docs/tasks/administer-cluster/kubelet-config-file/>Set Kubelet parameters via a config file</a>
for information.</p><p>Please note, the <code>DynamicKubeletConfig</code> feature gate cannot be set on a kubelet
starting v1.24 as it has no effect. However, the feature gate is not removed
from the API server or the controller manager before v1.26. This is designed for
the control plane to support nodes with older versions of kubelets and for
satisfying the <a href=/releases/version-skew-policy/>Kubernetes version skew policy</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b64a1d2bb3f4ed9f7021134e09a75c36>2.28 - Reserve Compute Resources for System Daemons</h1><p>Kubernetes nodes can be scheduled to <code>Capacity</code>. Pods can consume all the
available capacity on a node by default. This is an issue because nodes
typically run quite a few system daemons that power the OS and Kubernetes
itself. Unless resources are set aside for these system daemons, pods and system
daemons compete for resources and lead to resource starvation issues on the
node.</p><p>The <code>kubelet</code> exposes a feature named 'Node Allocatable' that helps to reserve
compute resources for system daemons. Kubernetes recommends cluster
administrators to configure 'Node Allocatable' based on their workload density
on each node.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.8.
To check the version, enter <code>kubectl version</code>.
Your Kubernetes server must be at or later than version 1.17 to use
the kubelet command line option <code>--reserved-cpus</code> to set an
<a href=#explicitly-reserved-cpu-list>explicitly reserved CPU list</a>.</p><h2 id=node-allocatable>Node Allocatable</h2><p><img src=/images/docs/node-capacity.svg alt="node capacity"></p><p>'Allocatable' on a Kubernetes node is defined as the amount of compute resources
that are available for pods. The scheduler does not over-subscribe
'Allocatable'. 'CPU', 'memory' and 'ephemeral-storage' are supported as of now.</p><p>Node Allocatable is exposed as part of <code>v1.Node</code> object in the API and as part
of <code>kubectl describe node</code> in the CLI.</p><p>Resources can be reserved for two categories of system daemons in the <code>kubelet</code>.</p><h3 id=enabling-qos-and-pod-level-cgroups>Enabling QoS and Pod level cgroups</h3><p>To properly enforce node allocatable constraints on the node, you must
enable the new cgroup hierarchy via the <code>--cgroups-per-qos</code> flag. This flag is
enabled by default. When enabled, the <code>kubelet</code> will parent all end-user pods
under a cgroup hierarchy managed by the <code>kubelet</code>.</p><h3 id=configuring-a-cgroup-driver>Configuring a cgroup driver</h3><p>The <code>kubelet</code> supports manipulation of the cgroup hierarchy on
the host using a cgroup driver. The driver is configured via the
<code>--cgroup-driver</code> flag.</p><p>The supported values are the following:</p><ul><li><code>cgroupfs</code> is the default driver that performs direct manipulation of the
cgroup filesystem on the host in order to manage cgroup sandboxes.</li><li><code>systemd</code> is an alternative driver that manages cgroup sandboxes using
transient slices for resources that are supported by that init system.</li></ul><p>Depending on the configuration of the associated container runtime,
operators may have to choose a particular cgroup driver to ensure
proper system behavior. For example, if operators use the <code>systemd</code>
cgroup driver provided by the <code>containerd</code> runtime, the <code>kubelet</code> must
be configured to use the <code>systemd</code> cgroup driver.</p><h3 id=kube-reserved>Kube Reserved</h3><ul><li><strong>Kubelet Flag</strong>: <code>--kube-reserved=[cpu=100m][,][memory=100Mi][,][ephemeral-storage=1Gi][,][pid=1000]</code></li><li><strong>Kubelet Flag</strong>: <code>--kube-reserved-cgroup=</code></li></ul><p><code>kube-reserved</code> is meant to capture resource reservation for kubernetes system
daemons like the <code>kubelet</code>, <code>container runtime</code>, <code>node problem detector</code>, etc.
It is not meant to reserve resources for system daemons that are run as pods.
<code>kube-reserved</code> is typically a function of <code>pod density</code> on the nodes.</p><p>In addition to <code>cpu</code>, <code>memory</code>, and <code>ephemeral-storage</code>, <code>pid</code> may be
specified to reserve the specified number of process IDs for
kubernetes system daemons.</p><p>To optionally enforce <code>kube-reserved</code> on kubernetes system daemons, specify the parent
control group for kube daemons as the value for <code>--kube-reserved-cgroup</code> kubelet
flag.</p><p>It is recommended that the kubernetes system daemons are placed under a top
level control group (<code>runtime.slice</code> on systemd machines for example). Each
system daemon should ideally run within its own child control group. Refer to
<a href=https://git.k8s.io/design-proposals-archive/node/node-allocatable.md#recommended-cgroups-setup>the design proposal</a>
for more details on recommended control group hierarchy.</p><p>Note that Kubelet <strong>does not</strong> create <code>--kube-reserved-cgroup</code> if it doesn't
exist. Kubelet will fail if an invalid cgroup is specified. With <code>systemd</code>
cgroup driver, you should follow a specific pattern for the name of the cgroup you
define: the name should be the value you set for <code>--kube-reserved-cgroup</code>,
with <code>.slice</code> appended.</p><h3 id=system-reserved>System Reserved</h3><ul><li><strong>Kubelet Flag</strong>: <code>--system-reserved=[cpu=100m][,][memory=100Mi][,][ephemeral-storage=1Gi][,][pid=1000]</code></li><li><strong>Kubelet Flag</strong>: <code>--system-reserved-cgroup=</code></li></ul><p><code>system-reserved</code> is meant to capture resource reservation for OS system daemons
like <code>sshd</code>, <code>udev</code>, etc. <code>system-reserved</code> should reserve <code>memory</code> for the
<code>kernel</code> too since <code>kernel</code> memory is not accounted to pods in Kubernetes at this time.
Reserving resources for user login sessions is also recommended (<code>user.slice</code> in
systemd world).</p><p>In addition to <code>cpu</code>, <code>memory</code>, and <code>ephemeral-storage</code>, <code>pid</code> may be
specified to reserve the specified number of process IDs for OS system
daemons.</p><p>To optionally enforce <code>system-reserved</code> on system daemons, specify the parent
control group for OS system daemons as the value for <code>--system-reserved-cgroup</code>
kubelet flag.</p><p>It is recommended that the OS system daemons are placed under a top level
control group (<code>system.slice</code> on systemd machines for example).</p><p>Note that <code>kubelet</code> <strong>does not</strong> create <code>--system-reserved-cgroup</code> if it doesn't
exist. <code>kubelet</code> will fail if an invalid cgroup is specified. With <code>systemd</code>
cgroup driver, you should follow a specific pattern for the name of the cgroup you
define: the name should be the value you set for <code>--system-reserved-cgroup</code>,
with <code>.slice</code> appended.</p><h3 id=explicitly-reserved-cpu-list>Explicitly Reserved CPU List</h3><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.17 [stable]</code></div><p><strong>Kubelet Flag</strong>: <code>--reserved-cpus=0-3</code></p><p><code>reserved-cpus</code> is meant to define an explicit CPU set for OS system daemons and
kubernetes system daemons. <code>reserved-cpus</code> is for systems that do not intend to
define separate top level cgroups for OS system daemons and kubernetes system daemons
with regard to cpuset resource.
If the Kubelet <strong>does not</strong> have <code>--system-reserved-cgroup</code> and <code>--kube-reserved-cgroup</code>,
the explicit cpuset provided by <code>reserved-cpus</code> will take precedence over the CPUs
defined by <code>--kube-reserved</code> and <code>--system-reserved</code> options.</p><p>This option is specifically designed for Telco/NFV use cases where uncontrolled
interrupts/timers may impact the workload performance. you can use this option
to define the explicit cpuset for the system/kubernetes daemons as well as the
interrupts/timers, so the rest CPUs on the system can be used exclusively for
workloads, with less impact from uncontrolled interrupts/timers. To move the
system daemon, kubernetes daemons and interrupts/timers to the explicit cpuset
defined by this option, other mechanism outside Kubernetes should be used.
For example: in Centos, you can do this using the tuned toolset.</p><h3 id=eviction-thresholds>Eviction Thresholds</h3><p><strong>Kubelet Flag</strong>: <code>--eviction-hard=[memory.available&lt;500Mi]</code></p><p>Memory pressure at the node level leads to System OOMs which affects the entire
node and all pods running on it. Nodes can go offline temporarily until memory
has been reclaimed. To avoid (or reduce the probability of) system OOMs kubelet
provides <a href=/docs/concepts/scheduling-eviction/node-pressure-eviction/>out of resource</a>
management. Evictions are
supported for <code>memory</code> and <code>ephemeral-storage</code> only. By reserving some memory via
<code>--eviction-hard</code> flag, the <code>kubelet</code> attempts to evict pods whenever memory
availability on the node drops below the reserved value. Hypothetically, if
system daemons did not exist on a node, pods cannot use more than <code>capacity - eviction-hard</code>. For this reason, resources reserved for evictions are not
available for pods.</p><h3 id=enforcing-node-allocatable>Enforcing Node Allocatable</h3><p><strong>Kubelet Flag</strong>: <code>--enforce-node-allocatable=pods[,][system-reserved][,][kube-reserved]</code></p><p>The scheduler treats 'Allocatable' as the available <code>capacity</code> for pods.</p><p><code>kubelet</code> enforce 'Allocatable' across pods by default. Enforcement is performed
by evicting pods whenever the overall usage across all pods exceeds
'Allocatable'. More details on eviction policy can be found
on the <a href=/docs/concepts/scheduling-eviction/node-pressure-eviction/>node pressure eviction</a>
page. This enforcement is controlled by
specifying <code>pods</code> value to the kubelet flag <code>--enforce-node-allocatable</code>.</p><p>Optionally, <code>kubelet</code> can be made to enforce <code>kube-reserved</code> and
<code>system-reserved</code> by specifying <code>kube-reserved</code> & <code>system-reserved</code> values in
the same flag. Note that to enforce <code>kube-reserved</code> or <code>system-reserved</code>,
<code>--kube-reserved-cgroup</code> or <code>--system-reserved-cgroup</code> needs to be specified
respectively.</p><h2 id=general-guidelines>General Guidelines</h2><p>System daemons are expected to be treated similar to
<a href=/docs/tasks/configure-pod-container/quality-service-pod/#create-a-pod-that-gets-assigned-a-qos-class-of-guaranteed>Guaranteed pods</a>.
System daemons can burst within their bounding control groups and this behavior needs
to be managed as part of kubernetes deployments. For example, <code>kubelet</code> should
have its own control group and share <code>kube-reserved</code> resources with the
container runtime. However, Kubelet cannot burst and use up all available Node
resources if <code>kube-reserved</code> is enforced.</p><p>Be extra careful while enforcing <code>system-reserved</code> reservation since it can lead
to critical system services being CPU starved, OOM killed, or unable
to fork on the node. The
recommendation is to enforce <code>system-reserved</code> only if a user has profiled their
nodes exhaustively to come up with precise estimates and is confident in their
ability to recover if any process in that group is oom-killed.</p><ul><li>To begin with enforce 'Allocatable' on <code>pods</code>.</li><li>Once adequate monitoring and alerting is in place to track kube system
daemons, attempt to enforce <code>kube-reserved</code> based on usage heuristics.</li><li>If absolutely necessary, enforce <code>system-reserved</code> over time.</li></ul><p>The resource requirements of kube system daemons may grow over time as more and
more features are added. Over time, kubernetes project will attempt to bring
down utilization of node system daemons, but that is not a priority as of now.
So expect a drop in <code>Allocatable</code> capacity in future releases.</p><h2 id=example-scenario>Example Scenario</h2><p>Here is an example to illustrate Node Allocatable computation:</p><ul><li>Node has <code>32Gi</code> of <code>memory</code>, <code>16 CPUs</code> and <code>100Gi</code> of <code>Storage</code></li><li><code>--kube-reserved</code> is set to <code>cpu=1,memory=2Gi,ephemeral-storage=1Gi</code></li><li><code>--system-reserved</code> is set to <code>cpu=500m,memory=1Gi,ephemeral-storage=1Gi</code></li><li><code>--eviction-hard</code> is set to <code>memory.available&lt;500Mi,nodefs.available&lt;10%</code></li></ul><p>Under this scenario, 'Allocatable' will be 14.5 CPUs, 28.5Gi of memory and
<code>88Gi</code> of local storage.
Scheduler ensures that the total memory <code>requests</code> across all pods on this node does
not exceed 28.5Gi and storage doesn't exceed 88Gi.
Kubelet evicts pods whenever the overall memory usage across pods exceeds 28.5Gi,
or if overall disk usage exceeds 88Gi If all processes on the node consume as
much CPU as they can, pods together cannot consume more than 14.5 CPUs.</p><p>If <code>kube-reserved</code> and/or <code>system-reserved</code> is not enforced and system daemons
exceed their reservation, <code>kubelet</code> evicts pods whenever the overall node memory
usage is higher than 31.5Gi or <code>storage</code> is greater than 90Gi.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f6f3b8f9789fda4286bf410b8e108f69>2.29 - Running Kubernetes Node Components as a Non-root User</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.22 [alpha]</code></div><p>This document describes how to run Kubernetes Node components such as kubelet, CRI, OCI, and CNI
without root privileges, by using a <a class=glossary-tooltip title='A Linux kernel feature to emulate superuser privilege for unprivileged users.' data-toggle=tooltip data-placement=top href=https://man7.org/linux/man-pages/man7/user_namespaces.7.html target=_blank aria-label='user namespace'>user namespace</a>.</p><p>This technique is also known as <em>rootless mode</em>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>This document describes how to run Kubernetes Node components (and hence pods) as a non-root user.</p><p>If you are just looking for how to run a pod as a non-root user, see <a href=/docs/tasks/configure-pod-container/security-context/>SecurityContext</a>.</p></div><h2 id=before-you-begin>Before you begin</h2><p>Your Kubernetes server must be at or later than version 1.22.
To check the version, enter <code>kubectl version</code>.</p><ul><li><a href=https://rootlesscontaine.rs/getting-started/common/cgroup2/>Enable Cgroup v2</a></li><li><a href=https://rootlesscontaine.rs/getting-started/common/login/>Enable systemd with user session</a></li><li><a href=https://rootlesscontaine.rs/getting-started/common/sysctl/>Configure several sysctl values, depending on host Linux distribution</a></li><li><a href=https://rootlesscontaine.rs/getting-started/common/subuid/>Ensure that your unprivileged user is listed in <code>/etc/subuid</code> and <code>/etc/subgid</code></a></li><li>Enable the <code>KubeletInUserNamespace</code> <a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gate</a></li></ul><h2 id=running-kubernetes-inside-rootless-docker-podman>Running Kubernetes inside Rootless Docker/Podman</h2><h3 id=kind>kind</h3><p><a href=https://kind.sigs.k8s.io/>kind</a> supports running Kubernetes inside Rootless Docker or Rootless Podman.</p><p>See <a href=https://kind.sigs.k8s.io/docs/user/rootless/>Running kind with Rootless Docker</a>.</p><h3 id=minikube>minikube</h3><p><a href=https://minikube.sigs.k8s.io/>minikube</a> also supports running Kubernetes inside Rootless Docker or Rootless Podman.</p><p>See the Minikube documentation:</p><ul><li><a href=https://minikube.sigs.k8s.io/docs/drivers/docker/>Rootless Docker</a></li><li><a href=https://minikube.sigs.k8s.io/docs/drivers/podman/>Rootless Podman</a></li></ul><h2 id=running-kubernetes-inside-unprivileged-containers>Running Kubernetes inside Unprivileged Containers</h2><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><h3 id=sysbox>sysbox</h3><p><a href=https://github.com/nestybox/sysbox>Sysbox</a> is an open-source container runtime
(similar to "runc") that supports running system-level workloads such as Docker
and Kubernetes inside unprivileged containers isolated with the Linux user
namespace.</p><p>See <a href=https://github.com/nestybox/sysbox/blob/master/docs/quickstart/kind.md>Sysbox Quick Start Guide: Kubernetes-in-Docker</a> for more info.</p><p>Sysbox supports running Kubernetes inside unprivileged containers without
requiring Cgroup v2 and without the <code>KubeletInUserNamespace</code> feature gate. It
does this by exposing specially crafted <code>/proc</code> and <code>/sys</code> filesystems inside
the container plus several other advanced OS virtualization techniques.</p><h2 id=running-rootless-kubernetes-directly-on-a-host>Running Rootless Kubernetes directly on a host</h2><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><h3 id=k3s>K3s</h3><p><a href=https://k3s.io/>K3s</a> experimentally supports rootless mode.</p><p>See <a href=https://rancher.com/docs/k3s/latest/en/advanced/#running-k3s-with-rootless-mode-experimental>Running K3s with Rootless mode</a> for the usage.</p><h3 id=usernetes>Usernetes</h3><p><a href=https://github.com/rootless-containers/usernetes>Usernetes</a> is a reference distribution of Kubernetes that can be installed under <code>$HOME</code> directory without the root privilege.</p><p>Usernetes supports both containerd and CRI-O as CRI runtimes.
Usernetes supports multi-node clusters using Flannel (VXLAN).</p><p>See <a href=https://github.com/rootless-containers/usernetes>the Usernetes repo</a> for the usage.</p><h2 id=userns-the-hard-way>Manually deploy a node that runs the kubelet in a user namespace</h2><p>This section provides hints for running Kubernetes in a user namespace manually.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This section is intended to be read by developers of Kubernetes distributions, not by end users.</div><h3 id=creating-a-user-namespace>Creating a user namespace</h3><p>The first step is to create a <a class=glossary-tooltip title='A Linux kernel feature to emulate superuser privilege for unprivileged users.' data-toggle=tooltip data-placement=top href=https://man7.org/linux/man-pages/man7/user_namespaces.7.html target=_blank aria-label='user namespace'>user namespace</a>.</p><p>If you are trying to run Kubernetes in a user-namespaced container such as
Rootless Docker/Podman or LXC/LXD, you are all set, and you can go to the next subsection.</p><p>Otherwise you have to create a user namespace by yourself, by calling <code>unshare(2)</code> with <code>CLONE_NEWUSER</code>.</p><p>A user namespace can be also unshared by using command line tools such as:</p><ul><li><a href=https://man7.org/linux/man-pages/man1/unshare.1.html><code>unshare(1)</code></a></li><li><a href=https://github.com/rootless-containers/rootlesskit>RootlessKit</a></li><li><a href=https://github.com/giuseppe/become-root>become-root</a></li></ul><p>After unsharing the user namespace, you will also have to unshare other namespaces such as mount namespace.</p><p>You do <em>not</em> need to call <code>chroot()</code> nor <code>pivot_root()</code> after unsharing the mount namespace,
however, you have to mount writable filesystems on several directories <em>in</em> the namespace.</p><p>At least, the following directories need to be writable <em>in</em> the namespace (not <em>outside</em> the namespace):</p><ul><li><code>/etc</code></li><li><code>/run</code></li><li><code>/var/logs</code></li><li><code>/var/lib/kubelet</code></li><li><code>/var/lib/cni</code></li><li><code>/var/lib/containerd</code> (for containerd)</li><li><code>/var/lib/containers</code> (for CRI-O)</li></ul><h3 id=creating-a-delegated-cgroup-tree>Creating a delegated cgroup tree</h3><p>In addition to the user namespace, you also need to have a writable cgroup tree with cgroup v2.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Kubernetes support for running Node components in user namespaces requires cgroup v2.
Cgroup v1 is not supported.</div><p>If you are trying to run Kubernetes in Rootless Docker/Podman or LXC/LXD on a systemd-based host, you are all set.</p><p>Otherwise you have to create a systemd unit with <code>Delegate=yes</code> property to delegate a cgroup tree with writable permission.</p><p>On your node, systemd must already be configured to allow delegation; for more details, see
<a href=https://rootlesscontaine.rs/getting-started/common/cgroup2/>cgroup v2</a> in the Rootless
Containers documentation.</p><h3 id=configuring-network>Configuring network</h3><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>The network namespace of the Node components has to have a non-loopback interface, which can be for example configured with
<a href=https://github.com/rootless-containers/slirp4netns>slirp4netns</a>,
<a href=https://github.com/moby/vpnkit>VPNKit</a>, or
<a href=https://www.man7.org/linux/man-pages/man1/lxc-user-nic.1.html>lxc-user-nic(1)</a>.</p><p>The network namespaces of the Pods can be configured with regular CNI plugins.
For multi-node networking, Flannel (VXLAN, 8472/UDP) is known to work.</p><p>Ports such as the kubelet port (10250/TCP) and <code>NodePort</code> service ports have to be exposed from the Node network namespace to
the host with an external port forwarder, such as RootlessKit, slirp4netns, or
<a href=https://linux.die.net/man/1/socat>socat(1)</a>.</p><p>You can use the port forwarder from K3s.
See <a href=https://rancher.com/docs/k3s/latest/en/advanced/#known-issues-with-rootless-mode>Running K3s in Rootless Mode</a>
for more details.
The implementation can be found in <a href=https://github.com/k3s-io/k3s/blob/v1.22.3+k3s1/pkg/rootlessports/controller.go>the <code>pkg/rootlessports</code> package</a> of k3s.</p><h3 id=configuring-cri>Configuring CRI</h3><p>The kubelet relies on a container runtime. You should deploy a container runtime such as
containerd or CRI-O and ensure that it is running within the user namespace before the kubelet starts.</p><ul class="nav nav-tabs" id=cri role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#cri-0 role=tab aria-controls=cri-0 aria-selected=true>containerd</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#cri-1 role=tab aria-controls=cri-1>CRI-O</a></li></ul><div class=tab-content id=cri><div id=cri-0 class="tab-pane show active" role=tabpanel aria-labelledby=cri-0><p><p>Running CRI plugin of containerd in a user namespace is supported since containerd 1.4.</p><p>Running containerd within a user namespace requires the following configurations.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>version = <span style=color:#666>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[plugins.<span style=color:#b44>&#34;io.containerd.grpc.v1.cri&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Disable AppArmor</span>
</span></span><span style=display:flex><span>  disable_apparmor = <span style=color:#a2f;font-weight:700>true</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Ignore an error during setting oom_score_adj</span>
</span></span><span style=display:flex><span>  restrict_oom_score_adj = <span style=color:#a2f;font-weight:700>true</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Disable hugetlb cgroup v2 controller (because systemd does not support delegating hugetlb controller)</span>
</span></span><span style=display:flex><span>  disable_hugetlb_controller = <span style=color:#a2f;font-weight:700>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[plugins.<span style=color:#b44>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd]
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Using non-fuse overlayfs is also possible for kernel &gt;= 5.11, but requires SELinux to be disabled</span>
</span></span><span style=display:flex><span>  snapshotter = <span style=color:#b44>&#34;fuse-overlayfs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[plugins.<span style=color:#b44>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options]
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># We use cgroupfs that is delegated by systemd, so we do not use SystemdCgroup driver</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># (unless you run another systemd in the namespace)</span>
</span></span><span style=display:flex><span>  SystemdCgroup = <span style=color:#a2f;font-weight:700>false</span>
</span></span></code></pre></div><p>The default path of the configuration file is <code>/etc/containerd/config.toml</code>.
The path can be specified with <code>containerd -c /path/to/containerd/config.toml</code>.</p></div><div id=cri-1 class=tab-pane role=tabpanel aria-labelledby=cri-1><p><p>Running CRI-O in a user namespace is supported since CRI-O 1.22.</p><p>CRI-O requires an environment variable <code>_CRIO_ROOTLESS=1</code> to be set.</p><p>The following configurations are also recommended:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[crio]
</span></span><span style=display:flex><span>  storage_driver = <span style=color:#b44>&#34;overlay&#34;</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Using non-fuse overlayfs is also possible for kernel &gt;= 5.11, but requires SELinux to be disabled</span>
</span></span><span style=display:flex><span>  storage_option = [<span style=color:#b44>&#34;overlay.mount_program=/usr/local/bin/fuse-overlayfs&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[crio.runtime]
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># We use cgroupfs that is delegated by systemd, so we do not use &#34;systemd&#34; driver</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># (unless you run another systemd in the namespace)</span>
</span></span><span style=display:flex><span>  cgroup_manager = <span style=color:#b44>&#34;cgroupfs&#34;</span>
</span></span></code></pre></div><p>The default path of the configuration file is <code>/etc/crio/crio.conf</code>.
The path can be specified with <code>crio --config /path/to/crio/crio.conf</code>.</p></div></div><h3 id=configuring-kubelet>Configuring kubelet</h3><p>Running kubelet in a user namespace requires the following configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubelet.config.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>KubeletConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>featureGates</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>KubeletInUserNamespace</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># We use cgroupfs that is delegated by systemd, so we do not use &#34;systemd&#34; driver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># (unless you run another systemd in the namespace)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>cgroupDriver</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;cgroupfs&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>When the <code>KubeletInUserNamespace</code> feature gate is enabled, the kubelet ignores errors
that may happen during setting the following sysctl values on the node.</p><ul><li><code>vm.overcommit_memory</code></li><li><code>vm.panic_on_oom</code></li><li><code>kernel.panic</code></li><li><code>kernel.panic_on_oops</code></li><li><code>kernel.keys.root_maxkeys</code></li><li><code>kernel.keys.root_maxbytes</code>.</li></ul><p>Within a user namespace, the kubelet also ignores any error raised from trying to open <code>/dev/kmsg</code>.
This feature gate also allows kube-proxy to ignore an error during setting <code>RLIMIT_NOFILE</code>.</p><p>The <code>KubeletInUserNamespace</code> feature gate was introduced in Kubernetes v1.22 with "alpha" status.</p><p>Running kubelet in a user namespace without using this feature gate is also possible
by mounting a specially crafted proc filesystem (as done by <a href=https://github.com/nestybox/sysbox>Sysbox</a>), but not officially supported.</p><h3 id=configuring-kube-proxy>Configuring kube-proxy</h3><p>Running kube-proxy in a user namespace requires the following configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeproxy.config.k8s.io/v1alpha1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>KubeProxyConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>mode</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;iptables&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># or &#34;userspace&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>conntrack</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Skip setting sysctl value &#34;net.netfilter.nf_conntrack_max&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>maxPerCore</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Skip setting &#34;net.netfilter.nf_conntrack_tcp_timeout_established&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tcpEstablishedTimeout</span>:<span style=color:#bbb> </span>0s<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Skip setting &#34;net.netfilter.nf_conntrack_tcp_timeout_close&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tcpCloseWaitTimeout</span>:<span style=color:#bbb> </span>0s<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=caveats>Caveats</h2><ul><li><p>Most of "non-local" volume drivers such as <code>nfs</code> and <code>iscsi</code> do not work.
Local volumes like <code>local</code>, <code>hostPath</code>, <code>emptyDir</code>, <code>configMap</code>, <code>secret</code>, and <code>downwardAPI</code> are known to work.</p></li><li><p>Some CNI plugins may not work. Flannel (VXLAN) is known to work.</p></li></ul><p>For more on this, see the <a href=https://rootlesscontaine.rs/caveats/>Caveats and Future work</a> page
on the rootlesscontaine.rs website.</p><h2 id=see-also>See Also</h2><ul><li><a href=https://rootlesscontaine.rs/>rootlesscontaine.rs</a></li><li><a href=https://www.slideshare.net/AkihiroSuda/kubecon-na-2020-containerd-rootless-containers-2020>Rootless Containers 2020 (KubeCon NA 2020)</a></li><li><a href=https://kind.sigs.k8s.io/docs/user/rootless/>Running kind with Rootless Docker</a></li><li><a href=https://github.com/rootless-containers/usernetes>Usernetes</a></li><li><a href=https://rancher.com/docs/k3s/latest/en/advanced/#running-k3s-with-rootless-mode-experimental>Running K3s with rootless mode</a></li><li><a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2033-kubelet-in-userns-aka-rootless>KEP-2033: Kubelet-in-UserNS (aka Rootless mode)</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b35b8ddb9bbc15620ce9636f4346c05c>2.30 - Safely Drain a Node</h1><p>This page shows how to safely drain a <a class=glossary-tooltip title='A node is a worker machine in Kubernetes.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/nodes/ target=_blank aria-label=node>node</a>,
optionally respecting the PodDisruptionBudget you have defined.</p><h2 id=before-you-begin>Before you begin</h2><p>Your Kubernetes server must be at or later than version 1.5.
To check the version, enter <code>kubectl version</code>.</p><p>This task also assumes that you have met the following prerequisites:</p><ol><li>You do not require your applications to be highly available during the
node drain, or</li><li>You have read about the <a href=/docs/concepts/workloads/pods/disruptions/>PodDisruptionBudget</a> concept,
and have <a href=/docs/tasks/run-application/configure-pdb/>configured PodDisruptionBudgets</a> for
applications that need them.</li></ol><h2 id=configure-poddisruptionbudget>(Optional) Configure a disruption budget</h2><p>To ensure that your workloads remain available during maintenance, you can
configure a <a href=/docs/concepts/workloads/pods/disruptions/>PodDisruptionBudget</a>.</p><p>If availability is important for any applications that run or could run on the node(s)
that you are draining, <a href=/docs/tasks/run-application/configure-pdb/>configure a PodDisruptionBudgets</a>
first and then continue following this guide.</p><h2 id=use-kubectl-drain-to-remove-a-node-from-service>Use <code>kubectl drain</code> to remove a node from service</h2><p>You can use <code>kubectl drain</code> to safely evict all of your pods from a
node before you perform maintenance on the node (e.g. kernel upgrade,
hardware maintenance, etc.). Safe evictions allow the pod's containers
to <a href=/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination>gracefully terminate</a>
and will respect the PodDisruptionBudgets you have specified.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> By default <code>kubectl drain</code> ignores certain system pods on the node
that cannot be killed; see
the <a href=/docs/reference/generated/kubectl/kubectl-commands/#drain>kubectl drain</a>
documentation for more details.</div><p>When <code>kubectl drain</code> returns successfully, that indicates that all of
the pods (except the ones excluded as described in the previous paragraph)
have been safely evicted (respecting the desired graceful termination period,
and respecting the PodDisruptionBudget you have defined). It is then safe to
bring down the node by powering down its physical machine or, if running on a
cloud platform, deleting its virtual machine.</p><p>First, identify the name of the node you wish to drain. You can list all of the nodes in your cluster with</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p>Next, tell Kubernetes to drain the node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl drain &lt;node name&gt;
</span></span></code></pre></div><p>Once it returns (without giving an error), you can power down the node
(or equivalently, if on a cloud platform, delete the virtual machine backing the node).
If you leave the node in the cluster during the maintenance operation, you need to run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl uncordon &lt;node name&gt;
</span></span></code></pre></div><p>afterwards to tell Kubernetes that it can resume scheduling new pods onto the node.</p><h2 id=draining-multiple-nodes-in-parallel>Draining multiple nodes in parallel</h2><p>The <code>kubectl drain</code> command should only be issued to a single node at a
time. However, you can run multiple <code>kubectl drain</code> commands for
different nodes in parallel, in different terminals or in the
background. Multiple drain commands running concurrently will still
respect the PodDisruptionBudget you specify.</p><p>For example, if you have a StatefulSet with three replicas and have
set a PodDisruptionBudget for that set specifying <code>minAvailable: 2</code>,
<code>kubectl drain</code> only evicts a pod from the StatefulSet if all three
replicas pods are ready; if then you issue multiple drain commands in
parallel, Kubernetes respects the PodDisruptionBudget and ensure
that only 1 (calculated as <code>replicas - minAvailable</code>) Pod is unavailable
at any given time. Any drains that would cause the number of ready
replicas to fall below the specified budget are blocked.</p><h2 id=eviction-api>The Eviction API</h2><p>If you prefer not to use <a href=/docs/reference/generated/kubectl/kubectl-commands/#drain>kubectl drain</a> (such as
to avoid calling to an external command, or to get finer control over the pod
eviction process), you can also programmatically cause evictions using the
eviction API.</p><p>For more information, see <a href=/docs/concepts/scheduling-eviction/api-eviction/>API-initiated eviction</a>.</p><h2 id=what-s-next>What's next</h2><ul><li>Follow steps to protect your application by <a href=/docs/tasks/run-application/configure-pdb/>configuring a Pod Disruption Budget</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-12001be83d15fcd7f3242313a55777df>2.31 - Securing a Cluster</h1><p>This document covers topics related to protecting a cluster from accidental or malicious access
and provides recommendations on overall security.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</li></ul><h2 id=controlling-access-to-the-kubernetes-api>Controlling access to the Kubernetes API</h2><p>As Kubernetes is entirely API-driven, controlling and limiting who can access the cluster and what actions
they are allowed to perform is the first line of defense.</p><h3 id=use-transport-layer-security-tls-for-all-api-traffic>Use Transport Layer Security (TLS) for all API traffic</h3><p>Kubernetes expects that all API communication in the cluster is encrypted by default with TLS, and the
majority of installation methods will allow the necessary certificates to be created and distributed to
the cluster components. Note that some components and installation methods may enable local ports over
HTTP and administrators should familiarize themselves with the settings of each component to identify
potentially unsecured traffic.</p><h3 id=api-authentication>API Authentication</h3><p>Choose an authentication mechanism for the API servers to use that matches the common access patterns
when you install a cluster. For instance, small, single-user clusters may wish to use a simple certificate
or static Bearer token approach. Larger clusters may wish to integrate an existing OIDC or LDAP server that
allow users to be subdivided into groups.</p><p>All API clients must be authenticated, even those that are part of the infrastructure like nodes,
proxies, the scheduler, and volume plugins. These clients are typically <a href=/docs/reference/access-authn-authz/service-accounts-admin/>service accounts</a> or use x509 client certificates, and they are created automatically at cluster startup or are setup as part of the cluster installation.</p><p>Consult the <a href=/docs/reference/access-authn-authz/authentication/>authentication reference document</a> for more information.</p><h3 id=api-authorization>API Authorization</h3><p>Once authenticated, every API call is also expected to pass an authorization check. Kubernetes ships
an integrated <a href=/docs/reference/access-authn-authz/rbac/>Role-Based Access Control (RBAC)</a> component that matches an incoming user or group to a
set of permissions bundled into roles. These permissions combine verbs (get, create, delete) with
resources (pods, services, nodes) and can be namespace-scoped or cluster-scoped. A set of out-of-the-box
roles are provided that offer reasonable default separation of responsibility depending on what
actions a client might want to perform. It is recommended that you use the
<a href=/docs/reference/access-authn-authz/node/>Node</a> and
<a href=/docs/reference/access-authn-authz/rbac/>RBAC</a> authorizers together, in combination with the
<a href=/docs/reference/access-authn-authz/admission-controllers/#noderestriction>NodeRestriction</a> admission plugin.</p><p>As with authentication, simple and broad roles may be appropriate for smaller clusters, but as
more users interact with the cluster, it may become necessary to separate teams into separate
<a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespaces>namespaces</a> with more limited roles.</p><p>With authorization, it is important to understand how updates on one object may cause actions in
other places. For instance, a user may not be able to create pods directly, but allowing them to
create a deployment, which creates pods on their behalf, will let them create those pods
indirectly. Likewise, deleting a node from the API will result in the pods scheduled to that node
being terminated and recreated on other nodes. The out-of-the box roles represent a balance
between flexibility and common use cases, but more limited roles should be carefully reviewed
to prevent accidental escalation. You can make roles specific to your use case if the out-of-box ones don't meet your needs.</p><p>Consult the <a href=/docs/reference/access-authn-authz/authorization/>authorization reference section</a> for more information.</p><h2 id=controlling-access-to-the-kubelet>Controlling access to the Kubelet</h2><p>Kubelets expose HTTPS endpoints which grant powerful control over the node and containers.
By default Kubelets allow unauthenticated access to this API.</p><p>Production clusters should enable Kubelet authentication and authorization.</p><p>Consult the <a href=/docs/reference/access-authn-authz/kubelet-authn-authz/>Kubelet authentication/authorization reference</a>
for more information.</p><h2 id=controlling-the-capabilities-of-a-workload-or-user-at-runtime>Controlling the capabilities of a workload or user at runtime</h2><p>Authorization in Kubernetes is intentionally high level, focused on coarse actions on resources.
More powerful controls exist as <strong>policies</strong> to limit by use case how those objects act on the
cluster, themselves, and other resources.</p><h3 id=limiting-resource-usage-on-a-cluster>Limiting resource usage on a cluster</h3><p><a href=/docs/concepts/policy/resource-quotas/>Resource quota</a> limits the number or capacity of
resources granted to a namespace. This is most often used to limit the amount of CPU, memory,
or persistent disk a namespace can allocate, but can also control how many pods, services, or
volumes exist in each namespace.</p><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Limit ranges</a> restrict the maximum or minimum size of some of the
resources above, to prevent users from requesting unreasonably high or low values for commonly
reserved resources like memory, or to provide default limits when none are specified.</p><h3 id=controlling-what-privileges-containers-run-with>Controlling what privileges containers run with</h3><p>A pod definition contains a <a href=/docs/tasks/configure-pod-container/security-context/>security context</a>
that allows it to request access to run as a specific Linux user on a node (like root),
access to run privileged or access the host network, and other controls that would otherwise
allow it to run unfettered on a hosting node.</p><p>You can configure <a href=/docs/concepts/security/pod-security-admission/>Pod security admission</a>
to enforce use of a particular <a href=/docs/concepts/security/pod-security-standards/>Pod Security Standard</a>
in a <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespace>namespace</a>, or to detect breaches.</p><p>Generally, most application workloads need limited access to host resources so they can
successfully run as a root process (uid 0) without access to host information. However,
considering the privileges associated with the root user, you should write application
containers to run as a non-root user. Similarly, administrators who wish to prevent
client applications from escaping their containers should apply the <strong>Baseline</strong>
or <strong>Restricted</strong> Pod Security Standard.</p><h3 id=preventing-containers-from-loading-unwanted-kernel-modules>Preventing containers from loading unwanted kernel modules</h3><p>The Linux kernel automatically loads kernel modules from disk if needed in certain
circumstances, such as when a piece of hardware is attached or a filesystem is mounted. Of
particular relevance to Kubernetes, even unprivileged processes can cause certain
network-protocol-related kernel modules to be loaded, just by creating a socket of the
appropriate type. This may allow an attacker to exploit a security hole in a kernel module
that the administrator assumed was not in use.</p><p>To prevent specific modules from being automatically loaded, you can uninstall them from
the node, or add rules to block them. On most Linux distributions, you can do that by
creating a file such as <code>/etc/modprobe.d/kubernetes-blacklist.conf</code> with contents like:</p><pre tabindex=0><code># DCCP is unlikely to be needed, has had multiple serious
# vulnerabilities, and is not well-maintained.
blacklist dccp

# SCTP is not used in most Kubernetes clusters, and has also had
# vulnerabilities in the past.
blacklist sctp
</code></pre><p>To block module loading more generically, you can use a Linux Security Module (such as
SELinux) to completely deny the <code>module_request</code> permission to containers, preventing the
kernel from loading modules for containers under any circumstances. (Pods would still be
able to use modules that had been loaded manually, or modules that were loaded by the
kernel on behalf of some more-privileged process.)</p><h3 id=restricting-network-access>Restricting network access</h3><p>The <a href=/docs/tasks/administer-cluster/declare-network-policy/>network policies</a> for a namespace
allows application authors to restrict which pods in other namespaces may access pods and ports
within their namespaces. Many of the supported <a href=/docs/concepts/cluster-administration/networking/>Kubernetes networking providers</a>
now respect network policy.</p><p>Quota and limit ranges can also be used to control whether users may request node ports or
load-balanced services, which on many clusters can control whether those users applications
are visible outside of the cluster.</p><p>Additional protections may be available that control network rules on a per-plugin or per-
environment basis, such as per-node firewalls, physically separating cluster nodes to
prevent cross talk, or advanced networking policy.</p><h3 id=restricting-cloud-metadata-api-access>Restricting cloud metadata API access</h3><p>Cloud platforms (AWS, Azure, GCE, etc.) often expose metadata services locally to instances.
By default these APIs are accessible by pods running on an instance and can contain cloud
credentials for that node, or provisioning data such as kubelet credentials. These credentials
can be used to escalate within the cluster or to other cloud services under the same account.</p><p>When running Kubernetes on a cloud platform, limit permissions given to instance credentials, use
<a href=/docs/tasks/administer-cluster/declare-network-policy/>network policies</a> to restrict pod access
to the metadata API, and avoid using provisioning data to deliver secrets.</p><h3 id=controlling-which-nodes-pods-may-access>Controlling which nodes pods may access</h3><p>By default, there are no restrictions on which nodes may run a pod. Kubernetes offers a
<a href=/docs/concepts/scheduling-eviction/assign-pod-node/>rich set of policies for controlling placement of pods onto nodes</a>
and the <a href=/docs/concepts/scheduling-eviction/taint-and-toleration/>taint-based pod placement and eviction</a>
that are available to end users. For many clusters use of these policies to separate workloads
can be a convention that authors adopt or enforce via tooling.</p><p>As an administrator, a beta admission plugin <code>PodNodeSelector</code> can be used to force pods
within a namespace to default or require a specific node selector, and if end users cannot
alter namespaces, this can strongly limit the placement of all of the pods in a specific workload.</p><h2 id=protecting-cluster-components-from-compromise>Protecting cluster components from compromise</h2><p>This section describes some common patterns for protecting clusters from compromise.</p><h3 id=restrict-access-to-etcd>Restrict access to etcd</h3><p>Write access to the etcd backend for the API is equivalent to gaining root on the entire cluster,
and read access can be used to escalate fairly quickly. Administrators should always use strong
credentials from the API servers to their etcd server, such as mutual auth via TLS client certificates,
and it is often recommended to isolate the etcd servers behind a firewall that only the API servers
may access.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Allowing other components within the cluster to access the master etcd instance with
read or write access to the full keyspace is equivalent to granting cluster-admin access. Using
separate etcd instances for non-master components or using etcd ACLs to restrict read and write
access to a subset of the keyspace is strongly recommended.</div><h3 id=enable-audit-logging>Enable audit logging</h3><p>The <a href=/docs/tasks/debug/debug-cluster/audit/>audit logger</a> is a beta feature that records actions taken by the
API for later analysis in the event of a compromise. It is recommended to enable audit logging
and archive the audit file on a secure server.</p><h3 id=restrict-access-to-alpha-or-beta-features>Restrict access to alpha or beta features</h3><p>Alpha and beta Kubernetes features are in active development and may have limitations or bugs
that result in security vulnerabilities. Always assess the value an alpha or beta feature may
provide against the possible risk to your security posture. When in doubt, disable features you
do not use.</p><h3 id=rotate-infrastructure-credentials-frequently>Rotate infrastructure credentials frequently</h3><p>The shorter the lifetime of a secret or credential the harder it is for an attacker to make
use of that credential. Set short lifetimes on certificates and automate their rotation. Use
an authentication provider that can control how long issued tokens are available and use short
lifetimes where possible. If you use service-account tokens in external integrations, plan to
rotate those tokens frequently. For example, once the bootstrap phase is complete, a bootstrap
token used for setting up nodes should be revoked or its authorization removed.</p><h3 id=review-third-party-integrations-before-enabling-them>Review third party integrations before enabling them</h3><p>Many third party integrations to Kubernetes may alter the security profile of your cluster. When
enabling an integration, always review the permissions that an extension requests before granting
it access. For example, many security integrations may request access to view all secrets on
your cluster which is effectively making that component a cluster admin. When in doubt,
restrict the integration to functioning in a single namespace if possible.</p><p>Components that create pods may also be unexpectedly powerful if they can do so inside namespaces
like the <code>kube-system</code> namespace, because those pods can gain access to service account secrets
or run with elevated permissions if those service accounts are granted access to permissive
<a href=/docs/concepts/security/pod-security-policy/>PodSecurityPolicies</a>.</p><p>If you use <a href=/docs/concepts/security/pod-security-admission/>Pod Security admission</a> and allow
any component to create Pods within a namespace that permits privileged Pods, those Pods may
be able to escape their containers and use this widened access to elevate their privileges.</p><p>You should not allow untrusted components to create Pods in any system namespace (those with
names that start with <code>kube-</code>) nor in any namespace where that access grant allows the possibility
of privilege escalation.</p><h3 id=encrypt-secrets-at-rest>Encrypt secrets at rest</h3><p>In general, the etcd database will contain any information accessible via the Kubernetes API
and may grant an attacker significant visibility into the state of your cluster. Always encrypt
your backups using a well reviewed backup and encryption solution, and consider using full disk
encryption where possible.</p><p>Kubernetes supports <a href=/docs/tasks/administer-cluster/encrypt-data/>encryption at rest</a>, a feature
introduced in 1.7, v1 beta since 1.13, and v2 alpha since 1.25. This will encrypt resources like <code>Secret</code> and <code>ConfigMap</code> in etcd, preventing
parties that gain access to your etcd backups from viewing the content of those secrets. While
this feature is currently beta, it offers an additional level of defense when backups
are not encrypted or an attacker gains read access to etcd.</p><h3 id=receiving-alerts-for-security-updates-and-reporting-vulnerabilities>Receiving alerts for security updates and reporting vulnerabilities</h3><p>Join the <a href=https://groups.google.com/forum/#!forum/kubernetes-announce>kubernetes-announce</a>
group for emails about security announcements. See the
<a href=/docs/reference/issues-security/security/>security reporting</a>
page for more on how to report vulnerabilities.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f58763cc9447491b6c40f939a02d441d>2.32 - Set Kubelet parameters via a config file</h1><p>A subset of the Kubelet's configuration parameters may be
set via an on-disk config file, as a substitute for command-line flags.</p><p>Providing parameters via a config file is the recommended approach because
it simplifies node deployment and configuration management.</p><h2 id=create-the-config-file>Create the config file</h2><p>The subset of the Kubelet's configuration that can be configured via a file
is defined by the
<a href=/docs/reference/config-api/kubelet-config.v1beta1/><code>KubeletConfiguration</code></a>
struct.</p><p>The configuration file must be a JSON or YAML representation of the parameters
in this struct. Make sure the Kubelet has read permissions on the file.</p><p>Here is an example of what this file might look like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubelet.config.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>KubeletConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>address</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;192.168.0.8&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>20250</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>serializeImagePulls</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>evictionHard</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>memory.available</span>:<span style=color:#bbb>  </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>In the example, the Kubelet is configured to serve on IP address 192.168.0.8 and port 20250, pull images in parallel,
and evict Pods when available memory drops below 200Mi. Since only one of the four evictionHard thresholds is configured,
other evictionHard thresholds are reset to 0 from their built-in defaults.
All other Kubelet configuration values are left at their built-in defaults, unless overridden
by flags. Command line flags which target the same value as a config file will override that value.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In the example, by changing the default value of only one parameter for
evictionHard, the default values of other parameters will not be inherited and
will be set to zero. In order to provide custom values, you should provide all
the threshold values respectively.</div><h2 id=start-a-kubelet-process-configured-via-the-config-file>Start a Kubelet process configured via the config file</h2><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you use kubeadm to initialize your cluster, use the kubelet-config while creating your cluster with <code>kubeadmin init</code>.
See <a href=/docs/setup/production-environment/tools/kubeadm/kubelet-integration/>configuring kubelet using kubeadm</a> for details.</div><p>Start the Kubelet with the <code>--config</code> flag set to the path of the Kubelet's config file.
The Kubelet will then load its config from this file.</p><p>Note that command line flags which target the same value as a config file will override that value.
This helps ensure backwards compatibility with the command-line API.</p><p>Note that relative file paths in the Kubelet config file are resolved relative to the
location of the Kubelet config file, whereas relative paths in command line flags are resolved
relative to the Kubelet's current working directory.</p><p>Note that some default values differ between command-line flags and the Kubelet config file.
If <code>--config</code> is provided and the values are not specified via the command line, the
defaults for the <code>KubeletConfiguration</code> version apply.
In the above example, this version is <code>kubelet.config.k8s.io/v1beta1</code>.</p><h2 id=what-s-next>What's next</h2><ul><li>Learn more about kubelet configuration by checking the
<a href=/docs/reference/config-api/kubelet-config.v1beta1/><code>KubeletConfiguration</code></a>
reference.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1e966f5d0540bbee0876f9d0d08d54dc>2.33 - Share a Cluster with Namespaces</h1><p>This page shows how to view, work in, and delete <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespaces>namespaces</a>. The page also shows how to use Kubernetes namespaces to subdivide your cluster.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>Have an <a href=/docs/setup/>existing Kubernetes cluster</a>.</li><li>You have a basic understanding of Kubernetes <a class=glossary-tooltip title='A Pod represents a set of running containers in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pods>Pods</a>, <a class=glossary-tooltip title='A way to expose an application running on a set of Pods as a network service.' data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=Services>Services</a>, and <a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployments>Deployments</a>.</li></ul><h2 id=viewing-namespaces>Viewing namespaces</h2><ol><li>List the current namespaces in a cluster using:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get namespaces
</span></span></code></pre></div><pre tabindex=0><code>NAME          STATUS    AGE
default       Active    11d
kube-system   Active    11d
kube-public   Active    11d
</code></pre><p>Kubernetes starts with three initial namespaces:</p><ul><li><code>default</code> The default namespace for objects with no other namespace</li><li><code>kube-system</code> The namespace for objects created by the Kubernetes system</li><li><code>kube-public</code> This namespace is created automatically and is readable by all users (including those not authenticated). This namespace is mostly reserved for cluster usage, in case that some resources should be visible and readable publicly throughout the whole cluster. The public aspect of this namespace is only a convention, not a requirement.</li></ul><p>You can also get the summary of a specific namespace using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get namespaces &lt;name&gt;
</span></span></code></pre></div><p>Or you can get detailed information with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe namespaces &lt;name&gt;
</span></span></code></pre></div><pre tabindex=0><code>Name:           default
Labels:         &lt;none&gt;
Annotations:    &lt;none&gt;
Status:         Active

No resource quota.

Resource Limits
 Type       Resource    Min Max Default
 ----               --------    --- --- ---
 Container          cpu         -   -   100m
</code></pre><p>Note that these details show both resource quota (if present) as well as resource limit ranges.</p><p>Resource quota tracks aggregate usage of resources in the <em>Namespace</em> and allows cluster operators
to define <em>Hard</em> resource usage limits that a <em>Namespace</em> may consume.</p><p>A limit range defines min/max constraints on the amount of resources a single entity can consume in
a <em>Namespace</em>.</p><p>See <a href=https://git.k8s.io/design-proposals-archive/resource-management/admission_control_limit_range.md>Admission control: Limit Range</a></p><p>A namespace can be in one of two phases:</p><ul><li><code>Active</code> the namespace is in use</li><li><code>Terminating</code> the namespace is being deleted, and can not be used for new objects</li></ul><p>For more details, see <a href=/docs/reference/kubernetes-api/cluster-resources/namespace-v1/>Namespace</a>
in the API reference.</p><h2 id=creating-a-new-namespace>Creating a new namespace</h2><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Avoid creating namespace with prefix <code>kube-</code>, since it is reserved for Kubernetes system namespaces.</div><ol><li><p>Create a new YAML file called <code>my-namespace.yaml</code> with the contents:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>&lt;insert-namespace-name-here&gt;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Then run:</p><pre tabindex=0><code>kubectl create -f ./my-namespace.yaml
</code></pre></li><li><p>Alternatively, you can create namespace using below command:</p><pre tabindex=0><code>kubectl create namespace &lt;insert-namespace-name-here&gt;
</code></pre></li></ol><p>The name of your namespace must be a valid
<a href=/docs/concepts/overview/working-with-objects/names#dns-label-names>DNS label</a>.</p><p>There's an optional field <code>finalizers</code>, which allows observables to purge resources whenever the namespace is deleted. Keep in mind that if you specify a nonexistent finalizer, the namespace will be created but will get stuck in the <code>Terminating</code> state if the user tries to delete it.</p><p>More information on <code>finalizers</code> can be found in the namespace <a href=https://git.k8s.io/design-proposals-archive/architecture/namespaces.md#finalizers>design doc</a>.</p><h2 id=deleting-a-namespace>Deleting a namespace</h2><p>Delete a namespace with</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespaces &lt;insert-some-namespace-name&gt;
</span></span></code></pre></div><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> This deletes <em>everything</em> under the namespace!</div><p>This delete is asynchronous, so for a time you will see the namespace in the <code>Terminating</code> state.</p><h2 id=subdividing-your-cluster-using-kubernetes-namespaces>Subdividing your cluster using Kubernetes namespaces</h2><ol><li><p>Understand the default namespace</p><p>By default, a Kubernetes cluster will instantiate a default namespace when provisioning the cluster to hold the default set of Pods,
Services, and Deployments used by the cluster.</p><p>Assuming you have a fresh cluster, you can introspect the available namespaces by doing the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get namespaces
</span></span></code></pre></div><pre tabindex=0><code>NAME      STATUS    AGE
default   Active    13m
</code></pre></li><li><p>Create new namespaces</p><p>For this exercise, we will create two additional Kubernetes namespaces to hold our content.</p><p>In a scenario where an organization is using a shared Kubernetes cluster for development and production use cases:</p><p>The development team would like to maintain a space in the cluster where they can get a view on the list of Pods, Services, and Deployments
they use to build and run their application. In this space, Kubernetes resources come and go, and the restrictions on who can or cannot modify resources
are relaxed to enable agile development.</p><p>The operations team would like to maintain a space in the cluster where they can enforce strict procedures on who can or cannot manipulate the set of
Pods, Services, and Deployments that run the production site.</p><p>One pattern this organization could follow is to partition the Kubernetes cluster into two namespaces: <code>development</code> and <code>production</code>.</p><p>Let's create two new namespaces to hold our work.</p><p>Create the <code>development</code> namespace using kubectl:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/admin/namespace-dev.json
</span></span></code></pre></div><p>And then let's create the <code>production</code> namespace using kubectl:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/admin/namespace-prod.json
</span></span></code></pre></div><p>To be sure things are right, list all of the namespaces in our cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get namespaces --show-labels
</span></span></code></pre></div><pre tabindex=0><code>NAME          STATUS    AGE       LABELS
default       Active    32m       &lt;none&gt;
development   Active    29s       name=development
production    Active    23s       name=production
</code></pre></li><li><p>Create pods in each namespace</p><p>A Kubernetes namespace provides the scope for Pods, Services, and Deployments in the cluster.</p><p>Users interacting with one namespace do not see the content in another namespace.</p><p>To demonstrate this, let's spin up a simple Deployment and Pods in the <code>development</code> namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create deployment snowflake --image<span style=color:#666>=</span>registry.k8s.io/serve_hostname  -n<span style=color:#666>=</span>development --replicas<span style=color:#666>=</span><span style=color:#666>2</span>
</span></span></code></pre></div><p>We have created a deployment whose replica size is 2 that is running the pod called <code>snowflake</code> with a basic container that serves the hostname.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment -n<span style=color:#666>=</span>development
</span></span></code></pre></div><pre tabindex=0><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
snowflake    2/2     2            2           2m
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>snowflake -n<span style=color:#666>=</span>development
</span></span></code></pre></div><pre tabindex=0><code>NAME                         READY     STATUS    RESTARTS   AGE
snowflake-3968820950-9dgr8   1/1       Running   0          2m
snowflake-3968820950-vgc4n   1/1       Running   0          2m
</code></pre><p>And this is great, developers are able to do what they want, and they do not have to worry about affecting content in the <code>production</code> namespace.</p><p>Let's switch to the <code>production</code> namespace and show how resources in one namespace are hidden from the other.</p><p>The <code>production</code> namespace should be empty, and the following commands should return nothing.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment -n<span style=color:#666>=</span>production
</span></span><span style=display:flex><span>kubectl get pods -n<span style=color:#666>=</span>production
</span></span></code></pre></div><p>Production likes to run cattle, so let's create some cattle pods.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create deployment cattle --image<span style=color:#666>=</span>registry.k8s.io/serve_hostname -n<span style=color:#666>=</span>production
</span></span><span style=display:flex><span>kubectl scale deployment cattle --replicas<span style=color:#666>=</span><span style=color:#666>5</span> -n<span style=color:#666>=</span>production
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get deployment -n<span style=color:#666>=</span>production
</span></span></code></pre></div><pre tabindex=0><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
cattle       5/5     5            5           10s
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>cattle -n<span style=color:#666>=</span>production
</span></span></code></pre></div><pre tabindex=0><code>NAME                      READY     STATUS    RESTARTS   AGE
cattle-2263376956-41xy6   1/1       Running   0          34s
cattle-2263376956-kw466   1/1       Running   0          34s
cattle-2263376956-n4v97   1/1       Running   0          34s
cattle-2263376956-p5p3i   1/1       Running   0          34s
cattle-2263376956-sxpth   1/1       Running   0          34s
</code></pre></li></ol><p>At this point, it should be clear that the resources users create in one namespace are hidden from the other namespace.</p><p>As the policy support in Kubernetes evolves, we will extend this scenario to show how you can provide different
authorization rules for each namespace.</p><h2 id=understanding-the-motivation-for-using-namespaces>Understanding the motivation for using namespaces</h2><p>A single cluster should be able to satisfy the needs of multiple users or groups of users (henceforth a 'user community').</p><p>Kubernetes <em>namespaces</em> help different projects, teams, or customers to share a Kubernetes cluster.</p><p>It does this by providing the following:</p><ol><li>A scope for <a href=/docs/concepts/overview/working-with-objects/names/>Names</a>.</li><li>A mechanism to attach authorization and policy to a subsection of the cluster.</li></ol><p>Use of multiple namespaces is optional.</p><p>Each user community wants to be able to work in isolation from other communities.</p><p>Each user community has its own:</p><ol><li>resources (pods, services, replication controllers, etc.)</li><li>policies (who can or cannot perform actions in their community)</li><li>constraints (this community is allowed this much quota, etc.)</li></ol><p>A cluster operator may create a Namespace for each unique user community.</p><p>The Namespace provides a unique scope for:</p><ol><li>named resources (to avoid basic naming collisions)</li><li>delegated management authority to trusted users</li><li>ability to limit community resource consumption</li></ol><p>Use cases include:</p><ol><li>As a cluster operator, I want to support multiple user communities on a single cluster.</li><li>As a cluster operator, I want to delegate authority to partitions of the cluster to trusted users
in those communities.</li><li>As a cluster operator, I want to limit the amount of resources each community can consume in order
to limit the impact to other communities using the cluster.</li><li>As a cluster user, I want to interact with resources that are pertinent to my user community in
isolation of what other user communities are doing on the cluster.</li></ol><h2 id=understanding-namespaces-and-dns>Understanding namespaces and DNS</h2><p>When you create a <a href=/docs/concepts/services-networking/service/>Service</a>, it creates a corresponding <a href=/docs/concepts/services-networking/dns-pod-service/>DNS entry</a>.
This entry is of the form <code>&lt;service-name>.&lt;namespace-name>.svc.cluster.local</code>, which means
that if a container uses <code>&lt;service-name></code> it will resolve to the service which
is local to a namespace. This is useful for using the same configuration across
multiple namespaces such as Development, Staging and Production. If you want to reach
across namespaces, you need to use the fully qualified domain name (FQDN).</p><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/overview/working-with-objects/namespaces/#setting-the-namespace-preference>setting the namespace preference</a>.</li><li>Learn more about <a href=/docs/concepts/overview/working-with-objects/namespaces/#setting-the-namespace-for-a-request>setting the namespace for a request</a></li><li>See <a href=https://git.k8s.io/design-proposals-archive/architecture/namespaces.md>namespaces design</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fe6b50655c29ab0b7c1ee549ff64c138>2.34 - Upgrade A Cluster</h1><p>This page provides an overview of the steps you should follow to upgrade a
Kubernetes cluster.</p><p>The way that you upgrade a cluster depends on how you initially deployed it
and on any subsequent changes.</p><p>At a high level, the steps you perform are:</p><ul><li>Upgrade the <a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a></li><li>Upgrade the nodes in your cluster</li><li>Upgrade clients such as <a class=glossary-tooltip title='A command line tool for communicating with a Kubernetes cluster.' data-toggle=tooltip data-placement=top href=/docs/user-guide/kubectl-overview/ target=_blank aria-label=kubectl>kubectl</a></li><li>Adjust manifests and other resources based on the API changes that accompany the
new Kubernetes version</li></ul><h2 id=before-you-begin>Before you begin</h2><p>You must have an existing cluster. This page is about upgrading from Kubernetes
1.24 to Kubernetes 1.25. If your cluster
is not currently running Kubernetes 1.24 then please check
the documentation for the version of Kubernetes that you plan to upgrade to.</p><h2 id=upgrade-approaches>Upgrade approaches</h2><h3 id=upgrade-kubeadm>kubeadm</h3><p>If your cluster was deployed using the <code>kubeadm</code> tool, refer to
<a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading kubeadm clusters</a>
for detailed information on how to upgrade the cluster.</p><p>Once you have upgraded the cluster, remember to
<a href=/docs/tasks/tools/>install the latest version of <code>kubectl</code></a>.</p><h3 id=manual-deployments>Manual deployments</h3><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> These steps do not account for third-party extensions such as network and storage
plugins.</div><p>You should manually update the control plane following this sequence:</p><ul><li>etcd (all instances)</li><li>kube-apiserver (all control plane hosts)</li><li>kube-controller-manager</li><li>kube-scheduler</li><li>cloud controller manager, if you use one</li></ul><p>At this point you should
<a href=/docs/tasks/tools/>install the latest version of <code>kubectl</code></a>.</p><p>For each node in your cluster, <a href=/docs/tasks/administer-cluster/safely-drain-node/>drain</a>
that node and then either replace it with a new node that uses the 1.25
kubelet, or upgrade the kubelet on that node and bring the node back into service.</p><h3 id=upgrade-other>Other deployments</h3><p>Refer to the documentation for your cluster deployment tool to learn the recommended set
up steps for maintenance.</p><h2 id=post-upgrade-tasks>Post-upgrade tasks</h2><h3 id=switch-your-cluster-s-storage-api-version>Switch your cluster's storage API version</h3><p>The objects that are serialized into etcd for a cluster's internal
representation of the Kubernetes resources active in the cluster are
written using a particular version of the API.</p><p>When the supported API changes, these objects may need to be rewritten
in the newer API. Failure to do this will eventually result in resources
that are no longer decodable or usable by the Kubernetes API server.</p><p>For each affected object, fetch it using the latest supported API and then
write it back also using the latest supported API.</p><h3 id=update-manifests>Update manifests</h3><p>Upgrading to a new Kubernetes version can provide new APIs.</p><p>You can use <code>kubectl convert</code> command to convert manifests between different API versions.
For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl convert -f pod.yaml --output-version v1
</span></span></code></pre></div><p>The <code>kubectl</code> tool replaces the contents of <code>pod.yaml</code> with a manifest that sets <code>kind</code> to
Pod (unchanged), but with a revised <code>apiVersion</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4e9de5bc3973e5d2bb8f09ff940c3319>2.35 - Use Cascading Deletion in a Cluster</h1><p>This page shows you how to specify the type of
<a href=/docs/concepts/architecture/garbage-collection/#cascading-deletion>cascading deletion</a>
to use in your cluster during <a class=glossary-tooltip title='A collective term for the various mechanisms Kubernetes uses to clean up cluster resources.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/garbage-collection/ target=_blank aria-label='garbage collection'>garbage collection</a>.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You also need to <a href=/docs/tasks/run-application/run-stateless-application-deployment/#creating-and-exploring-an-nginx-deployment>create a sample Deployment</a>
to experiment with the different types of cascading deletion. You will need to
recreate the Deployment for each type.</p><h2 id=check-owner-references-on-your-pods>Check owner references on your pods</h2><p>Check that the <code>ownerReferences</code> field is present on your pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>nginx --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output has an <code>ownerReferences</code> field similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ownerReferences</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>blockOwnerDeletion</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>controller</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ReplicaSet<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment-6b474476c4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>4fdcd81c-bd5d-41f7-97af-3a3b759af9a7<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=use-foreground-cascading-deletion>Use foreground cascading deletion</h2><p>By default, Kubernetes uses <a href=/docs/concepts/architecture/garbage-collection/#background-deletion>background cascading deletion</a>
to delete dependents of an object. You can switch to foreground cascading deletion
using either <code>kubectl</code> or the Kubernetes API, depending on the Kubernetes
version your cluster runs.
To check the version, enter <code>kubectl version</code>.</p><p>You can delete objects using foreground cascading deletion using <code>kubectl</code> or the
Kubernetes API.</p><p><strong>Using kubectl</strong></p><p>Run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deployment nginx-deployment --cascade<span style=color:#666>=</span>foreground
</span></span></code></pre></div><p><strong>Using the Kubernetes API</strong></p><ol><li><p>Start a local proxy session:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl proxy --port<span style=color:#666>=</span><span style=color:#666>8080</span>
</span></span></code></pre></div></li><li><p>Use <code>curl</code> to trigger deletion:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X DELETE localhost:8080/apis/apps/v1/namespaces/default/deployments/nginx-deployment <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -d <span style=color:#b44>&#39;{&#34;kind&#34;:&#34;DeleteOptions&#34;,&#34;apiVersion&#34;:&#34;v1&#34;,&#34;propagationPolicy&#34;:&#34;Foreground&#34;}&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -H <span style=color:#b44>&#34;Content-Type: application/json&#34;</span>
</span></span></code></pre></div><p>The output contains a <code>foregroundDeletion</code> <a class=glossary-tooltip title='A namespaced key that tells Kubernetes to wait until specific conditions are met before it fully deletes an object marked for deletion.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/finalizers/ target=_blank aria-label=finalizer>finalizer</a>
like this:</p><pre tabindex=0><code>&#34;kind&#34;: &#34;Deployment&#34;,
&#34;apiVersion&#34;: &#34;apps/v1&#34;,
&#34;metadata&#34;: {
    &#34;name&#34;: &#34;nginx-deployment&#34;,
    &#34;namespace&#34;: &#34;default&#34;,
    &#34;uid&#34;: &#34;d1ce1b02-cae8-4288-8a53-30e84d8fa505&#34;,
    &#34;resourceVersion&#34;: &#34;1363097&#34;,
    &#34;creationTimestamp&#34;: &#34;2021-07-08T20:24:37Z&#34;,
    &#34;deletionTimestamp&#34;: &#34;2021-07-08T20:27:39Z&#34;,
    &#34;finalizers&#34;: [
      &#34;foregroundDeletion&#34;
    ]
    ...
</code></pre></li></ol><h2 id=use-background-cascading-deletion>Use background cascading deletion</h2><ol><li><a href=/docs/tasks/run-application/run-stateless-application-deployment/#creating-and-exploring-an-nginx-deployment>Create a sample Deployment</a>.</li><li>Use either <code>kubectl</code> or the Kubernetes API to delete the Deployment,
depending on the Kubernetes version your cluster runs.
To check the version, enter <code>kubectl version</code>.</li></ol><p>You can delete objects using background cascading deletion using <code>kubectl</code>
or the Kubernetes API.</p><p>Kubernetes uses background cascading deletion by default, and does so
even if you run the following commands without the <code>--cascade</code> flag or the
<code>propagationPolicy</code> argument.</p><p><strong>Using kubectl</strong></p><p>Run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deployment nginx-deployment --cascade<span style=color:#666>=</span>background
</span></span></code></pre></div><p><strong>Using the Kubernetes API</strong></p><ol><li><p>Start a local proxy session:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl proxy --port<span style=color:#666>=</span><span style=color:#666>8080</span>
</span></span></code></pre></div></li><li><p>Use <code>curl</code> to trigger deletion:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X DELETE localhost:8080/apis/apps/v1/namespaces/default/deployments/nginx-deployment <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -d <span style=color:#b44>&#39;{&#34;kind&#34;:&#34;DeleteOptions&#34;,&#34;apiVersion&#34;:&#34;v1&#34;,&#34;propagationPolicy&#34;:&#34;Background&#34;}&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -H <span style=color:#b44>&#34;Content-Type: application/json&#34;</span>
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>&#34;kind&#34;: &#34;Status&#34;,
&#34;apiVersion&#34;: &#34;v1&#34;,
...
&#34;status&#34;: &#34;Success&#34;,
&#34;details&#34;: {
    &#34;name&#34;: &#34;nginx-deployment&#34;,
    &#34;group&#34;: &#34;apps&#34;,
    &#34;kind&#34;: &#34;deployments&#34;,
    &#34;uid&#34;: &#34;cc9eefb9-2d49-4445-b1c1-d261c9396456&#34;
}
</code></pre></li></ol><h2 id=set-orphan-deletion-policy>Delete owner objects and orphan dependents</h2><p>By default, when you tell Kubernetes to delete an object, the
<a class=glossary-tooltip title='A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/controller/ target=_blank aria-label=controller>controller</a> also deletes
dependent objects. You can make Kubernetes <em>orphan</em> these dependents using
<code>kubectl</code> or the Kubernetes API, depending on the Kubernetes version your
cluster runs.
To check the version, enter <code>kubectl version</code>.</p><p><strong>Using kubectl</strong></p><p>Run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deployment nginx-deployment --cascade<span style=color:#666>=</span>orphan
</span></span></code></pre></div><p><strong>Using the Kubernetes API</strong></p><ol><li><p>Start a local proxy session:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl proxy --port<span style=color:#666>=</span><span style=color:#666>8080</span>
</span></span></code></pre></div></li><li><p>Use <code>curl</code> to trigger deletion:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X DELETE localhost:8080/apis/apps/v1/namespaces/default/deployments/nginx-deployment <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -d <span style=color:#b44>&#39;{&#34;kind&#34;:&#34;DeleteOptions&#34;,&#34;apiVersion&#34;:&#34;v1&#34;,&#34;propagationPolicy&#34;:&#34;Orphan&#34;}&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -H <span style=color:#b44>&#34;Content-Type: application/json&#34;</span>
</span></span></code></pre></div><p>The output contains <code>orphan</code> in the <code>finalizers</code> field, similar to this:</p><pre tabindex=0><code>&#34;kind&#34;: &#34;Deployment&#34;,
&#34;apiVersion&#34;: &#34;apps/v1&#34;,
&#34;namespace&#34;: &#34;default&#34;,
&#34;uid&#34;: &#34;6f577034-42a0-479d-be21-78018c466f1f&#34;,
&#34;creationTimestamp&#34;: &#34;2021-07-09T16:46:37Z&#34;,
&#34;deletionTimestamp&#34;: &#34;2021-07-09T16:47:08Z&#34;,
&#34;deletionGracePeriodSeconds&#34;: 0,
&#34;finalizers&#34;: [
  &#34;orphan&#34;
],
...
</code></pre></li></ol><p>You can check that the Pods managed by the Deployment are still running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>nginx
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Learn about <a href=/docs/concepts/overview/working-with-objects/owners-dependents/>owners and dependents</a> in Kubernetes.</li><li>Learn about Kubernetes <a href=/docs/concepts/overview/working-with-objects/finalizers/>finalizers</a>.</li><li>Learn about <a href=/docs/concepts/architecture/garbage-collection/>garbage collection</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-669c88964b4a9eb2b040057266e4b60d>2.36 - Using a KMS provider for data encryption</h1><p>This page shows how to configure a Key Management Service (KMS) provider and plugin to enable secret data encryption. Currently there are two KMS API versions. KMS v1 will continue to work while v2 develops in maturity. If you are not sure which KMS API version to pick, choose v1.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>The version of Kubernetes that you need depends on which KMS API version
you have selected.</p><ul><li>If you selected KMS API v1, any supported Kubernetes version will work fine.</li><li>If you selected KMS API v2, you should use Kubernetes v1.25
(if you are running a different version of Kubernetes that also supports the v2 KMS
API, switch to the documentation for that version of Kubernetes).</li></ul>To check the version, enter <code>kubectl version</code>.<h3 id=kms-v1>KMS v1</h3><ul><li><p>Kubernetes version 1.10.0 or later is required</p></li><li><p>Your cluster must use etcd v3 or later</p></li></ul><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.12 [beta]</code></div><h3 id=kms-v2>KMS v2</h3><ul><li><p>Kubernetes version 1.25.0 or later is required</p></li><li><p>Set kube-apiserver feature gate: <code>--feature-gates=KMSv2=true</code> to configure a KMS v2 provider</p></li><li><p>Your cluster must use etcd v3 or later</p></li></ul><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [alpha]</code></div><p>The KMS encryption provider uses an envelope encryption scheme to encrypt data in etcd.
The data is encrypted using a data encryption key (DEK); a new DEK is generated for each encryption.
The DEKs are encrypted with a key encryption key (KEK) that is stored and managed in a remote KMS.
The KMS provider uses gRPC to communicate with a specific KMS plugin.
The KMS plugin, which is implemented as a gRPC server and deployed on the same host(s)
as the Kubernetes control plane, is responsible for all communication with the remote KMS.</p><h2 id=configuring-the-kms-provider>Configuring the KMS provider</h2><p>To configure a KMS provider on the API server, include a provider of type <code>kms</code> in the
<code>providers</code> array in the encryption configuration file and set the following properties:</p><h3 id=configuring-the-kms-provider-kms-v1>KMS v1</h3><ul><li><code>name</code>: Display name of the KMS plugin. Cannot be changed once set.</li><li><code>endpoint</code>: Listen address of the gRPC server (KMS plugin). The endpoint is a UNIX domain socket.</li><li><code>cachesize</code>: Number of data encryption keys (DEKs) to be cached in the clear.
When cached, DEKs can be used without another call to the KMS;
whereas DEKs that are not cached require a call to the KMS to unwrap.</li><li><code>timeout</code>: How long should <code>kube-apiserver</code> wait for kms-plugin to respond before
returning an error (default is 3 seconds).</li></ul><h3 id=configuring-the-kms-provider-kms-v2>KMS v2</h3><ul><li><code>apiVersion</code>: API Version for KMS provider (Allowed values: v2, v1 or empty. Any other value will result in an error.) Must be set to v2 to use the KMS v2 APIs.</li><li><code>name</code>: Display name of the KMS plugin. Cannot be changed once set.</li><li><code>endpoint</code>: Listen address of the gRPC server (KMS plugin). The endpoint is a UNIX domain socket.</li><li><code>cachesize</code>: Number of data encryption keys (DEKs) to be cached in the clear.
When cached, DEKs can be used without another call to the KMS;
whereas DEKs that are not cached require a call to the KMS to unwrap.</li><li><code>timeout</code>: How long should <code>kube-apiserver</code> wait for kms-plugin to respond before
returning an error (default is 3 seconds).</li></ul><p>See <a href=/docs/tasks/administer-cluster/encrypt-data>Understanding the encryption at rest configuration</a>.</p><h2 id=implementing-a-kms-plugin>Implementing a KMS plugin</h2><p>To implement a KMS plugin, you can develop a new plugin gRPC server or enable a KMS plugin
already provided by your cloud provider.
You then integrate the plugin with the remote KMS and deploy it on the Kubernetes master.</p><h3 id=enabling-the-kms-supported-by-your-cloud-provider>Enabling the KMS supported by your cloud provider</h3><p>Refer to your cloud provider for instructions on enabling the cloud provider-specific KMS plugin.</p><h3 id=developing-a-kms-plugin-grpc-server>Developing a KMS plugin gRPC server</h3><p>You can develop a KMS plugin gRPC server using a stub file available for Go. For other languages,
you use a proto file to create a stub file that you can use to develop the gRPC server code.</p><h4 id=developing-a-kms-plugin-gRPC-server-kms-v1>KMS v1</h4><ul><li><p>Using Go: Use the functions and data structures in the stub file:
<a href=https://github.com/kubernetes/kubernetes/blob/release-1.25/staging/src/k8s.io/apiserver/pkg/storage/value/encrypt/envelope/v1beta1/api.pb.go>api.pb.go</a>
to develop the gRPC server code</p></li><li><p>Using languages other than Go: Use the protoc compiler with the proto file:
<a href=https://github.com/kubernetes/kubernetes/blob/release-1.25/staging/src/k8s.io/apiserver/pkg/storage/value/encrypt/envelope/v1beta1/api.proto>api.proto</a>
to generate a stub file for the specific language</p></li></ul><h4 id=developing-a-kms-plugin-gRPC-server-kms-v2>KMS v2</h4><ul><li><p>Using Go: Use the functions and data structures in the stub file:
<a href=https://github.com/kubernetes/kubernetes/blob/release-1.25/staging/src/k8s.io/apiserver/pkg/storage/value/encrypt/envelope/v2alpha1/api.pb.go>api.pb.go</a>
to develop the gRPC server code</p></li><li><p>Using languages other than Go: Use the protoc compiler with the proto file:
<a href=https://github.com/kubernetes/kubernetes/blob/release-1.25/staging/src/k8s.io/apiserver/pkg/storage/value/encrypt/envelope/v2alpha1/api.proto>api.proto</a>
to generate a stub file for the specific language</p></li></ul><p>Then use the functions and data structures in the stub file to develop the server code.</p><h4 id=notes>Notes</h4><h5 id=developing-a-kms-plugin-gRPC-server-notes-kms-v1>KMS v1</h5><ul><li><p>kms plugin version: <code>v1beta1</code></p><p>In response to procedure call Version, a compatible KMS plugin should return <code>v1beta1</code> as <code>VersionResponse.version</code>.</p></li><li><p>message version: <code>v1beta1</code></p><p>All messages from KMS provider have the version field set to current version v1beta1.</p></li><li><p>protocol: UNIX domain socket (<code>unix</code>)</p><p>The plugin is implemented as a gRPC server that listens at UNIX domain socket. The plugin deployment should create a file on the file system to run the gRPC unix domain socket connection. The API server (gRPC client) is configured with the KMS provider (gRPC server) unix domain socket endpoint in order to communicate with it. An abstract Linux socket may be used by starting the endpoint with <code>/@</code>, i.e. <code>unix:///@foo</code>. Care must be taken when using this type of socket as they do not have concept of ACL (unlike traditional file based sockets). However, they are subject to Linux networking namespace, so will only be accessible to containers within the same pod unless host networking is used.</p></li></ul><h5 id=developing-a-kms-plugin-gRPC-server-notes-kms-v2>KMS v2</h5><ul><li><p>kms plugin version: <code>v2alpha1</code></p><p>In response to procedure call Status, a compatible KMS plugin should return <code>v2alpha1</code> as <code>StatusResponse.Version</code>, "ok" as <code>StatusResponse.Healthz</code> and a keyID (KMS KEK ID) as <code>StatusResponse.KeyID</code></p></li><li><p>protocol: UNIX domain socket (<code>unix</code>)</p><p>The plugin is implemented as a gRPC server that listens at UNIX domain socket. The plugin deployment should create a file on the file system to run the gRPC unix domain socket connection. The API server (gRPC client) is configured with the KMS provider (gRPC server) unix domain socket endpoint in order to communicate with it. An abstract Linux socket may be used by starting the endpoint with <code>/@</code>, i.e. <code>unix:///@foo</code>. Care must be taken when using this type of socket as they do not have concept of ACL (unlike traditional file based sockets). However, they are subject to Linux networking namespace, so will only be accessible to containers within the same pod unless host networking is used.</p></li></ul><h3 id=integrating-a-kms-plugin-with-the-remote-kms>Integrating a KMS plugin with the remote KMS</h3><p>The KMS plugin can communicate with the remote KMS using any protocol supported by the KMS.
All configuration data, including authentication credentials the KMS plugin uses to communicate with the remote KMS,
are stored and managed by the KMS plugin independently.
The KMS plugin can encode the ciphertext with additional metadata that may be required before sending it to the KMS for decryption.</p><h3 id=deploying-the-kms-plugin>Deploying the KMS plugin</h3><p>Ensure that the KMS plugin runs on the same host(s) as the Kubernetes master(s).</p><h2 id=encrypting-your-data-with-the-kms-provider>Encrypting your data with the KMS provider</h2><p>To encrypt the data:</p><ol><li><p>Create a new <code>EncryptionConfiguration</code> file using the appropriate properties for the <code>kms</code> provider to encrypt resources like Secrets and ConfigMaps.</p></li><li><p>Set the <code>--encryption-provider-config</code> flag on the kube-apiserver to point to the location of the configuration file.</p></li><li><p>Restart your API server.</p></li></ol><h3 id=encrypting-your-data-with-the-kms-provider-kms-v1>KMS v1</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EncryptionConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- secrets<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>providers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>kms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>myKmsPluginFoo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>endpoint</span>:<span style=color:#bbb> </span>unix:///tmp/socketfile.sock<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cachesize</span>:<span style=color:#bbb> </span><span style=color:#666>100</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>timeout</span>:<span style=color:#bbb> </span>3s<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>kms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>myKmsPluginBar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>endpoint</span>:<span style=color:#bbb> </span>unix:///tmp/socketfile.sock<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cachesize</span>:<span style=color:#bbb> </span><span style=color:#666>100</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>timeout</span>:<span style=color:#bbb> </span>3s<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=encrypting-your-data-with-the-kms-provider-kms-v2>KMS v2</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EncryptionConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- secrets<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>providers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>kms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>myKmsPluginFoo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>endpoint</span>:<span style=color:#bbb> </span>unix:///tmp/socketfile.sock<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cachesize</span>:<span style=color:#bbb> </span><span style=color:#666>100</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>timeout</span>:<span style=color:#bbb> </span>3s<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>kms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>myKmsPluginBar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>endpoint</span>:<span style=color:#bbb> </span>unix:///tmp/socketfile.sock<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cachesize</span>:<span style=color:#bbb> </span><span style=color:#666>100</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>timeout</span>:<span style=color:#bbb> </span>3s<span style=color:#bbb>
</span></span></span></code></pre></div><p>Until the steps defined in <a href=#ensuring-all-secrets-are-encrypted>Ensuring all secrets are encrypted</a> are performed, the <code>providers</code> list should end with the <code>identity: {}</code> provider to allow unencrypted data to be read. Once all resources are encrypted, the <code>identity</code> provider should be removed to prevent the API server from honoring unencrypted data.</p><p>For details about the <code>EncryptionConfiguration</code> format, please check the
<a href=/docs/reference/config-api/apiserver-encryption.v1/>API server encryption API reference</a>.</p><h2 id=verifying-that-the-data-is-encrypted>Verifying that the data is encrypted</h2><p>Data is encrypted when written to etcd. After restarting your <code>kube-apiserver</code>,
any newly created or updated secret should be encrypted when stored. To verify,
you can use the <code>etcdctl</code> command line program to retrieve the contents of your secret.</p><ol><li><p>Create a new secret called <code>secret1</code> in the <code>default</code> namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic secret1 -n default --from-literal<span style=color:#666>=</span><span style=color:#b8860b>mykey</span><span style=color:#666>=</span>mydata
</span></span></code></pre></div></li><li><p>Using the <code>etcdctl</code> command line, read that secret out of etcd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>ETCDCTL_API</span><span style=color:#666>=</span><span style=color:#666>3</span> etcdctl get /kubernetes.io/secrets/default/secret1 <span style=color:#666>[</span>...<span style=color:#666>]</span> | hexdump -C
</span></span></code></pre></div><p>where <code>[...]</code> contains the additional arguments for connecting to the etcd server.</p></li><li><p>Verify the stored secret is prefixed with <code>k8s:enc:kms:v1:</code> for KMS v1 or prefixed with <code>k8s:enc:kms:v2:</code> for KMS v2, which indicates that the <code>kms</code> provider has encrypted the resulting data.</p></li><li><p>Verify that the secret is correctly decrypted when retrieved via the API:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe secret secret1 -n default
</span></span></code></pre></div><p>The Secret should contain <code>mykey: mydata</code></p></li></ol><h2 id=ensuring-all-secrets-are-encrypted>Ensuring all secrets are encrypted</h2><p>Because secrets are encrypted on write, performing an update on a secret encrypts that content.</p><p>The following command reads all secrets and then updates them to apply server side encryption.
If an error occurs due to a conflicting write, retry the command.
For larger clusters, you may wish to subdivide the secrets by namespace or script an update.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secrets --all-namespaces -o json | kubectl replace -f -
</span></span></code></pre></div><h2 id=switching-from-a-local-encryption-provider-to-the-kms-provider>Switching from a local encryption provider to the KMS provider</h2><p>To switch from a local encryption provider to the <code>kms</code> provider and re-encrypt all of the secrets:</p><ol><li><p>Add the <code>kms</code> provider as the first entry in the configuration file as shown in the following example.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EncryptionConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- secrets<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>providers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>kms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name </span>:<span style=color:#bbb> </span>myKmsPlugin<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>endpoint</span>:<span style=color:#bbb> </span>unix:///tmp/socketfile.sock<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cachesize</span>:<span style=color:#bbb> </span><span style=color:#666>100</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>aescbc</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>keys</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>key1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb> </span>&lt;BASE 64 ENCODED SECRET&gt;<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Restart all <code>kube-apiserver</code> processes.</p></li><li><p>Run the following command to force all secrets to be re-encrypted using the <code>kms</code> provider.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secrets --all-namespaces -o json | kubectl replace -f -
</span></span></code></pre></div></li></ol><h2 id=disabling-encryption-at-rest>Disabling encryption at rest</h2><p>To disable encryption at rest:</p><ol><li><p>Place the <code>identity</code> provider as the first entry in the configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EncryptionConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- secrets<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>providers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>identity</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>kms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name </span>:<span style=color:#bbb> </span>myKmsPlugin<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>endpoint</span>:<span style=color:#bbb> </span>unix:///tmp/socketfile.sock<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cachesize</span>:<span style=color:#bbb> </span><span style=color:#666>100</span><span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Restart all <code>kube-apiserver</code> processes.</p></li><li><p>Run the following command to force all secrets to be decrypted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secrets --all-namespaces -o json | kubectl replace -f -
</span></span></code></pre></div></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-e1afcdac8d5e8458274b3c481c5ebcda>2.37 - Using CoreDNS for Service Discovery</h1><p>This page describes the CoreDNS upgrade process and how to install CoreDNS instead of kube-dns.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.9.
To check the version, enter <code>kubectl version</code>.</p><h2 id=about-coredns>About CoreDNS</h2><p><a href=https://coredns.io>CoreDNS</a> is a flexible, extensible DNS server
that can serve as the Kubernetes cluster DNS.
Like Kubernetes, the CoreDNS project is hosted by the
<a class=glossary-tooltip title='Cloud Native Computing Foundation' data-toggle=tooltip data-placement=top href=https://cncf.io/ target=_blank aria-label=CNCF>CNCF</a>.</p><p>You can use CoreDNS instead of kube-dns in your cluster by replacing
kube-dns in an existing deployment, or by using tools like kubeadm
that will deploy and upgrade the cluster for you.</p><h2 id=installing-coredns>Installing CoreDNS</h2><p>For manual deployment or replacement of kube-dns, see the documentation at the
<a href=https://github.com/coredns/deployment/tree/master/kubernetes>CoreDNS GitHub project.</a></p><h2 id=migrating-to-coredns>Migrating to CoreDNS</h2><h3 id=upgrading-an-existing-cluster-with-kubeadm>Upgrading an existing cluster with kubeadm</h3><p>In Kubernetes version 1.21, kubeadm removed its support for <code>kube-dns</code> as a DNS application.
For <code>kubeadm</code> v1.25, the only supported cluster DNS application
is CoreDNS.</p><p>You can move to CoreDNS when you use <code>kubeadm</code> to upgrade a cluster that is
using <code>kube-dns</code>. In this case, <code>kubeadm</code> generates the CoreDNS configuration
("Corefile") based upon the <code>kube-dns</code> ConfigMap, preserving configurations for
stub domains, and upstream name server.</p><h2 id=upgrading-coredns>Upgrading CoreDNS</h2><p>You can check the version of CoreDNS that kubeadm installs for each version of
Kubernetes in the page
<a href=https://github.com/coredns/deployment/blob/master/kubernetes/CoreDNS-k8s_version.md>CoreDNS version in Kubernetes</a>.</p><p>CoreDNS can be upgraded manually in case you want to only upgrade CoreDNS
or use your own custom image.
There is a helpful <a href=https://github.com/coredns/deployment/blob/master/kubernetes/Upgrading_CoreDNS.md>guideline and walkthrough</a>
available to ensure a smooth upgrade.
Make sure the existing CoreDNS configuration ("Corefile") is retained when
upgrading your cluster.</p><p>If you are upgrading your cluster using the <code>kubeadm</code> tool, <code>kubeadm</code>
can take care of retaining the existing CoreDNS configuration automatically.</p><h2 id=tuning-coredns>Tuning CoreDNS</h2><p>When resource utilisation is a concern, it may be useful to tune the
configuration of CoreDNS. For more details, check out the
<a href=https://github.com/coredns/deployment/blob/master/kubernetes/Scaling_CoreDNS.md>documentation on scaling CoreDNS</a>.</p><h2 id=what-s-next>What's next</h2><p>You can configure <a href=https://coredns.io>CoreDNS</a> to support many more use cases than
kube-dns does by modifying the CoreDNS configuration ("Corefile").
For more information, see the <a href=https://coredns.io/plugins/kubernetes/>documentation</a>
for the <code>kubernetes</code> CoreDNS plugin, or read the
<a href=https://coredns.io/2017/05/08/custom-dns-entries-for-kubernetes/>Custom DNS Entries for Kubernetes</a>.
in the CoreDNS blog.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9ceed97f912df7289ed8872e290cfbad>2.38 - Using NodeLocal DNSCache in Kubernetes Clusters</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [stable]</code></div><p>This page provides an overview of NodeLocal DNSCache feature in Kubernetes.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=introduction>Introduction</h2><p>NodeLocal DNSCache improves Cluster DNS performance by running a DNS caching agent
on cluster nodes as a DaemonSet. In today's architecture, Pods in 'ClusterFirst' DNS mode
reach out to a kube-dns <code>serviceIP</code> for DNS queries. This is translated to a
kube-dns/CoreDNS endpoint via iptables rules added by kube-proxy.
With this new architecture, Pods will reach out to the DNS caching agent
running on the same node, thereby avoiding iptables DNAT rules and connection tracking.
The local caching agent will query kube-dns service for cache misses of cluster
hostnames ("<code>cluster.local</code>" suffix by default).</p><h2 id=motivation>Motivation</h2><ul><li><p>With the current DNS architecture, it is possible that Pods with the highest DNS QPS
have to reach out to a different node, if there is no local kube-dns/CoreDNS instance.
Having a local cache will help improve the latency in such scenarios.</p></li><li><p>Skipping iptables DNAT and connection tracking will help reduce
<a href=https://github.com/kubernetes/kubernetes/issues/56903>conntrack races</a>
and avoid UDP DNS entries filling up conntrack table.</p></li><li><p>Connections from the local caching agent to kube-dns service can be upgraded to TCP.
TCP conntrack entries will be removed on connection close in contrast with
UDP entries that have to timeout
(<a href=https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt>default</a>
<code>nf_conntrack_udp_timeout</code> is 30 seconds)</p></li><li><p>Upgrading DNS queries from UDP to TCP would reduce tail latency attributed to
dropped UDP packets and DNS timeouts usually up to 30s (3 retries + 10s timeout).
Since the nodelocal cache listens for UDP DNS queries, applications don't need to be changed.</p></li><li><p>Metrics & visibility into DNS requests at a node level.</p></li><li><p>Negative caching can be re-enabled, thereby reducing the number of queries for the kube-dns service.</p></li></ul><h2 id=architecture-diagram>Architecture Diagram</h2><p>This is the path followed by DNS Queries after NodeLocal DNSCache is enabled:</p><figure class=diagram-medium><img src=/images/docs/nodelocaldns.svg alt="NodeLocal DNSCache flow"><figcaption><h4>Nodelocal DNSCache flow</h4><p>This image shows how NodeLocal DNSCache handles DNS queries.</p></figcaption></figure><h2 id=configuration>Configuration</h2><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The local listen IP address for NodeLocal DNSCache can be any address that
can be guaranteed to not collide with any existing IP in your cluster.
It's recommended to use an address with a local scope, for example,
from the 'link-local' range '169.254.0.0/16' for IPv4 or from the
'Unique Local Address' range in IPv6 'fd00::/8'.</div><p>This feature can be enabled using the following steps:</p><ul><li><p>Prepare a manifest similar to the sample
<a href=https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml><code>nodelocaldns.yaml</code></a>
and save it as <code>nodelocaldns.yaml.</code></p></li><li><p>If using IPv6, the CoreDNS configuration file needs to enclose all the IPv6 addresses
into square brackets if used in 'IP:Port' format.
If you are using the sample manifest from the previous point, this will require you to modify
<a href=https://github.com/kubernetes/kubernetes/blob/b2ecd1b3a3192fbbe2b9e348e095326f51dc43dd/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml#L70>the configuration line L70</a>
like this: "<code>health [__PILLAR__LOCAL__DNS__]:8080</code>"</p></li><li><p>Substitute the variables in the manifest with the right values:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>kubedns</span><span style=color:#666>=</span><span style=color:#b44>`</span>kubectl get svc kube-dns -n kube-system -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>={</span>.spec.clusterIP<span style=color:#666>}</span><span style=color:#b44>`</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>domain</span><span style=color:#666>=</span>&lt;cluster-domain&gt;
</span></span><span style=display:flex><span><span style=color:#b8860b>localdns</span><span style=color:#666>=</span>&lt;node-local-address&gt;
</span></span></code></pre></div><p><code>&lt;cluster-domain></code> is "<code>cluster.local</code>" by default. <code>&lt;node-local-address></code> is the
local listen IP address chosen for NodeLocal DNSCache.</p><ul><li><p>If kube-proxy is running in IPTABLES mode:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sed -i <span style=color:#b44>&#34;s/__PILLAR__LOCAL__DNS__/</span><span style=color:#b8860b>$localdns</span><span style=color:#b44>/g; s/__PILLAR__DNS__DOMAIN__/</span><span style=color:#b8860b>$domain</span><span style=color:#b44>/g; s/__PILLAR__DNS__SERVER__/</span><span style=color:#b8860b>$kubedns</span><span style=color:#b44>/g&#34;</span> nodelocaldns.yaml
</span></span></code></pre></div><p><code>__PILLAR__CLUSTER__DNS__</code> and <code>__PILLAR__UPSTREAM__SERVERS__</code> will be populated by
the <code>node-local-dns</code> pods.
In this mode, the <code>node-local-dns</code> pods listen on both the kube-dns service IP
as well as <code>&lt;node-local-address></code>, so pods can look up DNS records using either IP address.</p></li><li><p>If kube-proxy is running in IPVS mode:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sed -i <span style=color:#b44>&#34;s/__PILLAR__LOCAL__DNS__/</span><span style=color:#b8860b>$localdns</span><span style=color:#b44>/g; s/__PILLAR__DNS__DOMAIN__/</span><span style=color:#b8860b>$domain</span><span style=color:#b44>/g; s/,__PILLAR__DNS__SERVER__//g; s/__PILLAR__CLUSTER__DNS__/</span><span style=color:#b8860b>$kubedns</span><span style=color:#b44>/g&#34;</span> nodelocaldns.yaml
</span></span></code></pre></div><p>In this mode, the <code>node-local-dns</code> pods listen only on <code>&lt;node-local-address></code>.
The <code>node-local-dns</code> interface cannot bind the kube-dns cluster IP since the
interface used for IPVS loadbalancing already uses this address.
<code>__PILLAR__UPSTREAM__SERVERS__</code> will be populated by the node-local-dns pods.</p></li></ul></li><li><p>Run <code>kubectl create -f nodelocaldns.yaml</code></p></li><li><p>If using kube-proxy in IPVS mode, <code>--cluster-dns</code> flag to kubelet needs to be modified
to use <code>&lt;node-local-address></code> that NodeLocal DNSCache is listening on.
Otherwise, there is no need to modify the value of the <code>--cluster-dns</code> flag,
since NodeLocal DNSCache listens on both the kube-dns service IP as well as
<code>&lt;node-local-address></code>.</p></li></ul><p>Once enabled, the <code>node-local-dns</code> Pods will run in the <code>kube-system</code> namespace
on each of the cluster nodes. This Pod runs <a href=https://github.com/coredns/coredns>CoreDNS</a>
in cache mode, so all CoreDNS metrics exposed by the different plugins will
be available on a per-node basis.</p><p>You can disable this feature by removing the DaemonSet, using <code>kubectl delete -f &lt;manifest></code>.
You should also revert any changes you made to the kubelet configuration.</p><h2 id=stubdomains-and-upstream-server-configuration>StubDomains and Upstream server Configuration</h2><p>StubDomains and upstream servers specified in the <code>kube-dns</code> ConfigMap in the <code>kube-system</code> namespace
are automatically picked up by <code>node-local-dns</code> pods. The ConfigMap contents need to follow the format
shown in <a href=/docs/tasks/administer-cluster/dns-custom-nameservers/#example-1>the example</a>.
The <code>node-local-dns</code> ConfigMap can also be modified directly with the stubDomain configuration
in the Corefile format. Some cloud providers might not allow modifying <code>node-local-dns</code> ConfigMap directly.
In those cases, the <code>kube-dns</code> ConfigMap can be updated.</p><h2 id=setting-memory-limits>Setting memory limits</h2><p>The <code>node-local-dns</code> Pods use memory for storing cache entries and processing queries.
Since they do not watch Kubernetes objects, the cluster size or the number of Services / EndpointSlices do not directly affect memory usage. Memory usage is influenced by the DNS query pattern.
From <a href=https://github.com/coredns/deployment/blob/master/kubernetes/Scaling_CoreDNS.md>CoreDNS docs</a>,</p><blockquote><p>The default cache size is 10000 entries, which uses about 30 MB when completely filled.</p></blockquote><p>This would be the memory usage for each server block (if the cache gets completely filled).
Memory usage can be reduced by specifying smaller cache sizes.</p><p>The number of concurrent queries is linked to the memory demand, because each extra
goroutine used for handling a query requires an amount of memory. You can set an upper limit
using the <code>max_concurrent</code> option in the forward plugin.</p><p>If a <code>node-local-dns</code> Pod attempts to use more memory than is available (because of total system
resources, or because of a configured
<a href=/docs/concepts/configuration/manage-resources-containers/>resource limit</a>), the operating system
may shut down that pod's container.
If this happens, the container that is terminated (“OOMKilled”) does not clean up the custom
packet filtering rules that it previously added during startup.
The <code>node-local-dns</code> container should get restarted (since managed as part of a DaemonSet), but this
will lead to a brief DNS downtime each time that the container fails: the packet filtering rules direct
DNS queries to a local Pod that is unhealthy.</p><p>You can determine a suitable memory limit by running node-local-dns pods without a limit and
measuring the peak usage. You can also set up and use a
<a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler>VerticalPodAutoscaler</a>
in <em>recommender mode</em>, and then check its recommendations.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-fe5ad73163d38596340536ec03a205f0>2.39 - Using sysctls in a Kubernetes Cluster</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.21 [stable]</code></div><p>This document describes how to configure and use kernel parameters within a
Kubernetes cluster using the <a class=glossary-tooltip title='An interface for getting and setting Unix kernel parameters' data-toggle=tooltip data-placement=top href=/docs/tasks/administer-cluster/sysctl-cluster/ target=_blank aria-label=sysctl>sysctl</a>
interface.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Starting from Kubernetes version 1.23, the kubelet supports the use of either <code>/</code> or <code>.</code>
as separators for sysctl names.
Starting from Kubernetes version 1.25, setting Sysctls for a Pod supports setting sysctls with slashes.
For example, you can represent the same sysctl name as <code>kernel.shm_rmid_forced</code> using a
period as the separator, or as <code>kernel/shm_rmid_forced</code> using a slash as a separator.
For more sysctl parameter conversion method details, please refer to
the page <a href=https://man7.org/linux/man-pages/man5/sysctl.d.5.html>sysctl.d(5)</a> from
the Linux man-pages project.</div><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>For some steps, you also need to be able to reconfigure the command line
options for the kubelets running on your cluster.</p><h2 id=listing-all-sysctl-parameters>Listing all Sysctl Parameters</h2><p>In Linux, the sysctl interface allows an administrator to modify kernel
parameters at runtime. Parameters are available via the <code>/proc/sys/</code> virtual
process file system. The parameters cover various subsystems such as:</p><ul><li>kernel (common prefix: <code>kernel.</code>)</li><li>networking (common prefix: <code>net.</code>)</li><li>virtual memory (common prefix: <code>vm.</code>)</li><li>MDADM (common prefix: <code>dev.</code>)</li><li>More subsystems are described in <a href=https://www.kernel.org/doc/Documentation/sysctl/README>Kernel docs</a>.</li></ul><p>To get a list of all parameters, you can run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo sysctl -a
</span></span></code></pre></div><h2 id=enabling-unsafe-sysctls>Enabling Unsafe Sysctls</h2><p>Sysctls are grouped into <em>safe</em> and <em>unsafe</em> sysctls. In addition to proper
namespacing, a <em>safe</em> sysctl must be properly <em>isolated</em> between pods on the
same node. This means that setting a <em>safe</em> sysctl for one pod</p><ul><li>must not have any influence on any other pod on the node</li><li>must not allow to harm the node's health</li><li>must not allow to gain CPU or memory resources outside of the resource limits
of a pod.</li></ul><p>By far, most of the <em>namespaced</em> sysctls are not necessarily considered <em>safe</em>.
The following sysctls are supported in the <em>safe</em> set:</p><ul><li><code>kernel.shm_rmid_forced</code>,</li><li><code>net.ipv4.ip_local_port_range</code>,</li><li><code>net.ipv4.tcp_syncookies</code>,</li><li><code>net.ipv4.ping_group_range</code> (since Kubernetes 1.18),</li><li><code>net.ipv4.ip_unprivileged_port_start</code> (since Kubernetes 1.22).</li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The example <code>net.ipv4.tcp_syncookies</code> is not namespaced on Linux kernel version 4.4 or lower.</div><p>This list will be extended in future Kubernetes versions when the kubelet
supports better isolation mechanisms.</p><p>All <em>safe</em> sysctls are enabled by default.</p><p>All <em>unsafe</em> sysctls are disabled by default and must be allowed manually by the
cluster admin on a per-node basis. Pods with disabled unsafe sysctls will be
scheduled, but will fail to launch.</p><p>With the warning above in mind, the cluster admin can allow certain <em>unsafe</em>
sysctls for very special situations such as high-performance or real-time
application tuning. <em>Unsafe</em> sysctls are enabled on a node-by-node basis with a
flag of the kubelet; for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubelet --allowed-unsafe-sysctls <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  <span style=color:#b44>&#39;kernel.msg*,net.core.somaxconn&#39;</span> ...
</span></span></code></pre></div><p>For <a class=glossary-tooltip title='A tool for running Kubernetes locally.' data-toggle=tooltip data-placement=top href=/docs/setup/learning-environment/minikube/ target=_blank aria-label=Minikube>Minikube</a>, this can be done via the <code>extra-config</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube start --extra-config<span style=color:#666>=</span><span style=color:#b44>&#34;kubelet.allowed-unsafe-sysctls=kernel.msg*,net.core.somaxconn&#34;</span>...
</span></span></code></pre></div><p>Only <em>namespaced</em> sysctls can be enabled this way.</p><h2 id=setting-sysctls-for-a-pod>Setting Sysctls for a Pod</h2><p>A number of sysctls are <em>namespaced</em> in today's Linux kernels. This means that
they can be set independently for each pod on a node. Only namespaced sysctls
are configurable via the pod securityContext within Kubernetes.</p><p>The following sysctls are known to be namespaced. This list could change
in future versions of the Linux kernel.</p><ul><li><code>kernel.shm*</code>,</li><li><code>kernel.msg*</code>,</li><li><code>kernel.sem</code>,</li><li><code>fs.mqueue.*</code>,</li><li>The parameters under <code>net.*</code> that can be set in container networking
namespace. However, there are exceptions (e.g.,
<code>net.netfilter.nf_conntrack_max</code> and <code>net.netfilter.nf_conntrack_expect_max</code>
can be set in container networking namespace but they are unnamespaced).</li></ul><p>Sysctls with no namespace are called <em>node-level</em> sysctls. If you need to set
them, you must manually configure them on each node's operating system, or by
using a DaemonSet with privileged containers.</p><p>Use the pod securityContext to configure namespaced sysctls. The securityContext
applies to all containers in the same pod.</p><p>This example uses the pod securityContext to set a safe sysctl
<code>kernel.shm_rmid_forced</code> and two unsafe sysctls <code>net.core.somaxconn</code> and
<code>kernel.msgmax</code>. There is no distinction between <em>safe</em> and <em>unsafe</em> sysctls in
the specification.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Only modify sysctl parameters after you understand their effects, to avoid
destabilizing your operating system.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>sysctl-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>sysctls</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kernel.shm_rmid_forced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>net.core.somaxconn<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1024&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kernel.msgmax<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;65536&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Due to their nature of being <em>unsafe</em>, the use of <em>unsafe</em> sysctls
is at-your-own-risk and can lead to severe problems like wrong behavior of
containers, resource shortage or complete breakage of a node.</div><p>It is good practice to consider nodes with special sysctl settings as
<em>tainted</em> within a cluster, and only schedule pods onto them which need those
sysctl settings. It is suggested to use the Kubernetes <a href=/docs/reference/generated/kubectl/kubectl-commands/#taint><em>taints and toleration</em>
feature</a> to implement this.</p><p>A pod with the <em>unsafe</em> sysctls will fail to launch on any node which has not
enabled those two <em>unsafe</em> sysctls explicitly. As with <em>node-level</em> sysctls it
is recommended to use
<a href=/docs/reference/generated/kubectl/kubectl-commands/#taint><em>taints and toleration</em> feature</a> or
<a href=/docs/concepts/scheduling-eviction/taint-and-toleration/>taints on nodes</a>
to schedule those pods onto the right nodes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-778055e4a4415ca195169b42cd42ddf9>2.40 - Utilizing the NUMA-aware Memory Manager</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.22 [beta]</code></div><p>The Kubernetes <em>Memory Manager</em> enables the feature of guaranteed memory (and hugepages)
allocation for pods in the <code>Guaranteed</code> <a class=glossary-tooltip title='QoS Class (Quality of Service Class) provides a way for Kubernetes to classify pods within the cluster into several classes and make decisions about scheduling and eviction.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-qos-class' target=_blank aria-label='QoS class'>QoS class</a>.</p><p>The Memory Manager employs hint generation protocol to yield the most suitable NUMA affinity for a pod.
The Memory Manager feeds the central manager (<em>Topology Manager</em>) with these affinity hints.
Based on both the hints and Topology Manager policy, the pod is rejected or admitted to the node.</p><p>Moreover, the Memory Manager ensures that the memory which a pod requests
is allocated from a minimum number of NUMA nodes.</p><p>The Memory Manager is only pertinent to Linux based hosts.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.21.
To check the version, enter <code>kubectl version</code>.</p><p>To align memory resources with other requested resources in a Pod spec:</p><ul><li>the CPU Manager should be enabled and proper CPU Manager policy should be configured on a Node.
See <a href=/docs/tasks/administer-cluster/cpu-management-policies/>control CPU Management Policies</a>;</li><li>the Topology Manager should be enabled and proper Topology Manager policy should be configured on a Node.
See <a href=/docs/tasks/administer-cluster/topology-manager/>control Topology Management Policies</a>.</li></ul><p>Starting from v1.22, the Memory Manager is enabled by default through <code>MemoryManager</code>
<a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gate</a>.</p><p>Preceding v1.22, the <code>kubelet</code> must be started with the following flag:</p><p><code>--feature-gates=MemoryManager=true</code></p><p>in order to enable the Memory Manager feature.</p><h2 id=how-memory-manager-operates>How Memory Manager Operates?</h2><p>The Memory Manager currently offers the guaranteed memory (and hugepages) allocation
for Pods in Guaranteed QoS class.
To immediately put the Memory Manager into operation follow the guidelines in the section
<a href=#memory-manager-configuration>Memory Manager configuration</a>, and subsequently,
prepare and deploy a <code>Guaranteed</code> pod as illustrated in the section
<a href=#placing-a-pod-in-the-guaranteed-qos-class>Placing a Pod in the Guaranteed QoS class</a>.</p><p>The Memory Manager is a Hint Provider, and it provides topology hints for
the Topology Manager which then aligns the requested resources according to these topology hints.
It also enforces <code>cgroups</code> (i.e. <code>cpuset.mems</code>) for pods.
The complete flow diagram concerning pod admission and deployment process is illustrated in
<a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#design-overview>Memory Manager KEP: Design Overview</a> and below:</p><p><img src=/images/docs/memory-manager-diagram.svg alt="Memory Manager in the pod admission and deployment process"></p><p>During this process, the Memory Manager updates its internal counters stored in
<a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#the-concept-of-node-map-and-memory-maps>Node Map and Memory Maps</a> to manage guaranteed memory allocation.</p><p>The Memory Manager updates the Node Map during the startup and runtime as follows.</p><h3 id=startup>Startup</h3><p>This occurs once a node administrator employs <code>--reserved-memory</code> (section
<a href=#reserved-memory-flag>Reserved memory flag</a>).
In this case, the Node Map becomes updated to reflect this reservation as illustrated in
<a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#memory-maps-at-start-up-with-examples>Memory Manager KEP: Memory Maps at start-up (with examples)</a>.</p><p>The administrator must provide <code>--reserved-memory</code> flag when <code>Static</code> policy is configured.</p><h3 id=runtime>Runtime</h3><p>Reference <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#memory-maps-at-runtime-with-examples>Memory Manager KEP: Memory Maps at runtime (with examples)</a> illustrates
how a successful pod deployment affects the Node Map, and it also relates to
how potential Out-of-Memory (OOM) situations are handled further by Kubernetes or operating system.</p><p>Important topic in the context of Memory Manager operation is the management of NUMA groups.
Each time pod's memory request is in excess of single NUMA node capacity, the Memory Manager
attempts to create a group that comprises several NUMA nodes and features extend memory capacity.
The problem has been solved as elaborated in
<a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#how-to-enable-the-guaranteed-memory-allocation-over-many-numa-nodes>Memory Manager KEP: How to enable the guaranteed memory allocation over many NUMA nodes?</a>.
Also, reference <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#simulation---how-the-memory-manager-works-by-examples>Memory Manager KEP: Simulation - how the Memory Manager works? (by examples)</a>
illustrates how the management of groups occurs.</p><h2 id=memory-manager-configuration>Memory Manager configuration</h2><p>Other Managers should be first pre-configured. Next, the Memory Manager feature should be enabled
and be run with <code>Static</code> policy (section <a href=#policy-static>Static policy</a>).
Optionally, some amount of memory can be reserved for system or kubelet processes to increase
node stability (section <a href=#reserved-memory-flag>Reserved memory flag</a>).</p><h3 id=policies>Policies</h3><p>Memory Manager supports two policies. You can select a policy via a <code>kubelet</code> flag <code>--memory-manager-policy</code>:</p><ul><li><code>None</code> (default)</li><li><code>Static</code></li></ul><h4 id=policy-none>None policy</h4><p>This is the default policy and does not affect the memory allocation in any way.
It acts the same as if the Memory Manager is not present at all.</p><p>The <code>None</code> policy returns default topology hint. This special hint denotes that Hint Provider
(Memory Manger in this case) has no preference for NUMA affinity with any resource.</p><h4 id=policy-static>Static policy</h4><p>In the case of the <code>Guaranteed</code> pod, the <code>Static</code> Memory Manger policy returns topology hints
relating to the set of NUMA nodes where the memory can be guaranteed,
and reserves the memory through updating the internal <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#the-concept-of-node-map-and-memory-maps>NodeMap</a> object.</p><p>In the case of the <code>BestEffort</code> or <code>Burstable</code> pod, the <code>Static</code> Memory Manager policy sends back
the default topology hint as there is no request for the guaranteed memory,
and does not reserve the memory in the internal <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#the-concept-of-node-map-and-memory-maps>NodeMap</a> object.</p><h3 id=reserved-memory-flag>Reserved memory flag</h3><p>The <a href=/docs/tasks/administer-cluster/reserve-compute-resources/>Node Allocatable</a> mechanism
is commonly used by node administrators to reserve K8S node system resources for the kubelet
or operating system processes in order to enhance the node stability.
A dedicated set of flags can be used for this purpose to set the total amount of reserved memory
for a node. This pre-configured value is subsequently utilized to calculate
the real amount of node's "allocatable" memory available to pods.</p><p>The Kubernetes scheduler incorporates "allocatable" to optimise pod scheduling process.
The foregoing flags include <code>--kube-reserved</code>, <code>--system-reserved</code> and <code>--eviction-threshold</code>.
The sum of their values will account for the total amount of reserved memory.</p><p>A new <code>--reserved-memory</code> flag was added to Memory Manager to allow for this total reserved memory
to be split (by a node administrator) and accordingly reserved across many NUMA nodes.</p><p>The flag specifies a comma-separated list of memory reservations of different memory types per NUMA node.
Memory reservations across multiple NUMA nodes can be specified using semicolon as separator.
This parameter is only useful in the context of the Memory Manager feature.
The Memory Manager will not use this reserved memory for the allocation of container workloads.</p><p>For example, if you have a NUMA node "NUMA0" with <code>10Gi</code> of memory available, and
the <code>--reserved-memory</code> was specified to reserve <code>1Gi</code> of memory at "NUMA0",
the Memory Manager assumes that only <code>9Gi</code> is available for containers.</p><p>You can omit this parameter, however, you should be aware that the quantity of reserved memory
from all NUMA nodes should be equal to the quantity of memory specified by the
<a href=/docs/tasks/administer-cluster/reserve-compute-resources/>Node Allocatable feature</a>.
If at least one node allocatable parameter is non-zero, you will need to specify
<code>--reserved-memory</code> for at least one NUMA node.
In fact, <code>eviction-hard</code> threshold value is equal to <code>100Mi</code> by default, so
if <code>Static</code> policy is used, <code>--reserved-memory</code> is obligatory.</p><p>Also, avoid the following configurations:</p><ol><li>duplicates, i.e. the same NUMA node or memory type, but with a different value;</li><li>setting zero limit for any of memory types;</li><li>NUMA node IDs that do not exist in the machine hardware;</li><li>memory type names different than <code>memory</code> or <code>hugepages-&lt;size></code>
(hugepages of particular <code>&lt;size></code> should also exist).</li></ol><p>Syntax:</p><p><code>--reserved-memory N:memory-type1=value1,memory-type2=value2,...</code></p><ul><li><code>N</code> (integer) - NUMA node index, e.g. <code>0</code></li><li><code>memory-type</code> (string) - represents memory type:<ul><li><code>memory</code> - conventional memory</li><li><code>hugepages-2Mi</code> or <code>hugepages-1Gi</code> - hugepages</li></ul></li><li><code>value</code> (string) - the quantity of reserved memory, e.g. <code>1Gi</code></li></ul><p>Example usage:</p><p><code>--reserved-memory 0:memory=1Gi,hugepages-1Gi=2Gi</code></p><p>or</p><p><code>--reserved-memory 0:memory=1Gi --reserved-memory 1:memory=2Gi</code></p><p>or</p><p><code>--reserved-memory '0:memory=1Gi;1:memory=2Gi'</code></p><p>When you specify values for <code>--reserved-memory</code> flag, you must comply with the setting that
you prior provided via Node Allocatable Feature flags.
That is, the following rule must be obeyed for each memory type:</p><p><code>sum(reserved-memory(i)) = kube-reserved + system-reserved + eviction-threshold</code>,</p><p>where <code>i</code> is an index of a NUMA node.</p><p>If you do not follow the formula above, the Memory Manager will show an error on startup.</p><p>In other words, the example above illustrates that for the conventional memory (<code>type=memory</code>),
we reserve <code>3Gi</code> in total, i.e.:</p><p><code>sum(reserved-memory(i)) = reserved-memory(0) + reserved-memory(1) = 1Gi + 2Gi = 3Gi</code></p><p>An example of kubelet command-line arguments relevant to the node Allocatable configuration:</p><ul><li><code>--kube-reserved=cpu=500m,memory=50Mi</code></li><li><code>--system-reserved=cpu=123m,memory=333Mi</code></li><li><code>--eviction-hard=memory.available&lt;500Mi</code></li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The default hard eviction threshold is 100MiB, and <strong>not</strong> zero.
Remember to increase the quantity of memory that you reserve by setting <code>--reserved-memory</code>
by that hard eviction threshold. Otherwise, the kubelet will not start Memory Manager and
display an error.</div><p>Here is an example of a correct configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>--feature-gates<span style=color:#666>=</span><span style=color:#b8860b>MemoryManager</span><span style=color:#666>=</span><span style=color:#a2f>true</span>
</span></span><span style=display:flex><span>--kube-reserved<span style=color:#666>=</span><span style=color:#b8860b>cpu</span><span style=color:#666>=</span>4,memory<span style=color:#666>=</span>4Gi
</span></span><span style=display:flex><span>--system-reserved<span style=color:#666>=</span><span style=color:#b8860b>cpu</span><span style=color:#666>=</span>1,memory<span style=color:#666>=</span>1Gi
</span></span><span style=display:flex><span>--memory-manager-policy<span style=color:#666>=</span>Static
</span></span><span style=display:flex><span>--reserved-memory <span style=color:#b44>&#39;0:memory=3Gi;1:memory=2148Mi&#39;</span>
</span></span></code></pre></div><p>Let us validate the configuration above:</p><ol><li><code>kube-reserved + system-reserved + eviction-hard(default) = reserved-memory(0) + reserved-memory(1)</code></li><li><code>4GiB + 1GiB + 100MiB = 3GiB + 2148MiB</code></li><li><code>5120MiB + 100MiB = 3072MiB + 2148MiB</code></li><li><code>5220MiB = 5220MiB</code> (which is correct)</li></ol><h2 id=placing-a-pod-in-the-guaranteed-qos-class>Placing a Pod in the Guaranteed QoS class</h2><p>If the selected policy is anything other than <code>None</code>, the Memory Manager identifies pods
that are in the <code>Guaranteed</code> QoS class.
The Memory Manager provides specific topology hints to the Topology Manager for each <code>Guaranteed</code> pod.
For pods in a QoS class other than <code>Guaranteed</code>, the Memory Manager provides default topology hints
to the Topology Manager.</p><p>The following excerpts from pod manifests assign a pod to the <code>Guaranteed</code> QoS class.</p><p>Pod with integer CPU(s) runs in the <code>Guaranteed</code> QoS class, when <code>requests</code> are equal to <code>limits</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/device</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/device</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Also, a pod sharing CPU(s) runs in the <code>Guaranteed</code> QoS class, when <code>requests</code> are equal to <code>limits</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;300m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/device</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;300m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/device</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Notice that both CPU and memory requests must be specified for a Pod to lend it to Guaranteed QoS class.</p><h2 id=troubleshooting>Troubleshooting</h2><p>The following means can be used to troubleshoot the reason why a pod could not be deployed or
became rejected at a node:</p><ul><li>pod status - indicates topology affinity errors</li><li>system logs - include valuable information for debugging, e.g., about generated hints</li><li>state file - the dump of internal state of the Memory Manager
(includes <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#the-concept-of-node-map-and-memory-maps>Node Map and Memory Maps</a>)</li><li>starting from v1.22, the <a href=#device-plugin-resource-api>device plugin resource API</a> can be used
to retrieve information about the memory reserved for containers</li></ul><h3 id=TopologyAffinityError>Pod status (TopologyAffinityError)</h3><p>This error typically occurs in the following situations:</p><ul><li>a node has not enough resources available to satisfy the pod's request</li><li>the pod's request is rejected due to particular Topology Manager policy constraints</li></ul><p>The error appears in the status of a pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME         READY   STATUS                  RESTARTS   AGE
guaranteed   0/1     TopologyAffinityError   0          113s
</code></pre><p>Use <code>kubectl describe pod &lt;id></code> or <code>kubectl get events</code> to obtain detailed error message:</p><pre tabindex=0><code class=language-none data-lang=none>Warning  TopologyAffinityError  10m   kubelet, dell8  Resources cannot be allocated with Topology locality
</code></pre><h3 id=system-logs>System logs</h3><p>Search system logs with respect to a particular pod.</p><p>The set of hints that Memory Manager generated for the pod can be found in the logs.
Also, the set of hints generated by CPU Manager should be present in the logs.</p><p>Topology Manager merges these hints to calculate a single best hint.
The best hint should be also present in the logs.</p><p>The best hint indicates where to allocate all the resources.
Topology Manager tests this hint against its current policy, and based on the verdict,
it either admits the pod to the node or rejects it.</p><p>Also, search the logs for occurrences associated with the Memory Manager,
e.g. to find out information about <code>cgroups</code> and <code>cpuset.mems</code> updates.</p><h3 id=examine-the-memory-manager-state-on-a-node>Examine the memory manager state on a node</h3><p>Let us first deploy a sample <code>Guaranteed</code> pod whose specification is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>guaranteed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>guaranteed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>consumer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>150Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>150Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;sleep&#34;</span>,<span style=color:#b44>&#34;infinity&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div><p>Next, let us log into the node where it was deployed and examine the state file in
<code>/var/lib/kubelet/memory_manager_state</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:green;font-weight:700>&#34;policyName&#34;</span>:<span style=color:#b44>&#34;Static&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:green;font-weight:700>&#34;machineState&#34;</span>:{
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;0&#34;</span>:{
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;numberOfAssignments&#34;</span>:<span style=color:#666>1</span>,
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;memoryMap&#34;</span>:{
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;hugepages-1Gi&#34;</span>:{
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;total&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;systemReserved&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;allocatable&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;reserved&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;free&#34;</span>:<span style=color:#666>0</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;memory&#34;</span>:{
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;total&#34;</span>:<span style=color:#666>134987354112</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;systemReserved&#34;</span>:<span style=color:#666>3221225472</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;allocatable&#34;</span>:<span style=color:#666>131766128640</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;reserved&#34;</span>:<span style=color:#666>131766128640</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;free&#34;</span>:<span style=color:#666>0</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;nodes&#34;</span>:[
</span></span><span style=display:flex><span>            <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>            <span style=color:#666>1</span>
</span></span><span style=display:flex><span>         ]
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;1&#34;</span>:{
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;numberOfAssignments&#34;</span>:<span style=color:#666>1</span>,
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;memoryMap&#34;</span>:{
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;hugepages-1Gi&#34;</span>:{
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;total&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;systemReserved&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;allocatable&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;reserved&#34;</span>:<span style=color:#666>0</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;free&#34;</span>:<span style=color:#666>0</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;memory&#34;</span>:{
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;total&#34;</span>:<span style=color:#666>135286722560</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;systemReserved&#34;</span>:<span style=color:#666>2252341248</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;allocatable&#34;</span>:<span style=color:#666>133034381312</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;reserved&#34;</span>:<span style=color:#666>29295144960</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;free&#34;</span>:<span style=color:#666>103739236352</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;nodes&#34;</span>:[
</span></span><span style=display:flex><span>            <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>            <span style=color:#666>1</span>
</span></span><span style=display:flex><span>         ]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   },
</span></span><span style=display:flex><span>   <span style=color:green;font-weight:700>&#34;entries&#34;</span>:{
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;fa9bdd38-6df9-4cf9-aa67-8c4814da37a8&#34;</span>:{
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;guaranteed&#34;</span>:[
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;numaAffinity&#34;</span>:[
</span></span><span style=display:flex><span>                  <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>                  <span style=color:#666>1</span>
</span></span><span style=display:flex><span>               ],
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;type&#34;</span>:<span style=color:#b44>&#34;memory&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:green;font-weight:700>&#34;size&#34;</span>:<span style=color:#666>161061273600</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         ]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   },
</span></span><span style=display:flex><span>   <span style=color:green;font-weight:700>&#34;checksum&#34;</span>:<span style=color:#666>4142013182</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It can be deduced from the state file that the pod was pinned to both NUMA nodes, i.e.:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#b44>&#34;numaAffinity&#34;</span><span>:</span>[
</span></span><span style=display:flex><span>   <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>   <span style=color:#666>1</span>
</span></span><span style=display:flex><span>]<span>,</span>
</span></span></code></pre></div><p>Pinned term means that pod's memory consumption is constrained (through <code>cgroups</code> configuration)
to these NUMA nodes.</p><p>This automatically implies that Memory Manager instantiated a new group that
comprises these two NUMA nodes, i.e. <code>0</code> and <code>1</code> indexed NUMA nodes.</p><p>Notice that the management of groups is handled in a relatively complex manner, and
further elaboration is provided in Memory Manager KEP in <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#simulation---how-the-memory-manager-works-by-examples>this</a> and <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#how-to-enable-the-guaranteed-memory-allocation-over-many-numa-nodes>this</a> sections.</p><p>In order to analyse memory resources available in a group,the corresponding entries from
NUMA nodes belonging to the group must be added up.</p><p>For example, the total amount of free "conventional" memory in the group can be computed
by adding up the free memory available at every NUMA node in the group,
i.e., in the <code>"memory"</code> section of NUMA node <code>0</code> (<code>"free":0</code>) and NUMA node <code>1</code> (<code>"free":103739236352</code>).
So, the total amount of free "conventional" memory in this group is equal to <code>0 + 103739236352</code> bytes.</p><p>The line <code>"systemReserved":3221225472</code> indicates that the administrator of this node reserved
<code>3221225472</code> bytes (i.e. <code>3Gi</code>) to serve kubelet and system processes at NUMA node <code>0</code>,
by using <code>--reserved-memory</code> flag.</p><h3 id=device-plugin-resource-api>Device plugin resource API</h3><p>By employing the <a href=/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/>API</a>,
the information about reserved memory for each container can be retrieved, which is contained
in protobuf <code>ContainerMemory</code> message.
This information can be retrieved solely for pods in Guaranteed QoS class.</p><h2 id=what-s-next>What's next</h2><ul><li><a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#design-overview>Memory Manager KEP: Design Overview</a></li><li><a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#memory-maps-at-start-up-with-examples>Memory Manager KEP: Memory Maps at start-up (with examples)</a></li><li><a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#memory-maps-at-runtime-with-examples>Memory Manager KEP: Memory Maps at runtime (with examples)</a></li><li><a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#simulation---how-the-memory-manager-works-by-examples>Memory Manager KEP: Simulation - how the Memory Manager works? (by examples)</a></li><li><a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#the-concept-of-node-map-and-memory-maps>Memory Manager KEP: The Concept of Node Map and Memory Maps</a></li><li><a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/1769-memory-manager#how-to-enable-the-guaranteed-memory-allocation-over-many-numa-nodes>Memory Manager KEP: How to enable the guaranteed memory allocation over many NUMA nodes?</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-096540b253fc2fdc306a85eb3ecf4885>2.41 - Verify Signed Container Images</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.24 [alpha]</code></div><h2 id=before-you-begin>Before you begin</h2><p>These instructions are for Kubernetes 1.25. If you want
to check the integrity of components for a different version of Kubernetes,
check the documentation for that Kubernetes release.</p><p>You will need to have the following tools installed:</p><ul><li><code>cosign</code> (<a href=https://docs.sigstore.dev/cosign/installation/>install guide</a>)</li><li><code>curl</code> (often provided by your operating system)</li></ul><h2 id=verifying-image-signatures>Verifying image signatures</h2><p>For a complete list of images that are signed please refer
to <a href=/releases/download/>Releases</a>.</p><p>Let's pick one image from this list and verify its signature using
the <code>cosign verify</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>COSIGN_EXPERIMENTAL</span><span style=color:#666>=</span><span style=color:#666>1</span> cosign verify registry.k8s.io/kube-apiserver-amd64:v1.24.0
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>COSIGN_EXPERIMENTAL=1</code> is used to allow verification of images signed
in <code>KEYLESS</code> mode. To learn more about keyless signing, please refer to
<a href=https://github.com/sigstore/cosign/blob/main/KEYLESS.md#keyless-signatures>Keyless Signatures</a>
.</div><h3 id=verifying-images-for-all-control-plane-components>Verifying images for all control plane components</h3><p>To verify all signed control plane images, please run this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -Ls https://sbom.k8s.io/<span style=color:#a2f;font-weight:700>$(</span>curl -Ls https://dl.k8s.io/release/latest.txt<span style=color:#a2f;font-weight:700>)</span>/release | grep <span style=color:#b44>&#39;PackageName: registry.k8s.io/&#39;</span> | awk <span style=color:#b44>&#39;{print $2}&#39;</span> &gt; images.txt
</span></span><span style=display:flex><span><span style=color:#b8860b>input</span><span style=color:#666>=</span>images.txt
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>while</span> <span style=color:#b8860b>IFS</span><span style=color:#666>=</span> <span style=color:#a2f>read</span> -r image
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>  <span style=color:#b8860b>COSIGN_EXPERIMENTAL</span><span style=color:#666>=</span><span style=color:#666>1</span> cosign verify <span style=color:#b44>&#34;</span><span style=color:#b8860b>$image</span><span style=color:#b44>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span> &lt; <span style=color:#b44>&#34;</span><span style=color:#b8860b>$input</span><span style=color:#b44>&#34;</span>
</span></span></code></pre></div><p>Once you have verified an image, specify that image by its digest in your Pod
manifests as per this
example: <code>registry-url/image-name@sha256:45b23dee08af5e43a7fea6c4cf9c25ccf269ee113168c19722f87876677c5cb2</code>
.</p><p>For more information, please refer
to <a href=/docs/concepts/containers/images/#image-pull-policy>Image Pull Policy</a>
section.</p><h2 id=verifying-image-signatures-with-admission-controller>Verifying Image Signatures with Admission Controller</h2><p>For non-control plane images (
e.g. <a href=https://github.com/kubernetes/kubernetes/blob/master/test/conformance/image/README.md>conformance image</a>)
, signatures can also be verified at deploy time using
<a href=https://docs.sigstore.dev/policy-controller/overview>sigstore policy-controller</a>
admission controller. To get started with <code>policy-controller</code> here are a few helpful
resources:</p><ul><li><a href=https://github.com/sigstore/helm-charts/tree/main/charts/policy-controller>Installation</a></li><li><a href=https://github.com/sigstore/policy-controller/tree/main/config>Configuration Options</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f5da33b976758a9183018c421eb83f58>3 - Configure Pods and Containers</h1><div class=lead>Perform common configuration tasks for Pods and containers.</div></div><div class=td-content><h1 id=pg-e6dd9300cf3a955f7cdfe77fb5d15292>3.1 - Assign Memory Resources to Containers and Pods</h1><p>This page shows how to assign a memory <em>request</em> and a memory <em>limit</em> to a
Container. A Container is guaranteed to have as much memory as it requests,
but is not allowed to use more memory than its limit.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><p>Each node in your cluster must have at least 300 MiB of memory.</p><p>A few of the steps on this page require you to run the
<a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a>
service in your cluster. If you have the metrics-server
running, you can skip those steps.</p><p>If you are running Minikube, run the following command to enable the
metrics-server:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube addons <span style=color:#a2f>enable</span> metrics-server
</span></span></code></pre></div><p>To see whether the metrics-server is running, or another provider of the resource metrics
API (<code>metrics.k8s.io</code>), run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get apiservices
</span></span></code></pre></div><p>If the resource metrics API is available, the output includes a
reference to <code>metrics.k8s.io</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>v1beta1.metrics.k8s.io
</span></span></code></pre></div><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace mem-example
</span></span></code></pre></div><h2 id=specify-a-memory-request-and-a-memory-limit>Specify a memory request and a memory limit</h2><p>To specify a memory request for a Container, include the <code>resources:requests</code> field
in the Container's resource manifest. To specify a memory limit, include <code>resources:limits</code>.</p><p>In this exercise, you create a Pod that has one Container. The Container has a memory
request of 100 MiB and a memory limit of 200 MiB. Here's the configuration file
for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/resource/memory-request-limit.yaml download=pods/resource/memory-request-limit.yaml><code>pods/resource/memory-request-limit.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-resource-memory-request-limit-yaml")' title="Copy pods/resource/memory-request-limit.yaml to clipboard"></img></div><div class=includecode id=pods-resource-memory-request-limit-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>memory-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>mem-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>memory-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>polinux/stress<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;stress&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;--vm&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--vm-bytes&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;150M&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--vm-hang&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>The <code>args</code> section in the configuration file provides arguments for the Container when it starts.
The <code>"--vm-bytes", "150M"</code> arguments tell the Container to attempt to allocate 150 MiB of memory.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/resource/memory-request-limit.yaml --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>Verify that the Pod Container is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod memory-demo --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod memory-demo --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>The output shows that the one Container in the Pod has a memory request of 100 MiB
and a memory limit of 200 MiB.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>200Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Run <code>kubectl top</code> to fetch the metrics for the pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl top pod memory-demo --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>The output shows that the Pod is using about 162,900,000 bytes of memory, which
is about 150 MiB. This is greater than the Pod's 100 MiB request, but within the
Pod's 200 MiB limit.</p><pre tabindex=0><code>NAME                        CPU(cores)   MEMORY(bytes)
memory-demo                 &lt;something&gt;  162856960
</code></pre><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod memory-demo --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><h2 id=exceed-a-container-s-memory-limit>Exceed a Container's memory limit</h2><p>A Container can exceed its memory request if the Node has memory available. But a Container
is not allowed to use more than its memory limit. If a Container allocates more memory than
its limit, the Container becomes a candidate for termination. If the Container continues to
consume memory beyond its limit, the Container is terminated. If a terminated Container can be
restarted, the kubelet restarts it, as with any other type of runtime failure.</p><p>In this exercise, you create a Pod that attempts to allocate more memory than its limit.
Here is the configuration file for a Pod that has one Container with a
memory request of 50 MiB and a memory limit of 100 MiB:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/resource/memory-request-limit-2.yaml download=pods/resource/memory-request-limit-2.yaml><code>pods/resource/memory-request-limit-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-resource-memory-request-limit-2-yaml")' title="Copy pods/resource/memory-request-limit-2.yaml to clipboard"></img></div><div class=includecode id=pods-resource-memory-request-limit-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>memory-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>mem-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>memory-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>polinux/stress<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;50Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;stress&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;--vm&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--vm-bytes&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;250M&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--vm-hang&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the <code>args</code> section of the configuration file, you can see that the Container
will attempt to allocate 250 MiB of memory, which is well above the 100 MiB limit.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/resource/memory-request-limit-2.yaml --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod memory-demo-2 --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>At this point, the Container might be running or killed. Repeat the preceding command until the Container is killed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME            READY     STATUS      RESTARTS   AGE
</span></span><span style=display:flex><span>memory-demo-2   0/1       OOMKilled   <span style=color:#666>1</span>          24s
</span></span></code></pre></div><p>Get a more detailed view of the Container status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod memory-demo-2 --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>The output shows that the Container was killed because it is out of memory (OOM):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>lastState</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>   </span><span style=color:green;font-weight:700>terminated</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>containerID</span>:<span style=color:#bbb> </span>65183c1877aaec2e8427bc95609cc52677a454b56fcb24340dbd22917c23b10f<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>exitCode</span>:<span style=color:#bbb> </span><span style=color:#666>137</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>finishedAt</span>:<span style=color:#bbb> </span>2017-06-20T20:52:19Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>reason</span>:<span style=color:#bbb> </span>OOMKilled<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>startedAt</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>The Container in this exercise can be restarted, so the kubelet restarts it. Repeat
this command several times to see that the Container is repeatedly killed and restarted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod memory-demo-2 --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>The output shows that the Container is killed, restarted, killed again, restarted again, and so on:</p><pre tabindex=0><code>kubectl get pod memory-demo-2 --namespace=mem-example
NAME            READY     STATUS      RESTARTS   AGE
memory-demo-2   0/1       OOMKilled   1          37s
</code></pre><pre tabindex=0><code>
kubectl get pod memory-demo-2 --namespace=mem-example
NAME            READY     STATUS    RESTARTS   AGE
memory-demo-2   1/1       Running   2          40s
</code></pre><p>View detailed information about the Pod history:</p><pre tabindex=0><code>kubectl describe pod memory-demo-2 --namespace=mem-example
</code></pre><p>The output shows that the Container starts and fails repeatedly:</p><pre tabindex=0><code>... Normal  Created   Created container with id 66a3a20aa7980e61be4922780bf9d24d1a1d8b7395c09861225b0eba1b1f8511
... Warning BackOff   Back-off restarting failed container
</code></pre><p>View detailed information about your cluster's Nodes:</p><pre tabindex=0><code>kubectl describe nodes
</code></pre><p>The output includes a record of the Container being killed because of an out-of-memory condition:</p><pre tabindex=0><code>Warning OOMKilling Memory cgroup out of memory: Kill process 4481 (stress) score 1994 or sacrifice child
</code></pre><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod memory-demo-2 --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><h2 id=specify-a-memory-request-that-is-too-big-for-your-nodes>Specify a memory request that is too big for your Nodes</h2><p>Memory requests and limits are associated with Containers, but it is useful to think
of a Pod as having a memory request and limit. The memory request for the Pod is the
sum of the memory requests for all the Containers in the Pod. Likewise, the memory
limit for the Pod is the sum of the limits of all the Containers in the Pod.</p><p>Pod scheduling is based on requests. A Pod is scheduled to run on a Node only if the Node
has enough available memory to satisfy the Pod's memory request.</p><p>In this exercise, you create a Pod that has a memory request so big that it exceeds the
capacity of any Node in your cluster. Here is the configuration file for a Pod that has one
Container with a request for 1000 GiB of memory, which likely exceeds the capacity
of any Node in your cluster.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/resource/memory-request-limit-3.yaml download=pods/resource/memory-request-limit-3.yaml><code>pods/resource/memory-request-limit-3.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-resource-memory-request-limit-3-yaml")' title="Copy pods/resource/memory-request-limit-3.yaml to clipboard"></img></div><div class=includecode id=pods-resource-memory-request-limit-3-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>memory-demo-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>mem-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>memory-demo-3-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>polinux/stress<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1000Gi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1000Gi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;stress&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;--vm&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--vm-bytes&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;150M&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--vm-hang&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/resource/memory-request-limit-3.yaml --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>View the Pod status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod memory-demo-3 --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>The output shows that the Pod status is PENDING. That is, the Pod is not scheduled to run on any Node, and it will remain in the PENDING state indefinitely:</p><pre tabindex=0><code>kubectl get pod memory-demo-3 --namespace=mem-example
NAME            READY     STATUS    RESTARTS   AGE
memory-demo-3   0/1       Pending   0          25s
</code></pre><p>View detailed information about the Pod, including events:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod memory-demo-3 --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><p>The output shows that the Container cannot be scheduled because of insufficient memory on the Nodes:</p><pre tabindex=0><code>Events:
  ...  Reason            Message
       ------            -------
  ...  FailedScheduling  No nodes are available that match all of the following predicates:: Insufficient memory (3).
</code></pre><h2 id=memory-units>Memory units</h2><p>The memory resource is measured in bytes. You can express memory as a plain integer or a
fixed-point integer with one of these suffixes: E, P, T, G, M, K, Ei, Pi, Ti, Gi, Mi, Ki.
For example, the following represent approximately the same value:</p><pre tabindex=0><code>128974848, 129e6, 129M, 123Mi
</code></pre><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod memory-demo-3 --namespace<span style=color:#666>=</span>mem-example
</span></span></code></pre></div><h2 id=if-you-do-not-specify-a-memory-limit>If you do not specify a memory limit</h2><p>If you do not specify a memory limit for a Container, one of the following situations applies:</p><ul><li><p>The Container has no upper bound on the amount of memory it uses. The Container
could use all of the memory available on the Node where it is running which in turn could invoke the OOM Killer. Further, in case of an OOM Kill, a container with no resource limits will have a greater chance of being killed.</p></li><li><p>The Container is running in a namespace that has a default memory limit, and the
Container is automatically assigned the default limit. Cluster administrators can use a
<a href=/docs/reference/generated/kubernetes-api/v1.25/#limitrange-v1-core>LimitRange</a>
to specify a default value for the memory limit.</p></li></ul><h2 id=motivation-for-memory-requests-and-limits>Motivation for memory requests and limits</h2><p>By configuring memory requests and limits for the Containers that run in your
cluster, you can make efficient use of the memory resources available on your cluster's
Nodes. By keeping a Pod's memory request low, you give the Pod a good chance of being
scheduled. By having a memory limit that is greater than the memory request, you accomplish two things:</p><ul><li>The Pod can have bursts of activity where it makes use of memory that happens to be available.</li><li>The amount of memory a Pod can use during a burst is limited to some reasonable amount.</li></ul><h2 id=clean-up>Clean up</h2><p>Delete your namespace. This deletes all the Pods that you created for this task:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace mem-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8555af270ae7122cc0464bab3f5d1609>3.2 - Assign CPU Resources to Containers and Pods</h1><p>This page shows how to assign a CPU <em>request</em> and a CPU <em>limit</em> to
a container. Containers cannot use more CPU than the configured limit.
Provided the system has CPU time free, a container is guaranteed to be
allocated as much CPU as it requests.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><p>Your cluster must have at least 1 CPU available for use to run the task examples.</p><p>A few of the steps on this page require you to run the
<a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a>
service in your cluster. If you have the metrics-server
running, you can skip those steps.</p><p>If you are running <a class=glossary-tooltip title='A tool for running Kubernetes locally.' data-toggle=tooltip data-placement=top href=/docs/setup/learning-environment/minikube/ target=_blank aria-label=Minikube>Minikube</a>, run the
following command to enable metrics-server:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube addons <span style=color:#a2f>enable</span> metrics-server
</span></span></code></pre></div><p>To see whether metrics-server (or another provider of the resource metrics
API, <code>metrics.k8s.io</code>) is running, type the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get apiservices
</span></span></code></pre></div><p>If the resource metrics API is available, the output will include a
reference to <code>metrics.k8s.io</code>.</p><pre tabindex=0><code>NAME
v1beta1.metrics.k8s.io
</code></pre><h2 id=create-a-namespace>Create a namespace</h2><p>Create a <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=Namespace>Namespace</a> so that the resources you
create in this exercise are isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace cpu-example
</span></span></code></pre></div><h2 id=specify-a-cpu-request-and-a-cpu-limit>Specify a CPU request and a CPU limit</h2><p>To specify a CPU request for a container, include the <code>resources:requests</code> field
in the Container resource manifest. To specify a CPU limit, include <code>resources:limits</code>.</p><p>In this exercise, you create a Pod that has one container. The container has a request
of 0.5 CPU and a limit of 1 CPU. Here is the configuration file for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/resource/cpu-request-limit.yaml download=pods/resource/cpu-request-limit.yaml><code>pods/resource/cpu-request-limit.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-resource-cpu-request-limit-yaml")' title="Copy pods/resource/cpu-request-limit.yaml to clipboard"></img></div><div class=includecode id=pods-resource-cpu-request-limit-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>cpu-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>vish/stress<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0.5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- -cpus<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>The <code>args</code> section of the configuration file provides arguments for the container when it starts.
The <code>-cpus "2"</code> argument tells the Container to attempt to use 2 CPUs.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/resource/cpu-request-limit.yaml --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><p>Verify that the Pod is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod cpu-demo --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod cpu-demo --output<span style=color:#666>=</span>yaml --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><p>The output shows that the one container in the Pod has a CPU request of 500 milliCPU
and a CPU limit of 1 CPU.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>500m<span style=color:#bbb>
</span></span></span></code></pre></div><p>Use <code>kubectl top</code> to fetch the metrics for the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl top pod cpu-demo --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><p>This example output shows that the Pod is using 974 milliCPU, which is
slightly less than the limit of 1 CPU specified in the Pod configuration.</p><pre tabindex=0><code>NAME                        CPU(cores)   MEMORY(bytes)
cpu-demo                    974m         &lt;something&gt;
</code></pre><p>Recall that by setting <code>-cpu "2"</code>, you configured the Container to attempt to use 2 CPUs, but the Container is only being allowed to use about 1 CPU. The container's CPU use is being throttled, because the container is attempting to use more CPU resources than its limit.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Another possible explanation for the CPU use being below 1.0 is that the Node might not have
enough CPU resources available. Recall that the prerequisites for this exercise require your cluster to have at least 1 CPU available for use. If your Container runs on a Node that has only 1 CPU, the Container cannot use more than 1 CPU regardless of the CPU limit specified for the Container.</div><h2 id=cpu-units>CPU units</h2><p>The CPU resource is measured in <em>CPU</em> units. One CPU, in Kubernetes, is equivalent to:</p><ul><li>1 AWS vCPU</li><li>1 GCP Core</li><li>1 Azure vCore</li><li>1 Hyperthread on a bare-metal Intel processor with Hyperthreading</li></ul><p>Fractional values are allowed. A Container that requests 0.5 CPU is guaranteed half as much
CPU as a Container that requests 1 CPU. You can use the suffix m to mean milli. For example
100m CPU, 100 milliCPU, and 0.1 CPU are all the same. Precision finer than 1m is not allowed.</p><p>CPU is always requested as an absolute quantity, never as a relative quantity; 0.1 is the same
amount of CPU on a single-core, dual-core, or 48-core machine.</p><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod cpu-demo --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><h2 id=specify-a-cpu-request-that-is-too-big-for-your-nodes>Specify a CPU request that is too big for your Nodes</h2><p>CPU requests and limits are associated with Containers, but it is useful to think
of a Pod as having a CPU request and limit. The CPU request for a Pod is the sum
of the CPU requests for all the Containers in the Pod. Likewise, the CPU limit for
a Pod is the sum of the CPU limits for all the Containers in the Pod.</p><p>Pod scheduling is based on requests. A Pod is scheduled to run on a Node only if
the Node has enough CPU resources available to satisfy the Pod CPU request.</p><p>In this exercise, you create a Pod that has a CPU request so big that it exceeds
the capacity of any Node in your cluster. Here is the configuration file for a Pod
that has one Container. The Container requests 100 CPU, which is likely to exceed the
capacity of any Node in your cluster.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/resource/cpu-request-limit-2.yaml download=pods/resource/cpu-request-limit-2.yaml><code>pods/resource/cpu-request-limit-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-resource-cpu-request-limit-2-yaml")' title="Copy pods/resource/cpu-request-limit-2.yaml to clipboard"></img></div><div class=includecode id=pods-resource-cpu-request-limit-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>cpu-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu-demo-ctr-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>vish/stress<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- -cpus<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/resource/cpu-request-limit-2.yaml --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><p>View the Pod status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod cpu-demo-2 --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><p>The output shows that the Pod status is Pending. That is, the Pod has not been
scheduled to run on any Node, and it will remain in the Pending state indefinitely:</p><pre tabindex=0><code>NAME         READY     STATUS    RESTARTS   AGE
cpu-demo-2   0/1       Pending   0          7m
</code></pre><p>View detailed information about the Pod, including events:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod cpu-demo-2 --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><p>The output shows that the Container cannot be scheduled because of insufficient
CPU resources on the Nodes:</p><pre tabindex=0><code>Events:
  Reason                        Message
  ------                        -------
  FailedScheduling      No nodes are available that match all of the following predicates:: Insufficient cpu (3).
</code></pre><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod cpu-demo-2 --namespace<span style=color:#666>=</span>cpu-example
</span></span></code></pre></div><h2 id=if-you-do-not-specify-a-cpu-limit>If you do not specify a CPU limit</h2><p>If you do not specify a CPU limit for a Container, then one of these situations applies:</p><ul><li><p>The Container has no upper bound on the CPU resources it can use. The Container
could use all of the CPU resources available on the Node where it is running.</p></li><li><p>The Container is running in a namespace that has a default CPU limit, and the
Container is automatically assigned the default limit. Cluster administrators can use a
<a href=/docs/reference/generated/kubernetes-api/v1.25/#limitrange-v1-core/>LimitRange</a>
to specify a default value for the CPU limit.</p></li></ul><h2 id=if-you-specify-a-cpu-limit-but-do-not-specify-a-cpu-request>If you specify a CPU limit but do not specify a CPU request</h2><p>If you specify a CPU limit for a Container but do not specify a CPU request, Kubernetes automatically
assigns a CPU request that matches the limit. Similarly, if a Container specifies its own memory limit,
but does not specify a memory request, Kubernetes automatically assigns a memory request that matches
the limit.</p><h2 id=motivation-for-cpu-requests-and-limits>Motivation for CPU requests and limits</h2><p>By configuring the CPU requests and limits of the Containers that run in your
cluster, you can make efficient use of the CPU resources available on your cluster
Nodes. By keeping a Pod CPU request low, you give the Pod a good chance of being
scheduled. By having a CPU limit that is greater than the CPU request, you accomplish two things:</p><ul><li>The Pod can have bursts of activity where it makes use of CPU resources that happen to be available.</li><li>The amount of CPU resources a Pod can use during a burst is limited to some reasonable amount.</li></ul><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace cpu-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/quality-service-pod/>Configure Quality of Service for Pods</a></p></li></ul><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-aa522472483f900008124a2809f2114b>3.3 - Configure GMSA for Windows Pods and containers</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [stable]</code></div><p>This page shows how to configure <a href=https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview>Group Managed Service Accounts</a> (GMSA) for Pods and containers that will run on Windows nodes. Group Managed Service Accounts are a specific type of Active Directory account that provides automatic password management, simplified service principal name (SPN) management, and the ability to delegate the management to other administrators across multiple servers.</p><p>In Kubernetes, GMSA credential specs are configured at a Kubernetes cluster-wide scope as Custom Resources. Windows Pods, as well as individual containers within a Pod, can be configured to use a GMSA for domain based functions (e.g. Kerberos authentication) when interacting with other Windows services.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster and the <code>kubectl</code> command-line tool must be configured to communicate with your cluster. The cluster is expected to have Windows worker nodes. This section covers a set of initial steps required once for each cluster:</p><h3 id=install-the-gmsacredentialspec-crd>Install the GMSACredentialSpec CRD</h3><p>A <a href=/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/>CustomResourceDefinition</a>(CRD) for GMSA credential spec resources needs to be configured on the cluster to define the custom resource type <code>GMSACredentialSpec</code>. Download the GMSA CRD <a href=https://github.com/kubernetes-sigs/windows-gmsa/blob/master/admission-webhook/deploy/gmsa-crd.yml>YAML</a> and save it as gmsa-crd.yaml.
Next, install the CRD with <code>kubectl apply -f gmsa-crd.yaml</code></p><h3 id=install-webhooks-to-validate-gmsa-users>Install webhooks to validate GMSA users</h3><p>Two webhooks need to be configured on the Kubernetes cluster to populate and validate GMSA credential spec references at the Pod or container level:</p><ol><li><p>A mutating webhook that expands references to GMSAs (by name from a Pod specification) into the full credential spec in JSON form within the Pod spec.</p></li><li><p>A validating webhook ensures all references to GMSAs are authorized to be used by the Pod service account.</p></li></ol><p>Installing the above webhooks and associated objects require the steps below:</p><ol><li><p>Create a certificate key pair (that will be used to allow the webhook container to communicate to the cluster)</p></li><li><p>Install a secret with the certificate from above.</p></li><li><p>Create a deployment for the core webhook logic.</p></li><li><p>Create the validating and mutating webhook configurations referring to the deployment.</p></li></ol><p>A <a href=https://github.com/kubernetes-sigs/windows-gmsa/blob/master/admission-webhook/deploy/deploy-gmsa-webhook.sh>script</a> can be used to deploy and configure the GMSA webhooks and associated objects mentioned above. The script can be run with a <code>--dry-run=server</code> option to allow you to review the changes that would be made to your cluster.</p><p>The <a href=https://github.com/kubernetes-sigs/windows-gmsa/blob/master/admission-webhook/deploy/gmsa-webhook.yml.tpl>YAML template</a> used by the script may also be used to deploy the webhooks and associated objects manually (with appropriate substitutions for the parameters)</p><h2 id=configure-gmsas-and-windows-nodes-in-active-directory>Configure GMSAs and Windows nodes in Active Directory</h2><p>Before Pods in Kubernetes can be configured to use GMSAs, the desired GMSAs need to be provisioned in Active Directory as described in the <a href=https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/getting-started-with-group-managed-service-accounts#BKMK_Step1>Windows GMSA documentation</a>. Windows worker nodes (that are part of the Kubernetes cluster) need to be configured in Active Directory to access the secret credentials associated with the desired GMSA as described in the <a href=https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/getting-started-with-group-managed-service-accounts#to-add-member-hosts-using-the-set-adserviceaccount-cmdlet>Windows GMSA documentation</a></p><h2 id=create-gmsa-credential-spec-resources>Create GMSA credential spec resources</h2><p>With the GMSACredentialSpec CRD installed (as described earlier), custom resources containing GMSA credential specs can be configured. The GMSA credential spec does not contain secret or sensitive data. It is information that a container runtime can use to describe the desired GMSA of a container to Windows. GMSA credential specs can be generated in YAML format with a utility <a href=https://github.com/kubernetes-sigs/windows-gmsa/tree/master/scripts/GenerateCredentialSpecResource.ps1>PowerShell script</a>.</p><p>Following are the steps for generating a GMSA credential spec YAML manually in JSON format and then converting it:</p><ol><li><p>Import the CredentialSpec <a href=https://github.com/MicrosoftDocs/Virtualization-Documentation/blob/live/windows-server-container-tools/ServiceAccounts/CredentialSpec.psm1>module</a>: <code>ipmo CredentialSpec.psm1</code></p></li><li><p>Create a credential spec in JSON format using <code>New-CredentialSpec</code>. To create a GMSA credential spec named WebApp1, invoke <code>New-CredentialSpec -Name WebApp1 -AccountName WebApp1 -Domain $(Get-ADDomain -Current LocalComputer)</code></p></li><li><p>Use <code>Get-CredentialSpec</code> to show the path of the JSON file.</p></li><li><p>Convert the credspec file from JSON to YAML format and apply the necessary header fields <code>apiVersion</code>, <code>kind</code>, <code>metadata</code> and <code>credspec</code> to make it a GMSACredentialSpec custom resource that can be configured in Kubernetes.</p></li></ol><p>The following YAML configuration describes a GMSA credential spec named <code>gmsa-WebApp1</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>windows.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>GMSACredentialSpec<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>gmsa-WebApp1 <span style=color:#bbb> </span><span style=color:#080;font-style:italic>#This is an arbitrary name but it will be used as a reference</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>credspec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ActiveDirectoryConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>GroupManagedServiceAccounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>Name</span>:<span style=color:#bbb> </span>WebApp1  <span style=color:#bbb> </span><span style=color:#080;font-style:italic>#Username of the GMSA account</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>Scope</span>:<span style=color:#bbb> </span>CONTOSO <span style=color:#bbb> </span><span style=color:#080;font-style:italic>#NETBIOS Domain Name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>Name</span>:<span style=color:#bbb> </span>WebApp1  <span style=color:#bbb> </span><span style=color:#080;font-style:italic>#Username of the GMSA account</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>Scope</span>:<span style=color:#bbb> </span>contoso.com<span style=color:#bbb> </span><span style=color:#080;font-style:italic>#DNS Domain Name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>CmsPlugins</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- ActiveDirectory<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>DomainJoinConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>DnsName</span>:<span style=color:#bbb> </span>contoso.com <span style=color:#bbb> </span><span style=color:#080;font-style:italic>#DNS Domain Name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>DnsTreeName</span>:<span style=color:#bbb> </span>contoso.com<span style=color:#bbb> </span><span style=color:#080;font-style:italic>#DNS Domain Name Root</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>Guid</span>:<span style=color:#bbb> </span>244818ae-87ac-4fcd-92ec-e79e5252348a <span style=color:#bbb> </span><span style=color:#080;font-style:italic>#GUID</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>MachineAccountName</span>:<span style=color:#bbb> </span>WebApp1<span style=color:#bbb> </span><span style=color:#080;font-style:italic>#Username of the GMSA account</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>NetBiosName</span>:<span style=color:#bbb> </span>CONTOSO <span style=color:#bbb> </span><span style=color:#080;font-style:italic>#NETBIOS Domain Name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>Sid</span>:<span style=color:#bbb> </span>S-1-5-21-2126449477-2524075714-3094792973<span style=color:#bbb> </span><span style=color:#080;font-style:italic>#SID of GMSA</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>The above credential spec resource may be saved as <code>gmsa-Webapp1-credspec.yaml</code> and applied to the cluster using: <code>kubectl apply -f gmsa-Webapp1-credspec.yml</code></p><h2 id=configure-cluster-role-to-enable-rbac-on-specific-gmsa-credential-specs>Configure cluster role to enable RBAC on specific GMSA credential specs</h2><p>A cluster role needs to be defined for each GMSA credential spec resource. This authorizes the <code>use</code> verb on a specific GMSA resource by a subject which is typically a service account. The following example shows a cluster role that authorizes usage of the <code>gmsa-WebApp1</code> credential spec from above. Save the file as gmsa-webapp1-role.yaml and apply using <code>kubectl apply -f gmsa-webapp1-role.yaml</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic>#Create the Role to read the credspec</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>webapp1-role<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;windows.k8s.io&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;gmsacredentialspecs&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;use&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceNames</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;gmsa-WebApp1&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=assign-role-to-service-accounts-to-use-specific-gmsa-credspecs>Assign role to service accounts to use specific GMSA credspecs</h2><p>A service account (that Pods will be configured with) needs to be bound to the cluster role create above. This authorizes the service account to use the desired GMSA credential spec resource. The following shows the default service account being bound to a cluster role <code>webapp1-role</code> to use <code>gmsa-WebApp1</code> credential spec resource created above.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>RoleBinding<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>allow-default-svc-account-read-on-gmsa-WebApp1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>webapp1-role<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=configure-gmsa-credential-spec-reference-in-pod-spec>Configure GMSA credential spec reference in Pod spec</h2><p>The Pod spec field <code>securityContext.windowsOptions.gmsaCredentialSpecName</code> is used to specify references to desired GMSA credential spec custom resources in Pod specs. This configures all containers in the Pod spec to use the specified GMSA. A sample Pod spec with the annotation populated to refer to <code>gmsa-WebApp1</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>with-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>with-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>with-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>with-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>windowsOptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>gmsaCredentialSpecName</span>:<span style=color:#bbb> </span>gmsa-webapp1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mcr.microsoft.com/windows/servercore/iis:windowsservercore-ltsc2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>windows<span style=color:#bbb>
</span></span></span></code></pre></div><p>Individual containers in a Pod spec can also specify the desired GMSA credspec using a per-container <code>securityContext.windowsOptions.gmsaCredentialSpecName</code> field. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>with-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>with-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>with-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>with-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mcr.microsoft.com/windows/servercore/iis:windowsservercore-ltsc2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>windowsOptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>gmsaCredentialSpecName</span>:<span style=color:#bbb> </span>gmsa-Webapp1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>windows<span style=color:#bbb>
</span></span></span></code></pre></div><p>As Pod specs with GMSA fields populated (as described above) are applied in a cluster, the following sequence of events take place:</p><ol><li><p>The mutating webhook resolves and expands all references to GMSA credential spec resources to the contents of the GMSA credential spec.</p></li><li><p>The validating webhook ensures the service account associated with the Pod is authorized for the <code>use</code> verb on the specified GMSA credential spec.</p></li><li><p>The container runtime configures each Windows container with the specified GMSA credential spec so that the container can assume the identity of the GMSA in Active Directory and access services in the domain using that identity.</p></li></ol><h2 id=authenticating-to-network-shares-using-hostname-or-fqdn>Authenticating to network shares using hostname or FQDN</h2><p>If you are experiencing issues connecting to SMB shares from Pods using hostname or FQDN, but are able to access the shares via their IPv4 address then make sure the following registry key is set on the Windows nodes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd><span style=display:flex><span>reg add <span style=color:#b44>&#34;HKLM\SYSTEM\CurrentControlSet\Services\hns\State&#34;</span> /v EnableCompartmentNamespace /t REG_DWORD /d 1
</span></span></code></pre></div><p>Running Pods will then need to be recreated to pick up the behavior changes.
More information on how this registry key is used can be found <a href=https://github.com/microsoft/hcsshim/blob/885f896c5a8548ca36c88c4b87fd2208c8d16543/internal/uvm/create.go#L74-L83>here</a></p><h2 id=troubleshooting>Troubleshooting</h2><p>If you are having difficulties getting GMSA to work in your environment, there are a few troubleshooting steps you can take.</p><p>First, make sure the credspec has been passed to the Pod. To do this you will need to <code>exec</code> into one of your Pods and check the output of the <code>nltest.exe /parentdomain</code> command.</p><p>In the example below the Pod did not get the credspec correctly:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>kubectl exec -it <span style=color:#a2f>iis-auth</span>-<span style=color:#666>7776966999</span>-n5nzr powershell.exe
</span></span></code></pre></div><p><code>nltest.exe /parentdomain</code> results in the following error:</p><pre tabindex=0><code class=language-output data-lang=output>Getting parent domain failed: Status = 1722 0x6ba RPC_S_SERVER_UNAVAILABLE
</code></pre><p>If your Pod did get the credspec correctly, then next check communication with the domain. First, from inside of your Pod, quickly do an nslookup to find the root of your domain.</p><p>This will tell us 3 things:</p><ol><li>The Pod can reach the DC</li><li>The DC can reach the Pod</li><li>DNS is working correctly.</li></ol><p>If the DNS and communication test passes, next you will need to check if the Pod has established secure channel communication with the domain. To do this, again, <code>exec</code> into your Pod and run the <code>nltest.exe /query</code> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>nltest.exe /query
</span></span></code></pre></div><p>Results in the following output:</p><pre tabindex=0><code class=language-output data-lang=output>I_NetLogonControl failed: Status = 1722 0x6ba RPC_S_SERVER_UNAVAILABLE
</code></pre><p>This tells us that for some reason, the Pod was unable to logon to the domain using the account specified in the credspec. You can try to repair the secure channel by running the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>nltest /sc_reset<span>:</span>domain.example
</span></span></code></pre></div><p>If the command is successful you will see and output similar to this:</p><pre tabindex=0><code class=language-output data-lang=output>Flags: 30 HAS_IP  HAS_TIMESERV
Trusted DC Name \\dc10.domain.example
Trusted DC Connection Status Status = 0 0x0 NERR_Success
The command completed successfully
</code></pre><p>If the above corrects the error, you can automate the step by adding the following lifecycle hook to your Pod spec. If it did not correct the error, you will need to examine your credspec again and confirm that it is correct and complete.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.domain.example/iis-auth:1809v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>lifecycle</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>postStart</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>exec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;powershell.exe&#34;</span>,<span style=color:#b44>&#34;-command&#34;</span>,<span style=color:#b44>&#34;do { Restart-Service -Name netlogon } while ( $($Result = (nltest.exe /query); if ($Result -like &#39;*0x0 NERR_Success*&#39;) {return $true} else {return $false}) -eq $false)&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span></code></pre></div><p>If you add the <code>lifecycle</code> section show above to your Pod spec, the Pod will execute the commands listed to restart the <code>netlogon</code> service until the <code>nltest.exe /query</code> command exits without error.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f5da7517bee8a8807431d9fc65263b39>3.4 - Configure RunAsUserName for Windows pods and containers</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [stable]</code></div><p>This page shows how to use the <code>runAsUserName</code> setting for Pods and containers that will run on Windows nodes. This is roughly equivalent of the Linux-specific <code>runAsUser</code> setting, allowing you to run applications in a container as a different username than the default.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster and the kubectl command-line tool must be configured to communicate with your cluster. The cluster is expected to have Windows worker nodes where pods with containers running Windows workloads will get scheduled.</p><h2 id=set-the-username-for-a-pod>Set the Username for a Pod</h2><p>To specify the username with which to execute the Pod's container processes, include the <code>securityContext</code> field (<a href=/docs/reference/generated/kubernetes-api/v1.25/#podsecuritycontext-v1-core>PodSecurityContext</a>) in the Pod specification, and within it, the <code>windowsOptions</code> (<a href=/docs/reference/generated/kubernetes-api/v1.25/#windowssecuritycontextoptions-v1-core>WindowsSecurityContextOptions</a>) field containing the <code>runAsUserName</code> field.</p><p>The Windows security context options that you specify for a Pod apply to all Containers and init Containers in the Pod.</p><p>Here is a configuration file for a Windows Pod that has the <code>runAsUserName</code> field set:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/windows/run-as-username-pod.yaml download=windows/run-as-username-pod.yaml><code>windows/run-as-username-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("windows-run-as-username-pod-yaml")' title="Copy windows/run-as-username-pod.yaml to clipboard"></img></div><div class=includecode id=windows-run-as-username-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>run-as-username-pod-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>windowsOptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>runAsUserName</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;ContainerUser&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>run-as-username-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mcr.microsoft.com/windows/servercore:ltsc2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;ping&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-t&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;localhost&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>windows<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/windows/run-as-username-pod.yaml
</span></span></code></pre></div><p>Verify that the Pod's Container is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod run-as-username-pod-demo
</span></span></code></pre></div><p>Get a shell to the running Container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it run-as-username-pod-demo -- powershell
</span></span></code></pre></div><p>Check that the shell is running user the correct username:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>echo </span><span style=color:#b8860b>$env:USERNAME</span>
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>ContainerUser
</code></pre><h2 id=set-the-username-for-a-container>Set the Username for a Container</h2><p>To specify the username with which to execute a Container's processes, include the <code>securityContext</code> field (<a href=/docs/reference/generated/kubernetes-api/v1.25/#securitycontext-v1-core>SecurityContext</a>) in the Container manifest, and within it, the <code>windowsOptions</code> (<a href=/docs/reference/generated/kubernetes-api/v1.25/#windowssecuritycontextoptions-v1-core>WindowsSecurityContextOptions</a>) field containing the <code>runAsUserName</code> field.</p><p>The Windows security context options that you specify for a Container apply only to that individual Container, and they override the settings made at the Pod level.</p><p>Here is the configuration file for a Pod that has one Container, and the <code>runAsUserName</code> field is set at the Pod level and the Container level:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/windows/run-as-username-container.yaml download=windows/run-as-username-container.yaml><code>windows/run-as-username-container.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("windows-run-as-username-container-yaml")' title="Copy windows/run-as-username-container.yaml to clipboard"></img></div><div class=includecode id=windows-run-as-username-container-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>run-as-username-container-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>windowsOptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>runAsUserName</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;ContainerUser&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>run-as-username-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mcr.microsoft.com/windows/servercore:ltsc2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;ping&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-t&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;localhost&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>windowsOptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>runAsUserName</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;ContainerAdministrator&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>windows<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/windows/run-as-username-container.yaml
</span></span></code></pre></div><p>Verify that the Pod's Container is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod run-as-username-container-demo
</span></span></code></pre></div><p>Get a shell to the running Container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it run-as-username-container-demo -- powershell
</span></span></code></pre></div><p>Check that the shell is running user the correct username (the one set at the Container level):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>echo </span><span style=color:#b8860b>$env:USERNAME</span>
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>ContainerAdministrator
</code></pre><h2 id=windows-username-limitations>Windows Username limitations</h2><p>In order to use this feature, the value set in the <code>runAsUserName</code> field must be a valid username. It must have the following format: <code>DOMAIN\USER</code>, where <code>DOMAIN\</code> is optional. Windows user names are case insensitive. Additionally, there are some restrictions regarding the <code>DOMAIN</code> and <code>USER</code>:</p><ul><li>The <code>runAsUserName</code> field cannot be empty, and it cannot contain control characters (ASCII values: <code>0x00-0x1F</code>, <code>0x7F</code>)</li><li>The <code>DOMAIN</code> must be either a NetBios name, or a DNS name, each with their own restrictions:<ul><li>NetBios names: maximum 15 characters, cannot start with <code>.</code> (dot), and cannot contain the following characters: <code>\ / : * ? " &lt; > |</code></li><li>DNS names: maximum 255 characters, contains only alphanumeric characters, dots, and dashes, and it cannot start or end with a <code>.</code> (dot) or <code>-</code> (dash).</li></ul></li><li>The <code>USER</code> must have at most 20 characters, it cannot contain <em>only</em> dots or spaces, and it cannot contain the following characters: <code>" / \ [ ] : ; | = , + * ? &lt; > @</code>.</li></ul><p>Examples of acceptable values for the <code>runAsUserName</code> field: <code>ContainerAdministrator</code>, <code>ContainerUser</code>, <code>NT AUTHORITY\NETWORK SERVICE</code>, <code>NT AUTHORITY\LOCAL SERVICE</code>.</p><p>For more information about these limtations, check <a href=https://support.microsoft.com/en-us/help/909264/naming-conventions-in-active-directory-for-computers-domains-sites-and>here</a> and <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/new-localuser?view=powershell-5.1">here</a>.</p><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/concepts/windows/user-guide/>Guide for scheduling Windows containers in Kubernetes</a></li><li><a href=/docs/concepts/windows/user-guide/#managing-workload-identity-with-group-managed-service-accounts>Managing Workload Identity with Group Managed Service Accounts (GMSA)</a></li><li><a href=/docs/tasks/configure-pod-container/configure-gmsa/>Configure GMSA for Windows pods and containers</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-3fbf113e9e5f4b46f8ccb91a048509c0>3.5 - Create a Windows HostProcess Pod</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.23 [beta]</code></div><p>Windows HostProcess containers enable you to run containerized
workloads on a Windows host. These containers operate as
normal processes but have access to the host network namespace,
storage, and devices when given the appropriate user privileges.
HostProcess containers can be used to deploy network plugins,
storage configurations, device plugins, kube-proxy, and other
components to Windows nodes without the need for dedicated proxies or
the direct installation of host services.</p><p>Administrative tasks such as installation of security patches, event
log collection, and more can be performed without requiring cluster operators to
log onto each Windows node. HostProcess containers can run as any user that is
available on the host or is in the domain of the host machine, allowing administrators
to restrict resource access through user permissions. While neither filesystem or process
isolation are supported, a new volume is created on the host upon starting the container
to give it a clean and consolidated workspace. HostProcess containers can also be built on
top of existing Windows base images and do not inherit the same
<a href=https://docs.microsoft.com/virtualization/windowscontainers/deploy-containers/version-compatibility>compatibility requirements</a>
as Windows server containers, meaning that the version of the base images does not need
to match that of the host. It is, however, recommended that you use the same base image
version as your Windows Server container workloads to ensure you do not have any unused
images taking up space on the node. HostProcess containers also support
<a href=#volume-mounts>volume mounts</a> within the container volume.</p><h3 id=when-should-i-use-a-windows-hostprocess-container>When should I use a Windows HostProcess container?</h3><ul><li>When you need to perform tasks which require the networking namespace of the host.
HostProcess containers have access to the host's network interfaces and IP addresses.</li><li>You need access to resources on the host such as the filesystem, event logs, etc.</li><li>Installation of specific device drivers or Windows services.</li><li>Consolidation of administrative tasks and security policies. This reduces the degree of
privileges needed by Windows nodes.</li></ul><h2 id=before-you-begin>Before you begin</h2><p>This task guide is specific to Kubernetes v1.25.
If you are not running Kubernetes v1.25, check the documentation for
that version of Kubernetes.</p><p>In Kubernetes 1.25, the HostProcess container feature is enabled by default. The kubelet will
communicate with containerd directly by passing the hostprocess flag via CRI. You can use the
latest version of containerd (v1.6+) to run HostProcess containers.
<a href=/docs/setup/production-environment/container-runtimes/#containerd>How to install containerd.</a></p><p>To <em>disable</em> HostProcess containers you need to pass the following feature gate flag to the
<strong>kubelet</strong> and <strong>kube-apiserver</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>--feature-gates=WindowsHostProcessContainers=false
</span></span></code></pre></div><p>See <a href=/docs/reference/command-line-tools-reference/feature-gates/#overview>Features Gates</a>
documentation for more details.</p><h2 id=limitations>Limitations</h2><p>These limitations are relevant for Kubernetes v1.25:</p><ul><li>HostProcess containers require containerd 1.6 or higher
<a class=glossary-tooltip title='The container runtime is the software that is responsible for running containers.' data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label='container runtime'>container runtime</a>.</li><li>HostProcess pods can only contain HostProcess containers. This is a current limitation
of the Windows OS; non-privileged Windows containers cannot share a vNIC with the host IP namespace.</li><li>HostProcess containers run as a process on the host and do not have any degree of
isolation other than resource constraints imposed on the HostProcess user account. Neither
filesystem or Hyper-V isolation are supported for HostProcess containers.</li><li>Volume mounts are supported and are mounted under the container volume. See
<a href=#volume-mounts>Volume Mounts</a></li><li>A limited set of host user accounts are available for HostProcess containers by default.
See <a href=#choosing-a-user-account>Choosing a User Account</a>.</li><li>Resource limits (disk, memory, cpu count) are supported in the same fashion as processes
on the host.</li><li>Both Named pipe mounts and Unix domain sockets are <strong>not</strong> supported and should instead
be accessed via their path on the host (e.g. \\.\pipe\*)</li></ul><h2 id=hostprocess-pod-configuration-requirements>HostProcess Pod configuration requirements</h2><p>Enabling a Windows HostProcess pod requires setting the right configurations in the pod security
configuration. Of the policies defined in the <a href=/docs/concepts/security/pod-security-standards>Pod Security Standards</a>
HostProcess pods are disallowed by the baseline and restricted policies. It is therefore recommended
that HostProcess pods run in alignment with the privileged profile.</p><p>When running under the privileged policy, here are
the configurations which need to be set to enable the creation of a HostProcess pod:</p><table><caption style=display:none>Privileged policy specification</caption><thead><tr><th>Control</th><th>Policy</th></tr></thead><tbody><tr><td style=white-space:nowrap><a href=/docs/concepts/security/pod-security-standards><tt>securityContext.windowsOptions.hostProcess</tt></a></td><td><p>Windows pods offer the ability to run <a href=/docs/tasks/configure-pod-container/create-hostprocess-pod>HostProcess containers</a> which enables privileged access to the Windows node.</p><p><strong>Allowed Values</strong></p><ul><li><code>true</code></li></ul></td></tr><tr><td style=white-space:nowrap><a href=/docs/concepts/security/pod-security-standards><tt>hostNetwork</tt></a></td><td><p>Will be in host network by default initially. Support
to set network to a different compartment may be desirable in
the future.</p><p><strong>Allowed Values</strong></p><ul><li><code>true</code></li></ul></td></tr><tr><td style=white-space:nowrap><a href=/docs/tasks/configure-pod-container/configure-runasusername/><tt>securityContext.windowsOptions.runAsUsername</tt></a></td><td><p>Specification of which user the HostProcess container should run as is required for the pod spec.</p><p><strong>Allowed Values</strong></p><ul><li><code>NT AUTHORITY\SYSTEM</code></li><li><code>NT AUTHORITY\Local service</code></li><li><code>NT AUTHORITY\NetworkService</code></li></ul></td></tr><tr><td style=white-space:nowrap><a href=/docs/concepts/security/pod-security-standards><tt>runAsNonRoot</tt></a></td><td><p>Because HostProcess containers have privileged access to the host, the <tt>runAsNonRoot</tt> field cannot be set to true.</p><p><strong>Allowed Values</strong></p><ul><li>Undefined/Nil</li><li><code>false</code></li></ul></td></tr></tbody></table><h3 id=manifest-example>Example manifest (excerpt)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>windowsOptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostProcess</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>runAsUserName</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;NT AUTHORITY\\Local service&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>image1:latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- ping<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- -t<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#666>127.0.0.1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;kubernetes.io/os&#34;: </span>windows<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=volume-mounts>Volume mounts</h2><p>HostProcess containers support the ability to mount volumes within the container volume space.
Applications running inside the container can access volume mounts directly via relative or
absolute paths. An environment variable <code>$CONTAINER_SANDBOX_MOUNT_POINT</code> is set upon container
creation and provides the absolute host path to the container volume. Relative paths are based
upon the <code>.spec.containers.volumeMounts.mountPath</code> configuration.</p><h3 id=volume-mount-example>Example</h3><p>To access service account tokens the following path structures are supported within the container:</p><p><code>.\var\run\secrets\kubernetes.io\serviceaccount\</code></p><p><code>$CONTAINER_SANDBOX_MOUNT_POINT\var\run\secrets\kubernetes.io\serviceaccount\</code></p><h2 id=resource-limits>Resource limits</h2><p>Resource limits (disk, memory, cpu count) are applied to the job and are job wide.
For example, with a limit of 10MB set, the memory allocated for any HostProcess job object
will be capped at 10MB. This is the same behavior as other Windows container types.
These limits would be specified the same way they are currently for whatever orchestrator
or runtime is being used. The only difference is in the disk resource usage calculation
used for resource tracking due to the difference in how HostProcess containers are bootstrapped.</p><h2 id=choosing-a-user-account>Choosing a user account</h2><p>HostProcess containers support the ability to run as one of three supported Windows service accounts:</p><ul><li><strong><a href=https://docs.microsoft.com/windows/win32/services/localsystem-account>LocalSystem</a></strong></li><li><strong><a href=https://docs.microsoft.com/windows/win32/services/localservice-account>LocalService</a></strong></li><li><strong><a href=https://docs.microsoft.com/windows/win32/services/networkservice-account>NetworkService</a></strong></li></ul><p>You should select an appropriate Windows service account for each HostProcess
container, aiming to limit the degree of privileges so as to avoid accidental (or even
malicious) damage to the host. The LocalSystem service account has the highest level
of privilege of the three and should be used only if absolutely necessary. Where possible,
use the LocalService service account as it is the least privileged of the three options.</p><h2 id=troubleshooting-hostprocess-containers>Troubleshooting HostProcess containers</h2><ul><li><p>HostProcess containers fail to start with <code>failed to create user process token: failed to logon user: Access is denied.: unknown</code></p><p>Ensure containerd is running as <code>LocalSystem</code> or <code>LocalService</code> service accounts. User accounts (even Administrator accounts) do not have permissions to create logon tokens for any of the supported <a href=#choosing-a-user-account>user accounts</a>.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-904cea8c8efd5c0d33adbfe579ec2dd2>3.6 - Configure Quality of Service for Pods</h1><p>This page shows how to configure Pods so that they will be assigned particular
Quality of Service (QoS) classes. Kubernetes uses QoS classes to make decisions about
scheduling and evicting Pods.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=qos-classes>QoS classes</h2><p>When Kubernetes creates a Pod it assigns one of these QoS classes to the Pod:</p><ul><li>Guaranteed</li><li>Burstable</li><li>BestEffort</li></ul><h2 id=create-a-namespace>Create a namespace</h2><p>Create a namespace so that the resources you create in this exercise are
isolated from the rest of your cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace qos-example
</span></span></code></pre></div><h2 id=create-a-pod-that-gets-assigned-a-qos-class-of-guaranteed>Create a Pod that gets assigned a QoS class of Guaranteed</h2><p>For a Pod to be given a QoS class of Guaranteed:</p><ul><li>Every Container in the Pod must have a memory limit and a memory request.</li><li>For every Container in the Pod, the memory limit must equal the memory request.</li><li>Every Container in the Pod must have a CPU limit and a CPU request.</li><li>For every Container in the Pod, the CPU limit must equal the CPU request.</li></ul><p>These restrictions apply to init containers and app containers equally.</p><p>Here is the configuration file for a Pod that has one Container. The Container has a memory limit and a
memory request, both equal to 200 MiB. The Container has a CPU limit and a CPU request, both equal to 700 milliCPU:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/qos/qos-pod.yaml download=pods/qos/qos-pod.yaml><code>pods/qos/qos-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-qos-qos-pod-yaml")' title="Copy pods/qos/qos-pod.yaml to clipboard"></img></div><div class=includecode id=pods-qos-qos-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>qos-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;700m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;700m&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/qos/qos-pod.yaml --namespace<span style=color:#666>=</span>qos-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod qos-demo --namespace<span style=color:#666>=</span>qos-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows that Kubernetes gave the Pod a QoS class of Guaranteed. The output also
verifies that the Pod Container has a memory request that matches its memory limit, and it has
a CPU request that matches its CPU limit.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>700m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>200Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>700m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>200Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>qosClass</span>:<span style=color:#bbb> </span>Guaranteed<span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If a Container specifies its own memory limit, but does not specify a memory request, Kubernetes
automatically assigns a memory request that matches the limit. Similarly, if a Container specifies its own
CPU limit, but does not specify a CPU request, Kubernetes automatically assigns a CPU request that matches
the limit.</div><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod qos-demo --namespace<span style=color:#666>=</span>qos-example
</span></span></code></pre></div><h2 id=create-a-pod-that-gets-assigned-a-qos-class-of-burstable>Create a Pod that gets assigned a QoS class of Burstable</h2><p>A Pod is given a QoS class of Burstable if:</p><ul><li>The Pod does not meet the criteria for QoS class Guaranteed.</li><li>At least one Container in the Pod has a memory or CPU request or limit.</li></ul><p>Here is the configuration file for a Pod that has one Container. The Container has a memory limit of 200 MiB
and a memory request of 100 MiB.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/qos/qos-pod-2.yaml download=pods/qos/qos-pod-2.yaml><code>pods/qos/qos-pod-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-qos-qos-pod-2-yaml")' title="Copy pods/qos/qos-pod-2.yaml to clipboard"></img></div><div class=includecode id=pods-qos-qos-pod-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>qos-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/qos/qos-pod-2.yaml --namespace<span style=color:#666>=</span>qos-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod qos-demo-2 --namespace<span style=color:#666>=</span>qos-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows that Kubernetes gave the Pod a QoS class of Burstable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>200Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>qosClass</span>:<span style=color:#bbb> </span>Burstable<span style=color:#bbb>
</span></span></span></code></pre></div><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod qos-demo-2 --namespace<span style=color:#666>=</span>qos-example
</span></span></code></pre></div><h2 id=create-a-pod-that-gets-assigned-a-qos-class-of-besteffort>Create a Pod that gets assigned a QoS class of BestEffort</h2><p>For a Pod to be given a QoS class of BestEffort, the Containers in the Pod must not
have any memory or CPU limits or requests.</p><p>Here is the configuration file for a Pod that has one Container. The Container has no memory or CPU
limits or requests:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/qos/qos-pod-3.yaml download=pods/qos/qos-pod-3.yaml><code>pods/qos/qos-pod-3.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-qos-qos-pod-3-yaml")' title="Copy pods/qos/qos-pod-3.yaml to clipboard"></img></div><div class=includecode id=pods-qos-qos-pod-3-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>qos-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-3-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/qos/qos-pod-3.yaml --namespace<span style=color:#666>=</span>qos-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod qos-demo-3 --namespace<span style=color:#666>=</span>qos-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows that Kubernetes gave the Pod a QoS class of BestEffort.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>qosClass</span>:<span style=color:#bbb> </span>BestEffort<span style=color:#bbb>
</span></span></span></code></pre></div><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod qos-demo-3 --namespace<span style=color:#666>=</span>qos-example
</span></span></code></pre></div><h2 id=create-a-pod-that-has-two-containers>Create a Pod that has two Containers</h2><p>Here is the configuration file for a Pod that has two Containers. One container specifies a memory
request of 200 MiB. The other Container does not specify any requests or limits.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/qos/qos-pod-4.yaml download=pods/qos/qos-pod-4.yaml><code>pods/qos/qos-pod-4.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-qos-qos-pod-4-yaml")' title="Copy pods/qos/qos-pod-4.yaml to clipboard"></img></div><div class=includecode id=pods-qos-qos-pod-4-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>qos-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-4-ctr-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-4-ctr-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>redis<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Notice that this Pod meets the criteria for QoS class Burstable. That is, it does not meet the
criteria for QoS class Guaranteed, and one of its Containers has a memory request.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/qos/qos-pod-4.yaml --namespace<span style=color:#666>=</span>qos-example
</span></span></code></pre></div><p>View detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod qos-demo-4 --namespace<span style=color:#666>=</span>qos-example --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output shows that Kubernetes gave the Pod a QoS class of Burstable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-4-ctr-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>200Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>qos-demo-4-ctr-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>qosClass</span>:<span style=color:#bbb> </span>Burstable<span style=color:#bbb>
</span></span></span></code></pre></div><p>Delete your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod qos-demo-4 --namespace<span style=color:#666>=</span>qos-example
</span></span></code></pre></div><h2 id=clean-up>Clean up</h2><p>Delete your namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete namespace qos-example
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-app-developers>For app developers</h3><ul><li><p><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></p></li><li><p><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></p></li></ul><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>Configure Default Memory Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/>Configure Default CPU Requests and Limits for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/>Configure Minimum and Maximum Memory Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/>Configure Minimum and Maximum CPU Constraints for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/>Configure Memory and CPU Quotas for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/manage-resources/quota-pod-namespace/>Configure a Pod Quota for a Namespace</a></p></li><li><p><a href=/docs/tasks/administer-cluster/quota-api-object/>Configure Quotas for API Objects</a></p></li><li><p><a href=/docs/tasks/administer-cluster/topology-manager/>Control Topology Management policies on a node</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4219ac6ab56a3b88d20305083d57d03c>3.7 - Assign Extended Resources to a Container</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [stable]</code></div><p>This page shows how to assign extended resources to a Container.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><p>Before you do this exercise, do the exercise in
<a href=/docs/tasks/administer-cluster/extended-resource-node/>Advertise Extended Resources for a Node</a>.
That will configure one of your Nodes to advertise a dongle resource.</p><h2 id=assign-an-extended-resource-to-a-pod>Assign an extended resource to a Pod</h2><p>To request an extended resource, include the <code>resources:requests</code> field in your
Container manifest. Extended resources are fully qualified with any domain outside of
<code>*.kubernetes.io/</code>. Valid extended resource names have the form <code>example.com/foo</code> where
<code>example.com</code> is replaced with your organization's domain and <code>foo</code> is a
descriptive resource name.</p><p>Here is the configuration file for a Pod that has one Container:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/resource/extended-resource-pod.yaml download=pods/resource/extended-resource-pod.yaml><code>pods/resource/extended-resource-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-resource-extended-resource-pod-yaml")' title="Copy pods/resource/extended-resource-pod.yaml to clipboard"></img></div><div class=includecode id=pods-resource-extended-resource-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>extended-resource-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>extended-resource-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/dongle</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/dongle</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the configuration file, you can see that the Container requests 3 dongles.</p><p>Create a Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/resource/extended-resource-pod.yaml
</span></span></code></pre></div><p>Verify that the Pod is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod extended-resource-demo
</span></span></code></pre></div><p>Describe the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod extended-resource-demo
</span></span></code></pre></div><p>The output shows dongle requests:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>Limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>example.com/dongle</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>Requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>example.com/dongle</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=attempt-to-create-a-second-pod>Attempt to create a second Pod</h2><p>Here is the configuration file for a Pod that has one Container. The Container requests
two dongles.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/resource/extended-resource-pod-2.yaml download=pods/resource/extended-resource-pod-2.yaml><code>pods/resource/extended-resource-pod-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-resource-extended-resource-pod-2-yaml")' title="Copy pods/resource/extended-resource-pod-2.yaml to clipboard"></img></div><div class=includecode id=pods-resource-extended-resource-pod-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>extended-resource-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>extended-resource-demo-2-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/dongle</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>example.com/dongle</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Kubernetes will not be able to satisfy the request for two dongles, because the first Pod
used three of the four available dongles.</p><p>Attempt to create a Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/resource/extended-resource-pod-2.yaml
</span></span></code></pre></div><p>Describe the Pod</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod extended-resource-demo-2
</span></span></code></pre></div><p>The output shows that the Pod cannot be scheduled, because there is no Node that has
2 dongles available:</p><pre tabindex=0><code>Conditions:
  Type    Status
  PodScheduled  False
...
Events:
  ...
  ... Warning   FailedScheduling  pod (extended-resource-demo-2) failed to fit in any node
fit failure summary on nodes : Insufficient example.com/dongle (1)
</code></pre><p>View the Pod status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod extended-resource-demo-2
</span></span></code></pre></div><p>The output shows that the Pod was created, but not scheduled to run on a Node.
It has a status of Pending:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>NAME                       READY     STATUS    RESTARTS   AGE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>extended-resource-demo-2   0/1       Pending   0          6m<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=clean-up>Clean up</h2><p>Delete the Pods that you created for this exercise:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod extended-resource-demo
</span></span><span style=display:flex><span>kubectl delete pod extended-resource-demo-2
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=for-application-developers>For application developers</h3><ul><li><a href=/docs/tasks/configure-pod-container/assign-memory-resource/>Assign Memory Resources to Containers and Pods</a></li><li><a href=/docs/tasks/configure-pod-container/assign-cpu-resource/>Assign CPU Resources to Containers and Pods</a></li></ul><h3 id=for-cluster-administrators>For cluster administrators</h3><ul><li><a href=/docs/tasks/administer-cluster/extended-resource-node/>Advertise Extended Resources for a Node</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-484833fb880d1e179cc2965d15f84da5>3.8 - Configure a Pod to Use a Volume for Storage</h1><p>This page shows how to configure a Pod to use a Volume for storage.</p><p>A Container's file system lives only as long as the Container does. So when a
Container terminates and restarts, filesystem changes are lost. For more
consistent storage that is independent of the Container, you can use a
<a href=/docs/concepts/storage/volumes/>Volume</a>. This is especially important for stateful
applications, such as key-value stores (such as Redis) and databases.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=configure-a-volume-for-a-pod>Configure a volume for a Pod</h2><p>In this exercise, you create a Pod that runs one Container. This Pod has a
Volume of type
<a href=/docs/concepts/storage/volumes/#emptydir>emptyDir</a>
that lasts for the life of the Pod, even if the Container terminates and
restarts. Here is the configuration file for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/storage/redis.yaml download=pods/storage/redis.yaml><code>pods/storage/redis.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-storage-redis-yaml")' title="Copy pods/storage/redis.yaml to clipboard"></img></div><div class=includecode id=pods-storage-redis-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>redis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>redis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>redis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>redis-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/data/redis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>redis-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/storage/redis.yaml
</span></span></code></pre></div></li><li><p>Verify that the Pod's Container is running, and then watch for changes to
the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod redis --watch
</span></span></code></pre></div><p>The output looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME      READY     STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>redis     1/1       Running   <span style=color:#666>0</span>          13s
</span></span></code></pre></div></li><li><p>In another terminal, get a shell to the running Container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it redis -- /bin/bash
</span></span></code></pre></div></li><li><p>In your shell, go to <code>/data/redis</code>, and then create a file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@redis:/data# <span style=color:#a2f>cd</span> /data/redis/
</span></span><span style=display:flex><span>root@redis:/data/redis# <span style=color:#a2f>echo</span> Hello &gt; test-file
</span></span></code></pre></div></li><li><p>In your shell, list the running processes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@redis:/data/redis# apt-get update
</span></span><span style=display:flex><span>root@redis:/data/redis# apt-get install procps
</span></span><span style=display:flex><span>root@redis:/data/redis# ps aux
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style=display:flex><span>redis        <span style=color:#666>1</span>  0.1  0.1  <span style=color:#666>33308</span>  <span style=color:#666>3828</span> ?        Ssl  00:46   0:00 redis-server *:6379
</span></span><span style=display:flex><span>root        <span style=color:#666>12</span>  0.0  0.0  <span style=color:#666>20228</span>  <span style=color:#666>3020</span> ?        Ss   00:47   0:00 /bin/bash
</span></span><span style=display:flex><span>root        <span style=color:#666>15</span>  0.0  0.0  <span style=color:#666>17500</span>  <span style=color:#666>2072</span> ?        R+   00:48   0:00 ps aux
</span></span></code></pre></div></li><li><p>In your shell, kill the Redis process:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@redis:/data/redis# <span style=color:#a2f>kill</span> &lt;pid&gt;
</span></span></code></pre></div><p>where <code>&lt;pid></code> is the Redis process ID (PID).</p></li><li><p>In your original terminal, watch for changes to the Redis Pod. Eventually,
you will see something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME      READY     STATUS     RESTARTS   AGE
</span></span><span style=display:flex><span>redis     1/1       Running    <span style=color:#666>0</span>          13s
</span></span><span style=display:flex><span>redis     0/1       Completed  <span style=color:#666>0</span>         6m
</span></span><span style=display:flex><span>redis     1/1       Running    <span style=color:#666>1</span>         6m
</span></span></code></pre></div></li></ol><p>At this point, the Container has terminated and restarted. This is because the
Redis Pod has a
<a href=/docs/reference/generated/kubernetes-api/v1.25/#podspec-v1-core>restartPolicy</a>
of <code>Always</code>.</p><ol><li><p>Get a shell into the restarted Container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it redis -- /bin/bash
</span></span></code></pre></div></li><li><p>In your shell, go to <code>/data/redis</code>, and verify that <code>test-file</code> is still there.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@redis:/data/redis# <span style=color:#a2f>cd</span> /data/redis/
</span></span><span style=display:flex><span>root@redis:/data/redis# ls
</span></span><span style=display:flex><span>test-file
</span></span></code></pre></div></li><li><p>Delete the Pod that you created for this exercise:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod redis
</span></span></code></pre></div></li></ol><h2 id=what-s-next>What's next</h2><ul><li><p>See <a href=/docs/reference/generated/kubernetes-api/v1.25/#volume-v1-core>Volume</a>.</p></li><li><p>See <a href=/docs/reference/generated/kubernetes-api/v1.25/#pod-v1-core>Pod</a>.</p></li><li><p>In addition to the local disk storage provided by <code>emptyDir</code>, Kubernetes
supports many different network-attached storage solutions, including PD on
GCE and EBS on EC2, which are preferred for critical data and will handle
details such as mounting and unmounting the devices on the nodes. See
<a href=/docs/concepts/storage/volumes/>Volumes</a> for more details.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-528d2422215cb9632b7b45e886b023b5>3.9 - Configure a Pod to Use a PersistentVolume for Storage</h1><p>This page shows you how to configure a Pod to use a
<a class=glossary-tooltip title='Claims storage resources defined in a PersistentVolume so that it can be mounted as a volume in a container.' data-toggle=tooltip data-placement=top href=/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims target=_blank aria-label=PersistentVolumeClaim>PersistentVolumeClaim</a>
for storage.
Here is a summary of the process:</p><ol><li><p>You, as cluster administrator, create a PersistentVolume backed by physical
storage. You do not associate the volume with any Pod.</p></li><li><p>You, now taking the role of a developer / cluster user, create a
PersistentVolumeClaim that is automatically bound to a suitable
PersistentVolume.</p></li><li><p>You create a Pod that uses the above PersistentVolumeClaim for storage.</p></li></ol><h2 id=before-you-begin>Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster that has only one Node, and the
<a class=glossary-tooltip title='A command line tool for communicating with a Kubernetes cluster.' data-toggle=tooltip data-placement=top href=/docs/user-guide/kubectl-overview/ target=_blank aria-label=kubectl>kubectl</a>
command-line tool must be configured to communicate with your cluster. If you
do not already have a single-node cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/>Minikube</a>.</p></li><li><p>Familiarize yourself with the material in
<a href=/docs/concepts/storage/persistent-volumes/>Persistent Volumes</a>.</p></li></ul><h2 id=create-an-index-html-file-on-your-node>Create an index.html file on your Node</h2><p>Open a shell to the single Node in your cluster. How you open a shell depends
on how you set up your cluster. For example, if you are using Minikube, you
can open a shell to your Node by entering <code>minikube ssh</code>.</p><p>In your shell on that Node, create a <code>/mnt/data</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># This assumes that your Node uses &#34;sudo&#34; to run commands</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># as the superuser</span>
</span></span><span style=display:flex><span>sudo mkdir /mnt/data
</span></span></code></pre></div><p>In the <code>/mnt/data</code> directory, create an <code>index.html</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># This again assumes that your Node uses &#34;sudo&#34; to run commands</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># as the superuser</span>
</span></span><span style=display:flex><span>sudo sh -c <span style=color:#b44>&#34;echo &#39;Hello from Kubernetes storage&#39; &gt; /mnt/data/index.html&#34;</span>
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If your Node uses a tool for superuser access other than <code>sudo</code>, you can
usually make this work if you replace <code>sudo</code> with the name of the other tool.</div><p>Test that the <code>index.html</code> file exists:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat /mnt/data/index.html
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>Hello from Kubernetes storage
</code></pre><p>You can now close the shell to your Node.</p><h2 id=create-a-persistentvolume>Create a PersistentVolume</h2><p>In this exercise, you create a <em>hostPath</em> PersistentVolume. Kubernetes supports
hostPath for development and testing on a single-node cluster. A hostPath
PersistentVolume uses a file or directory on the Node to emulate network-attached storage.</p><p>In a production cluster, you would not use hostPath. Instead a cluster administrator
would provision a network resource like a Google Compute Engine persistent disk,
an NFS share, or an Amazon Elastic Block Store volume. Cluster administrators can also
use <a href=/docs/reference/generated/kubernetes-api/v1.25/#storageclass-v1-storage-k8s-io>StorageClasses</a>
to set up
<a href=/docs/concepts/storage/dynamic-provisioning/>dynamic provisioning</a>.</p><p>Here is the configuration file for the hostPath PersistentVolume:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/storage/pv-volume.yaml download=pods/storage/pv-volume.yaml><code>pods/storage/pv-volume.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-storage-pv-volume-yaml")' title="Copy pods/storage/pv-volume.yaml to clipboard"></img></div><div class=includecode id=pods-storage-pv-volume-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PersistentVolume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>task-pv-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>local<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>storageClassName</span>:<span style=color:#bbb> </span>manual<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>capacity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>10Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>accessModes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ReadWriteOnce<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/mnt/data&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>The configuration file specifies that the volume is at <code>/mnt/data</code> on the
cluster's Node. The configuration also specifies a size of 10 gibibytes and
an access mode of <code>ReadWriteOnce</code>, which means the volume can be mounted as
read-write by a single Node. It defines the <a href=/docs/concepts/storage/persistent-volumes/#class>StorageClass name</a>
<code>manual</code> for the PersistentVolume, which will be used to bind
PersistentVolumeClaim requests to this PersistentVolume.</p><p>Create the PersistentVolume:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/storage/pv-volume.yaml
</span></span></code></pre></div><p>View information about the PersistentVolume:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pv task-pv-volume
</span></span></code></pre></div><p>The output shows that the PersistentVolume has a <code>STATUS</code> of <code>Available</code>. This
means it has not yet been bound to a PersistentVolumeClaim.</p><pre><code>NAME             CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE
task-pv-volume   10Gi       RWO           Retain          Available             manual                   4s
</code></pre><h2 id=create-a-persistentvolumeclaim>Create a PersistentVolumeClaim</h2><p>The next step is to create a PersistentVolumeClaim. Pods use PersistentVolumeClaims
to request physical storage. In this exercise, you create a PersistentVolumeClaim
that requests a volume of at least three gibibytes that can provide read-write
access for at least one Node.</p><p>Here is the configuration file for the PersistentVolumeClaim:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/storage/pv-claim.yaml download=pods/storage/pv-claim.yaml><code>pods/storage/pv-claim.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-storage-pv-claim-yaml")' title="Copy pods/storage/pv-claim.yaml to clipboard"></img></div><div class=includecode id=pods-storage-pv-claim-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PersistentVolumeClaim<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>task-pv-claim<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>storageClassName</span>:<span style=color:#bbb> </span>manual<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>accessModes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ReadWriteOnce<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>3Gi<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the PersistentVolumeClaim:</p><pre><code>kubectl apply -f https://k8s.io/examples/pods/storage/pv-claim.yaml
</code></pre><p>After you create the PersistentVolumeClaim, the Kubernetes control plane looks
for a PersistentVolume that satisfies the claim's requirements. If the control
plane finds a suitable PersistentVolume with the same StorageClass, it binds the
claim to the volume.</p><p>Look again at the PersistentVolume:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pv task-pv-volume
</span></span></code></pre></div><p>Now the output shows a <code>STATUS</code> of <code>Bound</code>.</p><pre><code>NAME             CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS    CLAIM                   STORAGECLASS   REASON    AGE
task-pv-volume   10Gi       RWO           Retain          Bound     default/task-pv-claim   manual                   2m
</code></pre><p>Look at the PersistentVolumeClaim:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pvc task-pv-claim
</span></span></code></pre></div><p>The output shows that the PersistentVolumeClaim is bound to your PersistentVolume,
<code>task-pv-volume</code>.</p><pre><code>NAME            STATUS    VOLUME           CAPACITY   ACCESSMODES   STORAGECLASS   AGE
task-pv-claim   Bound     task-pv-volume   10Gi       RWO           manual         30s
</code></pre><h2 id=create-a-pod>Create a Pod</h2><p>The next step is to create a Pod that uses your PersistentVolumeClaim as a volume.</p><p>Here is the configuration file for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/storage/pv-pod.yaml download=pods/storage/pv-pod.yaml><code>pods/storage/pv-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-storage-pv-pod-yaml")' title="Copy pods/storage/pv-pod.yaml to clipboard"></img></div><div class=includecode id=pods-storage-pv-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>task-pv-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>task-pv-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>persistentVolumeClaim</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>claimName</span>:<span style=color:#bbb> </span>task-pv-claim<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>task-pv-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;http-server&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/usr/share/nginx/html&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>task-pv-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Notice that the Pod's configuration file specifies a PersistentVolumeClaim, but
it does not specify a PersistentVolume. From the Pod's point of view, the claim
is a volume.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/storage/pv-pod.yaml
</span></span></code></pre></div><p>Verify that the container in the Pod is running;</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod task-pv-pod
</span></span></code></pre></div><p>Get a shell to the container running in your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it task-pv-pod -- /bin/bash
</span></span></code></pre></div><p>In your shell, verify that nginx is serving the <code>index.html</code> file from the
hostPath volume:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Be sure to run these 3 commands inside the root shell that comes from</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># running &#34;kubectl exec&#34; in the previous step</span>
</span></span><span style=display:flex><span>apt update
</span></span><span style=display:flex><span>apt install curl
</span></span><span style=display:flex><span>curl http://localhost/
</span></span></code></pre></div><p>The output shows the text that you wrote to the <code>index.html</code> file on the
hostPath volume:</p><pre><code>Hello from Kubernetes storage
</code></pre><p>If you see that message, you have successfully configured a Pod to
use storage from a PersistentVolumeClaim.</p><h2 id=clean-up>Clean up</h2><p>Delete the Pod, the PersistentVolumeClaim and the PersistentVolume:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod task-pv-pod
</span></span><span style=display:flex><span>kubectl delete pvc task-pv-claim
</span></span><span style=display:flex><span>kubectl delete pv task-pv-volume
</span></span></code></pre></div><p>If you don't already have a shell open to the Node in your cluster,
open a new shell the same way that you did earlier.</p><p>In the shell on your Node, remove the file and directory that you created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># This assumes that your Node uses &#34;sudo&#34; to run commands</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># as the superuser</span>
</span></span><span style=display:flex><span>sudo rm /mnt/data/index.html
</span></span><span style=display:flex><span>sudo rmdir /mnt/data
</span></span></code></pre></div><p>You can now close the shell to your Node.</p><h2 id=mounting-the-same-persistentvolume-in-two-places>Mounting the same persistentVolume in two places</h2><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/storage/pv-duplicate.yaml download=pods/storage/pv-duplicate.yaml><code>pods/storage/pv-duplicate.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-storage-pv-duplicate-yaml")' title="Copy pods/storage/pv-duplicate.yaml to clipboard"></img></div><div class=includecode id=pods-storage-pv-duplicate-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># a mount for site-data</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/usr/share/nginx/html<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>subPath</span>:<span style=color:#bbb> </span>html<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># another mount for nginx config</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/nginx/nginx.conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>subPath</span>:<span style=color:#bbb> </span>nginx.conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>persistentVolumeClaim</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>claimName</span>:<span style=color:#bbb> </span>test-nfs-claim<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>You can perform 2 volume mounts on your nginx container:</p><p><code>/usr/share/nginx/html</code> for the static website
<code>/etc/nginx/nginx.conf</code> for the default config</p><h2 id=access-control>Access control</h2><p>Storage configured with a group ID (GID) allows writing only by Pods using the same
GID. Mismatched or missing GIDs cause permission denied errors. To reduce the
need for coordination with users, an administrator can annotate a PersistentVolume
with a GID. Then the GID is automatically added to any Pod that uses the
PersistentVolume.</p><p>Use the <code>pv.beta.kubernetes.io/gid</code> annotation as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PersistentVolume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pv1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pv.beta.kubernetes.io/gid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1234&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>When a Pod consumes a PersistentVolume that has a GID annotation, the annotated GID
is applied to all containers in the Pod in the same way that GIDs specified in the
Pod's security context are. Every GID, whether it originates from a PersistentVolume
annotation or the Pod's specification, is applied to the first process run in
each container.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> When a Pod consumes a PersistentVolume, the GIDs associated with the
PersistentVolume are not present on the Pod resource itself.</div><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/storage/persistent-volumes/>PersistentVolumes</a>.</li><li>Read the <a href=https://git.k8s.io/design-proposals-archive/storage/persistent-storage.md>Persistent Storage design document</a>.</li></ul><h3 id=reference>Reference</h3><ul><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#persistentvolume-v1-core>PersistentVolume</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#persistentvolumespec-v1-core>PersistentVolumeSpec</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#persistentvolumeclaim-v1-core>PersistentVolumeClaim</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#persistentvolumeclaimspec-v1-core>PersistentVolumeClaimSpec</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4621938ba53c04a77f51b5938a583439>3.10 - Configure a Pod to Use a Projected Volume for Storage</h1><p>This page shows how to use a <a href=/docs/concepts/storage/volumes/#projected><code>projected</code></a> Volume to mount
several existing volume sources into the same directory. Currently, <code>secret</code>, <code>configMap</code>, <code>downwardAPI</code>,
and <code>serviceAccountToken</code> volumes can be projected.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>serviceAccountToken</code> is not a volume type.</div><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=configure-a-projected-volume-for-a-pod>Configure a projected volume for a pod</h2><p>In this exercise, you create username and password <a class=glossary-tooltip title='Stores sensitive information, such as passwords, OAuth tokens, and ssh keys.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/secret/ target=_blank aria-label=Secrets>Secrets</a> from local files. You then create a Pod that runs one container, using a <a href=/docs/concepts/storage/volumes/#projected><code>projected</code></a> Volume to mount the Secrets into the same shared directory.</p><p>Here is the configuration file for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/storage/projected.yaml download=pods/storage/projected.yaml><code>pods/storage/projected.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-storage-projected-yaml")' title="Copy pods/storage/projected.yaml to clipboard"></img></div><div class=includecode id=pods-storage-projected-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-projected-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-projected-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- sleep<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;86400&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>all-in-one<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/projected-volume&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>all-in-one<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>projected</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>sources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>user<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pass<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create the Secrets:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create files containing the username and password:</span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#34;admin&#34;</span> &gt; ./username.txt
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#34;1f2d1e2e67df&#34;</span> &gt; ./password.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Package these files into secrets:</span>
</span></span><span style=display:flex><span>kubectl create secret generic user --from-file<span style=color:#666>=</span>./username.txt
</span></span><span style=display:flex><span>kubectl create secret generic pass --from-file<span style=color:#666>=</span>./password.txt
</span></span></code></pre></div></li><li><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/storage/projected.yaml
</span></span></code></pre></div></li><li><p>Verify that the Pod's container is running, and then watch for changes to
the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get --watch pod test-projected-volume
</span></span></code></pre></div><p>The output looks like this:</p><pre tabindex=0><code>NAME                    READY     STATUS    RESTARTS   AGE
test-projected-volume   1/1       Running   0          14s
</code></pre></li><li><p>In another terminal, get a shell to the running container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it test-projected-volume -- /bin/sh
</span></span></code></pre></div></li><li><p>In your shell, verify that the <code>projected-volume</code> directory contains your projected sources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ls /projected-volume/
</span></span></code></pre></div></li></ol><h2 id=clean-up>Clean up</h2><p>Delete the Pod and the Secrets:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod test-projected-volume
</span></span><span style=display:flex><span>kubectl delete secret user pass
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/storage/volumes/#projected><code>projected</code></a> volumes.</li><li>Read the <a href=https://git.k8s.io/design-proposals-archive/node/all-in-one-volume.md>all-in-one volume</a> design document.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-abd895c0803315e9717e6ff9ec4e3d30>3.11 - Configure a Security Context for a Pod or Container</h1><p>A security context defines privilege and access control settings for
a Pod or Container. Security context settings include, but are not limited to:</p><ul><li><p>Discretionary Access Control: Permission to access an object, like a file, is based on
<a href=https://wiki.archlinux.org/index.php/users_and_groups>user ID (UID) and group ID (GID)</a>.</p></li><li><p><a href=https://en.wikipedia.org/wiki/Security-Enhanced_Linux>Security Enhanced Linux (SELinux)</a>:
Objects are assigned security labels.</p></li><li><p>Running as privileged or unprivileged.</p></li><li><p><a href=https://linux-audit.com/linux-capabilities-hardening-linux-binaries-by-removing-setuid/>Linux Capabilities</a>:
Give a process some privileges, but not all the privileges of the root user.</p></li><li><p><a href=/docs/tutorials/security/apparmor/>AppArmor</a>:
Use program profiles to restrict the capabilities of individual programs.</p></li><li><p><a href=/docs/tutorials/security/seccomp/>Seccomp</a>: Filter a process's system calls.</p></li><li><p><code>allowPrivilegeEscalation</code>: Controls whether a process can gain more privileges than
its parent process. This bool directly controls whether the
<a href=https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt><code>no_new_privs</code></a>
flag gets set on the container process.
<code>allowPrivilegeEscalation</code> is always true when the container:</p><ul><li>is run as privileged, or</li><li>has <code>CAP_SYS_ADMIN</code></li></ul></li><li><p><code>readOnlyRootFilesystem</code>: Mounts the container's root filesystem as read-only.</p></li></ul><p>The above bullets are not a complete set of security context settings -- please see
<a href=/docs/reference/generated/kubernetes-api/v1.25/#securitycontext-v1-core>SecurityContext</a>
for a comprehensive list.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=set-the-security-context-for-a-pod>Set the security context for a Pod</h2><p>To specify security settings for a Pod, include the <code>securityContext</code> field
in the Pod specification. The <code>securityContext</code> field is a
<a href=/docs/reference/generated/kubernetes-api/v1.25/#podsecuritycontext-v1-core>PodSecurityContext</a> object.
The security settings that you specify for a Pod apply to all Containers in the Pod.
Here is a configuration file for a Pod that has a <code>securityContext</code> and an <code>emptyDir</code> volume:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/security/security-context.yaml download=pods/security/security-context.yaml><code>pods/security/security-context.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-security-context-yaml")' title="Copy pods/security/security-context.yaml to clipboard"></img></div><div class=includecode id=pods-security-security-context-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>security-context-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>runAsUser</span>:<span style=color:#bbb> </span><span style=color:#666>1000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>runAsGroup</span>:<span style=color:#bbb> </span><span style=color:#666>3000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>fsGroup</span>:<span style=color:#bbb> </span><span style=color:#666>2000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>sec-ctx-vol<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>sec-ctx-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;sleep 1h&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>sec-ctx-vol<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/data/demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>allowPrivilegeEscalation</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the configuration file, the <code>runAsUser</code> field specifies that for any Containers in
the Pod, all processes run with user ID 1000. The <code>runAsGroup</code> field specifies the primary group ID of 3000 for
all processes within any containers of the Pod. If this field is omitted, the primary group ID of the containers
will be root(0). Any files created will also be owned by user 1000 and group 3000 when <code>runAsGroup</code> is specified.
Since <code>fsGroup</code> field is specified, all processes of the container are also part of the supplementary group ID 2000.
The owner for volume <code>/data/demo</code> and any files created in that volume will be Group ID 2000.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/security/security-context.yaml
</span></span></code></pre></div><p>Verify that the Pod's Container is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod security-context-demo
</span></span></code></pre></div><p>Get a shell to the running Container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it security-context-demo -- sh
</span></span></code></pre></div><p>In your shell, list the running processes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ps
</span></span></code></pre></div><p>The output shows that the processes are running as user 1000, which is the value of <code>runAsUser</code>:</p><pre tabindex=0><code class=language-none data-lang=none>PID   USER     TIME  COMMAND
    1 1000      0:00 sleep 1h
    6 1000      0:00 sh
...
</code></pre><p>In your shell, navigate to <code>/data</code>, and list the one directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>cd</span> /data
</span></span><span style=display:flex><span>ls -l
</span></span></code></pre></div><p>The output shows that the <code>/data/demo</code> directory has group ID 2000, which is
the value of <code>fsGroup</code>.</p><pre tabindex=0><code class=language-none data-lang=none>drwxrwsrwx 2 root 2000 4096 Jun  6 20:08 demo
</code></pre><p>In your shell, navigate to <code>/data/demo</code>, and create a file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>cd</span> demo
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> hello &gt; testfile
</span></span></code></pre></div><p>List the file in the <code>/data/demo</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ls -l
</span></span></code></pre></div><p>The output shows that <code>testfile</code> has group ID 2000, which is the value of <code>fsGroup</code>.</p><pre tabindex=0><code class=language-none data-lang=none>-rw-r--r-- 1 1000 2000 6 Jun  6 20:08 testfile
</code></pre><p>Run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>id
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>uid=1000 gid=3000 groups=2000
</code></pre><p>From the output, you can see that <code>gid</code> is 3000 which is same as the <code>runAsGroup</code> field.
If the <code>runAsGroup</code> was omitted, the <code>gid</code> would remain as 0 (root) and the process will
be able to interact with files that are owned by the root(0) group and groups that have
the required group permissions for the root (0) group.</p><p>Exit your shell:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>exit</span>
</span></span></code></pre></div><h2 id=configure-volume-permission-and-ownership-change-policy-for-pods>Configure volume permission and ownership change policy for Pods</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.23 [stable]</code></div><p>By default, Kubernetes recursively changes ownership and permissions for the contents of each
volume to match the <code>fsGroup</code> specified in a Pod's <code>securityContext</code> when that volume is
mounted.
For large volumes, checking and changing ownership and permissions can take a lot of time,
slowing Pod startup. You can use the <code>fsGroupChangePolicy</code> field inside a <code>securityContext</code>
to control the way that Kubernetes checks and manages ownership and permissions
for a volume.</p><p><strong>fsGroupChangePolicy</strong> - <code>fsGroupChangePolicy</code> defines behavior for changing ownership
and permission of the volume before being exposed inside a Pod.
This field only applies to volume types that support <code>fsGroup</code> controlled ownership and permissions.
This field has two possible values:</p><ul><li><em>OnRootMismatch</em>: Only change permissions and ownership if the permission and the ownership of
root directory does not match with expected permissions of the volume.
This could help shorten the time it takes to change ownership and permission of a volume.</li><li><em>Always</em>: Always change permission and ownership of the volume when volume is mounted.</li></ul><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>runAsUser</span>:<span style=color:#bbb> </span><span style=color:#666>1000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>runAsGroup</span>:<span style=color:#bbb> </span><span style=color:#666>3000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>fsGroup</span>:<span style=color:#bbb> </span><span style=color:#666>2000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>fsGroupChangePolicy</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;OnRootMismatch&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This field has no effect on ephemeral volume types such as
<a href=/docs/concepts/storage/volumes/#secret><code>secret</code></a>,
<a href=/docs/concepts/storage/volumes/#configmap><code>configMap</code></a>,
and <a href=/docs/concepts/storage/volumes/#emptydir><code>emptydir</code></a>.</div><h2 id=delegating-volume-permission-and-ownership-change-to-csi-driver>Delegating volume permission and ownership change to CSI driver</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.23 [beta]</code></div><p>If you deploy a <a href=https://github.com/container-storage-interface/spec/blob/master/spec.md>Container Storage Interface (CSI)</a>
driver which supports the <code>VOLUME_MOUNT_GROUP</code> <code>NodeServiceCapability</code>, the
process of setting file ownership and permissions based on the
<code>fsGroup</code> specified in the <code>securityContext</code> will be performed by the CSI driver
instead of Kubernetes, provided that the <code>DelegateFSGroupToCSIDriver</code> Kubernetes
feature gate is enabled. In this case, since Kubernetes doesn't perform any
ownership and permission change, <code>fsGroupChangePolicy</code> does not take effect, and
as specified by CSI, the driver is expected to mount the volume with the
provided <code>fsGroup</code>, resulting in a volume that is readable/writable by the
<code>fsGroup</code>.</p><p>Please refer to the <a href=https://github.com/gnufied/enhancements/blob/master/keps/sig-storage/2317-fsgroup-on-mount/README.md>KEP</a>
and the description of the <code>VolumeCapability.MountVolume.volume_mount_group</code>
field in the <a href=https://github.com/container-storage-interface/spec/blob/master/spec.md#createvolume>CSI spec</a>
for more information.</p><h2 id=set-the-security-context-for-a-container>Set the security context for a Container</h2><p>To specify security settings for a Container, include the <code>securityContext</code> field
in the Container manifest. The <code>securityContext</code> field is a
<a href=/docs/reference/generated/kubernetes-api/v1.25/#securitycontext-v1-core>SecurityContext</a> object.
Security settings that you specify for a Container apply only to
the individual Container, and they override settings made at the Pod level when
there is overlap. Container settings do not affect the Pod's Volumes.</p><p>Here is the configuration file for a Pod that has one Container. Both the Pod
and the Container have a <code>securityContext</code> field:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/security/security-context-2.yaml download=pods/security/security-context-2.yaml><code>pods/security/security-context-2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-security-context-2-yaml")' title="Copy pods/security/security-context-2.yaml to clipboard"></img></div><div class=includecode id=pods-security-security-context-2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>security-context-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>runAsUser</span>:<span style=color:#bbb> </span><span style=color:#666>1000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>sec-ctx-demo-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/node-hello:1.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>runAsUser</span>:<span style=color:#bbb> </span><span style=color:#666>2000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>allowPrivilegeEscalation</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/security/security-context-2.yaml
</span></span></code></pre></div><p>Verify that the Pod's Container is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod security-context-demo-2
</span></span></code></pre></div><p>Get a shell into the running Container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it security-context-demo-2 -- sh
</span></span></code></pre></div><p>In your shell, list the running processes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ps aux
</span></span></code></pre></div><p>The output shows that the processes are running as user 2000. This is the value
of <code>runAsUser</code> specified for the Container. It overrides the value 1000 that is
specified for the Pod.</p><pre tabindex=0><code>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
2000         1  0.0  0.0   4336   764 ?        Ss   20:36   0:00 /bin/sh -c node server.js
2000         8  0.1  0.5 772124 22604 ?        Sl   20:36   0:00 node server.js
...
</code></pre><p>Exit your shell:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>exit</span>
</span></span></code></pre></div><h2 id=set-capabilities-for-a-container>Set capabilities for a Container</h2><p>With <a href=https://man7.org/linux/man-pages/man7/capabilities.7.html>Linux capabilities</a>,
you can grant certain privileges to a process without granting all the privileges
of the root user. To add or remove Linux capabilities for a Container, include the
<code>capabilities</code> field in the <code>securityContext</code> section of the Container manifest.</p><p>First, see what happens when you don't include a <code>capabilities</code> field.
Here is configuration file that does not add or remove any Container capabilities:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/security/security-context-3.yaml download=pods/security/security-context-3.yaml><code>pods/security/security-context-3.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-security-context-3-yaml")' title="Copy pods/security/security-context-3.yaml to clipboard"></img></div><div class=includecode id=pods-security-security-context-3-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>security-context-demo-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>sec-ctx-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/node-hello:1.0<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/security/security-context-3.yaml
</span></span></code></pre></div><p>Verify that the Pod's Container is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod security-context-demo-3
</span></span></code></pre></div><p>Get a shell into the running Container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it security-context-demo-3 -- sh
</span></span></code></pre></div><p>In your shell, list the running processes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ps aux
</span></span></code></pre></div><p>The output shows the process IDs (PIDs) for the Container:</p><pre tabindex=0><code>USER  PID %CPU %MEM    VSZ   RSS TTY   STAT START   TIME COMMAND
root    1  0.0  0.0   4336   796 ?     Ss   18:17   0:00 /bin/sh -c node server.js
root    5  0.1  0.5 772124 22700 ?     Sl   18:17   0:00 node server.js
</code></pre><p>In your shell, view the status for process 1:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>cd</span> /proc/1
</span></span><span style=display:flex><span>cat status
</span></span></code></pre></div><p>The output shows the capabilities bitmap for the process:</p><pre tabindex=0><code>...
CapPrm:	00000000a80425fb
CapEff:	00000000a80425fb
...
</code></pre><p>Make a note of the capabilities bitmap, and then exit your shell:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>exit</span>
</span></span></code></pre></div><p>Next, run a Container that is the same as the preceding container, except
that it has additional capabilities set.</p><p>Here is the configuration file for a Pod that runs one Container. The configuration
adds the <code>CAP_NET_ADMIN</code> and <code>CAP_SYS_TIME</code> capabilities:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/security/security-context-4.yaml download=pods/security/security-context-4.yaml><code>pods/security/security-context-4.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-security-context-4-yaml")' title="Copy pods/security/security-context-4.yaml to clipboard"></img></div><div class=includecode id=pods-security-security-context-4-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>security-context-demo-4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>sec-ctx-4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/node-hello:1.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>capabilities</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>add</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;NET_ADMIN&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;SYS_TIME&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/security/security-context-4.yaml
</span></span></code></pre></div><p>Get a shell into the running Container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it security-context-demo-4 -- sh
</span></span></code></pre></div><p>In your shell, view the capabilities for process 1:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>cd</span> /proc/1
</span></span><span style=display:flex><span>cat status
</span></span></code></pre></div><p>The output shows capabilities bitmap for the process:</p><pre tabindex=0><code>...
CapPrm:	00000000aa0435fb
CapEff:	00000000aa0435fb
...
</code></pre><p>Compare the capabilities of the two Containers:</p><pre tabindex=0><code>00000000a80425fb
00000000aa0435fb
</code></pre><p>In the capability bitmap of the first container, bits 12 and 25 are clear. In the second container,
bits 12 and 25 are set. Bit 12 is <code>CAP_NET_ADMIN</code>, and bit 25 is <code>CAP_SYS_TIME</code>.
See <a href=https://github.com/torvalds/linux/blob/master/include/uapi/linux/capability.h>capability.h</a>
for definitions of the capability constants.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Linux capability constants have the form <code>CAP_XXX</code>.
But when you list capabilities in your container manifest, you must
omit the <code>CAP_</code> portion of the constant.
For example, to add <code>CAP_SYS_TIME</code>, include <code>SYS_TIME</code> in your list of capabilities.</div><h2 id=set-the-seccomp-profile-for-a-container>Set the Seccomp Profile for a Container</h2><p>To set the Seccomp profile for a Container, include the <code>seccompProfile</code> field
in the <code>securityContext</code> section of your Pod or Container manifest. The
<code>seccompProfile</code> field is a
<a href=/docs/reference/generated/kubernetes-api/v1.25/#seccompprofile-v1-core>SeccompProfile</a> object consisting of <code>type</code> and <code>localhostProfile</code>.
Valid options for <code>type</code> include <code>RuntimeDefault</code>, <code>Unconfined</code>, and
<code>Localhost</code>. <code>localhostProfile</code> must only be set if <code>type: Localhost</code>. It
indicates the path of the pre-configured profile on the node, relative to the
kubelet's configured Seccomp profile location (configured with the <code>--root-dir</code>
flag).</p><p>Here is an example that sets the Seccomp profile to the node's container runtime
default profile:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>seccompProfile</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>RuntimeDefault<span style=color:#bbb>
</span></span></span></code></pre></div><p>Here is an example that sets the Seccomp profile to a pre-configured file at
<code>&lt;kubelet-root-dir>/seccomp/my-profiles/profile-allow.json</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>seccompProfile</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Localhost<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>localhostProfile</span>:<span style=color:#bbb> </span>my-profiles/profile-allow.json<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=assign-selinux-labels-to-a-container>Assign SELinux labels to a Container</h2><p>To assign SELinux labels to a Container, include the <code>seLinuxOptions</code> field in
the <code>securityContext</code> section of your Pod or Container manifest. The
<code>seLinuxOptions</code> field is an
<a href=/docs/reference/generated/kubernetes-api/v1.25/#selinuxoptions-v1-core>SELinuxOptions</a>
object. Here's an example that applies an SELinux level:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>seLinuxOptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;s0:c123,c456&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> To assign SELinux labels, the SELinux security module must be loaded on the host operating system.</div><h3 id=efficient-selinux-volume-relabeling>Efficient SELinux volume relabeling</h3><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [alpha]</code></div><p>By default, the contrainer runtime recursively assigns SELinux label to all
files on all Pod volumes. To speed up this process, Kubernetes can change the
SELinux label of a volume instantly by using a mount option
<code>-o context=&lt;label></code>.</p><p>To benefit from this speedup, all these conditions must be met:</p><ul><li>Alpha feature gates <code>ReadWriteOncePod</code> and <code>SELinuxMountReadWriteOncePod</code> must
be enabled.</li><li>Pod must use PersistentVolumeClaim with <code>accessModes: ["ReadWriteOncePod"]</code>.</li><li>Pod (or all its Containers that use the PersistentVolumeClaim) must
have <code>seLinuxOptions</code> set.</li><li>The corresponding PersistentVolume must be either a volume that uses a
<a class=glossary-tooltip title='The Container Storage Interface (CSI) defines a standard interface to expose storage systems to containers.' data-toggle=tooltip data-placement=top href=/docs/concepts/storage/volumes/#csi target=_blank aria-label=CSI>CSI</a> driver, or a volume that uses the
legacy <code>iscsi</code> volume type.<ul><li>If you use a volume backed by a CSI driver, that CSI driver must announce that it
supports mounting with <code>-o context</code> by setting <code>spec.seLinuxMount: true</code> in
its CSIDriver instance.</li></ul></li></ul><p>For any other volume types, SELinux relabelling happens another way: the container
runtime recursively changes the SELinux label for all inodes (files and directories)
in the volume.
The more files and directories in the volume, the longer that relabelling takes.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In Kubernetes 1.25, the kubelet loses track of volume labels after restart. In
other words, then kubelet may refuse to start Pods with errors similar to "conflicting
SELinux labels of volume", while there are no conflicting labels in Pods. Make sure
nodes are
<a href=https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/>fully drained</a>
before restarting kubelet.</div><h2 id=discussion>Discussion</h2><p>The security context for a Pod applies to the Pod's Containers and also to
the Pod's Volumes when applicable. Specifically <code>fsGroup</code> and <code>seLinuxOptions</code> are
applied to Volumes as follows:</p><ul><li><p><code>fsGroup</code>: Volumes that support ownership management are modified to be owned
and writable by the GID specified in <code>fsGroup</code>. See the
<a href=https://git.k8s.io/design-proposals-archive/storage/volume-ownership-management.md>Ownership Management design document</a>
for more details.</p></li><li><p><code>seLinuxOptions</code>: Volumes that support SELinux labeling are relabeled to be accessible
by the label specified under <code>seLinuxOptions</code>. Usually you only
need to set the <code>level</code> section. This sets the
<a href=https://selinuxproject.org/page/NB_MLS>Multi-Category Security (MCS)</a>
label given to all Containers in the Pod as well as the Volumes.</p></li></ul><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> After you specify an MCS label for a Pod, all Pods with the same label can access the Volume.
If you need inter-Pod protection, you must assign a unique MCS label to each Pod.</div><h2 id=clean-up>Clean up</h2><p>Delete the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod security-context-demo
</span></span><span style=display:flex><span>kubectl delete pod security-context-demo-2
</span></span><span style=display:flex><span>kubectl delete pod security-context-demo-3
</span></span><span style=display:flex><span>kubectl delete pod security-context-demo-4
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#podsecuritycontext-v1-core>PodSecurityContext</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#securitycontext-v1-core>SecurityContext</a></li><li><a href=https://github.com/containerd/containerd/blob/main/docs/cri/config.md>Tuning Docker with the newest security enhancements</a></li><li><a href=https://git.k8s.io/design-proposals-archive/auth/security_context.md>Security Contexts design document</a></li><li><a href=https://git.k8s.io/design-proposals-archive/storage/volume-ownership-management.md>Ownership Management design document</a></li><li><a href=/docs/concepts/security/pod-security-admission/>PodSecurity Admission</a></li><li><a href=https://git.k8s.io/design-proposals-archive/auth/no-new-privs.md>AllowPrivilegeEscalation design
document</a></li><li>For more information about security mechanisms in Linux, see
<a href=https://www.linux.com/learn/overview-linux-kernel-security-features>Overview of Linux Kernel Security Features</a> (Note: Some information is out of date)</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2c0d882359718c4c69c67099bed2156c>3.12 - Configure Service Accounts for Pods</h1><p>Kubernetes offers two distinct ways for clients that run within your
cluster, or that otherwise have a relationship to your cluster's
<a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a>
to authenticate to the
<a class=glossary-tooltip title='Control plane component that serves the Kubernetes API.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/components/#kube-apiserver target=_blank aria-label='API server'>API server</a>.</p><p>A <em>service account</em> provides an identity for processes that run in a Pod,
and maps to a ServiceAccount object. When you authenticate to the API
server, you identify yourself as a particular <em>user</em>. Kubernetes recognises
the concept of a user, however, Kubernetes itself does <strong>not</strong> have a User
API.</p><p>This task guide is about ServiceAccounts, which do exist in the Kubernetes
API. The guide shows you some ways to configure ServiceAccounts for Pods.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=use-the-default-service-account-to-access-the-api-server>Use the default service account to access the API server</h2><p>When Pods contact the API server, Pods authenticate as a particular
ServiceAccount (for example, <code>default</code>). There is always at least one
ServiceAccount in each <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=namespace>namespace</a>.</p><p>Every Kubernetes namespace contains at least one ServiceAccount: the default
ServiceAccount for that namespace, named <code>default</code>.
If you do not specify a ServiceAccount when you create a Pod, Kubernetes
automatically assigns the ServiceAccount named <code>default</code> in that namespace.</p><p>You can fetch the details for a Pod you have created. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods/&lt;podname&gt; -o yaml
</span></span></code></pre></div><p>In the output, you see a field <code>spec.serviceAccountName</code>.
Kubernetes <a href=/docs/user-guide/working-with-resources/#resources-are-automatically-modified>automatically</a>
sets that value if you don't specify it when you create a Pod.</p><p>An application running inside a Pod can access the Kubernetes API using
automatically mounted service account credentials. See <a href=/docs/user-guide/accessing-the-cluster/#accessing-the-api-from-a-pod>accessing the Cluster</a> to learn more.</p><p>When a Pod authenticates as a ServiceAccount, its level of access depends on the
<a href=/docs/reference/access-authn-authz/authorization/#authorization-modules>authorization plugin and policy</a>
in use.</p><h3 id=opt-out-of-api-credential-automounting>Opt out of API credential automounting</h3><p>If you don't want the <a class=glossary-tooltip title='An agent that runs on each node in the cluster. It makes sure that containers are running in a pod.' data-toggle=tooltip data-placement=top href=/docs/reference/generated/kubelet target=_blank aria-label=kubelet>kubelet</a>
to automatically mount a ServiceAccount's API credentials, you can opt out of
the default behavior.
You can opt out of automounting API credentials on <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> for a service account by setting <code>automountServiceAccountToken: false</code> on the ServiceAccount:</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>build-robot<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>automountServiceAccountToken</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>You can also opt out of automounting API credentials for a particular Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>build-robot<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>automountServiceAccountToken</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><p>If both the ServiceAccount and the Pod's <code>.spec</code> specify a value for
<code>automountServiceAccountToken</code>, the Pod spec takes precedence.</p><h2 id=use-multiple-service-accounts>Use more than one ServiceAccount</h2><p>Every namespace has at least one ServiceAccount: the default ServiceAccount
resource, called <code>default</code>. You can list all ServiceAccount resources in your
<a href=/docs/concepts/overview/working-with-objects/namespaces/#setting-the-namespace-preference>current namespace</a>
with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get serviceaccounts
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME      SECRETS    AGE
default   1          1d
</code></pre><p>You can create additional ServiceAccount objects like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#b44>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: build-robot
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>The name of a ServiceAccount object must be a valid
<a href=/docs/concepts/overview/working-with-objects/names#dns-subdomain-names>DNS subdomain name</a>.</p><p>If you get a complete dump of the service account object, like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get serviceaccounts/build-robot -o yaml
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2019-06-16T00:12:34Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>build-robot<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;272500&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>721ab723-13bc-11e5-aec2-42010af0021e<span style=color:#bbb>
</span></span></span></code></pre></div><p>You can use authorization plugins to
<a href=/docs/reference/access-authn-authz/rbac/#service-account-permissions>set permissions on service accounts</a>.</p><p>To use a non-default service account, set the <code>spec.serviceAccountName</code>
field of a Pod to the name of the ServiceAccount you wish to use.</p><p>You can only set the <code>serviceAccountName</code> field when creating a Pod, or in a
template for a new Pod. You cannot update the <code>.spec.serviceAccountName</code> field
of a Pod that already exists.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The <code>.spec.serviceAccount</code> field is a deprecated alias for <code>.spec.serviceAccountName</code>.
If you want to remove the fields from a workload resource, set both fields to empty explicitly
on the <a href=/docs/concepts/workloads/pods#pod-templates>pod template</a>.</div><h3 id=cleanup-use-multiple-service-accounts>Cleanup</h3><p>If you tried creating <code>build-robot</code> ServiceAccount from the example above,
you can clean it up by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete serviceaccount/build-robot
</span></span></code></pre></div><h2 id=manually-create-an-api-token-for-a-serviceaccount>Manually create an API token for a ServiceAccount</h2><p>Suppose you have an existing service account named "build-robot" as mentioned earlier.</p><p>You can get a time-limited API token for that ServiceAccount using <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create token admin-user
</span></span></code></pre></div><p>The output from that command is a token that you can use to authenticate as that
ServiceAccount. You can request a specific token duration using the <code>--duration</code>
command line argument to <code>kubectl create token</code> (the actual duration of the issued
token might be shorter, or could even be longer).</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>Versions of Kubernetes before v1.22 automatically created long term credentials for
accessing the Kubernetes API. This older mechanism was based on creating token Secrets
that could then be mounted into running Pods. In more recent versions, including
Kubernetes v1.25, API credentials are obtained directly by using the
<a href=/docs/reference/kubernetes-api/authentication-resources/token-request-v1/>TokenRequest</a> API,
and are mounted into Pods using a
<a href=/docs/reference/access-authn-authz/service-accounts-admin/#bound-service-account-token-volume>projected volume</a>.
The tokens obtained using this method have bounded lifetimes, and are automatically
invalidated when the Pod they are mounted into is deleted.</p><p>You can still manually create a service account token Secret; for example,
if you need a token that never expires. However, using the
<a href=/docs/reference/kubernetes-api/authentication-resources/token-request-v1/>TokenRequest</a>
subresource to obtain a token to access the API is recommended instead.</p></div><h3 id=manually-create-a-long-lived-api-token-for-a-serviceaccount>Manually create a long-lived API token for a ServiceAccount</h3><p>If you want to obtain an API token for a ServiceAccount, you create a new Secret
with a special annotation, <code>kubernetes.io/service-account.name</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#b44>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: build-robot-secret
</span></span></span><span style=display:flex><span><span style=color:#b44>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#b44>    kubernetes.io/service-account.name: build-robot
</span></span></span><span style=display:flex><span><span style=color:#b44>type: kubernetes.io/service-account-token
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>If you view the Secret using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret/build-robot-secret -o yaml
</span></span></code></pre></div><p>you can see that the Secret now contains an API token for the "build-robot" ServiceAccount.</p><p>Because of the annotation you set, the control plane automatically generates a token for that
ServiceAccounts, and stores them into the associated Secret. The control plane also cleans up
tokens for deleted ServiceAccounts.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe secrets/build-robot-secret
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>Name:           build-robot-secret
Namespace:      default
Labels:         &lt;none&gt;
Annotations:    kubernetes.io/service-account.name: build-robot
                kubernetes.io/service-account.uid: da68f9c6-9d26-11e7-b84e-002dc52800da

Type:   kubernetes.io/service-account-token

Data
====
ca.crt:         1338 bytes
namespace:      7 bytes
token:          ...
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>The content of <code>token</code> is elided here.</p><p>Take care not to display the contents of a <code>kubernetes.io/service-account-token</code>
Secret somewhere that your terminal / computer screen could be seen by an onlooker.</p></div><p>When you delete a ServiceAccount that has an associated Secret, the Kubernetes
control plane automatically cleans up the long-lived token from that Secret.</p><h2 id=add-imagepullsecrets-to-a-service-account>Add ImagePullSecrets to a service account</h2><p>First, <a href=/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod>create an imagePullSecret</a>.
Next, verify it has been created. For example:</p><ul><li><p>Create an imagePullSecret, as described in
<a href=/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod>Specifying ImagePullSecrets on a Pod</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret docker-registry myregistrykey --docker-server<span style=color:#666>=</span>DUMMY_SERVER <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>        --docker-username<span style=color:#666>=</span>DUMMY_USERNAME --docker-password<span style=color:#666>=</span>DUMMY_DOCKER_PASSWORD <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>        --docker-email<span style=color:#666>=</span>DUMMY_DOCKER_EMAIL
</span></span></code></pre></div></li><li><p>Verify it has been created.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secrets myregistrykey
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME             TYPE                              DATA    AGE
myregistrykey    kubernetes.io/.dockerconfigjson   1       1d
</code></pre></li></ul><h3 id=add-image-pull-secret-to-service-account>Add image pull secret to service account</h3><p>Next, modify the default service account for the namespace to use this Secret as an imagePullSecret.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch serviceaccount default -p <span style=color:#b44>&#39;{&#34;imagePullSecrets&#34;: [{&#34;name&#34;: &#34;myregistrykey&#34;}]}&#39;</span>
</span></span></code></pre></div><p>You can achieve the same outcome by editing the object manually:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit serviceaccount/default
</span></span></code></pre></div><p>The output of the <code>sa.yaml</code> file is similar to this:</p><p>Your selected text editor will open with a configuration looking something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2021-07-07T22:02:39Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;243024&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>052fb0f4-3d50-11e5-b066-42010af0d7b6<span style=color:#bbb>
</span></span></span></code></pre></div><p>Using your editor, delete the line with key <code>resourceVersion</code>, add lines for
<code>imagePullSecrets:</code> and save it. Leave the <code>uid</code> value set the same as you found it.</p><p>After you made those changes, the edited ServiceAccount looks something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2021-07-07T22:02:39Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>052fb0f4-3d50-11e5-b066-42010af0d7b6<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>imagePullSecrets</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>myregistrykey<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=verify-that-imagepullsecrets-are-set-for-new-pods>Verify that imagePullSecrets are set for new Pods</h3><p>Now, when a new Pod is created in the current namespace and using the default
ServiceAccount, the new Pod has its <code>spec.imagePullSecrets</code> field set automatically:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run nginx --image<span style=color:#666>=</span>nginx --restart<span style=color:#666>=</span>Never
</span></span><span style=display:flex><span>kubectl get pod nginx -o<span style=color:#666>=</span><span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.spec.imagePullSecrets[0].name}{&#34;\n&#34;}&#39;</span>
</span></span></code></pre></div><p>The output is:</p><pre tabindex=0><code>myregistrykey
</code></pre><h2 id=serviceaccount-token-volume-projection>ServiceAccount token volume projection</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.20 [stable]</code></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>To enable and use token request projection, you must specify each of the following
command line arguments to <code>kube-apiserver</code>:</p><dl><dt><code>--service-account-issuer</code></dt><dd>defines the Identifier of the service account token issuer. You can specify the
<code>--service-account-issuer</code> argument multiple times, this can be useful to enable
a non-disruptive change of the issuer. When this flag is specified multiple times,
the first is used to generate tokens and all are used to determine which issuers
are accepted. You must be running Kubernetes v1.22 or later to be able to specify
<code>--service-account-issuer</code> multiple times.</dd><dt><code>--service-account-key-file</code></dt><dd>specifies the path to a file containing PEM-encoded X.509 private or public keys
(RSA or ECDSA), used to verify ServiceAccount tokens. The specified file can contain
multiple keys, and the flag can be specified multiple times with different files.
If specified multiple times, tokens signed by any of the specified keys are considered
valid by the Kubernetes API server.</dd><dt><code>--service-account-signing-key-file</code></dt><dd>specifies the path to a file that contains the current private key of the service
account token issuer. The issuer signs issued ID tokens with this private key.</dd><dt><code>--api-audiences</code> (can be omitted)</dt><dd>defines audiences for ServiceAccount tokens. The service account token authenticator
validates that tokens used against the API are bound to at least one of these audiences.
If <code>api-audiences</code> is specified multiple times, tokens for any of the specified audiences
are considered valid by the Kubernetes API server. If you specify the <code>--service-account-issuer</code>
command line argument but you don't set <code>--api-audiences</code>, the control plane defaults to
a single element audience list that contains only the issuer URL.</dd></dl></div><p>The kubelet can also project a ServiceAccount token into a Pod. You can
specify desired properties of the token, such as the audience and the validity
duration. These properties are <em>not</em> configurable on the default ServiceAccount
token. The token will also become invalid against the API when either the Pod
or the ServiceAccount is deleted.</p><p>You can configure this behavior for the <code>spec</code> of a Pod using a
<a href=/docs/concepts/storage/volumes/#projected>projected volume</a> type called
<code>ServiceAccountToken</code>.</p><h3 id=launch-a-pod-using-service-account-token-projection>Launch a Pod using service account token projection</h3><p>To provide a Pod with a token with an audience of <code>vault</code> and a validity duration
of two hours, you could define a Pod manifest that is similar to:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-projected-svc-token.yaml download=pods/pod-projected-svc-token.yaml><code>pods/pod-projected-svc-token.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-projected-svc-token-yaml")' title="Copy pods/pod-projected-svc-token.yaml to clipboard"></img></div><div class=includecode id=pods-pod-projected-svc-token-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/run/secrets/tokens<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>vault-token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>build-robot<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>vault-token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>projected</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>sources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>serviceAccountToken</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>vault-token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>expirationSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>7200</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>audience</span>:<span style=color:#bbb> </span>vault<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/pods/pod-projected-svc-token.yaml
</span></span></code></pre></div><p>The kubelet will: request and store the token on behalf of the Pod; make
the token available to the Pod at a configurable file path; and refresh
the token as it approaches expiration. The kubelet proactively requests rotation
for the token if it is older than 80% of its total time-to-live (TTL),
or if the token is older than 24 hours.</p><p>The application is responsible for reloading the token when it rotates. It's
often good enough for the application to load the token on a schedule
(for example: once every 5 minutes), without tracking the actual expiry time.</p><h3 id=service-account-issuer-discovery>Service account issuer discovery</h3><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.21 [stable]</code></div><p>If you have enabled <a href=#serviceaccount-token-volume-projection>token projection</a>
for ServiceAccounts in your cluster, then you can also make use of the discovery
feature. Kubernetes provides a way for clients to federate as an <em>identity provider</em>,
so that one or more external systems can act as a <em>relying party</em>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>The issuer URL must comply with the
<a href=https://openid.net/specs/openid-connect-discovery-1_0.html>OIDC Discovery Spec</a>. In
practice, this means it must use the <code>https</code> scheme, and should serve an OpenID
provider configuration at <code>{service-account-issuer}/.well-known/openid-configuration</code>.</p><p>If the URL does not comply, ServiceAccount issuer discovery endpoints are not
registered or accessible.</p></div><p>When enabled, the Kubernetes API server publishes an OpenID Provider
Configuration document via HTTP. The configuration document is published at
<code>/.well-known/openid-configuration</code>.
The OpenID Provider Configuration is sometimes referred to as the <em>discovery document</em>.
The Kubernetes API server publishes the related
JSON Web Key Set (JWKS), also via HTTP, at <code>/openid/v1/jwks</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The responses served at <code>/.well-known/openid-configuration</code> and
<code>/openid/v1/jwks</code> are designed to be OIDC compatible, but not strictly OIDC
compliant. Those documents contain only the parameters necessary to perform
validation of Kubernetes service account tokens.</div><p>Clusters that use <a class=glossary-tooltip title='Manages authorization decisions, allowing admins to dynamically configure access policies through the Kubernetes API.' data-toggle=tooltip data-placement=top href=/docs/reference/access-authn-authz/rbac/ target=_blank aria-label=RBAC>RBAC</a> include a
default ClusterRole called <code>system:service-account-issuer-discovery</code>.
A default ClusterRoleBinding assigns this role to the <code>system:serviceaccounts</code> group,
which all ServiceAccounts implicitly belong to.
This allows pods running on the cluster to access the service account discovery document
via their mounted service account token. Administrators may, additionally, choose to
bind the role to <code>system:authenticated</code> or <code>system:unauthenticated</code> depending on their
security requirements and which external systems they intend to federate with.</p><p>The JWKS response contains public keys that a relying party can use to validate
the Kubernetes service account tokens. Relying parties first query for the
OpenID Provider Configuration, and use the <code>jwks_uri</code> field in the response to
find the JWKS.</p><p>In many cases, Kubernetes API servers are not available on the public internet,
but public endpoints that serve cached responses from the API server can be made
available by users or by service providers. In these cases, it is possible to
override the <code>jwks_uri</code> in the OpenID Provider Configuration so that it points
to the public endpoint, rather than the API server's address, by passing the
<code>--service-account-jwks-uri</code> flag to the API server. Like the issuer URL, the
JWKS URI is required to use the <code>https</code> scheme.</p><h2 id=what-s-next>What's next</h2><p>See also:</p><ul><li>Read the <a href=/docs/reference/access-authn-authz/service-accounts-admin/>Cluster Admin Guide to Service Accounts</a></li><li>Read about <a href=/docs/reference/access-authn-authz/authorization/>Authorization in Kubernetes</a></li><li>Read about <a href=/docs/concepts/configuration/secret/>Secrets</a><ul><li>or learn to <a href=/docs/tasks/inject-data-application/distribute-credentials-secure/>distribute credentials securely using Secrets</a></li><li>but also bear in mind that using Secrets for authenticating as a ServiceAccount
is deprecated. The recommended alternative is
<a href=#service-account-token-volume-projection>ServiceAccount token volume projection</a>.</li></ul></li><li>Read about <a href=/docs/tasks/configure-pod-container/configure-projected-volume-storage/>projected volumes</a>.</li><li>For background on OIDC discovery, read the
<a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-auth/1393-oidc-discovery>ServiceAccount signing key retrieval</a>
Kubernetes Enhancement Proposal</li><li>Read the <a href=https://openid.net/specs/openid-connect-discovery-1_0.html>OIDC Discovery Spec</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d385b86a7cb496d3b1c3b2a47280ca70>3.13 - Pull an Image from a Private Registry</h1><p>This page shows how to create a Pod that uses a
<a class=glossary-tooltip title='Stores sensitive information, such as passwords, OAuth tokens, and ssh keys.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/secret/ target=_blank aria-label=Secret>Secret</a> to pull an image
from a private container image registry or repository. There are many private
registries in use. This task uses <a href=https://www.docker.com/products/docker-hub>Docker Hub</a>
as an example registry.</p><div class="alert alert-secondary callout third-party-content" role=alert>&#128711; This item links to a third party project or product that is not part of Kubernetes itself. <a class=alert-more-info href=#third-party-content-disclaimer>More information</a></div><h2 id=before-you-begin>Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul></li><li><p>To do this exercise, you need the <code>docker</code> command line tool, and a
<a href=https://docs.docker.com/docker-id/>Docker ID</a> for which you know the password.</p></li><li><p>If you are using a different private container registry, you need the command
line tool for that registry and any login information for the registry.</p></li></ul><h2 id=log-in-to-docker-hub>Log in to Docker Hub</h2><p>On your laptop, you must authenticate with a registry in order to pull a private image.</p><p>Use the <code>docker</code> tool to log in to Docker Hub. See the <em>log in</em> section of
<a href=https://docs.docker.com/docker-id/#log-in>Docker ID accounts</a> for more information.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker login
</span></span></code></pre></div><p>When prompted, enter your Docker ID, and then the credential you want to use (access token,
or the password for your Docker ID).</p><p>The login process creates or updates a <code>config.json</code> file that holds an authorization token. Review <a href=/docs/concepts/containers/images#config-json>how Kubernetes interprets this file</a>.</p><p>View the <code>config.json</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat ~/.docker/config.json
</span></span></code></pre></div><p>The output contains a section similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;auths&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;https://index.docker.io/v1/&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;auth&#34;</span>: <span style=color:#b44>&#34;c3R...zE2&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you use a Docker credentials store, you won't see that <code>auth</code> entry but a <code>credsStore</code> entry with the name of the store as value.
In that case, you can create a secret directly. See <a href=#create-a-secret-by-providing-credentials-on-the-command-line>Create a Secret by providing credentials on the command line</a>.</div><h2 id=registry-secret-existing-credentials>Create a Secret based on existing credentials</h2><p>A Kubernetes cluster uses the Secret of <code>kubernetes.io/dockerconfigjson</code> type to authenticate with
a container registry to pull a private image.</p><p>If you already ran <code>docker login</code>, you can copy
that credential into Kubernetes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic regcred <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --from-file<span style=color:#666>=</span>.dockerconfigjson<span style=color:#666>=</span>&lt;path/to/.docker/config.json&gt; <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --type<span style=color:#666>=</span>kubernetes.io/dockerconfigjson
</span></span></code></pre></div><p>If you need more control (for example, to set a namespace or a label on the new
secret) then you can customise the Secret before storing it.
Be sure to:</p><ul><li>set the name of the data item to <code>.dockerconfigjson</code></li><li>base64 encode the Docker configuration file and then paste that string, unbroken
as the value for field <code>data[".dockerconfigjson"]</code></li><li>set <code>type</code> to <code>kubernetes.io/dockerconfigjson</code></li></ul><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>myregistrykey<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>awesomeapps<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>.dockerconfigjson</span>:<span style=color:#bbb> </span>UmVhbGx5IHJlYWxseSByZWVlZWVlZWVlZWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGx5eXl5eXl5eXl5eXl5eXl5eXl5eSBsbGxsbGxsbGxsbGxsbG9vb29vb29vb29vb29vb29vb29vb29vb29vb25ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubmdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2cgYXV0aCBrZXlzCg==<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>kubernetes.io/dockerconfigjson<span style=color:#bbb>
</span></span></span></code></pre></div><p>If you get the error message <code>error: no objects passed to create</code>, it may mean the base64 encoded string is invalid.
If you get an error message like <code>Secret "myregistrykey" is invalid: data[.dockerconfigjson]: invalid value ...</code>, it means
the base64 encoded string in the data was successfully decoded, but could not be parsed as a <code>.docker/config.json</code> file.</p><h2 id=create-a-secret-by-providing-credentials-on-the-command-line>Create a Secret by providing credentials on the command line</h2><p>Create this Secret, naming it <code>regcred</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret docker-registry regcred --docker-server<span style=color:#666>=</span>&lt;your-registry-server&gt; --docker-username<span style=color:#666>=</span>&lt;your-name&gt; --docker-password<span style=color:#666>=</span>&lt;your-pword&gt; --docker-email<span style=color:#666>=</span>&lt;your-email&gt;
</span></span></code></pre></div><p>where:</p><ul><li><code>&lt;your-registry-server></code> is your Private Docker Registry FQDN.
Use <code>https://index.docker.io/v1/</code> for DockerHub.</li><li><code>&lt;your-name></code> is your Docker username.</li><li><code>&lt;your-pword></code> is your Docker password.</li><li><code>&lt;your-email></code> is your Docker email.</li></ul><p>You have successfully set your Docker credentials in the cluster as a Secret called <code>regcred</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Typing secrets on the command line may store them in your shell history unprotected, and
those secrets might also be visible to other users on your PC during the time that
<code>kubectl</code> is running.</div><h2 id=inspecting-the-secret-regcred>Inspecting the Secret <code>regcred</code></h2><p>To understand the contents of the <code>regcred</code> Secret you created, start by viewing the Secret in YAML format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret regcred --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>regcred<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>.dockerconfigjson</span>:<span style=color:#bbb> </span>eyJodHRwczovL2luZGV4L ... J0QUl6RTIifX0=<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>kubernetes.io/dockerconfigjson<span style=color:#bbb>
</span></span></span></code></pre></div><p>The value of the <code>.dockerconfigjson</code> field is a base64 representation of your Docker credentials.</p><p>To understand what is in the <code>.dockerconfigjson</code> field, convert the secret data to a
readable format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret regcred --output<span style=color:#666>=</span><span style=color:#b44>&#34;jsonpath={.data.\.dockerconfigjson}&#34;</span> | base64 --decode
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:green;font-weight:700>&#34;auths&#34;</span>:{<span style=color:green;font-weight:700>&#34;your.private.registry.example.com&#34;</span>:{<span style=color:green;font-weight:700>&#34;username&#34;</span>:<span style=color:#b44>&#34;janedoe&#34;</span>,<span style=color:green;font-weight:700>&#34;password&#34;</span>:<span style=color:#b44>&#34;xxxxxxxxxxx&#34;</span>,<span style=color:green;font-weight:700>&#34;email&#34;</span>:<span style=color:#b44>&#34;jdoe@example.com&#34;</span>,<span style=color:green;font-weight:700>&#34;auth&#34;</span>:<span style=color:#b44>&#34;c3R...zE2&#34;</span>}}}
</span></span></code></pre></div><p>To understand what is in the <code>auth</code> field, convert the base64-encoded data to a readable format:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;c3R...zE2&#34;</span> | base64 --decode
</span></span></code></pre></div><p>The output, username and password concatenated with a <code>:</code>, is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>janedoe:xxxxxxxxxxx
</code></pre><p>Notice that the Secret data contains the authorization token similar to your local <code>~/.docker/config.json</code> file.</p><p>You have successfully set your Docker credentials as a Secret called <code>regcred</code> in the cluster.</p><h2 id=create-a-pod-that-uses-your-secret>Create a Pod that uses your Secret</h2><p>Here is a manifest for an example Pod that needs access to your Docker credentials in <code>regcred</code>:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/private-reg-pod.yaml download=pods/private-reg-pod.yaml><code>pods/private-reg-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-private-reg-pod-yaml")' title="Copy pods/private-reg-pod.yaml to clipboard"></img></div><div class=includecode id=pods-private-reg-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>private-reg<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>private-reg-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>&lt;your-private-image&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>imagePullSecrets</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>regcred<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Download the above file onto your computer:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L -o my-private-reg-pod.yaml https://k8s.io/examples/pods/private-reg-pod.yaml
</span></span></code></pre></div><p>In file <code>my-private-reg-pod.yaml</code>, replace <code>&lt;your-private-image></code> with the path to an image in a private registry such as:</p><pre tabindex=0><code class=language-none data-lang=none>your.private.registry.example.com/janedoe/jdoe-private:v1
</code></pre><p>To pull the image from the private registry, Kubernetes needs credentials.
The <code>imagePullSecrets</code> field in the configuration file specifies that
Kubernetes should get the credentials from a Secret named <code>regcred</code>.</p><p>Create a Pod that uses your Secret, and verify that the Pod is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-private-reg-pod.yaml
</span></span><span style=display:flex><span>kubectl get pod private-reg
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/configuration/secret/>Secrets</a><ul><li>or read the API reference for
<a href=/docs/reference/kubernetes-api/config-and-storage-resources/secret-v1/>Secret</a></li></ul></li><li>Learn more about <a href=/docs/concepts/containers/images/#using-a-private-registry>using a private registry</a>.</li><li>Learn more about <a href=/docs/tasks/configure-pod-container/configure-service-account/#add-imagepullsecrets-to-a-service-account>adding image pull secrets to a service account</a>.</li><li>See <a href=/docs/reference/generated/kubectl/kubectl-commands/#-em-secret-docker-registry-em->kubectl create secret docker-registry</a>.</li><li>See the <code>imagePullSecrets</code> field within the <a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#containers>container definitions</a> of a Pod</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-eb54daf87df373096b5e830680194dfc>3.14 - Configure Liveness, Readiness and Startup Probes</h1><p>This page shows how to configure liveness, readiness and startup probes for containers.</p><p>The <a href=/docs/reference/command-line-tools-reference/kubelet/>kubelet</a> uses liveness probes to know when to
restart a container. For example, liveness probes could catch a deadlock,
where an application is running, but unable to make progress. Restarting a
container in such a state can help to make the application more available
despite bugs.</p><p>The kubelet uses readiness probes to know when a container is ready to start
accepting traffic. A Pod is considered ready when all of its containers are ready.
One use of this signal is to control which Pods are used as backends for Services.
When a Pod is not ready, it is removed from Service load balancers.</p><p>The kubelet uses startup probes to know when a container application has started.
If such a probe is configured, it disables liveness and readiness checks until
it succeeds, making sure those probes don't interfere with the application startup.
This can be used to adopt liveness checks on slow starting containers, avoiding them
getting killed by the kubelet before they are up and running.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=define-a-liveness-command>Define a liveness command</h2><p>Many applications running for long periods of time eventually transition to
broken states, and cannot recover except by being restarted. Kubernetes provides
liveness probes to detect and remedy such situations.</p><p>In this exercise, you create a Pod that runs a container based on the
<code>registry.k8s.io/busybox</code> image. Here is the configuration file for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/probe/exec-liveness.yaml download=pods/probe/exec-liveness.yaml><code>pods/probe/exec-liveness.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-probe-exec-liveness-yaml")' title="Copy pods/probe/exec-liveness.yaml to clipboard"></img></div><div class=includecode id=pods-probe-exec-liveness-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>test</span>:<span style=color:#bbb> </span>liveness<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>liveness-exec<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>liveness<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- /bin/sh<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 600<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>exec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- cat<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- /tmp/healthy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the configuration file, you can see that the Pod has a single <code>Container</code>.
The <code>periodSeconds</code> field specifies that the kubelet should perform a liveness
probe every 5 seconds. The <code>initialDelaySeconds</code> field tells the kubelet that it
should wait 5 seconds before performing the first probe. To perform a probe, the
kubelet executes the command <code>cat /tmp/healthy</code> in the target container. If the
command succeeds, it returns 0, and the kubelet considers the container to be alive and
healthy. If the command returns a non-zero value, the kubelet kills the container
and restarts it.</p><p>When the container starts, it executes this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/bin/sh -c <span style=color:#b44>&#34;touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 600&#34;</span>
</span></span></code></pre></div><p>For the first 30 seconds of the container's life, there is a <code>/tmp/healthy</code> file.
So during the first 30 seconds, the command <code>cat /tmp/healthy</code> returns a success
code. After 30 seconds, <code>cat /tmp/healthy</code> returns a failure code.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/probe/exec-liveness.yaml
</span></span></code></pre></div><p>Within 30 seconds, view the Pod events:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod liveness-exec
</span></span></code></pre></div><p>The output indicates that no liveness probes have failed yet:</p><pre tabindex=0><code>Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  11s   default-scheduler  Successfully assigned default/liveness-exec to node01
  Normal  Pulling    9s    kubelet, node01    Pulling image &#34;registry.k8s.io/busybox&#34;
  Normal  Pulled     7s    kubelet, node01    Successfully pulled image &#34;registry.k8s.io/busybox&#34;
  Normal  Created    7s    kubelet, node01    Created container liveness
  Normal  Started    7s    kubelet, node01    Started container liveness
</code></pre><p>After 35 seconds, view the Pod events again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod liveness-exec
</span></span></code></pre></div><p>At the bottom of the output, there are messages indicating that the liveness
probes have failed, and the failed containers have been killed and recreated.</p><pre tabindex=0><code>  Type     Reason     Age                From               Message
  ----     ------     ----               ----               -------
  Normal   Scheduled  57s                default-scheduler  Successfully assigned default/liveness-exec to node01
  Normal   Pulling    55s                kubelet, node01    Pulling image &#34;registry.k8s.io/busybox&#34;
  Normal   Pulled     53s                kubelet, node01    Successfully pulled image &#34;registry.k8s.io/busybox&#34;
  Normal   Created    53s                kubelet, node01    Created container liveness
  Normal   Started    53s                kubelet, node01    Started container liveness
  Warning  Unhealthy  10s (x3 over 20s)  kubelet, node01    Liveness probe failed: cat: can&#39;t open &#39;/tmp/healthy&#39;: No such file or directory
  Normal   Killing    10s                kubelet, node01    Container liveness failed liveness probe, will be restarted
</code></pre><p>Wait another 30 seconds, and verify that the container has been restarted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod liveness-exec
</span></span></code></pre></div><p>The output shows that <code>RESTARTS</code> has been incremented. Note that the <code>RESTARTS</code> counter increments as soon as a failed container comes back to the running state:</p><pre tabindex=0><code>NAME            READY     STATUS    RESTARTS   AGE
liveness-exec   1/1       Running   1          1m
</code></pre><h2 id=define-a-liveness-http-request>Define a liveness HTTP request</h2><p>Another kind of liveness probe uses an HTTP GET request. Here is the configuration
file for a Pod that runs a container based on the <code>registry.k8s.io/liveness</code>
image.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/probe/http-liveness.yaml download=pods/probe/http-liveness.yaml><code>pods/probe/http-liveness.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-probe-http-liveness-yaml")' title="Copy pods/probe/http-liveness.yaml to clipboard"></img></div><div class=includecode id=pods-probe-http-liveness-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>test</span>:<span style=color:#bbb> </span>liveness<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>liveness-http<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>liveness<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/liveness<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- /server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>httpHeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Custom-Header<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>Awesome<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the configuration file, you can see that the Pod has a single container.
The <code>periodSeconds</code> field specifies that the kubelet should perform a liveness
probe every 3 seconds. The <code>initialDelaySeconds</code> field tells the kubelet that it
should wait 3 seconds before performing the first probe. To perform a probe, the
kubelet sends an HTTP GET request to the server that is running in the container
and listening on port 8080. If the handler for the server's <code>/healthz</code> path
returns a success code, the kubelet considers the container to be alive and
healthy. If the handler returns a failure code, the kubelet kills the container
and restarts it.</p><p>Any code greater than or equal to 200 and less than 400 indicates success. Any
other code indicates failure.</p><p>You can see the source code for the server in
<a href=https://github.com/kubernetes/kubernetes/blob/master/test/images/agnhost/liveness/server.go>server.go</a>.</p><p>For the first 10 seconds that the container is alive, the <code>/healthz</code> handler
returns a status of 200. After that, the handler returns a status of 500.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>http.<span style=color:#00a000>HandleFunc</span>(<span style=color:#b44>&#34;/healthz&#34;</span>, <span style=color:#a2f;font-weight:700>func</span>(w http.ResponseWriter, r <span style=color:#666>*</span>http.Request) {
</span></span><span style=display:flex><span>    duration <span style=color:#666>:=</span> time.<span style=color:#00a000>Now</span>().<span style=color:#00a000>Sub</span>(started)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span> duration.<span style=color:#00a000>Seconds</span>() &gt; <span style=color:#666>10</span> {
</span></span><span style=display:flex><span>        w.<span style=color:#00a000>WriteHeader</span>(<span style=color:#666>500</span>)
</span></span><span style=display:flex><span>        w.<span style=color:#00a000>Write</span>([]<span style=color:#a2f>byte</span>(fmt.<span style=color:#00a000>Sprintf</span>(<span style=color:#b44>&#34;error: %v&#34;</span>, duration.<span style=color:#00a000>Seconds</span>())))
</span></span><span style=display:flex><span>    } <span style=color:#a2f;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        w.<span style=color:#00a000>WriteHeader</span>(<span style=color:#666>200</span>)
</span></span><span style=display:flex><span>        w.<span style=color:#00a000>Write</span>([]<span style=color:#a2f>byte</span>(<span style=color:#b44>&#34;ok&#34;</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>The kubelet starts performing health checks 3 seconds after the container starts.
So the first couple of health checks will succeed. But after 10 seconds, the health
checks will fail, and the kubelet will kill and restart the container.</p><p>To try the HTTP liveness check, create a Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/probe/http-liveness.yaml
</span></span></code></pre></div><p>After 10 seconds, view Pod events to verify that liveness probes have failed and
the container has been restarted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod liveness-http
</span></span></code></pre></div><p>In releases prior to v1.13 (including v1.13), if the environment variable
<code>http_proxy</code> (or <code>HTTP_PROXY</code>) is set on the node where a Pod is running,
the HTTP liveness probe uses that proxy.
In releases after v1.13, local HTTP proxy environment variable settings do not
affect the HTTP liveness probe.</p><h2 id=define-a-tcp-liveness-probe>Define a TCP liveness probe</h2><p>A third type of liveness probe uses a TCP socket. With this configuration, the
kubelet will attempt to open a socket to your container on the specified port.
If it can establish a connection, the container is considered healthy, if it
can't it is considered a failure.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/probe/tcp-liveness-readiness.yaml download=pods/probe/tcp-liveness-readiness.yaml><code>pods/probe/tcp-liveness-readiness.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-probe-tcp-liveness-readiness-yaml")' title="Copy pods/probe/tcp-liveness-readiness.yaml to clipboard"></img></div><div class=includecode id=pods-probe-tcp-liveness-readiness-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>goproxy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>goproxy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>goproxy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/goproxy:0.1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>readinessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tcpSocket</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tcpSocket</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>20</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>As you can see, configuration for a TCP check is quite similar to an HTTP check.
This example uses both readiness and liveness probes. The kubelet will send the
first readiness probe 5 seconds after the container starts. This will attempt to
connect to the <code>goproxy</code> container on port 8080. If the probe succeeds, the Pod
will be marked as ready. The kubelet will continue to run this check every 10
seconds.</p><p>In addition to the readiness probe, this configuration includes a liveness probe.
The kubelet will run the first liveness probe 15 seconds after the container
starts. Similar to the readiness probe, this will attempt to connect to the
<code>goproxy</code> container on port 8080. If the liveness probe fails, the container
will be restarted.</p><p>To try the TCP liveness check, create a Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/probe/tcp-liveness-readiness.yaml
</span></span></code></pre></div><p>After 15 seconds, view Pod events to verify that liveness probes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod goproxy
</span></span></code></pre></div><h2 id=define-a-grpc-liveness-probe>Define a gRPC liveness probe</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.24 [beta]</code></div><p>If your application implements <a href=https://github.com/grpc/grpc/blob/master/doc/health-checking.md>gRPC Health Checking Protocol</a>,
kubelet can be configured to use it for application liveness checks.
You must enable the <code>GRPCContainerProbe</code>
<a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gate</a>
in order to configure checks that rely on gRPC.</p><p>Here is an example manifest:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/probe/grpc-liveness.yaml download=pods/probe/grpc-liveness.yaml><code>pods/probe/grpc-liveness.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-probe-grpc-liveness-yaml")' title="Copy pods/probe/grpc-liveness.yaml to clipboard"></img></div><div class=includecode id=pods-probe-grpc-liveness-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>etcd-with-grpc<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>etcd<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/etcd:3.5.1-0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/usr/local/bin/etcd&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--data-dir&#34;</span>,<span style=color:#bbb>  </span><span style=color:#b44>&#34;/var/lib/etcd&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--listen-client-urls&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;http://0.0.0.0:2379&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--advertise-client-urls&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;http://127.0.0.1:2379&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;--log-level&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;debug&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>2379</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>grpc</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>2379</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>To use a gRPC probe, <code>port</code> must be configured. If the health endpoint is configured
on a non-default service, you must also specify the <code>service</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Unlike HTTP and TCP probes, named ports cannot be used and custom host cannot be configured.</div><p>Configuration problems (for example: incorrect port and service, unimplemented health checking protocol)
are considered a probe failure, similar to HTTP and TCP probes.</p><p>To try the gRPC liveness check, create a Pod using the command below.
In the example below, the etcd pod is configured to use gRPC liveness probe.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/probe/grpc-liveness.yaml
</span></span></code></pre></div><p>After 15 seconds, view Pod events to verify that the liveness check has not failed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod etcd-with-grpc
</span></span></code></pre></div><p>Before Kubernetes 1.23, gRPC health probes were often implemented using <a href=https://github.com/grpc-ecosystem/grpc-health-probe/>grpc-health-probe</a>,
as described in the blog post <a href=/blog/2018/10/01/health-checking-grpc-servers-on-kubernetes/>Health checking gRPC servers on Kubernetes</a>.
The built-in gRPC probes behavior is similar to one implemented by grpc-health-probe.
When migrating from grpc-health-probe to built-in probes, remember the following differences:</p><ul><li>Built-in probes run against the pod IP address, unlike grpc-health-probe that often runs against <code>127.0.0.1</code>.
Be sure to configure your gRPC endpoint to listen on the Pod's IP address.</li><li>Built-in probes do not support any authentication parameters (like <code>-tls</code>).</li><li>There are no error codes for built-in probes. All errors are considered as probe failures.</li><li>If <code>ExecProbeTimeout</code> feature gate is set to <code>false</code>, grpc-health-probe does <strong>not</strong> respect the <code>timeoutSeconds</code> setting (which defaults to 1s),
while built-in probe would fail on timeout.</li></ul><h2 id=use-a-named-port>Use a named port</h2><p>You can use a named
<a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#ports><code>port</code></a>
for HTTP and TCP probes. (gRPC probes do not support named ports).</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>liveness-port<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span>liveness-port<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=define-startup-probes>Protect slow starting containers with startup probes</h2><p>Sometimes, you have to deal with legacy applications that might require
an additional startup time on their first initialization.
In such cases, it can be tricky to set up liveness probe parameters without
compromising the fast response to deadlocks that motivated such a probe.
The trick is to set up a startup probe with the same command, HTTP or TCP
check, with a <code>failureThreshold * periodSeconds</code> long enough to cover the
worse case startup time.</p><p>So, the previous example would become:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>liveness-port<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span>liveness-port<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>failureThreshold</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>startupProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span>liveness-port<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>failureThreshold</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Thanks to the startup probe, the application will have a maximum of 5 minutes
(30 * 10 = 300s) to finish its startup.
Once the startup probe has succeeded once, the liveness probe takes over to
provide a fast response to container deadlocks.
If the startup probe never succeeds, the container is killed after 300s and
subject to the pod's <code>restartPolicy</code>.</p><h2 id=define-readiness-probes>Define readiness probes</h2><p>Sometimes, applications are temporarily unable to serve traffic.
For example, an application might need to load large data or configuration
files during startup, or depend on external services after startup.
In such cases, you don't want to kill the application,
but you don't want to send it requests either. Kubernetes provides
readiness probes to detect and mitigate these situations. A pod with containers
reporting that they are not ready does not receive traffic through Kubernetes
Services.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Readiness probes runs on the container during its whole lifecycle.</div><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Liveness probes <em>do not</em> wait for readiness probes to succeed. If you want to wait before executing a liveness probe you should use initialDelaySeconds or a startupProbe.</div><p>Readiness probes are configured similarly to liveness probes. The only difference
is that you use the <code>readinessProbe</code> field instead of the <code>livenessProbe</code> field.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>readinessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>exec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- cat<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- /tmp/healthy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Configuration for HTTP and TCP readiness probes also remains identical to
liveness probes.</p><p>Readiness and liveness probes can be used in parallel for the same container.
Using both can ensure that traffic does not reach a container that is not ready
for it, and that containers are restarted when they fail.</p><h2 id=configure-probes>Configure Probes</h2><p><a href=/docs/reference/generated/kubernetes-api/v1.25/#probe-v1-core>Probes</a> have a number of fields that
you can use to more precisely control the behavior of startup, liveness and readiness
checks:</p><ul><li><code>initialDelaySeconds</code>: Number of seconds after the container has started
before startup, liveness or readiness probes are initiated. Defaults to 0 seconds. Minimum value is 0.</li><li><code>periodSeconds</code>: How often (in seconds) to perform the probe. Default to 10
seconds. Minimum value is 1.</li><li><code>timeoutSeconds</code>: Number of seconds after which the probe times out. Defaults
to 1 second. Minimum value is 1.</li><li><code>successThreshold</code>: Minimum consecutive successes for the probe to be
considered successful after having failed. Defaults to 1. Must be 1 for liveness
and startup Probes. Minimum value is 1.</li><li><code>failureThreshold</code>: When a probe fails, Kubernetes will
try <code>failureThreshold</code> times before giving up. Giving up in case of liveness probe means restarting the container. In case of readiness probe the Pod will be marked Unready.
Defaults to 3. Minimum value is 1.</li></ul><p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>Before Kubernetes 1.20, the field <code>timeoutSeconds</code> was not respected for exec probes:
probes continued running indefinitely, even past their configured deadline,
until a result was returned.</p><p>This defect was corrected in Kubernetes v1.20. You may have been relying on the previous behavior,
even without realizing it, as the default timeout is 1 second.
As a cluster administrator, you can disable the <a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gate</a> <code>ExecProbeTimeout</code> (set it to <code>false</code>)
on each kubelet to restore the behavior from older versions, then remove that override
once all the exec probes in the cluster have a <code>timeoutSeconds</code> value set.
If you have pods that are impacted from the default 1 second timeout,
you should update their probe timeout so that you're ready for the
eventual removal of that feature gate.</p><p>With the fix of the defect, for exec probes, on Kubernetes <code>1.20+</code> with the <code>dockershim</code> container runtime,
the process inside the container may keep running even after probe returned failure because of the timeout.</p></div><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Incorrect implementation of readiness probes may result in an ever growing number
of processes in the container, and resource starvation if this is left unchecked.</div></p><h3 id=http-probes>HTTP probes</h3><p><a href=/docs/reference/generated/kubernetes-api/v1.25/#httpgetaction-v1-core>HTTP probes</a>
have additional fields that can be set on <code>httpGet</code>:</p><ul><li><code>host</code>: Host name to connect to, defaults to the pod IP. You probably want to
set "Host" in httpHeaders instead.</li><li><code>scheme</code>: Scheme to use for connecting to the host (HTTP or HTTPS). Defaults to HTTP.</li><li><code>path</code>: Path to access on the HTTP server. Defaults to /.</li><li><code>httpHeaders</code>: Custom headers to set in the request. HTTP allows repeated headers.</li><li><code>port</code>: Name or number of the port to access on the container. Number must be
in the range 1 to 65535.</li></ul><p>For an HTTP probe, the kubelet sends an HTTP request to the specified path and
port to perform the check. The kubelet sends the probe to the pod's IP address,
unless the address is overridden by the optional <code>host</code> field in <code>httpGet</code>. If
<code>scheme</code> field is set to <code>HTTPS</code>, the kubelet sends an HTTPS request skipping the
certificate verification. In most scenarios, you do not want to set the <code>host</code> field.
Here's one scenario where you would set it. Suppose the container listens on 127.0.0.1
and the Pod's <code>hostNetwork</code> field is true. Then <code>host</code>, under <code>httpGet</code>, should be set
to 127.0.0.1. If your pod relies on virtual hosts, which is probably the more common
case, you should not use <code>host</code>, but rather set the <code>Host</code> header in <code>httpHeaders</code>.</p><p>For an HTTP probe, the kubelet sends two request headers in addition to the mandatory <code>Host</code> header:
<code>User-Agent</code>, and <code>Accept</code>. The default values for these headers are <code>kube-probe/1.25</code>
(where <code>1.25</code> is the version of the kubelet ), and <code>*/*</code> respectively.</p><p>You can override the default headers by defining <code>.httpHeaders</code> for the probe; for example</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>httpHeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Accept<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>application/json<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>startupProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>httpHeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>User-Agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>MyUserAgent<span style=color:#bbb>
</span></span></span></code></pre></div><p>You can also remove these two headers by defining them with an empty value.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>httpHeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Accept<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>startupProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>httpHeaders</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>User-Agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=tcp-probes>TCP probes</h3><p>For a TCP probe, the kubelet makes the probe connection at the node, not in the pod, which
means that you can not use a service name in the <code>host</code> parameter since the kubelet is unable
to resolve it.</p><h3 id=probe-level-terminationgraceperiodseconds>Probe-level <code>terminationGracePeriodSeconds</code></h3><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [beta]</code></div><p>Prior to release 1.21, the pod-level <code>terminationGracePeriodSeconds</code> was used
for terminating a container that failed its liveness or startup probe. This
coupling was unintended and may have resulted in failed containers taking an
unusually long time to restart when a pod-level <code>terminationGracePeriodSeconds</code>
was set.</p><p>In 1.25 and beyond, users can specify a probe-level <code>terminationGracePeriodSeconds</code>
as part of the probe specification. When both a pod- and probe-level
<code>terminationGracePeriodSeconds</code> are set, the kubelet will use the probe-level value.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>Beginning in Kubernetes 1.25, the <code>ProbeTerminationGracePeriod</code> feature is enabled
by default. For users choosing to disable this feature, please note the following:</p><ul><li><p>The <code>ProbeTerminationGracePeriod</code> feature gate is only available on the API Server.
The kubelet always honors the probe-level <code>terminationGracePeriodSeconds</code> field if
it is present on a Pod.</p></li><li><p>If you have existing Pods where the <code>terminationGracePeriodSeconds</code> field is set and
you no longer wish to use per-probe termination grace periods, you must delete
those existing Pods.</p></li><li><p>When you (or the control plane, or some other component) create replacement
Pods, and the feature gate <code>ProbeTerminationGracePeriod</code> is disabled, then the
API server ignores the Probe-level <code>terminationGracePeriodSeconds</code> field, even if
a Pod or pod template specifies it.</p></li></ul></div><p>For example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>terminationGracePeriodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>3600</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># pod-level</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>liveness-port<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span>liveness-port<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>failureThreshold</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Override pod-level terminationGracePeriodSeconds #</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>terminationGracePeriodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Probe-level <code>terminationGracePeriodSeconds</code> cannot be set for readiness probes.
It will be rejected by the API server.</p><h2 id=what-s-next>What's next</h2><ul><li>Learn more about
<a href=/docs/concepts/workloads/pods/pod-lifecycle/#container-probes>Container Probes</a>.</li></ul><p>You can also read the API references for:</p><ul><li><a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/>Pod</a>, and specifically:<ul><li><a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#Container>container(s)</a></li><li><a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#Probe>probe(s)</a></li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-bbc17480da6d051c696489654c64064a>3.15 - Assign Pods to Nodes</h1><p>This page shows how to assign a Kubernetes Pod to a particular node in a
Kubernetes cluster.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=add-a-label-to-a-node>Add a label to a node</h2><ol><li><p>List the <a class=glossary-tooltip title='A node is a worker machine in Kubernetes.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/nodes/ target=_blank aria-label=nodes>nodes</a> in your cluster, along with their labels:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes --show-labels
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME      STATUS    ROLES    AGE     VERSION        LABELS
</span></span><span style=display:flex><span>worker0   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname<span style=color:#666>=</span>worker0
</span></span><span style=display:flex><span>worker1   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname<span style=color:#666>=</span>worker1
</span></span><span style=display:flex><span>worker2   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname<span style=color:#666>=</span>worker2
</span></span></code></pre></div></li><li><p>Choose one of your nodes, and add a label to it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label nodes &lt;your-node-name&gt; <span style=color:#b8860b>disktype</span><span style=color:#666>=</span>ssd
</span></span></code></pre></div><p>where <code>&lt;your-node-name></code> is the name of your chosen node.</p></li><li><p>Verify that your chosen node has a <code>disktype=ssd</code> label:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes --show-labels
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME      STATUS    ROLES    AGE     VERSION        LABELS
</span></span><span style=display:flex><span>worker0   Ready     &lt;none&gt;   1d      v1.13.0        ...,disktype<span style=color:#666>=</span>ssd,kubernetes.io/hostname<span style=color:#666>=</span>worker0
</span></span><span style=display:flex><span>worker1   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname<span style=color:#666>=</span>worker1
</span></span><span style=display:flex><span>worker2   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname<span style=color:#666>=</span>worker2
</span></span></code></pre></div><p>In the preceding output, you can see that the <code>worker0</code> node has a
<code>disktype=ssd</code> label.</p></li></ol><h2 id=create-a-pod-that-gets-scheduled-to-your-chosen-node>Create a pod that gets scheduled to your chosen node</h2><p>This pod configuration file describes a pod that has a node selector,
<code>disktype: ssd</code>. This means that the pod will get scheduled on a node that has
a <code>disktype=ssd</code> label.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-nginx.yaml download=pods/pod-nginx.yaml><code>pods/pod-nginx.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-nginx-yaml")' title="Copy pods/pod-nginx.yaml to clipboard"></img></div><div class=includecode id=pods-pod-nginx-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>disktype</span>:<span style=color:#bbb> </span>ssd<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Use the configuration file to create a pod that will get scheduled on your
chosen node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/pod-nginx.yaml
</span></span></code></pre></div></li><li><p>Verify that the pod is running on your chosen node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --output<span style=color:#666>=</span>wide
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME     READY     STATUS    RESTARTS   AGE    IP           NODE
</span></span><span style=display:flex><span>nginx    1/1       Running   <span style=color:#666>0</span>          13s    10.200.0.4   worker0
</span></span></code></pre></div></li></ol><h2 id=create-a-pod-that-gets-scheduled-to-specific-node>Create a pod that gets scheduled to specific node</h2><p>You can also schedule a pod to one specific node via setting <code>nodeName</code>.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-nginx-specific-node.yaml download=pods/pod-nginx-specific-node.yaml><code>pods/pod-nginx-specific-node.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-nginx-specific-node-yaml")' title="Copy pods/pod-nginx-specific-node.yaml to clipboard"></img></div><div class=includecode id=pods-pod-nginx-specific-node-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeName</span>:<span style=color:#bbb> </span>foo-node<span style=color:#bbb> </span><span style=color:#080;font-style:italic># schedule pod to specific node</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Use the configuration file to create a pod that will get scheduled on <code>foo-node</code> only.</p><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/overview/working-with-objects/labels/>labels and selectors</a>.</li><li>Learn more about <a href=/docs/concepts/architecture/nodes/>nodes</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fc3f4777ae8ea685d2b54e175277ac01>3.16 - Assign Pods to Nodes using Node Affinity</h1><p>This page shows how to assign a Kubernetes Pod to a particular node using Node Affinity in a
Kubernetes cluster.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.10.
To check the version, enter <code>kubectl version</code>.</p><h2 id=add-a-label-to-a-node>Add a label to a node</h2><ol><li><p>List the nodes in your cluster, along with their labels:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes --show-labels
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME      STATUS    ROLES    AGE     VERSION        LABELS
</span></span><span style=display:flex><span>worker0   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname<span style=color:#666>=</span>worker0
</span></span><span style=display:flex><span>worker1   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname<span style=color:#666>=</span>worker1
</span></span><span style=display:flex><span>worker2   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname<span style=color:#666>=</span>worker2
</span></span></code></pre></div></li><li><p>Choose one of your nodes, and add a label to it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label nodes &lt;your-node-name&gt; <span style=color:#b8860b>disktype</span><span style=color:#666>=</span>ssd
</span></span></code></pre></div><p>where <code>&lt;your-node-name></code> is the name of your chosen node.</p></li><li><p>Verify that your chosen node has a <code>disktype=ssd</code> label:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes --show-labels
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME      STATUS    ROLES    AGE     VERSION        LABELS
worker0   Ready     &lt;none&gt;   1d      v1.13.0        ...,disktype=ssd,kubernetes.io/hostname=worker0
worker1   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname=worker1
worker2   Ready     &lt;none&gt;   1d      v1.13.0        ...,kubernetes.io/hostname=worker2
</code></pre><p>In the preceding output, you can see that the <code>worker0</code> node has a
<code>disktype=ssd</code> label.</p></li></ol><h2 id=schedule-a-pod-using-required-node-affinity>Schedule a Pod using required node affinity</h2><p>This manifest describes a Pod that has a <code>requiredDuringSchedulingIgnoredDuringExecution</code> node affinity,<code>disktype: ssd</code>.
This means that the pod will get scheduled only on a node that has a <code>disktype=ssd</code> label.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-nginx-required-affinity.yaml download=pods/pod-nginx-required-affinity.yaml><code>pods/pod-nginx-required-affinity.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-nginx-required-affinity-yaml")' title="Copy pods/pod-nginx-required-affinity.yaml to clipboard"></img></div><div class=includecode id=pods-pod-nginx-required-affinity-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>affinity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>nodeAffinity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requiredDuringSchedulingIgnoredDuringExecution</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>nodeSelectorTerms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>matchExpressions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>disktype<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>In<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>values</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- ssd            <span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Apply the manifest to create a Pod that is scheduled onto your
chosen node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/pod-nginx-required-affinity.yaml
</span></span></code></pre></div></li><li><p>Verify that the pod is running on your chosen node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --output<span style=color:#666>=</span>wide
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME     READY     STATUS    RESTARTS   AGE    IP           NODE
nginx    1/1       Running   0          13s    10.200.0.4   worker0
</code></pre></li></ol><h2 id=schedule-a-pod-using-preferred-node-affinity>Schedule a Pod using preferred node affinity</h2><p>This manifest describes a Pod that has a <code>preferredDuringSchedulingIgnoredDuringExecution</code> node affinity,<code>disktype: ssd</code>.
This means that the pod will prefer a node that has a <code>disktype=ssd</code> label.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-nginx-preferred-affinity.yaml download=pods/pod-nginx-preferred-affinity.yaml><code>pods/pod-nginx-preferred-affinity.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-nginx-preferred-affinity-yaml")' title="Copy pods/pod-nginx-preferred-affinity.yaml to clipboard"></img></div><div class=includecode id=pods-pod-nginx-preferred-affinity-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>affinity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>nodeAffinity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>preferredDuringSchedulingIgnoredDuringExecution</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>weight</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>preference</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>matchExpressions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>disktype<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>In<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>values</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- ssd          <span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Apply the manifest to create a Pod that is scheduled onto your
chosen node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/pod-nginx-preferred-affinity.yaml
</span></span></code></pre></div></li><li><p>Verify that the pod is running on your chosen node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --output<span style=color:#666>=</span>wide
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME     READY     STATUS    RESTARTS   AGE    IP           NODE
nginx    1/1       Running   0          13s    10.200.0.4   worker0
</code></pre></li></ol><h2 id=what-s-next>What's next</h2><p>Learn more about
<a href=/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity>Node Affinity</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1e7baac1825631a5af5d2aebcf059249>3.17 - Configure Pod Initialization</h1><p>This page shows how to use an Init Container to initialize a Pod before an
application Container runs.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=create-a-pod-that-has-an-init-container>Create a Pod that has an Init Container</h2><p>In this exercise you create a Pod that has one application Container and one
Init Container. The init container runs to completion before the application
container starts.</p><p>Here is the configuration file for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/init-containers.yaml download=pods/init-containers.yaml><code>pods/init-containers.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-init-containers-yaml")' title="Copy pods/init-containers.yaml to clipboard"></img></div><div class=includecode id=pods-init-containers-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>init-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>workdir<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/usr/share/nginx/html<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># These containers are run during pod initialization</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>initContainers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>install<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- wget<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;-O&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;/work-dir/index.html&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- http://info.cern.ch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>workdir<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/work-dir&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>dnsPolicy</span>:<span style=color:#bbb> </span>Default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>workdir<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the configuration file, you can see that the Pod has a Volume that the init
container and the application container share.</p><p>The init container mounts the
shared Volume at <code>/work-dir</code>, and the application container mounts the shared
Volume at <code>/usr/share/nginx/html</code>. The init container runs the following command
and then terminates:</p><pre><code>wget -O /work-dir/index.html http://info.cern.ch
</code></pre><p>Notice that the init container writes the <code>index.html</code> file in the root directory
of the nginx server.</p><p>Create the Pod:</p><pre><code>kubectl apply -f https://k8s.io/examples/pods/init-containers.yaml
</code></pre><p>Verify that the nginx container is running:</p><pre><code>kubectl get pod init-demo
</code></pre><p>The output shows that the nginx container is running:</p><pre><code>NAME        READY     STATUS    RESTARTS   AGE
init-demo   1/1       Running   0          1m
</code></pre><p>Get a shell into the nginx container running in the init-demo Pod:</p><pre><code>kubectl exec -it init-demo -- /bin/bash
</code></pre><p>In your shell, send a GET request to the nginx server:</p><pre><code>root@nginx:~# apt-get update
root@nginx:~# apt-get install curl
root@nginx:~# curl localhost
</code></pre><p>The output shows that nginx is serving the web page that was written by the init container:</p><pre><code>&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;header&gt;
&lt;title&gt;http://info.cern.ch&lt;/title&gt;
&lt;/header&gt;

&lt;h1&gt;http://info.cern.ch - home of the first website&lt;/h1&gt;
  ...
  &lt;li&gt;&lt;a href=&quot;http://info.cern.ch/hypertext/WWW/TheProject.html&quot;&gt;Browse the first website&lt;/a&gt;&lt;/li&gt;
  ...
</code></pre><h2 id=what-s-next>What's next</h2><ul><li>Learn more about
<a href=/docs/tasks/access-application-cluster/communicate-containers-same-pod-shared-volume/>communicating between Containers running in the same Pod</a>.</li><li>Learn more about <a href=/docs/concepts/workloads/pods/init-containers/>Init Containers</a>.</li><li>Learn more about <a href=/docs/concepts/storage/volumes/>Volumes</a>.</li><li>Learn more about <a href=/docs/tasks/debug/debug-application/debug-init-containers/>Debugging Init Containers</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-efbc43486296f0439d1a89c12d944d94>3.18 - Attach Handlers to Container Lifecycle Events</h1><p>This page shows how to attach handlers to Container lifecycle events. Kubernetes supports
the postStart and preStop events. Kubernetes sends the postStart event immediately
after a Container is started, and it sends the preStop event immediately before the
Container is terminated. A Container may specify one handler per event.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=define-poststart-and-prestop-handlers>Define postStart and preStop handlers</h2><p>In this exercise, you create a Pod that has one Container. The Container has handlers
for the postStart and preStop events.</p><p>Here is the configuration file for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/lifecycle-events.yaml download=pods/lifecycle-events.yaml><code>pods/lifecycle-events.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-lifecycle-events-yaml")' title="Copy pods/lifecycle-events.yaml to clipboard"></img></div><div class=includecode id=pods-lifecycle-events-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lifecycle-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>lifecycle-demo-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lifecycle</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>postStart</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>exec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;echo Hello from the postStart handler &gt; /usr/share/message&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>preStop</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>exec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#b44>&#34;nginx -s quit; while killall -0 nginx; do sleep 1; done&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the configuration file, you can see that the postStart command writes a <code>message</code>
file to the Container's <code>/usr/share</code> directory. The preStop command shuts down
nginx gracefully. This is helpful if the Container is being terminated because of a failure.</p><p>Create the Pod:</p><pre><code>kubectl apply -f https://k8s.io/examples/pods/lifecycle-events.yaml
</code></pre><p>Verify that the Container in the Pod is running:</p><pre><code>kubectl get pod lifecycle-demo
</code></pre><p>Get a shell into the Container running in your Pod:</p><pre><code>kubectl exec -it lifecycle-demo -- /bin/bash
</code></pre><p>In your shell, verify that the <code>postStart</code> handler created the <code>message</code> file:</p><pre><code>root@lifecycle-demo:/# cat /usr/share/message
</code></pre><p>The output shows the text written by the postStart handler:</p><pre><code>Hello from the postStart handler
</code></pre><h2 id=discussion>Discussion</h2><p>Kubernetes sends the postStart event immediately after the Container is created.
There is no guarantee, however, that the postStart handler is called before
the Container's entrypoint is called. The postStart handler runs asynchronously
relative to the Container's code, but Kubernetes' management of the container
blocks until the postStart handler completes. The Container's status is not
set to RUNNING until the postStart handler completes.</p><p>Kubernetes sends the preStop event immediately before the Container is terminated.
Kubernetes' management of the Container blocks until the preStop handler completes,
unless the Pod's grace period expires. For more details, see
<a href=/docs/concepts/workloads/pods/pod-lifecycle/>Pod Lifecycle</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Kubernetes only sends the preStop event when a Pod is <em>terminated</em>.
This means that the preStop hook is not invoked when the Pod is <em>completed</em>.
This limitation is tracked in <a href=https://github.com/kubernetes/kubernetes/issues/55807>issue #55087</a>.</div><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/containers/container-lifecycle-hooks/>Container lifecycle hooks</a>.</li><li>Learn more about the <a href=/docs/concepts/workloads/pods/pod-lifecycle/>lifecycle of a Pod</a>.</li></ul><h3 id=reference>Reference</h3><ul><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#lifecycle-v1-core>Lifecycle</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#container-v1-core>Container</a></li><li>See <code>terminationGracePeriodSeconds</code> in <a href=/docs/reference/generated/kubernetes-api/v1.25/#podspec-v1-core>PodSpec</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ed34e761c3dbd00fa79577fa78e30020>3.19 - Configure a Pod to Use a ConfigMap</h1><p>Many applications rely on configuration which is used during either application initialization or runtime.
Most of the times there is a requirement to adjust values assigned to configuration parameters.
ConfigMaps are the Kubernetes way to inject application pods with configuration data.
ConfigMaps allow you to decouple configuration artifacts from image content to keep containerized applications portable. This page provides a series of usage examples demonstrating how to create ConfigMaps and configure Pods using data stored in ConfigMaps.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=create-a-configmap>Create a ConfigMap</h2><p>You can use either <code>kubectl create configmap</code> or a ConfigMap generator in <code>kustomization.yaml</code> to create a ConfigMap. Note that <code>kubectl</code> starts to support <code>kustomization.yaml</code> since 1.14.</p><h3 id=create-a-configmap-using-kubectl-create-configmap>Create a ConfigMap Using kubectl create configmap</h3><p>Use the <code>kubectl create configmap</code> command to create ConfigMaps from <a href=#create-configmaps-from-directories>directories</a>, <a href=#create-configmaps-from-files>files</a>, or <a href=#create-configmaps-from-literal-values>literal values</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap &lt;map-name&gt; &lt;data-source&gt;
</span></span></code></pre></div><p>where &lt;map-name> is the name you want to assign to the ConfigMap and &lt;data-source> is the directory, file, or literal value to draw the data from.
The name of a ConfigMap object must be a valid
<a href=/docs/concepts/overview/working-with-objects/names#dns-subdomain-names>DNS subdomain name</a>.</p><p>When you are creating a ConfigMap based on a file, the key in the &lt;data-source> defaults to the basename of the file, and the value defaults to the file content.</p><p>You can use <a href=/docs/reference/generated/kubectl/kubectl-commands/#describe><code>kubectl describe</code></a> or
<a href=/docs/reference/generated/kubectl/kubectl-commands/#get><code>kubectl get</code></a> to retrieve information
about a ConfigMap.</p><h4 id=create-configmaps-from-directories>Create ConfigMaps from directories</h4><p>You can use <code>kubectl create configmap</code> to create a ConfigMap from multiple files in the same directory. When you are creating a ConfigMap based on a directory, kubectl identifies files whose basename is a valid key in the directory and packages each of those files into the new ConfigMap. Any directory entries except regular files are ignored (e.g. subdirectories, symlinks, devices, pipes, etc).</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create the local directory</span>
</span></span><span style=display:flex><span>mkdir -p configure-pod-container/configmap/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Download the sample files into `configure-pod-container/configmap/` directory</span>
</span></span><span style=display:flex><span>wget https://kubernetes.io/examples/configmap/game.properties -O configure-pod-container/configmap/game.properties
</span></span><span style=display:flex><span>wget https://kubernetes.io/examples/configmap/ui.properties -O configure-pod-container/configmap/ui.properties
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create the configmap</span>
</span></span><span style=display:flex><span>kubectl create configmap game-config --from-file<span style=color:#666>=</span>configure-pod-container/configmap/
</span></span></code></pre></div><p>The above command packages each file, in this case, <code>game.properties</code> and <code>ui.properties</code> in the <code>configure-pod-container/configmap/</code> directory into the game-config ConfigMap. You can display details of the ConfigMap using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe configmaps game-config
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>Name:         game-config
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
game.properties:
----
enemies=aliens
lives=3
enemies.cheat=true
enemies.cheat.level=noGoodRotten
secret.code.passphrase=UUDDLRLRBABAS
secret.code.allowed=true
secret.code.lives=30
ui.properties:
----
color.good=purple
color.bad=yellow
allow.textmode=true
how.nice.to.look=fairlyNice
</code></pre><p>The <code>game.properties</code> and <code>ui.properties</code> files in the <code>configure-pod-container/configmap/</code> directory are represented in the <code>data</code> section of the ConfigMap.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get configmaps game-config -o yaml
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2016-02-18T18:52:05Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>game-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;516&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>b4952dc3-d670-11e5-8cd0-68f728db1985<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>game.properties</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    enemies=aliens
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    lives=3
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    enemies.cheat=true
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    enemies.cheat.level=noGoodRotten
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    secret.code.passphrase=UUDDLRLRBABAS
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    secret.code.allowed=true
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    secret.code.lives=30</span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ui.properties</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    color.good=purple
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    color.bad=yellow
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    allow.textmode=true
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    how.nice.to.look=fairlyNice</span><span style=color:#bbb>    
</span></span></span></code></pre></div><h4 id=create-configmaps-from-files>Create ConfigMaps from files</h4><p>You can use <code>kubectl create configmap</code> to create a ConfigMap from an individual file, or from multiple files.</p><p>For example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap game-config-2 --from-file<span style=color:#666>=</span>configure-pod-container/configmap/game.properties
</span></span></code></pre></div><p>would produce the following ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe configmaps game-config-2
</span></span></code></pre></div><p>where the output is similar to this:</p><pre tabindex=0><code>Name:         game-config-2
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
game.properties:
----
enemies=aliens
lives=3
enemies.cheat=true
enemies.cheat.level=noGoodRotten
secret.code.passphrase=UUDDLRLRBABAS
secret.code.allowed=true
secret.code.lives=30
</code></pre><p>You can pass in the <code>--from-file</code> argument multiple times to create a ConfigMap from multiple data sources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap game-config-2 --from-file<span style=color:#666>=</span>configure-pod-container/configmap/game.properties --from-file<span style=color:#666>=</span>configure-pod-container/configmap/ui.properties
</span></span></code></pre></div><p>You can display details of the <code>game-config-2</code> ConfigMap using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe configmaps game-config-2
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>Name:         game-config-2
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
game.properties:
----
enemies=aliens
lives=3
enemies.cheat=true
enemies.cheat.level=noGoodRotten
secret.code.passphrase=UUDDLRLRBABAS
secret.code.allowed=true
secret.code.lives=30
ui.properties:
----
color.good=purple
color.bad=yellow
allow.textmode=true
how.nice.to.look=fairlyNice
</code></pre><p>When <code>kubectl</code> creates a ConfigMap from inputs that are not ASCII or UTF-8, the tool puts these into the <code>binaryData</code> field of the ConfigMap, and not in <code>data</code>. Both text and binary data sources can be combined in one ConfigMap.
If you want to view the <code>binaryData</code> keys (and their values) in a ConfigMap, you can run <code>kubectl get configmap -o jsonpath='{.binaryData}' &lt;name></code>.</p><p>Use the option <code>--from-env-file</code> to create a ConfigMap from an env-file, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Env-files contain a list of environment variables.</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># These syntax rules apply:</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#   Each line in an env file has to be in VAR=VAL format.</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#   Lines beginning with # (i.e. comments) are ignored.</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#   Blank lines are ignored.</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#   There is no special handling of quotation marks (i.e. they will be part of the ConfigMap value)).</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Download the sample files into `configure-pod-container/configmap/` directory</span>
</span></span><span style=display:flex><span>wget https://kubernetes.io/examples/configmap/game-env-file.properties -O configure-pod-container/configmap/game-env-file.properties
</span></span><span style=display:flex><span>wget https://kubernetes.io/examples/configmap/ui-env-file.properties -O configure-pod-container/configmap/ui-env-file.properties
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># The env-file `game-env-file.properties` looks like below</span>
</span></span><span style=display:flex><span>cat configure-pod-container/configmap/game-env-file.properties
</span></span><span style=display:flex><span><span style=color:#b8860b>enemies</span><span style=color:#666>=</span>aliens
</span></span><span style=display:flex><span><span style=color:#b8860b>lives</span><span style=color:#666>=</span><span style=color:#666>3</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>allowed</span><span style=color:#666>=</span><span style=color:#b44>&#34;true&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># This comment and the empty line above it are ignored</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap game-config-env-file <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>       --from-env-file<span style=color:#666>=</span>configure-pod-container/configmap/game-env-file.properties
</span></span></code></pre></div><p>would produce the following ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get configmap game-config-env-file -o yaml
</span></span></code></pre></div><p>where the output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2017-12-27T18:36:28Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>game-config-env-file<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;809965&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>d9d1ca5b-eb34-11e7-887b-42010a8002b8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>allowed</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;&#34;true&#34;&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>enemies</span>:<span style=color:#bbb> </span>aliens<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>lives</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;3&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Starting with Kubernetes v1.23, <code>kubectl</code> supports the <code>--from-env-file</code> argument to be
specified multiple times to create a ConfigMap from multiple data sources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap config-multi-env-files <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>        --from-env-file<span style=color:#666>=</span>configure-pod-container/configmap/game-env-file.properties <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>        --from-env-file<span style=color:#666>=</span>configure-pod-container/configmap/ui-env-file.properties
</span></span></code></pre></div><p>would produce the following ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get configmap config-multi-env-files -o yaml
</span></span></code></pre></div><p>where the output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2017-12-27T18:38:34Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-multi-env-files<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;810136&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>252c4572-eb35-11e7-887b-42010a8002b8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>allowed</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;&#34;true&#34;&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>color</span>:<span style=color:#bbb> </span>purple<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>enemies</span>:<span style=color:#bbb> </span>aliens<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>how</span>:<span style=color:#bbb> </span>fairlyNice<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>lives</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;3&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>textmode</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h4 id=define-the-key-to-use-when-creating-a-configmap-from-a-file>Define the key to use when creating a ConfigMap from a file</h4><p>You can define a key other than the file name to use in the <code>data</code> section of your ConfigMap when using the <code>--from-file</code> argument:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap game-config-3 --from-file<span style=color:#666>=</span>&lt;my-key-name&gt;<span style=color:#666>=</span>&lt;path-to-file&gt;
</span></span></code></pre></div><p>where <code>&lt;my-key-name></code> is the key you want to use in the ConfigMap and <code>&lt;path-to-file></code> is the location of the data source file you want the key to represent.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap game-config-3 --from-file<span style=color:#666>=</span>game-special-key<span style=color:#666>=</span>configure-pod-container/configmap/game.properties
</span></span></code></pre></div><p>would produce the following ConfigMap:</p><pre tabindex=0><code>kubectl get configmaps game-config-3 -o yaml
</code></pre><p>where the output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2016-02-18T18:54:22Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>game-config-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;530&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>05f8da22-d671-11e5-8cd0-68f728db1985<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>game-special-key</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    enemies=aliens
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    lives=3
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    enemies.cheat=true
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    enemies.cheat.level=noGoodRotten
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    secret.code.passphrase=UUDDLRLRBABAS
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    secret.code.allowed=true
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    secret.code.lives=30</span><span style=color:#bbb>    
</span></span></span></code></pre></div><h4 id=create-configmaps-from-literal-values>Create ConfigMaps from literal values</h4><p>You can use <code>kubectl create configmap</code> with the <code>--from-literal</code> argument to define a literal value from the command line:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap special-config --from-literal<span style=color:#666>=</span>special.how<span style=color:#666>=</span>very --from-literal<span style=color:#666>=</span>special.type<span style=color:#666>=</span>charm
</span></span></code></pre></div><p>You can pass in multiple key-value pairs. Each pair provided on the command line is represented as a separate entry in the <code>data</code> section of the ConfigMap.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get configmaps special-config -o yaml
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2016-02-18T19:14:38Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;651&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>dadce046-d673-11e5-8cd0-68f728db1985<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>special.how</span>:<span style=color:#bbb> </span>very<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>special.type</span>:<span style=color:#bbb> </span>charm<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=create-a-configmap-from-generator>Create a ConfigMap from generator</h3><p><code>kubectl</code> supports <code>kustomization.yaml</code> since 1.14.
You can also create a ConfigMap from generators and then apply it to create the object on
the Apiserver. The generators
should be specified in a <code>kustomization.yaml</code> inside a directory.</p><h4 id=generate-configmaps-from-files>Generate ConfigMaps from files</h4><p>For example, to generate a ConfigMap from files <code>configure-pod-container/configmap/game.properties</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a kustomization.yaml file with ConfigMapGenerator</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>configMapGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: game-config-4
</span></span></span><span style=display:flex><span><span style=color:#b44>  files:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - configure-pod-container/configmap/game.properties
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Apply the kustomization directory to create the ConfigMap object.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k .
</span></span><span style=display:flex><span>configmap/game-config-4-m9dm2f92bt created
</span></span></code></pre></div><p>You can check that the ConfigMap was created like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get configmap
</span></span><span style=display:flex><span>NAME                       DATA   AGE
</span></span><span style=display:flex><span>game-config-4-m9dm2f92bt   <span style=color:#666>1</span>      37s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl describe configmaps/game-config-4-m9dm2f92bt
</span></span><span style=display:flex><span>Name:         game-config-4-m9dm2f92bt
</span></span><span style=display:flex><span>Namespace:    default
</span></span><span style=display:flex><span>Labels:       &lt;none&gt;
</span></span><span style=display:flex><span>Annotations:  kubectl.kubernetes.io/last-applied-configuration:
</span></span><span style=display:flex><span>                <span style=color:#666>{</span><span style=color:#b44>&#34;apiVersion&#34;</span>:<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#b44>&#34;data&#34;</span>:<span style=color:#666>{</span><span style=color:#b44>&#34;game.properties&#34;</span>:<span style=color:#b44>&#34;enemies=aliens\nlives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\nsecret.code.p...
</span></span></span><span style=display:flex><span><span style=color:#b44>
</span></span></span><span style=display:flex><span><span style=color:#b44>Data
</span></span></span><span style=display:flex><span><span style=color:#b44>====
</span></span></span><span style=display:flex><span><span style=color:#b44>game.properties:
</span></span></span><span style=display:flex><span><span style=color:#b44>----
</span></span></span><span style=display:flex><span><span style=color:#b44>enemies=aliens
</span></span></span><span style=display:flex><span><span style=color:#b44>lives=3
</span></span></span><span style=display:flex><span><span style=color:#b44>enemies.cheat=true
</span></span></span><span style=display:flex><span><span style=color:#b44>enemies.cheat.level=noGoodRotten
</span></span></span><span style=display:flex><span><span style=color:#b44>secret.code.passphrase=UUDDLRLRBABAS
</span></span></span><span style=display:flex><span><span style=color:#b44>secret.code.allowed=true
</span></span></span><span style=display:flex><span><span style=color:#b44>secret.code.lives=30
</span></span></span><span style=display:flex><span><span style=color:#b44>Events:  &lt;none&gt;
</span></span></span></code></pre></div><p>Note that the generated ConfigMap name has a suffix appended by hashing the contents. This ensures that a
new ConfigMap is generated each time the content is modified.</p><h4 id=define-the-key-to-use-when-generating-a-configmap-from-a-file>Define the key to use when generating a ConfigMap from a file</h4><p>You can define a key other than the file name to use in the ConfigMap generator.
For example, to generate a ConfigMap from files <code>configure-pod-container/configmap/game.properties</code>
with the key <code>game-special-key</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a kustomization.yaml file with ConfigMapGenerator</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>configMapGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: game-config-5
</span></span></span><span style=display:flex><span><span style=color:#b44>  files:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - game-special-key=configure-pod-container/configmap/game.properties
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Apply the kustomization directory to create the ConfigMap object.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k .
</span></span><span style=display:flex><span>configmap/game-config-5-m67dt67794 created
</span></span></code></pre></div><h4 id=generate-configmaps-from-literals>Generate ConfigMaps from Literals</h4><p>To generate a ConfigMap from literals <code>special.type=charm</code> and <code>special.how=very</code>,
you can specify the ConfigMap generator in <code>kustomization.yaml</code> as</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a kustomization.yaml file with ConfigMapGenerator</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>configMapGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: special-config-2
</span></span></span><span style=display:flex><span><span style=color:#b44>  literals:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - special.how=very
</span></span></span><span style=display:flex><span><span style=color:#b44>  - special.type=charm
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Apply the kustomization directory to create the ConfigMap object.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k .
</span></span><span style=display:flex><span>configmap/special-config-2-c92b5mmcf2 created
</span></span></code></pre></div><h2 id=define-container-environment-variables-using-configmap-data>Define container environment variables using ConfigMap data</h2><h3 id=define-a-container-environment-variable-with-data-from-a-single-configmap>Define a container environment variable with data from a single ConfigMap</h3><ol><li><p>Define an environment variable as a key-value pair in a ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap special-config --from-literal<span style=color:#666>=</span>special.how<span style=color:#666>=</span>very
</span></span></code></pre></div></li><li><p>Assign the <code>special.how</code> value defined in the ConfigMap to the <code>SPECIAL_LEVEL_KEY</code> environment variable in the Pod specification.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-single-configmap-env-variable.yaml download=pods/pod-single-configmap-env-variable.yaml><code>pods/pod-single-configmap-env-variable.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-single-configmap-env-variable-yaml")' title="Copy pods/pod-single-configmap-env-variable.yaml to clipboard"></img></div><div class=includecode id=pods-pod-single-configmap-env-variable-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-test-pod<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;env&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># Define the environment variable</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SPECIAL_LEVEL_KEY<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>configMapKeyRef</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:#080;font-style:italic># The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:#080;font-style:italic># Specify the key associated with the value</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>special.how<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
   </span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/pods/pod-single-configmap-env-variable.yaml
</span></span></code></pre></div><p>Now, the Pod's output includes environment variable <code>SPECIAL_LEVEL_KEY=very</code>.</p></li></ol><h3 id=define-container-environment-variables-with-data-from-multiple-configmaps>Define container environment variables with data from multiple ConfigMaps</h3><ul><li><p>As with the previous example, create the ConfigMaps first.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/configmap/configmaps.yaml download=configmap/configmaps.yaml><code>configmap/configmaps.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("configmap-configmaps-yaml")' title="Copy configmap/configmaps.yaml to clipboard"></img></div><div class=includecode id=configmap-configmaps-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>special.how</span>:<span style=color:#bbb> </span>very<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>env-config<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>log_level</span>:<span style=color:#bbb> </span>INFO<span style=color:#bbb>
  </span></span></span></code></pre></div></div></div><p>Create the ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/configmap/configmaps.yaml
</span></span></code></pre></div></li><li><p>Define the environment variables in the Pod specification.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-multiple-configmap-env-variable.yaml download=pods/pod-multiple-configmap-env-variable.yaml><code>pods/pod-multiple-configmap-env-variable.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-multiple-configmap-env-variable-yaml")' title="Copy pods/pod-multiple-configmap-env-variable.yaml to clipboard"></img></div><div class=includecode id=pods-pod-multiple-configmap-env-variable-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-test-pod<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;env&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SPECIAL_LEVEL_KEY<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>configMapKeyRef</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>special.how<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>LOG_LEVEL<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>configMapKeyRef</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>env-config<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>log_level<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
  </span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/pods/pod-multiple-configmap-env-variable.yaml
</span></span></code></pre></div><p>Now, the Pod's output includes environment variables <code>SPECIAL_LEVEL_KEY=very</code> and <code>LOG_LEVEL=INFO</code>.</p></li></ul><h2 id=configure-all-key-value-pairs-in-a-configmap-as-container-environment-variables>Configure all key-value pairs in a ConfigMap as container environment variables</h2><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This functionality is available in Kubernetes v1.6 and later.</div><ul><li><p>Create a ConfigMap containing multiple key-value pairs.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/configmap/configmap-multikeys.yaml download=configmap/configmap-multikeys.yaml><code>configmap/configmap-multikeys.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("configmap-configmap-multikeys-yaml")' title="Copy configmap/configmap-multikeys.yaml to clipboard"></img></div><div class=includecode id=configmap-configmap-multikeys-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>SPECIAL_LEVEL</span>:<span style=color:#bbb> </span>very<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>SPECIAL_TYPE</span>:<span style=color:#bbb> </span>charm<span style=color:#bbb>
  </span></span></span></code></pre></div></div></div><p>Create the ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/configmap/configmap-multikeys.yaml
</span></span></code></pre></div></li><li><p>Use <code>envFrom</code> to define all of the ConfigMap's data as container environment variables. The key from the ConfigMap becomes the environment variable name in the Pod.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-configmap-envFrom.yaml download=pods/pod-configmap-envFrom.yaml><code>pods/pod-configmap-envFrom.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-configmap-envfrom-yaml")' title="Copy pods/pod-configmap-envFrom.yaml to clipboard"></img></div><div class=includecode id=pods-pod-configmap-envfrom-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-test-pod<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;env&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>envFrom</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>configMapRef</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
  </span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/pods/pod-configmap-envFrom.yaml
</span></span></code></pre></div><p>Now, the Pod's output includes environment variables <code>SPECIAL_LEVEL=very</code> and <code>SPECIAL_TYPE=charm</code>.</p></li></ul><h2 id=use-configmap-defined-environment-variables-in-pod-commands>Use ConfigMap-defined environment variables in Pod commands</h2><p>You can use ConfigMap-defined environment variables in the <code>command</code> and <code>args</code> of a container using the <code>$(VAR_NAME)</code> Kubernetes substitution syntax.</p><p>For example, the following Pod specification</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-configmap-env-var-valueFrom.yaml download=pods/pod-configmap-env-var-valueFrom.yaml><code>pods/pod-configmap-env-var-valueFrom.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-configmap-env-var-valuefrom-yaml")' title="Copy pods/pod-configmap-env-var-valueFrom.yaml to clipboard"></img></div><div class=includecode id=pods-pod-configmap-env-var-valuefrom-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-test-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/bin/echo&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;$(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SPECIAL_LEVEL_KEY<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>configMapKeyRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>SPECIAL_LEVEL<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SPECIAL_TYPE_KEY<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>configMapKeyRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>SPECIAL_TYPE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>created by running</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/pods/pod-configmap-env-var-valueFrom.yaml
</span></span></code></pre></div><p>produces the following output in the <code>test-container</code> container:</p><pre tabindex=0><code>very charm
</code></pre><h2 id=add-configmap-data-to-a-volume>Add ConfigMap data to a Volume</h2><p>As explained in <a href=#create-configmaps-from-files>Create ConfigMaps from files</a>, when you create a ConfigMap using <code>--from-file</code>, the filename becomes a key stored in the <code>data</code> section of the ConfigMap. The file contents become the key's value.</p><p>The examples in this section refer to a ConfigMap named special-config, shown below.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/configmap/configmap-multikeys.yaml download=configmap/configmap-multikeys.yaml><code>configmap/configmap-multikeys.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("configmap-configmap-multikeys-yaml")' title="Copy configmap/configmap-multikeys.yaml to clipboard"></img></div><div class=includecode id=configmap-configmap-multikeys-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>SPECIAL_LEVEL</span>:<span style=color:#bbb> </span>very<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>SPECIAL_TYPE</span>:<span style=color:#bbb> </span>charm<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/configmap/configmap-multikeys.yaml
</span></span></code></pre></div><h3 id=populate-a-volume-with-data-stored-in-a-configmap>Populate a Volume with data stored in a ConfigMap</h3><p>Add the ConfigMap name under the <code>volumes</code> section of the Pod specification.
This adds the ConfigMap data to the directory specified as <code>volumeMounts.mountPath</code> (in this case, <code>/etc/config</code>).
The <code>command</code> section lists directory files with names that match the keys in ConfigMap.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-configmap-volume.yaml download=pods/pod-configmap-volume.yaml><code>pods/pod-configmap-volume.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-configmap-volume-yaml")' title="Copy pods/pod-configmap-volume.yaml to clipboard"></img></div><div class=includecode id=pods-pod-configmap-volume-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-test-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;ls /etc/config/&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># Provide the name of the ConfigMap containing the files you want</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># to add to the container</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/pods/pod-configmap-volume.yaml
</span></span></code></pre></div><p>When the pod runs, the command <code>ls /etc/config/</code> produces the output below:</p><pre tabindex=0><code>SPECIAL_LEVEL
SPECIAL_TYPE
</code></pre><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> If there are some files in the <code>/etc/config/</code> directory, they will be deleted.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Text data is exposed as files using the UTF-8 character encoding. To use some other character encoding, use binaryData.</div><h3 id=add-configmap-data-to-a-specific-path-in-the-volume>Add ConfigMap data to a specific path in the Volume</h3><p>Use the <code>path</code> field to specify the desired file path for specific ConfigMap items.
In this case, the <code>SPECIAL_LEVEL</code> item will be mounted in the <code>config-volume</code> volume at <code>/etc/config/keys</code>.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/pod-configmap-volume-specific-key.yaml download=pods/pod-configmap-volume-specific-key.yaml><code>pods/pod-configmap-volume-specific-key.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-pod-configmap-volume-specific-key-yaml")' title="Copy pods/pod-configmap-volume-specific-key.yaml to clipboard"></img></div><div class=includecode id=pods-pod-configmap-volume-specific-key-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-test-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#b44>&#34;cat /etc/config/keys&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>special-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>SPECIAL_LEVEL<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>keys<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://kubernetes.io/examples/pods/pod-configmap-volume-specific-key.yaml
</span></span></code></pre></div><p>When the pod runs, the command <code>cat /etc/config/keys</code> produces the output below:</p><pre tabindex=0><code>very
</code></pre><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Like before, all previous files in the <code>/etc/config/</code> directory will be deleted.</div><h3 id=project-keys-to-specific-paths-and-file-permissions>Project keys to specific paths and file permissions</h3><p>You can project keys to specific paths and specific permissions on a per-file
basis. The <a href=/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod>Secrets</a> user guide explains the syntax.</p><h2 id=understanding-configmaps-and-pods>Understanding ConfigMaps and Pods</h2><p>The ConfigMap API resource stores configuration data as key-value pairs. The data can be consumed in pods or provide the configurations for system components such as controllers. ConfigMap is similar to <a href=/docs/concepts/configuration/secret/>Secrets</a>, but provides a means of working with strings that don't contain sensitive information. Users and system components alike can store configuration data in ConfigMap.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> ConfigMaps should reference properties files, not replace them. Think of the ConfigMap as representing something similar to the Linux <code>/etc</code> directory and its contents. For example, if you create a <a href=/docs/concepts/storage/volumes/>Kubernetes Volume</a> from a ConfigMap, each data item in the ConfigMap is represented by an individual file in the volume.</div><p>The ConfigMap's <code>data</code> field contains the configuration data. As shown in the example below, this can be simple -- like individual properties defined using <code>--from-literal</code> -- or complex -- like configuration files or JSON blobs defined using <code>--from-file</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2016-02-18T19:14:38Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># example of a simple property defined using --from-literal</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>example.property.1</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>example.property.2</span>:<span style=color:#bbb> </span>world<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># example of a complex property defined using --from-file</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>example.property.file</span>:<span style=color:#bbb> </span>|-<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    property.1=value-1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    property.2=value-2
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    property.3=value-3</span><span style=color:#bbb>    
</span></span></span></code></pre></div><h3 id=restrictions>Restrictions</h3><ul><li><p>You must create the <code>ConfigMap</code> object before you reference it in a Pod specification. Alternatively, mark the ConfigMap reference as <code>optional</code> in the Pod spec (see <a href=#optional-configmaps>Optional ConfigMaps</a>). If you reference a ConfigMap that doesn't exist and you don't mark the reference as <code>optional</code>, the Pod won't start. Similarly, references to keys that don't exist in the ConfigMap will also prevent the Pod from starting, unless you mark the key references as <code>optional</code>.</p></li><li><p>If you use <code>envFrom</code> to define environment variables from ConfigMaps, keys that are considered invalid will be skipped. The pod will be allowed to start, but the invalid names will be recorded in the event log (<code>InvalidVariableNames</code>). The log message lists each skipped key. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get events
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>LASTSEEN FIRSTSEEN COUNT NAME          KIND  SUBOBJECT  TYPE      REASON                            SOURCE                MESSAGE
0s       0s        1     dapi-test-pod Pod              Warning   InvalidEnvironmentVariableNames   {kubelet, 127.0.0.1}  Keys [1badkey, 2alsobad] from the EnvFrom configMap default/myconfig were skipped since they are considered invalid environment variable names.
</code></pre></li><li><p>ConfigMaps reside in a specific <a class=glossary-tooltip title='An abstraction used by Kubernetes to support isolation of groups of resources within a single cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/namespaces target=_blank aria-label=Namespace>Namespace</a>. A ConfigMap can only be referenced by pods residing in the same namespace.</p></li><li><p>You can't use ConfigMaps for <a class=glossary-tooltip title='A pod managed directly by the kubelet daemon on a specific node.' data-toggle=tooltip data-placement=top href=/docs/tasks/configure-pod-container/static-pod/ target=_blank aria-label='static pods'>static pods</a>, because the Kubelet does not support this.</p></li></ul><h3 id=optional-configmaps>Optional ConfigMaps</h3><p>You can mark a reference to a ConfigMap as <em>optional</em> in a Pod specification.
If the ConfigMap doesn't exist, the configuration for which it provides data in the Pod (e.g. environment variable, mounted volume) will be empty.
If the ConfigMap exists, but the referenced key is non-existent the data is also empty.</p><p>For example, the following Pod specification marks an environment variable from a ConfigMap as optional:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-test-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google_containers/busybox<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;env&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SPECIAL_LEVEL_KEY<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>configMapKeyRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>a-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>akey<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>optional</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># mark the variable as optional</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div><p>If you run this pod, and there is no ConfigMap named <code>a-config</code>, the output is empty.
If you run this pod, and there is a ConfigMap named <code>a-config</code> but that ConfigMap doesn't have
a key named <code>akey</code>, the output is also empty. If you do set a value for <code>akey</code> in the <code>a-config</code>
ConfigMap, this pod prints that value and then terminates.</p><p>You can also mark the volumes and files provided by a ConfigMap as optional. Kubernetes always creates the mount paths for the volume, even if the referenced ConfigMap or key doesn't exist. For example, the following
Pod specification marks a volume that references a ConfigMap as optional:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-test-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google_containers/busybox<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;/bin/sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;ls /etc/config&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>no</span>-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>optional</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># mark the source ConfigMap as optional</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=mounted-configmaps-are-updated-automatically>Mounted ConfigMaps are updated automatically</h3><p>When a mounted ConfigMap is updated, the projected content is eventually updated too. This applies in the case where an optionally referenced ConfigMap comes into
existence after a pod has started.</p><p>The kubelet checks whether the mounted ConfigMap is fresh on every periodic sync. However, it uses its local TTL-based cache for getting the current value of the
ConfigMap. As a result, the total delay from the moment when the ConfigMap is updated to the moment when new keys are projected to the pod can be as long as
kubelet sync period (1 minute by default) + TTL of ConfigMaps cache (1 minute by default) in kubelet.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> A container using a ConfigMap as a <a href=/docs/concepts/storage/volumes/#using-subpath>subPath</a> volume will not receive ConfigMap updates.</div><h2 id=what-s-next>What's next</h2><ul><li>Follow a real world example of <a href=/docs/tutorials/configuration/configure-redis-using-configmap/>Configuring Redis using a ConfigMap</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-3d7b9cb24a647c36ba63f7a02ec49010>3.20 - Share Process Namespace between Containers in a Pod</h1><p>This page shows how to configure process namespace sharing for a pod. When
process namespace sharing is enabled, processes in a container are visible
to all other containers in the same pod.</p><p>You can use this feature to configure cooperating containers, such as a log
handler sidecar container, or to troubleshoot container images that don't
include debugging utilities like a shell.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=configure-a-pod>Configure a Pod</h2><p>Process namespace sharing is enabled using the <code>shareProcessNamespace</code> field of
<code>.spec</code> for a Pod. For example:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/share-process-namespace.yaml download=pods/share-process-namespace.yaml><code>pods/share-process-namespace.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-share-process-namespace-yaml")' title="Copy pods/share-process-namespace.yaml to clipboard"></img></div><div class=includecode id=pods-share-process-namespace-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>shareProcessNamespace</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>shell<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>capabilities</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>add</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- SYS_PTRACE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>stdin</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tty</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create the pod <code>nginx</code> on your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/share-process-namespace.yaml
</span></span></code></pre></div></li><li><p>Attach to the <code>shell</code> container and run <code>ps</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl attach -it nginx -c shell
</span></span></code></pre></div><p>If you don't see a command prompt, try pressing enter. In the container shell:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># run this inside the &#34;shell&#34; container</span>
</span></span><span style=display:flex><span>ps ax
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>PID   USER     TIME  COMMAND
    1 root      0:00 /pause
    8 root      0:00 nginx: master process nginx -g daemon off;
   14 101       0:00 nginx: worker process
   15 root      0:00 sh
   21 root      0:00 ps ax
</code></pre></li></ol><p>You can signal processes in other containers. For example, send <code>SIGHUP</code> to
<code>nginx</code> to restart the worker process. This requires the <code>SYS_PTRACE</code> capability.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># run this inside the &#34;shell&#34; container</span>
</span></span><span style=display:flex><span><span style=color:#a2f>kill</span> -HUP <span style=color:#666>8</span>   <span style=color:#080;font-style:italic># change &#34;8&#34; to match the PID of the nginx leader process, if necessary</span>
</span></span><span style=display:flex><span>ps ax
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>PID   USER     TIME  COMMAND
    1 root      0:00 /pause
    8 root      0:00 nginx: master process nginx -g daemon off;
   15 root      0:00 sh
   22 101       0:00 nginx: worker process
   23 root      0:00 ps ax
</code></pre><p>It's even possible to access the file system of another container using the
<code>/proc/$pid/root</code> link.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># run this inside the &#34;shell&#34; container</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># change &#34;8&#34; to the PID of the Nginx process, if necessary</span>
</span></span><span style=display:flex><span>head /proc/8/root/etc/nginx/nginx.conf
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
</code></pre><h2 id=understanding-process-namespace-sharing>Understanding process namespace sharing</h2><p>Pods share many resources so it makes sense they would also share a process
namespace. Some containers may expect to be isolated from others, though,
so it's important to understand the differences:</p><ol><li><p><strong>The container process no longer has PID 1.</strong> Some containers refuse
to start without PID 1 (for example, containers using <code>systemd</code>) or run
commands like <code>kill -HUP 1</code> to signal the container process. In pods with a
shared process namespace, <code>kill -HUP 1</code> will signal the pod sandbox
(<code>/pause</code> in the above example).</p></li><li><p><strong>Processes are visible to other containers in the pod.</strong> This includes all
information visible in <code>/proc</code>, such as passwords that were passed as arguments
or environment variables. These are protected only by regular Unix permissions.</p></li><li><p><strong>Container filesystems are visible to other containers in the pod through the
<code>/proc/$pid/root</code> link.</strong> This makes debugging easier, but it also means
that filesystem secrets are protected only by filesystem permissions.</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-18935633a984586fbb68b727f3f339bb>3.21 - Use a User Namespace With a Pod</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [alpha]</code></div><p>This page shows how to configure a user namespace for stateless pods. This
allows to isolate the user running inside the container from the one in the
host.</p><p>A process running as root in a container can run as a different (non-root) user
in the host; in other words, the process has full privileges for operations
inside the user namespace, but is unprivileged for operations outside the
namespace.</p><p>You can use this feature to reduce the damage a compromised container can do to
the host or other pods in the same node. There are <a href=https://github.com/kubernetes/enhancements/tree/217d790720c5aef09b8bd4d6ca96284a0affe6c2/keps/sig-node/127-user-namespaces#motivation>several security
vulnerabilities</a> rated either <strong>HIGH</strong> or <strong>CRITICAL</strong> that were not
exploitable when user namespaces is active. It is expected user namespace will
mitigate some future vulnerabilities too.</p><p>Without using a user namespace a container running as root, in the case of a
container breakout, has root privileges on the node. And if some capability were
granted to the container, the capabilities are valid on the host too. None of
this is true when user namespaces are used.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be version v1.25.
To check the version, enter <code>kubectl version</code>.</p><div class="alert alert-secondary callout third-party-content" role=alert>&#128711; This item links to a third party project or product that is not part of Kubernetes itself. <a class=alert-more-info href=#third-party-content-disclaimer>More information</a></div><ul><li>The node OS needs to be Linux</li><li>You need to exec commands in the host</li><li>You need to be able to exec into pods</li><li>Feature gate <code>UserNamespacesStatelessPodsSupport</code> need to be enabled.</li></ul><p>In addition, support is needed in the
<a class=glossary-tooltip title='The container runtime is the software that is responsible for running containers.' data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label='container runtime'>container runtime</a>
to use this feature with Kubernetes stateless pods:</p><ul><li>CRI-O: v1.25 has support for user namespaces.</li></ul><p>Please note that <strong>if your container runtime doesn't support user namespaces, the
new <code>pod.spec</code> field will be silently ignored and the pod will be created without
user namespaces.</strong></p><h2 id=create-pod>Run a Pod that uses a user namespace</h2><p>A user namespace for a stateless pod is enabled setting the <code>hostUsers</code> field of
<code>.spec</code> to <code>false</code>. For example:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/user-namespaces-stateless.yaml download=pods/user-namespaces-stateless.yaml><code>pods/user-namespaces-stateless.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-user-namespaces-stateless-yaml")' title="Copy pods/user-namespaces-stateless.yaml to clipboard"></img></div><div class=includecode id=pods-user-namespaces-stateless-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>userns<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostUsers</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>shell<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;sleep&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;infinity&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>debian<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create the pod on your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/user-namespaces-stateless.yaml
</span></span></code></pre></div></li><li><p>Attach to the container and run <code>readlink /proc/self/ns/user</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl attach -it userns bash
</span></span></code></pre></div></li></ol><p>And run the command. The output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>readlink /proc/self/ns/user
user:[4026531837]
cat /proc/self/uid_map
0          0 4294967295
</code></pre><p>Then, open a shell in the host and run the same command.</p><p>The output must be different. This means the host and the pod are using a
different user namespace. When user namespaces are not enabled, the host and the
pod use the same user namespace.</p><p>If you are running the kubelet inside a user namespace, you need to compare the
output from running the command in the pod to the output of running in the host:</p><pre tabindex=0><code class=language-none data-lang=none>readlink /proc/$pid/ns/user
user:[4026534732]
</code></pre><p>replacing <code>$pid</code> with the kubelet PID.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-42a59b878d4c58e5c6f4bb87483dda93>3.22 - Create static Pods</h1><p><em>Static Pods</em> are managed directly by the kubelet daemon on a specific node,
without the <a class=glossary-tooltip title='Control plane component that serves the Kubernetes API.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/components/#kube-apiserver target=_blank aria-label='API server'>API server</a>
observing them.
Unlike Pods that are managed by the control plane (for example, a
<a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployment>Deployment</a>);
instead, the kubelet watches each static Pod (and restarts it if it fails).</p><p>Static Pods are always bound to one <a class=glossary-tooltip title='An agent that runs on each node in the cluster. It makes sure that containers are running in a pod.' data-toggle=tooltip data-placement=top href=/docs/reference/generated/kubelet target=_blank aria-label=Kubelet>Kubelet</a> on a specific node.</p><p>The kubelet automatically tries to create a <a class=glossary-tooltip title='An object in the API server that tracks a static pod on a kubelet.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-mirror-pod' target=_blank aria-label='mirror Pod'>mirror Pod</a>
on the Kubernetes API server for each static Pod.
This means that the Pods running on a node are visible on the API server,
but cannot be controlled from there.
The Pod names will be suffixed with the node hostname with a leading hyphen.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you are running clustered Kubernetes and are using static
Pods to run a Pod on every node, you should probably be using a
<a class=glossary-tooltip title='Ensures a copy of a Pod is running across a set of nodes in a cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/daemonset target=_blank aria-label=DaemonSet>DaemonSet</a>
instead.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The <code>spec</code> of a static Pod cannot refer to other API objects
(e.g., <a class=glossary-tooltip title='Provides an identity for processes that run in a Pod.' data-toggle=tooltip data-placement=top href=/docs/tasks/configure-pod-container/configure-service-account/ target=_blank aria-label=ServiceAccount>ServiceAccount</a>,
<a class=glossary-tooltip title='An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a>,
<a class=glossary-tooltip title='Stores sensitive information, such as passwords, OAuth tokens, and ssh keys.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/secret/ target=_blank aria-label=Secret>Secret</a>, etc).</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Static pods do not support <a href=/docs/concepts/workloads/pods/ephemeral-containers/>ephemeral containers</a>.</div><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><p>This page assumes you're using <a class=glossary-tooltip title='A lightweight container runtime specifically for Kubernetes' data-toggle=tooltip data-placement=top href=https://cri-o.io/#what-is-cri-o target=_blank aria-label=CRI-O>CRI-O</a> to run Pods,
and that your nodes are running the Fedora operating system.
Instructions for other distributions or Kubernetes installations may vary.</p><h2 id=static-pod-creation>Create a static pod</h2><p>You can configure a static Pod with either a <a href=/docs/tasks/configure-pod-container/static-pod/#configuration-files>file system hosted configuration file</a> or a <a href=/docs/tasks/configure-pod-container/static-pod/#pods-created-via-http>web hosted configuration file</a>.</p><h3 id=configuration-files>Filesystem-hosted static Pod manifest</h3><p>Manifests are standard Pod definitions in JSON or YAML format in a specific directory. Use the <code>staticPodPath: &lt;the directory></code> field in the
<a href=/docs/reference/config-api/kubelet-config.v1beta1/>kubelet configuration file</a>,
which periodically scans the directory and creates/deletes static Pods as YAML/JSON files appear/disappear there.
Note that the kubelet will ignore files starting with dots when scanning the specified directory.</p><p>For example, this is how to start a simple web server as a static Pod:</p><ol><li><p>Choose a node where you want to run the static Pod. In this example, it's <code>my-node1</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh my-node1
</span></span></code></pre></div></li><li><p>Choose a directory, say <code>/etc/kubernetes/manifests</code> and place a web server Pod definition there, for example <code>/etc/kubernetes/manifests/static-web.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this command on the node where kubelet is running</span>
</span></span><span style=display:flex><span>mkdir -p /etc/kubernetes/manifests/
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;/etc/kubernetes/manifests/static-web.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Pod
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: static-web
</span></span></span><span style=display:flex><span><span style=color:#b44>  labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>    role: myrole
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>    - name: web
</span></span></span><span style=display:flex><span><span style=color:#b44>      image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>      ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>        - name: web
</span></span></span><span style=display:flex><span><span style=color:#b44>          containerPort: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>          protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div></li><li><p>Configure your kubelet on the node to use this directory by running it with <code>--pod-manifest-path=/etc/kubernetes/manifests/</code> argument. On Fedora edit <code>/etc/kubernetes/kubelet</code> to include this line:</p><pre tabindex=0><code>KUBELET_ARGS=&#34;--cluster-dns=10.254.0.10 --cluster-domain=kube.local --pod-manifest-path=/etc/kubernetes/manifests/&#34;
</code></pre><p>or add the <code>staticPodPath: &lt;the directory></code> field in the
<a href=/docs/reference/config-api/kubelet-config.v1beta1/>kubelet configuration file</a>.</p></li><li><p>Restart the kubelet. On Fedora, you would run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this command on the node where the kubelet is running</span>
</span></span><span style=display:flex><span>systemctl restart kubelet
</span></span></code></pre></div></li></ol><h3 id=pods-created-via-http>Web-hosted static pod manifest</h3><p>Kubelet periodically downloads a file specified by <code>--manifest-url=&lt;URL></code> argument
and interprets it as a JSON/YAML file that contains Pod definitions.
Similar to how <a href=#configuration-files>filesystem-hosted manifests</a> work, the kubelet
refetches the manifest on a schedule. If there are changes to the list of static
Pods, the kubelet applies them.</p><p>To use this approach:</p><ol><li><p>Create a YAML file and store it on a web server so that you can pass the URL of that file to the kubelet.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>static-web<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>role</span>:<span style=color:#bbb> </span>myrole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>web<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>web<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Configure the kubelet on your selected node to use this web manifest by running it with <code>--manifest-url=&lt;manifest-url></code>. On Fedora, edit <code>/etc/kubernetes/kubelet</code> to include this line:</p><pre tabindex=0><code>KUBELET_ARGS=&#34;--cluster-dns=10.254.0.10 --cluster-domain=kube.local --manifest-url=&lt;manifest-url&gt;&#34;
</code></pre></li><li><p>Restart the kubelet. On Fedora, you would run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this command on the node where the kubelet is running</span>
</span></span><span style=display:flex><span>systemctl restart kubelet
</span></span></code></pre></div></li></ol><h2 id=behavior-of-static-pods>Observe static pod behavior</h2><p>When the kubelet starts, it automatically starts all defined static Pods. As you have
defined a static Pod and restarted the kubelet, the new static Pod should
already be running.</p><p>You can view running containers (including static Pods) by running (on the node):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this command on the node where the kubelet is running</span>
</span></span><span style=display:flex><span>crictl ps
</span></span></code></pre></div><p>The output might be something like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>CONTAINER       IMAGE                                 CREATED           STATE      NAME    ATTEMPT    POD ID
</span></span></span><span style=display:flex><span><span style=color:#888>129fd7d382018   docker.io/library/nginx@sha256:...    11 minutes ago    Running    web     0          34533c6729106
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>crictl</code> outputs the image URI and SHA-256 checksum. <code>NAME</code> will look more like:
<code>docker.io/library/nginx@sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31</code>.</div><p>You can see the mirror Pod on the API server:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><pre tabindex=0><code>NAME         READY   STATUS    RESTARTS        AGE
static-web   1/1     Running   0               2m
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Make sure the kubelet has permission to create the mirror Pod in the API server. If not, the creation request is rejected by the API server.</div><p><a class=glossary-tooltip title='Tags objects with identifying attributes that are meaningful and relevant to users.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/labels target=_blank aria-label=Labels>Labels</a> from the static Pod are
propagated into the mirror Pod. You can use those labels as normal via
<a class=glossary-tooltip title='Allows users to filter a list of resources based on labels.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/labels/ target=_blank aria-label=selectors>selectors</a>, etc.</p><p>If you try to use <code>kubectl</code> to delete the mirror Pod from the API server,
the kubelet <em>doesn't</em> remove the static Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod static-web
</span></span></code></pre></div><pre tabindex=0><code>pod &#34;static-web&#34; deleted
</code></pre><p>You can see that the Pod is still running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><pre tabindex=0><code>NAME         READY   STATUS    RESTARTS   AGE
static-web   1/1     Running   0          4s
</code></pre><p>Back on your node where the kubelet is running, you can try to stop the container manually.
You'll see that, after a time, the kubelet will notice and will restart the Pod
automatically:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run these commands on the node where the kubelet is running</span>
</span></span><span style=display:flex><span>crictl stop 129fd7d382018 <span style=color:#080;font-style:italic># replace with the ID of your container</span>
</span></span><span style=display:flex><span>sleep <span style=color:#666>20</span>
</span></span><span style=display:flex><span>crictl ps
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>CONTAINER       IMAGE                                 CREATED           STATE      NAME    ATTEMPT    POD ID
</span></span></span><span style=display:flex><span><span style=color:#888>89db4553e1eeb   docker.io/library/nginx@sha256:...    19 seconds ago    Running    web     1          34533c6729106
</span></span></span></code></pre></div><h2 id=dynamic-addition-and-removal-of-static-pods>Dynamic addition and removal of static pods</h2><p>The running kubelet periodically scans the configured directory (<code>/etc/kubernetes/manifests</code> in our example) for changes and adds/removes Pods as files appear/disappear in this directory.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># This assumes you are using filesystem-hosted static Pod configuration</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Run these commands on the node where the kubelet is running</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#</span>
</span></span><span style=display:flex><span>mv /etc/kubernetes/manifests/static-web.yaml /tmp
</span></span><span style=display:flex><span>sleep <span style=color:#666>20</span>
</span></span><span style=display:flex><span>crictl ps
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># You see that no nginx container is running</span>
</span></span><span style=display:flex><span>mv /tmp/static-web.yaml  /etc/kubernetes/manifests/
</span></span><span style=display:flex><span>sleep <span style=color:#666>20</span>
</span></span><span style=display:flex><span>crictl ps
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>CONTAINER       IMAGE                                 CREATED           STATE      NAME    ATTEMPT    POD ID
</span></span></span><span style=display:flex><span><span style=color:#888>f427638871c35   docker.io/library/nginx@sha256:...    19 seconds ago    Running    web     1          34533c6729106
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1bb997c61a85de753d9994e7a312a291>3.23 - Translate a Docker Compose File to Kubernetes Resources</h1><p>What's Kompose? It's a conversion tool for all things compose (namely Docker Compose) to container orchestrators (Kubernetes or OpenShift).</p><p>More information can be found on the Kompose website at <a href=http://kompose.io>http://kompose.io</a>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=install-kompose>Install Kompose</h2><p>We have multiple ways to install Kompose. Our preferred method is downloading the binary from the latest GitHub release.</p><ul class="nav nav-tabs" id=install-ways role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#install-ways-0 role=tab aria-controls=install-ways-0 aria-selected=true>GitHub download</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#install-ways-1 role=tab aria-controls=install-ways-1>Build from source</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#install-ways-2 role=tab aria-controls=install-ways-2>CentOS package</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#install-ways-3 role=tab aria-controls=install-ways-3>Fedora package</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#install-ways-4 role=tab aria-controls=install-ways-4>Homebrew (macOS)</a></li></ul><div class=tab-content id=install-ways><div id=install-ways-0 class="tab-pane show active" role=tabpanel aria-labelledby=install-ways-0><p><p>Kompose is released via GitHub on a three-week cycle, you can see all current releases on the <a href=https://github.com/kubernetes/kompose/releases>GitHub release page</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># Linux</span>
</span></span><span style=display:flex><span>curl -L https://github.com/kubernetes/kompose/releases/download/v1.26.0/kompose-linux-amd64 -o kompose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># macOS</span>
</span></span><span style=display:flex><span>curl -L https://github.com/kubernetes/kompose/releases/download/v1.26.0/kompose-darwin-amd64 -o kompose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Windows</span>
</span></span><span style=display:flex><span>curl -L https://github.com/kubernetes/kompose/releases/download/v1.26.0/kompose-windows-amd64.exe -o kompose.exe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chmod +x kompose
</span></span><span style=display:flex><span>sudo mv ./kompose /usr/local/bin/kompose
</span></span></code></pre></div><p>Alternatively, you can download the <a href=https://github.com/kubernetes/kompose/releases>tarball</a>.</p></div><div id=install-ways-1 class=tab-pane role=tabpanel aria-labelledby=install-ways-1><p><p>Installing using <code>go get</code> pulls from the master branch with the latest development changes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>go get -u github.com/kubernetes/kompose
</span></span></code></pre></div></div><div id=install-ways-2 class=tab-pane role=tabpanel aria-labelledby=install-ways-2><p><p>Kompose is in <a href=https://fedoraproject.org/wiki/EPEL>EPEL</a> CentOS repository.
If you don't have <a href=https://fedoraproject.org/wiki/EPEL>EPEL</a> repository already installed and enabled you can do it by running <code>sudo yum install epel-release</code>.</p><p>If you have <a href=https://fedoraproject.org/wiki/EPEL>EPEL</a> enabled in your system, you can install Kompose like any other package.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum -y install kompose
</span></span></code></pre></div></div><div id=install-ways-3 class=tab-pane role=tabpanel aria-labelledby=install-ways-3><p><p>Kompose is in Fedora 24, 25 and 26 repositories. You can install it like any other package.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo dnf -y install kompose
</span></span></code></pre></div></div><div id=install-ways-4 class=tab-pane role=tabpanel aria-labelledby=install-ways-4><p><p>On macOS you can install the latest release via <a href=https://brew.sh>Homebrew</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install kompose
</span></span></code></pre></div></div></div><h2 id=use-kompose>Use Kompose</h2><p>In a few steps, we'll take you from Docker Compose to Kubernetes. All
you need is an existing <code>docker-compose.yml</code> file.</p><ol><li><p>Go to the directory containing your <code>docker-compose.yml</code> file. If you don't have one, test using this one.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>services</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>redis-master</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/redis:e2e<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;6379&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>redis-slave</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google_samples/gb-redisslave:v3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;6379&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>environment</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- GET_HOSTS_FROM=dns<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>frontend</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/gb-frontend:v4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;80:80&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>environment</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- GET_HOSTS_FROM=dns<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kompose.service.type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>To convert the <code>docker-compose.yml</code> file to files that you can use with
<code>kubectl</code>, run <code>kompose convert</code> and then <code>kubectl apply -f &lt;output file></code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kompose convert
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code class=language-none data-lang=none>INFO Kubernetes file &#34;frontend-service.yaml&#34; created
   INFO Kubernetes file &#34;frontend-service.yaml&#34; created
INFO Kubernetes file &#34;frontend-service.yaml&#34; created
INFO Kubernetes file &#34;redis-master-service.yaml&#34; created
   INFO Kubernetes file &#34;redis-master-service.yaml&#34; created
INFO Kubernetes file &#34;redis-master-service.yaml&#34; created
INFO Kubernetes file &#34;redis-slave-service.yaml&#34; created
   INFO Kubernetes file &#34;redis-slave-service.yaml&#34; created
INFO Kubernetes file &#34;redis-slave-service.yaml&#34; created
INFO Kubernetes file &#34;frontend-deployment.yaml&#34; created
   INFO Kubernetes file &#34;frontend-deployment.yaml&#34; created
INFO Kubernetes file &#34;frontend-deployment.yaml&#34; created
INFO Kubernetes file &#34;redis-master-deployment.yaml&#34; created
   INFO Kubernetes file &#34;redis-master-deployment.yaml&#34; created
INFO Kubernetes file &#34;redis-master-deployment.yaml&#34; created
INFO Kubernetes file &#34;redis-slave-deployment.yaml&#34; created
   INFO Kubernetes file &#34;redis-slave-deployment.yaml&#34; created
INFO Kubernetes file &#34;redis-slave-deployment.yaml&#34; created
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> kubectl apply -f frontend-service.yaml,redis-master-service.yaml,redis-slave-service.yaml,frontend-deployment.yaml,redis-master-deployment.yaml,redis-slave-deployment.yaml
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code class=language-none data-lang=none>service/frontend created
service/redis-master created
service/redis-slave created
deployment.apps/frontend created
deployment.apps/redis-master created
deployment.apps/redis-slave created
</code></pre><p>Your deployments are running in Kubernetes.</p></li><li><p>Access your application.</p><p>If you're already using <code>minikube</code> for your development process:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>minikube service frontend
</span></span></code></pre></div><p>Otherwise, let's look up what IP your service is using!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl describe svc frontend
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Name:                   frontend
Namespace:              default
Labels:                 service=frontend
Selector:               service=frontend
Type:                   LoadBalancer
IP:                     10.0.0.183
LoadBalancer Ingress:   192.0.2.89
Port:                   80      80/TCP
NodePort:               80      31144/TCP
Endpoints:              172.17.0.4:80
Session Affinity:       None
No events.
</code></pre><p>If you're using a cloud provider, your IP will be listed next to <code>LoadBalancer Ingress</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl http://192.0.2.89
</span></span></code></pre></div></li></ol><h2 id=user-guide>User Guide</h2><ul><li>CLI<ul><li><a href=#kompose-convert><code>kompose convert</code></a></li></ul></li><li>Documentation<ul><li><a href=#alternative-conversions>Alternative Conversions</a></li><li><a href=#labels>Labels</a></li><li><a href=#restart>Restart</a></li><li><a href=#docker-compose-versions>Docker Compose Versions</a></li></ul></li></ul><p>Kompose has support for two providers: OpenShift and Kubernetes.
You can choose a targeted provider using global option <code>--provider</code>. If no provider is specified, Kubernetes is set by default.</p><h2 id=kompose-convert><code>kompose convert</code></h2><p>Kompose supports conversion of V1, V2, and V3 Docker Compose files into Kubernetes and OpenShift objects.</p><h3 id=kubernetes-kompose-convert-example>Kubernetes <code>kompose convert</code> example</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kompose --file docker-voting.yml convert
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>WARN Unsupported key networks - ignoring
WARN Unsupported key build - ignoring
INFO Kubernetes file &#34;worker-svc.yaml&#34; created
INFO Kubernetes file &#34;db-svc.yaml&#34; created
INFO Kubernetes file &#34;redis-svc.yaml&#34; created
INFO Kubernetes file &#34;result-svc.yaml&#34; created
INFO Kubernetes file &#34;vote-svc.yaml&#34; created
INFO Kubernetes file &#34;redis-deployment.yaml&#34; created
INFO Kubernetes file &#34;result-deployment.yaml&#34; created
INFO Kubernetes file &#34;vote-deployment.yaml&#34; created
INFO Kubernetes file &#34;worker-deployment.yaml&#34; created
INFO Kubernetes file &#34;db-deployment.yaml&#34; created
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ls
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>db-deployment.yaml  docker-compose.yml         docker-gitlab.yml  redis-deployment.yaml  result-deployment.yaml  vote-deployment.yaml  worker-deployment.yaml
db-svc.yaml         docker-voting.yml          redis-svc.yaml     result-svc.yaml        vote-svc.yaml           worker-svc.yaml
</code></pre><p>You can also provide multiple docker-compose files at the same time:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kompose -f docker-compose.yml -f docker-guestbook.yml convert
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>INFO Kubernetes file &#34;frontend-service.yaml&#34; created         
INFO Kubernetes file &#34;mlbparks-service.yaml&#34; created         
INFO Kubernetes file &#34;mongodb-service.yaml&#34; created          
INFO Kubernetes file &#34;redis-master-service.yaml&#34; created     
INFO Kubernetes file &#34;redis-slave-service.yaml&#34; created      
INFO Kubernetes file &#34;frontend-deployment.yaml&#34; created      
INFO Kubernetes file &#34;mlbparks-deployment.yaml&#34; created      
INFO Kubernetes file &#34;mongodb-deployment.yaml&#34; created       
INFO Kubernetes file &#34;mongodb-claim0-persistentvolumeclaim.yaml&#34; created
INFO Kubernetes file &#34;redis-master-deployment.yaml&#34; created  
INFO Kubernetes file &#34;redis-slave-deployment.yaml&#34; created   
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ls
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>mlbparks-deployment.yaml  mongodb-service.yaml                       redis-slave-service.jsonmlbparks-service.yaml  
frontend-deployment.yaml  mongodb-claim0-persistentvolumeclaim.yaml  redis-master-service.yaml
frontend-service.yaml     mongodb-deployment.yaml                    redis-slave-deployment.yaml
redis-master-deployment.yaml
</code></pre><p>When multiple docker-compose files are provided the configuration is merged. Any configuration that is common will be overridden by subsequent file.</p><h3 id=openshift-kompose-convert-example>OpenShift <code>kompose convert</code> example</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kompose --provider openshift --file docker-voting.yml convert
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>WARN [worker] Service cannot be created because of missing port.
INFO OpenShift file &#34;vote-service.yaml&#34; created             
INFO OpenShift file &#34;db-service.yaml&#34; created               
INFO OpenShift file &#34;redis-service.yaml&#34; created            
INFO OpenShift file &#34;result-service.yaml&#34; created           
INFO OpenShift file &#34;vote-deploymentconfig.yaml&#34; created    
INFO OpenShift file &#34;vote-imagestream.yaml&#34; created         
INFO OpenShift file &#34;worker-deploymentconfig.yaml&#34; created  
INFO OpenShift file &#34;worker-imagestream.yaml&#34; created       
INFO OpenShift file &#34;db-deploymentconfig.yaml&#34; created      
INFO OpenShift file &#34;db-imagestream.yaml&#34; created           
INFO OpenShift file &#34;redis-deploymentconfig.yaml&#34; created   
INFO OpenShift file &#34;redis-imagestream.yaml&#34; created        
INFO OpenShift file &#34;result-deploymentconfig.yaml&#34; created  
INFO OpenShift file &#34;result-imagestream.yaml&#34; created  
</code></pre><p>It also supports creating buildconfig for build directive in a service. By default, it uses the remote repo for the current git branch as the source repo, and the current branch as the source branch for the build. You can specify a different source repo and branch using <code>--build-repo</code> and <code>--build-branch</code> options respectively.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kompose --provider openshift --file buildconfig/docker-compose.yml convert
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>WARN [foo] Service cannot be created because of missing port.
INFO OpenShift Buildconfig using git@github.com:rtnpro/kompose.git::master as source.
INFO OpenShift file &#34;foo-deploymentconfig.yaml&#34; created     
INFO OpenShift file &#34;foo-imagestream.yaml&#34; created          
INFO OpenShift file &#34;foo-buildconfig.yaml&#34; created
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you are manually pushing the OpenShift artifacts using <code>oc create -f</code>, you need to ensure that you push the imagestream artifact before the buildconfig artifact, to workaround this OpenShift issue: <a href=https://github.com/openshift/origin/issues/4518>https://github.com/openshift/origin/issues/4518</a> .</div><h2 id=alternative-conversions>Alternative Conversions</h2><p>The default <code>kompose</code> transformation will generate Kubernetes <a href=/docs/concepts/workloads/controllers/deployment/>Deployments</a> and <a href=/docs/concepts/services-networking/service/>Services</a>, in yaml format. You have alternative option to generate json with <code>-j</code>. Also, you can alternatively generate <a href=/docs/concepts/workloads/controllers/replicationcontroller/>Replication Controllers</a> objects, <a href=/docs/concepts/workloads/controllers/daemonset/>Daemon Sets</a>, or <a href=https://github.com/helm/helm>Helm</a> charts.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kompose convert -j
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;redis-svc.json&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;web-svc.json&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;redis-deployment.json&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;web-deployment.json&#34;</span> created
</span></span></code></pre></div><p>The <code>*-deployment.json</code> files contain the Deployment objects.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kompose convert --replication-controller
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;redis-svc.yaml&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;web-svc.yaml&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;redis-replicationcontroller.yaml&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;web-replicationcontroller.yaml&#34;</span> created
</span></span></code></pre></div><p>The <code>*-replicationcontroller.yaml</code> files contain the Replication Controller objects. If you want to specify replicas (default is 1), use <code>--replicas</code> flag: <code>kompose convert --replication-controller --replicas 3</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kompose convert --daemon-set
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;redis-svc.yaml&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;web-svc.yaml&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;redis-daemonset.yaml&#34;</span> created
</span></span><span style=display:flex><span>INFO Kubernetes file <span style=color:#b44>&#34;web-daemonset.yaml&#34;</span> created
</span></span></code></pre></div><p>The <code>*-daemonset.yaml</code> files contain the DaemonSet objects.</p><p>If you want to generate a Chart to be used with <a href=https://github.com/kubernetes/helm>Helm</a> run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kompose convert -c
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>INFO Kubernetes file &#34;web-svc.yaml&#34; created
INFO Kubernetes file &#34;redis-svc.yaml&#34; created
INFO Kubernetes file &#34;web-deployment.yaml&#34; created
INFO Kubernetes file &#34;redis-deployment.yaml&#34; created
chart created in &#34;./docker-compose/&#34;
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>tree docker-compose/
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>docker-compose
├── Chart.yaml
├── README.md
└── templates
    ├── redis-deployment.yaml
    ├── redis-svc.yaml
    ├── web-deployment.yaml
    └── web-svc.yaml
</code></pre><p>The chart structure is aimed at providing a skeleton for building your Helm charts.</p><h2 id=labels>Labels</h2><p><code>kompose</code> supports Kompose-specific labels within the <code>docker-compose.yml</code> file in order to explicitly define a service's behavior upon conversion.</p><ul><li><p><code>kompose.service.type</code> defines the type of service to be created.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>services</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nginx</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>dockerfile</span>:<span style=color:#bbb> </span>foobar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>build</span>:<span style=color:#bbb> </span>./foobar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cap_add</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- ALL<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>container_name</span>:<span style=color:#bbb> </span>foobar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kompose.service.type</span>:<span style=color:#bbb> </span>nodeport<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p><code>kompose.service.expose</code> defines if the service needs to be made accessible from outside the cluster or not. If the value is set to "true", the provider sets the endpoint automatically, and for any other value, the value is set as the hostname. If multiple ports are defined in a service, the first one is chosen to be the exposed.</p><ul><li>For the Kubernetes provider, an ingress resource is created and it is assumed that an ingress controller has already been configured.</li><li>For the OpenShift provider, a route is created.</li></ul><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>services</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>web</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>tuna/docker-counter23<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;5000:5000&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>links</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- redis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kompose.service.expose</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;counter.example.com&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>redis</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>redis:3.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;6379&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></li></ul><p>The currently supported options are:</p><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td>kompose.service.type</td><td>nodeport / clusterip / loadbalancer</td></tr><tr><td>kompose.service.expose</td><td>true / hostname</td></tr></tbody></table><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The <code>kompose.service.type</code> label should be defined with <code>ports</code> only, otherwise <code>kompose</code> will fail.</div><h2 id=restart>Restart</h2><p>If you want to create normal pods without controllers you can use <code>restart</code> construct of docker-compose to define that. Follow table below to see what happens on the <code>restart</code> value.</p><table><thead><tr><th><code>docker-compose</code> <code>restart</code></th><th>object created</th><th>Pod <code>restartPolicy</code></th></tr></thead><tbody><tr><td><code>""</code></td><td>controller object</td><td><code>Always</code></td></tr><tr><td><code>always</code></td><td>controller object</td><td><code>Always</code></td></tr><tr><td><code>on-failure</code></td><td>Pod</td><td><code>OnFailure</code></td></tr><tr><td><code>no</code></td><td>Pod</td><td><code>Never</code></td></tr></tbody></table><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The controller object could be <code>deployment</code> or <code>replicationcontroller</code>.</div><p>For example, the <code>pival</code> service will become pod down here. This container calculated value of <code>pi</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;2&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>services</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>pival</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>perl<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;perl&#34;</span>,<span style=color:#bbb>  </span><span style=color:#b44>&#34;-Mbignum=bpi&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-wle&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;print bpi(2000)&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>restart</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;on-failure&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=warning-about-deployment-configurations>Warning about Deployment Configurations</h3><p>If the Docker Compose file has a volume specified for a service, the Deployment (Kubernetes) or DeploymentConfig (OpenShift) strategy is changed to "Recreate" instead of "RollingUpdate" (default). This is done to avoid multiple instances of a service from accessing a volume at the same time.</p><p>If the Docker Compose file has service name with <code>_</code> in it (for example, <code>web_service</code>), then it will be replaced by <code>-</code> and the service name will be renamed accordingly (for example, <code>web-service</code>). Kompose does this because "Kubernetes" doesn't allow <code>_</code> in object name.</p><p>Please note that changing service name might break some <code>docker-compose</code> files.</p><h2 id=docker-compose-versions>Docker Compose Versions</h2><p>Kompose supports Docker Compose versions: 1, 2 and 3. We have limited support on versions 2.1 and 3.2 due to their experimental nature.</p><p>A full list on compatibility between all three versions is listed in our <a href=https://github.com/kubernetes/kompose/blob/master/docs/conversion.md>conversion document</a> including a list of all incompatible Docker Compose keys.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-108be708e50a97cae1cc0b67d5f360b7>3.24 - Enforce Pod Security Standards by Configuring the Built-in Admission Controller</h1><p>As of v1.22, Kubernetes provides a built-in <a href=/docs/reference/access-authn-authz/admission-controllers/#podsecurity>admission controller</a>
to enforce the <a href=/docs/concepts/security/pod-security-standards>Pod Security Standards</a>.
You can configure this admission controller to set cluster-wide defaults and <a href=/docs/concepts/security/pod-security-admission/#exemptions>exemptions</a>.</p><h2 id=before-you-begin>Before you begin</h2><p>Your Kubernetes server must be at or later than version v1.22.
To check the version, enter <code>kubectl version</code>.</p><ul><li>Ensure the <code>PodSecurity</code> <a href=/docs/reference/command-line-tools-reference/feature-gates/#feature-gates-for-alpha-or-beta-features>feature gate</a> is enabled.</li></ul><h2 id=configure-the-admission-controller>Configure the Admission Controller</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>AdmissionConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>plugins</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>PodSecurity<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>configuration</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>pod-security.admission.config.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PodSecurityConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Defaults applied when a mode label is not set.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic>#</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Level label values must be one of:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - &#34;privileged&#34; (default)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - &#34;baseline&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - &#34;restricted&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic>#</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Version label values must be one of:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - &#34;latest&#34; (default) </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - specific version like &#34;v1.25&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>defaults</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>enforce</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;privileged&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>enforce-version</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;latest&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>audit</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;privileged&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>audit-version</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;latest&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>warn</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;privileged&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>warn-version</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;latest&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>exemptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Array of authenticated usernames to exempt.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>usernames</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Array of runtime class names to exempt.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>runtimeClasses</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Array of namespaces to exempt.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>namespaces</span>:<span style=color:#bbb> </span>[]<span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>pod-security.admission.config.k8s.io/v1</code> configuration requires v1.25+.
For v1.23 and v1.24, use <a href=https://v1-24.docs.kubernetes.io/docs/tasks/configure-pod-container/enforce-standards-admission-controller/>v1beta1</a>.
For v1.22, use <a href=https://v1-22.docs.kubernetes.io/docs/tasks/configure-pod-container/enforce-standards-admission-controller/>v1alpha1</a>.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-9c9966a13899846a35113763603cd6db>3.25 - Enforce Pod Security Standards with Namespace Labels</h1><p>Namespaces can be labeled to enforce the <a href=/docs/concepts/security/pod-security-standards>Pod Security Standards</a>. The three policies
<a href=/docs/concepts/security/pod-security-standards/#privileged>privileged</a>, <a href=/docs/concepts/security/pod-security-standards/#baseline>baseline</a>
and <a href=/docs/concepts/security/pod-security-standards/#restricted>restricted</a> broadly cover the security spectrum
and are implemented by the <a href=/docs/concepts/security/pod-security-admission/>Pod Security</a> <a class=glossary-tooltip title='A piece of code that intercepts requests to the Kubernetes API server prior to persistence of the object.' data-toggle=tooltip data-placement=top href=/docs/reference/access-authn-authz/admission-controllers/ target=_blank aria-label='admission controller'>admission controller</a>.</p><h2 id=before-you-begin>Before you begin</h2><p>Your Kubernetes server must be at or later than version v1.22.
To check the version, enter <code>kubectl version</code>.</p><ul><li>Ensure the <code>PodSecurity</code> <a href=/docs/reference/command-line-tools-reference/feature-gates/#feature-gates-for-alpha-or-beta-features>feature gate</a> is enabled.</li></ul><h2 id=requiring-the-baseline-pod-security-standard-with-namespace-labels>Requiring the <code>baseline</code> Pod Security Standard with namespace labels</h2><p>This manifest defines a Namespace <code>my-baseline-namespace</code> that:</p><ul><li><em>Blocks</em> any pods that don't satisfy the <code>baseline</code> policy requirements.</li><li>Generates a user-facing warning and adds an audit annotation to any created pod that does not
meet the <code>restricted</code> policy requirements.</li><li>Pins the versions of the <code>baseline</code> and <code>restricted</code> policies to v1.25.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-baseline-namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pod-security.kubernetes.io/enforce</span>:<span style=color:#bbb> </span>baseline<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pod-security.kubernetes.io/enforce-version</span>:<span style=color:#bbb> </span>v1.25<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># We are setting these to our _desired_ `enforce` level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pod-security.kubernetes.io/audit</span>:<span style=color:#bbb> </span>restricted<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pod-security.kubernetes.io/audit-version</span>:<span style=color:#bbb> </span>v1.25<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pod-security.kubernetes.io/warn</span>:<span style=color:#bbb> </span>restricted<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pod-security.kubernetes.io/warn-version</span>:<span style=color:#bbb> </span>v1.25<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=add-labels-to-existing-namespaces-with-kubectl-label>Add labels to existing namespaces with <code>kubectl label</code></h2><div class="alert alert-info note callout" role=alert><strong>Note:</strong> When an <code>enforce</code> policy (or version) label is added or changed, the admission plugin will test
each pod in the namespace against the new policy. Violations are returned to the user as warnings.</div><p>It is helpful to apply the <code>--dry-run</code> flag when initially evaluating security profile changes for
namespaces. The Pod Security Standard checks will still be run in <em>dry run</em> mode, giving you
information about how the new policy would treat existing pods, without actually updating a policy.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label --dry-run<span style=color:#666>=</span>server --overwrite ns --all <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    pod-security.kubernetes.io/enforce<span style=color:#666>=</span>baseline
</span></span></code></pre></div><h3 id=applying-to-all-namespaces>Applying to all namespaces</h3><p>If you're just getting started with the Pod Security Standards, a suitable first step would be to
configure all namespaces with audit annotations for a stricter level such as <code>baseline</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label --overwrite ns --all <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  pod-security.kubernetes.io/audit<span style=color:#666>=</span>baseline <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  pod-security.kubernetes.io/warn<span style=color:#666>=</span>baseline
</span></span></code></pre></div><p>Note that this is not setting an enforce level, so that namespaces that haven't been explicitly
evaluated can be distinguished. You can list namespaces without an explicitly set enforce level
using this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get namespaces --selector<span style=color:#666>=</span><span style=color:#b44>&#39;!pod-security.kubernetes.io/enforce&#39;</span>
</span></span></code></pre></div><h3 id=applying-to-a-single-namespace>Applying to a single namespace</h3><p>You can update a specific namespace as well. This command adds the <code>enforce=restricted</code>
policy to <code>my-existing-namespace</code>, pinning the restricted policy version to v1.25.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label --overwrite ns my-existing-namespace <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  pod-security.kubernetes.io/enforce<span style=color:#666>=</span>restricted <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  pod-security.kubernetes.io/enforce-version<span style=color:#666>=</span>v1.25
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0a91fdc1445a8c7f3563c41a9b9b3370>3.26 - Migrate from PodSecurityPolicy to the Built-In PodSecurity Admission Controller</h1><p>This page describes the process of migrating from PodSecurityPolicies to the built-in PodSecurity
admission controller. This can be done effectively using a combination of dry-run and <code>audit</code> and
<code>warn</code> modes, although this becomes harder if mutating PSPs are used.</p><h2 id=before-you-begin>Before you begin</h2><p>Your Kubernetes server must be at or later than version v1.22.
To check the version, enter <code>kubectl version</code>.</p><p>If you are currently running a version of Kubernetes other than
{{ skew currentVersion }}, you may want to switch to viewing this
page in the documentation for the version of Kubernetes that you
are actually running.</p><p>This page assumes you are already familiar with the basic <a href=/docs/concepts/security/pod-security-admission/>Pod Security Admission</a>
concepts.</p><h2 id=overall-approach>Overall approach</h2><p>There are multiple strategies you can take for migrating from PodSecurityPolicy to Pod Security
Admission. The following steps are one possible migration path, with a goal of minimizing both the
risks of a production outage and of a security gap.</p><ol start=0><li>Decide whether Pod Security Admission is the right fit for your use case.</li><li>Review namespace permissions</li><li>Simplify & standardize PodSecurityPolicies</li><li>Update namespaces<ol><li>Identify an appropriate Pod Security level</li><li>Verify the Pod Security level</li><li>Enforce the Pod Security level</li><li>Bypass PodSecurityPolicy</li></ol></li><li>Review namespace creation processes</li><li>Disable PodSecurityPolicy</li></ol><h2 id=is-psa-right-for-you>0. Decide whether Pod Security Admission is right for you</h2><p>Pod Security Admission was designed to meet the most common security needs out of the box, and to
provide a standard set of security levels across clusters. However, it is less flexible than
PodSecurityPolicy. Notably, the following features are supported by PodSecurityPolicy but not Pod
Security Admission:</p><ul><li><strong>Setting default security constraints</strong> - Pod Security Admission is a non-mutating admission
controller, meaning it won't modify pods before validating them. If you were relying on this
aspect of PSP, you will need to either modify your workloads to meet the Pod Security constraints,
or use a <a href=/docs/reference/access-authn-authz/extensible-admission-controllers/>Mutating Admission Webhook</a>
to make those changes. See <a href=#simplify-psps>Simplify & Standardize PodSecurityPolicies</a> below for more detail.</li><li><strong>Fine-grained control over policy definition</strong> - Pod Security Admission only supports
<a href=/docs/concepts/security/pod-security-standards/>3 standard levels</a>.
If you require more control over specific constraints, then you will need to use a
<a href=/docs/reference/access-authn-authz/extensible-admission-controllers/>Validating Admission Webhook</a>
to enforce those policies.</li><li><strong>Sub-namespace policy granularity</strong> - PodSecurityPolicy lets you bind different policies to
different Service Accounts or users, even within a single namespace. This approach has many
pitfalls and is not recommended, but if you require this feature anyway you will
need to use a 3rd party webhook instead. The exception to this is if you only need to completely exempt
specific users or <a href=/docs/concepts/containers/runtime-class/>RuntimeClasses</a>, in which case Pod
Security Admission does expose some
<a href=/docs/concepts/security/pod-security-admission/#exemptions>static configuration for exemptions</a>.</li></ul><p>Even if Pod Security Admission does not meet all of your needs it was designed to be <em>complementary</em>
to other policy enforcement mechanisms, and can provide a useful fallback running alongside other
admission webhooks.</p><h2 id=review-namespace-permissions>1. Review namespace permissions</h2><p>Pod Security Admission is controlled by <a href=/docs/concepts/security/pod-security-admission/#pod-security-admission-labels-for-namespaces>labels on
namespaces</a>.
This means that anyone who can update (or patch or create) a namespace can also modify the Pod
Security level for that namespace, which could be used to bypass a more restrictive policy. Before
proceeding, ensure that only trusted, privileged users have these namespace permissions. It is not
recommended to grant these powerful permissions to users that shouldn't have elevated permissions,
but if you must you will need to use an
<a href=/docs/reference/access-authn-authz/extensible-admission-controllers/>admission webhook</a>
to place additional restrictions on setting Pod Security labels on Namespace objects.</p><h2 id=simplify-psps>2. Simplify & standardize PodSecurityPolicies</h2><p>In this section, you will reduce mutating PodSecurityPolicies and remove options that are outside
the scope of the Pod Security Standards. You should make the changes recommended here to an offline
copy of the original PodSecurityPolicy being modified. The cloned PSP should have a different
name that is alphabetically before the original (for example, prepend a <code>0</code> to it). Do not create the
new policies in Kubernetes yet - that will be covered in the <a href=#psp-update-rollout>Rollout the updated
policies</a> section below.</p><h3 id=eliminate-mutating-fields>2.a. Eliminate purely mutating fields</h3><p>If a PodSecurityPolicy is mutating pods, then you could end up with pods that don't meet the Pod
Security level requirements when you finally turn PodSecurityPolicy off. In order to avoid this, you
should eliminate all PSP mutation prior to switching over. Unfortunately PSP does not cleanly
separate mutating & validating fields, so this is not a straightforward migration.</p><p>You can start by eliminating the fields that are purely mutating, and don't have any bearing on the
validating policy. These fields (also listed in the
<a href=/docs/reference/access-authn-authz/psp-to-pod-security-standards/>Mapping PodSecurityPolicies to Pod Security Standards</a>
reference) are:</p><ul><li><code>.spec.defaultAllowPrivilegeEscalation</code></li><li><code>.spec.runtimeClass.defaultRuntimeClassName</code></li><li><code>.metadata.annotations['seccomp.security.alpha.kubernetes.io/defaultProfileName']</code></li><li><code>.metadata.annotations['apparmor.security.beta.kubernetes.io/defaultProfileName']</code></li><li><code>.spec.defaultAddCapabilities</code> - Although technically a mutating & validating field, these should
be merged into <code>.spec.allowedCapabilities</code> which performs the same validation without mutation.</li></ul><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Removing these could result in workloads missing required configuration, and cause problems. See
<a href=#psp-update-rollout>Rollout the updated policies</a> below for advice on how to roll these changes
out safely.</div><h3 id=eliminate-non-standard-options>2.b. Eliminate options not covered by the Pod Security Standards</h3><p>There are several fields in PodSecurityPolicy that are not covered by the Pod Security Standards. If
you must enforce these options, you will need to supplement Pod Security Admission with an
<a href=/docs/reference/access-authn-authz/extensible-admission-controllers/>admission webhook</a>,
which is outside the scope of this guide.</p><p>First, you can remove the purely validating fields that the Pod Security Standards do not cover.
These fields (also listed in the
<a href=/docs/reference/access-authn-authz/psp-to-pod-security-standards/>Mapping PodSecurityPolicies to Pod Security Standards</a>
reference with "no opinion") are:</p><ul><li><code>.spec.allowedHostPaths</code></li><li><code>.spec.allowedFlexVolumes</code></li><li><code>.spec.allowedCSIDrivers</code></li><li><code>.spec.forbiddenSysctls</code></li><li><code>.spec.runtimeClass</code></li></ul><p>You can also remove the following fields, that are related to POSIX / UNIX group controls.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> If any of these use the <code>MustRunAs</code> strategy they may be mutating! Removing these could result in
workloads not setting the required groups, and cause problems. See
<a href=#psp-update-rollout>Rollout the updated policies</a> below for advice on how to roll these changes
out safely.</div><ul><li><code>.spec.runAsGroup</code></li><li><code>.spec.supplementalGroups</code></li><li><code>.spec.fsGroup</code></li></ul><p>The remaining mutating fields are required to properly support the Pod Security Standards, and will
need to be handled on a case-by-case basis later:</p><ul><li><code>.spec.requiredDropCapabilities</code> - Required to drop <code>ALL</code> for the Restricted profile.</li><li><code>.spec.seLinux</code> - (Only mutating with the <code>MustRunAs</code> rule) required to enforce the SELinux
requirements of the Baseline & Restricted profiles.</li><li><code>.spec.runAsUser</code> - (Non-mutating with the <code>RunAsAny</code> rule) required to enforce <code>RunAsNonRoot</code> for
the Restricted profile.</li><li><code>.spec.allowPrivilegeEscalation</code> - (Only mutating if set to <code>false</code>) required for the Restricted
profile.</li></ul><h3 id=psp-update-rollout>2.c. Rollout the updated PSPs</h3><p>Next, you can rollout the updated policies to your cluster. You should proceed with caution, as
removing the mutating options may result in workloads missing required configuration.</p><p>For each updated PodSecurityPolicy:</p><ol><li>Identify pods running under the original PSP. This can be done using the <code>kubernetes.io/psp</code>
annotation. For example, using kubectl:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#b8860b>PSP_NAME</span><span style=color:#666>=</span><span style=color:#b44>&#34;original&#34;</span> <span style=color:#080;font-style:italic># Set the name of the PSP you&#39;re checking for</span>
</span></span><span style=display:flex><span>kubectl get pods --all-namespaces -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{range .items[?(@.metadata.annotations.kubernetes\.io\/psp==&#39;</span><span style=color:#b8860b>$PSP_NAME</span><span style=color:#b44>&#39;)]}{.metadata.namespace} {.metadata.name}{&#39;\n&#39;}{end}&#34;</span>
</span></span></code></pre></div></li><li>Compare these running pods against the original pod spec to determine whether PodSecurityPolicy
has modified the pod. For pods created by a <a href=/docs/concepts/workloads/controllers/>workload resource</a>
you can compare the pod with the PodTemplate in the controller resource. If any changes are
identified, the original Pod or PodTemplate should be updated with the desired configuration.
The fields to review are:<ul><li><code>.metadata.annotations['container.apparmor.security.beta.kubernetes.io/*']</code> (replace * with each container name)</li><li><code>.spec.runtimeClassName</code></li><li><code>.spec.securityContext.fsGroup</code></li><li><code>.spec.securityContext.seccompProfile</code></li><li><code>.spec.securityContext.seLinuxOptions</code></li><li><code>.spec.securityContext.supplementalGroups</code></li><li>On containers, under <code>.spec.containers[*]</code> and <code>.spec.initContainers[*]</code>:<ul><li><code>.securityContext.allowPrivilegeEscalation</code></li><li><code>.securityContext.capabilities.add</code></li><li><code>.securityContext.capabilities.drop</code></li><li><code>.securityContext.readOnlyRootFilesystem</code></li><li><code>.securityContext.runAsGroup</code></li><li><code>.securityContext.runAsNonRoot</code></li><li><code>.securityContext.runAsUser</code></li><li><code>.securityContext.seccompProfile</code></li><li><code>.securityContext.seLinuxOptions</code></li></ul></li></ul></li><li>Create the new PodSecurityPolicies. If any Roles or ClusterRoles are granting <code>use</code> on all PSPs
this could cause the new PSPs to be used instead of their mutating counter-parts.</li><li>Update your authorization to grant access to the new PSPs. In RBAC this means updating any Roles
or ClusterRoles that grant the <code>use</code> permision on the original PSP to also grant it to the
updated PSP.</li><li>Verify: after some soak time, rerun the command from step 1 to see if any pods are still using
the original PSPs. Note that pods need to be recreated after the new policies have been rolled
out before they can be fully verified.</li><li>(optional) Once you have verified that the original PSPs are no longer in use, you can delete
them.</li></ol><h2 id=update-namespaces>3. Update Namespaces</h2><p>The following steps will need to be performed on every namespace in the cluster. Commands referenced
in these steps use the <code>$NAMESPACE</code> variable to refer to the namespace being updated.</p><h3 id=identify-appropriate-level>3.a. Identify an appropriate Pod Security level</h3><p>Start reviewing the <a href=/docs/concepts/security/pod-security-standards/>Pod Security Standards</a> and
familiarizing yourself with the 3 different levels.</p><p>There are several ways to choose a Pod Security level for your namespace:</p><ol><li><strong>By security requirements for the namespace</strong> - If you are familiar with the expected access
level for the namespace, you can choose an appropriate level based on those requirements, similar
to how one might approach this on a new cluster.</li><li><strong>By existing PodSecurityPolicies</strong> - Using the
<a href=/docs/reference/access-authn-authz/psp-to-pod-security-standards/>Mapping PodSecurityPolicies to Pod Security Standards</a>
reference you can map each
PSP to a Pod Security Standard level. If your PSPs aren't based on the Pod Security Standards, you
may need to decide between choosing a level that is at least as permissive as the PSP, and a
level that is at least as restrictive. You can see which PSPs are in use for pods in a given
namespace with this command:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get pods -n <span style=color:#b8860b>$NAMESPACE</span> -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{.items[*].metadata.annotations.kubernetes\.io\/psp}&#34;</span> | tr <span style=color:#b44>&#34; &#34;</span> <span style=color:#b44>&#34;\n&#34;</span> | sort -u
</span></span></code></pre></div></li><li><strong>By existing pods</strong> - Using the strategies under <a href=#verify-pss-level>Verify the Pod Security level</a>,
you can test out both the Baseline and Restricted levels to see
whether they are sufficiently permissive for existing workloads, and chose the least-privileged
valid level.</li></ol><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Options 2 & 3 above are based on <em>existing</em> pods, and may miss workloads that aren't currently
running, such as CronJobs, scale-to-zero workloads, or other workloads that haven't rolled out.</div><h3 id=verify-pss-level>3.b. Verify the Pod Security level</h3><p>Once you have selected a Pod Security level for the namespace (or if you're trying several), it's a
good idea to test it out first (you can skip this step if using the Privileged level). Pod Security
includes several tools to help test and safely roll out profiles.</p><p>First, you can dry-run the policy, which will evaluate pods currently running in the namespace
against the applied policy, without making the new policy take effect:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># $LEVEL is the level to dry-run, either &#34;baseline&#34; or &#34;restricted&#34;.</span>
</span></span><span style=display:flex><span>kubectl label --dry-run<span style=color:#666>=</span>server --overwrite ns <span style=color:#b8860b>$NAMESPACE</span> pod-security.kubernetes.io/enforce<span style=color:#666>=</span><span style=color:#b8860b>$LEVEL</span>
</span></span></code></pre></div><p>This command will return a warning for any <em>existing</em> pods that are not valid under the proposed
level.</p><p>The second option is better for catching workloads that are not currently running: audit mode. When
running under audit-mode (as opposed to enforcing), pods that violate the policy level are recorded
in the audit logs, which can be reviewed later after some soak time, but are not forbidden. Warning
mode works similarly, but returns the warning to the user immediately. You can set the audit level
on a namespace with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl label --overwrite ns <span style=color:#b8860b>$NAMESPACE</span> pod-security.kubernetes.io/audit<span style=color:#666>=</span><span style=color:#b8860b>$LEVEL</span>
</span></span></code></pre></div><p>If either of these approaches yield unexpected violations, you will need to either update the
violating workloads to meet the policy requirements, or relax the namespace Pod Security level.</p><h3 id=enforce-pod-security-level>3.c. Enforce the Pod Security level</h3><p>When you are satisfied that the chosen level can safely be enforced on the namespace, you can update
the namespace to enforce the desired level:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl label --overwrite ns <span style=color:#b8860b>$NAMESPACE</span> pod-security.kubernetes.io/enforce<span style=color:#666>=</span><span style=color:#b8860b>$LEVEL</span>
</span></span></code></pre></div><h3 id=bypass-psp>3.d. Bypass PodSecurityPolicy</h3><p>Finally, you can effectively bypass PodSecurityPolicy at the namespace level by binding the fully
<a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/policy/privileged-psp.yaml download=policy/privileged-psp.yaml>privileged PSP</a>
to all service
accounts in the namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># The following cluster-scoped commands are only needed once.</span>
</span></span><span style=display:flex><span>kubectl apply -f privileged-psp.yaml
</span></span><span style=display:flex><span>kubectl create clusterrole privileged-psp --verb use --resource podsecuritypolicies.policy --resource-name privileged
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Per-namespace disable</span>
</span></span><span style=display:flex><span>kubectl create -n <span style=color:#b8860b>$NAMESPACE</span> rolebinding disable-psp --clusterrole privileged-psp --group system:serviceaccounts:<span style=color:#b8860b>$NAMESPACE</span>
</span></span></code></pre></div><p>Since the privileged PSP is non-mutating, and the PSP admission controller always
prefers non-mutating PSPs, this will ensure that pods in this namespace are no longer being modified
or restricted by PodSecurityPolicy.</p><p>The advantage to disabling PodSecurityPolicy on a per-namespace basis like this is if a problem
arises you can easily roll the change back by deleting the RoleBinding. Just make sure the
pre-existing PodSecurityPolicies are still in place!</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># Undo PodSecurityPolicy disablement.</span>
</span></span><span style=display:flex><span>kubectl delete -n <span style=color:#b8860b>$NAMESPACE</span> rolebinding disable-psp
</span></span></code></pre></div><h2 id=review-namespace-creation-process>4. Review namespace creation processes</h2><p>Now that existing namespaces have been updated to enforce Pod Security Admission, you should ensure
that your processes and/or policies for creating new namespaces are updated to ensure that an
appropriate Pod Security profile is applied to new namespaces.</p><p>You can also statically configure the Pod Security admission controller to set a default enforce,
audit, and/or warn level for unlabeled namespaces. See
<a href=/docs/tasks/configure-pod-container/enforce-standards-admission-controller/#configure-the-admission-controller>Configure the Admission Controller</a>
for more information.</p><h2 id=disable-psp>5. Disable PodSecurityPolicy</h2><p>Finally, you're ready to disable PodSecurityPolicy. To do so, you will need to modify the admission
configuration of the API server:
<a href=/docs/reference/access-authn-authz/admission-controllers/#how-do-i-turn-off-an-admission-controller>How do I turn off an admission controller?</a>.</p><p>To verify that the PodSecurityPolicy admission controller is no longer enabled, you can manually run
a test by impersonating a user without access to any PodSecurityPolicies (see the
<a href=/docs/concepts/security/pod-security-policy/#example>PodSecurityPolicy example</a>), or by verifying in
the API server logs. At startup, the API server outputs log lines listing the loaded admission
controller plugins:</p><pre tabindex=0><code>I0218 00:59:44.903329      13 plugins.go:158] Loaded 16 mutating admission controller(s) successfully in the following order: NamespaceLifecycle,LimitRanger,ServiceAccount,NodeRestriction,TaintNodesByCondition,Priority,DefaultTolerationSeconds,ExtendedResourceToleration,PersistentVolumeLabel,DefaultStorageClass,StorageObjectInUseProtection,RuntimeClass,DefaultIngressClass,MutatingAdmissionWebhook.
I0218 00:59:44.903350      13 plugins.go:161] Loaded 14 validating admission controller(s) successfully in the following order: LimitRanger,ServiceAccount,PodSecurity,Priority,PersistentVolumeClaimResize,RuntimeClass,CertificateApproval,CertificateSigning,CertificateSubjectRestriction,DenyServiceExternalIPs,ValidatingAdmissionWebhook,ResourceQuota.
</code></pre><p>You should see <code>PodSecurity</code> (in the validating admission controllers), and neither list should
contain <code>PodSecurityPolicy</code>.</p><p>Once you are certain the PSP admission controller is disabled (and after sufficient soak time to be
confident you won't need to roll back), you are free to delete your PodSecurityPolicies and any
associated Roles, ClusterRoles, RoleBindings and ClusterRoleBindings (just make sure they don't
grant any other unrelated permissions).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-61e6bd39c782b924943d60fc8387afe4>4 - Monitoring, Logging, and Debugging</h1><div class=lead>Set up monitoring and logging to troubleshoot a cluster, or debug a containerized application.</div><p>Sometimes things go wrong. This guide is aimed at making them right. It has
two sections:</p><ul><li><a href=/docs/tasks/debug/debug-application/>Debugging your application</a> - Useful
for users who are deploying code into Kubernetes and wondering why it is not working.</li><li><a href=/docs/tasks/debug/debug-cluster/>Debugging your cluster</a> - Useful
for cluster administrators and people whose Kubernetes cluster is unhappy.</li></ul><p>You should also check the known issues for the <a href=https://github.com/kubernetes/kubernetes/releases>release</a>
you're using.</p><h2 id=getting-help>Getting help</h2><p>If your problem isn't answered by any of the guides above, there are variety of
ways for you to get help from the Kubernetes community.</p><h3 id=questions>Questions</h3><p>The documentation on this site has been structured to provide answers to a wide
range of questions. <a href=/docs/concepts/>Concepts</a> explain the Kubernetes
architecture and how each component works, while <a href=/docs/setup/>Setup</a> provides
practical instructions for getting started. <a href=/docs/tasks/>Tasks</a> show how to
accomplish commonly used tasks, and <a href=/docs/tutorials/>Tutorials</a> are more
comprehensive walkthroughs of real-world, industry-specific, or end-to-end
development scenarios. The <a href=/docs/reference/>Reference</a> section provides
detailed documentation on the <a href=/docs/reference/generated/kubernetes-api/v1.25/>Kubernetes API</a>
and command-line interfaces (CLIs), such as <a href=/docs/reference/kubectl/><code>kubectl</code></a>.</p><h2 id=help-my-question-isn-t-covered-i-need-help-now>Help! My question isn't covered! I need help now!</h2><h3 id=stack-overflow>Stack Overflow</h3><p>Someone else from the community may have already asked a similar question or may
be able to help with your problem. The Kubernetes team will also monitor
<a href=https://stackoverflow.com/questions/tagged/kubernetes>posts tagged Kubernetes</a>.
If there aren't any existing questions that help, <strong>please <a href=https://stackoverflow.com/help/on-topic>ensure that your question is on-topic on Stack Overflow</a>
and that you read through the guidance on <a href=https://stackoverflow.com/help/how-to-ask>how to ask a new question</a></strong>,
before <a href="https://stackoverflow.com/questions/ask?tags=kubernetes">asking a new one</a>!</p><h3 id=slack>Slack</h3><p>Many people from the Kubernetes community hang out on Kubernetes Slack in the <code>#kubernetes-users</code> channel.
Slack requires registration; you can <a href=https://slack.kubernetes.io>request an invitation</a>,
and registration is open to everyone). Feel free to come and ask any and all questions.
Once registered, access the <a href=https://kubernetes.slack.com>Kubernetes organisation in Slack</a>
via your web browser or via Slack's own dedicated app.</p><p>Once you are registered, browse the growing list of channels for various subjects of
interest. For example, people new to Kubernetes may also want to join the
<a href=https://kubernetes.slack.com/messages/kubernetes-novice><code>#kubernetes-novice</code></a> channel. As another example, developers should join the
<a href=https://kubernetes.slack.com/messages/kubernetes-dev><code>#kubernetes-dev</code></a> channel.</p><p>There are also many country specific / local language channels. Feel free to join
these channels for localized support and info:</p><table><caption style=display:none>Country / language specific Slack channels</caption><thead><tr><th style=text-align:left>Country</th><th style=text-align:left>Channels</th></tr></thead><tbody><tr><td style=text-align:left>China</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/cn-users><code>#cn-users</code></a>, <a href=https://kubernetes.slack.com/messages/cn-events><code>#cn-events</code></a></td></tr><tr><td style=text-align:left>Finland</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/fi-users><code>#fi-users</code></a></td></tr><tr><td style=text-align:left>France</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/fr-users><code>#fr-users</code></a>, <a href=https://kubernetes.slack.com/messages/fr-events><code>#fr-events</code></a></td></tr><tr><td style=text-align:left>Germany</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/de-users><code>#de-users</code></a>, <a href=https://kubernetes.slack.com/messages/de-events><code>#de-events</code></a></td></tr><tr><td style=text-align:left>India</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/in-users><code>#in-users</code></a>, <a href=https://kubernetes.slack.com/messages/in-events><code>#in-events</code></a></td></tr><tr><td style=text-align:left>Italy</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/it-users><code>#it-users</code></a>, <a href=https://kubernetes.slack.com/messages/it-events><code>#it-events</code></a></td></tr><tr><td style=text-align:left>Japan</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/jp-users><code>#jp-users</code></a>, <a href=https://kubernetes.slack.com/messages/jp-events><code>#jp-events</code></a></td></tr><tr><td style=text-align:left>Korea</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/kr-users><code>#kr-users</code></a></td></tr><tr><td style=text-align:left>Netherlands</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/nl-users><code>#nl-users</code></a></td></tr><tr><td style=text-align:left>Norway</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/norw-users><code>#norw-users</code></a></td></tr><tr><td style=text-align:left>Poland</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/pl-users><code>#pl-users</code></a></td></tr><tr><td style=text-align:left>Russia</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/ru-users><code>#ru-users</code></a></td></tr><tr><td style=text-align:left>Spain</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/es-users><code>#es-users</code></a></td></tr><tr><td style=text-align:left>Sweden</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/se-users><code>#se-users</code></a></td></tr><tr><td style=text-align:left>Turkey</td><td style=text-align:left><a href=https://kubernetes.slack.com/messages/tr-users><code>#tr-users</code></a>, <a href=https://kubernetes.slack.com/messages/tr-events><code>#tr-events</code></a></td></tr></tbody></table><h3 id=forum>Forum</h3><p>You're welcome to join the official Kubernetes Forum: <a href=https://discuss.kubernetes.io>discuss.kubernetes.io</a>.</p><h3 id=bugs-and-feature-requests>Bugs and feature requests</h3><p>If you have what looks like a bug, or you would like to make a feature request,
please use the <a href=https://github.com/kubernetes/kubernetes/issues>GitHub issue tracking system</a>.</p><p>Before you file an issue, please search existing issues to see if your issue is
already covered.</p><p>If filing a bug, please include detailed information about how to reproduce the
problem, such as:</p><ul><li>Kubernetes version: <code>kubectl version</code></li><li>Cloud provider, OS distro, network configuration, and container runtime version</li><li>Steps to reproduce the problem</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4a26f4e7f9ffe4b86dea8b77906d3d5c>4.1 - Troubleshooting Applications</h1><div class=lead>Debugging common containerized application issues.</div><p>This doc contains a set of resources for fixing issues with containerized applications. It covers things like common issues with Kubernetes resources (like Pods, Services, or StatefulSets), advice on making sense of container termination messages, and ways to debug running containers.</p></div><div class=td-content><h1 id=pg-abb72792fa997869a6d241ca28ea225e>4.1.1 - Debug Pods</h1><p>This guide is to help users debug applications that are deployed into Kubernetes and not behaving correctly.
This is <em>not</em> a guide for people who want to debug their cluster. For that you should check out
<a href=/docs/tasks/debug/debug-cluster>this guide</a>.</p><h2 id=diagnosing-the-problem>Diagnosing the problem</h2><p>The first step in troubleshooting is triage. What is the problem? Is it your Pods, your Replication Controller or
your Service?</p><ul><li><a href=#debugging-pods>Debugging Pods</a></li><li><a href=#debugging-replication-controllers>Debugging Replication Controllers</a></li><li><a href=#debugging-services>Debugging Services</a></li></ul><h3 id=debugging-pods>Debugging Pods</h3><p>The first step in debugging a Pod is taking a look at it. Check the current state of the Pod and recent events with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pods <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>POD_NAME</span><span style=color:#b68;font-weight:700>}</span>
</span></span></code></pre></div><p>Look at the state of the containers in the pod. Are they all <code>Running</code>? Have there been recent restarts?</p><p>Continue debugging depending on the state of the pods.</p><h4 id=my-pod-stays-pending>My pod stays pending</h4><p>If a Pod is stuck in <code>Pending</code> it means that it can not be scheduled onto a node. Generally this is because
there are insufficient resources of one type or another that prevent scheduling. Look at the output of the
<code>kubectl describe ...</code> command above. There should be messages from the scheduler about why it can not schedule
your pod. Reasons include:</p><ul><li><p><strong>You don't have enough resources</strong>: You may have exhausted the supply of CPU or Memory in your cluster, in this case
you need to delete Pods, adjust resource requests, or add new nodes to your cluster. See
<a href=/docs/concepts/configuration/manage-resources-containers/>Compute Resources document</a> for more information.</p></li><li><p><strong>You are using <code>hostPort</code></strong>: When you bind a Pod to a <code>hostPort</code> there are a limited number of places that pod can be
scheduled. In most cases, <code>hostPort</code> is unnecessary, try using a Service object to expose your Pod. If you do require
<code>hostPort</code> then you can only schedule as many Pods as there are nodes in your Kubernetes cluster.</p></li></ul><h4 id=my-pod-stays-waiting>My pod stays waiting</h4><p>If a Pod is stuck in the <code>Waiting</code> state, then it has been scheduled to a worker node, but it can't run on that machine.
Again, the information from <code>kubectl describe ...</code> should be informative. The most common cause of <code>Waiting</code> pods is a failure to pull the image. There are three things to check:</p><ul><li>Make sure that you have the name of the image correct.</li><li>Have you pushed the image to the registry?</li><li>Try to manually pull the image to see if the image can be pulled. For example,
if you use Docker on your PC, run <code>docker pull &lt;image></code>.</li></ul><h4 id=my-pod-is-crashing-or-otherwise-unhealthy>My pod is crashing or otherwise unhealthy</h4><p>Once your pod has been scheduled, the methods described in <a href=/docs/tasks/debug/debug-application/debug-running-pod/>Debug Running Pods</a> are available for debugging.</p><h4 id=my-pod-is-running-but-not-doing-what-i-told-it-to-do>My pod is running but not doing what I told it to do</h4><p>If your pod is not behaving as you expected, it may be that there was an error in your
pod description (e.g. <code>mypod.yaml</code> file on your local machine), and that the error
was silently ignored when you created the pod. Often a section of the pod description
is nested incorrectly, or a key name is typed incorrectly, and so the key is ignored.
For example, if you misspelled <code>command</code> as <code>commnd</code> then the pod will be created but
will not use the command line you intended it to use.</p><p>The first thing to do is to delete your pod and try creating it again with the <code>--validate</code> option.
For example, run <code>kubectl apply --validate -f mypod.yaml</code>.
If you misspelled <code>command</code> as <code>commnd</code> then will give an error like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>I0805 10:43:25.129850   <span style=color:#666>46757</span> schema.go:126<span style=color:#666>]</span> unknown field: commnd
</span></span><span style=display:flex><span>I0805 10:43:25.129973   <span style=color:#666>46757</span> schema.go:129<span style=color:#666>]</span> this may be a <span style=color:#a2f>false</span> alarm, see https://github.com/kubernetes/kubernetes/issues/6842
</span></span><span style=display:flex><span>pods/mypod
</span></span></code></pre></div><p>The next thing to check is whether the pod on the apiserver
matches the pod you meant to create (e.g. in a yaml file on your local machine).
For example, run <code>kubectl get pods/mypod -o yaml > mypod-on-apiserver.yaml</code> and then
manually compare the original pod description, <code>mypod.yaml</code> with the one you got
back from apiserver, <code>mypod-on-apiserver.yaml</code>. There will typically be some
lines on the "apiserver" version that are not on the original version. This is
expected. However, if there are lines on the original that are not on the apiserver
version, then this may indicate a problem with your pod spec.</p><h3 id=debugging-replication-controllers>Debugging Replication Controllers</h3><p>Replication controllers are fairly straightforward. They can either create Pods or they can't. If they can't
create pods, then please refer to the <a href=#debugging-pods>instructions above</a> to debug your pods.</p><p>You can also use <code>kubectl describe rc ${CONTROLLER_NAME}</code> to introspect events related to the replication
controller.</p><h3 id=debugging-services>Debugging Services</h3><p>Services provide load balancing across a set of pods. There are several common problems that can make Services
not work properly. The following instructions should help debug Service problems.</p><p>First, verify that there are endpoints for the service. For every Service object, the apiserver makes an <code>endpoints</code> resource available.</p><p>You can view this resource with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get endpoints <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICE_NAME</span><span style=color:#b68;font-weight:700>}</span>
</span></span></code></pre></div><p>Make sure that the endpoints match up with the number of pods that you expect to be members of your service.
For example, if your Service is for an nginx container with 3 replicas, you would expect to see three different
IP addresses in the Service's endpoints.</p><h4 id=my-service-is-missing-endpoints>My service is missing endpoints</h4><p>If you are missing endpoints, try listing pods using the labels that Service uses. Imagine that you have
a Service where the labels are:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span></code></pre></div><p>You can use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --selector<span style=color:#666>=</span><span style=color:#b8860b>name</span><span style=color:#666>=</span>nginx,type<span style=color:#666>=</span>frontend
</span></span></code></pre></div><p>to list pods that match this selector. Verify that the list matches the Pods that you expect to provide your Service.
Verify that the pod's <code>containerPort</code> matches up with the Service's <code>targetPort</code></p><h4 id=network-traffic-is-not-forwarded>Network traffic is not forwarded</h4><p>Please see <a href=/docs/tasks/debug/debug-application/debug-service/>debugging service</a> for more information.</p><h2 id=what-s-next>What's next</h2><p>If none of the above solves your problem, follow the instructions in
<a href=/docs/tasks/debug/debug-application/debug-service/>Debugging Service document</a>
to make sure that your <code>Service</code> is running, has <code>Endpoints</code>, and your <code>Pods</code> are
actually serving; you have DNS working, iptables rules installed, and kube-proxy
does not seem to be misbehaving.</p><p>You may also visit <a href=/docs/tasks/debug/>troubleshooting document</a> for more information.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-68c4fd0542b7d39f8d36435ef83bd57b>4.1.2 - Debug Services</h1><p>An issue that comes up rather frequently for new installations of Kubernetes is
that a Service is not working properly. You've run your Pods through a
Deployment (or other workload controller) and created a Service, but you
get no response when you try to access it. This document will hopefully help
you to figure out what's going wrong.</p><h2 id=running-commands-in-a-pod>Running commands in a Pod</h2><p>For many steps here you will want to see what a Pod running in the cluster
sees. The simplest way to do this is to run an interactive busybox Pod:</p><pre tabindex=0><code class=language-none data-lang=none>kubectl run -it --rm --restart=Never busybox --image=gcr.io/google-containers/busybox sh
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you don't see a command prompt, try pressing enter.</div><p>If you already have a running Pod that you prefer to use, you can run a
command in it using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> &lt;POD-NAME&gt; -c &lt;CONTAINER-NAME&gt; -- &lt;COMMAND&gt;
</span></span></code></pre></div><h2 id=setup>Setup</h2><p>For the purposes of this walk-through, let's run some Pods. Since you're
probably debugging your own Service you can substitute your own details, or you
can follow along and get a second data point.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create deployment hostnames --image<span style=color:#666>=</span>registry.k8s.io/serve_hostname
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>deployment.apps/hostnames created
</code></pre><p><code>kubectl</code> commands will print the type and name of the resource created or mutated, which can then be used in subsequent commands.</p><p>Let's scale the deployment to 3 replicas.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl scale deployment hostnames --replicas<span style=color:#666>=</span><span style=color:#666>3</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>deployment.apps/hostnames scaled
</code></pre><p>Note that this is the same as if you had started the Deployment with the following
YAML:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hostnames<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hostnames<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hostnames<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hostnames<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hostnames<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/serve_hostname<span style=color:#bbb>
</span></span></span></code></pre></div><p>The label "app" is automatically set by <code>kubectl create deployment</code> to the name of the
Deployment.</p><p>You can confirm your Pods are running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>hostnames
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME                        READY     STATUS    RESTARTS   AGE
hostnames-632524106-bbpiw   1/1       Running   0          2m
hostnames-632524106-ly40y   1/1       Running   0          2m
hostnames-632524106-tlaok   1/1       Running   0          2m
</code></pre><p>You can also confirm that your Pods are serving. You can get the list of
Pod IP addresses and test them directly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>hostnames <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -o go-template<span style=color:#666>=</span><span style=color:#b44>&#39;{{range .items}}{{.status.podIP}}{{&#34;\n&#34;}}{{end}}&#39;</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>10.244.0.5
10.244.0.6
10.244.0.7
</code></pre><p>The example container used for this walk-through serves its own hostname
via HTTP on port 9376, but if you are debugging your own app, you'll want to
use whatever port number your Pods are listening on.</p><p>From within a pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> ep in 10.244.0.5:9376 10.244.0.6:9376 10.244.0.7:9376; <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>    wget -qO- <span style=color:#b8860b>$ep</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>This should produce something like:</p><pre tabindex=0><code>hostnames-632524106-bbpiw
hostnames-632524106-ly40y
hostnames-632524106-tlaok
</code></pre><p>If you are not getting the responses you expect at this point, your Pods
might not be healthy or might not be listening on the port you think they are.
You might find <code>kubectl logs</code> to be useful for seeing what is happening, or
perhaps you need to <code>kubectl exec</code> directly into your Pods and debug from
there.</p><p>Assuming everything has gone to plan so far, you can start to investigate why
your Service doesn't work.</p><h2 id=does-the-service-exist>Does the Service exist?</h2><p>The astute reader will have noticed that you did not actually create a Service
yet - that is intentional. This is a step that sometimes gets forgotten, and
is the first thing to check.</p><p>What would happen if you tried to access a non-existent Service? If
you have another Pod that consumes this Service by name you would get
something like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget -O- hostnames
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Resolving hostnames (hostnames)... failed: Name or service not known.
wget: unable to resolve host address &#39;hostnames&#39;
</code></pre><p>The first thing to check is whether that Service actually exists:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc hostnames
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>No resources found.
Error from server (NotFound): services &#34;hostnames&#34; not found
</code></pre><p>Let's create the Service. As before, this is for the walk-through - you can
use your own Service's details here.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl expose deployment hostnames --port<span style=color:#666>=</span><span style=color:#666>80</span> --target-port<span style=color:#666>=</span><span style=color:#666>9376</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>service/hostnames exposed
</code></pre><p>And read it back:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc hostnames
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
hostnames   ClusterIP   10.0.1.175   &lt;none&gt;        80/TCP    5s
</code></pre><p>Now you know that the Service exists.</p><p>As before, this is the same as if you had started the Service with YAML:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hostnames<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hostnames<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hostnames<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>9376</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>In order to highlight the full range of configuration, the Service you created
here uses a different port number than the Pods. For many real-world
Services, these values might be the same.</p><h2 id=any-network-policy-ingress-rules-affecting-the-target-pods>Any Network Policy Ingress rules affecting the target Pods?</h2><p>If you have deployed any Network Policy Ingress rules which may affect incoming
traffic to <code>hostnames-*</code> Pods, these need to be reviewed.</p><p>Please refer to <a href=/docs/concepts/services-networking/network-policies/>Network Policies</a> for more details.</p><h2 id=does-the-service-work-by-dns-name>Does the Service work by DNS name?</h2><p>One of the most common ways that clients consume a Service is through a DNS
name.</p><p>From a Pod in the same Namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nslookup hostnames
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      hostnames
Address 1: 10.0.1.175 hostnames.default.svc.cluster.local
</code></pre><p>If this fails, perhaps your Pod and Service are in different
Namespaces, try a namespace-qualified name (again, from within a Pod):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nslookup hostnames.default
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      hostnames.default
Address 1: 10.0.1.175 hostnames.default.svc.cluster.local
</code></pre><p>If this works, you'll need to adjust your app to use a cross-namespace name, or
run your app and Service in the same Namespace. If this still fails, try a
fully-qualified name:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nslookup hostnames.default.svc.cluster.local
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      hostnames.default.svc.cluster.local
Address 1: 10.0.1.175 hostnames.default.svc.cluster.local
</code></pre><p>Note the suffix here: "default.svc.cluster.local". The "default" is the
Namespace you're operating in. The "svc" denotes that this is a Service.
The "cluster.local" is your cluster domain, which COULD be different in your
own cluster.</p><p>You can also try this from a Node in the cluster:</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> 10.0.0.10 is the cluster's DNS Service IP, yours might be different.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nslookup hostnames.default.svc.cluster.local 10.0.0.10
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Server:         10.0.0.10
Address:        10.0.0.10#53

Name:   hostnames.default.svc.cluster.local
Address: 10.0.1.175
</code></pre><p>If you are able to do a fully-qualified name lookup but not a relative one, you
need to check that your <code>/etc/resolv.conf</code> file in your Pod is correct. From
within a Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat /etc/resolv.conf
</span></span></code></pre></div><p>You should see something like:</p><pre tabindex=0><code>nameserver 10.0.0.10
search default.svc.cluster.local svc.cluster.local cluster.local example.com
options ndots:5
</code></pre><p>The <code>nameserver</code> line must indicate your cluster's DNS Service. This is
passed into <code>kubelet</code> with the <code>--cluster-dns</code> flag.</p><p>The <code>search</code> line must include an appropriate suffix for you to find the
Service name. In this case it is looking for Services in the local
Namespace ("default.svc.cluster.local"), Services in all Namespaces
("svc.cluster.local"), and lastly for names in the cluster ("cluster.local").
Depending on your own install you might have additional records after that (up
to 6 total). The cluster suffix is passed into <code>kubelet</code> with the
<code>--cluster-domain</code> flag. Throughout this document, the cluster suffix is
assumed to be "cluster.local". Your own clusters might be configured
differently, in which case you should change that in all of the previous
commands.</p><p>The <code>options</code> line must set <code>ndots</code> high enough that your DNS client library
considers search paths at all. Kubernetes sets this to 5 by default, which is
high enough to cover all of the DNS names it generates.</p><h3 id=does-any-service-exist-in-dns>Does any Service work by DNS name?</h3><p>If the above still fails, DNS lookups are not working for your Service. You
can take a step back and see what else is not working. The Kubernetes master
Service should always work. From within a Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nslookup kubernetes.default
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes.default
Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local
</code></pre><p>If this fails, please see the <a href=#is-the-kube-proxy-working>kube-proxy</a> section
of this document, or even go back to the top of this document and start over,
but instead of debugging your own Service, debug the DNS Service.</p><h2 id=does-the-service-work-by-ip>Does the Service work by IP?</h2><p>Assuming you have confirmed that DNS works, the next thing to test is whether your
Service works by its IP address. From a Pod in your cluster, access the
Service's IP (from <code>kubectl get</code> above).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> i in <span style=color:#a2f;font-weight:700>$(</span>seq <span style=color:#666>1</span> 3<span style=color:#a2f;font-weight:700>)</span>; <span style=color:#a2f;font-weight:700>do</span> 
</span></span><span style=display:flex><span>    wget -qO- 10.0.1.175:80
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>This should produce something like:</p><pre tabindex=0><code>hostnames-632524106-bbpiw
hostnames-632524106-ly40y
hostnames-632524106-tlaok
</code></pre><p>If your Service is working, you should get correct responses. If not, there
are a number of things that could be going wrong. Read on.</p><h2 id=is-the-service-defined-correctly>Is the Service defined correctly?</h2><p>It might sound silly, but you should really double and triple check that your
Service is correct and matches your Pod's port. Read back your Service
and verify it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service hostnames -o json
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;kind&#34;</span>: <span style=color:#b44>&#34;Service&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;apiVersion&#34;</span>: <span style=color:#b44>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;hostnames&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;namespace&#34;</span>: <span style=color:#b44>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;uid&#34;</span>: <span style=color:#b44>&#34;428c8b6c-24bc-11e5-936d-42010af0a9bc&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;resourceVersion&#34;</span>: <span style=color:#b44>&#34;347189&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;creationTimestamp&#34;</span>: <span style=color:#b44>&#34;2015-07-07T15:24:29Z&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;labels&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;app&#34;</span>: <span style=color:#b44>&#34;hostnames&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;spec&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;ports&#34;</span>: [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;protocol&#34;</span>: <span style=color:#b44>&#34;TCP&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;port&#34;</span>: <span style=color:#666>80</span>,
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;targetPort&#34;</span>: <span style=color:#666>9376</span>,
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;nodePort&#34;</span>: <span style=color:#666>0</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;selector&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;app&#34;</span>: <span style=color:#b44>&#34;hostnames&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;clusterIP&#34;</span>: <span style=color:#b44>&#34;10.0.1.175&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;type&#34;</span>: <span style=color:#b44>&#34;ClusterIP&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;sessionAffinity&#34;</span>: <span style=color:#b44>&#34;None&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;status&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;loadBalancer&#34;</span>: {}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>Is the Service port you are trying to access listed in <code>spec.ports[]</code>?</li><li>Is the <code>targetPort</code> correct for your Pods (some Pods use a different port than the Service)?</li><li>If you meant to use a numeric port, is it a number (9376) or a string "9376"?</li><li>If you meant to use a named port, do your Pods expose a port with the same name?</li><li>Is the port's <code>protocol</code> correct for your Pods?</li></ul><h2 id=does-the-service-have-any-endpoints>Does the Service have any Endpoints?</h2><p>If you got this far, you have confirmed that your Service is correctly
defined and is resolved by DNS. Now let's check that the Pods you ran are
actually being selected by the Service.</p><p>Earlier you saw that the Pods were running. You can re-check that:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>hostnames
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME                        READY     STATUS    RESTARTS   AGE
hostnames-632524106-bbpiw   1/1       Running   0          1h
hostnames-632524106-ly40y   1/1       Running   0          1h
hostnames-632524106-tlaok   1/1       Running   0          1h
</code></pre><p>The <code>-l app=hostnames</code> argument is a label selector configured on the Service.</p><p>The "AGE" column says that these Pods are about an hour old, which implies that
they are running fine and not crashing.</p><p>The "RESTARTS" column says that these pods are not crashing frequently or being
restarted. Frequent restarts could lead to intermittent connectivity issues.
If the restart count is high, read more about how to <a href=/docs/tasks/debug/debug-application/debug-pods>debug pods</a>.</p><p>Inside the Kubernetes system is a control loop which evaluates the selector of
every Service and saves the results into a corresponding Endpoints object.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get endpoints hostnames
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME        ENDPOINTS
</span></span><span style=display:flex><span>hostnames   10.244.0.5:9376,10.244.0.6:9376,10.244.0.7:9376
</span></span></code></pre></div><p>This confirms that the endpoints controller has found the correct Pods for
your Service. If the <code>ENDPOINTS</code> column is <code>&lt;none></code>, you should check that
the <code>spec.selector</code> field of your Service actually selects for
<code>metadata.labels</code> values on your Pods. A common mistake is to have a typo or
other error, such as the Service selecting for <code>app=hostnames</code>, but the
Deployment specifying <code>run=hostnames</code>, as in versions previous to 1.18, where
the <code>kubectl run</code> command could have been also used to create a Deployment.</p><h2 id=are-the-pods-working>Are the Pods working?</h2><p>At this point, you know that your Service exists and has selected your Pods.
At the beginning of this walk-through, you verified the Pods themselves.
Let's check again that the Pods are actually working - you can bypass the
Service mechanism and go straight to the Pods, as listed by the Endpoints
above.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> These commands use the Pod port (9376), rather than the Service port (80).</div><p>From within a Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> ep in 10.244.0.5:9376 10.244.0.6:9376 10.244.0.7:9376; <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>    wget -qO- <span style=color:#b8860b>$ep</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>This should produce something like:</p><pre tabindex=0><code>hostnames-632524106-bbpiw
hostnames-632524106-ly40y
hostnames-632524106-tlaok
</code></pre><p>You expect each Pod in the Endpoints list to return its own hostname. If
this is not what happens (or whatever the correct behavior is for your own
Pods), you should investigate what's happening there.</p><h2 id=is-the-kube-proxy-working>Is the kube-proxy working?</h2><p>If you get here, your Service is running, has Endpoints, and your Pods
are actually serving. At this point, the whole Service proxy mechanism is
suspect. Let's confirm it, piece by piece.</p><p>The default implementation of Services, and the one used on most clusters, is
kube-proxy. This is a program that runs on every node and configures one of a
small set of mechanisms for providing the Service abstraction. If your
cluster does not use kube-proxy, the following sections will not apply, and you
will have to investigate whatever implementation of Services you are using.</p><h3 id=is-kube-proxy-running>Is kube-proxy running?</h3><p>Confirm that <code>kube-proxy</code> is running on your Nodes. Running directly on a
Node, you should get something like the below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ps auxw | grep kube-proxy
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>root  4194  0.4  0.1 101864 17696 ?    Sl Jul04  25:43 /usr/local/bin/kube-proxy --master=https://kubernetes-master --kubeconfig=/var/lib/kube-proxy/kubeconfig --v=2
</code></pre><p>Next, confirm that it is not failing something obvious, like contacting the
master. To do this, you'll have to look at the logs. Accessing the logs
depends on your Node OS. On some OSes it is a file, such as
/var/log/kube-proxy.log, while other OSes use <code>journalctl</code> to access logs. You
should see something like:</p><pre tabindex=0><code class=language-none data-lang=none>I1027 22:14:53.995134    5063 server.go:200] Running in resource-only container &#34;/kube-proxy&#34;
I1027 22:14:53.998163    5063 server.go:247] Using iptables Proxier.
I1027 22:14:53.999055    5063 server.go:255] Tearing down userspace rules. Errors here are acceptable.
I1027 22:14:54.038140    5063 proxier.go:352] Setting endpoints for &#34;kube-system/kube-dns:dns-tcp&#34; to [10.244.1.3:53]
I1027 22:14:54.038164    5063 proxier.go:352] Setting endpoints for &#34;kube-system/kube-dns:dns&#34; to [10.244.1.3:53]
I1027 22:14:54.038209    5063 proxier.go:352] Setting endpoints for &#34;default/kubernetes:https&#34; to [10.240.0.2:443]
I1027 22:14:54.038238    5063 proxier.go:429] Not syncing iptables until Services and Endpoints have been received from master
I1027 22:14:54.040048    5063 proxier.go:294] Adding new service &#34;default/kubernetes:https&#34; at 10.0.0.1:443/TCP
I1027 22:14:54.040154    5063 proxier.go:294] Adding new service &#34;kube-system/kube-dns:dns&#34; at 10.0.0.10:53/UDP
I1027 22:14:54.040223    5063 proxier.go:294] Adding new service &#34;kube-system/kube-dns:dns-tcp&#34; at 10.0.0.10:53/TCP
</code></pre><p>If you see error messages about not being able to contact the master, you
should double-check your Node configuration and installation steps.</p><p>One of the possible reasons that <code>kube-proxy</code> cannot run correctly is that the
required <code>conntrack</code> binary cannot be found. This may happen on some Linux
systems, depending on how you are installing the cluster, for example, you are
installing Kubernetes from scratch. If this is the case, you need to manually
install the <code>conntrack</code> package (e.g. <code>sudo apt install conntrack</code> on Ubuntu)
and then retry.</p><p>Kube-proxy can run in one of a few modes. In the log listed above, the
line <code>Using iptables Proxier</code> indicates that kube-proxy is running in
"iptables" mode. The most common other mode is "ipvs". The older "userspace"
mode has largely been replaced by these.</p><h4 id=iptables-mode>Iptables mode</h4><p>In "iptables" mode, you should see something like the following on a Node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>iptables-save | grep hostnames
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>-A KUBE-SEP-57KPRZ3JQVENLNBR -s 10.244.3.6/32 -m comment --comment &#34;default/hostnames:&#34; -j MARK --set-xmark 0x00004000/0x00004000
-A KUBE-SEP-57KPRZ3JQVENLNBR -p tcp -m comment --comment &#34;default/hostnames:&#34; -m tcp -j DNAT --to-destination 10.244.3.6:9376
-A KUBE-SEP-WNBA2IHDGP2BOBGZ -s 10.244.1.7/32 -m comment --comment &#34;default/hostnames:&#34; -j MARK --set-xmark 0x00004000/0x00004000
-A KUBE-SEP-WNBA2IHDGP2BOBGZ -p tcp -m comment --comment &#34;default/hostnames:&#34; -m tcp -j DNAT --to-destination 10.244.1.7:9376
-A KUBE-SEP-X3P2623AGDH6CDF3 -s 10.244.2.3/32 -m comment --comment &#34;default/hostnames:&#34; -j MARK --set-xmark 0x00004000/0x00004000
-A KUBE-SEP-X3P2623AGDH6CDF3 -p tcp -m comment --comment &#34;default/hostnames:&#34; -m tcp -j DNAT --to-destination 10.244.2.3:9376
-A KUBE-SERVICES -d 10.0.1.175/32 -p tcp -m comment --comment &#34;default/hostnames: cluster IP&#34; -m tcp --dport 80 -j KUBE-SVC-NWV5X2332I4OT4T3
-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment &#34;default/hostnames:&#34; -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-WNBA2IHDGP2BOBGZ
-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment &#34;default/hostnames:&#34; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-X3P2623AGDH6CDF3
-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment &#34;default/hostnames:&#34; -j KUBE-SEP-57KPRZ3JQVENLNBR
</code></pre><p>For each port of each Service, there should be 1 rule in <code>KUBE-SERVICES</code> and
one <code>KUBE-SVC-&lt;hash></code> chain. For each Pod endpoint, there should be a small
number of rules in that <code>KUBE-SVC-&lt;hash></code> and one <code>KUBE-SEP-&lt;hash></code> chain with
a small number of rules in it. The exact rules will vary based on your exact
config (including node-ports and load-balancers).</p><h4 id=ipvs-mode>IPVS mode</h4><p>In "ipvs" mode, you should see something like the following on a Node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ipvsadm -ln
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
...
TCP  10.0.1.175:80 rr
  -&gt; 10.244.0.5:9376               Masq    1      0          0
  -&gt; 10.244.0.6:9376               Masq    1      0          0
  -&gt; 10.244.0.7:9376               Masq    1      0          0
...
</code></pre><p>For each port of each Service, plus any NodePorts, external IPs, and
load-balancer IPs, kube-proxy will create a virtual server. For each Pod
endpoint, it will create corresponding real servers. In this example, service
hostnames(<code>10.0.1.175:80</code>) has 3 endpoints(<code>10.244.0.5:9376</code>,
<code>10.244.0.6:9376</code>, <code>10.244.0.7:9376</code>).</p><h4 id=userspace-mode>Userspace mode</h4><p>In rare cases, you may be using "userspace" mode. From your Node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>iptables-save | grep hostnames
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>-A KUBE-PORTALS-CONTAINER -d 10.0.1.175/32 -p tcp -m comment --comment &#34;default/hostnames:default&#34; -m tcp --dport 80 -j REDIRECT --to-ports 48577
-A KUBE-PORTALS-HOST -d 10.0.1.175/32 -p tcp -m comment --comment &#34;default/hostnames:default&#34; -m tcp --dport 80 -j DNAT --to-destination 10.240.115.247:48577
</code></pre><p>There should be 2 rules for each port of your Service (only one in this
example) - a "KUBE-PORTALS-CONTAINER" and a "KUBE-PORTALS-HOST".</p><p>Almost nobody should be using the "userspace" mode any more, so you won't spend
more time on it here.</p><h3 id=is-kube-proxy-proxying>Is kube-proxy proxying?</h3><p>Assuming you do see one the above cases, try again to access your Service by
IP from one of your Nodes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl 10.0.1.175:80
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>hostnames-632524106-bbpiw
</code></pre><p>If this fails and you are using the userspace proxy, you can try accessing the
proxy directly. If you are using the iptables proxy, skip this section.</p><p>Look back at the <code>iptables-save</code> output above, and extract the
port number that <code>kube-proxy</code> is using for your Service. In the above
examples it is "48577". Now connect to that:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl localhost:48577
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>hostnames-632524106-tlaok
</code></pre><p>If this still fails, look at the <code>kube-proxy</code> logs for specific lines like:</p><pre tabindex=0><code class=language-none data-lang=none>Setting endpoints for default/hostnames:default to [10.244.0.5:9376 10.244.0.6:9376 10.244.0.7:9376]
</code></pre><p>If you don't see those, try restarting <code>kube-proxy</code> with the <code>-v</code> flag set to 4, and
then look at the logs again.</p><h3 id=a-pod-fails-to-reach-itself-via-the-service-ip>Edge case: A Pod fails to reach itself via the Service IP</h3><p>This might sound unlikely, but it does happen and it is supposed to work.</p><p>This can happen when the network is not properly configured for "hairpin"
traffic, usually when <code>kube-proxy</code> is running in <code>iptables</code> mode and Pods
are connected with bridge network. The <code>Kubelet</code> exposes a <code>hairpin-mode</code>
<a href=/docs/reference/command-line-tools-reference/kubelet/>flag</a> that allows endpoints of a Service to loadbalance
back to themselves if they try to access their own Service VIP. The
<code>hairpin-mode</code> flag must either be set to <code>hairpin-veth</code> or
<code>promiscuous-bridge</code>.</p><p>The common steps to trouble shoot this are as follows:</p><ul><li>Confirm <code>hairpin-mode</code> is set to <code>hairpin-veth</code> or <code>promiscuous-bridge</code>.
You should see something like the below. <code>hairpin-mode</code> is set to
<code>promiscuous-bridge</code> in the following example.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ps auxw | grep kubelet
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>root      3392  1.1  0.8 186804 65208 ?        Sl   00:51  11:11 /usr/local/bin/kubelet --enable-debugging-handlers=true --config=/etc/kubernetes/manifests --allow-privileged=True --v=4 --cluster-dns=10.0.0.10 --cluster-domain=cluster.local --configure-cbr0=true --cgroup-root=/ --system-cgroups=/system --hairpin-mode=promiscuous-bridge --runtime-cgroups=/docker-daemon --kubelet-cgroups=/kubelet --babysit-daemons=true --max-pods=110 --serialize-image-pulls=false --outofdisk-transition-frequency=0
</code></pre><ul><li>Confirm the effective <code>hairpin-mode</code>. To do this, you'll have to look at
kubelet log. Accessing the logs depends on your Node OS. On some OSes it
is a file, such as /var/log/kubelet.log, while other OSes use <code>journalctl</code>
to access logs. Please be noted that the effective hairpin mode may not
match <code>--hairpin-mode</code> flag due to compatibility. Check if there is any log
lines with key word <code>hairpin</code> in kubelet.log. There should be log lines
indicating the effective hairpin mode, like something below.</li></ul><pre tabindex=0><code class=language-none data-lang=none>I0629 00:51:43.648698    3252 kubelet.go:380] Hairpin mode set to &#34;promiscuous-bridge&#34;
</code></pre><ul><li>If the effective hairpin mode is <code>hairpin-veth</code>, ensure the <code>Kubelet</code> has
the permission to operate in <code>/sys</code> on node. If everything works properly,
you should see something like:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> intf in /sys/devices/virtual/net/cbr0/brif/*; <span style=color:#a2f;font-weight:700>do</span> cat <span style=color:#b8860b>$intf</span>/hairpin_mode; <span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>1
1
1
1
</code></pre><ul><li>If the effective hairpin mode is <code>promiscuous-bridge</code>, ensure <code>Kubelet</code>
has the permission to manipulate linux bridge on node. If <code>cbr0</code> bridge is
used and configured properly, you should see:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ifconfig cbr0 |grep PROMISC
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>UP BROADCAST RUNNING PROMISC MULTICAST  MTU:1460  Metric:1
</code></pre><ul><li>Seek help if none of above works out.</li></ul><h2 id=seek-help>Seek help</h2><p>If you get this far, something very strange is happening. Your Service is
running, has Endpoints, and your Pods are actually serving. You have DNS
working, and <code>kube-proxy</code> does not seem to be misbehaving. And yet your
Service is not working. Please let us know what is going on, so we can help
investigate!</p><p>Contact us on
<a href=https://slack.k8s.io/>Slack</a> or
<a href=https://discuss.kubernetes.io>Forum</a> or
<a href=https://github.com/kubernetes/kubernetes>GitHub</a>.</p><h2 id=what-s-next>What's next</h2><p>Visit the <a href=/docs/tasks/debug/>troubleshooting overview document</a>
for more information.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-089001d4003f033e21602adcb11cd277>4.1.3 - Debug a StatefulSet</h1><p>This task shows you how to debug a StatefulSet.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>You need to have a Kubernetes cluster, and the kubectl command-line tool must be configured to communicate with your cluster.</li><li>You should have a StatefulSet running that you want to investigate.</li></ul><h2 id=debugging-a-statefulset>Debugging a StatefulSet</h2><p>In order to list all the pods which belong to a StatefulSet, which have a label <code>app.kubernetes.io/name=MyApp</code> set on them,
you can use the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l app.kubernetes.io/name<span style=color:#666>=</span>MyApp
</span></span></code></pre></div><p>If you find that any Pods listed are in <code>Unknown</code> or <code>Terminating</code> state for an extended period of time,
refer to the <a href=/docs/tasks/run-application/delete-stateful-set/>Deleting StatefulSet Pods</a> task for
instructions on how to deal with them.
You can debug individual Pods in a StatefulSet using the
<a href=/docs/tasks/debug/debug-application/debug-pods/>Debugging Pods</a> guide.</p><h2 id=what-s-next>What's next</h2><p>Learn more about <a href=/docs/tasks/debug/debug-application/debug-init-containers/>debugging an init-container</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-655b47c523b6f1b52d25e520625abccb>4.1.4 - Determine the Reason for Pod Failure</h1><p>This page shows how to write and read a Container termination message.</p><p>Termination messages provide a way for containers to write
information about fatal events to a location where it can
be easily retrieved and surfaced by tools like dashboards
and monitoring software. In most cases, information that you
put in a termination message should also be written to
the general
<a href=/docs/concepts/cluster-administration/logging/>Kubernetes logs</a>.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=writing-and-reading-a-termination-message>Writing and reading a termination message</h2><p>In this exercise, you create a Pod that runs one container.
The manifest for that Pod specifies a command that runs when the container starts:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/debug/termination.yaml download=debug/termination.yaml><code>debug/termination.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("debug-termination-yaml")' title="Copy debug/termination.yaml to clipboard"></img></div><div class=includecode id=debug-termination-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>termination-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>termination-demo-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>debian<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/bin/sh&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;sleep 10 &amp;&amp; echo Sleep expired &gt; /dev/termination-log&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create a Pod based on the YAML configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/debug/termination.yaml
</span></span></code></pre></div><p>In the YAML file, in the <code>command</code> and <code>args</code> fields, you can see that the
container sleeps for 10 seconds and then writes "Sleep expired" to
the <code>/dev/termination-log</code> file. After the container writes
the "Sleep expired" message, it terminates.</p></li><li><p>Display information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod termination-demo
</span></span></code></pre></div><p>Repeat the preceding command until the Pod is no longer running.</p></li><li><p>Display detailed information about the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod termination-demo --output<span style=color:#666>=</span>yaml
</span></span></code></pre></div><p>The output includes the "Sleep expired" message:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastState</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>terminated</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>containerID</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>exitCode</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>finishedAt</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          </span><span style=color:#bbb>          </span>Sleep expired<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>...<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Use a Go template to filter the output so that it includes only the termination message:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod termination-demo -o go-template<span style=color:#666>=</span><span style=color:#b44>&#34;{{range .status.containerStatuses}}{{.lastState.terminated.message}}{{end}}&#34;</span>
</span></span></code></pre></div></li></ol><p>If you are running a multi-container Pod, you can use a Go template to include the container's name.
By doing so, you can discover which of the containers is failing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod multi-container-pod -o go-template<span style=color:#666>=</span><span style=color:#b44>&#39;{{range .status.containerStatuses}}{{printf &#34;%s:\n%s\n\n&#34; .name .lastState.terminated.message}}{{end}}&#39;</span>
</span></span></code></pre></div><h2 id=customizing-the-termination-message>Customizing the termination message</h2><p>Kubernetes retrieves termination messages from the termination message file
specified in the <code>terminationMessagePath</code> field of a Container, which has a default
value of <code>/dev/termination-log</code>. By customizing this field, you can tell Kubernetes
to use a different file. Kubernetes use the contents from the specified file to
populate the Container's status message on both success and failure.</p><p>The termination message is intended to be brief final status, such as an assertion failure message.
The kubelet truncates messages that are longer than 4096 bytes.</p><p>The total message length across all containers is limited to 12KiB, divided equally among each container.
For example, if there are 12 containers (<code>initContainers</code> or <code>containers</code>), each has 1024 bytes of available termination message space.</p><p>The default termination message path is <code>/dev/termination-log</code>.
You cannot set the termination message path after a Pod is launched.</p><p>In the following example, the container writes termination messages to
<code>/tmp/my-log</code> for Kubernetes to retrieve:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>msg-path-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>msg-path-demo-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>debian<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>terminationMessagePath</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/tmp/my-log&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Moreover, users can set the <code>terminationMessagePolicy</code> field of a Container for
further customization. This field defaults to "<code>File</code>" which means the termination
messages are retrieved only from the termination message file. By setting the
<code>terminationMessagePolicy</code> to "<code>FallbackToLogsOnError</code>", you can tell Kubernetes
to use the last chunk of container log output if the termination message file
is empty and the container exited with an error. The log output is limited to
2048 bytes or 80 lines, whichever is smaller.</p><h2 id=what-s-next>What's next</h2><ul><li>See the <code>terminationMessagePath</code> field in
<a href=/docs/reference/generated/kubernetes-api/v1.25/#container-v1-core>Container</a>.</li><li>Learn about <a href=/docs/concepts/cluster-administration/logging/>retrieving logs</a>.</li><li>Learn about <a href=https://golang.org/pkg/text/template/>Go templates</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-43445f3208669d4078e87dbdbeed8473>4.1.5 - Debug Init Containers</h1><p>This page shows how to investigate problems related to the execution of
Init Containers. The example command lines below refer to the Pod as
<code>&lt;pod-name></code> and the Init Containers as <code>&lt;init-container-1></code> and
<code>&lt;init-container-2></code>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><ul><li>You should be familiar with the basics of
<a href=/docs/concepts/workloads/pods/init-containers/>Init Containers</a>.</li><li>You should have <a href=/docs/tasks/configure-pod-container/configure-pod-initialization/#creating-a-pod-that-has-an-init-container/>Configured an Init Container</a>.</li></ul><h2 id=checking-the-status-of-init-containers>Checking the status of Init Containers</h2><p>Display the status of your pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod &lt;pod-name&gt;
</span></span></code></pre></div><p>For example, a status of <code>Init:1/2</code> indicates that one of two Init Containers
has completed successfully:</p><pre tabindex=0><code>NAME         READY     STATUS     RESTARTS   AGE
&lt;pod-name&gt;   0/1       Init:1/2   0          7s
</code></pre><p>See <a href=#understanding-pod-status>Understanding Pod status</a> for more examples of
status values and their meanings.</p><h2 id=getting-details-about-init-containers>Getting details about Init Containers</h2><p>View more detailed information about Init Container execution:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod &lt;pod-name&gt;
</span></span></code></pre></div><p>For example, a Pod with two Init Containers might show the following:</p><pre tabindex=0><code>Init Containers:
  &lt;init-container-1&gt;:
    Container ID:    ...
    ...
    State:           Terminated
      Reason:        Completed
      Exit Code:     0
      Started:       ...
      Finished:      ...
    Ready:           True
    Restart Count:   0
    ...
  &lt;init-container-2&gt;:
    Container ID:    ...
    ...
    State:           Waiting
      Reason:        CrashLoopBackOff
    Last State:      Terminated
      Reason:        Error
      Exit Code:     1
      Started:       ...
      Finished:      ...
    Ready:           False
    Restart Count:   3
    ...
</code></pre><p>You can also access the Init Container statuses programmatically by reading the
<code>status.initContainerStatuses</code> field on the Pod Spec:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod nginx --template <span style=color:#b44>&#39;{{.status.initContainerStatuses}}&#39;</span>
</span></span></code></pre></div><p>This command will return the same information as above in raw JSON.</p><h2 id=accessing-logs-from-init-containers>Accessing logs from Init Containers</h2><p>Pass the Init Container name along with the Pod name
to access its logs.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs &lt;pod-name&gt; -c &lt;init-container-2&gt;
</span></span></code></pre></div><p>Init Containers that run a shell script print
commands as they're executed. For example, you can do this in Bash by running
<code>set -x</code> at the beginning of the script.</p><h2 id=understanding-pod-status>Understanding Pod status</h2><p>A Pod status beginning with <code>Init:</code> summarizes the status of Init Container
execution. The table below describes some example status values that you might
see while debugging Init Containers.</p><table><thead><tr><th>Status</th><th>Meaning</th></tr></thead><tbody><tr><td><code>Init:N/M</code></td><td>The Pod has <code>M</code> Init Containers, and <code>N</code> have completed so far.</td></tr><tr><td><code>Init:Error</code></td><td>An Init Container has failed to execute.</td></tr><tr><td><code>Init:CrashLoopBackOff</code></td><td>An Init Container has failed repeatedly.</td></tr><tr><td><code>Pending</code></td><td>The Pod has not yet begun executing Init Containers.</td></tr><tr><td><code>PodInitializing</code> or <code>Running</code></td><td>The Pod has already finished executing Init Containers.</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-132acc7efbd72bd677945eda3b6c6d38>4.1.6 - Debug Running Pods</h1><p>This page explains how to debug Pods running (or crashing) on a Node.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>Your <a class=glossary-tooltip title='A Pod represents a set of running containers in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pod>Pod</a> should already be
scheduled and running. If your Pod is not yet running, start with <a href=/docs/tasks/debug/debug-application/>Debugging
Pods</a>.</li><li>For some of the advanced debugging steps you need to know on which Node the
Pod is running and have shell access to run commands on that Node. You don't
need that access to run the standard debug steps that use <code>kubectl</code>.</li></ul><h2 id=using-kubectl-describe-pod-to-fetch-details-about-pods>Using <code>kubectl describe pod</code> to fetch details about pods</h2><p>For this example we'll use a Deployment to create two pods, similar to the earlier example.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/nginx-with-request.yaml download=application/nginx-with-request.yaml><code>application/nginx-with-request.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-nginx-with-request-yaml")' title="Copy application/nginx-with-request.yaml to clipboard"></img></div><div class=includecode id=application-nginx-with-request-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;128Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;500m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create deployment by running following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/nginx-with-request.yaml
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>deployment.apps/nginx-deployment created
</code></pre><p>Check pod status by following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-67d4bdd6f5-cx2nz   1/1     Running   0          13s
nginx-deployment-67d4bdd6f5-w6kd7   1/1     Running   0          13s
</code></pre><p>We can retrieve a lot more information about each of these pods using <code>kubectl describe pod</code>. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod nginx-deployment-67d4bdd6f5-w6kd7
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Name:         nginx-deployment-67d4bdd6f5-w6kd7
Namespace:    default
Priority:     0
Node:         kube-worker-1/192.168.0.113
Start Time:   Thu, 17 Feb 2022 16:51:01 -0500
Labels:       app=nginx
              pod-template-hash=67d4bdd6f5
Annotations:  &lt;none&gt;
Status:       Running
IP:           10.88.0.3
IPs:
  IP:           10.88.0.3
  IP:           2001:db8::1
Controlled By:  ReplicaSet/nginx-deployment-67d4bdd6f5
Containers:
  nginx:
    Container ID:   containerd://5403af59a2b46ee5a23fb0ae4b1e077f7ca5c5fb7af16e1ab21c00e0e616462a
    Image:          nginx
    Image ID:       docker.io/library/nginx@sha256:2834dc507516af02784808c5f48b7cbe38b8ed5d0f4837f16e78d00deb7e7767
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Thu, 17 Feb 2022 16:51:05 -0500
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:        500m
      memory:     128Mi
    Environment:  &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-bgsgp (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  kube-api-access-bgsgp:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       &lt;nil&gt;
    DownwardAPI:             true
QoS Class:                   Guaranteed
Node-Selectors:              &lt;none&gt;
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  34s   default-scheduler  Successfully assigned default/nginx-deployment-67d4bdd6f5-w6kd7 to kube-worker-1
  Normal  Pulling    31s   kubelet            Pulling image &#34;nginx&#34;
  Normal  Pulled     30s   kubelet            Successfully pulled image &#34;nginx&#34; in 1.146417389s
  Normal  Created    30s   kubelet            Created container nginx
  Normal  Started    30s   kubelet            Started container nginx
</code></pre><p>Here you can see configuration information about the container(s) and Pod (labels, resource requirements, etc.), as well as status information about the container(s) and Pod (state, readiness, restart count, events, etc.).</p><p>The container state is one of Waiting, Running, or Terminated. Depending on the state, additional information will be provided -- here you can see that for a container in Running state, the system tells you when the container started.</p><p>Ready tells you whether the container passed its last readiness probe. (In this case, the container does not have a readiness probe configured; the container is assumed to be ready if no readiness probe is configured.)</p><p>Restart Count tells you how many times the container has been restarted; this information can be useful for detecting crash loops in containers that are configured with a restart policy of 'always.'</p><p>Currently the only Condition associated with a Pod is the binary Ready condition, which indicates that the pod is able to service requests and should be added to the load balancing pools of all matching services.</p><p>Lastly, you see a log of recent events related to your Pod. The system compresses multiple identical events by indicating the first and last time it was seen and the number of times it was seen. "From" indicates the component that is logging the event, "SubobjectPath" tells you which object (e.g. container within the pod) is being referred to, and "Reason" and "Message" tell you what happened.</p><h2 id=example-debugging-pending-pods>Example: debugging Pending Pods</h2><p>A common scenario that you can detect using events is when you've created a Pod that won't fit on any node. For example, the Pod might request more resources than are free on any node, or it might specify a label selector that doesn't match any nodes. Let's say we created the previous Deployment with 5 replicas (instead of 2) and requesting 600 millicores instead of 500, on a four-node cluster where each (virtual) machine has 1 CPU. In that case one of the Pods will not be able to schedule. (Note that because of the cluster addon pods such as fluentd, skydns, etc., that run on each node, if we requested 1000 millicores then none of the Pods would be able to schedule.)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-1006230814-6winp   1/1       Running   0          7m
nginx-deployment-1006230814-fmgu3   1/1       Running   0          7m
nginx-deployment-1370807587-6ekbw   1/1       Running   0          1m
nginx-deployment-1370807587-fg172   0/1       Pending   0          1m
nginx-deployment-1370807587-fz9sd   0/1       Pending   0          1m
</code></pre><p>To find out why the nginx-deployment-1370807587-fz9sd pod is not running, we can use <code>kubectl describe pod</code> on the pending Pod and look at its events:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod nginx-deployment-1370807587-fz9sd
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>  Name:		nginx-deployment-1370807587-fz9sd
  Namespace:	default
  Node:		/
  Labels:		app=nginx,pod-template-hash=1370807587
  Status:		Pending
  IP:
  Controllers:	ReplicaSet/nginx-deployment-1370807587
  Containers:
    nginx:
      Image:	nginx
      Port:	80/TCP
      QoS Tier:
        memory:	Guaranteed
        cpu:	Guaranteed
      Limits:
        cpu:	1
        memory:	128Mi
      Requests:
        cpu:	1
        memory:	128Mi
      Environment Variables:
  Volumes:
    default-token-4bcbi:
      Type:	Secret (a volume populated by a Secret)
      SecretName:	default-token-4bcbi
  Events:
    FirstSeen	LastSeen	Count	From			        SubobjectPath	Type		Reason			    Message
    ---------	--------	-----	----			        -------------	--------	------			    -------
    1m		    48s		    7	    {default-scheduler }			        Warning		FailedScheduling	pod (nginx-deployment-1370807587-fz9sd) failed to fit in any node
  fit failure on node (kubernetes-node-6ta5): Node didn&#39;t have enough resource: CPU, requested: 1000, used: 1420, capacity: 2000
  fit failure on node (kubernetes-node-wul5): Node didn&#39;t have enough resource: CPU, requested: 1000, used: 1100, capacity: 2000
</code></pre><p>Here you can see the event generated by the scheduler saying that the Pod failed to schedule for reason <code>FailedScheduling</code> (and possibly others). The message tells us that there were not enough resources for the Pod on any of the nodes.</p><p>To correct this situation, you can use <code>kubectl scale</code> to update your Deployment to specify four or fewer replicas. (Or you could leave the one Pod pending, which is harmless.)</p><p>Events such as the ones you saw at the end of <code>kubectl describe pod</code> are persisted in etcd and provide high-level information on what is happening in the cluster. To list all events you can use</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get events
</span></span></code></pre></div><p>but you have to remember that events are namespaced. This means that if you're interested in events for some namespaced object (e.g. what happened with Pods in namespace <code>my-namespace</code>) you need to explicitly provide a namespace to the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get events --namespace<span style=color:#666>=</span>my-namespace
</span></span></code></pre></div><p>To see events from all namespaces, you can use the <code>--all-namespaces</code> argument.</p><p>In addition to <code>kubectl describe pod</code>, another way to get extra information about a pod (beyond what is provided by <code>kubectl get pod</code>) is to pass the <code>-o yaml</code> output format flag to <code>kubectl get pod</code>. This will give you, in YAML format, even more information than <code>kubectl describe pod</code>--essentially all of the information the system has about the Pod. Here you will see things like annotations (which are key-value metadata without the label restrictions, that is used internally by Kubernetes system components), restart policy, ports, and volumes.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod nginx-deployment-1006230814-6winp -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T21:51:01Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>generateName</span>:<span style=color:#bbb> </span>nginx-deployment-67d4bdd6f5-<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pod-template-hash</span>:<span style=color:#bbb> </span>67d4bdd6f5<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment-67d4bdd6f5-w6kd7<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ownerReferences</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>blockOwnerDeletion</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>controller</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ReplicaSet<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment-67d4bdd6f5<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>7d41dfd4-84c0-4be4-88ab-cedbe626ad82<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1364&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>a6501da1-0447-4262-98eb-c03d4002222e<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>500m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>128Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>500m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>128Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>terminationMessagePath</span>:<span style=color:#bbb> </span>/dev/termination-log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>terminationMessagePolicy</span>:<span style=color:#bbb> </span>File<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/run/secrets/kubernetes.io/serviceaccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-api-access-bgsgp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>dnsPolicy</span>:<span style=color:#bbb> </span>ClusterFirst<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>enableServiceLinks</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeName</span>:<span style=color:#bbb> </span>kube-worker-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>preemptionPolicy</span>:<span style=color:#bbb> </span>PreemptLowerPriority<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>priority</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>schedulerName</span>:<span style=color:#bbb> </span>default-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>serviceAccount</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>terminationGracePeriodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoExecute<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node.kubernetes.io/not-ready<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exists<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tolerationSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>300</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoExecute<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node.kubernetes.io/unreachable<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exists<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tolerationSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>300</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-api-access-bgsgp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>projected</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>defaultMode</span>:<span style=color:#bbb> </span><span style=color:#666>420</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>sources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>serviceAccountToken</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>expirationSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>3607</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>ca.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>ca.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-root-ca.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>downwardAPI</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>metadata.namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conditions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastProbeTime</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T21:51:01Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;True&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Initialized<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastProbeTime</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T21:51:06Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;True&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Ready<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastProbeTime</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T21:51:06Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;True&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>ContainersReady<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastProbeTime</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T21:51:01Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;True&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>PodScheduled<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containerStatuses</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>containerID</span>:<span style=color:#bbb> </span>containerd://5403af59a2b46ee5a23fb0ae4b1e077f7ca5c5fb7af16e1ab21c00e0e616462a<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>docker.io/library/nginx:latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>imageID</span>:<span style=color:#bbb> </span>docker.io/library/nginx@sha256:2834dc507516af02784808c5f48b7cbe38b8ed5d0f4837f16e78d00deb7e7767<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastState</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ready</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>restartCount</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>started</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>state</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>running</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>startedAt</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T21:51:05Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostIP</span>:<span style=color:#bbb> </span><span style=color:#666>192.168.0.113</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>phase</span>:<span style=color:#bbb> </span>Running<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podIP</span>:<span style=color:#bbb> </span><span style=color:#666>10.88.0.3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podIPs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>ip</span>:<span style=color:#bbb> </span><span style=color:#666>10.88.0.3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>ip</span>:<span style=color:#bbb> </span><span style=color:#666>2001</span>:db8::1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>qosClass</span>:<span style=color:#bbb> </span>Guaranteed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>startTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T21:51:01Z&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=examine-pod-logs>Examining pod logs</h2><p>First, look at the logs of the affected container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>POD_NAME</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CONTAINER_NAME</span><span style=color:#b68;font-weight:700>}</span>
</span></span></code></pre></div><p>If your container has previously crashed, you can access the previous container's crash log with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs --previous <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>POD_NAME</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CONTAINER_NAME</span><span style=color:#b68;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=container-exec>Debugging with container exec</h2><p>If the <a class=glossary-tooltip title='Stored instance of a container that holds a set of software needed to run an application.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-image' target=_blank aria-label='container image'>container image</a> includes
debugging utilities, as is the case with images built from Linux and Windows OS
base images, you can run commands inside a specific container with
<code>kubectl exec</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>POD_NAME</span><span style=color:#b68;font-weight:700>}</span> -c <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CONTAINER_NAME</span><span style=color:#b68;font-weight:700>}</span> -- <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CMD</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>ARG1</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>ARG2</span><span style=color:#b68;font-weight:700>}</span> ... <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>ARGN</span><span style=color:#b68;font-weight:700>}</span>
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>-c ${CONTAINER_NAME}</code> is optional. You can omit it for Pods that only contain a single container.</div><p>As an example, to look at the logs from a running Cassandra pod, you might run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> cassandra -- cat /var/log/cassandra/system.log
</span></span></code></pre></div><p>You can run a shell that's connected to your terminal using the <code>-i</code> and <code>-t</code>
arguments to <code>kubectl exec</code>, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it cassandra -- sh
</span></span></code></pre></div><p>For more details, see <a href=/docs/tasks/debug/debug-application/get-shell-running-container/>Get a Shell to a Running Container</a>.</p><h2 id=ephemeral-container>Debugging with an ephemeral debug container</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [stable]</code></div><p><a class=glossary-tooltip title='A type of container type that you can temporarily run inside a Pod' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ephemeral-containers/ target=_blank aria-label='Ephemeral containers'>Ephemeral containers</a>
are useful for interactive troubleshooting when <code>kubectl exec</code> is insufficient
because a container has crashed or a container image doesn't include debugging
utilities, such as with <a href=https://github.com/GoogleContainerTools/distroless>distroless images</a>.</p><h3 id=ephemeral-container-example>Example debugging using ephemeral containers</h3><p>You can use the <code>kubectl debug</code> command to add ephemeral containers to a
running Pod. First, create a pod for the example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run ephemeral-demo --image<span style=color:#666>=</span>registry.k8s.io/pause:3.1 --restart<span style=color:#666>=</span>Never
</span></span></code></pre></div><p>The examples in this section use the <code>pause</code> container image because it does not
contain debugging utilities, but this method works with all container
images.</p><p>If you attempt to use <code>kubectl exec</code> to create a shell you will see an error
because there is no shell in this container image.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it ephemeral-demo -- sh
</span></span></code></pre></div><pre tabindex=0><code>OCI runtime exec failed: exec failed: container_linux.go:346: starting container process caused &#34;exec: \&#34;sh\&#34;: executable file not found in $PATH&#34;: unknown
</code></pre><p>You can instead add a debugging container using <code>kubectl debug</code>. If you
specify the <code>-i</code>/<code>--interactive</code> argument, <code>kubectl</code> will automatically attach
to the console of the Ephemeral Container.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl debug -it ephemeral-demo --image<span style=color:#666>=</span>busybox:1.28 --target<span style=color:#666>=</span>ephemeral-demo
</span></span></code></pre></div><pre tabindex=0><code>Defaulting debug container name to debugger-8xzrl.
If you don&#39;t see a command prompt, try pressing enter.
/ #
</code></pre><p>This command adds a new busybox container and attaches to it. The <code>--target</code>
parameter targets the process namespace of another container. It's necessary
here because <code>kubectl run</code> does not enable <a href=/docs/tasks/configure-pod-container/share-process-namespace/>process namespace sharing</a> in the pod it
creates.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The <code>--target</code> parameter must be supported by the <a class=glossary-tooltip title='The container runtime is the software that is responsible for running containers.' data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label='Container Runtime'>Container Runtime</a>. When not supported,
the Ephemeral Container may not be started, or it may be started with an
isolated process namespace so that <code>ps</code> does not reveal processes in other
containers.</div><p>You can view the state of the newly created ephemeral container using <code>kubectl describe</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod ephemeral-demo
</span></span></code></pre></div><pre tabindex=0><code>...
Ephemeral Containers:
  debugger-8xzrl:
    Container ID:   docker://b888f9adfd15bd5739fefaa39e1df4dd3c617b9902082b1cfdc29c4028ffb2eb
    Image:          busybox
    Image ID:       docker-pullable://busybox@sha256:1828edd60c5efd34b2bf5dd3282ec0cc04d47b2ff9caa0b6d4f07a21d1c08084
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Wed, 12 Feb 2020 14:25:42 +0100
    Ready:          False
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:         &lt;none&gt;
...
</code></pre><p>Use <code>kubectl delete</code> to remove the Pod when you're finished:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod ephemeral-demo
</span></span></code></pre></div><h2 id=debugging-using-a-copy-of-the-pod>Debugging using a copy of the Pod</h2><p>Sometimes Pod configuration options make it difficult to troubleshoot in certain
situations. For example, you can't run <code>kubectl exec</code> to troubleshoot your
container if your container image does not include a shell or if your application
crashes on startup. In these situations you can use <code>kubectl debug</code> to create a
copy of the Pod with configuration values changed to aid debugging.</p><h3 id=copying-a-pod-while-adding-a-new-container>Copying a Pod while adding a new container</h3><p>Adding a new container can be useful when your application is running but not
behaving as you expect and you'd like to add additional troubleshooting
utilities to the Pod.</p><p>For example, maybe your application's container images are built on <code>busybox</code>
but you need debugging utilities not included in <code>busybox</code>. You can simulate
this scenario using <code>kubectl run</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run myapp --image<span style=color:#666>=</span>busybox:1.28 --restart<span style=color:#666>=</span>Never -- sleep 1d
</span></span></code></pre></div><p>Run this command to create a copy of <code>myapp</code> named <code>myapp-debug</code> that adds a
new Ubuntu container for debugging:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl debug myapp -it --image<span style=color:#666>=</span>ubuntu --share-processes --copy-to<span style=color:#666>=</span>myapp-debug
</span></span></code></pre></div><pre tabindex=0><code>Defaulting debug container name to debugger-w7xmf.
If you don&#39;t see a command prompt, try pressing enter.
root@myapp-debug:/#
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong><ul><li><code>kubectl debug</code> automatically generates a container name if you don't choose
one using the <code>--container</code> flag.</li><li>The <code>-i</code> flag causes <code>kubectl debug</code> to attach to the new container by
default. You can prevent this by specifying <code>--attach=false</code>. If your session
becomes disconnected you can reattach using <code>kubectl attach</code>.</li><li>The <code>--share-processes</code> allows the containers in this Pod to see processes
from the other containers in the Pod. For more information about how this
works, see <a href=/docs/tasks/configure-pod-container/share-process-namespace/>Share Process Namespace between Containers in a Pod</a>.</li></ul></div><p>Don't forget to clean up the debugging Pod when you're finished with it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod myapp myapp-debug
</span></span></code></pre></div><h3 id=copying-a-pod-while-changing-its-command>Copying a Pod while changing its command</h3><p>Sometimes it's useful to change the command for a container, for example to
add a debugging flag or because the application is crashing.</p><p>To simulate a crashing application, use <code>kubectl run</code> to create a container
that immediately exits:</p><pre tabindex=0><code>kubectl run --image=busybox:1.28 myapp -- false
</code></pre><p>You can see using <code>kubectl describe pod myapp</code> that this container is crashing:</p><pre tabindex=0><code>Containers:
  myapp:
    Image:         busybox
    ...
    Args:
      false
    State:          Waiting
      Reason:       CrashLoopBackOff
    Last State:     Terminated
      Reason:       Error
      Exit Code:    1
</code></pre><p>You can use <code>kubectl debug</code> to create a copy of this Pod with the command
changed to an interactive shell:</p><pre tabindex=0><code>kubectl debug myapp -it --copy-to=myapp-debug --container=myapp -- sh
</code></pre><pre tabindex=0><code>If you don&#39;t see a command prompt, try pressing enter.
/ #
</code></pre><p>Now you have an interactive shell that you can use to perform tasks like
checking filesystem paths or running the container command manually.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><ul><li>To change the command of a specific container you must
specify its name using <code>--container</code> or <code>kubectl debug</code> will instead
create a new container to run the command you specified.</li><li>The <code>-i</code> flag causes <code>kubectl debug</code> to attach to the container by default.
You can prevent this by specifying <code>--attach=false</code>. If your session becomes
disconnected you can reattach using <code>kubectl attach</code>.</li></ul></div><p>Don't forget to clean up the debugging Pod when you're finished with it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod myapp myapp-debug
</span></span></code></pre></div><h3 id=copying-a-pod-while-changing-container-images>Copying a Pod while changing container images</h3><p>In some situations you may want to change a misbehaving Pod from its normal
production container images to an image containing a debugging build or
additional utilities.</p><p>As an example, create a Pod using <code>kubectl run</code>:</p><pre tabindex=0><code>kubectl run myapp --image=busybox:1.28 --restart=Never -- sleep 1d
</code></pre><p>Now use <code>kubectl debug</code> to make a copy and change its container image
to <code>ubuntu</code>:</p><pre tabindex=0><code>kubectl debug myapp --copy-to=myapp-debug --set-image=*=ubuntu
</code></pre><p>The syntax of <code>--set-image</code> uses the same <code>container_name=image</code> syntax as
<code>kubectl set image</code>. <code>*=ubuntu</code> means change the image of all containers
to <code>ubuntu</code>.</p><p>Don't forget to clean up the debugging Pod when you're finished with it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod myapp myapp-debug
</span></span></code></pre></div><h2 id=node-shell-session>Debugging via a shell on the node</h2><p>If none of these approaches work, you can find the Node on which the Pod is
running and create a Pod running on the Node. To create
an interactive shell on a Node using <code>kubectl debug</code>, run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl debug node/mynode -it --image<span style=color:#666>=</span>ubuntu
</span></span></code></pre></div><pre tabindex=0><code>Creating debugging pod node-debugger-mynode-pdx84 with container debugger on node mynode.
If you don&#39;t see a command prompt, try pressing enter.
root@ek8s:/#
</code></pre><p>When creating a debugging session on a node, keep in mind that:</p><ul><li><code>kubectl debug</code> automatically generates the name of the new Pod based on
the name of the Node.</li><li>The root filesystem of the Node will be mounted at <code>/host</code>.</li><li>The container runs in the host IPC, Network, and PID namespaces, although
the pod isn't privileged, so reading some process information may fail,
and <code>chroot /host</code> will fail.</li><li>If you need a privileged pod, create it manually.</li></ul><p>Don't forget to clean up the debugging Pod when you're finished with it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod node-debugger-mynode-pdx84
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-09530217eead8a801ead3ef165c2f591>4.1.7 - Get a Shell to a Running Container</h1><p>This page shows how to use <code>kubectl exec</code> to get a shell to a
running container.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=getting-a-shell-to-a-container>Getting a shell to a container</h2><p>In this exercise, you create a Pod that has one container. The container
runs the nginx image. Here is the configuration file for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/shell-demo.yaml download=application/shell-demo.yaml><code>application/shell-demo.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-shell-demo-yaml")' title="Copy application/shell-demo.yaml to clipboard"></img></div><div class=includecode id=application-shell-demo-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>shell-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>shared-data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>shared-data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/usr/share/nginx/html<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>dnsPolicy</span>:<span style=color:#bbb> </span>Default<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/shell-demo.yaml
</span></span></code></pre></div><p>Verify that the container is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod shell-demo
</span></span></code></pre></div><p>Get a shell to the running container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> --stdin --tty shell-demo -- /bin/bash
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The double dash (<code>--</code>) separates the arguments you want to pass to the command from the kubectl arguments.</div><p>In your shell, list the root directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this inside the container</span>
</span></span><span style=display:flex><span>ls /
</span></span></code></pre></div><p>In your shell, experiment with other commands. Here are
some examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># You can run these example commands inside the container</span>
</span></span><span style=display:flex><span>ls /
</span></span><span style=display:flex><span>cat /proc/mounts
</span></span><span style=display:flex><span>cat /proc/1/maps
</span></span><span style=display:flex><span>apt-get update
</span></span><span style=display:flex><span>apt-get install -y tcpdump
</span></span><span style=display:flex><span>tcpdump
</span></span><span style=display:flex><span>apt-get install -y lsof
</span></span><span style=display:flex><span>lsof
</span></span><span style=display:flex><span>apt-get install -y procps
</span></span><span style=display:flex><span>ps aux
</span></span><span style=display:flex><span>ps aux | grep nginx
</span></span></code></pre></div><h2 id=writing-the-root-page-for-nginx>Writing the root page for nginx</h2><p>Look again at the configuration file for your Pod. The Pod
has an <code>emptyDir</code> volume, and the container mounts the volume
at <code>/usr/share/nginx/html</code>.</p><p>In your shell, create an <code>index.html</code> file in the <code>/usr/share/nginx/html</code>
directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this inside the container</span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;Hello shell demo&#39;</span> &gt; /usr/share/nginx/html/index.html
</span></span></code></pre></div><p>In your shell, send a GET request to the nginx server:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this in the shell inside your container</span>
</span></span><span style=display:flex><span>apt-get update
</span></span><span style=display:flex><span>apt-get install curl
</span></span><span style=display:flex><span>curl http://localhost/
</span></span></code></pre></div><p>The output shows the text that you wrote to the <code>index.html</code> file:</p><pre tabindex=0><code>Hello shell demo
</code></pre><p>When you are finished with your shell, enter <code>exit</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>exit</span> <span style=color:#080;font-style:italic># To quit the shell in the container</span>
</span></span></code></pre></div><h2 id=running-individual-commands-in-a-container>Running individual commands in a container</h2><p>In an ordinary command window, not your shell, list the environment
variables in the running container:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> shell-demo env
</span></span></code></pre></div><p>Experiment with running other commands. Here are some examples:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> shell-demo -- ps aux
</span></span><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> shell-demo -- ls /
</span></span><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> shell-demo -- cat /proc/1/mounts
</span></span></code></pre></div><h2 id=opening-a-shell-when-a-pod-has-more-than-one-container>Opening a shell when a Pod has more than one container</h2><p>If a Pod has more than one container, use <code>--container</code> or <code>-c</code> to
specify a container in the <code>kubectl exec</code> command. For example,
suppose you have a Pod named my-pod, and the Pod has two containers
named <em>main-app</em> and <em>helper-app</em>. The following command would open a
shell to the <em>main-app</em> container.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t my-pod --container main-app -- /bin/bash
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The short options <code>-i</code> and <code>-t</code> are the same as the long options <code>--stdin</code> and <code>--tty</code></div><h2 id=what-s-next>What's next</h2><ul><li>Read about <a href=/docs/reference/generated/kubectl/kubectl-commands/#exec>kubectl exec</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ce321f5c35198a1d9b64d52a98ba705c>4.2 - Troubleshooting Clusters</h1><div class=lead>Debugging common cluster issues.</div><p>This doc is about cluster troubleshooting; we assume you have already ruled out your application as the root cause of the
problem you are experiencing. See
the <a href=/docs/tasks/debug/debug-application/>application troubleshooting guide</a> for tips on application debugging.
You may also visit the <a href=/docs/tasks/debug/>troubleshooting overview document</a> for more information.</p><h2 id=listing-your-cluster>Listing your cluster</h2><p>The first thing to debug in your cluster is if your nodes are all registered correctly.</p><p>Run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p>And verify that all of the nodes you expect to see are present and that they are all in the <code>Ready</code> state.</p><p>To get detailed information about the overall health of your cluster, you can run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info dump
</span></span></code></pre></div><h3 id=example-debugging-a-down-unreachable-node>Example: debugging a down/unreachable node</h3><p>Sometimes when debugging it can be useful to look at the status of a node -- for example, because
you've noticed strange behavior of a Pod that's running on the node, or to find out why a Pod
won't schedule onto the node. As with Pods, you can use <code>kubectl describe node</code> and <code>kubectl get node -o yaml</code> to retrieve detailed information about nodes. For example, here's what you'll see if
a node is down (disconnected from the network, or kubelet dies and won't restart, etc.). Notice
the events that show the node is NotReady, and also notice that the pods are no longer running
(they are evicted after five minutes of NotReady status).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME                     STATUS       ROLES     AGE     VERSION
kube-worker-1            NotReady     &lt;none&gt;    1h      v1.23.3
kubernetes-node-bols     Ready        &lt;none&gt;    1h      v1.23.3
kubernetes-node-st6x     Ready        &lt;none&gt;    1h      v1.23.3
kubernetes-node-unaj     Ready        &lt;none&gt;    1h      v1.23.3
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe node kube-worker-1
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Name:               kube-worker-1
Roles:              &lt;none&gt;
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=kube-worker-1
                    kubernetes.io/os=linux
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /run/containerd/containerd.sock
                    node.alpha.kubernetes.io/ttl: 0
                    volumes.kubernetes.io/controller-managed-attach-detach: true
CreationTimestamp:  Thu, 17 Feb 2022 16:46:30 -0500
Taints:             node.kubernetes.io/unreachable:NoExecute
                    node.kubernetes.io/unreachable:NoSchedule
Unschedulable:      false
Lease:
  HolderIdentity:  kube-worker-1
  AcquireTime:     &lt;unset&gt;
  RenewTime:       Thu, 17 Feb 2022 17:13:09 -0500
Conditions:
  Type                 Status    LastHeartbeatTime                 LastTransitionTime                Reason              Message
  ----                 ------    -----------------                 ------------------                ------              -------
  NetworkUnavailable   False     Thu, 17 Feb 2022 17:09:13 -0500   Thu, 17 Feb 2022 17:09:13 -0500   WeaveIsUp           Weave pod has set this
  MemoryPressure       Unknown   Thu, 17 Feb 2022 17:12:40 -0500   Thu, 17 Feb 2022 17:13:52 -0500   NodeStatusUnknown   Kubelet stopped posting node status.
  DiskPressure         Unknown   Thu, 17 Feb 2022 17:12:40 -0500   Thu, 17 Feb 2022 17:13:52 -0500   NodeStatusUnknown   Kubelet stopped posting node status.
  PIDPressure          Unknown   Thu, 17 Feb 2022 17:12:40 -0500   Thu, 17 Feb 2022 17:13:52 -0500   NodeStatusUnknown   Kubelet stopped posting node status.
  Ready                Unknown   Thu, 17 Feb 2022 17:12:40 -0500   Thu, 17 Feb 2022 17:13:52 -0500   NodeStatusUnknown   Kubelet stopped posting node status.
Addresses:
  InternalIP:  192.168.0.113
  Hostname:    kube-worker-1
Capacity:
  cpu:                2
  ephemeral-storage:  15372232Ki
  hugepages-2Mi:      0
  memory:             2025188Ki
  pods:               110
Allocatable:
  cpu:                2
  ephemeral-storage:  14167048988
  hugepages-2Mi:      0
  memory:             1922788Ki
  pods:               110
System Info:
  Machine ID:                 9384e2927f544209b5d7b67474bbf92b
  System UUID:                aa829ca9-73d7-064d-9019-df07404ad448
  Boot ID:                    5a295a03-aaca-4340-af20-1327fa5dab5c
  Kernel Version:             5.13.0-28-generic
  OS Image:                   Ubuntu 21.10
  Operating System:           linux
  Architecture:               amd64
  Container Runtime Version:  containerd://1.5.9
  Kubelet Version:            v1.23.3
  Kube-Proxy Version:         v1.23.3
Non-terminated Pods:          (4 in total)
  Namespace                   Name                                 CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
  ---------                   ----                                 ------------  ----------  ---------------  -------------  ---
  default                     nginx-deployment-67d4bdd6f5-cx2nz    500m (25%)    500m (25%)  128Mi (6%)       128Mi (6%)     23m
  default                     nginx-deployment-67d4bdd6f5-w6kd7    500m (25%)    500m (25%)  128Mi (6%)       128Mi (6%)     23m
  kube-system                 kube-proxy-dnxbz                     0 (0%)        0 (0%)      0 (0%)           0 (0%)         28m
  kube-system                 weave-net-gjxxp                      100m (5%)     0 (0%)      200Mi (10%)      0 (0%)         28m
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests     Limits
  --------           --------     ------
  cpu                1100m (55%)  1 (50%)
  memory             456Mi (24%)  256Mi (13%)
  ephemeral-storage  0 (0%)       0 (0%)
  hugepages-2Mi      0 (0%)       0 (0%)
Events:
...
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get node kube-worker-1 -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Node<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubeadm.alpha.kubernetes.io/cri-socket</span>:<span style=color:#bbb> </span>/run/containerd/containerd.sock<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>node.alpha.kubernetes.io/ttl</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumes.kubernetes.io/controller-managed-attach-detach</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T21:46:30Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>beta.kubernetes.io/arch</span>:<span style=color:#bbb> </span>amd64<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>beta.kubernetes.io/os</span>:<span style=color:#bbb> </span>linux<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/arch</span>:<span style=color:#bbb> </span>amd64<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/hostname</span>:<span style=color:#bbb> </span>kube-worker-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>linux<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-worker-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;4026&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>98efe7cb-2978-4a0b-842a-1a7bf12c05f8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>addresses</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>address</span>:<span style=color:#bbb> </span><span style=color:#666>192.168.0.113</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>InternalIP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>address</span>:<span style=color:#bbb> </span>kube-worker-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Hostname<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>allocatable</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ephemeral-storage</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;14167048988&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hugepages-2Mi</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>1922788Ki<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pods</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;110&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>capacity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ephemeral-storage</span>:<span style=color:#bbb> </span>15372232Ki<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hugepages-2Mi</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>2025188Ki<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pods</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;110&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conditions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastHeartbeatTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:20:32Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:20:32Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>Weave pod has set this<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>reason</span>:<span style=color:#bbb> </span>WeaveIsUp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;False&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>NetworkUnavailable<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastHeartbeatTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:20:15Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:13:25Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>kubelet has sufficient memory available<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>reason</span>:<span style=color:#bbb> </span>KubeletHasSufficientMemory<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;False&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>MemoryPressure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastHeartbeatTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:20:15Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:13:25Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>kubelet has no disk pressure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>reason</span>:<span style=color:#bbb> </span>KubeletHasNoDiskPressure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;False&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DiskPressure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastHeartbeatTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:20:15Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:13:25Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>kubelet has sufficient PID available<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>reason</span>:<span style=color:#bbb> </span>KubeletHasSufficientPID<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;False&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>PIDPressure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>lastHeartbeatTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:20:15Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>lastTransitionTime</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-02-17T22:15:15Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>kubelet is posting ready status. AppArmor enabled<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>reason</span>:<span style=color:#bbb> </span>KubeletReady<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;True&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Ready<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>daemonEndpoints</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubeletEndpoint</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>Port</span>:<span style=color:#bbb> </span><span style=color:#666>10250</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeInfo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>architecture</span>:<span style=color:#bbb> </span>amd64<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bootID</span>:<span style=color:#bbb> </span><span style=color:#666>22333234</span>-7a6b-44d4-9ce1-67e31dc7e369<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>containerRuntimeVersion</span>:<span style=color:#bbb> </span>containerd://1.5.9<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kernelVersion</span>:<span style=color:#bbb> </span><span style=color:#666>5.13.0-28</span>-generic<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubeProxyVersion</span>:<span style=color:#bbb> </span>v1.23.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubeletVersion</span>:<span style=color:#bbb> </span>v1.23.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>machineID</span>:<span style=color:#bbb> </span>9384e2927f544209b5d7b67474bbf92b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>operatingSystem</span>:<span style=color:#bbb> </span>linux<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>osImage</span>:<span style=color:#bbb> </span>Ubuntu 21.10<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>systemUUID</span>:<span style=color:#bbb> </span>aa829ca9-73d7-064d-9019-df07404ad448<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=looking-at-logs>Looking at logs</h2><p>For now, digging deeper into the cluster requires logging into the relevant machines. Here are the locations
of the relevant log files. On systemd-based systems, you may need to use <code>journalctl</code> instead of examining log files.</p><h3 id=control-plane-nodes>Control Plane nodes</h3><ul><li><code>/var/log/kube-apiserver.log</code> - API Server, responsible for serving the API</li><li><code>/var/log/kube-scheduler.log</code> - Scheduler, responsible for making scheduling decisions</li><li><code>/var/log/kube-controller-manager.log</code> - a component that runs most Kubernetes built-in
<a class=glossary-tooltip title='A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/controller/ target=_blank aria-label=controllers>controllers</a>, with the notable exception of scheduling
(the kube-scheduler handles scheduling).</li></ul><h3 id=worker-nodes>Worker Nodes</h3><ul><li><code>/var/log/kubelet.log</code> - logs from the kubelet, responsible for running containers on the node</li><li><code>/var/log/kube-proxy.log</code> - logs from <code>kube-proxy</code>, which is responsible for directing traffic to Service endpoints</li></ul><h2 id=cluster-failure-modes>Cluster failure modes</h2><p>This is an incomplete list of things that could go wrong, and how to adjust your cluster setup to mitigate the problems.</p><h3 id=contributing-causes>Contributing causes</h3><ul><li>VM(s) shutdown</li><li>Network partition within cluster, or between cluster and users</li><li>Crashes in Kubernetes software</li><li>Data loss or unavailability of persistent storage (e.g. GCE PD or AWS EBS volume)</li><li>Operator error, for example misconfigured Kubernetes software or application software</li></ul><h3 id=specific-scenarios>Specific scenarios</h3><ul><li>API server VM shutdown or apiserver crashing<ul><li>Results<ul><li>unable to stop, update, or start new pods, services, replication controller</li><li>existing pods and services should continue to work normally, unless they depend on the Kubernetes API</li></ul></li></ul></li><li>API server backing storage lost<ul><li>Results<ul><li>the kube-apiserver component fails to start successfully and become healthy</li><li>kubelets will not be able to reach it but will continue to run the same pods and provide the same service proxying</li><li>manual recovery or recreation of apiserver state necessary before apiserver is restarted</li></ul></li></ul></li><li>Supporting services (node controller, replication controller manager, scheduler, etc) VM shutdown or crashes<ul><li>currently those are colocated with the apiserver, and their unavailability has similar consequences as apiserver</li><li>in future, these will be replicated as well and may not be co-located</li><li>they do not have their own persistent state</li></ul></li><li>Individual node (VM or physical machine) shuts down<ul><li>Results<ul><li>pods on that Node stop running</li></ul></li></ul></li><li>Network partition<ul><li>Results<ul><li>partition A thinks the nodes in partition B are down; partition B thinks the apiserver is down.
(Assuming the master VM ends up in partition A.)</li></ul></li></ul></li><li>Kubelet software fault<ul><li>Results<ul><li>crashing kubelet cannot start new pods on the node</li><li>kubelet might delete the pods or not</li><li>node marked unhealthy</li><li>replication controllers start new pods elsewhere</li></ul></li></ul></li><li>Cluster operator error<ul><li>Results<ul><li>loss of pods, services, etc</li><li>lost of apiserver backing store</li><li>users unable to read API</li><li>etc.</li></ul></li></ul></li></ul><h3 id=mitigations>Mitigations</h3><ul><li><p>Action: Use IaaS provider's automatic VM restarting feature for IaaS VMs</p><ul><li>Mitigates: Apiserver VM shutdown or apiserver crashing</li><li>Mitigates: Supporting services VM shutdown or crashes</li></ul></li><li><p>Action: Use IaaS providers reliable storage (e.g. GCE PD or AWS EBS volume) for VMs with apiserver+etcd</p><ul><li>Mitigates: Apiserver backing storage lost</li></ul></li><li><p>Action: Use <a href=/docs/setup/production-environment/tools/kubeadm/high-availability/>high-availability</a> configuration</p><ul><li>Mitigates: Control plane node shutdown or control plane components (scheduler, API server, controller-manager) crashing<ul><li>Will tolerate one or more simultaneous node or component failures</li></ul></li><li>Mitigates: API server backing storage (i.e., etcd's data directory) lost<ul><li>Assumes HA (highly-available) etcd configuration</li></ul></li></ul></li><li><p>Action: Snapshot apiserver PDs/EBS-volumes periodically</p><ul><li>Mitigates: Apiserver backing storage lost</li><li>Mitigates: Some cases of operator error</li><li>Mitigates: Some cases of Kubernetes software fault</li></ul></li><li><p>Action: use replication controller and services in front of pods</p><ul><li>Mitigates: Node shutdown</li><li>Mitigates: Kubelet software fault</li></ul></li><li><p>Action: applications (containers) designed to tolerate unexpected restarts</p><ul><li>Mitigates: Node shutdown</li><li>Mitigates: Kubelet software fault</li></ul></li></ul><h2 id=what-s-next>What's next</h2><ul><li>Learn about the metrics available in the
<a href=/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/>Resource Metrics Pipeline</a></li><li>Discover additional tools for
<a href=/docs/tasks/debug/debug-cluster/resource-usage-monitoring/>monitoring resource usage</a></li><li>Use Node Problem Detector to
<a href=/docs/tasks/debug/debug-cluster/monitor-node-health/>monitor node health</a></li><li>Use <code>crictl</code> to <a href=/docs/tasks/debug/debug-cluster/crictl/>debug Kubernetes nodes</a></li><li>Get more information about <a href=/docs/tasks/debug/debug-cluster/audit/>Kubernetes auditing</a></li><li>Use <code>telepresence</code> to <a href=/docs/tasks/debug/debug-cluster/local-debugging/>develop and debug services locally</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5ff0cdcf7701f887e45d629f5cfe0424>4.2.1 - Resource metrics pipeline</h1><p>For Kubernetes, the <em>Metrics API</em> offers a basic set of metrics to support automatic scaling and
similar use cases. This API makes information available about resource usage for node and pod,
including metrics for CPU and memory. If you deploy the Metrics API into your cluster, clients of
the Kubernetes API can then query for this information, and you can use Kubernetes' access control
mechanisms to manage permissions to do so.</p><p>The <a href=/docs/tasks/run-application/horizontal-pod-autoscale/>HorizontalPodAutoscaler</a> (HPA) and
<a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler#readme>VerticalPodAutoscaler</a> (VPA)
use data from the metrics API to adjust workload replicas and resources to meet customer demand.</p><p>You can also view the resource metrics using the
<a href=/docs/reference/generated/kubectl/kubectl-commands#top><code>kubectl top</code></a>
command.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The Metrics API, and the metrics pipeline that it enables, only offers the minimum
CPU and memory metrics to enable automatic scaling using HPA and / or VPA.
If you would like to provide a more complete set of metrics, you can complement
the simpler Metrics API by deploying a second
<a href=/docs/tasks/debug/debug-cluster/resource-usage-monitoring/#full-metrics-pipeline>metrics pipeline</a>
that uses the <em>Custom Metrics API</em>.</div><p>Figure 1 illustrates the architecture of the resource metrics pipeline.</p><figure><div class=mermaid>flowchart RL
subgraph cluster[Cluster]
direction RL
S[<br><br>]
A[Metrics-<br>Server]
subgraph B[Nodes]
direction TB
D[cAdvisor] --> C[kubelet]
E[Container<br>runtime] --> D
E1[Container<br>runtime] --> D
P[pod data] -.- C
end
L[API<br>server]
W[HPA]
C ---->|Summary<br>API| A -->|metrics<br>API| L --> W
end
L ---> K[kubectl<br>top]
classDef box fill:#fff,stroke:#000,stroke-width:1px,color:#000;
class W,B,P,K,cluster,D,E,E1 box
classDef spacewhite fill:#ffffff,stroke:#fff,stroke-width:0px,color:#000
class S spacewhite
classDef k8s fill:#326ce5,stroke:#fff,stroke-width:1px,color:#fff;
class A,L,C k8s</div></figure><noscript><div class="alert alert-secondary callout" role=alert><em class=javascript-required>JavaScript must be <a href=https://www.enable-javascript.com/>enabled</a> to view this content</em></div></noscript><p>Figure 1. Resource Metrics Pipeline</p><p>The architecture components, from right to left in the figure, consist of the following:</p><ul><li><p><a href=https://github.com/google/cadvisor>cAdvisor</a>: Daemon for collecting, aggregating and exposing
container metrics included in Kubelet.</p></li><li><p><a href=/docs/concepts/overview/components/#kubelet>kubelet</a>: Node agent for managing container
resources. Resource metrics are accessible using the <code>/metrics/resource</code> and <code>/stats</code> kubelet
API endpoints.</p></li><li><p><a href=#summary-api-source>Summary API</a>: API provided by the kubelet for discovering and retrieving
per-node summarized stats available through the <code>/stats</code> endpoint.</p></li><li><p><a href=#metrics-server>metrics-server</a>: Cluster addon component that collects and aggregates resource
metrics pulled from each kubelet. The API server serves Metrics API for use by HPA, VPA, and by
the <code>kubectl top</code> command. Metrics Server is a reference implementation of the Metrics API.</p></li><li><p><a href=#metrics-api>Metrics API</a>: Kubernetes API supporting access to CPU and memory used for
workload autoscaling. To make this work in your cluster, you need an API extension server that
provides the Metrics API.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> cAdvisor supports reading metrics from cgroups, which works with typical container runtimes on Linux.
If you use a container runtime that uses another resource isolation mechanism, for example
virtualization, then that container runtime must support
<a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/cri-container-stats.md>CRI Container Metrics</a>
in order for metrics to be available to the kubelet.</div></li></ul><h2 id=metrics-api>Metrics API</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes 1.8 [beta]</code></div><p>The metrics-server implements the Metrics API. This API allows you to access CPU and memory usage
for the nodes and pods in your cluster. Its primary role is to feed resource usage metrics to K8s
autoscaler components.</p><p>Here is an example of the Metrics API request for a <code>minikube</code> node piped through <code>jq</code> for easier
reading:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get --raw <span style=color:#b44>&#34;/apis/metrics.k8s.io/v1beta1/nodes/minikube&#34;</span> | jq <span style=color:#b44>&#39;.&#39;</span>
</span></span></code></pre></div><p>Here is the same API call using <code>curl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl http://localhost:8080/apis/metrics.k8s.io/v1beta1/nodes/minikube
</span></span></code></pre></div><p>Sample response:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;kind&#34;</span>: <span style=color:#b44>&#34;NodeMetrics&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;apiVersion&#34;</span>: <span style=color:#b44>&#34;metrics.k8s.io/v1beta1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;minikube&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;selfLink&#34;</span>: <span style=color:#b44>&#34;/apis/metrics.k8s.io/v1beta1/nodes/minikube&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;creationTimestamp&#34;</span>: <span style=color:#b44>&#34;2022-01-27T18:48:43Z&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;timestamp&#34;</span>: <span style=color:#b44>&#34;2022-01-27T18:48:33Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;window&#34;</span>: <span style=color:#b44>&#34;30s&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;usage&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;cpu&#34;</span>: <span style=color:#b44>&#34;487558164n&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;memory&#34;</span>: <span style=color:#b44>&#34;732212Ki&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here is an example of the Metrics API request for a <code>kube-scheduler-minikube</code> pod contained in the
<code>kube-system</code> namespace and piped through <code>jq</code> for easier reading:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get --raw <span style=color:#b44>&#34;/apis/metrics.k8s.io/v1beta1/namespaces/kube-system/pods/kube-scheduler-minikube&#34;</span> | jq <span style=color:#b44>&#39;.&#39;</span>
</span></span></code></pre></div><p>Here is the same API call using <code>curl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl http://localhost:8080/apis/metrics.k8s.io/v1beta1/namespaces/kube-system/pods/kube-scheduler-minikube
</span></span></code></pre></div><p>Sample response:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;kind&#34;</span>: <span style=color:#b44>&#34;PodMetrics&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;apiVersion&#34;</span>: <span style=color:#b44>&#34;metrics.k8s.io/v1beta1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;kube-scheduler-minikube&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;namespace&#34;</span>: <span style=color:#b44>&#34;kube-system&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;selfLink&#34;</span>: <span style=color:#b44>&#34;/apis/metrics.k8s.io/v1beta1/namespaces/kube-system/pods/kube-scheduler-minikube&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;creationTimestamp&#34;</span>: <span style=color:#b44>&#34;2022-01-27T19:25:00Z&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;timestamp&#34;</span>: <span style=color:#b44>&#34;2022-01-27T19:24:31Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;window&#34;</span>: <span style=color:#b44>&#34;30s&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;containers&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;kube-scheduler&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;usage&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;cpu&#34;</span>: <span style=color:#b44>&#34;9559630n&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;memory&#34;</span>: <span style=color:#b44>&#34;22244Ki&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The Metrics API is defined in the <a href=https://github.com/kubernetes/metrics>k8s.io/metrics</a>
repository. You must enable the <a href=/docs/tasks/extend-kubernetes/configure-aggregation-layer/>API aggregation layer</a>
and register an <a href=/docs/reference/kubernetes-api/cluster-resources/api-service-v1/>APIService</a>
for the <code>metrics.k8s.io</code> API.</p><p>To learn more about the Metrics API, see <a href=https://git.k8s.io/design-proposals-archive/instrumentation/resource-metrics-api.md>resource metrics API design</a>,
the <a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server repository</a> and the
<a href=https://github.com/kubernetes/metrics#resource-metrics-api>resource metrics API</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> You must deploy the metrics-server or alternative adapter that serves the Metrics API to be able
to access it.</div><h2 id=measuring-resource-usage>Measuring resource usage</h2><h3 id=cpu>CPU</h3><p>CPU is reported as the average core usage measured in cpu units. One cpu, in Kubernetes, is
equivalent to 1 vCPU/Core for cloud providers, and 1 hyper-thread on bare-metal Intel processors.</p><p>This value is derived by taking a rate over a cumulative CPU counter provided by the kernel (in
both Linux and Windows kernels). The time window used to calculate CPU is shown under window field
in Metrics API.</p><p>To learn more about how Kubernetes allocates and measures CPU resources, see
<a href=/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu>meaning of CPU</a>.</p><h3 id=memory>Memory</h3><p>Memory is reported as the working set, measured in bytes, at the instant the metric was collected.</p><p>In an ideal world, the "working set" is the amount of memory in-use that cannot be freed under
memory pressure. However, calculation of the working set varies by host OS, and generally makes
heavy use of heuristics to produce an estimate.</p><p>The Kubernetes model for a container's working set expects that the container runtime counts
anonymous memory associated with the container in question. The working set metric typically also
includes some cached (file-backed) memory, because the host OS cannot always reclaim pages.</p><p>To learn more about how Kubernetes allocates and measures memory resources, see
<a href=/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory>meaning of memory</a>.</p><h2 id=metrics-server>Metrics Server</h2><p>The metrics-server fetches resource metrics from the kubelets and exposes them in the Kubernetes
API server through the Metrics API for use by the HPA and VPA. You can also view these metrics
using the <code>kubectl top</code> command.</p><p>The metrics-server uses the Kubernetes API to track nodes and pods in your cluster. The
metrics-server queries each node over HTTP to fetch metrics. The metrics-server also builds an
internal view of pod metadata, and keeps a cache of pod health. That cached pod health information
is available via the extension API that the metrics-server makes available.</p><p>For example with an HPA query, the metrics-server needs to identify which pods fulfill the label
selectors in the deployment.</p><p>The metrics-server calls the <a href=/docs/reference/command-line-tools-reference/kubelet/>kubelet</a> API
to collect metrics from each node. Depending on the metrics-server version it uses:</p><ul><li>Metrics resource endpoint <code>/metrics/resource</code> in version v0.6.0+ or</li><li>Summary API endpoint <code>/stats/summary</code> in older versions</li></ul><h2 id=what-s-next>What's next</h2><p>To learn more about the metrics-server, see the
<a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server repository</a>.</p><p>You can also check out the following:</p><ul><li><a href=https://git.k8s.io/design-proposals-archive/instrumentation/metrics-server.md>metrics-server design</a></li><li><a href=https://github.com/kubernetes-sigs/metrics-server/blob/master/FAQ.md>metrics-server FAQ</a></li><li><a href=https://github.com/kubernetes-sigs/metrics-server/blob/master/KNOWN_ISSUES.md>metrics-server known issues</a></li><li><a href=https://github.com/kubernetes-sigs/metrics-server/releases>metrics-server releases</a></li><li><a href=/docs/tasks/run-application/horizontal-pod-autoscale/>Horizontal Pod Autoscaling</a></li></ul><p>To learn about how the kubelet serves node metrics, and how you can access those via
the Kubernetes API, read <a href=/docs/reference/instrumentation/node-metrics>Node Metrics Data</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cb9e28c208c6cfbabdb15ba2e42e9ef0>4.2.2 - Tools for Monitoring Resources</h1><p>To scale an application and provide a reliable service, you need to
understand how the application behaves when it is deployed. You can examine
application performance in a Kubernetes cluster by examining the containers,
<a href=/docs/concepts/workloads/pods/>pods</a>,
<a href=/docs/concepts/services-networking/service/>services</a>, and
the characteristics of the overall cluster. Kubernetes provides detailed
information about an application's resource usage at each of these levels.
This information allows you to evaluate your application's performance and
where bottlenecks can be removed to improve overall performance.</p><p>In Kubernetes, application monitoring does not depend on a single monitoring solution.
On new clusters, you can use <a href=#resource-metrics-pipeline>resource metrics</a> or
<a href=#full-metrics-pipeline>full metrics</a> pipelines to collect monitoring statistics.</p><h2 id=resource-metrics-pipeline>Resource metrics pipeline</h2><p>The resource metrics pipeline provides a limited set of metrics related to
cluster components such as the
<a href=/docs/tasks/run-application/horizontal-pod-autoscale/>Horizontal Pod Autoscaler</a>
controller, as well as the <code>kubectl top</code> utility.
These metrics are collected by the lightweight, short-term, in-memory
<a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a> and
are exposed via the <code>metrics.k8s.io</code> API.</p><p>metrics-server discovers all nodes on the cluster and
queries each node's
<a href=/docs/reference/command-line-tools-reference/kubelet/>kubelet</a> for CPU and
memory usage. The kubelet acts as a bridge between the Kubernetes master and
the nodes, managing the pods and containers running on a machine. The kubelet
translates each pod into its constituent containers and fetches individual
container usage statistics from the container runtime through the container
runtime interface. If you use a container runtime that uses Linux cgroups and
namespaces to implement containers, and the container runtime does not publish
usage statistics, then the kubelet can look up those statistics directly
(using code from <a href=https://github.com/google/cadvisor>cAdvisor</a>).
No matter how those statistics arrive, the kubelet then exposes the aggregated pod
resource usage statistics through the metrics-server Resource Metrics API.
This API is served at <code>/metrics/resource/v1beta1</code> on the kubelet's authenticated and
read-only ports.</p><h2 id=full-metrics-pipeline>Full metrics pipeline</h2><p>A full metrics pipeline gives you access to richer metrics. Kubernetes can
respond to these metrics by automatically scaling or adapting the cluster
based on its current state, using mechanisms such as the Horizontal Pod
Autoscaler. The monitoring pipeline fetches metrics from the kubelet and
then exposes them to Kubernetes via an adapter by implementing either the
<code>custom.metrics.k8s.io</code> or <code>external.metrics.k8s.io</code> API.</p><p><a href=https://prometheus.io>Prometheus</a>, a CNCF project, can natively monitor Kubernetes, nodes, and Prometheus itself.
Full metrics pipeline projects that are not part of the CNCF are outside the scope of Kubernetes documentation.</p><h2 id=what-s-next>What's next</h2><p>Learn about additional debugging tools, including:</p><ul><li><a href=/docs/concepts/cluster-administration/logging/>Logging</a></li><li><a href=/docs/tasks/debug/debug-cluster/resource-usage-monitoring/>Monitoring</a></li><li><a href=/docs/tasks/debug/debug-application/get-shell-running-container/>Getting into containers via <code>exec</code></a></li><li><a href=/docs/tasks/extend-kubernetes/http-proxy-access-api/>Connecting to containers via proxies</a></li><li><a href=/docs/tasks/access-application-cluster/port-forward-access-application-cluster/>Connecting to containers via port forwarding</a></li><li><a href=/docs/tasks/debug/debug-cluster/crictl/>Inspect Kubernetes node with crictl</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-20165c8269bed123bfb94fb6e7f85643>4.2.3 - Monitor Node Health</h1><p><em>Node Problem Detector</em> is a daemon for monitoring and reporting about a node's health.
You can run Node Problem Detector as a <code>DaemonSet</code> or as a standalone daemon.
Node Problem Detector collects information about node problems from various daemons
and reports these conditions to the API server as <a href=/docs/concepts/architecture/nodes/#condition>NodeCondition</a>
and <a href=/docs/reference/generated/kubernetes-api/v1.25/#event-v1-core>Event</a>.</p><p>To learn how to install and use Node Problem Detector, see
<a href=https://github.com/kubernetes/node-problem-detector>Node Problem Detector project documentation</a>.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=limitations>Limitations</h2><ul><li><p>Node Problem Detector only supports file based kernel log.
Log tools such as <code>journald</code> are not supported.</p></li><li><p>Node Problem Detector uses the kernel log format for reporting kernel issues.
To learn how to extend the kernel log format, see <a href=#support-other-log-format>Add support for another log format</a>.</p></li></ul><h2 id=enabling-node-problem-detector>Enabling Node Problem Detector</h2><p>Some cloud providers enable Node Problem Detector as an <a class=glossary-tooltip title='Resources that extend the functionality of Kubernetes.' data-toggle=tooltip data-placement=top href=/docs/concepts/cluster-administration/addons/ target=_blank aria-label=Addon>Addon</a>.
You can also enable Node Problem Detector with <code>kubectl</code> or by creating an Addon pod.</p><h3 id=using-kubectl>Using kubectl to enable Node Problem Detector</h3><p><code>kubectl</code> provides the most flexible management of Node Problem Detector.
You can overwrite the default configuration to fit it into your environment or
to detect customized node problems. For example:</p><ol><li><p>Create a Node Problem Detector configuration similar to <code>node-problem-detector.yaml</code>:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/debug/node-problem-detector.yaml download=debug/node-problem-detector.yaml><code>debug/node-problem-detector.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("debug-node-problem-detector-yaml")' title="Copy debug/node-problem-detector.yaml to clipboard"></img></div><div class=includecode id=debug-node-problem-detector-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector-v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector  <span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/node-problem-detector:v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>privileged</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200m&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20m&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20Mi&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/log/</span></span></code></pre></div></div></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> You should verify that the system log directory is right for your operating system distribution.</div></li><li><p>Start node problem detector with <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/debug/node-problem-detector.yaml
</span></span></code></pre></div></li></ol><h3 id=using-addon-pod>Using an Addon pod to enable Node Problem Detector</h3><p>If you are using a custom cluster bootstrap solution and don't need
to overwrite the default configuration, you can leverage the Addon pod to
further automate the deployment.</p><p>Create <code>node-problem-detector.yaml</code>, and save the configuration in the Addon pod's
directory <code>/etc/kubernetes/addons/node-problem-detector</code> on a control plane node.</p><h2 id=overwrite-the-configuration>Overwrite the configuration</h2><p>The <a href=https://github.com/kubernetes/node-problem-detector/tree/v0.1/config>default configuration</a>
is embedded when building the Docker image of Node Problem Detector.</p><p>However, you can use a <a href=/docs/tasks/configure-pod-container/configure-pod-configmap/><code>ConfigMap</code></a>
to overwrite the configuration:</p><ol><li><p>Change the configuration files in <code>config/</code></p></li><li><p>Create the <code>ConfigMap</code> <code>node-problem-detector-config</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap node-problem-detector-config --from-file<span style=color:#666>=</span>config/
</span></span></code></pre></div></li><li><p>Change the <code>node-problem-detector.yaml</code> to use the <code>ConfigMap</code>:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/debug/node-problem-detector-configmap.yaml download=debug/node-problem-detector-configmap.yaml><code>debug/node-problem-detector-configmap.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("debug-node-problem-detector-configmap-yaml")' title="Copy debug/node-problem-detector-configmap.yaml to clipboard"></img></div><div class=includecode id=debug-node-problem-detector-configmap-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector-v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector  <span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/node-problem-detector:v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>privileged</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200m&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20m&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20Mi&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Overwrite the config/ directory with ConfigMap volume</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/config<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/log/<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Define ConfigMap volume</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector-config</span></span></code></pre></div></div></div></li><li><p>Recreate the Node Problem Detector with the new configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># If you have a node-problem-detector running, delete before recreating</span>
</span></span><span style=display:flex><span>kubectl delete -f https://k8s.io/examples/debug/node-problem-detector.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/debug/node-problem-detector-configmap.yaml
</span></span></code></pre></div></li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This approach only applies to a Node Problem Detector started with <code>kubectl</code>.</div><p>Overwriting a configuration is not supported if a Node Problem Detector runs as a cluster Addon.
The Addon manager does not support <code>ConfigMap</code>.</p><h2 id=kernel-monitor>Kernel Monitor</h2><p><em>Kernel Monitor</em> is a system log monitor daemon supported in the Node Problem Detector.
Kernel monitor watches the kernel log and detects known kernel issues following predefined rules.</p><p>The Kernel Monitor matches kernel issues according to a set of predefined rule list in
<a href=https://github.com/kubernetes/node-problem-detector/blob/v0.1/config/kernel-monitor.json><code>config/kernel-monitor.json</code></a>. The rule list is extensible. You can expand the rule list by overwriting the
configuration.</p><h3 id=add-new-nodeconditions>Add new NodeConditions</h3><p>To support a new <code>NodeCondition</code>, create a condition definition within the <code>conditions</code> field in
<code>config/kernel-monitor.json</code>, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;type&#34;</span>: <span style=color:#b44>&#34;NodeConditionType&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;reason&#34;</span>: <span style=color:#b44>&#34;CamelCaseDefaultNodeConditionReason&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;message&#34;</span>: <span style=color:#b44>&#34;arbitrary default node condition message&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=detect-new-problems>Detect new problems</h3><p>To detect new problems, you can extend the <code>rules</code> field in <code>config/kernel-monitor.json</code>
with a new rule definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;type&#34;</span>: <span style=color:#b44>&#34;temporary/permanent&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;condition&#34;</span>: <span style=color:#b44>&#34;NodeConditionOfPermanentIssue&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;reason&#34;</span>: <span style=color:#b44>&#34;CamelCaseShortReason&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;message&#34;</span>: <span style=color:#b44>&#34;regexp matching the issue in the kernel log&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=kernel-log-device-path>Configure path for the kernel log device</h3><p>Check your kernel log path location in your operating system (OS) distribution.
The Linux kernel <a href=https://www.kernel.org/doc/Documentation/ABI/testing/dev-kmsg>log device</a> is usually presented as <code>/dev/kmsg</code>. However, the log path location varies by OS distribution.
The <code>log</code> field in <code>config/kernel-monitor.json</code> represents the log path inside the container.
You can configure the <code>log</code> field to match the device path as seen by the Node Problem Detector.</p><h3 id=support-other-log-format>Add support for another log format</h3><p>Kernel monitor uses the
<a href=https://github.com/kubernetes/node-problem-detector/blob/v0.1/pkg/kernelmonitor/translator/translator.go><code>Translator</code></a> plugin to translate the internal data structure of the kernel log.
You can implement a new translator for a new log format.</p><h2 id=recommendations-and-restrictions>Recommendations and restrictions</h2><p>It is recommended to run the Node Problem Detector in your cluster to monitor node health.
When running the Node Problem Detector, you can expect extra resource overhead on each node.
Usually this is fine, because:</p><ul><li>The kernel log grows relatively slowly.</li><li>A resource limit is set for the Node Problem Detector.</li><li>Even under high load, the resource usage is acceptable. For more information, see the Node Problem Detector
<a href=https://github.com/kubernetes/node-problem-detector/issues/2#issuecomment-220255629>benchmark result</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6ca4f22ef4d1713577ada4815f0a3b5a>4.2.4 - Debugging Kubernetes nodes with crictl</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.11 [stable]</code></div><p><code>crictl</code> is a command-line interface for CRI-compatible container runtimes.
You can use it to inspect and debug container runtimes and applications on a
Kubernetes node. <code>crictl</code> and its source are hosted in the
<a href=https://github.com/kubernetes-sigs/cri-tools>cri-tools</a> repository.</p><h2 id=before-you-begin>Before you begin</h2><p><code>crictl</code> requires a Linux operating system with a CRI runtime.</p><h2 id=installing-crictl>Installing crictl</h2><p>You can download a compressed archive <code>crictl</code> from the cri-tools
<a href=https://github.com/kubernetes-sigs/cri-tools/releases>release page</a>, for several
different architectures. Download the version that corresponds to your version
of Kubernetes. Extract it and move it to a location on your system path, such as
<code>/usr/local/bin/</code>.</p><h2 id=general-usage>General usage</h2><p>The <code>crictl</code> command has several subcommands and runtime flags. Use
<code>crictl help</code> or <code>crictl &lt;subcommand> help</code> for more details.</p><p>You can set the endpoint for <code>crictl</code> by doing one of the following:</p><ul><li>Set the <code>--runtime-endpoint</code> and <code>--image-endpoint</code> flags.</li><li>Set the <code>CONTAINER_RUNTIME_ENDPOINT</code> and <code>IMAGE_SERVICE_ENDPOINT</code> environment
variables.</li><li>Set the endpoint in the configuration file <code>/etc/crictl.yaml</code>. To specify a
different file, use the <code>--config=PATH_TO_FILE</code> flag when you run <code>crictl</code>.</li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you don't set an endpoint, <code>crictl</code> attempts to connect to a list of known
endpoints, which might result in an impact to performance.</div><p>You can also specify timeout values when connecting to the server and enable or
disable debugging, by specifying <code>timeout</code> or <code>debug</code> values in the configuration
file or using the <code>--timeout</code> and <code>--debug</code> command-line flags.</p><p>To view or edit the current configuration, view or edit the contents of
<code>/etc/crictl.yaml</code>. For example, the configuration when using the <code>containerd</code>
container runtime would be similar to this:</p><pre tabindex=0><code>runtime-endpoint: unix:///var/run/containerd/containerd.sock
image-endpoint: unix:///var/run/containerd/containerd.sock
timeout: 10
debug: true
</code></pre><p>To learn more about <code>crictl</code>, refer to the <a href=https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md><code>crictl</code>
documentation</a>.</p><h2 id=example-crictl-commands>Example crictl commands</h2><p>The following examples show some <code>crictl</code> commands and example output.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> If you use <code>crictl</code> to create pod sandboxes or containers on a running
Kubernetes cluster, the Kubelet will eventually delete them. <code>crictl</code> is not a
general purpose workflow tool, but a tool that is useful for debugging.</div><h3 id=list-pods>List pods</h3><p>List all pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl pods
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>POD ID              CREATED              STATE               NAME                         NAMESPACE           ATTEMPT
926f1b5a1d33a       About a minute ago   Ready               sh-84d7dcf559-4r2gq          default             0
4dccb216c4adb       About a minute ago   Ready               nginx-65899c769f-wv2gp       default             0
a86316e96fa89       17 hours ago         Ready               kube-proxy-gblk4             kube-system         0
919630b8f81f1       17 hours ago         Ready               nvidia-device-plugin-zgbbv   kube-system         0
</code></pre><p>List pods by name:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl pods --name nginx-65899c769f-wv2gp
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>POD ID              CREATED             STATE               NAME                     NAMESPACE           ATTEMPT
4dccb216c4adb       2 minutes ago       Ready               nginx-65899c769f-wv2gp   default             0
</code></pre><p>List pods by label:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl pods --label <span style=color:#b8860b>run</span><span style=color:#666>=</span>nginx
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>POD ID              CREATED             STATE               NAME                     NAMESPACE           ATTEMPT
4dccb216c4adb       2 minutes ago       Ready               nginx-65899c769f-wv2gp   default             0
</code></pre><h3 id=list-images>List images</h3><p>List all images:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl images
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>IMAGE                                     TAG                 IMAGE ID            SIZE
busybox                                   latest              8c811b4aec35f       1.15MB
k8s-gcrio.azureedge.net/hyperkube-amd64   v1.10.3             e179bbfe5d238       665MB
k8s-gcrio.azureedge.net/pause-amd64       3.1                 da86e6ba6ca19       742kB
nginx                                     latest              cd5239a0906a6       109MB
</code></pre><p>List images by repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl images nginx
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>IMAGE               TAG                 IMAGE ID            SIZE
nginx               latest              cd5239a0906a6       109MB
</code></pre><p>Only list image IDs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl images -q
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>sha256:8c811b4aec35f259572d0f79207bc0678df4c736eeec50bc9fec37ed936a472a
sha256:e179bbfe5d238de6069f3b03fccbecc3fb4f2019af741bfff1233c4d7b2970c5
sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e
sha256:cd5239a0906a6ccf0562354852fae04bc5b52d72a2aff9a871ddb6bd57553569
</code></pre><h3 id=list-containers>List containers</h3><p>List all containers:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl ps -a
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>CONTAINER ID        IMAGE                                                                                                             CREATED             STATE               NAME                       ATTEMPT
1f73f2d81bf98       busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47                                   7 minutes ago       Running             sh                         1
9c5951df22c78       busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47                                   8 minutes ago       Exited              sh                         0
87d3992f84f74       nginx@sha256:d0a8828cccb73397acb0073bf34f4d7d8aa315263f1e7806bf8c55d8ac139d5f                                     8 minutes ago       Running             nginx                      0
1941fb4da154f       k8s-gcrio.azureedge.net/hyperkube-amd64@sha256:00d814b1f7763f4ab5be80c58e98140dfc69df107f253d7fdd714b30a714260a   18 hours ago        Running             kube-proxy                 0
</code></pre><p>List running containers:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl ps
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>CONTAINER ID        IMAGE                                                                                                             CREATED             STATE               NAME                       ATTEMPT
1f73f2d81bf98       busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47                                   6 minutes ago       Running             sh                         1
87d3992f84f74       nginx@sha256:d0a8828cccb73397acb0073bf34f4d7d8aa315263f1e7806bf8c55d8ac139d5f                                     7 minutes ago       Running             nginx                      0
1941fb4da154f       k8s-gcrio.azureedge.net/hyperkube-amd64@sha256:00d814b1f7763f4ab5be80c58e98140dfc69df107f253d7fdd714b30a714260a   17 hours ago        Running             kube-proxy                 0
</code></pre><h3 id=execute-a-command-in-a-running-container>Execute a command in a running container</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl <span style=color:#a2f>exec</span> -i -t 1f73f2d81bf98 ls
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>bin   dev   etc   home  proc  root  sys   tmp   usr   var
</code></pre><h3 id=get-a-container-s-logs>Get a container's logs</h3><p>Get all container logs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl logs 87d3992f84f74
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>10.240.0.96 - - [06/Jun/2018:02:45:49 +0000] &#34;GET / HTTP/1.1&#34; 200 612 &#34;-&#34; &#34;curl/7.47.0&#34; &#34;-&#34;
10.240.0.96 - - [06/Jun/2018:02:45:50 +0000] &#34;GET / HTTP/1.1&#34; 200 612 &#34;-&#34; &#34;curl/7.47.0&#34; &#34;-&#34;
10.240.0.96 - - [06/Jun/2018:02:45:51 +0000] &#34;GET / HTTP/1.1&#34; 200 612 &#34;-&#34; &#34;curl/7.47.0&#34; &#34;-&#34;
</code></pre><p>Get only the latest <code>N</code> lines of logs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl logs --tail<span style=color:#666>=</span><span style=color:#666>1</span> 87d3992f84f74
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>10.240.0.96 - - [06/Jun/2018:02:45:51 +0000] &#34;GET / HTTP/1.1&#34; 200 612 &#34;-&#34; &#34;curl/7.47.0&#34; &#34;-&#34;
</code></pre><h3 id=run-a-pod-sandbox>Run a pod sandbox</h3><p>Using <code>crictl</code> to run a pod sandbox is useful for debugging container runtimes.
On a running Kubernetes cluster, the sandbox will eventually be stopped and
deleted by the Kubelet.</p><ol><li><p>Create a JSON file like the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;nginx-sandbox&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;namespace&#34;</span>: <span style=color:#b44>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;attempt&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;uid&#34;</span>: <span style=color:#b44>&#34;hdishd83djaidwnduwk28bcsb&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;log_directory&#34;</span>: <span style=color:#b44>&#34;/tmp&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;linux&#34;</span>: {
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>Use the <code>crictl runp</code> command to apply the JSON and run the sandbox.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl runp pod-config.json
</span></span></code></pre></div><p>The ID of the sandbox is returned.</p></li></ol><h3 id=create-a-container>Create a container</h3><p>Using <code>crictl</code> to create a container is useful for debugging container runtimes.
On a running Kubernetes cluster, the sandbox will eventually be stopped and
deleted by the Kubelet.</p><ol><li><p>Pull a busybox image</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl pull busybox
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Image is up to date for busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47
</code></pre></li><li><p>Create configs for the pod and the container:</p><p><strong>Pod config</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;busybox-sandbox&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;namespace&#34;</span>: <span style=color:#b44>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;attempt&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;uid&#34;</span>: <span style=color:#b44>&#34;aewi4aeThua7ooShohbo1phoj&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;log_directory&#34;</span>: <span style=color:#b44>&#34;/tmp&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;linux&#34;</span>: {
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Container config</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;busybox&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;image&#34;</span>:{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;image&#34;</span>: <span style=color:#b44>&#34;busybox&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;command&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;top&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;log_path&#34;</span>:<span style=color:#b44>&#34;busybox.log&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;linux&#34;</span>: {
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>Create the container, passing the ID of the previously-created pod, the
container config file, and the pod config file. The ID of the container is
returned.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl create f84dd361f8dc51518ed291fbadd6db537b0496536c1d2d6c05ff943ce8c9a54f container-config.json pod-config.json
</span></span></code></pre></div></li><li><p>List all containers and verify that the newly-created container has its
state set to <code>Created</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl ps -a
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>CONTAINER ID        IMAGE               CREATED             STATE               NAME                ATTEMPT
3e025dd50a72d       busybox             32 seconds ago      Created             busybox             0
</code></pre></li></ol><h3 id=start-a-container>Start a container</h3><p>To start a container, pass its ID to <code>crictl start</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl start 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60
</code></pre><p>Check the container has its state set to <code>Running</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl ps
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>CONTAINER ID   IMAGE    CREATED              STATE    NAME     ATTEMPT
3e025dd50a72d  busybox  About a minute ago   Running  busybox  0
</code></pre><h2 id=what-s-next>What's next</h2><ul><li><a href=https://github.com/kubernetes-sigs/cri-tools>Learn more about <code>crictl</code></a>.</li><li><a href=/docs/reference/tools/map-crictl-dockercli/>Map <code>docker</code> CLI commands to <code>crictl</code></a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-38387ad04dd284933cb502944ea3515b>4.2.5 - Auditing</h1><p>Kubernetes <em>auditing</em> provides a security-relevant, chronological set of records documenting
the sequence of actions in a cluster. The cluster audits the activities generated by users,
by applications that use the Kubernetes API, and by the control plane itself.</p><p>Auditing allows cluster administrators to answer the following questions:</p><ul><li>what happened?</li><li>when did it happen?</li><li>who initiated it?</li><li>on what did it happen?</li><li>where was it observed?</li><li>from where was it initiated?</li><li>to where was it going?</li></ul><p>Audit records begin their lifecycle inside the
<a href=/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver</a>
component. Each request on each stage
of its execution generates an audit event, which is then pre-processed according to
a certain policy and written to a backend. The policy determines what's recorded
and the backends persist the records. The current backend implementations
include logs files and webhooks.</p><p>Each request can be recorded with an associated <em>stage</em>. The defined stages are:</p><ul><li><code>RequestReceived</code> - The stage for events generated as soon as the audit
handler receives the request, and before it is delegated down the handler
chain.</li><li><code>ResponseStarted</code> - Once the response headers are sent, but before the
response body is sent. This stage is only generated for long-running requests
(e.g. watch).</li><li><code>ResponseComplete</code> - The response body has been completed and no more bytes
will be sent.</li><li><code>Panic</code> - Events generated when a panic occurred.</li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The configuration of an
<a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Event>Audit Event configuration</a>
is different from the
<a href=/docs/reference/generated/kubernetes-api/v1.25/#event-v1-core>Event</a>
API object.</div><p>The audit logging feature increases the memory consumption of the API server
because some context required for auditing is stored for each request.
Memory consumption depends on the audit logging configuration.</p><h2 id=audit-policy>Audit policy</h2><p>Audit policy defines rules about what events should be recorded and what data
they should include. The audit policy object structure is defined in the
<a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy><code>audit.k8s.io</code> API group</a>.
When an event is processed, it's
compared against the list of rules in order. The first matching rule sets the
<em>audit level</em> of the event. The defined audit levels are:</p><ul><li><code>None</code> - don't log events that match this rule.</li><li><code>Metadata</code> - log request metadata (requesting user, timestamp, resource,
verb, etc.) but not request or response body.</li><li><code>Request</code> - log event metadata and request body but not response body.
This does not apply for non-resource requests.</li><li><code>RequestResponse</code> - log event metadata, request and response bodies.
This does not apply for non-resource requests.</li></ul><p>You can pass a file with the policy to <code>kube-apiserver</code>
using the <code>--audit-policy-file</code> flag. If the flag is omitted, no events are logged.
Note that the <code>rules</code> field <strong>must</strong> be provided in the audit policy file.
A policy with no (0) rules is treated as illegal.</p><p>Below is an example audit policy file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/audit/audit-policy.yaml download=audit/audit-policy.yaml><code>audit/audit-policy.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("audit-audit-policy-yaml")' title="Copy audit/audit-policy.yaml to clipboard"></img></div><div class=includecode id=audit-audit-policy-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>audit.k8s.io/v1<span style=color:#bbb> </span><span style=color:#080;font-style:italic># This is required.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Policy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Don&#39;t generate audit events for all requests in RequestReceived stage.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>omitStages</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:#b44>&#34;RequestReceived&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log pod changes at RequestResponse level</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>RequestResponse<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Resource &#34;pods&#34; doesn&#39;t match requests to any subresource of pods,</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># which is consistent with the RBAC policy.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;pods&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log &#34;pods/log&#34;, &#34;pods/status&#34; at Metadata level</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Metadata<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;pods/log&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;pods/status&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Don&#39;t log requests to a configmap called &#34;controller-leader&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;configmaps&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resourceNames</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;controller-leader&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Don&#39;t log watch requests by the &#34;system:kube-proxy&#34; on endpoints or services</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;system:kube-proxy&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;watch&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># core API group</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;endpoints&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;services&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Don&#39;t log authenticated requests to certain non-resource URL paths.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>userGroups</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;system:authenticated&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>nonResourceURLs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;/api*&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># Wildcard matching.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;/version&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log the request body of configmap changes in kube-system.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Request<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># core API group</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;configmaps&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This rule only applies to resources in the &#34;kube-system&#34; namespace.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The empty string &#34;&#34; can be used to select non-namespaced resources.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespaces</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;kube-system&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log configmap and secret changes in all other namespaces at the Metadata level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Metadata<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># core API group</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;secrets&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;configmaps&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log all other resources in core and extensions at the Request level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Request<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># core API group</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;extensions&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># Version of group should NOT be included.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># A catch-all rule to log all other requests at the Metadata level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Metadata<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Long-running requests like watches that fall under this rule will not</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># generate an audit event in RequestReceived.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>omitStages</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;RequestReceived&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>You can use a minimal audit policy file to log all requests at the <code>Metadata</code> level:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Log all requests at the Metadata level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>audit.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Policy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Metadata<span style=color:#bbb>
</span></span></span></code></pre></div><p>If you're crafting your own audit profile, you can use the audit profile for Google Container-Optimized OS as a starting point. You can check the
<a href=https://github.com/kubernetes/kubernetes/blob/master/cluster/gce/gci/configure-helper.sh>configure-helper.sh</a>
script, which generates an audit policy file. You can see most of the audit policy file by looking directly at the script.</p><p>You can also refer to the <a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy><code>Policy</code> configuration reference</a>
for details about the fields defined.</p><h2 id=audit-backends>Audit backends</h2><p>Audit backends persist audit events to an external storage.
Out of the box, the kube-apiserver provides two backends:</p><ul><li>Log backend, which writes events into the filesystem</li><li>Webhook backend, which sends events to an external HTTP API</li></ul><p>In all cases, audit events follow a structure defined by the Kubernetes API in the
<a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Event><code>audit.k8s.io</code> API group</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>In case of patches, request body is a JSON array with patch operations, not a JSON object
with an appropriate Kubernetes API object. For example, the following request body is a valid patch
request to <code>/apis/batch/v1/namespaces/some-namespace/jobs/some-job-name</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;op&#34;</span>: <span style=color:#b44>&#34;replace&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;path&#34;</span>: <span style=color:#b44>&#34;/spec/parallelism&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;value&#34;</span>: <span style=color:#666>0</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;op&#34;</span>: <span style=color:#b44>&#34;remove&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;path&#34;</span>: <span style=color:#b44>&#34;/spec/template/spec/containers/0/terminationMessagePolicy&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div></div><h3 id=log-backend>Log backend</h3><p>The log backend writes audit events to a file in <a href=https://jsonlines.org/>JSONlines</a> format.
You can configure the log audit backend using the following <code>kube-apiserver</code> flags:</p><ul><li><code>--audit-log-path</code> specifies the log file path that log backend uses to write
audit events. Not specifying this flag disables log backend. <code>-</code> means standard out</li><li><code>--audit-log-maxage</code> defined the maximum number of days to retain old audit log files</li><li><code>--audit-log-maxbackup</code> defines the maximum number of audit log files to retain</li><li><code>--audit-log-maxsize</code> defines the maximum size in megabytes of the audit log file before it gets rotated</li></ul><p>If your cluster's control plane runs the kube-apiserver as a Pod, remember to mount the <code>hostPath</code>
to the location of the policy file and log file, so that audit records are persisted. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>    --audit-policy-file<span style=color:#666>=</span>/etc/kubernetes/audit-policy.yaml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --audit-log-path<span style=color:#666>=</span>/var/log/kubernetes/audit/audit.log
</span></span></code></pre></div><p>then mount the volumes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/audit-policy.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/log/kubernetes/audit/<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit-log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>and finally configure the <code>hostPath</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/audit-policy.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>File<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit-log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/log/kubernetes/audit/<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DirectoryOrCreate<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=webhook-backend>Webhook backend</h3><p>The webhook audit backend sends audit events to a remote web API, which is assumed to
be a form of the Kubernetes API, including means of authentication. You can configure
a webhook audit backend using the following kube-apiserver flags:</p><ul><li><code>--audit-webhook-config-file</code> specifies the path to a file with a webhook
configuration. The webhook configuration is effectively a specialized
<a href=/docs/tasks/access-application-cluster/configure-access-multiple-clusters>kubeconfig</a>.</li><li><code>--audit-webhook-initial-backoff</code> specifies the amount of time to wait after the first failed
request before retrying. Subsequent requests are retried with exponential backoff.</li></ul><p>The webhook config file uses the kubeconfig format to specify the remote address of
the service and credentials used to connect to it.</p><h2 id=batching>Event batching</h2><p>Both log and webhook backends support batching. Using webhook as an example, here's the list of
available flags. To get the same flag for log backend, replace <code>webhook</code> with <code>log</code> in the flag
name. By default, batching is enabled in <code>webhook</code> and disabled in <code>log</code>. Similarly, by default
throttling is enabled in <code>webhook</code> and disabled in <code>log</code>.</p><ul><li><code>--audit-webhook-mode</code> defines the buffering strategy. One of the following:<ul><li><code>batch</code> - buffer events and asynchronously process them in batches. This is the default.</li><li><code>blocking</code> - block API server responses on processing each individual event.</li><li><code>blocking-strict</code> - Same as blocking, but when there is a failure during audit logging at the
RequestReceived stage, the whole request to the kube-apiserver fails.</li></ul></li></ul><p>The following flags are used only in the <code>batch</code> mode:</p><ul><li><code>--audit-webhook-batch-buffer-size</code> defines the number of events to buffer before batching.
If the rate of incoming events overflows the buffer, events are dropped.</li><li><code>--audit-webhook-batch-max-size</code> defines the maximum number of events in one batch.</li><li><code>--audit-webhook-batch-max-wait</code> defines the maximum amount of time to wait before unconditionally
batching events in the queue.</li><li><code>--audit-webhook-batch-throttle-qps</code> defines the maximum average number of batches generated
per second.</li><li><code>--audit-webhook-batch-throttle-burst</code> defines the maximum number of batches generated at the same
moment if the allowed QPS was underutilized previously.</li></ul><h2 id=parameter-tuning>Parameter tuning</h2><p>Parameters should be set to accommodate the load on the API server.</p><p>For example, if kube-apiserver receives 100 requests each second, and each request is audited only
on <code>ResponseStarted</code> and <code>ResponseComplete</code> stages, you should account for ≅200 audit
events being generated each second. Assuming that there are up to 100 events in a batch,
you should set throttling level at least 2 queries per second. Assuming that the backend can take up to
5 seconds to write events, you should set the buffer size to hold up to 5 seconds of events;
that is: 10 batches, or 1000 events.</p><p>In most cases however, the default parameters should be sufficient and you don't have to worry about
setting them manually. You can look at the following Prometheus metrics exposed by kube-apiserver
and in the logs to monitor the state of the auditing subsystem.</p><ul><li><code>apiserver_audit_event_total</code> metric contains the total number of audit events exported.</li><li><code>apiserver_audit_error_total</code> metric contains the total number of events dropped due to an error
during exporting.</li></ul><h3 id=truncate>Log entry truncation</h3><p>Both log and webhook backends support limiting the size of events that are logged.
As an example, the following is the list of flags available for the log backend:</p><ul><li><code>audit-log-truncate-enabled</code> whether event and batch truncating is enabled.</li><li><code>audit-log-truncate-max-batch-size</code> maximum size in bytes of the batch sent to the underlying backend.</li><li><code>audit-log-truncate-max-event-size</code> maximum size in bytes of the audit event sent to the underlying backend.</li></ul><p>By default truncate is disabled in both <code>webhook</code> and <code>log</code>, a cluster administrator should set
<code>audit-log-truncate-enabled</code> or <code>audit-webhook-truncate-enabled</code> to enable the feature.</p><h2 id=what-s-next>What's next</h2><ul><li>Learn about <a href=/docs/reference/access-authn-authz/extensible-admission-controllers/#mutating-webhook-auditing-annotations>Mutating webhook auditing annotations</a>.</li><li>Learn more about <a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Event><code>Event</code></a>
and the <a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy><code>Policy</code></a>
resource types by reading the Audit configuration reference.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-60dca0ec8d41f0045e7d73e1d6bd7bce>4.2.6 - Developing and debugging services locally using telepresence</h1><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>Kubernetes applications usually consist of multiple, separate services, each running in its own container. Developing and debugging these services on a remote Kubernetes cluster can be cumbersome, requiring you to <a href=/docs/tasks/debug/debug-application/get-shell-running-container/>get a shell on a running container</a> in order to run debugging tools.</p><p><code>telepresence</code> is a tool to ease the process of developing and debugging services locally while proxying the service to a remote Kubernetes cluster. Using <code>telepresence</code> allows you to use custom tools, such as a debugger and IDE, for a local service and provides the service full access to ConfigMap, secrets, and the services running on the remote cluster.</p><p>This document describes using <code>telepresence</code> to develop and debug services running on a remote cluster locally.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>Kubernetes cluster is installed</li><li><code>kubectl</code> is configured to communicate with the cluster</li><li><a href=https://www.telepresence.io/docs/latest/install/>Telepresence</a> is installed</li></ul><h2 id=connecting-your-local-machine-to-a-remote-kubernetes-cluster>Connecting your local machine to a remote Kubernetes cluster</h2><p>After installing <code>telepresence</code>, run <code>telepresence connect</code> to launch its Daemon and connect your local workstation to the cluster.</p><pre tabindex=0><code>$ telepresence connect
 
Launching Telepresence Daemon
...
Connected to context default (https://&lt;cluster public IP&gt;)
</code></pre><p>You can curl services using the Kubernetes syntax e.g. <code>curl -ik https://kubernetes.default</code></p><h2 id=developing-or-debugging-an-existing-service>Developing or debugging an existing service</h2><p>When developing an application on Kubernetes, you typically program or debug a single service. The service might require access to other services for testing and debugging. One option is to use the continuous deployment pipeline, but even the fastest deployment pipeline introduces a delay in the program or debug cycle.</p><p>Use the <code>telepresence intercept $SERVICE_NAME --port $LOCAL_PORT:$REMOTE_PORT</code> command to create an "intercept" for rerouting remote service traffic.</p><p>Where:</p><ul><li><code>$SERVICE_NAME</code> is the name of your local service</li><li><code>$LOCAL_PORT</code> is the port that your service is running on your local workstation</li><li>And <code>$REMOTE_PORT</code> is the port your service listens to in the cluster</li></ul><p>Running this command tells Telepresence to send remote traffic to your local service instead of the service in the remote Kubernetes cluster. Make edits to your service source code locally, save, and see the corresponding changes when accessing your remote application take effect immediately. You can also run your local service using a debugger or any other local development tool.</p><h2 id=how-does-telepresence-work>How does Telepresence work?</h2><p>Telepresence installs a traffic-agent sidecar next to your existing application's container running in the remote cluster. It then captures all traffic requests going into the Pod, and instead of forwarding this to the application in the remote cluster, it routes all traffic (when you create a <a href=https://www.getambassador.io/docs/telepresence/latest/concepts/intercepts/#global-intercept>global intercept</a>) or a subset of the traffic (when you create a <a href=https://www.getambassador.io/docs/telepresence/latest/concepts/intercepts/#personal-intercept>personal intercept</a>) to your local development environment.</p><h2 id=what-s-next>What's next</h2><p>If you're interested in a hands-on tutorial, check out <a href=https://cloud.google.com/community/tutorials/developing-services-with-k8s>this tutorial</a> that walks through locally developing the Guestbook application on Google Kubernetes Engine.</p><p>For further reading, visit the <a href=https://www.telepresence.io>Telepresence website</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-34f51c9306a166418b33355c09e672be>4.2.7 - Windows debugging tips</h1><h2 id=troubleshooting-node>Node-level troubleshooting</h2><ol><li><p>My Pods are stuck at "Container Creating" or restarting over and over</p><p>Ensure that your pause image is compatible with your Windows OS version.
See <a href=/docs/concepts/windows/intro/#pause-container>Pause container</a>
to see the latest / recommended pause image and/or get more information.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If using containerd as your container runtime the pause image is specified in the
<code>plugins.plugins.cri.sandbox_image</code> field of the of config.toml configration file.</div></li><li><p>My pods show status as <code>ErrImgPull</code> or <code>ImagePullBackOff</code></p><p>Ensure that your Pod is getting scheduled to a
<a href=https://docs.microsoft.com/virtualization/windowscontainers/deploy-containers/version-compatibility>compatible</a>
Windows Node.</p><p>More information on how to specify a compatible node for your Pod can be found in
<a href=/docs/concepts/windows/user-guide/#ensuring-os-specific-workloads-land-on-the-appropriate-container-host>this guide</a>.</p></li></ol><h2 id=troubleshooting-network>Network troubleshooting</h2><ol><li><p>My Windows Pods do not have network connectivity</p><p>If you are using virtual machines, ensure that MAC spoofing is <strong>enabled</strong> on all
the VM network adapter(s).</p></li><li><p>My Windows Pods cannot ping external resources</p><p>Windows Pods do not have outbound rules programmed for the ICMP protocol. However,
TCP/UDP is supported. When trying to demonstrate connectivity to resources
outside of the cluster, substitute <code>ping &lt;IP></code> with corresponding
<code>curl &lt;IP></code> commands.</p><p>If you are still facing problems, most likely your network configuration in
<a href=https://github.com/Microsoft/SDN/blob/master/Kubernetes/flannel/l2bridge/cni/config/cni.conf>cni.conf</a>
deserves some extra attention. You can always edit this static file. The
configuration update will apply to any new Kubernetes resources.</p><p>One of the Kubernetes networking requirements
(see <a href=/docs/concepts/cluster-administration/networking/>Kubernetes model</a>) is
for cluster communication to occur without
NAT internally. To honor this requirement, there is an
<a href=https://github.com/Microsoft/SDN/blob/master/Kubernetes/flannel/l2bridge/cni/config/cni.conf#L20>ExceptionList</a>
for all the communication where you do not want outbound NAT to occur. However,
this also means that you need to exclude the external IP you are trying to query
from the <code>ExceptionList</code>. Only then will the traffic originating from your Windows
pods be SNAT'ed correctly to receive a response from the outside world. In this
regard, your <code>ExceptionList</code> in <code>cni.conf</code> should look as follows:</p><pre tabindex=0><code class=language-conf data-lang=conf>&#34;ExceptionList&#34;: [
                &#34;10.244.0.0/16&#34;,  # Cluster subnet
                &#34;10.96.0.0/12&#34;,   # Service subnet
                &#34;10.127.130.0/24&#34; # Management (host) subnet
            ]
</code></pre></li><li><p>My Windows node cannot access <code>NodePort</code> type Services</p><p>Local NodePort access from the node itself fails. This is a known
limitation. NodePort access works from other nodes or external clients.</p></li><li><p>vNICs and HNS endpoints of containers are being deleted</p><p>This issue can be caused when the <code>hostname-override</code> parameter is not passed to
<a href=/docs/reference/command-line-tools-reference/kube-proxy/>kube-proxy</a>. To resolve
it, users need to pass the hostname to kube-proxy as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>C:\k\<span style=color:#a2f>kube-proxy</span>.exe --hostname-override=$(hostname)
</span></span></code></pre></div></li><li><p>My Windows node cannot access my services using the service IP</p><p>This is a known limitation of the networking stack on Windows. However, Windows Pods can access the Service IP.</p></li><li><p>No network adapter is found when starting the kubelet</p><p>The Windows networking stack needs a virtual adapter for Kubernetes networking to work.
If the following commands return no results (in an admin shell),
virtual network creation — a necessary prerequisite for the kubelet to work — has failed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>Get-HnsNetwork</span> | ? Name <span style=color:#666>-ieq</span> <span style=color:#b44>&#34;cbr0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f>Get-NetAdapter</span> | ? Name <span style=color:#666>-Like</span> <span style=color:#b44>&#34;vEthernet (Ethernet*&#34;</span>
</span></span></code></pre></div><p>Often it is worthwhile to modify the <a href=https://github.com/microsoft/SDN/blob/master/Kubernetes/flannel/start.ps1#L7>InterfaceName</a>
parameter of the <code>start.ps1</code> script, in cases where the host's network adapter isn't "Ethernet".
Otherwise, consult the output of the <code>start-kubelet.ps1</code> script to see if there are errors during virtual network creation.</p></li><li><p>DNS resolution is not properly working</p><p>Check the DNS limitations for Windows in this <a href=/docs/concepts/services-networking/dns-pod-service/#dns-windows>section</a>.</p></li><li><p><code>kubectl port-forward</code> fails with "unable to do port forwarding: wincat not found"</p><p>This was implemented in Kubernetes 1.15 by including <code>wincat.exe</code> in the pause infrastructure container
<code>mcr.microsoft.com/oss/kubernetes/pause:3.6</code>.
Be sure to use a supported version of Kubernetes.
If you would like to build your own pause infrastructure container be sure to include
<a href=https://github.com/kubernetes/kubernetes/tree/master/build/pause/windows/wincat>wincat</a>.</p></li><li><p>My Kubernetes installation is failing because my Windows Server node is behind a proxy</p><p>If you are behind a proxy, the following PowerShell environment variables must be defined:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>[<span style=color:#800>Environment</span>]::SetEnvironmentVariable(<span style=color:#b44>&#34;HTTP_PROXY&#34;</span>, <span style=color:#b44>&#34;http://proxy.example.com:80/&#34;</span>, [<span style=color:#800>EnvironmentVariableTarget</span>]::Machine)
</span></span><span style=display:flex><span>[<span style=color:#800>Environment</span>]::SetEnvironmentVariable(<span style=color:#b44>&#34;HTTPS_PROXY&#34;</span>, <span style=color:#b44>&#34;http://proxy.example.com:443/&#34;</span>, [<span style=color:#800>EnvironmentVariableTarget</span>]::Machine)
</span></span></code></pre></div></li></ol><h3 id=flannel-troubleshooting>Flannel troubleshooting</h3><ol><li><p>With Flannel, my nodes are having issues after rejoining a cluster</p><p>Whenever a previously deleted node is being re-joined to the cluster, flannelD
tries to assign a new pod subnet to the node. Users should remove the old pod
subnet configuration files in the following paths:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>Remove-Item</span> C:\k\SourceVip.json
</span></span><span style=display:flex><span><span style=color:#a2f>Remove-Item</span> C:\k\SourceVipRequest.json
</span></span></code></pre></div></li><li><p>Flanneld is stuck in "Waiting for the Network to be created"</p><p>There are numerous reports of this <a href=https://github.com/coreos/flannel/issues/1066>issue</a>;
most likely it is a timing issue for when the management IP of the flannel network is set.
A workaround is to relaunch <code>start.ps1</code> or relaunch it manually as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>[<span style=color:#800>Environment</span>]::SetEnvironmentVariable(<span style=color:#b44>&#34;NODE_NAME&#34;</span>, <span style=color:#b44>&#34;&lt;Windows_Worker_Hostname&gt;&#34;</span>)
</span></span><span style=display:flex><span>C:\flannel\flanneld.exe --kubeconfig<span style=color:#666>-file</span>=c:\k\config --iface=&lt;Windows_Worker_Node_IP&gt; --ip-masq=<span style=color:#666>1</span> --kube-subnet-mgr=<span style=color:#666>1</span>
</span></span></code></pre></div></li><li><p>My Windows Pods cannot launch because of missing <code>/run/flannel/subnet.env</code></p><p>This indicates that Flannel didn't launch correctly. You can either try
to restart <code>flanneld.exe</code> or you can copy the files over manually from
<code>/run/flannel/subnet.env</code> on the Kubernetes master to <code>C:\run\flannel\subnet.env</code>
on the Windows worker node and modify the <code>FLANNEL_SUBNET</code> row to a different
number. For example, if node subnet 10.244.4.1/24 is desired:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span><span style=color:#b8860b>FLANNEL_NETWORK</span><span style=color:#666>=</span>10.244.0.0/16
</span></span><span style=display:flex><span><span style=color:#b8860b>FLANNEL_SUBNET</span><span style=color:#666>=</span>10.244.4.1/24
</span></span><span style=display:flex><span><span style=color:#b8860b>FLANNEL_MTU</span><span style=color:#666>=</span><span style=color:#666>1500</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>FLANNEL_IPMASQ</span><span style=color:#666>=</span><span style=color:#a2f>true</span>
</span></span></code></pre></div></li></ol><h3 id=further-investigation>Further investigation</h3><p>If these steps don't resolve your problem, you can get help running Windows containers on Windows nodes in Kubernetes through:</p><ul><li>StackOverflow <a href=https://stackoverflow.com/questions/tagged/windows-server-container>Windows Server Container</a> topic</li><li>Kubernetes Official Forum <a href=https://discuss.kubernetes.io/>discuss.kubernetes.io</a></li><li>Kubernetes Slack <a href=https://kubernetes.slack.com/messages/sig-windows>#SIG-Windows Channel</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-aa0731e8aa8e2f6cc9e3c1a5e9895863>5 - Manage Kubernetes Objects</h1><div class=lead>Declarative and imperative paradigms for interacting with the Kubernetes API.</div></div><div class=td-content><h1 id=pg-df206392be6f4d19bd8da41cee7170fa>5.1 - Declarative Management of Kubernetes Objects Using Configuration Files</h1><p>Kubernetes objects can be created, updated, and deleted by storing multiple
object configuration files in a directory and using <code>kubectl apply</code> to
recursively create and update those objects as needed. This method
retains writes made to live objects without merging the changes
back into the object configuration files. <code>kubectl diff</code> also gives you a
preview of what changes <code>apply</code> will make.</p><h2 id=before-you-begin>Before you begin</h2><p>Install <a href=/docs/tasks/tools/><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=trade-offs>Trade-offs</h2><p>The <code>kubectl</code> tool supports three kinds of object management:</p><ul><li>Imperative commands</li><li>Imperative object configuration</li><li>Declarative object configuration</li></ul><p>See <a href=/docs/concepts/overview/working-with-objects/object-management/>Kubernetes Object Management</a>
for a discussion of the advantages and disadvantage of each kind of object management.</p><h2 id=overview>Overview</h2><p>Declarative object configuration requires a firm understanding of
the Kubernetes object definitions and configuration. Read and complete
the following documents if you have not already:</p><ul><li><a href=/docs/tasks/manage-kubernetes-objects/imperative-command/>Managing Kubernetes Objects Using Imperative Commands</a></li><li><a href=/docs/tasks/manage-kubernetes-objects/imperative-config/>Imperative Management of Kubernetes Objects Using Configuration Files</a></li></ul><p>Following are definitions for terms used in this document:</p><ul><li><em>object configuration file / configuration file</em>: A file that defines the
configuration for a Kubernetes object. This topic shows how to pass configuration
files to <code>kubectl apply</code>. Configuration files are typically stored in source control, such as Git.</li><li><em>live object configuration / live configuration</em>: The live configuration
values of an object, as observed by the Kubernetes cluster. These are kept in the Kubernetes
cluster storage, typically etcd.</li><li><em>declarative configuration writer / declarative writer</em>: A person or software component
that makes updates to a live object. The live writers referred to in this topic make changes
to object configuration files and run <code>kubectl apply</code> to write the changes.</li></ul><h2 id=how-to-create-objects>How to create objects</h2><p>Use <code>kubectl apply</code> to create all objects, except those that already exist,
defined by configuration files in a specified directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f &lt;directory&gt;/
</span></span></code></pre></div><p>This sets the <code>kubectl.kubernetes.io/last-applied-configuration: '{...}'</code>
annotation on each object. The annotation contains the contents of the object
configuration file that was used to create the object.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Add the <code>-R</code> flag to recursively process directories.</div><p>Here's an example of an object configuration file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/simple_deployment.yaml download=application/simple_deployment.yaml><code>application/simple_deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-simple-deployment-yaml")' title="Copy application/simple_deployment.yaml to clipboard"></img></div><div class=includecode id=application-simple-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReadySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Run <code>kubectl diff</code> to print the object that will be created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl diff -f https://k8s.io/examples/application/simple_deployment.yaml
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p><code>diff</code> uses <a href=/docs/reference/using-api/api-concepts/#dry-run>server-side dry-run</a>,
which needs to be enabled on <code>kube-apiserver</code>.</p><p>Since <code>diff</code> performs a server-side apply request in dry-run mode,
it requires granting <code>PATCH</code>, <code>CREATE</code>, and <code>UPDATE</code> permissions.
See <a href=/docs/reference/using-api/api-concepts#dry-run-authorization>Dry-Run Authorization</a>
for details.</p></div><p>Create the object using <code>kubectl apply</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</span></span></code></pre></div><p>Print the live configuration using <code>kubectl get</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</span></span></code></pre></div><p>The output shows that the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation
was written to the live configuration, and it matches the configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This is the json representation of simple_deployment.yaml</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># It was written by kubectl apply when the object was created</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;minReadySeconds&#34;:5,&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.14.2&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}</span><span style=color:#bbb>      
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReadySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=how-to-update-objects>How to update objects</h2><p>You can also use <code>kubectl apply</code> to update all objects defined in a directory, even
if those objects already exist. This approach accomplishes the following:</p><ol><li>Sets fields that appear in the configuration file in the live configuration.</li><li>Clears fields removed from the configuration file in the live configuration.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl diff -f &lt;directory&gt;/
</span></span><span style=display:flex><span>kubectl apply -f &lt;directory&gt;/
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Add the <code>-R</code> flag to recursively process directories.</div><p>Here's an example configuration file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/simple_deployment.yaml download=application/simple_deployment.yaml><code>application/simple_deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-simple-deployment-yaml")' title="Copy application/simple_deployment.yaml to clipboard"></img></div><div class=includecode id=application-simple-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReadySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the object using <code>kubectl apply</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> For purposes of illustration, the preceding command refers to a single
configuration file instead of a directory.</div><p>Print the live configuration using <code>kubectl get</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</span></span></code></pre></div><p>The output shows that the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation
was written to the live configuration, and it matches the configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This is the json representation of simple_deployment.yaml</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># It was written by kubectl apply when the object was created</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;minReadySeconds&#34;:5,&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.14.2&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}</span><span style=color:#bbb>      
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReadySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Directly update the <code>replicas</code> field in the live configuration by using <code>kubectl scale</code>.
This does not use <code>kubectl apply</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl scale deployment/nginx-deployment --replicas<span style=color:#666>=</span><span style=color:#666>2</span>
</span></span></code></pre></div><p>Print the live configuration using <code>kubectl get</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment nginx-deployment -o yaml
</span></span></code></pre></div><p>The output shows that the <code>replicas</code> field has been set to 2, and the <code>last-applied-configuration</code>
annotation does not contain a <code>replicas</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># note that the annotation does not contain replicas</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># because it was not updated through apply</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;minReadySeconds&#34;:5,&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.14.2&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}</span><span style=color:#bbb>      
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># written by scale</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReadySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Update the <code>simple_deployment.yaml</code> configuration file to change the image from
<code>nginx:1.14.2</code> to <code>nginx:1.16.1</code>, and delete the <code>minReadySeconds</code> field:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/update_deployment.yaml download=application/update_deployment.yaml><code>application/update_deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-update-deployment-yaml")' title="Copy application/update_deployment.yaml to clipboard"></img></div><div class=includecode id=application-update-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16.1<span style=color:#bbb> </span><span style=color:#080;font-style:italic># update the image</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Apply the changes made to the configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl diff -f https://k8s.io/examples/application/update_deployment.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/update_deployment.yaml
</span></span></code></pre></div><p>Print the live configuration using <code>kubectl get</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get -f https://k8s.io/examples/application/update_deployment.yaml -o yaml
</span></span></code></pre></div><p>The output shows the following changes to the live configuration:</p><ul><li>The <code>replicas</code> field retains the value of 2 set by <code>kubectl scale</code>.
This is possible because it is omitted from the configuration file.</li><li>The <code>image</code> field has been updated to <code>nginx:1.16.1</code> from <code>nginx:1.14.2</code>.</li><li>The <code>last-applied-configuration</code> annotation has been updated with the new image.</li><li>The <code>minReadySeconds</code> field has been cleared.</li><li>The <code>last-applied-configuration</code> annotation no longer contains the <code>minReadySeconds</code> field.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The annotation contains the updated image to nginx 1.11.9,</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># but does not contain the updated replicas to 2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.16.1&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}</span><span style=color:#bbb>      
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># Set by `kubectl scale`.  Ignored by `kubectl apply`.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># minReadySeconds cleared by `kubectl apply`</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16.1<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Set by `kubectl apply`</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Mixing <code>kubectl apply</code> with the imperative object configuration commands
<code>create</code> and <code>replace</code> is not supported. This is because <code>create</code>
and <code>replace</code> do not retain the <code>kubectl.kubernetes.io/last-applied-configuration</code>
that <code>kubectl apply</code> uses to compute updates.</div><h2 id=how-to-delete-objects>How to delete objects</h2><p>There are two approaches to delete objects managed by <code>kubectl apply</code>.</p><h3 id=recommended-kubectl-delete-f-filename>Recommended: <code>kubectl delete -f &lt;filename></code></h3><p>Manually deleting objects using the imperative command is the recommended
approach, as it is more explicit about what is being deleted, and less likely
to result in the user deleting something unintentionally:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f &lt;filename&gt;
</span></span></code></pre></div><h3 id=alternative-kubectl-apply-f-directory-prune-l-your-label>Alternative: <code>kubectl apply -f &lt;directory/> --prune -l your=label</code></h3><p>Only use this if you know what you are doing.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> <code>kubectl apply --prune</code> is in alpha, and backwards incompatible
changes might be introduced in subsequent releases.</div><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> You must be careful when using this command, so that you
do not delete objects unintentionally.</div><p>As an alternative to <code>kubectl delete</code>, you can use <code>kubectl apply</code> to identify objects to be deleted after their
configuration files have been removed from the directory. Apply with <code>--prune</code>
queries the API server for all objects matching a set of labels, and attempts
to match the returned live object configurations against the object
configuration files. If an object matches the query, and it does not have a
configuration file in the directory, and it has a <code>last-applied-configuration</code> annotation,
it is deleted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f &lt;directory/&gt; --prune -l &lt;labels&gt;
</span></span></code></pre></div><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Apply with prune should only be run against the root directory
containing the object configuration files. Running against sub-directories
can cause objects to be unintentionally deleted if they are returned
by the label selector query specified with <code>-l &lt;labels></code> and
do not appear in the subdirectory.</div><h2 id=how-to-view-an-object>How to view an object</h2><p>You can use <code>kubectl get</code> with <code>-o yaml</code> to view the configuration of a live object:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get -f &lt;filename|url&gt; -o yaml
</span></span></code></pre></div><h2 id=how-apply-calculates-differences-and-merges-changes>How apply calculates differences and merges changes</h2><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> A <em>patch</em> is an update operation that is scoped to specific fields of an object
instead of the entire object. This enables updating only a specific set of fields
on an object without reading the object first.</div><p>When <code>kubectl apply</code> updates the live configuration for an object,
it does so by sending a patch request to the API server. The
patch defines updates scoped to specific fields of the live object
configuration. The <code>kubectl apply</code> command calculates this patch request
using the configuration file, the live configuration, and the
<code>last-applied-configuration</code> annotation stored in the live configuration.</p><h3 id=merge-patch-calculation>Merge patch calculation</h3><p>The <code>kubectl apply</code> command writes the contents of the configuration file to the
<code>kubectl.kubernetes.io/last-applied-configuration</code> annotation. This
is used to identify fields that have been removed from the configuration
file and need to be cleared from the live configuration. Here are the steps used
to calculate which fields should be deleted or set:</p><ol><li>Calculate the fields to delete. These are the fields present in <code>last-applied-configuration</code> and missing from the configuration file.</li><li>Calculate the fields to add or set. These are the fields present in the configuration file whose values don't match the live configuration.</li></ol><p>Here's an example. Suppose this is the configuration file for a Deployment object:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/update_deployment.yaml download=application/update_deployment.yaml><code>application/update_deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-update-deployment-yaml")' title="Copy application/update_deployment.yaml to clipboard"></img></div><div class=includecode id=application-update-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16.1<span style=color:#bbb> </span><span style=color:#080;font-style:italic># update the image</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Also, suppose this is the live configuration for the same Deployment object:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># note that the annotation does not contain replicas</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># because it was not updated through apply</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;minReadySeconds&#34;:5,&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.14.2&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}</span><span style=color:#bbb>      
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># written by scale</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReadySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Here are the merge calculations that would be performed by <code>kubectl apply</code>:</p><ol><li>Calculate the fields to delete by reading values from
<code>last-applied-configuration</code> and comparing them to values in the
configuration file.
Clear fields explicitly set to null in the local object configuration file
regardless of whether they appear in the <code>last-applied-configuration</code>.
In this example, <code>minReadySeconds</code> appears in the
<code>last-applied-configuration</code> annotation, but does not appear in the configuration file.
<strong>Action:</strong> Clear <code>minReadySeconds</code> from the live configuration.</li><li>Calculate the fields to set by reading values from the configuration
file and comparing them to values in the live configuration. In this example,
the value of <code>image</code> in the configuration file does not match
the value in the live configuration. <strong>Action:</strong> Set the value of <code>image</code> in the live configuration.</li><li>Set the <code>last-applied-configuration</code> annotation to match the value
of the configuration file.</li><li>Merge the results from 1, 2, 3 into a single patch request to the API server.</li></ol><p>Here is the live configuration that is the result of the merge:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The annotation contains the updated image to nginx 1.11.9,</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># but does not contain the updated replicas to 2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.16.1&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}</span><span style=color:#bbb>      
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># Set by `kubectl scale`.  Ignored by `kubectl apply`.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># minReadySeconds cleared by `kubectl apply`</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16.1<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Set by `kubectl apply`</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=how-different-types-of-fields-are-merged>How different types of fields are merged</h3><p>How a particular field in a configuration file is merged with
the live configuration depends on the
type of the field. There are several types of fields:</p><ul><li><p><em>primitive</em>: A field of type string, integer, or boolean.
For example, <code>image</code> and <code>replicas</code> are primitive fields. <strong>Action:</strong> Replace.</p></li><li><p><em>map</em>, also called <em>object</em>: A field of type map or a complex type that contains subfields. For example, <code>labels</code>,
<code>annotations</code>,<code>spec</code> and <code>metadata</code> are all maps. <strong>Action:</strong> Merge elements or subfields.</p></li><li><p><em>list</em>: A field containing a list of items that can be either primitive types or maps.
For example, <code>containers</code>, <code>ports</code>, and <code>args</code> are lists. <strong>Action:</strong> Varies.</p></li></ul><p>When <code>kubectl apply</code> updates a map or list field, it typically does
not replace the entire field, but instead updates the individual subelements.
For instance, when merging the <code>spec</code> on a Deployment, the entire <code>spec</code> is
not replaced. Instead the subfields of <code>spec</code>, such as <code>replicas</code>, are compared
and merged.</p><h3 id=merging-changes-to-primitive-fields>Merging changes to primitive fields</h3><p>Primitive fields are replaced or cleared.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>-</code> is used for "not applicable" because the value is not used.</div><table><thead><tr><th>Field in object configuration file</th><th>Field in live object configuration</th><th>Field in last-applied-configuration</th><th>Action</th></tr></thead><tbody><tr><td>Yes</td><td>Yes</td><td>-</td><td>Set live to configuration file value.</td></tr><tr><td>Yes</td><td>No</td><td>-</td><td>Set live to local configuration.</td></tr><tr><td>No</td><td>-</td><td>Yes</td><td>Clear from live configuration.</td></tr><tr><td>No</td><td>-</td><td>No</td><td>Do nothing. Keep live value.</td></tr></tbody></table><h3 id=merging-changes-to-map-fields>Merging changes to map fields</h3><p>Fields that represent maps are merged by comparing each of the subfields or elements of the map:</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>-</code> is used for "not applicable" because the value is not used.</div><table><thead><tr><th>Key in object configuration file</th><th>Key in live object configuration</th><th>Field in last-applied-configuration</th><th>Action</th></tr></thead><tbody><tr><td>Yes</td><td>Yes</td><td>-</td><td>Compare sub fields values.</td></tr><tr><td>Yes</td><td>No</td><td>-</td><td>Set live to local configuration.</td></tr><tr><td>No</td><td>-</td><td>Yes</td><td>Delete from live configuration.</td></tr><tr><td>No</td><td>-</td><td>No</td><td>Do nothing. Keep live value.</td></tr></tbody></table><h3 id=merging-changes-for-fields-of-type-list>Merging changes for fields of type list</h3><p>Merging changes to a list uses one of three strategies:</p><ul><li>Replace the list if all its elements are primitives.</li><li>Merge individual elements in a list of complex elements.</li><li>Merge a list of primitive elements.</li></ul><p>The choice of strategy is made on a per-field basis.</p><h4 id=replace-the-list-if-all-its-elements-are-primitives>Replace the list if all its elements are primitives</h4><p>Treat the list the same as a primitive field. Replace or delete the
entire list. This preserves ordering.</p><p><strong>Example:</strong> Use <code>kubectl apply</code> to update the <code>args</code> field of a Container in a Pod. This sets
the value of <code>args</code> in the live configuration to the value in the configuration file.
Any <code>args</code> elements that had previously been added to the live configuration are lost.
The order of the <code>args</code> elements defined in the configuration file is
retained in the live configuration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># last-applied-configuration value</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;a&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;b&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># configuration file value</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;a&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;c&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># live configuration</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;a&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;b&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;d&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># result after merge</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;a&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;c&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div><p><strong>Explanation:</strong> The merge used the configuration file value as the new list value.</p><h4 id=merge-individual-elements-of-a-list-of-complex-elements>Merge individual elements of a list of complex elements:</h4><p>Treat the list as a map, and treat a specific field of each element as a key.
Add, delete, or update individual elements. This does not preserve ordering.</p><p>This merge strategy uses a special tag on each field called a <code>patchMergeKey</code>. The
<code>patchMergeKey</code> is defined for each field in the Kubernetes source code:
<a href=https://github.com/kubernetes/api/blob/d04500c8c3dda9c980b668c57abc2ca61efcf5c4/core/v1/types.go#L2747>types.go</a>
When merging a list of maps, the field specified as the <code>patchMergeKey</code> for a given element
is used like a map key for that element.</p><p><strong>Example:</strong> Use <code>kubectl apply</code> to update the <code>containers</code> field of a PodSpec.
This merges the list as though it was a map where each element is keyed
by <code>name</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># last-applied-configuration value</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name: nginx-helper-a # key</span>:<span style=color:#bbb> </span>nginx-helper-a; will be deleted in result<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name: nginx-helper-b # key</span>:<span style=color:#bbb> </span>nginx-helper-b; will be retained<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># configuration file value</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-helper-b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name: nginx-helper-c # key</span>:<span style=color:#bbb> </span>nginx-helper-c; will be added in result<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># live configuration</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-helper-a<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-helper-b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;run&#34;</span>]<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Field will be retained</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name: nginx-helper-d # key</span>:<span style=color:#bbb> </span>nginx-helper-d; will be retained<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># result after merge</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Element nginx-helper-a was deleted</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-helper-b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;run&#34;</span>]<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Field was retained</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-helper-c<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Element was added</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-helper-d<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Element was ignored</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>helper:1.3<span style=color:#bbb>
</span></span></span></code></pre></div><p><strong>Explanation:</strong></p><ul><li>The container named "nginx-helper-a" was deleted because no container
named "nginx-helper-a" appeared in the configuration file.</li><li>The container named "nginx-helper-b" retained the changes to <code>args</code>
in the live configuration. <code>kubectl apply</code> was able to identify
that "nginx-helper-b" in the live configuration was the same
"nginx-helper-b" as in the configuration file, even though their fields
had different values (no <code>args</code> in the configuration file). This is
because the <code>patchMergeKey</code> field value (name) was identical in both.</li><li>The container named "nginx-helper-c" was added because no container
with that name appeared in the live configuration, but one with
that name appeared in the configuration file.</li><li>The container named "nginx-helper-d" was retained because
no element with that name appeared in the last-applied-configuration.</li></ul><h4 id=merge-a-list-of-primitive-elements>Merge a list of primitive elements</h4><p>As of Kubernetes 1.5, merging lists of primitive elements is not supported.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Which of the above strategies is chosen for a given field is controlled by
the <code>patchStrategy</code> tag in <a href=https://github.com/kubernetes/api/blob/d04500c8c3dda9c980b668c57abc2ca61efcf5c4/core/v1/types.go#L2748>types.go</a>
If no <code>patchStrategy</code> is specified for a field of type list, then
the list is replaced.</div><h2 id=default-field-values>Default field values</h2><p>The API server sets certain fields to default values in the live configuration if they are
not specified when the object is created.</p><p>Here's a configuration file for a Deployment. The file does not specify <code>strategy</code>:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/simple_deployment.yaml download=application/simple_deployment.yaml><code>application/simple_deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-simple-deployment-yaml")' title="Copy application/simple_deployment.yaml to clipboard"></img></div><div class=includecode id=application-simple-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReadySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the object using <code>kubectl apply</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</span></span></code></pre></div><p>Print the live configuration using <code>kubectl get</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</span></span></code></pre></div><p>The output shows that the API server set several fields to default values in the live
configuration. These fields were not specified in the configuration file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReadySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rollingUpdate</span>:<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver - derived from strategy.type</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxSurge</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxUnavailable</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>RollingUpdate<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>terminationMessagePath</span>:<span style=color:#bbb> </span>/dev/termination-log<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>dnsPolicy</span>:<span style=color:#bbb> </span>ClusterFirst<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>terminationGracePeriodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted by apiserver</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># ...</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>In a patch request, defaulted fields are not re-defaulted unless they are explicitly cleared
as part of a patch request. This can cause unexpected behavior for
fields that are defaulted based
on the values of other fields. When the other fields are later changed,
the values defaulted from them will not be updated unless they are
explicitly cleared.</p><p>For this reason, it is recommended that certain fields defaulted
by the server are explicitly defined in the configuration file, even
if the desired values match the server defaults. This makes it
easier to recognize conflicting values that will not be re-defaulted
by the server.</p><p><strong>Example:</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># last-applied-configuration</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># configuration file</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Recreate<span style=color:#bbb> </span><span style=color:#080;font-style:italic># updated value</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># live configuration</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>RollingUpdate<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted value</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rollingUpdate</span>:<span style=color:#bbb> </span><span style=color:#080;font-style:italic># defaulted value derived from type</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxSurge </span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxUnavailable</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># result after merge - ERROR!</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type: Recreate # updated value</span>:<span style=color:#bbb> </span>incompatible with rollingUpdate<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rollingUpdate: # defaulted value</span>:<span style=color:#bbb> </span>incompatible with &#34;type: Recreate&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxSurge </span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxUnavailable</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div><p><strong>Explanation:</strong></p><ol><li>The user creates a Deployment without defining <code>strategy.type</code>.</li><li>The server defaults <code>strategy.type</code> to <code>RollingUpdate</code> and defaults the
<code>strategy.rollingUpdate</code> values.</li><li>The user changes <code>strategy.type</code> to <code>Recreate</code>. The <code>strategy.rollingUpdate</code>
values remain at their defaulted values, though the server expects them to be cleared.
If the <code>strategy.rollingUpdate</code> values had been defined initially in the configuration file,
it would have been more clear that they needed to be deleted.</li><li>Apply fails because <code>strategy.rollingUpdate</code> is not cleared. The <code>strategy.rollingupdate</code>
field cannot be defined with a <code>strategy.type</code> of <code>Recreate</code>.</li></ol><p>Recommendation: These fields should be explicitly defined in the object configuration file:</p><ul><li>Selectors and PodTemplate labels on workloads, such as Deployment, StatefulSet, Job, DaemonSet,
ReplicaSet, and ReplicationController</li><li>Deployment rollout strategy</li></ul><h3 id=how-to-clear-server-defaulted-fields-or-fields-set-by-other-writers>How to clear server-defaulted fields or fields set by other writers</h3><p>Fields that do not appear in the configuration file can be cleared by
setting their values to <code>null</code> and then applying the configuration file.
For fields defaulted by the server, this triggers re-defaulting
the values.</p><h2 id=how-to-change-ownership-of-a-field-between-the-configuration-file-and-direct-imperative-writers>How to change ownership of a field between the configuration file and direct imperative writers</h2><p>These are the only methods you should use to change an individual object field:</p><ul><li>Use <code>kubectl apply</code>.</li><li>Write directly to the live configuration without modifying the configuration file:
for example, use <code>kubectl scale</code>.</li></ul><h3 id=changing-the-owner-from-a-direct-imperative-writer-to-a-configuration-file>Changing the owner from a direct imperative writer to a configuration file</h3><p>Add the field to the configuration file. For the field, discontinue direct updates to
the live configuration that do not go through <code>kubectl apply</code>.</p><h3 id=changing-the-owner-from-a-configuration-file-to-a-direct-imperative-writer>Changing the owner from a configuration file to a direct imperative writer</h3><p>As of Kubernetes 1.5, changing ownership of a field from a configuration file to
an imperative writer requires manual steps:</p><ul><li>Remove the field from the configuration file.</li><li>Remove the field from the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation on the live object.</li></ul><h2 id=changing-management-methods>Changing management methods</h2><p>Kubernetes objects should be managed using only one method at a time.
Switching from one method to another is possible, but is a manual process.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> It is OK to use imperative deletion with declarative management.</div><h3 id=migrating-from-imperative-command-management-to-declarative-object-configuration>Migrating from imperative command management to declarative object configuration</h3><p>Migrating from imperative command management to declarative object
configuration involves several manual steps:</p><ol><li><p>Export the live object to a local configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get &lt;kind&gt;/&lt;name&gt; -o yaml &gt; &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li><li><p>Manually remove the <code>status</code> field from the configuration file.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This step is optional, as <code>kubectl apply</code> does not update the status field
even if it is present in the configuration file.</div></li><li><p>Set the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation on the object:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl replace --save-config -f &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li><li><p>Change processes to use <code>kubectl apply</code> for managing the object exclusively.</p></li></ol><h3 id=migrating-from-imperative-object-configuration-to-declarative-object-configuration>Migrating from imperative object configuration to declarative object configuration</h3><ol><li><p>Set the <code>kubectl.kubernetes.io/last-applied-configuration</code> annotation on the object:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl replace --save-config -f &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li><li><p>Change processes to use <code>kubectl apply</code> for managing the object exclusively.</p></li></ol><h2 id=defining-controller-selectors-and-podtemplate-labels>Defining controller selectors and PodTemplate labels</h2><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Updating selectors on controllers is strongly discouraged.</div><p>The recommended approach is to define a single, immutable PodTemplate label
used only by the controller selector with no other semantic meaning.</p><p><strong>Example:</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>controller-selector</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;apps/v1/deployment/nginx&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>controller-selector</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;apps/v1/deployment/nginx&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/tasks/manage-kubernetes-objects/imperative-command/>Managing Kubernetes Objects Using Imperative Commands</a></li><li><a href=/docs/tasks/manage-kubernetes-objects/imperative-config/>Imperative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href=/docs/reference/generated/kubectl/kubectl-commands/>Kubectl Command Reference</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/>Kubernetes API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-11aa6950fcb203094823c8e2cbdd517f>5.2 - Declarative Management of Kubernetes Objects Using Kustomize</h1><p><a href=https://github.com/kubernetes-sigs/kustomize>Kustomize</a> is a standalone tool
to customize Kubernetes objects
through a <a href=https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization>kustomization file</a>.</p><p>Since 1.14, Kubectl also
supports the management of Kubernetes objects using a kustomization file.
To view Resources found in a directory containing a kustomization file, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl kustomize &lt;kustomization_directory&gt;
</span></span></code></pre></div><p>To apply those Resources, run <code>kubectl apply</code> with <code>--kustomize</code> or <code>-k</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k &lt;kustomization_directory&gt;
</span></span></code></pre></div><h2 id=before-you-begin>Before you begin</h2><p>Install <a href=/docs/tasks/tools/><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=overview-of-kustomize>Overview of Kustomize</h2><p>Kustomize is a tool for customizing Kubernetes configurations. It has the following features to manage application configuration files:</p><ul><li>generating resources from other sources</li><li>setting cross-cutting fields for resources</li><li>composing and customizing collections of resources</li></ul><h3 id=generating-resources>Generating Resources</h3><p>ConfigMaps and Secrets hold configuration or sensitive data that are used by other Kubernetes objects, such as Pods. The source of truth of ConfigMaps or Secrets are usually external to a cluster, such as a <code>.properties</code> file or an SSH keyfile.
Kustomize has <code>secretGenerator</code> and <code>configMapGenerator</code>, which generate Secret and ConfigMap from files or literals.</p><h4 id=configmapgenerator>configMapGenerator</h4><p>To generate a ConfigMap from a file, add an entry to the <code>files</code> list in <code>configMapGenerator</code>. Here is an example of generating a ConfigMap with a data item from a <code>.properties</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a application.properties file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;application.properties
</span></span></span><span style=display:flex><span><span style=color:#b44>FOO=Bar
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>configMapGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: example-configmap-1
</span></span></span><span style=display:flex><span><span style=color:#b44>  files:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - application.properties
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>The generated ConfigMap can be examined with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl kustomize ./
</span></span></code></pre></div><p>The generated ConfigMap is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>application.properties</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    </span><span style=color:#bbb>    </span>FOO=Bar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-configmap-1-8mbdf7882g<span style=color:#bbb>
</span></span></span></code></pre></div><p>To generate a ConfigMap from an env file, add an entry to the <code>envs</code> list in <code>configMapGenerator</code>. Here is an example of generating a ConfigMap with a data item from a <code>.env</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a .env file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;.env
</span></span></span><span style=display:flex><span><span style=color:#b44>FOO=Bar
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>configMapGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: example-configmap-1
</span></span></span><span style=display:flex><span><span style=color:#b44>  envs:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - .env
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>The generated ConfigMap can be examined with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl kustomize ./
</span></span></code></pre></div><p>The generated ConfigMap is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>FOO</span>:<span style=color:#bbb> </span>Bar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-configmap-1-42cfbf598f<span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Each variable in the <code>.env</code> file becomes a separate key in the ConfigMap that you generate. This is different from the previous example which embeds a file named <code>.properties</code> (and all its entries) as the value for a single key.</div><p>ConfigMaps can also be generated from literal key-value pairs. To generate a ConfigMap from a literal key-value pair, add an entry to the <code>literals</code> list in configMapGenerator. Here is an example of generating a ConfigMap with a data item from a key-value pair:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>configMapGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: example-configmap-2
</span></span></span><span style=display:flex><span><span style=color:#b44>  literals:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - FOO=Bar
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>The generated ConfigMap can be checked by the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl kustomize ./
</span></span></code></pre></div><p>The generated ConfigMap is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>FOO</span>:<span style=color:#bbb> </span>Bar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-configmap-2-g2hdhfc6tk<span style=color:#bbb>
</span></span></span></code></pre></div><p>To use a generated ConfigMap in a Deployment, reference it by the name of the configMapGenerator. Kustomize will automatically replace this name with the generated name.</p><p>This is an example deployment that uses a generated ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Create a application.properties file</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>cat &lt;&lt;EOF &gt;application.properties<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>FOO=Bar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>EOF<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>cat &lt;&lt;EOF &gt;deployment.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-configmap-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>EOF<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>cat &lt;&lt;EOF &gt;./kustomization.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- deployment.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>configMapGenerator</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-configmap-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>files</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- application.properties<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>EOF<span style=color:#bbb>
</span></span></span></code></pre></div><p>Generate the ConfigMap and Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl kustomize ./
</span></span></code></pre></div><p>The generated Deployment will refer to the generated ConfigMap by name:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>application.properties</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    </span><span style=color:#bbb>    </span>FOO=Bar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-configmap-1-g4hk9g2ff8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>app<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-configmap-1-g4hk9g2ff8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb>
</span></span></span></code></pre></div><h4 id=secretgenerator>secretGenerator</h4><p>You can generate Secrets from files or literal key-value pairs. To generate a Secret from a file, add an entry to the <code>files</code> list in <code>secretGenerator</code>. Here is an example of generating a Secret with a data item from a file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a password.txt file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./password.txt
</span></span></span><span style=display:flex><span><span style=color:#b44>username=admin
</span></span></span><span style=display:flex><span><span style=color:#b44>password=secret
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>secretGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: example-secret-1
</span></span></span><span style=display:flex><span><span style=color:#b44>  files:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - password.txt
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>The generated Secret is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>password.txt</span>:<span style=color:#bbb> </span>dXNlcm5hbWU9YWRtaW4KcGFzc3dvcmQ9c2VjcmV0Cg==<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-secret-1-t2kt65hgtb<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span></code></pre></div><p>To generate a Secret from a literal key-value pair, add an entry to <code>literals</code> list in <code>secretGenerator</code>. Here is an example of generating a Secret with a data item from a key-value pair:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>secretGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: example-secret-2
</span></span></span><span style=display:flex><span><span style=color:#b44>  literals:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - username=admin
</span></span></span><span style=display:flex><span><span style=color:#b44>  - password=secret
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>The generated Secret is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>c2VjcmV0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>YWRtaW4=<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-secret-2-t52t6g96d8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span></code></pre></div><p>Like ConfigMaps, generated Secrets can be used in Deployments by referring to the name of the secretGenerator:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a password.txt file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./password.txt
</span></span></span><span style=display:flex><span><span style=color:#b44>username=admin
</span></span></span><span style=display:flex><span><span style=color:#b44>password=secret
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-app
</span></span></span><span style=display:flex><span><span style=color:#b44>  labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>    app: my-app
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      app: my-app
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        app: my-app
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: app
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: my-app
</span></span></span><span style=display:flex><span><span style=color:#b44>        volumeMounts:
</span></span></span><span style=display:flex><span><span style=color:#b44>        - name: password
</span></span></span><span style=display:flex><span><span style=color:#b44>          mountPath: /secrets
</span></span></span><span style=display:flex><span><span style=color:#b44>      volumes:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: password
</span></span></span><span style=display:flex><span><span style=color:#b44>        secret:
</span></span></span><span style=display:flex><span><span style=color:#b44>          secretName: example-secret-1
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>secretGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: example-secret-1
</span></span></span><span style=display:flex><span><span style=color:#b44>  files:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - password.txt
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><h4 id=generatoroptions>generatorOptions</h4><p>The generated ConfigMaps and Secrets have a content hash suffix appended. This ensures that a new ConfigMap or Secret is generated when the contents are changed. To disable the behavior of appending a suffix, one can use <code>generatorOptions</code>. Besides that, it is also possible to specify cross-cutting options for generated ConfigMaps and Secrets.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>configMapGenerator:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: example-configmap-3
</span></span></span><span style=display:flex><span><span style=color:#b44>  literals:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - FOO=Bar
</span></span></span><span style=display:flex><span><span style=color:#b44>generatorOptions:
</span></span></span><span style=display:flex><span><span style=color:#b44>  disableNameSuffixHash: true
</span></span></span><span style=display:flex><span><span style=color:#b44>  labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>    type: generated
</span></span></span><span style=display:flex><span><span style=color:#b44>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#b44>    note: generated
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Run<code>kubectl kustomize ./</code> to view the generated ConfigMap:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>FOO</span>:<span style=color:#bbb> </span>Bar<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>note</span>:<span style=color:#bbb> </span>generated<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>generated<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-configmap-3<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=setting-cross-cutting-fields>Setting cross-cutting fields</h3><p>It is quite common to set cross-cutting fields for all Kubernetes resources in a project.
Some use cases for setting cross-cutting fields:</p><ul><li>setting the same namespace for all Resources</li><li>adding the same name prefix or suffix</li><li>adding the same set of labels</li><li>adding the same set of annotations</li></ul><p>Here is an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a deployment.yaml</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: nginx-deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>  labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>    app: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      app: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        app: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>namespace: my-namespace
</span></span></span><span style=display:flex><span><span style=color:#b44>namePrefix: dev-
</span></span></span><span style=display:flex><span><span style=color:#b44>nameSuffix: &#34;-001&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44>commonLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>  app: bingo
</span></span></span><span style=display:flex><span><span style=color:#b44>commonAnnotations:
</span></span></span><span style=display:flex><span><span style=color:#b44>  oncallPager: 800-555-1212
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to view those fields are all set in the Deployment Resource:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>oncallPager</span>:<span style=color:#bbb> </span><span style=color:#666>800-555-1212</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>bingo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-nginx-deployment-001<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>bingo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>oncallPager</span>:<span style=color:#bbb> </span><span style=color:#666>800-555-1212</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>bingo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=composing-and-customizing-resources>Composing and Customizing Resources</h3><p>It is common to compose a set of Resources in a project and manage them inside
the same file or directory.
Kustomize offers composing Resources from different files and applying patches or other customization to them.</p><h4 id=composing>Composing</h4><p>Kustomize supports composition of different resources. The <code>resources</code> field, in the <code>kustomization.yaml</code> file, defines the list of resources to include in a configuration. Set the path to a resource's configuration file in the <code>resources</code> list.
Here is an example of an NGINX application comprised of a Deployment and a Service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a deployment.yaml file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>        - containerPort: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a service.yaml file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; service.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>    run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - port: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a kustomization.yaml composing them</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>- service.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>The Resources from <code>kubectl kustomize ./</code> contain both the Deployment and the Service objects.</p><h4 id=customizing>Customizing</h4><p>Patches can be used to apply different customizations to Resources. Kustomize supports different patching
mechanisms through <code>patchesStrategicMerge</code> and <code>patchesJson6902</code>. <code>patchesStrategicMerge</code> is a list of file paths. Each file should be resolved to a <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md>strategic merge patch</a>. The names inside the patches must match Resource names that are already loaded. Small patches that do one thing are recommended. For example, create one patch for increasing the deployment replica number and another patch for setting the memory limit.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a deployment.yaml file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>        - containerPort: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a patch increase_replicas.yaml</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; increase_replicas.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  replicas: 3
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create another patch set_memory.yaml</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; set_memory.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>          limits:
</span></span></span><span style=display:flex><span><span style=color:#b44>            memory: 512Mi
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>patchesStrategicMerge:
</span></span></span><span style=display:flex><span><span style=color:#b44>- increase_replicas.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>- set_memory.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to view the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>512Mi<span style=color:#bbb>
</span></span></span></code></pre></div><p>Not all Resources or fields support strategic merge patches. To support modifying arbitrary fields in arbitrary Resources,
Kustomize offers applying <a href=https://tools.ietf.org/html/rfc6902>JSON patch</a> through <code>patchesJson6902</code>.
To find the correct Resource for a Json patch, the group, version, kind and name of that Resource need to be
specified in <code>kustomization.yaml</code>. For example, increasing the replica number of a Deployment object can also be done
through <code>patchesJson6902</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a deployment.yaml file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>        - containerPort: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a json patch</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; patch.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>- op: replace
</span></span></span><span style=display:flex><span><span style=color:#b44>  path: /spec/replicas
</span></span></span><span style=display:flex><span><span style=color:#b44>  value: 3
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a kustomization.yaml</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>
</span></span></span><span style=display:flex><span><span style=color:#b44>patchesJson6902:
</span></span></span><span style=display:flex><span><span style=color:#b44>- target:
</span></span></span><span style=display:flex><span><span style=color:#b44>    group: apps
</span></span></span><span style=display:flex><span><span style=color:#b44>    version: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>    kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>    name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  path: patch.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to see the <code>replicas</code> field is updated:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>In addition to patches, Kustomize also offers customizing container images or injecting field values from other objects into containers
without creating patches. For example, you can change the image used inside containers by specifying the new image in <code>images</code> field in <code>kustomization.yaml</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>        - containerPort: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>images:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  newName: my.image.registry/nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  newTag: 1.4.0
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to see that the image being used is updated:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my.image.registry/nginx:1.4.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Sometimes, the application running in a Pod may need to use configuration values from other objects. For example,
a Pod from a Deployment object need to read the corresponding Service name from Env or as a command argument.
Since the Service name may change as <code>namePrefix</code> or <code>nameSuffix</code> is added in the <code>kustomization.yaml</code> file. It is
not recommended to hard code the Service name in the command argument. For this usage, Kustomize can inject the Service name into containers through <code>vars</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a deployment.yaml file (quoting the here doc delimiter)</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;&#39;EOF&#39; &gt; deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        command: [&#34;start&#34;, &#34;--host&#34;, &#34;$(MY_SERVICE_NAME)&#34;]
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a service.yaml file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; service.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>    run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - port: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>namePrefix: dev-
</span></span></span><span style=display:flex><span><span style=color:#b44>nameSuffix: &#34;-001&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44>
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>- service.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>
</span></span></span><span style=display:flex><span><span style=color:#b44>vars:
</span></span></span><span style=display:flex><span><span style=color:#b44>- name: MY_SERVICE_NAME
</span></span></span><span style=display:flex><span><span style=color:#b44>  objref:
</span></span></span><span style=display:flex><span><span style=color:#b44>    kind: Service
</span></span></span><span style=display:flex><span><span style=color:#b44>    name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Run <code>kubectl kustomize ./</code> to see that the Service name injected into containers is <code>dev-my-nginx-001</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-my-nginx-001<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- start<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- --host<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- dev-my-nginx-001<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-nginx<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=bases-and-overlays>Bases and Overlays</h2><p>Kustomize has the concepts of <strong>bases</strong> and <strong>overlays</strong>. A <strong>base</strong> is a directory with a <code>kustomization.yaml</code>, which contains a
set of resources and associated customization. A base could be either a local directory or a directory from a remote repo,
as long as a <code>kustomization.yaml</code> is present inside. An <strong>overlay</strong> is a directory with a <code>kustomization.yaml</code> that refers to other
kustomization directories as its <code>bases</code>. A <strong>base</strong> has no knowledge of an overlay and can be used in multiple overlays.
An overlay may have multiple bases and it composes all resources
from bases and may also have customization on top of them.</p><p>Here is an example of a base:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a directory to hold the base</span>
</span></span><span style=display:flex><span>mkdir base
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a base/deployment.yaml</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; base/deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a base/service.yaml file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; base/service.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>    run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - port: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a base/kustomization.yaml</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; base/kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>- service.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>This base can be used in multiple overlays. You can add different <code>namePrefix</code> or other cross-cutting fields
in different overlays. Here are two overlays using the same base.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir dev
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; dev/kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>bases:
</span></span></span><span style=display:flex><span><span style=color:#b44>- ../base
</span></span></span><span style=display:flex><span><span style=color:#b44>namePrefix: dev-
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir prod
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; prod/kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>bases:
</span></span></span><span style=display:flex><span><span style=color:#b44>- ../base
</span></span></span><span style=display:flex><span><span style=color:#b44>namePrefix: prod-
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><h2 id=how-to-apply-view-delete-objects-using-kustomize>How to apply/view/delete objects using Kustomize</h2><p>Use <code>--kustomize</code> or <code>-k</code> in <code>kubectl</code> commands to recognize Resources managed by <code>kustomization.yaml</code>.
Note that <code>-k</code> should point to a kustomization directory, such as</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k &lt;kustomization directory&gt;/
</span></span></code></pre></div><p>Given the following <code>kustomization.yaml</code>,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a deployment.yaml file</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  selector:
</span></span></span><span style=display:flex><span><span style=color:#b44>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>      run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>  replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#b44>  template:
</span></span></span><span style=display:flex><span><span style=color:#b44>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>      labels:
</span></span></span><span style=display:flex><span><span style=color:#b44>        run: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>    spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>      containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>      - name: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>        ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>        - containerPort: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Create a kustomization.yaml</span>
</span></span><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt;./kustomization.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>namePrefix: dev-
</span></span></span><span style=display:flex><span><span style=color:#b44>commonLabels:
</span></span></span><span style=display:flex><span><span style=color:#b44>  app: my-nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>resources:
</span></span></span><span style=display:flex><span><span style=color:#b44>- deployment.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Run the following command to apply the Deployment object <code>dev-my-nginx</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; kubectl apply -k ./
</span></span><span style=display:flex><span>deployment.apps/dev-my-nginx created
</span></span></code></pre></div><p>Run one of the following commands to view the Deployment object <code>dev-my-nginx</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get -k ./
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe -k ./
</span></span></code></pre></div><p>Run the following command to compare the Deployment object <code>dev-my-nginx</code> against the state that the cluster would be in if the manifest was applied:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl diff -k ./
</span></span></code></pre></div><p>Run the following command to delete the Deployment object <code>dev-my-nginx</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; kubectl delete -k ./
</span></span><span style=display:flex><span>deployment.apps <span style=color:#b44>&#34;dev-my-nginx&#34;</span> deleted
</span></span></code></pre></div><h2 id=kustomize-feature-list>Kustomize Feature List</h2><table><thead><tr><th>Field</th><th>Type</th><th>Explanation</th></tr></thead><tbody><tr><td>namespace</td><td>string</td><td>add namespace to all resources</td></tr><tr><td>namePrefix</td><td>string</td><td>value of this field is prepended to the names of all resources</td></tr><tr><td>nameSuffix</td><td>string</td><td>value of this field is appended to the names of all resources</td></tr><tr><td>commonLabels</td><td>map[string]string</td><td>labels to add to all resources and selectors</td></tr><tr><td>commonAnnotations</td><td>map[string]string</td><td>annotations to add to all resources</td></tr><tr><td>resources</td><td>[]string</td><td>each entry in this list must resolve to an existing resource configuration file</td></tr><tr><td>configMapGenerator</td><td>[]<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/configmapargs.go#L7>ConfigMapArgs</a></td><td>Each entry in this list generates a ConfigMap</td></tr><tr><td>secretGenerator</td><td>[]<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/secretargs.go#L7>SecretArgs</a></td><td>Each entry in this list generates a Secret</td></tr><tr><td>generatorOptions</td><td><a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/generatoroptions.go#L7>GeneratorOptions</a></td><td>Modify behaviors of all ConfigMap and Secret generator</td></tr><tr><td>bases</td><td>[]string</td><td>Each entry in this list should resolve to a directory containing a kustomization.yaml file</td></tr><tr><td>patchesStrategicMerge</td><td>[]string</td><td>Each entry in this list should resolve a strategic merge patch of a Kubernetes object</td></tr><tr><td>patchesJson6902</td><td>[]<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/patch.go#L10>Patch</a></td><td>Each entry in this list should resolve to a Kubernetes object and a Json Patch</td></tr><tr><td>vars</td><td>[]<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/var.go#L19>Var</a></td><td>Each entry is to capture text from one resource's field</td></tr><tr><td>images</td><td>[]<a href=https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/image.go#L8>Image</a></td><td>Each entry is to modify the name, tags and/or digest for one image without creating patches</td></tr><tr><td>configurations</td><td>[]string</td><td>Each entry in this list should resolve to a file containing <a href=https://github.com/kubernetes-sigs/kustomize/tree/master/examples/transformerconfigs>Kustomize transformer configurations</a></td></tr><tr><td>crds</td><td>[]string</td><td>Each entry in this list should resolve to an OpenAPI definition file for Kubernetes types</td></tr></tbody></table><h2 id=what-s-next>What's next</h2><ul><li><a href=https://github.com/kubernetes-sigs/kustomize>Kustomize</a></li><li><a href=https://kubectl.docs.kubernetes.io>Kubectl Book</a></li><li><a href=/docs/reference/generated/kubectl/kubectl-commands/>Kubectl Command Reference</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/>Kubernetes API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-80c83fe9b80d0fef2681c8d59c0aa197>5.3 - Managing Kubernetes Objects Using Imperative Commands</h1><p>Kubernetes objects can quickly be created, updated, and deleted directly using
imperative commands built into the <code>kubectl</code> command-line tool. This document
explains how those commands are organized and how to use them to manage live objects.</p><h2 id=before-you-begin>Before you begin</h2><p>Install <a href=/docs/tasks/tools/><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=trade-offs>Trade-offs</h2><p>The <code>kubectl</code> tool supports three kinds of object management:</p><ul><li>Imperative commands</li><li>Imperative object configuration</li><li>Declarative object configuration</li></ul><p>See <a href=/docs/concepts/overview/working-with-objects/object-management/>Kubernetes Object Management</a>
for a discussion of the advantages and disadvantage of each kind of object management.</p><h2 id=how-to-create-objects>How to create objects</h2><p>The <code>kubectl</code> tool supports verb-driven commands for creating some of the most common
object types. The commands are named to be recognizable to users unfamiliar with
the Kubernetes object types.</p><ul><li><code>run</code>: Create a new Pod to run a Container.</li><li><code>expose</code>: Create a new Service object to load balance traffic across Pods.</li><li><code>autoscale</code>: Create a new Autoscaler object to automatically horizontally scale a controller, such as a Deployment.</li></ul><p>The <code>kubectl</code> tool also supports creation commands driven by object type.
These commands support more object types and are more explicit about
their intent, but require users to know the type of objects they intend
to create.</p><ul><li><code>create &lt;objecttype> [&lt;subtype>] &lt;instancename></code></li></ul><p>Some objects types have subtypes that you can specify in the <code>create</code> command.
For example, the Service object has several subtypes including ClusterIP,
LoadBalancer, and NodePort. Here's an example that creates a Service with
subtype NodePort:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create service nodeport &lt;myservicename&gt;
</span></span></code></pre></div><p>In the preceding example, the <code>create service nodeport</code> command is called
a subcommand of the <code>create service</code> command.</p><p>You can use the <code>-h</code> flag to find the arguments and flags supported by
a subcommand:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create service nodeport -h
</span></span></code></pre></div><h2 id=how-to-update-objects>How to update objects</h2><p>The <code>kubectl</code> command supports verb-driven commands for some common update operations.
These commands are named to enable users unfamiliar with Kubernetes
objects to perform updates without knowing the specific fields
that must be set:</p><ul><li><code>scale</code>: Horizontally scale a controller to add or remove Pods by updating the replica count of the controller.</li><li><code>annotate</code>: Add or remove an annotation from an object.</li><li><code>label</code>: Add or remove a label from an object.</li></ul><p>The <code>kubectl</code> command also supports update commands driven by an aspect of the object.
Setting this aspect may set different fields for different object types:</p><ul><li><code>set</code> <code>&lt;field></code>: Set an aspect of an object.</li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In Kubernetes version 1.5, not every verb-driven command has an associated aspect-driven command.</div><p>The <code>kubectl</code> tool supports these additional ways to update a live object directly,
however they require a better understanding of the Kubernetes object schema.</p><ul><li><code>edit</code>: Directly edit the raw configuration of a live object by opening its configuration in an editor.</li><li><code>patch</code>: Directly modify specific fields of a live object by using a patch string.
For more details on patch strings, see the patch section in
<a href=https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#patch-operations>API Conventions</a>.</li></ul><h2 id=how-to-delete-objects>How to delete objects</h2><p>You can use the <code>delete</code> command to delete an object from a cluster:</p><ul><li><code>delete &lt;type>/&lt;name></code></li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> You can use <code>kubectl delete</code> for both imperative commands and imperative object
configuration. The difference is in the arguments passed to the command. To use
<code>kubectl delete</code> as an imperative command, pass the object to be deleted as
an argument. Here's an example that passes a Deployment object named nginx:</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deployment/nginx
</span></span></code></pre></div><h2 id=how-to-view-an-object>How to view an object</h2><p>There are several commands for printing information about an object:</p><ul><li><code>get</code>: Prints basic information about matching objects. Use <code>get -h</code> to see a list of options.</li><li><code>describe</code>: Prints aggregated detailed information about matching objects.</li><li><code>logs</code>: Prints the stdout and stderr for a container running in a Pod.</li></ul><h2 id=using-set-commands-to-modify-objects-before-creation>Using <code>set</code> commands to modify objects before creation</h2><p>There are some object fields that don't have a flag you can use
in a <code>create</code> command. In some of those cases, you can use a combination of
<code>set</code> and <code>create</code> to specify a value for the field before object
creation. This is done by piping the output of the <code>create</code> command to the
<code>set</code> command, and then back to the <code>create</code> command. Here's an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create service clusterip my-svc --clusterip<span style=color:#666>=</span><span style=color:#b44>&#34;None&#34;</span> -o yaml --dry-run<span style=color:#666>=</span>client | kubectl <span style=color:#a2f>set</span> selector --local -f - <span style=color:#b44>&#39;environment=qa&#39;</span> -o yaml | kubectl create -f -
</span></span></code></pre></div><ol><li>The <code>kubectl create service -o yaml --dry-run=client</code> command creates the configuration for the Service, but prints it to stdout as YAML instead of sending it to the Kubernetes API server.</li><li>The <code>kubectl set selector --local -f - -o yaml</code> command reads the configuration from stdin, and writes the updated configuration to stdout as YAML.</li><li>The <code>kubectl create -f -</code> command creates the object using the configuration provided via stdin.</li></ol><h2 id=using-edit-to-modify-objects-before-creation>Using <code>--edit</code> to modify objects before creation</h2><p>You can use <code>kubectl create --edit</code> to make arbitrary changes to an object
before it is created. Here's an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create service clusterip my-svc --clusterip<span style=color:#666>=</span><span style=color:#b44>&#34;None&#34;</span> -o yaml --dry-run<span style=color:#666>=</span>client &gt; /tmp/srv.yaml
</span></span><span style=display:flex><span>kubectl create --edit -f /tmp/srv.yaml
</span></span></code></pre></div><ol><li>The <code>kubectl create service</code> command creates the configuration for the Service and saves it to <code>/tmp/srv.yaml</code>.</li><li>The <code>kubectl create --edit</code> command opens the configuration file for editing before it creates the object.</li></ol><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/tasks/manage-kubernetes-objects/imperative-config/>Imperative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href=/docs/tasks/manage-kubernetes-objects/declarative-config/>Declarative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href=/docs/reference/generated/kubectl/kubectl-commands/>Kubectl Command Reference</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/>Kubernetes API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b18886277c410fc6f32ce068e2160537>5.4 - Imperative Management of Kubernetes Objects Using Configuration Files</h1><p>Kubernetes objects can be created, updated, and deleted by using the <code>kubectl</code>
command-line tool along with an object configuration file written in YAML or JSON.
This document explains how to define and manage objects using configuration files.</p><h2 id=before-you-begin>Before you begin</h2><p>Install <a href=/docs/tasks/tools/><code>kubectl</code></a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=trade-offs>Trade-offs</h2><p>The <code>kubectl</code> tool supports three kinds of object management:</p><ul><li>Imperative commands</li><li>Imperative object configuration</li><li>Declarative object configuration</li></ul><p>See <a href=/docs/concepts/overview/working-with-objects/object-management/>Kubernetes Object Management</a>
for a discussion of the advantages and disadvantage of each kind of object management.</p><h2 id=how-to-create-objects>How to create objects</h2><p>You can use <code>kubectl create -f</code> to create an object from a configuration file.
Refer to the <a href=/docs/reference/generated/kubernetes-api/v1.25/>kubernetes API reference</a>
for details.</p><ul><li><code>kubectl create -f &lt;filename|url></code></li></ul><h2 id=how-to-update-objects>How to update objects</h2><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Updating objects with the <code>replace</code> command drops all
parts of the spec not specified in the configuration file. This
should not be used with objects whose specs are partially managed
by the cluster, such as Services of type <code>LoadBalancer</code>, where
the <code>externalIPs</code> field is managed independently from the configuration
file. Independently managed fields must be copied to the configuration
file to prevent <code>replace</code> from dropping them.</div><p>You can use <code>kubectl replace -f</code> to update a live object according to a
configuration file.</p><ul><li><code>kubectl replace -f &lt;filename|url></code></li></ul><h2 id=how-to-delete-objects>How to delete objects</h2><p>You can use <code>kubectl delete -f</code> to delete an object that is described in a
configuration file.</p><ul><li><code>kubectl delete -f &lt;filename|url></code></li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>If configuration file has specified the <code>generateName</code> field in the <code>metadata</code>
section instead of the <code>name</code> field, you cannot delete the object using
<code>kubectl delete -f &lt;filename|url></code>.
You will have to use other flags for deleting the object. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete &lt;type&gt; &lt;name&gt;
</span></span><span style=display:flex><span>kubectl delete &lt;type&gt; -l &lt;label&gt;
</span></span></code></pre></div></div><h2 id=how-to-view-an-object>How to view an object</h2><p>You can use <code>kubectl get -f</code> to view information about an object that is
described in a configuration file.</p><ul><li><code>kubectl get -f &lt;filename|url> -o yaml</code></li></ul><p>The <code>-o yaml</code> flag specifies that the full object configuration is printed.
Use <code>kubectl get -h</code> to see a list of options.</p><h2 id=limitations>Limitations</h2><p>The <code>create</code>, <code>replace</code>, and <code>delete</code> commands work well when each object's
configuration is fully defined and recorded in its configuration
file. However when a live object is updated, and the updates are not merged
into its configuration file, the updates will be lost the next time a <code>replace</code>
is executed. This can happen if a controller, such as
a HorizontalPodAutoscaler, makes updates directly to a live object. Here's
an example:</p><ol><li>You create an object from a configuration file.</li><li>Another source updates the object by changing some field.</li><li>You replace the object from the configuration file. Changes made by
the other source in step 2 are lost.</li></ol><p>If you need to support multiple writers to the same object, you can use
<code>kubectl apply</code> to manage the object.</p><h2 id=creating-and-editing-an-object-from-a-url-without-saving-the-configuration>Creating and editing an object from a URL without saving the configuration</h2><p>Suppose you have the URL of an object configuration file. You can use
<code>kubectl create --edit</code> to make changes to the configuration before the
object is created. This is particularly useful for tutorials and tasks
that point to a configuration file that could be modified by the reader.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f &lt;url&gt; --edit
</span></span></code></pre></div><h2 id=migrating-from-imperative-commands-to-imperative-object-configuration>Migrating from imperative commands to imperative object configuration</h2><p>Migrating from imperative commands to imperative object configuration involves
several manual steps.</p><ol><li><p>Export the live object to a local object configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get &lt;kind&gt;/&lt;name&gt; -o yaml &gt; &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li><li><p>Manually remove the status field from the object configuration file.</p></li><li><p>For subsequent object management, use <code>replace</code> exclusively.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl replace -f &lt;kind&gt;_&lt;name&gt;.yaml
</span></span></code></pre></div></li></ol><h2 id=defining-controller-selectors-and-podtemplate-labels>Defining controller selectors and PodTemplate labels</h2><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Updating selectors on controllers is strongly discouraged.</div><p>The recommended approach is to define a single, immutable PodTemplate label
used only by the controller selector with no other semantic meaning.</p><p>Example label:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>controller-selector</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;apps/v1/deployment/nginx&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>controller-selector</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;apps/v1/deployment/nginx&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/tasks/manage-kubernetes-objects/imperative-command/>Managing Kubernetes Objects Using Imperative Commands</a></li><li><a href=/docs/tasks/manage-kubernetes-objects/declarative-config/>Declarative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href=/docs/reference/generated/kubectl/kubectl-commands/>Kubectl Command Reference</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/>Kubernetes API Reference</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d4d4414dc91b63cfe0f65ca4f0c2fe31>5.5 - Update API Objects in Place Using kubectl patch</h1><div class=lead>Use kubectl patch to update Kubernetes API objects in place. Do a strategic merge patch or a JSON merge patch.</div><p>This task shows how to use <code>kubectl patch</code> to update an API object in place. The exercises
in this task demonstrate a strategic merge patch and a JSON merge patch.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=use-a-strategic-merge-patch-to-update-a-deployment>Use a strategic merge patch to update a Deployment</h2><p>Here's the configuration file for a Deployment that has two replicas. Each replica
is a Pod that has one container:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment-patch.yaml download=application/deployment-patch.yaml><code>application/deployment-patch.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-deployment-patch-yaml")' title="Copy application/deployment-patch.yaml to clipboard"></img></div><div class=includecode id=application-deployment-patch-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>patch-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>patch-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>dedicated<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>test-team<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/deployment-patch.yaml
</span></span></code></pre></div><p>View the Pods associated with your Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>The output shows that the Deployment has two Pods. The <code>1/1</code> indicates that
each Pod has one container:</p><pre tabindex=0><code>NAME                        READY     STATUS    RESTARTS   AGE
patch-demo-28633765-670qr   1/1       Running   0          23s
patch-demo-28633765-j5qs3   1/1       Running   0          23s
</code></pre><p>Make a note of the names of the running Pods. Later, you will see that these Pods
get terminated and replaced by new ones.</p><p>At this point, each Pod has one Container that runs the nginx image. Now suppose
you want each Pod to have two containers: one that runs nginx and one that runs redis.</p><p>Create a file named <code>patch-file.yaml</code> that has this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>patch-demo-ctr-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>redis<span style=color:#bbb>
</span></span></span></code></pre></div><p>Patch your Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment patch-demo --patch-file patch-file.yaml
</span></span></code></pre></div><p>View the patched Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment patch-demo --output yaml
</span></span></code></pre></div><p>The output shows that the PodSpec in the Deployment has two Containers:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>redis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>patch-demo-ctr-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>Always<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>patch-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><p>View the Pods associated with your patched Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>The output shows that the running Pods have different names from the Pods that
were running previously. The Deployment terminated the old Pods and created two
new Pods that comply with the updated Deployment spec. The <code>2/2</code> indicates that
each Pod has two Containers:</p><pre tabindex=0><code>NAME                          READY     STATUS    RESTARTS   AGE
patch-demo-1081991389-2wrn5   2/2       Running   0          1m
patch-demo-1081991389-jmg7b   2/2       Running   0          1m
</code></pre><p>Take a closer look at one of the patch-demo Pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod &lt;your-pod-name&gt; --output yaml
</span></span></code></pre></div><p>The output shows that the Pod has two Containers: one running nginx and one running redis:</p><pre tabindex=0><code>containers:
- image: redis
  ...
- image: nginx
  ...
</code></pre><h3 id=notes-on-the-strategic-merge-patch>Notes on the strategic merge patch</h3><p>The patch you did in the preceding exercise is called a <em>strategic merge patch</em>.
Notice that the patch did not replace the <code>containers</code> list. Instead it added a new
Container to the list. In other words, the list in the patch was merged with the
existing list. This is not always what happens when you use a strategic merge patch on a list.
In some cases, the list is replaced, not merged.</p><p>With a strategic merge patch, a list is either replaced or merged depending on its
patch strategy. The patch strategy is specified by the value of the <code>patchStrategy</code> key
in a field tag in the Kubernetes source code. For example, the <code>Containers</code> field of <code>PodSpec</code>
struct has a <code>patchStrategy</code> of <code>merge</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a2f;font-weight:700>type</span> PodSpec <span style=color:#a2f;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#666>...</span>
</span></span><span style=display:flex><span>  Containers []Container <span style=color:#b44>`json:&#34;containers&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; ...`</span>
</span></span><span style=display:flex><span>  <span style=color:#666>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can also see the patch strategy in the
<a href=https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json>OpenApi spec</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>&#34;io.k8s.api.core.v1.PodSpec&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;containers&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;description&#34;: </span><span style=color:#b44>&#34;List of containers belonging to the pod.  ....&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;x-kubernetes-patch-merge-key&#34;: </span><span style=color:#b44>&#34;name&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;x-kubernetes-patch-strategy&#34;: </span><span style=color:#b44>&#34;merge&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>And you can see the patch strategy in the
<a href=/docs/reference/generated/kubernetes-api/v1.25/#podspec-v1-core>Kubernetes API documentation</a>.</p><p>Create a file named <code>patch-file-tolerations.yaml</code> that has this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>disktype<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>ssd<span style=color:#bbb>
</span></span></span></code></pre></div><p>Patch your Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment patch-demo --patch-file patch-file-tolerations.yaml
</span></span></code></pre></div><p>View the patched Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment patch-demo --output yaml
</span></span></code></pre></div><p>The output shows that the PodSpec in the Deployment has only one Toleration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>disktype<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>ssd<span style=color:#bbb>
</span></span></span></code></pre></div><p>Notice that the <code>tolerations</code> list in the PodSpec was replaced, not merged. This is because
the Tolerations field of PodSpec does not have a <code>patchStrategy</code> key in its field tag. So the
strategic merge patch uses the default patch strategy, which is <code>replace</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a2f;font-weight:700>type</span> PodSpec <span style=color:#a2f;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#666>...</span>
</span></span><span style=display:flex><span>  Tolerations []Toleration <span style=color:#b44>`json:&#34;tolerations,omitempty&#34; protobuf:&#34;bytes,22,opt,name=tolerations&#34;`</span>
</span></span><span style=display:flex><span>  <span style=color:#666>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=use-a-json-merge-patch-to-update-a-deployment>Use a JSON merge patch to update a Deployment</h2><p>A strategic merge patch is different from a
<a href=https://tools.ietf.org/html/rfc7386>JSON merge patch</a>.
With a JSON merge patch, if you
want to update a list, you have to specify the entire new list. And the new list completely
replaces the existing list.</p><p>The <code>kubectl patch</code> command has a <code>type</code> parameter that you can set to one of these values:</p><table><tr><th>Parameter value</th><th>Merge type</th></tr><tr><td>json</td><td><a href=https://tools.ietf.org/html/rfc6902>JSON Patch, RFC 6902</a></td></tr><tr><td>merge</td><td><a href=https://tools.ietf.org/html/rfc7386>JSON Merge Patch, RFC 7386</a></td></tr><tr><td>strategic</td><td>Strategic merge patch</td></tr></table><p>For a comparison of JSON patch and JSON merge patch, see
<a href=https://erosb.github.io/post/json-patch-vs-merge-patch/>JSON Patch and JSON Merge Patch</a>.</p><p>The default value for the <code>type</code> parameter is <code>strategic</code>. So in the preceding exercise, you
did a strategic merge patch.</p><p>Next, do a JSON merge patch on your same Deployment. Create a file named <code>patch-file-2.yaml</code>
that has this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>patch-demo-ctr-3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/node-hello:1.0<span style=color:#bbb>
</span></span></span></code></pre></div><p>In your patch command, set <code>type</code> to <code>merge</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment patch-demo --type merge --patch-file patch-file-2.yaml
</span></span></code></pre></div><p>View the patched Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment patch-demo --output yaml
</span></span></code></pre></div><p>The <code>containers</code> list that you specified in the patch has only one Container.
The output shows that your list of one Container replaced the existing <code>containers</code> list.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  containers:
</span></span><span style=display:flex><span>  - image: gcr.io/google-samples/node-hello:1.0
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    name: patch-demo-ctr-3
</span></span></code></pre></div><p>List the running Pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>In the output, you can see that the existing Pods were terminated, and new Pods
were created. The <code>1/1</code> indicates that each new Pod is running only one Container.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                          READY     STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>patch-demo-1307768864-69308   1/1       Running   <span style=color:#666>0</span>          1m
</span></span><span style=display:flex><span>patch-demo-1307768864-c86dc   1/1       Running   <span style=color:#666>0</span>          1m
</span></span></code></pre></div><h2 id=use-strategic-merge-patch-to-update-a-deployment-using-the-retainkeys-strategy>Use strategic merge patch to update a Deployment using the retainKeys strategy</h2><p>Here's the configuration file for a Deployment that uses the <code>RollingUpdate</code> strategy:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment-retainkeys.yaml download=application/deployment-retainkeys.yaml><code>application/deployment-retainkeys.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-deployment-retainkeys-yaml")' title="Copy application/deployment-retainkeys.yaml to clipboard"></img></div><div class=includecode id=application-deployment-retainkeys-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>retainkeys-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rollingUpdate</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxSurge</span>:<span style=color:#bbb> </span><span style=color:#666>30</span>%<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>retainkeys-demo-ctr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/deployment-retainkeys.yaml
</span></span></code></pre></div><p>At this point, the deployment is created and is using the <code>RollingUpdate</code> strategy.</p><p>Create a file named <code>patch-file-no-retainkeys.yaml</code> that has this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Recreate<span style=color:#bbb>
</span></span></span></code></pre></div><p>Patch your Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment retainkeys-demo --type strategic --patch-file patch-file-no-retainkeys.yaml
</span></span></code></pre></div><p>In the output, you can see that it is not possible to set <code>type</code> as <code>Recreate</code> when a value is defined for <code>spec.strategy.rollingUpdate</code>:</p><pre tabindex=0><code>The Deployment &#34;retainkeys-demo&#34; is invalid: spec.strategy.rollingUpdate: Forbidden: may not be specified when strategy `type` is &#39;Recreate&#39;
</code></pre><p>The way to remove the value for <code>spec.strategy.rollingUpdate</code> when updating the value for <code>type</code> is to use the <code>retainKeys</code> strategy for the strategic merge.</p><p>Create another file named <code>patch-file-retainkeys.yaml</code> that has this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>$retainKeys</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- type<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Recreate<span style=color:#bbb>
</span></span></span></code></pre></div><p>With this patch, we indicate that we want to retain only the <code>type</code> key of the <code>strategy</code> object. Thus, the <code>rollingUpdate</code> will be removed during the patch operation.</p><p>Patch your Deployment again with this new patch:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment retainkeys-demo --type strategic --patch-file patch-file-retainkeys.yaml
</span></span></code></pre></div><p>Examine the content of the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment retainkeys-demo --output yaml
</span></span></code></pre></div><p>The output shows that the strategy object in the Deployment does not contain the <code>rollingUpdate</code> key anymore:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Recreate<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=notes-on-the-strategic-merge-patch-using-the-retainkeys-strategy>Notes on the strategic merge patch using the retainKeys strategy</h3><p>The patch you did in the preceding exercise is called a <em>strategic merge patch with retainKeys strategy</em>. This method introduces a new directive <code>$retainKeys</code> that has the following strategies:</p><ul><li>It contains a list of strings.</li><li>All fields needing to be preserved must be present in the <code>$retainKeys</code> list.</li><li>The fields that are present will be merged with live object.</li><li>All of the missing fields will be cleared when patching.</li><li>All fields in the <code>$retainKeys</code> list must be a superset or the same as the fields present in the patch.</li></ul><p>The <code>retainKeys</code> strategy does not work for all objects. It only works when the value of the <code>patchStrategy</code> key in a field tag in the Kubernetes source code contains <code>retainKeys</code>. For example, the <code>Strategy</code> field of the <code>DeploymentSpec</code> struct has a <code>patchStrategy</code> of <code>retainKeys</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a2f;font-weight:700>type</span> DeploymentSpec <span style=color:#a2f;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#666>...</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>// +patchStrategy=retainKeys
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>  Strategy DeploymentStrategy <span style=color:#b44>`json:&#34;strategy,omitempty&#34; patchStrategy:&#34;retainKeys&#34; ...`</span>
</span></span><span style=display:flex><span>  <span style=color:#666>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can also see the <code>retainKeys</code> strategy in the <a href=https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json>OpenApi spec</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>&#34;io.k8s.api.apps.v1.DeploymentSpec&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;strategy&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;$ref&#34;: </span><span style=color:#b44>&#34;#/definitions/io.k8s.api.apps.v1.DeploymentStrategy&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;description&#34;: </span><span style=color:#b44>&#34;The deployment strategy to use to replace existing pods with new ones.&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;x-kubernetes-patch-strategy&#34;: </span><span style=color:#b44>&#34;retainKeys&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>....<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>And you can see the <code>retainKeys</code> strategy in the
<a href=/docs/reference/generated/kubernetes-api/v1.25/#deploymentspec-v1-apps>Kubernetes API documentation</a>.</p><h3 id=alternate-forms-of-the-kubectl-patch-command>Alternate forms of the kubectl patch command</h3><p>The <code>kubectl patch</code> command takes YAML or JSON. It can take the patch as a file or
directly on the command line.</p><p>Create a file named <code>patch-file.json</code> that has this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:green;font-weight:700>&#34;spec&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;template&#34;</span>: {
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;spec&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;containers&#34;</span>: [
</span></span><span style=display:flex><span>               {
</span></span><span style=display:flex><span>                  <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;patch-demo-ctr-2&#34;</span>,
</span></span><span style=display:flex><span>                  <span style=color:green;font-weight:700>&#34;image&#34;</span>: <span style=color:#b44>&#34;redis&#34;</span>
</span></span><span style=display:flex><span>               }
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The following commands are equivalent:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment patch-demo --patch-file patch-file.yaml
</span></span><span style=display:flex><span>kubectl patch deployment patch-demo --patch <span style=color:#b44>&#39;spec:\n template:\n  spec:\n   containers:\n   - name: patch-demo-ctr-2\n     image: redis&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl patch deployment patch-demo --patch-file patch-file.json
</span></span><span style=display:flex><span>kubectl patch deployment patch-demo --patch <span style=color:#b44>&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;spec&#34;: {&#34;containers&#34;: [{&#34;name&#34;: &#34;patch-demo-ctr-2&#34;,&#34;image&#34;: &#34;redis&#34;}]}}}}&#39;</span>
</span></span></code></pre></div><h3 id=scale-kubectl-patch>Update an object's replica count using <code>kubectl patch</code> with <code>--subresource</code></h3><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.24 [alpha]</code></div><p>The flag <code>--subresource=[subresource-name]</code> is used with kubectl commands like get, patch,
edit and replace to fetch and update <code>status</code> and <code>scale</code> subresources of the resources
(applicable for kubectl version v1.24 or more). This flag is used with all the API resources
(built-in and CRs) which has <code>status</code> or <code>scale</code> subresource. Deployment is one of the
examples which supports these subresources.</p><p>Here's a manifest for a Deployment that has two replicas:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment.yaml download=application/deployment.yaml><code>application/deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-deployment-yaml")' title="Copy application/deployment.yaml to clipboard"></img></div><div class=includecode id=application-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># tells deployment to run 2 pods matching the template</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Create the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/deployment.yaml
</span></span></code></pre></div><p>View the Pods associated with your Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>nginx
</span></span></code></pre></div><p>In the output, you can see that Deployment has two Pods. For example:</p><pre tabindex=0><code>NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-7fb96c846b-22567   1/1     Running   0          47s
nginx-deployment-7fb96c846b-mlgns   1/1     Running   0          47s
</code></pre><p>Now, patch that Deployment with <code>--subresource=[subresource-name]</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch deployment nginx-deployment --subresource<span style=color:#666>=</span><span style=color:#b44>&#39;scale&#39;</span> --type<span style=color:#666>=</span><span style=color:#b44>&#39;merge&#39;</span> -p <span style=color:#b44>&#39;{&#34;spec&#34;:{&#34;replicas&#34;:3}}&#39;</span>
</span></span></code></pre></div><p>The output is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>scale.autoscaling/nginx-deployment patched
</span></span></code></pre></div><p>View the Pods associated with your patched Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>nginx
</span></span></code></pre></div><p>In the output, you can see one new pod is created, so now you have 3 running pods.</p><pre tabindex=0><code>NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-7fb96c846b-22567   1/1     Running   0          107s
nginx-deployment-7fb96c846b-lxfr2   1/1     Running   0          14s
nginx-deployment-7fb96c846b-mlgns   1/1     Running   0          107s
</code></pre><p>View the patched Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment nginx-deployment -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>availableReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>readyReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you run <code>kubectl patch</code> and specify <code>--subresource</code> flag for resource that doesn't support that
particular subresource, the API server returns a 404 Not Found error.</div><h2 id=summary>Summary</h2><p>In this exercise, you used <code>kubectl patch</code> to change the live configuration
of a Deployment object. You did not change the configuration file that you originally used to
create the Deployment object. Other commands for updating API objects include
<a href=/docs/reference/generated/kubectl/kubectl-commands/#annotate>kubectl annotate</a>,
<a href=/docs/reference/generated/kubectl/kubectl-commands/#edit>kubectl edit</a>,
<a href=/docs/reference/generated/kubectl/kubectl-commands/#replace>kubectl replace</a>,
<a href=/docs/reference/generated/kubectl/kubectl-commands/#scale>kubectl scale</a>,
and
<a href=/docs/reference/generated/kubectl/kubectl-commands/#apply>kubectl apply</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Strategic merge patch is not supported for custom resources.</div><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/concepts/overview/working-with-objects/object-management/>Kubernetes Object Management</a></li><li><a href=/docs/tasks/manage-kubernetes-objects/imperative-command/>Managing Kubernetes Objects Using Imperative Commands</a></li><li><a href=/docs/tasks/manage-kubernetes-objects/imperative-config/>Imperative Management of Kubernetes Objects Using Configuration Files</a></li><li><a href=/docs/tasks/manage-kubernetes-objects/declarative-config/>Declarative Management of Kubernetes Objects Using Configuration Files</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-94f49ece137035764368f22a98942872>6 - Managing Secrets</h1><div class=lead>Managing confidential settings data using Secrets.</div></div><div class=td-content><h1 id=pg-0ed63ce3c9665aed7ff5a560ff1da843>6.1 - Managing Secrets using kubectl</h1><div class=lead>Creating Secret objects using kubectl command line.</div><p>This page shows you how to create, edit, manage, and delete Kubernetes
<a class=glossary-tooltip title='Stores sensitive information, such as passwords, OAuth tokens, and ssh keys.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/secret/ target=_blank aria-label=Secrets>Secrets</a> using the <code>kubectl</code>
command-line tool.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=create-a-secret>Create a Secret</h2><p>A <code>Secret</code> object stores sensitive data such as credentials
used by Pods to access services. For example, you might need a Secret to store
the username and password needed to access a database.</p><p>You can create the Secret by passing the raw data in the command, or by storing
the credentials in files that you pass in the command. The following commands
create a Secret that stores the username <code>admin</code> and the password <code>S!B\*d$zDsb=</code>.</p><h3 id=use-raw-data>Use raw data</h3><p>Run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic db-user-pass <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --from-literal<span style=color:#666>=</span><span style=color:#b8860b>username</span><span style=color:#666>=</span>admin <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --from-literal<span style=color:#666>=</span><span style=color:#b8860b>password</span><span style=color:#666>=</span><span style=color:#b44>&#39;S!B\*d$zDsb=&#39;</span>
</span></span></code></pre></div><p>You must use single quotes <code>''</code> to escape special characters such as <code>$</code>, <code>\</code>,
<code>*</code>, <code>=</code>, and <code>!</code> in your strings. If you don't, your shell will interpret these
characters.</p><h3 id=use-source-files>Use source files</h3><ol><li><p>Store the credentials in files with the values encoded in base64:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;admin&#39;</span> | base64 &gt; ./username.txt
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;S!B\*d$zDsb=&#39;</span> | base64 &gt; ./password.txt
</span></span></code></pre></div><p>The <code>-n</code> flag ensures that the generated files do not have an extra newline
character at the end of the text. This is important because when <code>kubectl</code>
reads a file and encodes the content into a base64 string, the extra
newline character gets encoded too. You do not need to escape special
characters in strings that you include in a file.</p></li><li><p>Pass the file paths in the <code>kubectl</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic db-user-pass <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --from-file<span style=color:#666>=</span>./username.txt <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --from-file<span style=color:#666>=</span>./password.txt
</span></span></code></pre></div><p>The default key name is the file name. You can optionally set the key name
using <code>--from-file=[key=]source</code>. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic db-user-pass <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --from-file<span style=color:#666>=</span><span style=color:#b8860b>username</span><span style=color:#666>=</span>./username.txt <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --from-file<span style=color:#666>=</span><span style=color:#b8860b>password</span><span style=color:#666>=</span>./password.txt
</span></span></code></pre></div></li></ol><p>With either method, the output is similar to:</p><pre tabindex=0><code>secret/db-user-pass created
</code></pre><h3 id=verify-the-secret>Verify the Secret</h3><p>Check that the Secret was created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secrets
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>NAME              TYPE       DATA      AGE
db-user-pass      Opaque     2         51s
</code></pre><p>View the details of the Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe secret db-user-pass
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>Name:            db-user-pass
Namespace:       default
Labels:          &lt;none&gt;
Annotations:     &lt;none&gt;

Type:            Opaque

Data
====
password:    12 bytes
username:    5 bytes
</code></pre><p>The commands <code>kubectl get</code> and <code>kubectl describe</code> avoid showing the contents
of a <code>Secret</code> by default. This is to protect the <code>Secret</code> from being exposed
accidentally, or from being stored in a terminal log.</p><h3 id=decoding-secret>Decode the Secret</h3><ol><li><p>View the contents of the Secret you created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret db-user-pass -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.data}&#39;</span>
</span></span></code></pre></div><p>The output is similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:green;font-weight:700>&#34;password&#34;</span>:<span style=color:#b44>&#34;UyFCXCpkJHpEc2I9&#34;</span>,<span style=color:green;font-weight:700>&#34;username&#34;</span>:<span style=color:#b44>&#34;YWRtaW4=&#34;</span>}
</span></span></code></pre></div></li><li><p>Decode the <code>password</code> data:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#39;UyFCXCpkJHpEc2I9&#39;</span> | base64 --decode
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>S!B\*d$zDsb=
</code></pre><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> This is an example for documentation purposes. In practice,
this method could cause the command with the encoded data to be stored in
your shell history. Anyone with access to your computer could find the
command and decode the secret. A better approach is to combine the view and
decode commands.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret db-user-pass -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.data.password}&#39;</span> | base64 --decode
</span></span></code></pre></div></li></ol><h2 id=edit-secret>Edit a Secret</h2><p>You can edit an existing <code>Secret</code> object unless it is
<a href=/docs/concepts/configuration/secret/#secret-immutable>immutable</a>. To edit a
Secret, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit secrets &lt;secret-name&gt;
</span></span></code></pre></div><p>This opens your default editor and allows you to update the base64 encoded
Secret values in the <code>data</code> field, such as in the following example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># and an empty file will abort the edit. If an error occurs while saving this file, it will be</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># reopened with the relevant failures.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic>#</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>UyFCXCpkJHpEc2I9<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>YWRtaW4=<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2022-06-28T17:44:13Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>db-user-pass<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;12708504&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>91becd59-78fa-4c85-823f-6d44436242ac<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=clean-up>Clean up</h2><p>To delete a Secret, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret db-user-pass
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Read more about the <a href=/docs/concepts/configuration/secret/>Secret concept</a></li><li>Learn how to <a href=/docs/tasks/configmap-secret/managing-secret-using-config-file/>manage Secrets using config file</a></li><li>Learn how to <a href=/docs/tasks/configmap-secret/managing-secret-using-kustomize/>manage Secrets using kustomize</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e841cf91fd3566db1e86143ed7a9e13c>6.2 - Managing Secrets using Configuration File</h1><div class=lead>Creating Secret objects using resource configuration file.</div><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=create-the-config-file>Create the Secret</h2><p>You can define the <code>Secret</code> object in a manifest first, in JSON or YAML format,
and then create that object. The
<a href=/docs/reference/generated/kubernetes-api/v1.25/#secret-v1-core>Secret</a>
resource contains two maps: <code>data</code> and <code>stringData</code>.
The <code>data</code> field is used to store arbitrary data, encoded using base64. The
<code>stringData</code> field is provided for convenience, and it allows you to provide
the same data as unencoded strings.
The keys of <code>data</code> and <code>stringData</code> must consist of alphanumeric characters,
<code>-</code>, <code>_</code> or <code>.</code>.</p><p>The following example stores two strings in a Secret using the <code>data</code> field.</p><ol><li><p>Convert the strings to base64:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;admin&#39;</span> | base64
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;1f2d1e2e67df&#39;</span> | base64
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The serialized JSON and YAML values of Secret data are encoded as base64 strings. Newlines are not valid within these strings and must be omitted. When using the <code>base64</code> utility on Darwin/macOS, users should avoid using the <code>-b</code> option to split long lines. Conversely, Linux users <em>should</em> add the option <code>-w 0</code> to <code>base64</code> commands or the pipeline <code>base64 | tr -d '\n'</code> if the <code>-w</code> option is not available.</div><p>The output is similar to:</p><pre tabindex=0><code>YWRtaW4=
MWYyZDFlMmU2N2Rm
</code></pre></li><li><p>Create the manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysecret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>YWRtaW4=<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>MWYyZDFlMmU2N2Rm<span style=color:#bbb>
</span></span></span></code></pre></div><p>Note that the name of a Secret object must be a valid
<a href=/docs/concepts/overview/working-with-objects/names#dns-subdomain-names>DNS subdomain name</a>.</p></li><li><p>Create the Secret using <a href=/docs/reference/generated/kubectl/kubectl-commands#apply><code>kubectl apply</code></a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f ./secret.yaml
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>secret/mysecret created
</code></pre></li></ol><p>To verify that the Secret was created and to decode the Secret data, refer to
<a href=/docs/tasks/configmap-secret/managing-secret-using-kubectl/#verify-the-secret>Managing Secrets using kubectl</a>.</p><h3 id=specify-unencoded-data-when-creating-a-secret>Specify unencoded data when creating a Secret</h3><p>For certain scenarios, you may wish to use the <code>stringData</code> field instead. This
field allows you to put a non-base64 encoded string directly into the Secret,
and the string will be encoded for you when the Secret is created or updated.</p><p>A practical example of this might be where you are deploying an application
that uses a Secret to store a configuration file, and you want to populate
parts of that configuration file during your deployment process.</p><p>For example, if your application uses the following configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiUrl</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;https://my.api.com/api/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&lt;user&gt;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&lt;password&gt;&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>You could store this in a Secret using the following definition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysecret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>stringData</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>config.yaml</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    apiUrl: &#34;https://my.api.com/api/v1&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    username: &lt;user&gt;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    password: &lt;password&gt;</span><span style=color:#bbb>    
</span></span></span></code></pre></div><p>When you retrieve the Secret data, the command returns the encoded values,
and not the plaintext values you provided in <code>stringData</code>.</p><p>For example, if you run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret mysecret -o yaml
</span></span></code></pre></div><p>The output is similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>config.yaml</span>:<span style=color:#bbb> </span>YXBpVXJsOiAiaHR0cHM6Ly9teS5hcGkuY29tL2FwaS92MSIKdXNlcm5hbWU6IHt7dXNlcm5hbWV9fQpwYXNzd29yZDoge3twYXNzd29yZH19<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2018-11-15T20:40:59Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysecret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;7225&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>c280ad2e-e916-11e8-98f2-025000000001<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=specify-both-data-and-stringdata>Specify both <code>data</code> and <code>stringData</code></h3><p>If you specify a field in both <code>data</code> and <code>stringData</code>, the value from <code>stringData</code> is used.</p><p>For example, if you define the following Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysecret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>YWRtaW4=<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>stringData</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>administrator<span style=color:#bbb>
</span></span></span></code></pre></div><p>The <code>Secret</code> object is created as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>YWRtaW5pc3RyYXRvcg==<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2018-11-15T20:46:46Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysecret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;7579&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>91460ecb-e917-11e8-98f2-025000000001<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>YWRtaW5pc3RyYXRvcg==</code> decodes to <code>administrator</code>.</p><h2 id=edit-secret>Edit a Secret</h2><p>To edit the data in the Secret you created using a manifest, modify the <code>data</code>
or <code>stringData</code> field in your manifest and apply the file to your
cluster. You can edit an existing <code>Secret</code> object unless it is
<a href=/docs/concepts/configuration/secret/#secret-immutable>immutable</a>.</p><p>For example, if you want to change the password from the previous example to
<code>birdsarentreal</code>, do the following:</p><ol><li><p>Encode the new password string:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;birdsarentreal&#39;</span> | base64
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>YmlyZHNhcmVudHJlYWw=
</code></pre></li><li><p>Update the <code>data</code> field with your new password string:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysecret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Opaque<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>YWRtaW4=<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>YmlyZHNhcmVudHJlYWw=<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Apply the manifest to your cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f ./secret.yaml
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>secret/mysecret configured
</code></pre></li></ol><p>Kubernetes updates the existing <code>Secret</code> object. In detail, the <code>kubectl</code> tool
notices that there is an existing <code>Secret</code> object with the same name. <code>kubectl</code>
fetches the existing object, plans changes to it, and submits the changed
<code>Secret</code> object to your cluster control plane.</p><p>If you specified <code>kubectl apply --server-side</code> instead, <code>kubectl</code> uses
<a href=/docs/reference/using-api/server-side-apply/>Server Side Apply</a> instead.</p><h2 id=clean-up>Clean up</h2><p>To delete the Secret you have created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret mysecret
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Read more about the <a href=/docs/concepts/configuration/secret/>Secret concept</a></li><li>Learn how to <a href=/docs/tasks/configmap-secret/managing-secret-using-kubectl/>manage Secrets using kubectl</a></li><li>Learn how to <a href=/docs/tasks/configmap-secret/managing-secret-using-kustomize/>manage Secrets using kustomize</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a0ff2e3ba8af5670d5dc3d94c4bd0a68>6.3 - Managing Secrets using Kustomize</h1><div class=lead>Creating Secret objects using kustomization.yaml file.</div><p><code>kubectl</code> supports using the <a href=/docs/tasks/manage-kubernetes-objects/kustomization/>Kustomize object management tool</a> to manage Secrets
and ConfigMaps. You create a <em>resource generator</em> using Kustomize, which
generates a Secret that you can apply to the API server using <code>kubectl</code>.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=create-a-secret>Create a Secret</h2><p>You can generate a Secret by defining a <code>secretGenerator</code> in a
<code>kustomization.yaml</code> file that references other existing files, <code>.env</code> files, or
literal values. For example, the following instructions create a Kustomization
file for the username <code>admin</code> and the password <code>1f2d1e2e67df</code>.</p><h3 id=create-the-kustomization-file>Create the Kustomization file</h3><ul class="nav nav-tabs" id=secret-data role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#secret-data-0 role=tab aria-controls=secret-data-0 aria-selected=true>Literals</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#secret-data-1 role=tab aria-controls=secret-data-1>Files</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#secret-data-2 role=tab aria-controls=secret-data-2>.env files</a></li></ul><div class=tab-content id=secret-data><div id=secret-data-0 class="tab-pane show active" role=tabpanel aria-labelledby=secret-data-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>secretGenerator</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>database-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>literals</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- username=admin<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- password=1f2d1e2e67df<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=secret-data-1 class=tab-pane role=tabpanel aria-labelledby=secret-data-1><p><ol><li><p>Store the credentials in files with the values encoded in base64:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;admin&#39;</span> &gt; ./username.txt
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;1f2d1e2e67df&#39;</span> &gt; ./password.txt
</span></span></code></pre></div><p>The <code>-n</code> flag ensures that there's no newline character at the end of your
files.</p></li><li><p>Create the <code>kustomization.yaml</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>secretGenerator</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>database-creds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>files</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- username.txt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- password.txt<span style=color:#bbb>
</span></span></span></code></pre></div></li></ol></div><div id=secret-data-2 class=tab-pane role=tabpanel aria-labelledby=secret-data-2><p><p>You can also define the secretGenerator in the <code>kustomization.yaml</code> file by
providing <code>.env</code> files. For example, the following <code>kustomization.yaml</code> file
pulls in data from an <code>.env.secret</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>secretGenerator</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>db-user-pass<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>envs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- .env.secret<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In all cases, you don't need to base64 encode the values. The name of the YAML
file <strong>must</strong> be <code>kustomization.yaml</code> or <code>kustomization.yml</code>.</p><h3 id=apply-the-kustomization-file>Apply the kustomization file</h3><p>To create the Secret, apply the directory that contains the kustomization file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k &lt;directory-path&gt;
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>secret/database-creds-5hdh7hhgfk created
</code></pre><p>When a Secret is generated, the Secret name is created by hashing
the Secret data and appending the hash value to the name. This ensures that
a new Secret is generated each time the data is modified.</p><p>To verify that the Secret was created and to decode the Secret data, refer to
<a href=/docs/tasks/configmap-secret/managing-secret-using-kubectl/#verify-the-secret>Managing Secrets using kubectl</a>.</p><h2 id=edit-secret>Edit a Secret</h2><ol><li><p>In your <code>kustomization.yaml</code> file, modify the data, such as the <code>password</code>.</p></li><li><p>Apply the directory that contains the kustomization file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -k &lt;directory-path&gt;
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>secret/db-user-pass-6f24b56cc8 created
</code></pre></li></ol><p>The edited Secret is created as a new <code>Secret</code> object, instead of updating the
existing <code>Secret</code> object. You might need to update references to the Secret in
your Pods.</p><h2 id=clean-up>Clean up</h2><p>To delete a Secret, use <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret db-user-pass
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Read more about the <a href=/docs/concepts/configuration/secret/>Secret concept</a></li><li>Learn how to <a href=/docs/tasks/configmap-secret/managing-secret-using-kubectl/>manage Secrets using kubectl</a></li><li>Learn how to <a href=/docs/tasks/configmap-secret/managing-secret-using-config-file/>manage Secrets using config file</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-866924fa095f897ede8dfdcab9e97942>7 - Inject Data Into Applications</h1><div class=lead>Specify configuration and other data for the Pods that run your workload.</div></div><div class=td-content><h1 id=pg-c9af1e81bb6e109f6c41febe44f0931b>7.1 - Define a Command and Arguments for a Container</h1><p>This page shows how to define commands and arguments when you run a container
in a <a class=glossary-tooltip title='A Pod represents a set of running containers in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pod>Pod</a>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=define-a-command-and-arguments-when-you-create-a-pod>Define a command and arguments when you create a Pod</h2><p>When you create a Pod, you can define a command and arguments for the
containers that run in the Pod. To define a command, include the <code>command</code>
field in the configuration file. To define arguments for the command, include
the <code>args</code> field in the configuration file. The command and arguments that
you define cannot be changed after the Pod is created.</p><p>The command and arguments that you define in the configuration file
override the default command and arguments provided by the container image.
If you define args, but do not define a command, the default command is used
with your new arguments.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The <code>command</code> field corresponds to <code>entrypoint</code> in some container runtimes.</div><p>In this exercise, you create a Pod that runs one container. The configuration
file for the Pod defines a command and two arguments:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/commands.yaml download=pods/commands.yaml><code>pods/commands.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-commands-yaml")' title="Copy pods/commands.yaml to clipboard"></img></div><div class=includecode id=pods-commands-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>command-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>purpose</span>:<span style=color:#bbb> </span>demonstrate-command<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>command-demo-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>debian<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;printenv&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;HOSTNAME&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;KUBERNETES_PORT&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create a Pod based on the YAML configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/commands.yaml
</span></span></code></pre></div></li><li><p>List the running Pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>The output shows that the container that ran in the command-demo Pod has
completed.</p></li><li><p>To see the output of the command that ran in the container, view the logs
from the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs command-demo
</span></span></code></pre></div><p>The output shows the values of the HOSTNAME and KUBERNETES_PORT environment
variables:</p><pre tabindex=0><code>command-demo
tcp://10.3.240.1:443
</code></pre></li></ol><h2 id=use-environment-variables-to-define-arguments>Use environment variables to define arguments</h2><p>In the preceding example, you defined the arguments directly by
providing strings. As an alternative to providing strings directly,
you can define arguments by using environment variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MESSAGE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;hello world&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/bin/echo&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;$(MESSAGE)&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div><p>This means you can define an argument for a Pod using any of
the techniques available for defining environment variables, including
<a href=/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMaps</a>
and
<a href=/docs/concepts/configuration/secret/>Secrets</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The environment variable appears in parentheses, <code>"$(VAR)"</code>. This is
required for the variable to be expanded in the <code>command</code> or <code>args</code> field.</div><h2 id=run-a-command-in-a-shell>Run a command in a shell</h2><p>In some cases, you need your command to run in a shell. For example, your
command might consist of several commands piped together, or it might be a shell
script. To run your command in a shell, wrap it like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>command: <span style=color:#666>[</span><span style=color:#b44>&#34;/bin/sh&#34;</span><span style=color:#666>]</span>
</span></span><span style=display:flex><span>args: <span style=color:#666>[</span><span style=color:#b44>&#34;-c&#34;</span>, <span style=color:#b44>&#34;while true; do echo hello; sleep 10;done&#34;</span><span style=color:#666>]</span>
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/tasks/>configuring pods and containers</a>.</li><li>Learn more about <a href=/docs/tasks/debug/debug-application/get-shell-running-container/>running commands in a container</a>.</li><li>See <a href=/docs/reference/generated/kubernetes-api/v1.25/#container-v1-core>Container</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-eff97c25c917cdb414eda016df0e2bca>7.2 - Define Dependent Environment Variables</h1><p>This page shows how to define dependent environment variables for a container
in a Kubernetes Pod.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=define-an-environment-dependent-variable-for-a-container>Define an environment dependent variable for a container</h2><p>When you create a Pod, you can set dependent environment variables for the containers that run in the Pod. To set dependent environment variables, you can use $(VAR_NAME) in the <code>value</code> of <code>env</code> in the configuration file.</p><p>In this exercise, you create a Pod that runs one container. The configuration
file for the Pod defines a dependent environment variable with common usage defined. Here is the configuration manifest for the
Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/dependent-envars.yaml download=pods/inject/dependent-envars.yaml><code>pods/inject/dependent-envars.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-dependent-envars-yaml")' title="Copy pods/inject/dependent-envars.yaml to clipboard"></img></div><div class=includecode id=pods-inject-dependent-envars-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dependent-envars-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dependent-envars-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- while true; do echo -en &#39;\n&#39;; printf UNCHANGED_REFERENCE=$UNCHANGED_REFERENCE&#39;\n&#39;; printf SERVICE_ADDRESS=$SERVICE_ADDRESS&#39;\n&#39;;printf ESCAPED_REFERENCE=$ESCAPED_REFERENCE&#39;\n&#39;; sleep 30; done;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- sh<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SERVICE_PORT<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;80&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SERVICE_IP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;172.17.0.1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>UNCHANGED_REFERENCE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;$(PROTOCOL)://$(SERVICE_IP):$(SERVICE_PORT)&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>PROTOCOL<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;https&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SERVICE_ADDRESS<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;$(PROTOCOL)://$(SERVICE_IP):$(SERVICE_PORT)&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>ESCAPED_REFERENCE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;$$(PROTOCOL)://$(SERVICE_IP):$(SERVICE_PORT)&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create a Pod based on that manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/inject/dependent-envars.yaml
</span></span></code></pre></div><pre tabindex=0><code>pod/dependent-envars-demo created
</code></pre></li><li><p>List the running Pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods dependent-envars-demo
</span></span></code></pre></div><pre tabindex=0><code>NAME                      READY     STATUS    RESTARTS   AGE
dependent-envars-demo     1/1       Running   0          9s
</code></pre></li><li><p>Check the logs for the container running in your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs pod/dependent-envars-demo
</span></span></code></pre></div><pre tabindex=0><code>
UNCHANGED_REFERENCE=$(PROTOCOL)://172.17.0.1:80
SERVICE_ADDRESS=https://172.17.0.1:80
ESCAPED_REFERENCE=$(PROTOCOL)://172.17.0.1:80
</code></pre></li></ol><p>As shown above, you have defined the correct dependency reference of <code>SERVICE_ADDRESS</code>, bad dependency reference of <code>UNCHANGED_REFERENCE</code> and skip dependent references of <code>ESCAPED_REFERENCE</code>.</p><p>When an environment variable is already defined when being referenced,
the reference can be correctly resolved, such as in the <code>SERVICE_ADDRESS</code> case.</p><p>Note that order matters in the <code>env</code> list. An environment variable is not considered
"defined" if it is specified further down the list. That is why <code>UNCHANGED_REFERENCE</code>
fails to resolve <code>$(PROTOCOL)</code> in the example above.</p><p>When the environment variable is undefined or only includes some variables, the undefined environment variable is treated as a normal string, such as <code>UNCHANGED_REFERENCE</code>. Note that incorrectly parsed environment variables, in general, will not block the container from starting.</p><p>The <code>$(VAR_NAME)</code> syntax can be escaped with a double <code>$</code>, ie: <code>$$(VAR_NAME)</code>.
Escaped references are never expanded, regardless of whether the referenced variable
is defined or not. This can be seen from the <code>ESCAPED_REFERENCE</code> case above.</p><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/tasks/inject-data-application/environment-variable-expose-pod-information/>environment variables</a>.</li><li>See <a href=/docs/reference/generated/kubernetes-api/v1.25/#envvarsource-v1-core>EnvVarSource</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-82c93897176489678232542102daea40>7.3 - Define Environment Variables for a Container</h1><p>This page shows how to define environment variables for a container
in a Kubernetes Pod.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=define-an-environment-variable-for-a-container>Define an environment variable for a container</h2><p>When you create a Pod, you can set environment variables for the containers
that run in the Pod. To set environment variables, include the <code>env</code> or
<code>envFrom</code> field in the configuration file.</p><p>In this exercise, you create a Pod that runs one container. The configuration
file for the Pod defines an environment variable with name <code>DEMO_GREETING</code> and
value <code>"Hello from the environment"</code>. Here is the configuration manifest for the
Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/envars.yaml download=pods/inject/envars.yaml><code>pods/inject/envars.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-envars-yaml")' title="Copy pods/inject/envars.yaml to clipboard"></img></div><div class=includecode id=pods-inject-envars-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>envar-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>purpose</span>:<span style=color:#bbb> </span>demonstrate-envars<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>envar-demo-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/node-hello:1.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>DEMO_GREETING<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Hello from the environment&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>DEMO_FAREWELL<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Such a sweet sorrow&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create a Pod based on that manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/inject/envars.yaml
</span></span></code></pre></div></li><li><p>List the running Pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>purpose</span><span style=color:#666>=</span>demonstrate-envars
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>NAME            READY     STATUS    RESTARTS   AGE
envar-demo      1/1       Running   0          9s
</code></pre></li><li><p>List the Pod's container environment variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> envar-demo -- printenv
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NODE_VERSION=4.4.2
EXAMPLE_SERVICE_PORT_8080_TCP_ADDR=10.3.245.237
HOSTNAME=envar-demo
...
DEMO_GREETING=Hello from the environment
DEMO_FAREWELL=Such a sweet sorrow
</code></pre></li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The environment variables set using the <code>env</code> or <code>envFrom</code> field
override any environment variables specified in the container image.</div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Environment variables may reference each other, however ordering is important.
Variables making use of others defined in the same context must come later in
the list. Similarly, avoid circular references.</div><h2 id=using-environment-variables-inside-of-your-config>Using environment variables inside of your config</h2><p>Environment variables that you define in a Pod's configuration can be used
elsewhere in the configuration, for example in commands and arguments that
you set for the Pod's containers.
In the example configuration below, the <code>GREETING</code>, <code>HONORIFIC</code>, and
<code>NAME</code> environment variables are set to <code>Warm greetings to</code>, <code>The Most Honorable</code>, and <code>Kubernetes</code>, respectively. Those environment variables
are then used in the CLI arguments passed to the <code>env-print-demo</code>
container.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>print-greeting<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>env-print-demo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>bash<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>GREETING<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Warm greetings to&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>HONORIFIC<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;The Most Honorable&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>NAME<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Kubernetes&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;echo&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;$(GREETING) $(HONORIFIC) $(NAME)&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div><p>Upon creation, the command <code>echo Warm greetings to The Most Honorable Kubernetes</code> is run on the container.</p><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/tasks/inject-data-application/environment-variable-expose-pod-information/>environment variables</a>.</li><li>Learn about <a href=/docs/concepts/configuration/secret/#using-secrets-as-environment-variables>using secrets as environment variables</a>.</li><li>See <a href=/docs/reference/generated/kubernetes-api/v1.25/#envvarsource-v1-core>EnvVarSource</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-66c0456fdbef5e5116dd606d1e6f73cc>7.4 - Expose Pod Information to Containers Through Environment Variables</h1><p>This page shows how a Pod can use environment variables to expose information
about itself to containers running in the Pod, using the <em>downward API</em>.
You can use environment variables to expose Pod fields, container fields, or both.</p><p>In Kubernetes, there are two ways to expose Pod and container fields to a running container:</p><ul><li><em>Environment variables</em>, as explained in this task</li><li><a href=/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/>Volume files</a></li></ul><p>Together, these two ways of exposing Pod and container fields are called the
downward API.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=use-pod-fields-as-values-for-environment-variables>Use Pod fields as values for environment variables</h2><p>In this part of exercise, you create a Pod that has one container, and you
project Pod-level fields into the running container as environment variables.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/dapi-envars-pod.yaml download=pods/inject/dapi-envars-pod.yaml><code>pods/inject/dapi-envars-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-dapi-envars-pod-yaml")' title="Copy pods/inject/dapi-envars-pod.yaml to clipboard"></img></div><div class=includecode id=pods-inject-dapi-envars-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-envars-fieldref<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- while true; do<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>echo -en &#39;\n&#39;;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>printenv MY_NODE_NAME MY_POD_NAME MY_POD_NAMESPACE;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>printenv MY_POD_IP MY_POD_SERVICE_ACCOUNT;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>sleep 10;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>done;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_NODE_NAME<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>spec.nodeName<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_POD_NAME<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>metadata.name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_POD_NAMESPACE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>metadata.namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_POD_IP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>status.podIP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_POD_SERVICE_ACCOUNT<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>spec.serviceAccountName<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In that manifest, you can see five environment variables. The <code>env</code>
field is an array of
environment variable definitions.
The first element in the array specifies that the <code>MY_NODE_NAME</code> environment
variable gets its value from the Pod's <code>spec.nodeName</code> field. Similarly, the
other environment variables get their names from Pod fields.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The fields in this example are Pod fields. They are not fields of the
container in the Pod.</div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/inject/dapi-envars-pod.yaml
</span></span></code></pre></div><p>Verify that the container in the Pod is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># If the new Pod isn&#39;t yet healthy, rerun this command a few times.</span>
</span></span><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>View the container's logs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs dapi-envars-fieldref
</span></span></code></pre></div><p>The output shows the values of selected environment variables:</p><pre tabindex=0><code>minikube
dapi-envars-fieldref
default
172.17.0.4
default
</code></pre><p>To see why these values are in the log, look at the <code>command</code> and <code>args</code> fields
in the configuration file. When the container starts, it writes the values of
five environment variables to stdout. It repeats this every ten seconds.</p><p>Next, get a shell into the container that is running in your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it dapi-envars-fieldref -- sh
</span></span></code></pre></div><p>In your shell, view the environment variables:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this in a shell inside the container</span>
</span></span><span style=display:flex><span>printenv
</span></span></code></pre></div><p>The output shows that certain environment variables have been assigned the
values of Pod fields:</p><pre tabindex=0><code>MY_POD_SERVICE_ACCOUNT=default
...
MY_POD_NAMESPACE=default
MY_POD_IP=172.17.0.4
...
MY_NODE_NAME=minikube
...
MY_POD_NAME=dapi-envars-fieldref
</code></pre><h2 id=use-container-fields-as-values-for-environment-variables>Use container fields as values for environment variables</h2><p>In the preceding exercise, you used information from Pod-level fields as the values
for environment variables.
In this next exercise, you are going to pass fields that are part of the Pod
definition, but taken from the specific
<a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#Container>container</a>
rather than from the Pod overall.</p><p>Here is a manifest for another Pod that again has just one container:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/dapi-envars-container.yaml download=pods/inject/dapi-envars-container.yaml><code>pods/inject/dapi-envars-container.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-dapi-envars-container-yaml")' title="Copy pods/inject/dapi-envars-container.yaml to clipboard"></img></div><div class=includecode id=pods-inject-dapi-envars-container-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dapi-envars-resourcefieldref<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox:1.24<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- while true; do<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>echo -en &#39;\n&#39;;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>printenv MY_CPU_REQUEST MY_CPU_LIMIT;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>printenv MY_MEM_REQUEST MY_MEM_LIMIT;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>sleep 10;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>done;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;32Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;125m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;64Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;250m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_CPU_REQUEST<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>resourceFieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb> </span>requests.cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_CPU_LIMIT<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>resourceFieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb> </span>limits.cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_MEM_REQUEST<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>resourceFieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb> </span>requests.memory<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MY_MEM_LIMIT<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>resourceFieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb> </span>limits.memory<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In this manifest, you can see four environment variables. The <code>env</code>
field is an array of
environment variable definitions.
The first element in the array specifies that the <code>MY_CPU_REQUEST</code> environment
variable gets its value from the <code>requests.cpu</code> field of a container named
<code>test-container</code>. Similarly, the other environment variables get their values
from fields that are specific to this container.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/inject/dapi-envars-container.yaml
</span></span></code></pre></div><p>Verify that the container in the Pod is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># If the new Pod isn&#39;t yet healthy, rerun this command a few times.</span>
</span></span><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>View the container's logs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs dapi-envars-resourcefieldref
</span></span></code></pre></div><p>The output shows the values of selected environment variables:</p><pre tabindex=0><code>1
1
33554432
67108864
</code></pre><h2 id=what-s-next>What's next</h2><ul><li>Read <a href=/docs/tasks/inject-data-application/define-environment-variable-container/>Defining Environment Variables for a Container</a></li><li>Read the <a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#PodSpec><code>spec</code></a>
API definition for Pod. This includes the definition of Container (part of Pod).</li><li>Read the list of <a href=/docs/concepts/workloads/pods/downward-api/#available-fields>available fields</a> that you
can expose using the downward API.</li></ul><p>Read about Pods, containers and environment variables in the legacy API reference:</p><ul><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#podspec-v1-core>PodSpec</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#container-v1-core>Container</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#envvar-v1-core>EnvVar</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#envvarsource-v1-core>EnvVarSource</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#objectfieldselector-v1-core>ObjectFieldSelector</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#resourcefieldselector-v1-core>ResourceFieldSelector</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-bcf93d1cd019501fd0b7649e9fbcaf60>7.5 - Expose Pod Information to Containers Through Files</h1><p>This page shows how a Pod can use a
<a href=/docs/concepts/storage/volumes/#downwardapi><code>downwardAPI</code> volume</a>,
to expose information about itself to containers running in the Pod.
A <code>downwardAPI</code> volume can expose Pod fields and container fields.</p><p>In Kubernetes, there are two ways to expose Pod and container fields to a running container:</p><ul><li><a href=/docs/tasks/inject-data-application/environment-variable-expose-pod-information/>Environment variables</a></li><li>Volume files, as explained in this task</li></ul><p>Together, these two ways of exposing Pod and container fields are called the
<em>downward API</em>.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=store-pod-fields>Store Pod fields</h2><p>In this part of exercise, you create a Pod that has one container, and you
project Pod-level fields into the running container as files.
Here is the manifest for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/dapi-volume.yaml download=pods/inject/dapi-volume.yaml><code>pods/inject/dapi-volume.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-dapi-volume-yaml")' title="Copy pods/inject/dapi-volume.yaml to clipboard"></img></div><div class=includecode id=pods-inject-dapi-volume-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubernetes-downwardapi-volume-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>zone</span>:<span style=color:#bbb> </span>us-est-coast<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>test-cluster1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rack</span>:<span style=color:#bbb> </span>rack-22<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>build</span>:<span style=color:#bbb> </span>two<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>builder</span>:<span style=color:#bbb> </span>john-doe<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>client-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- while true; do<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>if [[ -e /etc/podinfo/labels ]]; then<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>echo -en &#39;\n\n&#39;; cat /etc/podinfo/labels; fi;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>if [[ -e /etc/podinfo/annotations ]]; then<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>echo -en &#39;\n\n&#39;; cat /etc/podinfo/annotations; fi;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>sleep 5;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>done;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>podinfo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/podinfo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>podinfo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>downwardAPI</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;labels&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>metadata.labels<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;annotations&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>metadata.annotations<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the manifest, you can see that the Pod has a <code>downwardAPI</code> Volume,
and the container mounts the volume at <code>/etc/podinfo</code>.</p><p>Look at the <code>items</code> array under <code>downwardAPI</code>. Each element of the array
defines a <code>downwardAPI</code> volume.
The first element specifies that the value of the Pod's
<code>metadata.labels</code> field should be stored in a file named <code>labels</code>.
The second element specifies that the value of the Pod's <code>annotations</code>
field should be stored in a file named <code>annotations</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The fields in this example are Pod fields. They are not
fields of the container in the Pod.</div><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/inject/dapi-volume.yaml
</span></span></code></pre></div><p>Verify that the container in the Pod is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>View the container's logs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs kubernetes-downwardapi-volume-example
</span></span></code></pre></div><p>The output shows the contents of the <code>labels</code> file and the <code>annotations</code> file:</p><pre tabindex=0><code>cluster=&#34;test-cluster1&#34;
rack=&#34;rack-22&#34;
zone=&#34;us-est-coast&#34;

build=&#34;two&#34;
builder=&#34;john-doe&#34;
</code></pre><p>Get a shell into the container that is running in your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it kubernetes-downwardapi-volume-example -- sh
</span></span></code></pre></div><p>In your shell, view the <code>labels</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/# cat /etc/podinfo/labels
</span></span></code></pre></div><p>The output shows that all of the Pod's labels have been written
to the <code>labels</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>cluster</span><span style=color:#666>=</span><span style=color:#b44>&#34;test-cluster1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>rack</span><span style=color:#666>=</span><span style=color:#b44>&#34;rack-22&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>zone</span><span style=color:#666>=</span><span style=color:#b44>&#34;us-est-coast&#34;</span>
</span></span></code></pre></div><p>Similarly, view the <code>annotations</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/# cat /etc/podinfo/annotations
</span></span></code></pre></div><p>View the files in the <code>/etc/podinfo</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/# ls -laR /etc/podinfo
</span></span></code></pre></div><p>In the output, you can see that the <code>labels</code> and <code>annotations</code> files
are in a temporary subdirectory: in this example,
<code>..2982_06_02_21_47_53.299460680</code>. In the <code>/etc/podinfo</code> directory, <code>..data</code> is
a symbolic link to the temporary subdirectory. Also in the <code>/etc/podinfo</code> directory,
<code>labels</code> and <code>annotations</code> are symbolic links.</p><pre tabindex=0><code>drwxr-xr-x  ... Feb 6 21:47 ..2982_06_02_21_47_53.299460680
lrwxrwxrwx  ... Feb 6 21:47 ..data -&gt; ..2982_06_02_21_47_53.299460680
lrwxrwxrwx  ... Feb 6 21:47 annotations -&gt; ..data/annotations
lrwxrwxrwx  ... Feb 6 21:47 labels -&gt; ..data/labels

/etc/..2982_06_02_21_47_53.299460680:
total 8
-rw-r--r--  ... Feb  6 21:47 annotations
-rw-r--r--  ... Feb  6 21:47 labels
</code></pre><p>Using symbolic links enables dynamic atomic refresh of the metadata; updates are
written to a new temporary directory, and the <code>..data</code> symlink is updated
atomically using <a href=http://man7.org/linux/man-pages/man2/rename.2.html>rename(2)</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> A container using Downward API as a
<a href=/docs/concepts/storage/volumes/#using-subpath>subPath</a> volume mount will not
receive Downward API updates.</div><p>Exit the shell:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/# <span style=color:#a2f>exit</span>
</span></span></code></pre></div><h2 id=store-container-fields>Store container fields</h2><p>The preceding exercise, you made Pod-level fields accessible using the
downward API.
In this next exercise, you are going to pass fields that are part of the Pod
definition, but taken from the specific
<a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#Container>container</a>
rather than from the Pod overall. Here is a manifest for a Pod that again has
just one container:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/dapi-volume-resources.yaml download=pods/inject/dapi-volume-resources.yaml><code>pods/inject/dapi-volume-resources.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-dapi-volume-resources-yaml")' title="Copy pods/inject/dapi-volume-resources.yaml to clipboard"></img></div><div class=includecode id=pods-inject-dapi-volume-resources-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubernetes-downwardapi-volume-example-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>client-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/busybox:1.24<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- while true; do<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>echo -en &#39;\n&#39;;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>if [[ -e /etc/podinfo/cpu_limit ]]; then<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>echo -en &#39;\n&#39;; cat /etc/podinfo/cpu_limit; fi;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>if [[ -e /etc/podinfo/cpu_request ]]; then<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>echo -en &#39;\n&#39;; cat /etc/podinfo/cpu_request; fi;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>if [[ -e /etc/podinfo/mem_limit ]]; then<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>echo -en &#39;\n&#39;; cat /etc/podinfo/mem_limit; fi;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>if [[ -e /etc/podinfo/mem_request ]]; then<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>echo -en &#39;\n&#39;; cat /etc/podinfo/mem_request; fi;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>sleep 5;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>done;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;32Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;125m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;64Mi&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;250m&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>podinfo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/podinfo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>podinfo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>downwardAPI</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;cpu_limit&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>resourceFieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>client-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb> </span>limits.cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>divisor</span>:<span style=color:#bbb> </span>1m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;cpu_request&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>resourceFieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>client-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb> </span>requests.cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>divisor</span>:<span style=color:#bbb> </span>1m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;mem_limit&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>resourceFieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>client-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb> </span>limits.memory<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>divisor</span>:<span style=color:#bbb> </span>1Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;mem_request&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>resourceFieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>client-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb> </span>requests.memory<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>divisor</span>:<span style=color:#bbb> </span>1Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the manifest, you can see that the Pod has a
<a href=/docs/concepts/storage/volumes/#downwardapi><code>downwardAPI</code> volume</a>,
and that the single container in that Pod mounts the volume at <code>/etc/podinfo</code>.</p><p>Look at the <code>items</code> array under <code>downwardAPI</code>. Each element of the array
defines a file in the downward API volume.</p><p>The first element specifies that in the container named <code>client-container</code>,
the value of the <code>limits.cpu</code> field in the format specified by <code>1m</code> should be
published as a file named <code>cpu_limit</code>. The <code>divisor</code> field is optional and has the
default value of <code>1</code>. A divisor of 1 means cores for <code>cpu</code> resources, or
bytes for <code>memory</code> resources.</p><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/inject/dapi-volume-resources.yaml
</span></span></code></pre></div><p>Get a shell into the container that is running in your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it kubernetes-downwardapi-volume-example-2 -- sh
</span></span></code></pre></div><p>In your shell, view the <code>cpu_limit</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this in a shell inside the container</span>
</span></span><span style=display:flex><span>cat /etc/podinfo/cpu_limit
</span></span></code></pre></div><p>You can use similar commands to view the <code>cpu_request</code>, <code>mem_limit</code> and
<code>mem_request</code> files.</p><h2 id=project-keys-to-specific-paths-and-file-permissions>Project keys to specific paths and file permissions</h2><p>You can project keys to specific paths and specific permissions on a per-file
basis. For more information, see
<a href=/docs/concepts/configuration/secret/>Secrets</a>.</p><h2 id=what-s-next>What's next</h2><ul><li>Read the <a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#PodSpec><code>spec</code></a>
API definition for Pod. This includes the definition of Container (part of Pod).</li><li>Read the list of <a href=/docs/concepts/workloads/pods/downward-api/#available-fields>available fields</a> that you
can expose using the downward API.</li></ul><p>Read about volumes in the legacy API reference:</p><ul><li>Check the <a href=/docs/reference/generated/kubernetes-api/v1.25/#volume-v1-core><code>Volume</code></a>
API definition which defines a generic volume in a Pod for containers to access.</li><li>Check the <a href=/docs/reference/generated/kubernetes-api/v1.25/#downwardapivolumesource-v1-core><code>DownwardAPIVolumeSource</code></a>
API definition which defines a volume that contains Downward API information.</li><li>Check the <a href=/docs/reference/generated/kubernetes-api/v1.25/#downwardapivolumefile-v1-core><code>DownwardAPIVolumeFile</code></a>
API definition which contains references to object or resource fields for
populating a file in the Downward API volume.</li><li>Check the <a href=/docs/reference/generated/kubernetes-api/v1.25/#resourcefieldselector-v1-core><code>ResourceFieldSelector</code></a>
API definition which specifies the container resources and their output format.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7f9454a1e775548c23ee5b300a9218a3>7.6 - Distribute Credentials Securely Using Secrets</h1><p>This page shows how to securely inject sensitive data, such as passwords and
encryption keys, into Pods.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h3 id=convert-your-secret-data-to-a-base-64-representation>Convert your secret data to a base-64 representation</h3><p>Suppose you want to have two pieces of secret data: a username <code>my-app</code> and a password
<code>39528$vdg7Jb</code>. First, use a base64 encoding tool to convert your username and password to a base64 representation. Here's an example using the commonly available base64 program:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;my-app&#39;</span> | base64
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -n <span style=color:#b44>&#39;39528$vdg7Jb&#39;</span> | base64
</span></span></code></pre></div><p>The output shows that the base-64 representation of your username is <code>bXktYXBw</code>,
and the base-64 representation of your password is <code>Mzk1MjgkdmRnN0pi</code>.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Use a local tool trusted by your OS to decrease the security risks of external tools.</div><h2 id=create-a-secret>Create a Secret</h2><p>Here is a configuration file you can use to create a Secret that holds your
username and password:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/secret.yaml download=pods/inject/secret.yaml><code>pods/inject/secret.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-secret-yaml")' title="Copy pods/inject/secret.yaml to clipboard"></img></div><div class=includecode id=pods-inject-secret-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>bXktYXBw<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>Mzk1MjgkdmRnN0pi<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create the Secret</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/inject/secret.yaml
</span></span></code></pre></div></li><li><p>View information about the Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get secret test-secret
</span></span></code></pre></div><p>Output:</p><pre tabindex=0><code>NAME          TYPE      DATA      AGE
test-secret   Opaque    2         1m
</code></pre></li><li><p>View more detailed information about the Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe secret test-secret
</span></span></code></pre></div><p>Output:</p><pre tabindex=0><code>Name:       test-secret
Namespace:  default
Labels:     &lt;none&gt;
Annotations:    &lt;none&gt;

Type:   Opaque

Data
====
password:   13 bytes
username:   7 bytes
</code></pre></li></ol><h3 id=create-a-secret-directly-with-kubectl>Create a Secret directly with kubectl</h3><p>If you want to skip the Base64 encoding step, you can create the
same Secret using the <code>kubectl create secret</code> command. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic test-secret --from-literal<span style=color:#666>=</span><span style=color:#b44>&#39;username=my-app&#39;</span> --from-literal<span style=color:#666>=</span><span style=color:#b44>&#39;password=39528$vdg7Jb&#39;</span>
</span></span></code></pre></div><p>This is more convenient. The detailed approach shown earlier runs
through each step explicitly to demonstrate what is happening.</p><h2 id=create-a-pod-that-has-access-to-the-secret-data-through-a-volume>Create a Pod that has access to the secret data through a Volume</h2><p>Here is a configuration file you can use to create a Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/secret-pod.yaml download=pods/inject/secret-pod.yaml><code>pods/inject/secret-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-secret-pod-yaml")' title="Copy pods/inject/secret-pod.yaml to clipboard"></img></div><div class=includecode id=pods-inject-secret-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>secret-test-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># name must match the volume name below</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>secret-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/secret-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># The secret data is exposed to Containers in the Pod through a Volume.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>secret-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>secret</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>secretName</span>:<span style=color:#bbb> </span>test-secret<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/inject/secret-pod.yaml
</span></span></code></pre></div></li><li><p>Verify that your Pod is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod secret-test-pod
</span></span></code></pre></div><p>Output:</p><pre tabindex=0><code>NAME              READY     STATUS    RESTARTS   AGE
secret-test-pod   1/1       Running   0          42m
</code></pre></li><li><p>Get a shell into the Container that is running in your Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t secret-test-pod -- /bin/bash
</span></span></code></pre></div></li><li><p>The secret data is exposed to the Container through a Volume mounted under
<code>/etc/secret-volume</code>.</p><p>In your shell, list the files in the <code>/etc/secret-volume</code> directory:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this in the shell inside the container</span>
</span></span><span style=display:flex><span>ls /etc/secret-volume
</span></span></code></pre></div><p>The output shows two files, one for each piece of secret data:</p><pre tabindex=0><code>password username
</code></pre></li><li><p>In your shell, display the contents of the <code>username</code> and <code>password</code> files:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this in the shell inside the container</span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#a2f;font-weight:700>$(</span> cat /etc/secret-volume/username <span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#a2f;font-weight:700>$(</span> cat /etc/secret-volume/password <span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>&#34;</span>
</span></span></code></pre></div><p>The output is your username and password:</p><pre tabindex=0><code>my-app
39528$vdg7Jb
</code></pre></li></ol><h2 id=define-container-environment-variables-using-secret-data>Define container environment variables using Secret data</h2><h3 id=define-a-container-environment-variable-with-data-from-a-single-secret>Define a container environment variable with data from a single Secret</h3><ul><li><p>Define an environment variable as a key-value pair in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic backend-user --from-literal<span style=color:#666>=</span>backend-username<span style=color:#666>=</span><span style=color:#b44>&#39;backend-admin&#39;</span>
</span></span></code></pre></div></li><li><p>Assign the <code>backend-username</code> value defined in the Secret to the <code>SECRET_USERNAME</code> environment variable in the Pod specification.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/pod-single-secret-env-variable.yaml download=pods/inject/pod-single-secret-env-variable.yaml><code>pods/inject/pod-single-secret-env-variable.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-pod-single-secret-env-variable-yaml")' title="Copy pods/inject/pod-single-secret-env-variable.yaml to clipboard"></img></div><div class=includecode id=pods-inject-pod-single-secret-env-variable-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>env-single-secret<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>envars-test-container<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>SECRET_USERNAME<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>secretKeyRef</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>backend-user<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>backend-username<span style=color:#bbb>
   </span></span></span></code></pre></div></div></div></li><li><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/pods/inject/pod-single-secret-env-variable.yaml
</span></span></code></pre></div></li><li><p>In your shell, display the content of <code>SECRET_USERNAME</code> container environment variable</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t env-single-secret -- /bin/sh -c <span style=color:#b44>&#39;echo $SECRET_USERNAME&#39;</span>
</span></span></code></pre></div><p>The output is</p><pre tabindex=0><code>backend-admin
</code></pre></li></ul><h3 id=define-container-environment-variables-with-data-from-multiple-secrets>Define container environment variables with data from multiple Secrets</h3><ul><li><p>As with the previous example, create the Secrets first.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic backend-user --from-literal<span style=color:#666>=</span>backend-username<span style=color:#666>=</span><span style=color:#b44>&#39;backend-admin&#39;</span>
</span></span><span style=display:flex><span>kubectl create secret generic db-user --from-literal<span style=color:#666>=</span>db-username<span style=color:#666>=</span><span style=color:#b44>&#39;db-admin&#39;</span>
</span></span></code></pre></div></li><li><p>Define the environment variables in the Pod specification.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/pod-multiple-secret-env-variable.yaml download=pods/inject/pod-multiple-secret-env-variable.yaml><code>pods/inject/pod-multiple-secret-env-variable.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-pod-multiple-secret-env-variable-yaml")' title="Copy pods/inject/pod-multiple-secret-env-variable.yaml to clipboard"></img></div><div class=includecode id=pods-inject-pod-multiple-secret-env-variable-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>envvars-multiple-secrets<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>envars-test-container<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>BACKEND_USERNAME<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>secretKeyRef</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>backend-user<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>backend-username<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>DB_USERNAME<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>valueFrom</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>secretKeyRef</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>db-user<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>db-username<span style=color:#bbb>
   </span></span></span></code></pre></div></div></div></li><li><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/pods/inject/pod-multiple-secret-env-variable.yaml
</span></span></code></pre></div></li><li><p>In your shell, display the container environment variables</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t envvars-multiple-secrets -- /bin/sh -c <span style=color:#b44>&#39;env | grep _USERNAME&#39;</span>
</span></span></code></pre></div><p>The output is</p><pre tabindex=0><code>DB_USERNAME=db-admin
BACKEND_USERNAME=backend-admin
</code></pre></li></ul><h2 id=configure-all-key-value-pairs-in-a-secret-as-container-environment-variables>Configure all key-value pairs in a Secret as container environment variables</h2><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This functionality is available in Kubernetes v1.6 and later.</div><ul><li><p>Create a Secret containing multiple key-value pairs</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret generic test-secret --from-literal<span style=color:#666>=</span><span style=color:#b8860b>username</span><span style=color:#666>=</span><span style=color:#b44>&#39;my-app&#39;</span> --from-literal<span style=color:#666>=</span><span style=color:#b8860b>password</span><span style=color:#666>=</span><span style=color:#b44>&#39;39528$vdg7Jb&#39;</span>
</span></span></code></pre></div></li><li><p>Use envFrom to define all of the Secret's data as container environment variables. The key from the Secret becomes the environment variable name in the Pod.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/inject/pod-secret-envFrom.yaml download=pods/inject/pod-secret-envFrom.yaml><code>pods/inject/pod-secret-envFrom.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-inject-pod-secret-envfrom-yaml")' title="Copy pods/inject/pod-secret-envFrom.yaml to clipboard"></img></div><div class=includecode id=pods-inject-pod-secret-envfrom-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>envfrom-secret<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>envars-test-container<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>envFrom</span>:<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>secretRef</span>:<span style=color:#bbb>
    </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-secret<span style=color:#bbb>
    </span></span></span></code></pre></div></div></div></li><li><p>Create the Pod:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/pods/inject/pod-secret-envFrom.yaml
</span></span></code></pre></div></li><li><p>In your shell, display <code>username</code> and <code>password</code> container environment variables</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -i -t envfrom-secret -- /bin/sh -c <span style=color:#b44>&#39;echo &#34;username: $username\npassword: $password\n&#34;&#39;</span>
</span></span></code></pre></div><p>The output is</p><pre tabindex=0><code>username: my-app
password: 39528$vdg7Jb
</code></pre></li></ul><h3 id=references>References</h3><ul><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#secret-v1-core>Secret</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#volume-v1-core>Volume</a></li><li><a href=/docs/reference/generated/kubernetes-api/v1.25/#pod-v1-core>Pod</a></li></ul><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/configuration/secret/>Secrets</a>.</li><li>Learn about <a href=/docs/concepts/storage/volumes/>Volumes</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a78a5e7e765fd8c49c8f7c0d72499f72>8 - Run Applications</h1><div class=lead>Run and manage both stateless and stateful applications.</div></div><div class=td-content><h1 id=pg-790ea02857492b3a822e981e93e3a98b>8.1 - Run a Stateless Application Using a Deployment</h1><p>This page shows how to run an application using a Kubernetes Deployment object.</p><h2 id=objectives>Objectives</h2><ul><li>Create an nginx deployment.</li><li>Use kubectl to list information about the deployment.</li><li>Update the deployment.</li></ul><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.9.
To check the version, enter <code>kubectl version</code>.</p><h2 id=creating-and-exploring-an-nginx-deployment>Creating and exploring an nginx deployment</h2><p>You can run an application by creating a Kubernetes Deployment object, and you
can describe a Deployment in a YAML file. For example, this YAML file describes
a Deployment that runs the nginx:1.14.2 Docker image:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment.yaml download=application/deployment.yaml><code>application/deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-deployment-yaml")' title="Copy application/deployment.yaml to clipboard"></img></div><div class=includecode id=application-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># tells deployment to run 2 pods matching the template</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.14.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Create a Deployment based on the YAML file:</p><pre><code> kubectl apply -f https://k8s.io/examples/application/deployment.yaml
</code></pre></li><li><p>Display information about the Deployment:</p><pre><code> kubectl describe deployment nginx-deployment
</code></pre><p>The output is similar to this:</p><pre><code> Name:     nginx-deployment
 Namespace:    default
 CreationTimestamp:  Tue, 30 Aug 2016 18:11:37 -0700
 Labels:     app=nginx
 Annotations:    deployment.kubernetes.io/revision=1
 Selector:   app=nginx
 Replicas:   2 desired | 2 updated | 2 total | 2 available | 0 unavailable
 StrategyType:   RollingUpdate
 MinReadySeconds:  0
 RollingUpdateStrategy:  1 max unavailable, 1 max surge
 Pod Template:
   Labels:       app=nginx
   Containers:
    nginx:
     Image:              nginx:1.14.2
     Port:               80/TCP
     Environment:        &lt;none&gt;
     Mounts:             &lt;none&gt;
   Volumes:              &lt;none&gt;
 Conditions:
   Type          Status  Reason
   ----          ------  ------
   Available     True    MinimumReplicasAvailable
   Progressing   True    NewReplicaSetAvailable
 OldReplicaSets:   &lt;none&gt;
 NewReplicaSet:    nginx-deployment-1771418926 (2/2 replicas created)
 No events.
</code></pre></li><li><p>List the Pods created by the deployment:</p><pre><code> kubectl get pods -l app=nginx
</code></pre><p>The output is similar to this:</p><pre><code> NAME                                READY     STATUS    RESTARTS   AGE
 nginx-deployment-1771418926-7o5ns   1/1       Running   0          16h
 nginx-deployment-1771418926-r18az   1/1       Running   0          16h
</code></pre></li><li><p>Display information about a Pod:</p><pre><code> kubectl describe pod &lt;pod-name&gt;
</code></pre><p>where <code>&lt;pod-name></code> is the name of one of your Pods.</p></li></ol><h2 id=updating-the-deployment>Updating the deployment</h2><p>You can update the deployment by applying a new YAML file. This YAML file
specifies that the deployment should be updated to use nginx 1.16.1.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment-update.yaml download=application/deployment-update.yaml><code>application/deployment-update.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-deployment-update-yaml")' title="Copy application/deployment-update.yaml to clipboard"></img></div><div class=includecode id=application-deployment-update-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16.1<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Update the version of nginx from 1.14.2 to 1.16.1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Apply the new YAML file:</p><pre><code>  kubectl apply -f https://k8s.io/examples/application/deployment-update.yaml
</code></pre></li><li><p>Watch the deployment create pods with new names and delete the old pods:</p><pre><code>  kubectl get pods -l app=nginx
</code></pre></li></ol><h2 id=scaling-the-application-by-increasing-the-replica-count>Scaling the application by increasing the replica count</h2><p>You can increase the number of Pods in your Deployment by applying a new YAML
file. This YAML file sets <code>replicas</code> to 4, which specifies that the Deployment
should have four Pods:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/deployment-scale.yaml download=application/deployment-scale.yaml><code>application/deployment-scale.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-deployment-scale-yaml")' title="Copy application/deployment-scale.yaml to clipboard"></img></div><div class=includecode id=application-deployment-scale-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>4</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># Update the replicas from 2 to 4</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx:1.16.1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Apply the new YAML file:</p><pre><code> kubectl apply -f https://k8s.io/examples/application/deployment-scale.yaml
</code></pre></li><li><p>Verify that the Deployment has four Pods:</p><pre><code> kubectl get pods -l app=nginx
</code></pre><p>The output is similar to this:</p><pre><code> NAME                               READY     STATUS    RESTARTS   AGE
 nginx-deployment-148880595-4zdqq   1/1       Running   0          25s
 nginx-deployment-148880595-6zgi1   1/1       Running   0          25s
 nginx-deployment-148880595-fxcez   1/1       Running   0          2m
 nginx-deployment-148880595-rwovn   1/1       Running   0          2m
</code></pre></li></ol><h2 id=deleting-a-deployment>Deleting a deployment</h2><p>Delete the deployment by name:</p><pre><code>kubectl delete deployment nginx-deployment
</code></pre><h2 id=replicationcontrollers-the-old-way>ReplicationControllers -- the Old Way</h2><p>The preferred way to create a replicated application is to use a Deployment,
which in turn uses a ReplicaSet. Before the Deployment and ReplicaSet were
added to Kubernetes, replicated applications were configured using a
<a href=/docs/concepts/workloads/controllers/replicationcontroller/>ReplicationController</a>.</p><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/workloads/controllers/deployment/>Deployment objects</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-43398a6f5dc7ce19df59f5f4c2e7922d>8.2 - Run a Single-Instance Stateful Application</h1><p>This page shows you how to run a single-instance stateful application
in Kubernetes using a PersistentVolume and a Deployment. The
application is MySQL.</p><h2 id=objectives>Objectives</h2><ul><li>Create a PersistentVolume referencing a disk in your environment.</li><li>Create a MySQL Deployment.</li><li>Expose MySQL to other pods in the cluster at a known DNS name.</li></ul><h2 id=before-you-begin>Before you begin</h2><ul><li><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p></li><li><p>You need to either have a <a href=/docs/concepts/storage/dynamic-provisioning/>dynamic PersistentVolume provisioner</a> with a default
<a href=/docs/concepts/storage/storage-classes/>StorageClass</a>,
or <a href=/docs/concepts/storage/persistent-volumes/#provisioning>statically provision PersistentVolumes</a>
yourself to satisfy the <a href=/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims>PersistentVolumeClaims</a>
used here.</p></li></ul><h2 id=deploy-mysql>Deploy MySQL</h2><p>You can run a stateful application by creating a Kubernetes Deployment
and connecting it to an existing PersistentVolume using a
PersistentVolumeClaim. For example, this YAML file describes a
Deployment that runs MySQL and references the PersistentVolumeClaim. The file
defines a volume mount for /var/lib/mysql, and then creates a
PersistentVolumeClaim that looks for a 20G volume. This claim is
satisfied by any existing volume that meets the requirements,
or by a dynamic provisioner.</p><p>Note: The password is defined in the config yaml, and this is insecure. See
<a href=/docs/concepts/configuration/secret/>Kubernetes Secrets</a>
for a secure solution.</p><p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/mysql/mysql-deployment.yaml download=application/mysql/mysql-deployment.yaml><code>application/mysql/mysql-deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-mysql-mysql-deployment-yaml")' title="Copy application/mysql/mysql-deployment.yaml to clipboard"></img></div><div class=includecode id=application-mysql-mysql-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>3306</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIP</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Recreate<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mysql:5.6<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># Use secret in real usage</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MYSQL_ROOT_PASSWORD<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>password<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>3306</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql-persistent-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/lib/mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql-persistent-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>persistentVolumeClaim</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>claimName</span>:<span style=color:#bbb> </span>mysql-pv-claim<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/mysql/mysql-pv.yaml download=application/mysql/mysql-pv.yaml><code>application/mysql/mysql-pv.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-mysql-mysql-pv-yaml")' title="Copy application/mysql/mysql-pv.yaml to clipboard"></img></div><div class=includecode id=application-mysql-mysql-pv-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PersistentVolume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql-pv-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>local<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>storageClassName</span>:<span style=color:#bbb> </span>manual<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>capacity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>20Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>accessModes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ReadWriteOnce<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/mnt/data&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PersistentVolumeClaim<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql-pv-claim<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>storageClassName</span>:<span style=color:#bbb> </span>manual<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>accessModes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ReadWriteOnce<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>20Gi<span style=color:#bbb>
</span></span></span></code></pre></div></div></div></p><ol><li><p>Deploy the PV and PVC of the YAML file:</p><pre><code> kubectl apply -f https://k8s.io/examples/application/mysql/mysql-pv.yaml
</code></pre></li><li><p>Deploy the contents of the YAML file:</p><pre><code> kubectl apply -f https://k8s.io/examples/application/mysql/mysql-deployment.yaml
</code></pre></li><li><p>Display information about the Deployment:</p><pre><code> kubectl describe deployment mysql
</code></pre><p>The output is similar to this:</p><pre><code> Name:                 mysql
 Namespace:            default
 CreationTimestamp:    Tue, 01 Nov 2016 11:18:45 -0700
 Labels:               app=mysql
 Annotations:          deployment.kubernetes.io/revision=1
 Selector:             app=mysql
 Replicas:             1 desired | 1 updated | 1 total | 0 available | 1 unavailable
 StrategyType:         Recreate
 MinReadySeconds:      0
 Pod Template:
   Labels:       app=mysql
   Containers:
    mysql:
     Image:      mysql:5.6
     Port:       3306/TCP
     Environment:
       MYSQL_ROOT_PASSWORD:      password
     Mounts:
       /var/lib/mysql from mysql-persistent-storage (rw)
   Volumes:
    mysql-persistent-storage:
     Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
     ClaimName:  mysql-pv-claim
     ReadOnly:   false
 Conditions:
   Type          Status  Reason
   ----          ------  ------
   Available     False   MinimumReplicasUnavailable
   Progressing   True    ReplicaSetUpdated
 OldReplicaSets:       &lt;none&gt;
 NewReplicaSet:        mysql-63082529 (1/1 replicas created)
 Events:
   FirstSeen    LastSeen    Count    From                SubobjectPath    Type        Reason            Message
   ---------    --------    -----    ----                -------------    --------    ------            -------
   33s          33s         1        {deployment-controller }             Normal      ScalingReplicaSet Scaled up replica set mysql-63082529 to 1
</code></pre></li><li><p>List the pods created by the Deployment:</p><pre><code> kubectl get pods -l app=mysql
</code></pre><p>The output is similar to this:</p><pre><code> NAME                   READY     STATUS    RESTARTS   AGE
 mysql-63082529-2z3ki   1/1       Running   0          3m
</code></pre></li><li><p>Inspect the PersistentVolumeClaim:</p><pre><code> kubectl describe pvc mysql-pv-claim
</code></pre><p>The output is similar to this:</p><pre><code> Name:         mysql-pv-claim
 Namespace:    default
 StorageClass:
 Status:       Bound
 Volume:       mysql-pv-volume
 Labels:       &lt;none&gt;
 Annotations:    pv.kubernetes.io/bind-completed=yes
                 pv.kubernetes.io/bound-by-controller=yes
 Capacity:     20Gi
 Access Modes: RWO
 Events:       &lt;none&gt;
</code></pre></li></ol><h2 id=accessing-the-mysql-instance>Accessing the MySQL instance</h2><p>The preceding YAML file creates a service that
allows other Pods in the cluster to access the database. The Service option
<code>clusterIP: None</code> lets the Service DNS name resolve directly to the
Pod's IP address. This is optimal when you have only one Pod
behind a Service and you don't intend to increase the number of Pods.</p><p>Run a MySQL client to connect to the server:</p><pre tabindex=0><code>kubectl run -it --rm --image=mysql:5.6 --restart=Never mysql-client -- mysql -h mysql -ppassword
</code></pre><p>This command creates a new Pod in the cluster running a MySQL client
and connects it to the server through the Service. If it connects, you
know your stateful MySQL database is up and running.</p><pre tabindex=0><code>Waiting for pod default/mysql-client-274442439-zyp6i to be running, status is Pending, pod ready: false
If you don&#39;t see a command prompt, try pressing enter.

mysql&gt;
</code></pre><h2 id=updating>Updating</h2><p>The image or any other part of the Deployment can be updated as usual
with the <code>kubectl apply</code> command. Here are some precautions that are
specific to stateful apps:</p><ul><li>Don't scale the app. This setup is for single-instance apps
only. The underlying PersistentVolume can only be mounted to one
Pod. For clustered stateful apps, see the
<a href=/docs/concepts/workloads/controllers/statefulset/>StatefulSet documentation</a>.</li><li>Use <code>strategy:</code> <code>type: Recreate</code> in the Deployment configuration
YAML file. This instructs Kubernetes to <em>not</em> use rolling
updates. Rolling updates will not work, as you cannot have more than
one Pod running at a time. The <code>Recreate</code> strategy will stop the
first pod before creating a new one with the updated configuration.</li></ul><h2 id=deleting-a-deployment>Deleting a deployment</h2><p>Delete the deployed objects by name:</p><pre tabindex=0><code>kubectl delete deployment,svc mysql
kubectl delete pvc mysql-pv-claim
kubectl delete pv mysql-pv-volume
</code></pre><p>If you manually provisioned a PersistentVolume, you also need to manually
delete it, as well as release the underlying resource.
If you used a dynamic provisioner, it automatically deletes the
PersistentVolume when it sees that you deleted the PersistentVolumeClaim.
Some dynamic provisioners (such as those for EBS and PD) also release the
underlying resource upon deleting the PersistentVolume.</p><h2 id=what-s-next>What's next</h2><ul><li><p>Learn more about <a href=/docs/concepts/workloads/controllers/deployment/>Deployment objects</a>.</p></li><li><p>Learn more about <a href=/docs/tasks/run-application/run-stateless-application-deployment/>Deploying applications</a></p></li><li><p><a href=/docs/reference/generated/kubectl/kubectl-commands/#run>kubectl run documentation</a></p></li><li><p><a href=/docs/concepts/storage/volumes/>Volumes</a> and <a href=/docs/concepts/storage/persistent-volumes/>Persistent Volumes</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-95b3d561509c573e53bec2368264cf6a>8.3 - Run a Replicated Stateful Application</h1><p>This page shows how to run a replicated stateful application using a
<a class=glossary-tooltip title='Manages deployment and scaling of a set of Pods, with durable storage and persistent identifiers for each Pod.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/statefulset/ target=_blank aria-label=StatefulSet>StatefulSet</a>.
This application is a replicated MySQL database. The example topology has a
single primary server and multiple replicas, using asynchronous row-based
replication.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <strong>This is not a production configuration</strong>. MySQL settings remain on insecure defaults to keep the focus
on general patterns for running stateful applications in Kubernetes.</div><h2 id=before-you-begin>Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul></li><li><p>You need to either have a <a href=/docs/concepts/storage/dynamic-provisioning/>dynamic PersistentVolume provisioner</a> with a default
<a href=/docs/concepts/storage/storage-classes/>StorageClass</a>,
or <a href=/docs/concepts/storage/persistent-volumes/#provisioning>statically provision PersistentVolumes</a>
yourself to satisfy the <a href=/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims>PersistentVolumeClaims</a>
used here.</p></li><li>This tutorial assumes you are familiar with
<a href=/docs/concepts/storage/persistent-volumes/>PersistentVolumes</a>
and <a href=/docs/concepts/workloads/controllers/statefulset/>StatefulSets</a>,
as well as other core concepts like <a href=/docs/concepts/workloads/pods/>Pods</a>,
<a href=/docs/concepts/services-networking/service/>Services</a>, and
<a href=/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMaps</a>.</li><li>Some familiarity with MySQL helps, but this tutorial aims to present
general patterns that should be useful for other systems.</li><li>You are using the default namespace or another namespace that does not contain any conflicting objects.</li></ul><h2 id=objectives>Objectives</h2><ul><li>Deploy a replicated MySQL topology with a StatefulSet.</li><li>Send MySQL client traffic.</li><li>Observe resistance to downtime.</li><li>Scale the StatefulSet up and down.</li></ul><h2 id=deploy-mysql>Deploy MySQL</h2><p>The example MySQL deployment consists of a ConfigMap, two Services,
and a StatefulSet.</p><h3 id=configmap>Create a ConfigMap</h3><p>Create the ConfigMap from the following YAML configuration file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/mysql/mysql-configmap.yaml download=application/mysql/mysql-configmap.yaml><code>application/mysql/mysql-configmap.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-mysql-mysql-configmap-yaml")' title="Copy application/mysql/mysql-configmap.yaml to clipboard"></img></div><div class=includecode id=application-mysql-mysql-configmap-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>primary.cnf</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    # Apply this config only on the primary.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    [mysqld]
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    log-bin</span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replica.cnf</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    # Apply this config only on replicas.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    [mysqld]
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    super-read-only</span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/mysql/mysql-configmap.yaml
</span></span></code></pre></div><p>This ConfigMap provides <code>my.cnf</code> overrides that let you independently control
configuration on the primary MySQL server and its replicas.
In this case, you want the primary server to be able to serve replication logs to replicas
and you want replicas to reject any writes that don't come via replication.</p><p>There's nothing special about the ConfigMap itself that causes different
portions to apply to different Pods.
Each Pod decides which portion to look at as it's initializing,
based on information provided by the StatefulSet controller.</p><h3 id=services>Create Services</h3><p>Create the Services from the following YAML configuration file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/mysql/mysql-services.yaml download=application/mysql/mysql-services.yaml><code>application/mysql/mysql-services.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-mysql-mysql-services-yaml")' title="Copy application/mysql/mysql-services.yaml to clipboard"></img></div><div class=includecode id=application-mysql-mysql-services-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Headless service for stable DNS entries of StatefulSet members.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>3306</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIP</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Client service for connecting to any MySQL instance for reads.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># For writes, you must instead connect to the primary: mysql-0.mysql.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql-read<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>readonly</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>3306</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/mysql/mysql-services.yaml
</span></span></code></pre></div><p>The headless Service provides a home for the DNS entries that the StatefulSet
<a class=glossary-tooltip title='A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/controller/ target=_blank aria-label=controllers>controllers</a> creates for each
Pod that's part of the set.
Because the headless Service is named <code>mysql</code>, the Pods are accessible by
resolving <code>&lt;pod-name>.mysql</code> from within any other Pod in the same Kubernetes
cluster and namespace.</p><p>The client Service, called <code>mysql-read</code>, is a normal Service with its own
cluster IP that distributes connections across all MySQL Pods that report
being Ready. The set of potential endpoints includes the primary MySQL server and all
replicas.</p><p>Note that only read queries can use the load-balanced client Service.
Because there is only one primary MySQL server, clients should connect directly to the
primary MySQL Pod (through its DNS entry within the headless Service) to execute
writes.</p><h3 id=statefulset>Create the StatefulSet</h3><p>Finally, create the StatefulSet from the following YAML configuration file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/mysql/mysql-statefulset.yaml download=application/mysql/mysql-statefulset.yaml><code>application/mysql/mysql-statefulset.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-mysql-mysql-statefulset-yaml")' title="Copy application/mysql/mysql-statefulset.yaml to clipboard"></img></div><div class=includecode id=application-mysql-mysql-statefulset-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>StatefulSet<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>serviceName</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initContainers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>init-mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mysql:5.7<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- bash<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;-c&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          set -ex
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Generate mysql server-id from pod ordinal index.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          [[ $HOSTNAME =~ -([0-9]+)$ ]] || exit 1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          ordinal=${BASH_REMATCH[1]}
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Add an offset to avoid reserved server-id=0 value.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Copy appropriate conf.d files from config-map to emptyDir.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          if [[ $ordinal -eq 0 ]]; then
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            cp /mnt/config-map/primary.cnf /mnt/conf.d/
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          else
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            cp /mnt/config-map/replica.cnf /mnt/conf.d/
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          fi</span><span style=color:#bbb>          
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/mnt/conf.d<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-map<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/mnt/config-map<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>clone-mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/xtrabackup:1.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- bash<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;-c&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          set -ex
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Skip the clone if data already exists.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Skip the clone on primary (ordinal index 0).
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          ordinal=${BASH_REMATCH[1]}
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          [[ $ordinal -eq 0 ]] &amp;&amp; exit 0
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Clone data from previous peer.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Prepare the backup.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          xtrabackup --prepare --target-dir=/var/lib/mysql</span><span style=color:#bbb>          
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/lib/mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>subPath</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/mysql/conf.d<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mysql:5.7<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MYSQL_ALLOW_EMPTY_PASSWORD<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>3306</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/lib/mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>subPath</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/mysql/conf.d<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>500m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>1Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>exec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;mysqladmin&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;ping&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>timeoutSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>readinessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>exec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># Check we can execute queries over TCP (skip-networking is off).</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;mysql&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-h&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;127.0.0.1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-e&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;SELECT 1&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>timeoutSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>xtrabackup<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/xtrabackup:1.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>xtrabackup<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>3307</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- bash<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;-c&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          set -ex
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          cd /var/lib/mysql
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Determine binlog position of cloned data, if any.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          if [[ -f xtrabackup_slave_info &amp;&amp; &#34;x$(&lt;xtrabackup_slave_info)&#34; != &#34;x&#34; ]]; then
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            # XtraBackup already generated a partial &#34;CHANGE MASTER TO&#34; query
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            # because we&#39;re cloning from an existing replica. (Need to remove the tailing semicolon!)
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            cat xtrabackup_slave_info | sed -E &#39;s/;$//g&#39; &gt; change_master_to.sql.in
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            # Ignore xtrabackup_binlog_info in this case (it&#39;s useless).
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            rm -f xtrabackup_slave_info xtrabackup_binlog_info
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          elif [[ -f xtrabackup_binlog_info ]]; then
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            # We&#39;re cloning directly from primary. Parse binlog position.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            [[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            rm -f xtrabackup_binlog_info xtrabackup_slave_info
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            echo &#34;CHANGE MASTER TO MASTER_LOG_FILE=&#39;${BASH_REMATCH[1]}&#39;,\
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                  MASTER_LOG_POS=${BASH_REMATCH[2]}&#34; &gt; change_master_to.sql.in
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          fi
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Check if we need to complete a clone by starting replication.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          if [[ -f change_master_to.sql.in ]]; then
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            echo &#34;Waiting for mysqld to be ready (accepting connections)&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            until mysql -h 127.0.0.1 -e &#34;SELECT 1&#34;; do sleep 1; done
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            echo &#34;Initializing replication from clone position&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            mysql -h 127.0.0.1 \
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                  -e &#34;$(&lt;change_master_to.sql.in), \
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                          MASTER_HOST=&#39;mysql-0.mysql&#39;, \
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                          MASTER_USER=&#39;root&#39;, \
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                          MASTER_PASSWORD=&#39;&#39;, \
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                          MASTER_CONNECT_RETRY=10; \
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                        START SLAVE;&#34; || exit 1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            # In case of container restart, attempt this at-most-once.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            mv change_master_to.sql.in change_master_to.sql.orig
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          fi
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          # Start a server to send backups when requested by peers.
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            &#34;xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root&#34;</span><span style=color:#bbb>          
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/lib/mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>subPath</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/mysql/conf.d<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>100m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-map<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>mysql<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumeClaimTemplates</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>accessModes</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;ReadWriteOnce&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span>10Gi<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/mysql/mysql-statefulset.yaml
</span></span></code></pre></div><p>You can watch the startup progress by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>mysql --watch
</span></span></code></pre></div><p>After a while, you should see all 3 Pods become <code>Running</code>:</p><pre tabindex=0><code>NAME      READY     STATUS    RESTARTS   AGE
mysql-0   2/2       Running   0          2m
mysql-1   2/2       Running   0          1m
mysql-2   2/2       Running   0          1m
</code></pre><p>Press <strong>Ctrl+C</strong> to cancel the watch.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you don't see any progress, make sure you have a dynamic PersistentVolume
provisioner enabled, as mentioned in the <a href=#before-you-begin>prerequisites</a>.</div><p>This manifest uses a variety of techniques for managing stateful Pods as part of
a StatefulSet. The next section highlights some of these techniques to explain
what happens as the StatefulSet creates Pods.</p><h2 id=understanding-stateful-pod-initialization>Understanding stateful Pod initialization</h2><p>The StatefulSet controller starts Pods one at a time, in order by their
ordinal index.
It waits until each Pod reports being Ready before starting the next one.</p><p>In addition, the controller assigns each Pod a unique, stable name of the form
<code>&lt;statefulset-name>-&lt;ordinal-index></code>, which results in Pods named <code>mysql-0</code>,
<code>mysql-1</code>, and <code>mysql-2</code>.</p><p>The Pod template in the above StatefulSet manifest takes advantage of these
properties to perform orderly startup of MySQL replication.</p><h3 id=generating-configuration>Generating configuration</h3><p>Before starting any of the containers in the Pod spec, the Pod first runs any
<a href=/docs/concepts/workloads/pods/init-containers/>init containers</a>
in the order defined.</p><p>The first init container, named <code>init-mysql</code>, generates special MySQL config
files based on the ordinal index.</p><p>The script determines its own ordinal index by extracting it from the end of
the Pod name, which is returned by the <code>hostname</code> command.
Then it saves the ordinal (with a numeric offset to avoid reserved values)
into a file called <code>server-id.cnf</code> in the MySQL <code>conf.d</code> directory.
This translates the unique, stable identity provided by the StatefulSet
into the domain of MySQL server IDs, which require the same properties.</p><p>The script in the <code>init-mysql</code> container also applies either <code>primary.cnf</code> or
<code>replica.cnf</code> from the ConfigMap by copying the contents into <code>conf.d</code>.
Because the example topology consists of a single primary MySQL server and any number of
replicas, the script assigns ordinal <code>0</code> to be the primary server, and everyone
else to be replicas.
Combined with the StatefulSet controller's
<a href=/docs/concepts/workloads/controllers/statefulset/#deployment-and-scaling-guarantees>deployment order guarantee</a>,
this ensures the primary MySQL server is Ready before creating replicas, so they can begin
replicating.</p><h3 id=cloning-existing-data>Cloning existing data</h3><p>In general, when a new Pod joins the set as a replica, it must assume the primary MySQL
server might already have data on it. It also must assume that the replication
logs might not go all the way back to the beginning of time.
These conservative assumptions are the key to allow a running StatefulSet
to scale up and down over time, rather than being fixed at its initial size.</p><p>The second init container, named <code>clone-mysql</code>, performs a clone operation on
a replica Pod the first time it starts up on an empty PersistentVolume.
That means it copies all existing data from another running Pod,
so its local state is consistent enough to begin replicating from the primary server.</p><p>MySQL itself does not provide a mechanism to do this, so the example uses a
popular open-source tool called Percona XtraBackup.
During the clone, the source MySQL server might suffer reduced performance.
To minimize impact on the primary MySQL server, the script instructs each Pod to clone
from the Pod whose ordinal index is one lower.
This works because the StatefulSet controller always ensures Pod <code>N</code> is
Ready before starting Pod <code>N+1</code>.</p><h3 id=starting-replication>Starting replication</h3><p>After the init containers complete successfully, the regular containers run.
The MySQL Pods consist of a <code>mysql</code> container that runs the actual <code>mysqld</code>
server, and an <code>xtrabackup</code> container that acts as a
<a href=/blog/2015/06/the-distributed-system-toolkit-patterns>sidecar</a>.</p><p>The <code>xtrabackup</code> sidecar looks at the cloned data files and determines if
it's necessary to initialize MySQL replication on the replica.
If so, it waits for <code>mysqld</code> to be ready and then executes the
<code>CHANGE MASTER TO</code> and <code>START SLAVE</code> commands with replication parameters
extracted from the XtraBackup clone files.</p><p>Once a replica begins replication, it remembers its primary MySQL server and
reconnects automatically if the server restarts or the connection dies.
Also, because replicas look for the primary server at its stable DNS name
(<code>mysql-0.mysql</code>), they automatically find the primary server even if it gets a new
Pod IP due to being rescheduled.</p><p>Lastly, after starting replication, the <code>xtrabackup</code> container listens for
connections from other Pods requesting a data clone.
This server remains up indefinitely in case the StatefulSet scales up, or in
case the next Pod loses its PersistentVolumeClaim and needs to redo the clone.</p><h2 id=sending-client-traffic>Sending client traffic</h2><p>You can send test queries to the primary MySQL server (hostname <code>mysql-0.mysql</code>)
by running a temporary container with the <code>mysql:5.7</code> image and running the
<code>mysql</code> client binary.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run mysql-client --image<span style=color:#666>=</span>mysql:5.7 -i --rm --restart<span style=color:#666>=</span>Never --<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  mysql -h mysql-0.mysql <span style=color:#b44>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>CREATE DATABASE test;
</span></span></span><span style=display:flex><span><span style=color:#b44>CREATE TABLE test.messages (message VARCHAR(250));
</span></span></span><span style=display:flex><span><span style=color:#b44>INSERT INTO test.messages VALUES (&#39;hello&#39;);
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Use the hostname <code>mysql-read</code> to send test queries to any server that reports
being Ready:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run mysql-client --image<span style=color:#666>=</span>mysql:5.7 -i -t --rm --restart<span style=color:#666>=</span>Never --<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  mysql -h mysql-read -e <span style=color:#b44>&#34;SELECT * FROM test.messages&#34;</span>
</span></span></code></pre></div><p>You should get output like this:</p><pre tabindex=0><code>Waiting for pod default/mysql-client to be running, status is Pending, pod ready: false
+---------+
| message |
+---------+
| hello   |
+---------+
pod &#34;mysql-client&#34; deleted
</code></pre><p>To demonstrate that the <code>mysql-read</code> Service distributes connections across
servers, you can run <code>SELECT @@server_id</code> in a loop:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run mysql-client-loop --image<span style=color:#666>=</span>mysql:5.7 -i -t --rm --restart<span style=color:#666>=</span>Never --<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  bash -ic <span style=color:#b44>&#34;while sleep 1; do mysql -h mysql-read -e &#39;SELECT @@server_id,NOW()&#39;; done&#34;</span>
</span></span></code></pre></div><p>You should see the reported <code>@@server_id</code> change randomly, because a different
endpoint might be selected upon each connection attempt:</p><pre tabindex=0><code>+-------------+---------------------+
| @@server_id | NOW()               |
+-------------+---------------------+
|         100 | 2006-01-02 15:04:05 |
+-------------+---------------------+
+-------------+---------------------+
| @@server_id | NOW()               |
+-------------+---------------------+
|         102 | 2006-01-02 15:04:06 |
+-------------+---------------------+
+-------------+---------------------+
| @@server_id | NOW()               |
+-------------+---------------------+
|         101 | 2006-01-02 15:04:07 |
+-------------+---------------------+
</code></pre><p>You can press <strong>Ctrl+C</strong> when you want to stop the loop, but it's useful to keep
it running in another window so you can see the effects of the following steps.</p><h2 id=simulate-pod-and-node-downtime>Simulate Pod and Node failure</h2><p>To demonstrate the increased availability of reading from the pool of replicas
instead of a single server, keep the <code>SELECT @@server_id</code> loop from above
running while you force a Pod out of the Ready state.</p><h3 id=break-the-readiness-probe>Break the Readiness probe</h3><p>The <a href=/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes>readiness probe</a>
for the <code>mysql</code> container runs the command <code>mysql -h 127.0.0.1 -e 'SELECT 1'</code>
to make sure the server is up and able to execute queries.</p><p>One way to force this readiness probe to fail is to break that command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> mysql-2 -c mysql -- mv /usr/bin/mysql /usr/bin/mysql.off
</span></span></code></pre></div><p>This reaches into the actual container's filesystem for Pod <code>mysql-2</code> and
renames the <code>mysql</code> command so the readiness probe can't find it.
After a few seconds, the Pod should report one of its containers as not Ready,
which you can check by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod mysql-2
</span></span></code></pre></div><p>Look for <code>1/2</code> in the <code>READY</code> column:</p><pre tabindex=0><code>NAME      READY     STATUS    RESTARTS   AGE
mysql-2   1/2       Running   0          3m
</code></pre><p>At this point, you should see your <code>SELECT @@server_id</code> loop continue to run,
although it never reports <code>102</code> anymore.
Recall that the <code>init-mysql</code> script defined <code>server-id</code> as <code>100 + $ordinal</code>,
so server ID <code>102</code> corresponds to Pod <code>mysql-2</code>.</p><p>Now repair the Pod and it should reappear in the loop output
after a few seconds:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> mysql-2 -c mysql -- mv /usr/bin/mysql.off /usr/bin/mysql
</span></span></code></pre></div><h3 id=delete-pods>Delete Pods</h3><p>The StatefulSet also recreates Pods if they're deleted, similar to what a
ReplicaSet does for stateless Pods.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod mysql-2
</span></span></code></pre></div><p>The StatefulSet controller notices that no <code>mysql-2</code> Pod exists anymore,
and creates a new one with the same name and linked to the same
PersistentVolumeClaim.
You should see server ID <code>102</code> disappear from the loop output for a while
and then return on its own.</p><h3 id=drain-a-node>Drain a Node</h3><p>If your Kubernetes cluster has multiple Nodes, you can simulate Node downtime
(such as when Nodes are upgraded) by issuing a
<a href=/docs/reference/generated/kubectl/kubectl-commands/#drain>drain</a>.</p><p>First determine which Node one of the MySQL Pods is on:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod mysql-2 -o wide
</span></span></code></pre></div><p>The Node name should show up in the last column:</p><pre tabindex=0><code>NAME      READY     STATUS    RESTARTS   AGE       IP            NODE
mysql-2   2/2       Running   0          15m       10.244.5.27   kubernetes-node-9l2t
</code></pre><p>Then, drain the Node by running the following command, which cordons it so
no new Pods may schedule there, and then evicts any existing Pods.
Replace <code>&lt;node-name></code> with the name of the Node you found in the last step.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Draining a Node can impact other workloads and applications
running on the same node. Only perform the following step in a test
cluster.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># See above advice about impact on other workloads</span>
</span></span><span style=display:flex><span>kubectl drain &lt;node-name&gt; --force --delete-emptydir-data --ignore-daemonsets
</span></span></code></pre></div><p>Now you can watch as the Pod reschedules on a different Node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod mysql-2 -o wide --watch
</span></span></code></pre></div><p>It should look something like this:</p><pre tabindex=0><code>NAME      READY   STATUS          RESTARTS   AGE       IP            NODE
mysql-2   2/2     Terminating     0          15m       10.244.1.56   kubernetes-node-9l2t
[...]
mysql-2   0/2     Pending         0          0s        &lt;none&gt;        kubernetes-node-fjlm
mysql-2   0/2     Init:0/2        0          0s        &lt;none&gt;        kubernetes-node-fjlm
mysql-2   0/2     Init:1/2        0          20s       10.244.5.32   kubernetes-node-fjlm
mysql-2   0/2     PodInitializing 0          21s       10.244.5.32   kubernetes-node-fjlm
mysql-2   1/2     Running         0          22s       10.244.5.32   kubernetes-node-fjlm
mysql-2   2/2     Running         0          30s       10.244.5.32   kubernetes-node-fjlm
</code></pre><p>And again, you should see server ID <code>102</code> disappear from the
<code>SELECT @@server_id</code> loop output for a while and then return.</p><p>Now uncordon the Node to return it to a normal state:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl uncordon &lt;node-name&gt;
</span></span></code></pre></div><h2 id=scaling-the-number-of-replicas>Scaling the number of replicas</h2><p>When you use MySQL replication, you can scale your read query capacity by
adding replicas.
For a StatefulSet, you can achieve this with a single command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl scale statefulset mysql  --replicas<span style=color:#666>=</span><span style=color:#666>5</span>
</span></span></code></pre></div><p>Watch the new Pods come up by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>mysql --watch
</span></span></code></pre></div><p>Once they're up, you should see server IDs <code>103</code> and <code>104</code> start appearing in
the <code>SELECT @@server_id</code> loop output.</p><p>You can also verify that these new servers have the data you added before they
existed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run mysql-client --image<span style=color:#666>=</span>mysql:5.7 -i -t --rm --restart<span style=color:#666>=</span>Never --<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  mysql -h mysql-3.mysql -e <span style=color:#b44>&#34;SELECT * FROM test.messages&#34;</span>
</span></span></code></pre></div><pre tabindex=0><code>Waiting for pod default/mysql-client to be running, status is Pending, pod ready: false
+---------+
| message |
+---------+
| hello   |
+---------+
pod &#34;mysql-client&#34; deleted
</code></pre><p>Scaling back down is also seamless:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl scale statefulset mysql --replicas<span style=color:#666>=</span><span style=color:#666>3</span>
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>Although scaling up creates new PersistentVolumeClaims
automatically, scaling down does not automatically delete these PVCs.</p><p>This gives you the choice to keep those initialized PVCs around to make
scaling back up quicker, or to extract data before deleting them.</p></div><p>You can see this by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pvc -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>mysql
</span></span></code></pre></div><p>Which shows that all 5 PVCs still exist, despite having scaled the
StatefulSet down to 3:</p><pre tabindex=0><code>NAME           STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
data-mysql-0   Bound     pvc-8acbf5dc-b103-11e6-93fa-42010a800002   10Gi       RWO           20m
data-mysql-1   Bound     pvc-8ad39820-b103-11e6-93fa-42010a800002   10Gi       RWO           20m
data-mysql-2   Bound     pvc-8ad69a6d-b103-11e6-93fa-42010a800002   10Gi       RWO           20m
data-mysql-3   Bound     pvc-50043c45-b1c5-11e6-93fa-42010a800002   10Gi       RWO           2m
data-mysql-4   Bound     pvc-500a9957-b1c5-11e6-93fa-42010a800002   10Gi       RWO           2m
</code></pre><p>If you don't intend to reuse the extra PVCs, you can delete them:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pvc data-mysql-3
</span></span><span style=display:flex><span>kubectl delete pvc data-mysql-4
</span></span></code></pre></div><h2 id=cleaning-up>Cleaning up</h2><ol><li><p>Cancel the <code>SELECT @@server_id</code> loop by pressing <strong>Ctrl+C</strong> in its terminal,
or running the following from another terminal:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod mysql-client-loop --now
</span></span></code></pre></div></li><li><p>Delete the StatefulSet. This also begins terminating the Pods.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete statefulset mysql
</span></span></code></pre></div></li><li><p>Verify that the Pods disappear.
They might take some time to finish terminating.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>mysql
</span></span></code></pre></div><p>You'll know the Pods have terminated when the above returns:</p><pre tabindex=0><code>No resources found.
</code></pre></li><li><p>Delete the ConfigMap, Services, and PersistentVolumeClaims.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete configmap,service,pvc -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>mysql
</span></span></code></pre></div></li><li><p>If you manually provisioned PersistentVolumes, you also need to manually
delete them, as well as release the underlying resources.
If you used a dynamic provisioner, it automatically deletes the
PersistentVolumes when it sees that you deleted the PersistentVolumeClaims.
Some dynamic provisioners (such as those for EBS and PD) also release the
underlying resources upon deleting the PersistentVolumes.</p></li></ol><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/tasks/run-application/scale-stateful-set/>scaling a StatefulSet</a>.</li><li>Learn more about <a href=/docs/tasks/debug/debug-application/debug-statefulset/>debugging a StatefulSet</a>.</li><li>Learn more about <a href=/docs/tasks/run-application/delete-stateful-set/>deleting a StatefulSet</a>.</li><li>Learn more about <a href=/docs/tasks/run-application/force-delete-stateful-set-pod/>force deleting StatefulSet Pods</a>.</li><li>Look in the <a href=https://artifacthub.io/>Helm Charts repository</a>
for other stateful application examples.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7a9b5779e228083ba3fdeaf414fe704e>8.4 - Scale a StatefulSet</h1><p>This task shows how to scale a StatefulSet. Scaling a StatefulSet refers to increasing or decreasing the number of replicas.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><p>StatefulSets are only available in Kubernetes version 1.5 or later.
To check your version of Kubernetes, run <code>kubectl version</code>.</p></li><li><p>Not all stateful applications scale nicely. If you are unsure about whether to scale your StatefulSets, see <a href=/docs/concepts/workloads/controllers/statefulset/>StatefulSet concepts</a> or <a href=/docs/tutorials/stateful-application/basic-stateful-set/>StatefulSet tutorial</a> for further information.</p></li><li><p>You should perform scaling only when you are confident that your stateful application
cluster is completely healthy.</p></li></ul><h2 id=scaling-statefulsets>Scaling StatefulSets</h2><h3 id=use-kubectl-to-scale-statefulsets>Use kubectl to scale StatefulSets</h3><p>First, find the StatefulSet you want to scale.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get statefulsets &lt;stateful-set-name&gt;
</span></span></code></pre></div><p>Change the number of replicas of your StatefulSet:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl scale statefulsets &lt;stateful-set-name&gt; --replicas<span style=color:#666>=</span>&lt;new-replicas&gt;
</span></span></code></pre></div><h3 id=make-in-place-updates-on-your-statefulsets>Make in-place updates on your StatefulSets</h3><p>Alternatively, you can do <a href=/docs/concepts/cluster-administration/manage-deployment/#in-place-updates-of-resources>in-place updates</a> on your StatefulSets.</p><p>If your StatefulSet was initially created with <code>kubectl apply</code>,
update <code>.spec.replicas</code> of the StatefulSet manifests, and then do a <code>kubectl apply</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f &lt;stateful-set-file-updated&gt;
</span></span></code></pre></div><p>Otherwise, edit that field with <code>kubectl edit</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit statefulsets &lt;stateful-set-name&gt;
</span></span></code></pre></div><p>Or use <code>kubectl patch</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch statefulsets &lt;stateful-set-name&gt; -p <span style=color:#b44>&#39;{&#34;spec&#34;:{&#34;replicas&#34;:&lt;new-replicas&gt;}}&#39;</span>
</span></span></code></pre></div><h2 id=troubleshooting>Troubleshooting</h2><h3 id=scaling-down-does-not-work-right>Scaling down does not work right</h3><p>You cannot scale down a StatefulSet when any of the stateful Pods it manages is unhealthy. Scaling down only takes place
after those stateful Pods become running and ready.</p><p>If spec.replicas > 1, Kubernetes cannot determine the reason for an unhealthy Pod. It might be the result of a permanent fault or of a transient fault. A transient fault can be caused by a restart required by upgrading or maintenance.</p><p>If the Pod is unhealthy due to a permanent fault, scaling
without correcting the fault may lead to a state where the StatefulSet membership
drops below a certain minimum number of replicas that are needed to function
correctly. This may cause your StatefulSet to become unavailable.</p><p>If the Pod is unhealthy due to a transient fault and the Pod might become available again,
the transient error may interfere with your scale-up or scale-down operation. Some distributed
databases have issues when nodes join and leave at the same time. It is better
to reason about scaling operations at the application level in these cases, and
perform scaling only when you are sure that your stateful application cluster is
completely healthy.</p><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/tasks/run-application/delete-stateful-set/>deleting a StatefulSet</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c43537b0ee1da992ecb7488f87e6c934>8.5 - Delete a StatefulSet</h1><p>This task shows you how to delete a <a class=glossary-tooltip title='Manages deployment and scaling of a set of Pods, with durable storage and persistent identifiers for each Pod.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/statefulset/ target=_blank aria-label=StatefulSet>StatefulSet</a>.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>This task assumes you have an application running on your cluster represented by a StatefulSet.</li></ul><h2 id=deleting-a-statefulset>Deleting a StatefulSet</h2><p>You can delete a StatefulSet in the same way you delete other resources in Kubernetes: use the <code>kubectl delete</code> command, and specify the StatefulSet either by file or by name.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f &lt;file.yaml&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete statefulsets &lt;statefulset-name&gt;
</span></span></code></pre></div><p>You may need to delete the associated headless service separately after the StatefulSet itself is deleted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete service &lt;service-name&gt;
</span></span></code></pre></div><p>When deleting a StatefulSet through <code>kubectl</code>, the StatefulSet scales down to 0. All Pods that are part of this workload are also deleted. If you want to delete only the StatefulSet and not the Pods, use <code>--cascade=orphan</code>.
For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f &lt;file.yaml&gt; --cascade<span style=color:#666>=</span>orphan
</span></span></code></pre></div><p>By passing <code>--cascade=orphan</code> to <code>kubectl delete</code>, the Pods managed by the StatefulSet are left behind even after the StatefulSet object itself is deleted. If the pods have a label <code>app.kubernetes.io/name=MyApp</code>, you can then delete them as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pods -l app.kubernetes.io/name<span style=color:#666>=</span>MyApp
</span></span></code></pre></div><h3 id=persistent-volumes>Persistent Volumes</h3><p>Deleting the Pods in a StatefulSet will not delete the associated volumes. This is to ensure that you have the chance to copy data off the volume before deleting it. Deleting the PVC after the pods have terminated might trigger deletion of the backing Persistent Volumes depending on the storage class and reclaim policy. You should never assume ability to access a volume after claim deletion.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Use caution when deleting a PVC, as it may lead to data loss.</div><h3 id=complete-deletion-of-a-statefulset>Complete deletion of a StatefulSet</h3><p>To delete everything in a StatefulSet, including the associated pods, you can run a series of commands similar to the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>grace</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get pods &lt;stateful-set-pod&gt; --template <span style=color:#b44>&#39;{{.spec.terminationGracePeriodSeconds}}&#39;</span><span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl delete statefulset -l app.kubernetes.io/name<span style=color:#666>=</span>MyApp
</span></span><span style=display:flex><span>sleep <span style=color:#b8860b>$grace</span>
</span></span><span style=display:flex><span>kubectl delete pvc -l app.kubernetes.io/name<span style=color:#666>=</span>MyApp
</span></span></code></pre></div><p>In the example above, the Pods have the label <code>app.kubernetes.io/name=MyApp</code>; substitute your own label as appropriate.</p><h3 id=force-deletion-of-statefulset-pods>Force deletion of StatefulSet pods</h3><p>If you find that some pods in your StatefulSet are stuck in the 'Terminating' or 'Unknown' states for an extended period of time, you may need to manually intervene to forcefully delete the pods from the apiserver. This is a potentially dangerous task. Refer to <a href=/docs/tasks/run-application/force-delete-stateful-set-pod/>Force Delete StatefulSet Pods</a> for details.</p><h2 id=what-s-next>What's next</h2><p>Learn more about <a href=/docs/tasks/run-application/force-delete-stateful-set-pod/>force deleting StatefulSet Pods</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f5f2f7a74377a9d45325c5253353fa8f>8.6 - Force Delete StatefulSet Pods</h1><p>This page shows how to delete Pods which are part of a <a class=glossary-tooltip title='Manages deployment and scaling of a set of Pods, with durable storage and persistent identifiers for each Pod.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/statefulset/ target=_blank aria-label='stateful set'>stateful set</a>, and explains the considerations to keep in mind when doing so.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>This is a fairly advanced task and has the potential to violate some of the properties inherent to StatefulSet.</li><li>Before proceeding, make yourself familiar with the considerations enumerated below.</li></ul><h2 id=statefulset-considerations>StatefulSet considerations</h2><p>In normal operation of a StatefulSet, there is <strong>never</strong> a need to force delete a StatefulSet Pod. The <a href=/docs/concepts/workloads/controllers/statefulset/>StatefulSet controller</a> is responsible for creating, scaling and deleting members of the StatefulSet. It tries to ensure that the specified number of Pods from ordinal 0 through N-1 are alive and ready. StatefulSet ensures that, at any time, there is at most one Pod with a given identity running in a cluster. This is referred to as <em>at most one</em> semantics provided by a StatefulSet.</p><p>Manual force deletion should be undertaken with caution, as it has the potential to violate the at most one semantics inherent to StatefulSet. StatefulSets may be used to run distributed and clustered applications which have a need for a stable network identity and stable storage. These applications often have configuration which relies on an ensemble of a fixed number of members with fixed identities. Having multiple members with the same identity can be disastrous and may lead to data loss (e.g. split brain scenario in quorum-based systems).</p><h2 id=delete-pods>Delete Pods</h2><p>You can perform a graceful pod deletion with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pods &lt;pod&gt;
</span></span></code></pre></div><p>For the above to lead to graceful termination, the Pod <strong>must not</strong> specify a
<code>pod.Spec.TerminationGracePeriodSeconds</code> of 0. The practice of setting a
<code>pod.Spec.TerminationGracePeriodSeconds</code> of 0 seconds is unsafe and strongly discouraged
for StatefulSet Pods. Graceful deletion is safe and will ensure that the Pod
<a href=/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination>shuts down gracefully</a>
before the kubelet deletes the name from the apiserver.</p><p>A Pod is not deleted automatically when a node is unreachable.
The Pods running on an unreachable Node enter the 'Terminating' or 'Unknown' state after a
<a href=/docs/concepts/architecture/nodes/#condition>timeout</a>.
Pods may also enter these states when the user attempts graceful deletion of a Pod
on an unreachable Node.
The only ways in which a Pod in such a state can be removed from the apiserver are as follows:</p><ul><li>The Node object is deleted (either by you, or by the <a href=/docs/concepts/architecture/nodes/#node-controller>Node Controller</a>).</li><li>The kubelet on the unresponsive Node starts responding, kills the Pod and removes the entry from the apiserver.</li><li>Force deletion of the Pod by the user.</li></ul><p>The recommended best practice is to use the first or second approach. If a Node is confirmed to be dead (e.g. permanently disconnected from the network, powered down, etc), then delete the Node object. If the Node is suffering from a network partition, then try to resolve this or wait for it to resolve. When the partition heals, the kubelet will complete the deletion of the Pod and free up its name in the apiserver.</p><p>Normally, the system completes the deletion once the Pod is no longer running on a Node, or the Node is deleted by an administrator. You may override this by force deleting the Pod.</p><h3 id=force-deletion>Force Deletion</h3><p>Force deletions <strong>do not</strong> wait for confirmation from the kubelet that the Pod has been terminated. Irrespective of whether a force deletion is successful in killing a Pod, it will immediately free up the name from the apiserver. This would let the StatefulSet controller create a replacement Pod with that same identity; this can lead to the duplication of a still-running Pod, and if said Pod can still communicate with the other members of the StatefulSet, will violate the at most one semantics that StatefulSet is designed to guarantee.</p><p>When you force delete a StatefulSet pod, you are asserting that the Pod in question will never again make contact with other Pods in the StatefulSet and its name can be safely freed up for a replacement to be created.</p><p>If you want to delete a Pod forcibly using kubectl version >= 1.5, do the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pods &lt;pod&gt; --grace-period<span style=color:#666>=</span><span style=color:#666>0</span> --force
</span></span></code></pre></div><p>If you're using any version of kubectl &lt;= 1.4, you should omit the <code>--force</code> option and use:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pods &lt;pod&gt; --grace-period<span style=color:#666>=</span><span style=color:#666>0</span>
</span></span></code></pre></div><p>If even after these commands the pod is stuck on <code>Unknown</code> state, use the following command to remove the pod from the cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch pod &lt;pod&gt; -p <span style=color:#b44>&#39;{&#34;metadata&#34;:{&#34;finalizers&#34;:null}}&#39;</span>
</span></span></code></pre></div><p>Always perform force deletion of StatefulSet Pods carefully and with complete knowledge of the risks involved.</p><h2 id=what-s-next>What's next</h2><p>Learn more about <a href=/docs/tasks/debug/debug-application/debug-statefulset/>debugging a StatefulSet</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0c0bb1bd76d2a9069e50e2cec6d20c2a>8.7 - Horizontal Pod Autoscaling</h1><p>In Kubernetes, a <em>HorizontalPodAutoscaler</em> automatically updates a workload resource (such as
a <a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployment>Deployment</a> or
<a class=glossary-tooltip title='Manages deployment and scaling of a set of Pods, with durable storage and persistent identifiers for each Pod.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/statefulset/ target=_blank aria-label=StatefulSet>StatefulSet</a>), with the
aim of automatically scaling the workload to match demand.</p><p>Horizontal scaling means that the response to increased load is to deploy more
<a class=glossary-tooltip title='A Pod represents a set of running containers in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pods>Pods</a>.
This is different from <em>vertical</em> scaling, which for Kubernetes would mean
assigning more resources (for example: memory or CPU) to the Pods that are already
running for the workload.</p><p>If the load decreases, and the number of Pods is above the configured minimum,
the HorizontalPodAutoscaler instructs the workload resource (the Deployment, StatefulSet,
or other similar resource) to scale back down.</p><p>Horizontal pod autoscaling does not apply to objects that can't be scaled (for example:
a <a class=glossary-tooltip title='Ensures a copy of a Pod is running across a set of nodes in a cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/daemonset target=_blank aria-label=DaemonSet>DaemonSet</a>.)</p><p>The HorizontalPodAutoscaler is implemented as a Kubernetes API resource and a
<a class=glossary-tooltip title='A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/controller/ target=_blank aria-label=controller>controller</a>.
The resource determines the behavior of the controller.
The horizontal pod autoscaling controller, running within the Kubernetes
<a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a>, periodically adjusts the
desired scale of its target (for example, a Deployment) to match observed metrics such as average
CPU utilization, average memory utilization, or any other custom metric you specify.</p><p>There is <a href=/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/>walkthrough example</a> of using
horizontal pod autoscaling.</p><h2 id=how-does-a-horizontalpodautoscaler-work>How does a HorizontalPodAutoscaler work?</h2><figure><div class=mermaid>graph BT
hpa[Horizontal Pod Autoscaler] --> scale[Scale]
subgraph rc[RC / Deployment]
scale
end
scale -.-> pod1[Pod 1]
scale -.-> pod2[Pod 2]
scale -.-> pod3[Pod N]
classDef hpa fill:#D5A6BD,stroke:#1E1E1D,stroke-width:1px,color:#1E1E1D;
classDef rc fill:#F9CB9C,stroke:#1E1E1D,stroke-width:1px,color:#1E1E1D;
classDef scale fill:#B6D7A8,stroke:#1E1E1D,stroke-width:1px,color:#1E1E1D;
classDef pod fill:#9FC5E8,stroke:#1E1E1D,stroke-width:1px,color:#1E1E1D;
class hpa hpa;
class rc rc;
class scale scale;
class pod1,pod2,pod3 pod</div></figure><noscript><div class="alert alert-secondary callout" role=alert><em class=javascript-required>JavaScript must be <a href=https://www.enable-javascript.com/>enabled</a> to view this content</em></div></noscript><p>Figure 1. HorizontalPodAutoscaler controls the scale of a Deployment and its ReplicaSet</p><p>Kubernetes implements horizontal pod autoscaling as a control loop that runs intermittently
(it is not a continuous process). The interval is set by the
<code>--horizontal-pod-autoscaler-sync-period</code> parameter to the
<a href=/docs/reference/command-line-tools-reference/kube-controller-manager/><code>kube-controller-manager</code></a>
(and the default interval is 15 seconds).</p><p>Once during each period, the controller manager queries the resource utilization against the
metrics specified in each HorizontalPodAutoscaler definition. The controller manager
finds the target resource defined by the <code>scaleTargetRef</code>,
then selects the pods based on the target resource's <code>.spec.selector</code> labels, and obtains the metrics from either the resource metrics API (for per-pod resource metrics),
or the custom metrics API (for all other metrics).</p><ul><li><p>For per-pod resource metrics (like CPU), the controller fetches the metrics
from the resource metrics API for each Pod targeted by the HorizontalPodAutoscaler.
Then, if a target utilization value is set, the controller calculates the utilization
value as a percentage of the equivalent
<a href=/docs/concepts/configuration/manage-resources-containers/#requests-and-limits>resource request</a>
on the containers in each Pod. If a target raw value is set, the raw metric values are used directly.
The controller then takes the mean of the utilization or the raw value (depending on the type
of target specified) across all targeted Pods, and produces a ratio used to scale
the number of desired replicas.</p><p>Please note that if some of the Pod's containers do not have the relevant resource request set,
CPU utilization for the Pod will not be defined and the autoscaler will
not take any action for that metric. See the <a href=#algorithm-details>algorithm details</a> section below
for more information about how the autoscaling algorithm works.</p></li><li><p>For per-pod custom metrics, the controller functions similarly to per-pod resource metrics,
except that it works with raw values, not utilization values.</p></li><li><p>For object metrics and external metrics, a single metric is fetched, which describes
the object in question. This metric is compared to the target
value, to produce a ratio as above. In the <code>autoscaling/v2</code> API
version, this value can optionally be divided by the number of Pods before the
comparison is made.</p></li></ul><p>The common use for HorizontalPodAutoscaler is to configure it to fetch metrics from
<a class=glossary-tooltip title='The aggregation layer lets you install additional Kubernetes-style APIs in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/ target=_blank aria-label='aggregated APIs'>aggregated APIs</a>
(<code>metrics.k8s.io</code>, <code>custom.metrics.k8s.io</code>, or <code>external.metrics.k8s.io</code>). The <code>metrics.k8s.io</code> API is
usually provided by an add-on named Metrics Server, which needs to be launched separately.
For more information about resource metrics, see
<a href=/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-server>Metrics Server</a>.</p><p><a href=#support-for-metrics-apis>Support for metrics APIs</a> explains the stability guarantees and support status for these
different APIs.</p><p>The HorizontalPodAutoscaler controller accesses corresponding workload resources that support scaling (such as Deployments
and StatefulSet). These resources each have a subresource named <code>scale</code>, an interface that allows you to dynamically set the
number of replicas and examine each of their current states.
For general information about subresources in the Kubernetes API, see
<a href=/docs/reference/using-api/api-concepts/>Kubernetes API Concepts</a>.</p><h3 id=algorithm-details>Algorithm details</h3><p>From the most basic perspective, the HorizontalPodAutoscaler controller
operates on the ratio between desired metric value and current metric
value:</p><pre tabindex=0><code>desiredReplicas = ceil[currentReplicas * ( currentMetricValue / desiredMetricValue )]
</code></pre><p>For example, if the current metric value is <code>200m</code>, and the desired value
is <code>100m</code>, the number of replicas will be doubled, since <code>200.0 / 100.0 == 2.0</code> If the current value is instead <code>50m</code>, you'll halve the number of
replicas, since <code>50.0 / 100.0 == 0.5</code>. The control plane skips any scaling
action if the ratio is sufficiently close to 1.0 (within a globally-configurable
tolerance, 0.1 by default).</p><p>When a <code>targetAverageValue</code> or <code>targetAverageUtilization</code> is specified,
the <code>currentMetricValue</code> is computed by taking the average of the given
metric across all Pods in the HorizontalPodAutoscaler's scale target.</p><p>Before checking the tolerance and deciding on the final values, the control
plane also considers whether any metrics are missing, and how many Pods
are <a href=/docs/concepts/workloads/pods/pod-lifecycle/#pod-conditions><code>Ready</code></a>.
All Pods with a deletion timestamp set (objects with a deletion timestamp are
in the process of being shut down / removed) are ignored, and all failed Pods
are discarded.</p><p>If a particular Pod is missing metrics, it is set aside for later; Pods
with missing metrics will be used to adjust the final scaling amount.</p><p>When scaling on CPU, if any pod has yet to become ready (it's still
initializing, or possibly is unhealthy) <em>or</em> the most recent metric point for
the pod was before it became ready, that pod is set aside as well.</p><p>Due to technical constraints, the HorizontalPodAutoscaler controller
cannot exactly determine the first time a pod becomes ready when
determining whether to set aside certain CPU metrics. Instead, it
considers a Pod "not yet ready" if it's unready and transitioned to
ready within a short, configurable window of time since it started.
This value is configured with the <code>--horizontal-pod-autoscaler-initial-readiness-delay</code> flag, and its default is 30
seconds. Once a pod has become ready, it considers any transition to
ready to be the first if it occurred within a longer, configurable time
since it started. This value is configured with the <code>--horizontal-pod-autoscaler-cpu-initialization-period</code> flag, and its
default is 5 minutes.</p><p>The <code>currentMetricValue / desiredMetricValue</code> base scale ratio is then
calculated using the remaining pods not set aside or discarded from above.</p><p>If there were any missing metrics, the control plane recomputes the average more
conservatively, assuming those pods were consuming 100% of the desired
value in case of a scale down, and 0% in case of a scale up. This dampens
the magnitude of any potential scale.</p><p>Furthermore, if any not-yet-ready pods were present, and the workload would have
scaled up without factoring in missing metrics or not-yet-ready pods,
the controller conservatively assumes that the not-yet-ready pods are consuming 0%
of the desired metric, further dampening the magnitude of a scale up.</p><p>After factoring in the not-yet-ready pods and missing metrics, the
controller recalculates the usage ratio. If the new ratio reverses the scale
direction, or is within the tolerance, the controller doesn't take any scaling
action. In other cases, the new ratio is used to decide any change to the
number of Pods.</p><p>Note that the <em>original</em> value for the average utilization is reported
back via the HorizontalPodAutoscaler status, without factoring in the
not-yet-ready pods or missing metrics, even when the new usage ratio is
used.</p><p>If multiple metrics are specified in a HorizontalPodAutoscaler, this
calculation is done for each metric, and then the largest of the desired
replica counts is chosen. If any of these metrics cannot be converted
into a desired replica count (e.g. due to an error fetching the metrics
from the metrics APIs) and a scale down is suggested by the metrics which
can be fetched, scaling is skipped. This means that the HPA is still capable
of scaling up if one or more metrics give a <code>desiredReplicas</code> greater than
the current value.</p><p>Finally, right before HPA scales the target, the scale recommendation is recorded. The
controller considers all recommendations within a configurable window choosing the
highest recommendation from within that window. This value can be configured using the <code>--horizontal-pod-autoscaler-downscale-stabilization</code> flag, which defaults to 5 minutes.
This means that scaledowns will occur gradually, smoothing out the impact of rapidly
fluctuating metric values.</p><h2 id=api-object>API Object</h2><p>The Horizontal Pod Autoscaler is an API resource in the Kubernetes
<code>autoscaling</code> API group. The current stable version can be found in
the <code>autoscaling/v2</code> API version which includes support for scaling on
memory and custom metrics. The new fields introduced in
<code>autoscaling/v2</code> are preserved as annotations when working with
<code>autoscaling/v1</code>.</p><p>When you create a HorizontalPodAutoscaler API object, make sure the name specified is a valid
<a href=/docs/concepts/overview/working-with-objects/names#dns-subdomain-names>DNS subdomain name</a>.
More details about the API object can be found at
<a href=/docs/reference/generated/kubernetes-api/v1.25/#horizontalpodautoscaler-v2-autoscaling>HorizontalPodAutoscaler Object</a>.</p><h2 id=flapping>Stability of workload scale</h2><p>When managing the scale of a group of replicas using the HorizontalPodAutoscaler,
it is possible that the number of replicas keeps fluctuating frequently due to the
dynamic nature of the metrics evaluated. This is sometimes referred to as <em>thrashing</em>,
or <em>flapping</em>. It's similar to the concept of <em>hysteresis</em> in cybernetics.</p><h2 id=autoscaling-during-rolling-update>Autoscaling during rolling update</h2><p>Kubernetes lets you perform a rolling update on a Deployment. In that
case, the Deployment manages the underlying ReplicaSets for you.
When you configure autoscaling for a Deployment, you bind a
HorizontalPodAutoscaler to a single Deployment. The HorizontalPodAutoscaler
manages the <code>replicas</code> field of the Deployment. The deployment controller is responsible
for setting the <code>replicas</code> of the underlying ReplicaSets so that they add up to a suitable
number during the rollout and also afterwards.</p><p>If you perform a rolling update of a StatefulSet that has an autoscaled number of
replicas, the StatefulSet directly manages its set of Pods (there is no intermediate resource
similar to ReplicaSet).</p><h2 id=support-for-resource-metrics>Support for resource metrics</h2><p>Any HPA target can be scaled based on the resource usage of the pods in the scaling target.
When defining the pod specification the resource requests like <code>cpu</code> and <code>memory</code> should
be specified. This is used to determine the resource utilization and used by the HPA controller
to scale the target up or down. To use resource utilization based scaling specify a metric source
like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Resource<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Utilization<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>averageUtilization</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>With this metric the HPA controller will keep the average utilization of the pods in the scaling
target at 60%. Utilization is the ratio between the current usage of resource to the requested
resources of the pod. See <a href=#algorithm-details>Algorithm</a> for more details about how the utilization
is calculated and averaged.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Since the resource usages of all the containers are summed up the total pod utilization may not
accurately represent the individual container resource usage. This could lead to situations where
a single container might be running with high usage and the HPA will not scale out because the overall
pod usage is still within acceptable limits.</div><h3 id=container-resource-metrics>Container resource metrics</h3><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.20 [alpha]</code></div><p>The HorizontalPodAutoscaler API also supports a container metric source where the HPA can track the
resource usage of individual containers across a set of Pods, in order to scale the target resource.
This lets you configure scaling thresholds for the containers that matter most in a particular Pod.
For example, if you have a web application and a logging sidecar, you can scale based on the resource
use of the web application, ignoring the sidecar container and its resource use.</p><p>If you revise the target resource to have a new Pod specification with a different set of containers,
you should revise the HPA spec if that newly added container should also be used for
scaling. If the specified container in the metric source is not present or only present in a subset
of the pods then those pods are ignored and the recommendation is recalculated. See <a href=#algorithm-details>Algorithm</a>
for more details about the calculation. To use container resources for autoscaling define a metric
source as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>ContainerResource<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>containerResource</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>container</span>:<span style=color:#bbb> </span>application<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Utilization<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>averageUtilization</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>In the above example the HPA controller scales the target such that the average utilization of the cpu
in the <code>application</code> container of all the pods is 60%.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>If you change the name of a container that a HorizontalPodAutoscaler is tracking, you can
make that change in a specific order to ensure scaling remains available and effective
whilst the change is being applied. Before you update the resource that defines the container
(such as a Deployment), you should update the associated HPA to track both the new and
old container names. This way, the HPA is able to calculate a scaling recommendation
throughout the update process.</p><p>Once you have rolled out the container name change to the workload resource, tidy up by removing
the old container name from the HPA specification.</p></div><h2 id=scaling-on-custom-metrics>Scaling on custom metrics</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.23 [stable]</code></div><p>(the <code>autoscaling/v2beta2</code> API version previously provided this ability as a beta feature)</p><p>Provided that you use the <code>autoscaling/v2</code> API version, you can configure a HorizontalPodAutoscaler
to scale based on a custom metric (that is not built in to Kubernetes or any Kubernetes component).
The HorizontalPodAutoscaler controller then queries for these custom metrics from the Kubernetes
API.</p><p>See <a href=#support-for-metrics-apis>Support for metrics APIs</a> for the requirements.</p><h2 id=scaling-on-multiple-metrics>Scaling on multiple metrics</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.23 [stable]</code></div><p>(the <code>autoscaling/v2beta2</code> API version previously provided this ability as a beta feature)</p><p>Provided that you use the <code>autoscaling/v2</code> API version, you can specify multiple metrics for a
HorizontalPodAutoscaler to scale on. Then, the HorizontalPodAutoscaler controller evaluates each metric,
and proposes a new scale based on that metric. The HorizontalPodAutoscaler takes the maximum scale
recommended for each metric and sets the workload to that size (provided that this isn't larger than the
overall maximum that you configured).</p><h2 id=support-for-metrics-apis>Support for metrics APIs</h2><p>By default, the HorizontalPodAutoscaler controller retrieves metrics from a series of APIs. In order for it to access these
APIs, cluster administrators must ensure that:</p><ul><li><p>The <a href=/docs/tasks/extend-kubernetes/configure-aggregation-layer/>API aggregation layer</a> is enabled.</p></li><li><p>The corresponding APIs are registered:</p><ul><li><p>For resource metrics, this is the <code>metrics.k8s.io</code> API, generally provided by <a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a>.
It can be launched as a cluster add-on.</p></li><li><p>For custom metrics, this is the <code>custom.metrics.k8s.io</code> API. It's provided by "adapter" API servers provided by metrics solution vendors.
Check with your metrics pipeline to see if there is a Kubernetes metrics adapter available.</p></li><li><p>For external metrics, this is the <code>external.metrics.k8s.io</code> API. It may be provided by the custom metrics adapters provided above.</p></li></ul></li></ul><p>For more information on these different metrics paths and how they differ please see the relevant design proposals for
<a href=https://git.k8s.io/design-proposals-archive/autoscaling/hpa-v2.md>the HPA V2</a>,
<a href=https://git.k8s.io/design-proposals-archive/instrumentation/custom-metrics-api.md>custom.metrics.k8s.io</a>
and <a href=https://git.k8s.io/design-proposals-archive/instrumentation/external-metrics-api.md>external.metrics.k8s.io</a>.</p><p>For examples of how to use them see <a href=/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics>the walkthrough for using custom metrics</a>
and <a href=/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-metrics-not-related-to-kubernetes-objects>the walkthrough for using external metrics</a>.</p><h2 id=configurable-scaling-behavior>Configurable scaling behavior</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.23 [stable]</code></div><p>(the <code>autoscaling/v2beta2</code> API version previously provided this ability as a beta feature)</p><p>If you use the <code>v2</code> HorizontalPodAutoscaler API, you can use the <code>behavior</code> field
(see the <a href=/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/#HorizontalPodAutoscalerSpec>API reference</a>)
to configure separate scale-up and scale-down behaviors.
You specify these behaviours by setting <code>scaleUp</code> and / or <code>scaleDown</code>
under the <code>behavior</code> field.</p><p>You can specify a <em>stabilization window</em> that prevents <a href=#flapping>flapping</a>
the replica count for a scaling target. Scaling policies also let you controls the
rate of change of replicas while scaling.</p><h3 id=scaling-policies>Scaling policies</h3><p>One or more scaling policies can be specified in the <code>behavior</code> section of the spec.
When multiple policies are specified the policy which allows the highest amount of
change is the policy which is selected by default. The following example shows this behavior
while scaling down:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>behavior</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleDown</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>policies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Pods<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#666>4</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Percent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span></code></pre></div><p><code>periodSeconds</code> indicates the length of time in the past for which the policy must hold true.
The first policy <em>(Pods)</em> allows at most 4 replicas to be scaled down in one minute. The second policy
<em>(Percent)</em> allows at most 10% of the current replicas to be scaled down in one minute.</p><p>Since by default the policy which allows the highest amount of change is selected, the second policy will
only be used when the number of pod replicas is more than 40. With 40 or less replicas, the first policy will be applied.
For instance if there are 80 replicas and the target has to be scaled down to 10 replicas
then during the first step 8 replicas will be reduced. In the next iteration when the number
of replicas is 72, 10% of the pods is 7.2 but the number is rounded up to 8. On each loop of
the autoscaler controller the number of pods to be change is re-calculated based on the number
of current replicas. When the number of replicas falls below 40 the first policy <em>(Pods)</em> is applied
and 4 replicas will be reduced at a time.</p><p>The policy selection can be changed by specifying the <code>selectPolicy</code> field for a scaling
direction. By setting the value to <code>Min</code> which would select the policy which allows the
smallest change in the replica count. Setting the value to <code>Disabled</code> completely disables
scaling in that direction.</p><h3 id=stabilization-window>Stabilization window</h3><p>The stabilization window is used to restrict the <a href=#flapping>flapping</a> of
replica count when the metrics used for scaling keep fluctuating. The autoscaling algorithm
uses this window to infer a previous desired state and avoid unwanted changes to workload
scale.</p><p>For example, in the following example snippet, a stabilization window is specified for <code>scaleDown</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>behavior</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleDown</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>stabilizationWindowSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>300</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>When the metrics indicate that the target should be scaled down the algorithm looks
into previously computed desired states, and uses the highest value from the specified
interval. In the above example, all desired states from the past 5 minutes will be considered.</p><p>This approximates a rolling maximum, and avoids having the scaling algorithm frequently
remove Pods only to trigger recreating an equivalent Pod just moments later.</p><h3 id=default-behavior>Default Behavior</h3><p>To use the custom scaling not all fields have to be specified. Only values which need to be
customized can be specified. These custom values are merged with default values. The default values
match the existing behavior in the HPA algorithm.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>behavior</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleDown</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>stabilizationWindowSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>300</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>policies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Percent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#666>100</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleUp</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>stabilizationWindowSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>policies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Percent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#666>100</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Pods<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#666>4</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>selectPolicy</span>:<span style=color:#bbb> </span>Max<span style=color:#bbb>
</span></span></span></code></pre></div><p>For scaling down the stabilization window is <em>300</em> seconds (or the value of the
<code>--horizontal-pod-autoscaler-downscale-stabilization</code> flag if provided). There is only a single policy
for scaling down which allows a 100% of the currently running replicas to be removed which
means the scaling target can be scaled down to the minimum allowed replicas.
For scaling up there is no stabilization window. When the metrics indicate that the target should be
scaled up the target is scaled up immediately. There are 2 policies where 4 pods or a 100% of the currently
running replicas will be added every 15 seconds till the HPA reaches its steady state.</p><h3 id=example-change-downscale-stabilization-window>Example: change downscale stabilization window</h3><p>To provide a custom downscale stabilization window of 1 minute, the following
behavior would be added to the HPA:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>behavior</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleDown</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>stabilizationWindowSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=example-limit-scale-down-rate>Example: limit scale down rate</h3><p>To limit the rate at which pods are removed by the HPA to 10% per minute, the
following behavior would be added to the HPA:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>behavior</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleDown</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>policies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Percent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>To ensure that no more than 5 Pods are removed per minute, you can add a second scale-down
policy with a fixed size of 5, and set <code>selectPolicy</code> to minimum. Setting <code>selectPolicy</code> to <code>Min</code> means
that the autoscaler chooses the policy that affects the smallest number of Pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>behavior</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleDown</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>policies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Percent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Pods<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>periodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>selectPolicy</span>:<span style=color:#bbb> </span>Min<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=example-disable-scale-down>Example: disable scale down</h3><p>The <code>selectPolicy</code> value of <code>Disabled</code> turns off scaling the given direction.
So to prevent downscaling the following policy would be used:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>behavior</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleDown</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>selectPolicy</span>:<span style=color:#bbb> </span>Disabled<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=support-for-horizontalpodautoscaler-in-kubectl>Support for HorizontalPodAutoscaler in kubectl</h2><p>HorizontalPodAutoscaler, like every API resource, is supported in a standard way by <code>kubectl</code>.
You can create a new autoscaler using <code>kubectl create</code> command.
You can list autoscalers by <code>kubectl get hpa</code> or get detailed description by <code>kubectl describe hpa</code>.
Finally, you can delete an autoscaler using <code>kubectl delete hpa</code>.</p><p>In addition, there is a special <code>kubectl autoscale</code> command for creating a HorizontalPodAutoscaler object.
For instance, executing <code>kubectl autoscale rs foo --min=2 --max=5 --cpu-percent=80</code>
will create an autoscaler for ReplicaSet <em>foo</em>, with target CPU utilization set to <code>80%</code>
and the number of replicas between 2 and 5.</p><h2 id=implicit-maintenance-mode-deactivation>Implicit maintenance-mode deactivation</h2><p>You can implicitly deactivate the HPA for a target without the
need to change the HPA configuration itself. If the target's desired replica count
is set to 0, and the HPA's minimum replica count is greater than 0, the HPA
stops adjusting the target (and sets the <code>ScalingActive</code> Condition on itself
to <code>false</code>) until you reactivate it by manually adjusting the target's desired
replica count or HPA's minimum replica count.</p><h3 id=migrating-deployments-and-statefulsets-to-horizontal-autoscaling>Migrating Deployments and StatefulSets to horizontal autoscaling</h3><p>When an HPA is enabled, it is recommended that the value of <code>spec.replicas</code> of
the Deployment and / or StatefulSet be removed from their
<a class=glossary-tooltip title='A serialized specification of one or more Kubernetes API objects.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-manifest' target=_blank aria-label=manifest(s)>manifest(s)</a>. If this isn't done, any time
a change to that object is applied, for example via <code>kubectl apply -f deployment.yaml</code>, this will instruct Kubernetes to scale the current number of Pods
to the value of the <code>spec.replicas</code> key. This may not be
desired and could be troublesome when an HPA is active.</p><p>Keep in mind that the removal of <code>spec.replicas</code> may incur a one-time
degradation of Pod counts as the default value of this key is 1 (reference
<a href=/docs/concepts/workloads/controllers/deployment#replicas>Deployment Replicas</a>).
Upon the update, all Pods except 1 will begin their termination procedures. Any
deployment application afterwards will behave as normal and respect a rolling
update configuration as desired. You can avoid this degradation by choosing one of the following two
methods based on how you are modifying your deployments:</p><ul class="nav nav-tabs" id=fix-replicas-instructions role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#fix-replicas-instructions-0 role=tab aria-controls=fix-replicas-instructions-0 aria-selected=true>Client Side Apply (this is the default)</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#fix-replicas-instructions-1 role=tab aria-controls=fix-replicas-instructions-1>Server Side Apply</a></li></ul><div class=tab-content id=fix-replicas-instructions><div id=fix-replicas-instructions-0 class="tab-pane show active" role=tabpanel aria-labelledby=fix-replicas-instructions-0><p><ol><li><code>kubectl apply edit-last-applied deployment/&lt;deployment_name></code></li><li>In the editor, remove <code>spec.replicas</code>. When you save and exit the editor, <code>kubectl</code>
applies the update. No changes to Pod counts happen at this step.</li><li>You can now remove <code>spec.replicas</code> from the manifest. If you use source code management,
also commit your changes or take whatever other steps for revising the source code
are appropriate for how you track updates.</li><li>From here on out you can run <code>kubectl apply -f deployment.yaml</code></li></ol></div><div id=fix-replicas-instructions-1 class=tab-pane role=tabpanel aria-labelledby=fix-replicas-instructions-1><p><p>When using the <a href=/docs/reference/using-api/server-side-apply/>Server-Side Apply</a>
you can follow the <a href=/docs/reference/using-api/server-side-apply/#transferring-ownership>transferring ownership</a>
guidelines, which cover this exact use case.</p></div></div><h2 id=what-s-next>What's next</h2><p>If you configure autoscaling in your cluster, you may also want to consider running a
cluster-level autoscaler such as <a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler>Cluster Autoscaler</a>.</p><p>For more information on HorizontalPodAutoscaler:</p><ul><li>Read a <a href=/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/>walkthrough example</a> for horizontal pod autoscaling.</li><li>Read documentation for <a href=/docs/reference/generated/kubectl/kubectl-commands/#autoscale><code>kubectl autoscale</code></a>.</li><li>If you would like to write your own custom metrics adapter, check out the
<a href=https://github.com/kubernetes-sigs/custom-metrics-apiserver>boilerplate</a> to get started.</li><li>Read the <a href=/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/>API reference</a> for HorizontalPodAutoscaler.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8138226ce9660ac8e3e82ff86fff8ad2>8.8 - HorizontalPodAutoscaler Walkthrough</h1><p>A <a href=/docs/tasks/run-application/horizontal-pod-autoscale/>HorizontalPodAutoscaler</a>
(HPA for short)
automatically updates a workload resource (such as
a <a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployment>Deployment</a> or
<a class=glossary-tooltip title='Manages deployment and scaling of a set of Pods, with durable storage and persistent identifiers for each Pod.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/statefulset/ target=_blank aria-label=StatefulSet>StatefulSet</a>), with the
aim of automatically scaling the workload to match demand.</p><p>Horizontal scaling means that the response to increased load is to deploy more
<a class=glossary-tooltip title='A Pod represents a set of running containers in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pods>Pods</a>.
This is different from <em>vertical</em> scaling, which for Kubernetes would mean
assigning more resources (for example: memory or CPU) to the Pods that are already
running for the workload.</p><p>If the load decreases, and the number of Pods is above the configured minimum,
the HorizontalPodAutoscaler instructs the workload resource (the Deployment, StatefulSet,
or other similar resource) to scale back down.</p><p>This document walks you through an example of enabling HorizontalPodAutoscaler to
automatically manage scale for an example web app. This example workload is Apache
httpd running some PHP code.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.23.
To check the version, enter <code>kubectl version</code>.
If you're running an older
release of Kubernetes, refer to the version of the documentation for that release (see
<a href=/docs/home/supported-doc-versions/>available documentation versions</a>).</p><p>To follow this walkthrough, you also need to use a cluster that has a
<a href=https://github.com/kubernetes-sigs/metrics-server#readme>Metrics Server</a> deployed and configured.
The Kubernetes Metrics Server collects resource metrics from
the <a class=glossary-tooltip title='An agent that runs on each node in the cluster. It makes sure that containers are running in a pod.' data-toggle=tooltip data-placement=top href=/docs/reference/generated/kubelet target=_blank aria-label=kubelets>kubelets</a> in your cluster, and exposes those metrics
through the <a href=/docs/concepts/overview/kubernetes-api/>Kubernetes API</a>,
using an <a href=/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>APIService</a> to add
new kinds of resource that represent metric readings.</p><p>To learn how to deploy the Metrics Server, see the
<a href=https://github.com/kubernetes-sigs/metrics-server#deployment>metrics-server documentation</a>.</p><h2 id=run-and-expose-php-apache-server>Run and expose php-apache server</h2><p>To demonstrate a HorizontalPodAutoscaler, you will first start a Deployment that runs a container using the
<code>hpa-example</code> image, and expose it as a <a class=glossary-tooltip title='A way to expose an application running on a set of Pods as a network service.' data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=Service>Service</a>
using the following manifest:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/php-apache.yaml download=application/php-apache.yaml><code>application/php-apache.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-php-apache-yaml")' title="Copy application/php-apache.yaml to clipboard"></img></div><div class=includecode id=application-php-apache-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/hpa-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>500m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>200m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>To do so, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/php-apache.yaml
</span></span></code></pre></div><pre tabindex=0><code>deployment.apps/php-apache created
service/php-apache created
</code></pre><h2 id=create-horizontal-pod-autoscaler>Create the HorizontalPodAutoscaler</h2><p>Now that the server is running, create the autoscaler using <code>kubectl</code>. There is
<a href=/docs/reference/generated/kubectl/kubectl-commands#autoscale><code>kubectl autoscale</code></a> subcommand,
part of <code>kubectl</code>, that helps you do this.</p><p>You will shortly run a command that creates a HorizontalPodAutoscaler that maintains
between 1 and 10 replicas of the Pods controlled by the php-apache Deployment that
you created in the first step of these instructions.</p><p>Roughly speaking, the HPA <a class=glossary-tooltip title='A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/controller/ target=_blank aria-label=controller>controller</a> will increase and decrease
the number of replicas (by updating the Deployment) to maintain an average CPU utilization across all Pods of 50%.
The Deployment then updates the ReplicaSet - this is part of how all Deployments work in Kubernetes -
and then the ReplicaSet either adds or removes Pods based on the change to its <code>.spec</code>.</p><p>Since each pod requests 200 milli-cores by <code>kubectl run</code>, this means an average CPU usage of 100 milli-cores.
See <a href=/docs/tasks/run-application/horizontal-pod-autoscale/#algorithm-details>Algorithm details</a> for more details
on the algorithm.</p><p>Create the HorizontalPodAutoscaler:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl autoscale deployment php-apache --cpu-percent<span style=color:#666>=</span><span style=color:#666>50</span> --min<span style=color:#666>=</span><span style=color:#666>1</span> --max<span style=color:#666>=</span><span style=color:#666>10</span>
</span></span></code></pre></div><pre tabindex=0><code>horizontalpodautoscaler.autoscaling/php-apache autoscaled
</code></pre><p>You can check the current status of the newly-made HorizontalPodAutoscaler, by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># You can use &#34;hpa&#34; or &#34;horizontalpodautoscaler&#34;; either name works OK.</span>
</span></span><span style=display:flex><span>kubectl get hpa
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>NAME         REFERENCE                     TARGET    MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache/scale   0% / 50%  1         10        1          18s
</code></pre><p>(if you see other HorizontalPodAutoscalers with different names, that means they already existed,
and isn't usually a problem).</p><p>Please note that the current CPU consumption is 0% as there are no clients sending requests to the server
(the <code>TARGET</code> column shows the average across all the Pods controlled by the corresponding deployment).</p><h2 id=increase-load>Increase the load</h2><p>Next, see how the autoscaler reacts to increased load.
To do this, you'll start a different Pod to act as a client. The container within the client Pod
runs in an infinite loop, sending queries to the php-apache service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Run this in a separate terminal</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># so that the load generation continues and you can carry on with the rest of the steps</span>
</span></span><span style=display:flex><span>kubectl run -i --tty load-generator --rm --image<span style=color:#666>=</span>busybox:1.28 --restart<span style=color:#666>=</span>Never -- /bin/sh -c <span style=color:#b44>&#34;while sleep 0.01; do wget -q -O- http://php-apache; done&#34;</span>
</span></span></code></pre></div><p>Now run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># type Ctrl+C to end the watch when you&#39;re ready</span>
</span></span><span style=display:flex><span>kubectl get hpa php-apache --watch
</span></span></code></pre></div><p>Within a minute or so, you should see the higher CPU load; for example:</p><pre tabindex=0><code>NAME         REFERENCE                     TARGET      MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache/scale   305% / 50%  1         10        1          3m
</code></pre><p>and then, more replicas. For example:</p><pre tabindex=0><code>NAME         REFERENCE                     TARGET      MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache/scale   305% / 50%  1         10        7          3m
</code></pre><p>Here, CPU consumption has increased to 305% of the request.
As a result, the Deployment was resized to 7 replicas:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment php-apache
</span></span></code></pre></div><p>You should see the replica count matching the figure from the HorizontalPodAutoscaler</p><pre tabindex=0><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
php-apache   7/7      7           7           19m
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> It may take a few minutes to stabilize the number of replicas. Since the amount
of load is not controlled in any way it may happen that the final number of replicas
will differ from this example.</div><h2 id=stop-load>Stop generating load</h2><p>To finish the example, stop sending the load.</p><p>In the terminal where you created the Pod that runs a <code>busybox</code> image, terminate
the load generation by typing <code>&lt;Ctrl> + C</code>.</p><p>Then verify the result state (after a minute or so):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># type Ctrl+C to end the watch when you&#39;re ready</span>
</span></span><span style=display:flex><span>kubectl get hpa php-apache --watch
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>NAME         REFERENCE                     TARGET       MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache/scale   0% / 50%     1         10        1          11m
</code></pre><p>and the Deployment also shows that it has scaled down:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment php-apache
</span></span></code></pre></div><pre tabindex=0><code>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
php-apache   1/1     1            1           27m
</code></pre><p>Once CPU utilization dropped to 0, the HPA automatically scaled the number of replicas back down to 1.</p><p>Autoscaling the replicas may take a few minutes.</p><h2 id=autoscaling-on-multiple-metrics-and-custom-metrics>Autoscaling on multiple metrics and custom metrics</h2><p>You can introduce additional metrics to use when autoscaling the <code>php-apache</code> Deployment
by making use of the <code>autoscaling/v2</code> API version.</p><p>First, get the YAML of your HorizontalPodAutoscaler in the <code>autoscaling/v2</code> form:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get hpa php-apache -o yaml &gt; /tmp/hpa-v2.yaml
</span></span></code></pre></div><p>Open the <code>/tmp/hpa-v2.yaml</code> file in an editor, and you should see YAML which looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>autoscaling/v2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>HorizontalPodAutoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleTargetRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>maxReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metrics</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Resource<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Utilization<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>averageUtilization</span>:<span style=color:#bbb> </span><span style=color:#666>50</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>observedGeneration</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>lastScaleTime</span>:<span style=color:#bbb> </span>&lt;some-time&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>currentReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>desiredReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>currentMetrics</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Resource<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>current</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>averageUtilization</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>averageValue</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Notice that the <code>targetCPUUtilizationPercentage</code> field has been replaced with an array called <code>metrics</code>.
The CPU utilization metric is a <em>resource metric</em>, since it is represented as a percentage of a resource
specified on pod containers. Notice that you can specify other resource metrics besides CPU. By default,
the only other supported resource metric is memory. These resources do not change names from cluster
to cluster, and should always be available, as long as the <code>metrics.k8s.io</code> API is available.</p><p>You can also specify resource metrics in terms of direct values, instead of as percentages of the
requested value, by using a <code>target.type</code> of <code>AverageValue</code> instead of <code>Utilization</code>, and
setting the corresponding <code>target.averageValue</code> field instead of the <code>target.averageUtilization</code>.</p><p>There are two other types of metrics, both of which are considered <em>custom metrics</em>: pod metrics and
object metrics. These metrics may have names which are cluster specific, and require a more
advanced cluster monitoring setup.</p><p>The first of these alternative metric types is <em>pod metrics</em>. These metrics describe Pods, and
are averaged together across Pods and compared with a target value to determine the replica count.
They work much like resource metrics, except that they <em>only</em> support a <code>target</code> type of <code>AverageValue</code>.</p><p>Pod metrics are specified using a metric block like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Pods<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>pods</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metric</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>packets-per-second<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>AverageValue<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>averageValue</span>:<span style=color:#bbb> </span>1k<span style=color:#bbb>
</span></span></span></code></pre></div><p>The second alternative metric type is <em>object metrics</em>. These metrics describe a different
object in the same namespace, instead of describing Pods. The metrics are not necessarily
fetched from the object; they only describe it. Object metrics support <code>target</code> types of
both <code>Value</code> and <code>AverageValue</code>. With <code>Value</code>, the target is compared directly to the returned
metric from the API. With <code>AverageValue</code>, the value returned from the custom metrics API is divided
by the number of Pods before being compared to the target. The following example is the YAML
representation of the <code>requests-per-second</code> metric.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>object</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metric</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>requests-per-second<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>describedObject</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>networking.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Ingress<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>main-route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Value<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>2k<span style=color:#bbb>
</span></span></span></code></pre></div><p>If you provide multiple such metric blocks, the HorizontalPodAutoscaler will consider each metric in turn.
The HorizontalPodAutoscaler will calculate proposed replica counts for each metric, and then choose the
one with the highest replica count.</p><p>For example, if you had your monitoring system collecting metrics about network traffic,
you could update the definition above using <code>kubectl edit</code> to look like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>autoscaling/v2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>HorizontalPodAutoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleTargetRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>maxReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metrics</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Resource<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Utilization<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>averageUtilization</span>:<span style=color:#bbb> </span><span style=color:#666>50</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Pods<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pods</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metric</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>packets-per-second<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>AverageValue<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>averageValue</span>:<span style=color:#bbb> </span>1k<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>object</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metric</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>requests-per-second<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>describedObject</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>networking.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Ingress<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>main-route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Value<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>10k<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>observedGeneration</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>lastScaleTime</span>:<span style=color:#bbb> </span>&lt;some-time&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>currentReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>desiredReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>currentMetrics</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Resource<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resource</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cpu<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>current</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>averageUtilization</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>averageValue</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>object</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metric</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>requests-per-second<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>describedObject</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>networking.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Ingress<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>main-route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>current</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>10k<span style=color:#bbb>
</span></span></span></code></pre></div><p>Then, your HorizontalPodAutoscaler would attempt to ensure that each pod was consuming roughly
50% of its requested CPU, serving 1000 packets per second, and that all pods behind the main-route
Ingress were serving a total of 10000 requests per second.</p><h3 id=autoscaling-on-more-specific-metrics>Autoscaling on more specific metrics</h3><p>Many metrics pipelines allow you to describe metrics either by name or by a set of additional
descriptors called <em>labels</em>. For all non-resource metric types (pod, object, and external,
described below), you can specify an additional label selector which is passed to your metric
pipeline. For instance, if you collect a metric <code>http_requests</code> with the <code>verb</code>
label, you can specify the following metric block to scale only on GET requests:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>object</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metric</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>http_requests<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb> </span>{<span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb> </span>{<span style=color:green;font-weight:700>verb</span>:<span style=color:#bbb> </span>GET}}<span style=color:#bbb>
</span></span></span></code></pre></div><p>This selector uses the same syntax as the full Kubernetes label selectors. The monitoring pipeline
determines how to collapse multiple series into a single value, if the name and selector
match multiple series. The selector is additive, and cannot select metrics
that describe objects that are <strong>not</strong> the target object (the target pods in the case of the <code>Pods</code>
type, and the described object in the case of the <code>Object</code> type).</p><h3 id=autoscaling-on-metrics-not-related-to-kubernetes-objects>Autoscaling on metrics not related to Kubernetes objects</h3><p>Applications running on Kubernetes may need to autoscale based on metrics that don't have an obvious
relationship to any object in the Kubernetes cluster, such as metrics describing a hosted service with
no direct correlation to Kubernetes namespaces. In Kubernetes 1.10 and later, you can address this use case
with <em>external metrics</em>.</p><p>Using external metrics requires knowledge of your monitoring system; the setup is
similar to that required when using custom metrics. External metrics allow you to autoscale your cluster
based on any metric available in your monitoring system. Provide a <code>metric</code> block with a
<code>name</code> and <code>selector</code>, as above, and use the <code>External</code> metric type instead of <code>Object</code>.
If multiple time series are matched by the <code>metricSelector</code>,
the sum of their values is used by the HorizontalPodAutoscaler.
External metrics support both the <code>Value</code> and <code>AverageValue</code> target types, which function exactly the same
as when you use the <code>Object</code> type.</p><p>For example if your application processes tasks from a hosted queue service, you could add the following
section to your HorizontalPodAutoscaler manifest to specify that you need one worker per 30 outstanding tasks.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>External<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>external</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metric</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>queue_messages_ready<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>queue</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;worker_tasks&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>AverageValue<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>averageValue</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>When possible, it's preferable to use the custom metric target types instead of external metrics, since it's
easier for cluster administrators to secure the custom metrics API. The external metrics API potentially allows
access to any metric, so cluster administrators should take care when exposing it.</p><h2 id=appendix-horizontal-pod-autoscaler-status-conditions>Appendix: Horizontal Pod Autoscaler Status Conditions</h2><p>When using the <code>autoscaling/v2</code> form of the HorizontalPodAutoscaler, you will be able to see
<em>status conditions</em> set by Kubernetes on the HorizontalPodAutoscaler. These status conditions indicate
whether or not the HorizontalPodAutoscaler is able to scale, and whether or not it is currently restricted
in any way.</p><p>The conditions appear in the <code>status.conditions</code> field. To see the conditions affecting a HorizontalPodAutoscaler,
we can use <code>kubectl describe hpa</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe hpa cm-test
</span></span></code></pre></div><pre tabindex=0><code>Name:                           cm-test
Namespace:                      prom
Labels:                         &lt;none&gt;
Annotations:                    &lt;none&gt;
CreationTimestamp:              Fri, 16 Jun 2017 18:09:22 +0000
Reference:                      ReplicationController/cm-test
Metrics:                        ( current / target )
  &#34;http_requests&#34; on pods:      66m / 500m
Min replicas:                   1
Max replicas:                   4
ReplicationController pods:     1 current / 1 desired
Conditions:
  Type                  Status  Reason                  Message
  ----                  ------  ------                  -------
  AbleToScale           True    ReadyForNewScale        the last scale time was sufficiently old as to warrant a new scale
  ScalingActive         True    ValidMetricFound        the HPA was able to successfully calculate a replica count from pods metric http_requests
  ScalingLimited        False   DesiredWithinRange      the desired replica count is within the acceptable range
Events:
</code></pre><p>For this HorizontalPodAutoscaler, you can see several conditions in a healthy state. The first,
<code>AbleToScale</code>, indicates whether or not the HPA is able to fetch and update scales, as well as
whether or not any backoff-related conditions would prevent scaling. The second, <code>ScalingActive</code>,
indicates whether or not the HPA is enabled (i.e. the replica count of the target is not zero) and
is able to calculate desired scales. When it is <code>False</code>, it generally indicates problems with
fetching metrics. Finally, the last condition, <code>ScalingLimited</code>, indicates that the desired scale
was capped by the maximum or minimum of the HorizontalPodAutoscaler. This is an indication that
you may wish to raise or lower the minimum or maximum replica count constraints on your
HorizontalPodAutoscaler.</p><h2 id=quantities>Quantities</h2><p>All metrics in the HorizontalPodAutoscaler and metrics APIs are specified using
a special whole-number notation known in Kubernetes as a
<a class=glossary-tooltip title='A whole-number representation of small or large numbers using SI suffixes.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-quantity' target=_blank aria-label=quantity>quantity</a>. For example,
the quantity <code>10500m</code> would be written as <code>10.5</code> in decimal notation. The metrics APIs
will return whole numbers without a suffix when possible, and will generally return
quantities in milli-units otherwise. This means you might see your metric value fluctuate
between <code>1</code> and <code>1500m</code>, or <code>1</code> and <code>1.5</code> when written in decimal notation.</p><h2 id=other-possible-scenarios>Other possible scenarios</h2><h3 id=creating-the-autoscaler-declaratively>Creating the autoscaler declaratively</h3><p>Instead of using <code>kubectl autoscale</code> command to create a HorizontalPodAutoscaler imperatively we
can use the following manifest to create it declaratively:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/hpa/php-apache.yaml download=application/hpa/php-apache.yaml><code>application/hpa/php-apache.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-hpa-php-apache-yaml")' title="Copy application/hpa/php-apache.yaml to clipboard"></img></div><div class=includecode id=application-hpa-php-apache-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>autoscaling/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>HorizontalPodAutoscaler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scaleTargetRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>php-apache<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>maxReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>targetCPUUtilizationPercentage</span>:<span style=color:#bbb> </span><span style=color:#666>50</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Then, create the autoscaler by executing the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/application/hpa/php-apache.yaml
</span></span></code></pre></div><pre tabindex=0><code>horizontalpodautoscaler.autoscaling/php-apache created
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-fbe2744f00d1aa4df4cdf4eea6a082d4>8.9 - Specifying a Disruption Budget for your Application</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.21 [stable]</code></div><p>This page shows how to limit the number of concurrent disruptions
that your application experiences, allowing for higher availability
while permitting the cluster administrator to manage the clusters
nodes.</p><h2 id=before-you-begin>Before you begin</h2>Your Kubernetes server must be at or later than version v1.21.
To check the version, enter <code>kubectl version</code>.<ul><li>You are the owner of an application running on a Kubernetes cluster that requires
high availability.</li><li>You should know how to deploy <a href=/docs/tasks/run-application/run-stateless-application-deployment/>Replicated Stateless Applications</a>
and/or <a href=/docs/tasks/run-application/run-replicated-stateful-application/>Replicated Stateful Applications</a>.</li><li>You should have read about <a href=/docs/concepts/workloads/pods/disruptions/>Pod Disruptions</a>.</li><li>You should confirm with your cluster owner or service provider that they respect
Pod Disruption Budgets.</li></ul><h2 id=protecting-an-application-with-a-poddisruptionbudget>Protecting an Application with a PodDisruptionBudget</h2><ol><li>Identify what application you want to protect with a PodDisruptionBudget (PDB).</li><li>Think about how your application reacts to disruptions.</li><li>Create a PDB definition as a YAML file.</li><li>Create the PDB object from the YAML file.</li></ol><h2 id=identify-an-application-to-protect>Identify an Application to Protect</h2><p>The most common use case when you want to protect an application
specified by one of the built-in Kubernetes controllers:</p><ul><li>Deployment</li><li>ReplicationController</li><li>ReplicaSet</li><li>StatefulSet</li></ul><p>In this case, make a note of the controller's <code>.spec.selector</code>; the same
selector goes into the PDBs <code>.spec.selector</code>.</p><p>From version 1.15 PDBs support custom controllers where the <a href=/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#scale-subresource>scale subresource</a> is enabled.</p><p>You can also use PDBs with pods which are not controlled by one of the above
controllers, or arbitrary groups of pods, but there are some restrictions,
described in <a href=#arbitrary-controllers-and-selectors>Arbitrary Controllers and Selectors</a>.</p><h2 id=think-about-how-your-application-reacts-to-disruptions>Think about how your application reacts to disruptions</h2><p>Decide how many instances can be down at the same time for a short period
due to a voluntary disruption.</p><ul><li>Stateless frontends:<ul><li>Concern: don't reduce serving capacity by more than 10%.<ul><li>Solution: use PDB with minAvailable 90% for example.</li></ul></li></ul></li><li>Single-instance Stateful Application:<ul><li>Concern: do not terminate this application without talking to me.<ul><li>Possible Solution 1: Do not use a PDB and tolerate occasional downtime.</li><li>Possible Solution 2: Set PDB with maxUnavailable=0. Have an understanding
(outside of Kubernetes) that the cluster operator needs to consult you before
termination. When the cluster operator contacts you, prepare for downtime,
and then delete the PDB to indicate readiness for disruption. Recreate afterwards.</li></ul></li></ul></li><li>Multiple-instance Stateful application such as Consul, ZooKeeper, or etcd:<ul><li>Concern: Do not reduce number of instances below quorum, otherwise writes fail.<ul><li>Possible Solution 1: set maxUnavailable to 1 (works with varying scale of application).</li><li>Possible Solution 2: set minAvailable to quorum-size (e.g. 3 when scale is 5). (Allows more disruptions at once).</li></ul></li></ul></li><li>Restartable Batch Job:<ul><li>Concern: Job needs to complete in case of voluntary disruption.<ul><li>Possible solution: Do not create a PDB. The Job controller will create a replacement pod.</li></ul></li></ul></li></ul><h3 id=rounding-logic-when-specifying-percentages>Rounding logic when specifying percentages</h3><p>Values for <code>minAvailable</code> or <code>maxUnavailable</code> can be expressed as integers or as a percentage.</p><ul><li>When you specify an integer, it represents a number of Pods. For instance, if you set <code>minAvailable</code> to 10, then 10
Pods must always be available, even during a disruption.</li><li>When you specify a percentage by setting the value to a string representation of a percentage (eg. <code>"50%"</code>), it represents a percentage of
total Pods. For instance, if you set <code>maxUnavailable</code> to <code>"50%"</code>, then only 50% of the Pods can be unavailable during a
disruption.</li></ul><p>When you specify the value as a percentage, it may not map to an exact number of Pods. For example, if you have 7 Pods and
you set <code>minAvailable</code> to <code>"50%"</code>, it's not immediately obvious whether that means 3 Pods or 4 Pods must be available.
Kubernetes rounds up to the nearest integer, so in this case, 4 Pods must be available. You can examine the
<a href=https://github.com/kubernetes/kubernetes/blob/23be9587a0f8677eb8091464098881df939c44a9/pkg/controller/disruption/disruption.go#L539>code</a>
that controls this behavior.</p><h2 id=specifying-a-poddisruptionbudget>Specifying a PodDisruptionBudget</h2><p>A <code>PodDisruptionBudget</code> has three fields:</p><ul><li>A label selector <code>.spec.selector</code> to specify the set of
pods to which it applies. This field is required.</li><li><code>.spec.minAvailable</code> which is a description of the number of pods from that
set that must still be available after the eviction, even in the absence
of the evicted pod. <code>minAvailable</code> can be either an absolute number or a percentage.</li><li><code>.spec.maxUnavailable</code> (available in Kubernetes 1.7 and higher) which is a description
of the number of pods from that set that can be unavailable after the eviction.
It can be either an absolute number or a percentage.</li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The behavior for an empty selector differs between the policy/v1beta1 and policy/v1 APIs for
PodDisruptionBudgets. For policy/v1beta1 an empty selector matches zero pods, while
for policy/v1 an empty selector matches every pod in the namespace.</div><p>You can specify only one of <code>maxUnavailable</code> and <code>minAvailable</code> in a single <code>PodDisruptionBudget</code>.
<code>maxUnavailable</code> can only be used to control the eviction of pods
that have an associated controller managing them. In the examples below, "desired replicas"
is the <code>scale</code> of the controller managing the pods being selected by the
<code>PodDisruptionBudget</code>.</p><p>Example 1: With a <code>minAvailable</code> of 5, evictions are allowed as long as they leave behind
5 or more healthy pods among those selected by the PodDisruptionBudget's <code>selector</code>.</p><p>Example 2: With a <code>minAvailable</code> of 30%, evictions are allowed as long as at least 30%
of the number of desired replicas are healthy.</p><p>Example 3: With a <code>maxUnavailable</code> of 5, evictions are allowed as long as there are at most 5
unhealthy replicas among the total number of desired replicas.</p><p>Example 4: With a <code>maxUnavailable</code> of 30%, evictions are allowed as long as no more than 30%
of the desired replicas are unhealthy.</p><p>In typical usage, a single budget would be used for a collection of pods managed by
a controller—for example, the pods in a single ReplicaSet or StatefulSet.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> A disruption budget does not truly guarantee that the specified
number/percentage of pods will always be up. For example, a node that hosts a
pod from the collection may fail when the collection is at the minimum size
specified in the budget, thus bringing the number of available pods from the
collection below the specified size. The budget can only protect against
voluntary evictions, not all causes of unavailability.</div><p>If you set <code>maxUnavailable</code> to 0% or 0, or you set <code>minAvailable</code> to 100% or the number of replicas,
you are requiring zero voluntary evictions. When you set zero voluntary evictions for a workload
object such as ReplicaSet, then you cannot successfully drain a Node running one of those Pods.
If you try to drain a Node where an unevictable Pod is running, the drain never completes. This is permitted as per the
semantics of <code>PodDisruptionBudget</code>.</p><p>You can find examples of pod disruption budgets defined below. They match pods with the label
<code>app: zookeeper</code>.</p><p>Example PDB Using minAvailable:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/policy/zookeeper-pod-disruption-budget-minavailable.yaml download=policy/zookeeper-pod-disruption-budget-minavailable.yaml><code>policy/zookeeper-pod-disruption-budget-minavailable.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("policy-zookeeper-pod-disruption-budget-minavailable-yaml")' title="Copy policy/zookeeper-pod-disruption-budget-minavailable.yaml to clipboard"></img></div><div class=includecode id=policy-zookeeper-pod-disruption-budget-minavailable-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>policy/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PodDisruptionBudget<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>zk-pdb<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minAvailable</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>zookeeper<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Example PDB Using maxUnavailable:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/policy/zookeeper-pod-disruption-budget-maxunavailable.yaml download=policy/zookeeper-pod-disruption-budget-maxunavailable.yaml><code>policy/zookeeper-pod-disruption-budget-maxunavailable.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("policy-zookeeper-pod-disruption-budget-maxunavailable-yaml")' title="Copy policy/zookeeper-pod-disruption-budget-maxunavailable.yaml to clipboard"></img></div><div class=includecode id=policy-zookeeper-pod-disruption-budget-maxunavailable-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>policy/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PodDisruptionBudget<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>zk-pdb<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>maxUnavailable</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>zookeeper<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>For example, if the above <code>zk-pdb</code> object selects the pods of a StatefulSet of size 3, both
specifications have the exact same meaning. The use of <code>maxUnavailable</code> is recommended as it
automatically responds to changes in the number of replicas of the corresponding controller.</p><h2 id=create-the-pdb-object>Create the PDB object</h2><p>You can create or update the PDB object using kubectl.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f mypdb.yaml
</span></span></code></pre></div><h2 id=check-the-status-of-the-pdb>Check the status of the PDB</h2><p>Use kubectl to check that your PDB is created.</p><p>Assuming you don't actually have pods matching <code>app: zookeeper</code> in your namespace,
then you'll see something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get poddisruptionbudgets
</span></span></code></pre></div><pre tabindex=0><code>NAME     MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
zk-pdb   2               N/A               0                     7s
</code></pre><p>If there are matching pods (say, 3), then you would see something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get poddisruptionbudgets
</span></span></code></pre></div><pre tabindex=0><code>NAME     MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
zk-pdb   2               N/A               1                     7s
</code></pre><p>The non-zero value for <code>ALLOWED DISRUPTIONS</code> means that the disruption controller has seen the pods,
counted the matching pods, and updated the status of the PDB.</p><p>You can get more information about the status of a PDB with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get poddisruptionbudgets zk-pdb -o yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>policy/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>PodDisruptionBudget<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>…<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2020-03-04T04:22:56Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>generation</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>zk-pdb<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>…<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>currentHealthy</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>desiredHealthy</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>disruptionsAllowed</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>expectedPods</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>observedGeneration</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=arbitrary-controllers-and-selectors>Arbitrary Controllers and Selectors</h2><p>You can skip this section if you only use PDBs with the built-in
application controllers (Deployment, ReplicationController, ReplicaSet, and StatefulSet),
with the PDB selector matching the controller's selector.</p><p>You can use a PDB with pods controlled by another type of controller, by an
"operator", or bare pods, but with these restrictions:</p><ul><li>only <code>.spec.minAvailable</code> can be used, not <code>.spec.maxUnavailable</code>.</li><li>only an integer value can be used with <code>.spec.minAvailable</code>, not a percentage.</li></ul><p>You can use a selector which selects a subset or superset of the pods belonging to a built-in
controller. The eviction API will disallow eviction of any pod covered by multiple PDBs,
so most users will want to avoid overlapping selectors. One reasonable use of overlapping
PDBs is when pods are being transitioned from one PDB to another.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-52cd10ee3fc7c74a6c31043a2d489878>8.10 - Accessing the Kubernetes API from a Pod</h1><p>This guide demonstrates how to access the Kubernetes API from within a pod.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=accessing-the-api-from-within-a-pod>Accessing the API from within a Pod</h2><p>When accessing the API from within a Pod, locating and authenticating
to the API server are slightly different to the external client case.</p><p>The easiest way to use the Kubernetes API from a Pod is to use
one of the official <a href=/docs/reference/using-api/client-libraries/>client libraries</a>. These
libraries can automatically discover the API server and authenticate.</p><h3 id=using-official-client-libraries>Using Official Client Libraries</h3><p>From within a Pod, the recommended ways to connect to the Kubernetes API are:</p><ul><li><p>For a Go client, use the official <a href=https://github.com/kubernetes/client-go/>Go client library</a>.
The <code>rest.InClusterConfig()</code> function handles API host discovery and authentication automatically.
See <a href=https://git.k8s.io/client-go/examples/in-cluster-client-configuration/main.go>an example here</a>.</p></li><li><p>For a Python client, use the official <a href=https://github.com/kubernetes-client/python/>Python client library</a>.
The <code>config.load_incluster_config()</code> function handles API host discovery and authentication automatically.
See <a href=https://github.com/kubernetes-client/python/blob/master/examples/in_cluster_config.py>an example here</a>.</p></li><li><p>There are a number of other libraries available, please refer to the <a href=/docs/reference/using-api/client-libraries/>Client Libraries</a> page.</p></li></ul><p>In each case, the service account credentials of the Pod are used to communicate
securely with the API server.</p><h3 id=directly-accessing-the-rest-api>Directly accessing the REST API</h3><p>While running in a Pod, the Kubernetes apiserver is accessible via a Service named
<code>kubernetes</code> in the <code>default</code> namespace. Therefore, Pods can use the
<code>kubernetes.default.svc</code> hostname to query the API server. Official client libraries
do this automatically.</p><p>The recommended way to authenticate to the API server is with a
<a href=/docs/tasks/configure-pod-container/configure-service-account/>service account</a>
credential. By default, a Pod
is associated with a service account, and a credential (token) for that
service account is placed into the filesystem tree of each container in that Pod,
at <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>.</p><p>If available, a certificate bundle is placed into the filesystem tree of each
container at <code>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</code>, and should be
used to verify the serving certificate of the API server.</p><p>Finally, the default namespace to be used for namespaced API operations is placed in a file
at <code>/var/run/secrets/kubernetes.io/serviceaccount/namespace</code> in each container.</p><h3 id=using-kubectl-proxy>Using kubectl proxy</h3><p>If you would like to query the API without an official client library, you can run <code>kubectl proxy</code>
as the <a href=/docs/tasks/inject-data-application/define-command-argument-container/>command</a>
of a new sidecar container in the Pod. This way, <code>kubectl proxy</code> will authenticate
to the API and expose it on the <code>localhost</code> interface of the Pod, so that other containers
in the Pod can use it directly.</p><h3 id=without-using-a-proxy>Without using a proxy</h3><p>It is possible to avoid using the kubectl proxy by passing the authentication token
directly to the API server. The internal certificate secures the connection.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Point to the internal API server hostname</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>APISERVER</span><span style=color:#666>=</span>https://kubernetes.default.svc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Path to ServiceAccount token</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>SERVICEACCOUNT</span><span style=color:#666>=</span>/var/run/secrets/kubernetes.io/serviceaccount
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Read this Pod&#39;s namespace</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>NAMESPACE</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>cat <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICEACCOUNT</span><span style=color:#b68;font-weight:700>}</span>/namespace<span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Read the ServiceAccount bearer token</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>TOKEN</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>cat <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICEACCOUNT</span><span style=color:#b68;font-weight:700>}</span>/token<span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Reference the internal certificate authority (CA)</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>CACERT</span><span style=color:#666>=</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>SERVICEACCOUNT</span><span style=color:#b68;font-weight:700>}</span>/ca.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Explore the API with TOKEN</span>
</span></span><span style=display:flex><span>curl --cacert <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CACERT</span><span style=color:#b68;font-weight:700>}</span> --header <span style=color:#b44>&#34;Authorization: Bearer </span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>TOKEN</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span> -X GET <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>APISERVER</span><span style=color:#b68;font-weight:700>}</span>/api
</span></span></code></pre></div><p>The output will be similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;kind&#34;</span>: <span style=color:#b44>&#34;APIVersions&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;versions&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;v1&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;serverAddressByClientCIDRs&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;clientCIDR&#34;</span>: <span style=color:#b44>&#34;0.0.0.0/0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;serverAddress&#34;</span>: <span style=color:#b44>&#34;10.0.1.149:443&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ca3bc4e31dfe46d5044a3b93eb804ee9>9 - Run Jobs</h1><div class=lead>Run Jobs using parallel processing.</div></div><div class=td-content><h1 id=pg-964bdff888520740e5e221695245678d>9.1 - Running Automated Tasks with a CronJob</h1><p>You can use a <a class=glossary-tooltip title='A repeating task (a Job) that runs on a regular schedule.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/cron-jobs/ target=_blank aria-label=CronJob>CronJob</a> to run <a class=glossary-tooltip title='A finite or batch task that runs to completion.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/job/ target=_blank aria-label=Jobs>Jobs</a>
on a time-based schedule.
These automated jobs run like <a href=https://en.wikipedia.org/wiki/Cron>Cron</a> tasks on a Linux or UNIX system.</p><p>Cron jobs are useful for creating periodic and recurring tasks, like running backups or sending emails.
Cron jobs can also schedule individual tasks for a specific time, such as if you want to schedule a job for a low activity period.</p><p>Cron jobs have limitations and idiosyncrasies.
For example, in certain circumstances, a single cron job can create multiple jobs.
Therefore, jobs should be idempotent.</p><p>For more limitations, see <a href=/docs/concepts/workloads/controllers/cron-jobs>CronJobs</a>.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul></li></ul><h2 id=creating-a-cron-job>Creating a CronJob</h2><p>Cron jobs require a config file.
Here is a manifest for a CronJob that runs a simple demonstration task every minute:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/cronjob.yaml download=application/job/cronjob.yaml><code>application/job/cronjob.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-cronjob-yaml")' title="Copy application/job/cronjob.yaml to clipboard"></img></div><div class=includecode id=application-job-cronjob-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronJob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>schedule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * *&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>jobTemplate</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- /bin/sh<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- date; echo Hello from the Kubernetes cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Run the example CronJob by using this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/application/job/cronjob.yaml
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>cronjob.batch/hello created
</code></pre><p>After creating the cron job, get its status using this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get cronjob hello
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
hello   */1 * * * *   False     0        &lt;none&gt;          10s
</code></pre><p>As you can see from the results of the command, the cron job has not scheduled or run any jobs yet.
Watch for the job to be created in around one minute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get <span style=color:#a2f>jobs</span> --watch
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME               COMPLETIONS   DURATION   AGE
hello-4111706356   0/1                      0s
hello-4111706356   0/1           0s         0s
hello-4111706356   1/1           5s         5s
</code></pre><p>Now you've seen one running job scheduled by the "hello" cron job.
You can stop watching the job and view the cron job again to see that it scheduled the job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get cronjob hello
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
hello   */1 * * * *   False     0        50s             75s
</code></pre><p>You should see that the cron job <code>hello</code> successfully scheduled a job at the time specified in
<code>LAST SCHEDULE</code>. There are currently 0 active jobs, meaning that the job has completed or failed.</p><p>Now, find the pods that the last scheduled job created and view the standard output of one of the pods.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The job name is different from the pod name.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Replace &#34;hello-4111706356&#34; with the job name in your system</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>pods</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get pods --selector<span style=color:#666>=</span>job-name<span style=color:#666>=</span>hello-4111706356 --output<span style=color:#666>=</span><span style=color:#b8860b>jsonpath</span><span style=color:#666>={</span>.items<span style=color:#666>[</span>*<span style=color:#666>]</span>.metadata.name<span style=color:#666>}</span><span style=color:#a2f;font-weight:700>)</span>
</span></span></code></pre></div><p>Show the pod log:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs <span style=color:#b8860b>$pods</span>
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>Fri Feb 22 11:02:09 UTC 2019
Hello from the Kubernetes cluster
</code></pre><h2 id=deleting-a-cron-job>Deleting a CronJob</h2><p>When you don't need a cron job any more, delete it with <code>kubectl delete cronjob &lt;cronjob name></code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete cronjob hello
</span></span></code></pre></div><p>Deleting the cron job removes all the jobs and pods it created and stops it from creating additional jobs.
You can read more about removing jobs in <a href=/docs/concepts/architecture/garbage-collection/>garbage collection</a>.</p><h2 id=writing-a-cron-job-spec>Writing a CronJob Spec</h2><p>As with all other Kubernetes objects, a CronJob must have <code>apiVersion</code>, <code>kind</code>, and <code>metadata</code> fields.
For more information about working with Kubernetes objects and their
<a class=glossary-tooltip title='A serialized specification of one or more Kubernetes API objects.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-manifest' target=_blank aria-label=manifests>manifests</a>, see the
<a href=/docs/concepts/cluster-administration/manage-deployment/>managing resources</a>,
and <a href=/docs/concepts/overview/working-with-objects/object-management/>using kubectl to manage resources</a> documents.</p><p>Each manifest for a CronJob also needs a <a href=/docs/concepts/overview/working-with-objects/kubernetes-objects/#object-spec-and-status><code>.spec</code></a> section.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you modify a CronJob, the changes you make will apply to new jobs that start to run after your modification
is complete. Jobs (and their Pods) that have already started continue to run without changes.
That is, the CronJob does <em>not</em> update existing jobs, even if those remain running.</div><h3 id=schedule>Schedule</h3><p>The <code>.spec.schedule</code> is a required field of the <code>.spec</code>.
It takes a <a href=https://en.wikipedia.org/wiki/Cron>Cron</a> format string, such as <code>0 * * * *</code> or <code>@hourly</code>,
as schedule time of its jobs to be created and executed.</p><p>The format also includes extended "Vixie cron" step values. As explained in the
<a href=https://www.freebsd.org/cgi/man.cgi?crontab%285%29>FreeBSD manual</a>:</p><blockquote><p>Step values can be used in conjunction with ranges. Following a range
with <code>/&lt;number></code> specifies skips of the number's value through the
range. For example, <code>0-23/2</code> can be used in the hours field to specify
command execution every other hour (the alternative in the V7 standard is
<code>0,2,4,6,8,10,12,14,16,18,20,22</code>). Steps are also permitted after an
asterisk, so if you want to say "every two hours", just use <code>*/2</code>.</p></blockquote><div class="alert alert-info note callout" role=alert><strong>Note:</strong> A question mark (<code>?</code>) in the schedule has the same meaning as an asterisk <code>*</code>, that is,
it stands for any of available value for a given field.</div><h3 id=job-template>Job Template</h3><p>The <code>.spec.jobTemplate</code> is the template for the job, and it is required.
It has exactly the same schema as a <a href=/docs/concepts/workloads/controllers/job/>Job</a>, except that
it is nested and does not have an <code>apiVersion</code> or <code>kind</code>.
For information about writing a job <code>.spec</code>, see <a href=/docs/concepts/workloads/controllers/job/#writing-a-job-spec>Writing a Job Spec</a>.</p><h3 id=starting-deadline>Starting Deadline</h3><p>The <code>.spec.startingDeadlineSeconds</code> field is optional.
It stands for the deadline in seconds for starting the job if it misses its scheduled time for any reason.
After the deadline, the cron job does not start the job.
Jobs that do not meet their deadline in this way count as failed jobs.
If this field is not specified, the jobs have no deadline.</p><p>If the <code>.spec.startingDeadlineSeconds</code> field is set (not null), the CronJob
controller measures the time between when a job is expected to be created and
now. If the difference is higher than that limit, it will skip this execution.</p><p>For example, if it is set to <code>200</code>, it allows a job to be created for up to 200
seconds after the actual schedule.</p><h3 id=concurrency-policy>Concurrency Policy</h3><p>The <code>.spec.concurrencyPolicy</code> field is also optional.
It specifies how to treat concurrent executions of a job that is created by this cron job.
The spec may specify only one of the following concurrency policies:</p><ul><li><code>Allow</code> (default): The cron job allows concurrently running jobs</li><li><code>Forbid</code>: The cron job does not allow concurrent runs; if it is time for a new job run and the
previous job run hasn't finished yet, the cron job skips the new job run</li><li><code>Replace</code>: If it is time for a new job run and the previous job run hasn't finished yet, the
cron job replaces the currently running job run with a new job run</li></ul><p>Note that concurrency policy only applies to the jobs created by the same cron job.
If there are multiple cron jobs, their respective jobs are always allowed to run concurrently.</p><h3 id=suspend>Suspend</h3><p>The <code>.spec.suspend</code> field is also optional.
If it is set to <code>true</code>, all subsequent executions are suspended.
This setting does not apply to already started executions.
Defaults to false.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Executions that are suspended during their scheduled time count as missed jobs.
When <code>.spec.suspend</code> changes from <code>true</code> to <code>false</code> on an existing cron job without a
<a href=#starting-deadline>starting deadline</a>, the missed jobs are scheduled immediately.</div><h3 id=jobs-history-limits>Jobs History Limits</h3><p>The <code>.spec.successfulJobsHistoryLimit</code> and <code>.spec.failedJobsHistoryLimit</code> fields are optional.
These fields specify how many completed and failed jobs should be kept.
By default, they are set to 3 and 1 respectively. Setting a limit to <code>0</code> corresponds to keeping
none of the corresponding kind of jobs after they finish.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1058efa4d70f13c015e6a2094ff85068>9.2 - Coarse Parallel Processing Using a Work Queue</h1><p>In this example, we will run a Kubernetes Job with multiple parallel
worker processes.</p><p>In this example, as each pod is created, it picks up one unit of work
from a task queue, completes it, deletes it from the queue, and exits.</p><p>Here is an overview of the steps in this example:</p><ol><li><strong>Start a message queue service.</strong> In this example, we use RabbitMQ, but you could use another
one. In practice you would set up a message queue service once and reuse it for many jobs.</li><li><strong>Create a queue, and fill it with messages.</strong> Each message represents one task to be done. In
this example, a message is an integer that we will do a lengthy computation on.</li><li><strong>Start a Job that works on tasks from the queue</strong>. The Job starts several pods. Each pod takes
one task from the message queue, processes it, and repeats until the end of the queue is reached.</li></ol><h2 id=before-you-begin>Before you begin</h2><p>Be familiar with the basic,
non-parallel, use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=starting-a-message-queue-service>Starting a message queue service</h2><p>This example uses RabbitMQ, however, you can adapt the example to use another AMQP-type message service.</p><p>In practice you could set up a message queue service once in a
cluster and reuse it for many jobs, as well as for long-running services.</p><p>Start RabbitMQ as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://raw.githubusercontent.com/kubernetes/kubernetes/release-1.3/examples/celery-rabbitmq/rabbitmq-service.yaml
</span></span></code></pre></div><pre tabindex=0><code>service &#34;rabbitmq-service&#34; created
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://raw.githubusercontent.com/kubernetes/kubernetes/release-1.3/examples/celery-rabbitmq/rabbitmq-controller.yaml
</span></span></code></pre></div><pre tabindex=0><code>replicationcontroller &#34;rabbitmq-controller&#34; created
</code></pre><p>We will only use the rabbitmq part from the <a href=https://github.com/kubernetes/kubernetes/tree/release-1.3/examples/celery-rabbitmq>celery-rabbitmq example</a>.</p><h2 id=testing-the-message-queue-service>Testing the message queue service</h2><p>Now, we can experiment with accessing the message queue. We will
create a temporary interactive pod, install some tools on it,
and experiment with queues.</p><p>First create a temporary interactive Pod.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a temporary interactive container</span>
</span></span><span style=display:flex><span>kubectl run -i --tty temp --image ubuntu:18.04
</span></span></code></pre></div><pre tabindex=0><code>Waiting for pod default/temp-loe07 to be running, status is Pending, pod ready: false
... [ previous line repeats several times .. hit return when it stops ] ...
</code></pre><p>Note that your pod name and command prompt will be different.</p><p>Next install the <code>amqp-tools</code> so we can work with message queues.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Install some tools</span>
</span></span><span style=display:flex><span>root@temp-loe07:/# apt-get update
</span></span><span style=display:flex><span>.... <span style=color:#666>[</span> lots of output <span style=color:#666>]</span> ....
</span></span><span style=display:flex><span>root@temp-loe07:/# apt-get install -y curl ca-certificates amqp-tools python dnsutils
</span></span><span style=display:flex><span>.... <span style=color:#666>[</span> lots of output <span style=color:#666>]</span> ....
</span></span></code></pre></div><p>Later, we will make a docker image that includes these packages.</p><p>Next, we will check that we can discover the rabbitmq service:</p><pre tabindex=0><code># Note the rabbitmq-service has a DNS name, provided by Kubernetes:

root@temp-loe07:/# nslookup rabbitmq-service
Server:        10.0.0.10
Address:    10.0.0.10#53

Name:    rabbitmq-service.default.svc.cluster.local
Address: 10.0.147.152

# Your address will vary.
</code></pre><p>If Kube-DNS is not set up correctly, the previous step may not work for you.
You can also find the service IP in an env var:</p><pre tabindex=0><code># env | grep RABBIT | grep HOST
RABBITMQ_SERVICE_SERVICE_HOST=10.0.147.152
# Your address will vary.
</code></pre><p>Next we will verify we can create a queue, and publish and consume messages.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># In the next line, rabbitmq-service is the hostname where the rabbitmq-service</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># can be reached.  5672 is the standard port for rabbitmq.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@temp-loe07:/# <span style=color:#a2f>export</span> <span style=color:#b8860b>BROKER_URL</span><span style=color:#666>=</span>amqp://guest:guest@rabbitmq-service:5672
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># If you could not resolve &#34;rabbitmq-service&#34; in the previous step,</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># then use this command instead:</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># root@temp-loe07:/# BROKER_URL=amqp://guest:guest@$RABBITMQ_SERVICE_SERVICE_HOST:5672</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Now create a queue:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@temp-loe07:/# /usr/bin/amqp-declare-queue --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -q foo -d
</span></span><span style=display:flex><span>foo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Publish one message to it:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@temp-loe07:/# /usr/bin/amqp-publish --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -r foo -p -b Hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># And get it back.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@temp-loe07:/# /usr/bin/amqp-consume --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -q foo -c <span style=color:#666>1</span> cat <span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span>
</span></span><span style=display:flex><span>Hello
</span></span><span style=display:flex><span>root@temp-loe07:/#
</span></span></code></pre></div><p>In the last command, the <code>amqp-consume</code> tool takes one message (<code>-c 1</code>)
from the queue, and passes that message to the standard input of an arbitrary command. In this case, the program <code>cat</code> prints out the characters read from standard input, and the echo adds a carriage
return so the example is readable.</p><h2 id=filling-the-queue-with-tasks>Filling the Queue with tasks</h2><p>Now let's fill the queue with some "tasks". In our example, our tasks are strings to be
printed.</p><p>In a practice, the content of the messages might be:</p><ul><li>names of files to that need to be processed</li><li>extra flags to the program</li><li>ranges of keys in a database table</li><li>configuration parameters to a simulation</li><li>frame numbers of a scene to be rendered</li></ul><p>In practice, if there is large data that is needed in a read-only mode by all pods
of the Job, you will typically put that in a shared file system like NFS and mount
that readonly on all the pods, or the program in the pod will natively read data from
a cluster file system like HDFS.</p><p>For our example, we will create the queue and fill it using the amqp command line tools.
In practice, you might write a program to fill the queue using an amqp client library.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/bin/amqp-declare-queue --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -q job1  -d
</span></span><span style=display:flex><span>job1
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> f in apple banana cherry date fig grape lemon melon
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>  /usr/bin/amqp-publish --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -r job1 -p -b <span style=color:#b8860b>$f</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>So, we filled the queue with 8 messages.</p><h2 id=create-an-image>Create an Image</h2><p>Now we are ready to create an image that we will run as a job.</p><p>We will use the <code>amqp-consume</code> utility to read the message
from the queue and run our actual program. Here is a very simple
example program:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/rabbitmq/worker.py download=application/job/rabbitmq/worker.py><code>application/job/rabbitmq/worker.py</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-rabbitmq-worker-py")' title="Copy application/job/rabbitmq/worker.py to clipboard"></img></div><div class=includecode id=application-job-rabbitmq-worker-py><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#080;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Just prints standard out and sleeps for 10 seconds.</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>sys</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>time</span>
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Processing &#34;</span> <span style=color:#666>+</span> sys<span style=color:#666>.</span>stdin<span style=color:#666>.</span>readlines()[<span style=color:#666>0</span>])
</span></span><span style=display:flex><span>time<span style=color:#666>.</span>sleep(<span style=color:#666>10</span>)
</span></span></code></pre></div></div></div><p>Give the script execution permission:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chmod +x worker.py
</span></span></code></pre></div><p>Now, build an image. If you are working in the source
tree, then change directory to <code>examples/job/work-queue-1</code>.
Otherwise, make a temporary directory, change to it,
download the <a href=/examples/application/job/rabbitmq/Dockerfile>Dockerfile</a>,
and <a href=/examples/application/job/rabbitmq/worker.py>worker.py</a>. In either case,
build the image with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build -t job-wq-1 .
</span></span></code></pre></div><p>For the <a href=https://hub.docker.com/>Docker Hub</a>, tag your app image with
your username and push to the Hub with the below commands. Replace
<code>&lt;username></code> with your Hub username.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag job-wq-1 &lt;username&gt;/job-wq-1
</span></span><span style=display:flex><span>docker push &lt;username&gt;/job-wq-1
</span></span></code></pre></div><p>If you are using <a href=https://cloud.google.com/tools/container-registry/>Google Container
Registry</a>, tag
your app image with your project ID, and push to GCR. Replace
<code>&lt;project></code> with your project ID.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag job-wq-1 gcr.io/&lt;project&gt;/job-wq-1
</span></span><span style=display:flex><span>gcloud docker -- push gcr.io/&lt;project&gt;/job-wq-1
</span></span></code></pre></div><h2 id=defining-a-job>Defining a Job</h2><p>Here is a job definition. You'll need to make a copy of the Job and edit the
image to match the name you used, and call it <code>./job.yaml</code>.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/rabbitmq/job.yaml download=application/job/rabbitmq/job.yaml><code>application/job/rabbitmq/job.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-rabbitmq-job-yaml")' title="Copy application/job/rabbitmq/job.yaml to clipboard"></img></div><div class=includecode id=application-job-rabbitmq-job-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-wq-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>8</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-wq-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/&lt;project&gt;/job-wq-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>BROKER_URL<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>amqp://guest:guest@rabbitmq-service:5672<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>QUEUE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>job1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In this example, each pod works on one item from the queue and then exits.
So, the completion count of the Job corresponds to the number of work items
done. So we set, <code>.spec.completions: 8</code> for the example, since we put 8 items in the queue.</p><h2 id=running-the-job>Running the Job</h2><p>So, now run the Job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f ./job.yaml
</span></span></code></pre></div><p>You can wait for the Job to succeed, with a timeout:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># The check for condition name is case insensitive</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a2f>wait</span> --for<span style=color:#666>=</span><span style=color:#b8860b>condition</span><span style=color:#666>=</span><span style=color:#a2f>complete</span> --timeout<span style=color:#666>=</span>300s job/job-wq-1
</span></span></code></pre></div><p>Next, check on the Job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe jobs/job-wq-1
</span></span></code></pre></div><pre tabindex=0><code>Name:             job-wq-1
Namespace:        default
Selector:         controller-uid=41d75705-92df-11e7-b85e-fa163ee3c11f
Labels:           controller-uid=41d75705-92df-11e7-b85e-fa163ee3c11f
                  job-name=job-wq-1
Annotations:      &lt;none&gt;
Parallelism:      2
Completions:      8
Start Time:       Wed, 06 Sep 2017 16:42:02 +0800
Pods Statuses:    0 Running / 8 Succeeded / 0 Failed
Pod Template:
  Labels:       controller-uid=41d75705-92df-11e7-b85e-fa163ee3c11f
                job-name=job-wq-1
  Containers:
   c:
    Image:      gcr.io/causal-jigsaw-637/job-wq-1
    Port:
    Environment:
      BROKER_URL:       amqp://guest:guest@rabbitmq-service:5672
      QUEUE:            job1
    Mounts:             &lt;none&gt;
  Volumes:              &lt;none&gt;
Events:
  FirstSeen  LastSeen   Count    From    SubobjectPath    Type      Reason              Message
  ─────────  ────────   ─────    ────    ─────────────    ──────    ──────              ───────
  27s        27s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-hcobb
  27s        27s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-weytj
  27s        27s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-qaam5
  27s        27s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-b67sr
  26s        26s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-xe5hj
  15s        15s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-w2zqe
  14s        14s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-d6ppa
  14s        14s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-p17e0
</code></pre><p>All the pods for that Job succeeded. Yay.</p><h2 id=alternatives>Alternatives</h2><p>This approach has the advantage that you
do not need to modify your "worker" program to be aware that there is a work queue.</p><p>It does require that you run a message queue service.
If running a queue service is inconvenient, you may
want to consider one of the other <a href=/docs/concepts/workloads/controllers/job/#job-patterns>job patterns</a>.</p><p>This approach creates a pod for every work item. If your work items only take a few seconds,
though, creating a Pod for every work item may add a lot of overhead. Consider another
<a href=/docs/tasks/job/fine-parallel-processing-work-queue/>example</a>, that executes multiple work items per Pod.</p><p>In this example, we use the <code>amqp-consume</code> utility to read the message
from the queue and run our actual program. This has the advantage that you
do not need to modify your program to be aware of the queue.
A <a href=/docs/tasks/job/fine-parallel-processing-work-queue/>different example</a>, shows how to
communicate with the work queue using a client library.</p><h2 id=caveats>Caveats</h2><p>If the number of completions is set to less than the number of items in the queue, then
not all items will be processed.</p><p>If the number of completions is set to more than the number of items in the queue,
then the Job will not appear to be completed, even though all items in the queue
have been processed. It will start additional pods which will block waiting
for a message.</p><p>There is an unlikely race with this pattern. If the container is killed in between the time
that the message is acknowledged by the amqp-consume command and the time that the container
exits with success, or if the node crashes before the kubelet is able to post the success of the pod
back to the api-server, then the Job will not appear to be complete, even though all items
in the queue have been processed.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-457c9dd93aed2b05615ed28dc38075d3>9.3 - Fine Parallel Processing Using a Work Queue</h1><p>In this example, we will run a Kubernetes Job with multiple parallel
worker processes in a given pod.</p><p>In this example, as each pod is created, it picks up one unit of work
from a task queue, processes it, and repeats until the end of the queue is reached.</p><p>Here is an overview of the steps in this example:</p><ol><li><strong>Start a storage service to hold the work queue.</strong> In this example, we use Redis to store
our work items. In the previous example, we used RabbitMQ. In this example, we use Redis and
a custom work-queue client library because AMQP does not provide a good way for clients to
detect when a finite-length work queue is empty. In practice you would set up a store such
as Redis once and reuse it for the work queues of many jobs, and other things.</li><li><strong>Create a queue, and fill it with messages.</strong> Each message represents one task to be done. In
this example, a message is an integer that we will do a lengthy computation on.</li><li><strong>Start a Job that works on tasks from the queue</strong>. The Job starts several pods. Each pod takes
one task from the message queue, processes it, and repeats until the end of the queue is reached.</li></ol><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>Be familiar with the basic,
non-parallel, use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><h2 id=starting-redis>Starting Redis</h2><p>For this example, for simplicity, we will start a single instance of Redis.
See the <a href=https://github.com/kubernetes/examples/tree/master/guestbook>Redis Example</a> for an example
of deploying Redis scalably and redundantly.</p><p>You could also download the following files directly:</p><ul><li><a href=/examples/application/job/redis/redis-pod.yaml><code>redis-pod.yaml</code></a></li><li><a href=/examples/application/job/redis/redis-service.yaml><code>redis-service.yaml</code></a></li><li><a href=/examples/application/job/redis/Dockerfile><code>Dockerfile</code></a></li><li><a href=/examples/application/job/redis/job.yaml><code>job.yaml</code></a></li><li><a href=/examples/application/job/redis/rediswq.py><code>rediswq.py</code></a></li><li><a href=/examples/application/job/redis/worker.py><code>worker.py</code></a></li></ul><h2 id=filling-the-queue-with-tasks>Filling the Queue with tasks</h2><p>Now let's fill the queue with some "tasks". In our example, our tasks are strings to be
printed.</p><p>Start a temporary interactive pod for running the Redis CLI.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run -i --tty temp --image redis --command <span style=color:#b44>&#34;/bin/sh&#34;</span>
</span></span><span style=display:flex><span>Waiting <span style=color:#a2f;font-weight:700>for</span> pod default/redis2-c7h78 to be running, status is Pending, pod ready: <span style=color:#a2f>false</span>
</span></span><span style=display:flex><span>Hit enter <span style=color:#a2f;font-weight:700>for</span> <span style=color:#a2f>command</span> prompt
</span></span></code></pre></div><p>Now hit enter, start the redis CLI, and create a list with some work items in it.</p><pre tabindex=0><code># redis-cli -h redis
redis:6379&gt; rpush job2 &#34;apple&#34;
(integer) 1
redis:6379&gt; rpush job2 &#34;banana&#34;
(integer) 2
redis:6379&gt; rpush job2 &#34;cherry&#34;
(integer) 3
redis:6379&gt; rpush job2 &#34;date&#34;
(integer) 4
redis:6379&gt; rpush job2 &#34;fig&#34;
(integer) 5
redis:6379&gt; rpush job2 &#34;grape&#34;
(integer) 6
redis:6379&gt; rpush job2 &#34;lemon&#34;
(integer) 7
redis:6379&gt; rpush job2 &#34;melon&#34;
(integer) 8
redis:6379&gt; rpush job2 &#34;orange&#34;
(integer) 9
redis:6379&gt; lrange job2 0 -1
1) &#34;apple&#34;
2) &#34;banana&#34;
3) &#34;cherry&#34;
4) &#34;date&#34;
5) &#34;fig&#34;
6) &#34;grape&#34;
7) &#34;lemon&#34;
8) &#34;melon&#34;
9) &#34;orange&#34;
</code></pre><p>So, the list with key <code>job2</code> will be our work queue.</p><p>Note: if you do not have Kube DNS setup correctly, you may need to change
the first step of the above block to <code>redis-cli -h $REDIS_SERVICE_HOST</code>.</p><h2 id=create-an-image>Create an Image</h2><p>Now we are ready to create an image that we will run.</p><p>We will use a python worker program with a redis client to read
the messages from the message queue.</p><p>A simple Redis work queue client library is provided,
called rediswq.py (<a href=/examples/application/job/redis/rediswq.py>Download</a>).</p><p>The "worker" program in each Pod of the Job uses the work queue
client library to get work. Here it is:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/redis/worker.py download=application/job/redis/worker.py><code>application/job/redis/worker.py</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-redis-worker-py")' title="Copy application/job/redis/worker.py to clipboard"></img></div><div class=includecode id=application-job-redis-worker-py><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#080;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>time</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>rediswq</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>host<span style=color:#666>=</span><span style=color:#b44>&#34;redis&#34;</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Uncomment next two lines if you do not have Kube-DNS working.</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># import os</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># host = os.getenv(&#34;REDIS_SERVICE_HOST&#34;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>q <span style=color:#666>=</span> rediswq<span style=color:#666>.</span>RedisWQ(name<span style=color:#666>=</span><span style=color:#b44>&#34;job2&#34;</span>, host<span style=color:#666>=</span>host)
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Worker with sessionID: &#34;</span> <span style=color:#666>+</span>  q<span style=color:#666>.</span>sessionID())
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Initial queue state: empty=&#34;</span> <span style=color:#666>+</span> <span style=color:#a2f>str</span>(q<span style=color:#666>.</span>empty()))
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>while</span> <span style=color:#a2f;font-weight:700>not</span> q<span style=color:#666>.</span>empty():
</span></span><span style=display:flex><span>  item <span style=color:#666>=</span> q<span style=color:#666>.</span>lease(lease_secs<span style=color:#666>=</span><span style=color:#666>10</span>, block<span style=color:#666>=</span><span style=color:#a2f;font-weight:700>True</span>, timeout<span style=color:#666>=</span><span style=color:#666>2</span>) 
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span> item <span style=color:#a2f;font-weight:700>is</span> <span style=color:#a2f;font-weight:700>not</span> <span style=color:#a2f;font-weight:700>None</span>:
</span></span><span style=display:flex><span>    itemstr <span style=color:#666>=</span> item<span style=color:#666>.</span>decode(<span style=color:#b44>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Working on &#34;</span> <span style=color:#666>+</span> itemstr)
</span></span><span style=display:flex><span>    time<span style=color:#666>.</span>sleep(<span style=color:#666>10</span>) <span style=color:#080;font-style:italic># Put your actual work here instead of sleep.</span>
</span></span><span style=display:flex><span>    q<span style=color:#666>.</span>complete(item)
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>else</span>:
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Waiting for work&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Queue empty, exiting&#34;</span>)
</span></span></code></pre></div></div></div><p>You could also download <a href=/examples/application/job/redis/worker.py><code>worker.py</code></a>,
<a href=/examples/application/job/redis/rediswq.py><code>rediswq.py</code></a>, and
<a href=/examples/application/job/redis/Dockerfile><code>Dockerfile</code></a> files, then build
the image:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build -t job-wq-2 .
</span></span></code></pre></div><h3 id=push-the-image>Push the image</h3><p>For the <a href=https://hub.docker.com/>Docker Hub</a>, tag your app image with
your username and push to the Hub with the below commands. Replace
<code>&lt;username></code> with your Hub username.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag job-wq-2 &lt;username&gt;/job-wq-2
</span></span><span style=display:flex><span>docker push &lt;username&gt;/job-wq-2
</span></span></code></pre></div><p>You need to push to a public repository or <a href=/docs/concepts/containers/images/>configure your cluster to be able to access
your private repository</a>.</p><p>If you are using <a href=https://cloud.google.com/tools/container-registry/>Google Container
Registry</a>, tag
your app image with your project ID, and push to GCR. Replace
<code>&lt;project></code> with your project ID.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag job-wq-2 gcr.io/&lt;project&gt;/job-wq-2
</span></span><span style=display:flex><span>gcloud docker -- push gcr.io/&lt;project&gt;/job-wq-2
</span></span></code></pre></div><h2 id=defining-a-job>Defining a Job</h2><p>Here is the job definition:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/redis/job.yaml download=application/job/redis/job.yaml><code>application/job/redis/job.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-redis-job-yaml")' title="Copy application/job/redis/job.yaml to clipboard"></img></div><div class=includecode id=application-job-redis-job-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-wq-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-wq-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/myproject/job-wq-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Be sure to edit the job template to
change <code>gcr.io/myproject</code> to your own path.</p><p>In this example, each pod works on several items from the queue and then exits when there are no more items.
Since the workers themselves detect when the workqueue is empty, and the Job controller does not
know about the workqueue, it relies on the workers to signal when they are done working.
The workers signal that the queue is empty by exiting with success. So, as soon as any worker
exits with success, the controller knows the work is done, and the Pods will exit soon.
So, we set the completion count of the Job to 1. The job controller will wait for the other pods to complete
too.</p><h2 id=running-the-job>Running the Job</h2><p>So, now run the Job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f ./job.yaml
</span></span></code></pre></div><p>Now wait a bit, then check on the job.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe jobs/job-wq-2
</span></span><span style=display:flex><span>Name:             job-wq-2
</span></span><span style=display:flex><span>Namespace:        default
</span></span><span style=display:flex><span>Selector:         controller-uid<span style=color:#666>=</span>b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
</span></span><span style=display:flex><span>Labels:           controller-uid<span style=color:#666>=</span>b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
</span></span><span style=display:flex><span>                  job-name<span style=color:#666>=</span>job-wq-2
</span></span><span style=display:flex><span>Annotations:      &lt;none&gt;
</span></span><span style=display:flex><span>Parallelism:      <span style=color:#666>2</span>
</span></span><span style=display:flex><span>Completions:      &lt;unset&gt;
</span></span><span style=display:flex><span>Start Time:       Mon, <span style=color:#666>11</span> Jan <span style=color:#666>2016</span> 17:07:59 -0800
</span></span><span style=display:flex><span>Pods Statuses:    <span style=color:#666>1</span> Running / <span style=color:#666>0</span> Succeeded / <span style=color:#666>0</span> Failed
</span></span><span style=display:flex><span>Pod Template:
</span></span><span style=display:flex><span>  Labels:       controller-uid<span style=color:#666>=</span>b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
</span></span><span style=display:flex><span>                job-name<span style=color:#666>=</span>job-wq-2
</span></span><span style=display:flex><span>  Containers:
</span></span><span style=display:flex><span>   c:
</span></span><span style=display:flex><span>    Image:              gcr.io/exampleproject/job-wq-2
</span></span><span style=display:flex><span>    Port:
</span></span><span style=display:flex><span>    Environment:        &lt;none&gt;
</span></span><span style=display:flex><span>    Mounts:             &lt;none&gt;
</span></span><span style=display:flex><span>  Volumes:              &lt;none&gt;
</span></span><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  FirstSeen    LastSeen    Count    From            SubobjectPath    Type        Reason            Message
</span></span><span style=display:flex><span>  ---------    --------    -----    ----            -------------    --------    ------            -------
</span></span><span style=display:flex><span>  33s          33s         <span style=color:#666>1</span>        <span style=color:#666>{</span>job-controller <span style=color:#666>}</span>                Normal      SuccessfulCreate  Created pod: job-wq-2-lglf8
</span></span></code></pre></div><p>You can wait for the Job to succeed, with a timeout:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># The check for condition name is case insensitive</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a2f>wait</span> --for<span style=color:#666>=</span><span style=color:#b8860b>condition</span><span style=color:#666>=</span><span style=color:#a2f>complete</span> --timeout<span style=color:#666>=</span>300s job/job-wq-2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs pods/job-wq-2-7r7b2
</span></span></code></pre></div><pre tabindex=0><code>Worker with sessionID: bbd72d0a-9e5c-4dd6-abf6-416cc267991f
Initial queue state: empty=False
Working on banana
Working on date
Working on lemon
</code></pre><p>As you can see, one of our pods worked on several work units.</p><h2 id=alternatives>Alternatives</h2><p>If running a queue service or modifying your containers to use a work queue is inconvenient, you may
want to consider one of the other
<a href=/docs/concepts/workloads/controllers/job/#job-patterns>job patterns</a>.</p><p>If you have a continuous stream of background processing work to run, then
consider running your background workers with a <code>ReplicaSet</code> instead,
and consider running a background processing library such as
<a href=https://github.com/resque/resque>https://github.com/resque/resque</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9e63850014876afaebd1561f70bb8f6b>9.4 - Indexed Job for Parallel Processing with Static Work Assignment</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.24 [stable]</code></div><p>In this example, you will run a Kubernetes Job that uses multiple parallel
worker processes.
Each worker is a different container running in its own Pod. The Pods have an
<em>index number</em> that the control plane sets automatically, which allows each Pod
to identify which part of the overall task to work on.</p><p>The pod index is available in the <a class=glossary-tooltip title='A key-value pair that is used to attach arbitrary non-identifying metadata to objects.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/annotations target=_blank aria-label=annotation>annotation</a>
<code>batch.kubernetes.io/job-completion-index</code> as a string representing its
decimal value. In order for the containerized task process to obtain this index,
you can publish the value of the annotation using the <a href=/docs/concepts/workloads/pods/downward-api/>downward API</a>
mechanism.
For convenience, the control plane automatically sets the downward API to
expose the index in the <code>JOB_COMPLETION_INDEX</code> environment variable.</p><p>Here is an overview of the steps in this example:</p><ol><li><strong>Define a Job manifest using indexed completion</strong>.
The downward API allows you to pass the pod index annotation as an
environment variable or file to the container.</li><li><strong>Start an <code>Indexed</code> Job based on that manifest</strong>.</li></ol><h2 id=before-you-begin>Before you begin</h2><p>You should already be familiar with the basic,
non-parallel, use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.21.
To check the version, enter <code>kubectl version</code>.</p><h2 id=choose-an-approach>Choose an approach</h2><p>To access the work item from the worker program, you have a few options:</p><ol><li>Read the <code>JOB_COMPLETION_INDEX</code> environment variable. The Job
<a class=glossary-tooltip title='A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/controller/ target=_blank aria-label=controller>controller</a>
automatically links this variable to the annotation containing the completion
index.</li><li>Read a file that contains the completion index.</li><li>Assuming that you can't modify the program, you can wrap it with a script
that reads the index using any of the methods above and converts it into
something that the program can use as input.</li></ol><p>For this example, imagine that you chose option 3 and you want to run the
<a href=https://man7.org/linux/man-pages/man1/rev.1.html>rev</a> utility. This
program accepts a file as an argument and prints its content reversed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rev data.txt
</span></span></code></pre></div><p>You'll use the <code>rev</code> tool from the
<a href=https://hub.docker.com/_/busybox><code>busybox</code></a> container image.</p><p>As this is only an example, each Pod only does a tiny piece of work (reversing a short
string). In a real workload you might, for example, create a Job that represents
the
task of producing 60 seconds of video based on scene data.
Each work item in the video rendering Job would be to render a particular
frame of that video clip. Indexed completion would mean that each Pod in
the Job knows which frame to render and publish, by counting frames from
the start of the clip.</p><h2 id=define-an-indexed-job>Define an Indexed Job</h2><p>Here is a sample Job manifest that uses <code>Indexed</code> completion mode:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/indexed-job.yaml download=application/job/indexed-job.yaml><code>application/job/indexed-job.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-indexed-job-yaml")' title="Copy application/job/indexed-job.yaml to clipboard"></img></div><div class=includecode id=application-job-indexed-job-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;indexed-job&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completionMode</span>:<span style=color:#bbb> </span>Indexed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initContainers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;input&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;docker.io/library/bash&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;bash&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;-c&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          items=(foo bar baz qux xyz)
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          echo ${items[$JOB_COMPLETION_INDEX]} &gt; /input/data.txt</span><span style=color:#bbb>          
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;worker&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;docker.io/library/busybox&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;rev&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;/input/data.txt&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the example above, you use the builtin <code>JOB_COMPLETION_INDEX</code> environment
variable set by the Job controller for all containers. An <a href=/docs/concepts/workloads/pods/init-containers/>init container</a>
maps the index to a static value and writes it to a file that is shared with the
container running the worker through an <a href=/docs/concepts/storage/volumes/#emptydir>emptyDir volume</a>.
Optionally, you can <a href=/docs/tasks/inject-data-application/environment-variable-expose-pod-information/>define your own environment variable through the downward
API</a>
to publish the index to containers. You can also choose to load a list of values
from a <a href=/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMap as an environment variable or file</a>.</p><p>Alternatively, you can directly <a href=/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#store-pod-fields>use the downward API to pass the annotation
value as a volume file</a>,
like shown in the following example:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/indexed-job-vol.yaml download=application/job/indexed-job-vol.yaml><code>application/job/indexed-job-vol.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-indexed-job-vol-yaml")' title="Copy application/job/indexed-job-vol.yaml to clipboard"></img></div><div class=includecode id=application-job-indexed-job-vol-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;indexed-job&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completionMode</span>:<span style=color:#bbb> </span>Indexed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;worker&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;docker.io/library/busybox&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;rev&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;/input/data.txt&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>downwardAPI</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;data.txt&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>metadata.annotations[&#39;batch.kubernetes.io/job-completion-index&#39;]</span></span></code></pre></div></div></div><h2 id=running-the-job>Running the Job</h2><p>Now run the Job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># This uses the first approach (relying on $JOB_COMPLETION_INDEX)</span>
</span></span><span style=display:flex><span>kubectl apply -f https://kubernetes.io/examples/application/job/indexed-job.yaml
</span></span></code></pre></div><p>When you create this Job, the control plane creates a series of Pods, one for each index you specified. The value of <code>.spec.parallelism</code> determines how many can run at once whereas <code>.spec.completions</code> determines how many Pods the Job creates in total.</p><p>Because <code>.spec.parallelism</code> is less than <code>.spec.completions</code>, the control plane waits for some of the first Pods to complete before starting more of them.</p><p>You can wait for the Job to succeed, with a timeout:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># The check for condition name is case insensitive</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a2f>wait</span> --for<span style=color:#666>=</span><span style=color:#b8860b>condition</span><span style=color:#666>=</span><span style=color:#a2f>complete</span> --timeout<span style=color:#666>=</span>300s job/indexed-job
</span></span></code></pre></div><p>Now, describe the Job and check that it was successful.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe jobs/indexed-job
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>Name:              indexed-job
Namespace:         default
Selector:          controller-uid=bf865e04-0b67-483b-9a90-74cfc4c3e756
Labels:            controller-uid=bf865e04-0b67-483b-9a90-74cfc4c3e756
                   job-name=indexed-job
Annotations:       &lt;none&gt;
Parallelism:       3
Completions:       5
Start Time:        Thu, 11 Mar 2021 15:47:34 +0000
Pods Statuses:     2 Running / 3 Succeeded / 0 Failed
Completed Indexes: 0-2
Pod Template:
  Labels:  controller-uid=bf865e04-0b67-483b-9a90-74cfc4c3e756
           job-name=indexed-job
  Init Containers:
   input:
    Image:      docker.io/library/bash
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Command:
      bash
      -c
      items=(foo bar baz qux xyz)
      echo ${items[$JOB_COMPLETION_INDEX]} &gt; /input/data.txt

    Environment:  &lt;none&gt;
    Mounts:
      /input from input (rw)
  Containers:
   worker:
    Image:      docker.io/library/busybox
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Command:
      rev
      /input/data.txt
    Environment:  &lt;none&gt;
    Mounts:
      /input from input (rw)
  Volumes:
   input:
    Type:       EmptyDir (a temporary directory that shares a pod&#39;s lifetime)
    Medium:
    SizeLimit:  &lt;unset&gt;
Events:
  Type    Reason            Age   From            Message
  ----    ------            ----  ----            -------
  Normal  SuccessfulCreate  4s    job-controller  Created pod: indexed-job-njkjj
  Normal  SuccessfulCreate  4s    job-controller  Created pod: indexed-job-9kd4h
  Normal  SuccessfulCreate  4s    job-controller  Created pod: indexed-job-qjwsz
  Normal  SuccessfulCreate  1s    job-controller  Created pod: indexed-job-fdhq5
  Normal  SuccessfulCreate  1s    job-controller  Created pod: indexed-job-ncslj
</code></pre><p>In this example, you run the Job with custom values for each index. You can
inspect the output of one of the pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs indexed-job-fdhq5 <span style=color:#080;font-style:italic># Change this to match the name of a Pod from that Job</span>
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>xuq
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-d65c40e1d2df81b94a09634c2432b055>9.5 - Job with Pod-to-Pod Communication</h1><p>In this example, you will run a Job in <a href=/blog/2021/04/19/introducing-indexed-jobs/>Indexed completion mode</a> configured such that
the pods created by the Job can communicate with each other using pod hostnames rather than pod IP addresses.</p><p>Pods within a Job might need to communicate among themselves. The user workload running in each pod could query the Kubernetes API server
to learn the IPs of the other Pods, but it's much simpler to rely on Kubernetes' built-in DNS resolution.</p><p>Jobs in Indexed completion mode automatically set the pods' hostname to be in the format of
<code>${jobName}-${completionIndex}</code>. You can use this format to deterministically build
pod hostnames and enable pod communication <em>without</em> needing to create a client connection to
the Kubernetes control plane to obtain pod hostnames/IPs via API requests.</p><p>This configuration is useful
for use cases where pod networking is required but you don't want to depend on a network
connection with the Kubernetes API server.</p><h2 id=before-you-begin>Before you begin</h2><p>You should already be familiar with the basic use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.21.
To check the version, enter <code>kubectl version</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you are using MiniKube or a similar tool, you may need to take
<a href=https://minikube.sigs.k8s.io/docs/handbook/addons/ingress-dns/>extra steps</a>
to ensure you have DNS.</div><h2 id=starting-a-job-with-pod-to-pod-communication>Starting a Job with Pod-to-Pod Communication</h2><p>To enable pod-to-pod communication using pod hostnames in a Job, you must do the following:</p><ol><li><p>Set up a <a href=/docs/concepts/services-networking/service/#headless-services>headless service</a>
with a valid label selector for the pods created by your Job. The headless service must be in the same namespace as
the Job. One easy way to do this is to use the <code>job-name: &lt;your-job-name></code> selector, since the <code>job-name</code> label will be automatically added by Kubernetes. This configuration will trigger the DNS system to create records of the hostnames of
the pods running your Job.</p></li><li><p>Configure the headless service as subdomain service for the Job pods by including the following value in your Job template spec:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>subdomain</span>:<span style=color:#bbb> </span>&lt;headless-svc-name&gt;<span style=color:#bbb>
</span></span></span></code></pre></div></li></ol><h3 id=example>Example</h3><p>Below is a working example of a Job with pod-to-pod communication via pod hostnames enabled.
The Job is completed only after all pods successfully ping each other using hostnames.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In the Bash script executed on each pod in the example below, the pod hostnames can be prefixed
by the namespace as well if the pod needs to be reached from outside the namespace.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>headless-svc<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIP</span>:<span style=color:#bbb> </span>None<span style=color:#bbb> </span><span style=color:#080;font-style:italic># clusterIP must be None to create a headless service</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>job-name</span>:<span style=color:#bbb> </span>example-job<span style=color:#bbb> </span><span style=color:#080;font-style:italic># must match Job name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completionMode</span>:<span style=color:#bbb> </span>Indexed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>subdomain</span>:<span style=color:#bbb> </span>headless-svc<span style=color:#bbb> </span><span style=color:#080;font-style:italic># has to match Service name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-workload<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>bash:latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- bash<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          for i in 0 1 2
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          do
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            gotStatus=&#34;-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            wantStatus=&#34;0&#34;             
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            while [ $gotStatus -ne $wantStatus ]
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            do                                       
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>              ping -c 1 example-job-${i}.headless-svc &gt; /dev/null 2&gt;&amp;1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>              gotStatus=$?                
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>              if [ $gotStatus -ne $wantStatus ]; then
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                echo &#34;Failed to ping pod example-job-${i}.headless-svc, retrying in 1 second...&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                sleep 1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>              fi
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            done                                                         
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            echo &#34;Successfully pinged pod: example-job-${i}.headless-svc&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          done</span><span style=color:#bbb>          
</span></span></span></code></pre></div><p>After applying the example above, reach each other over the network
using: <code>&lt;pod-hostname>.&lt;headless-service-name></code>. You should see output similar to the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs example-job-0-qws42
</span></span></code></pre></div><pre tabindex=0><code>Failed to ping pod example-job-0.headless-svc, retrying in 1 second...
Successfully pinged pod: example-job-0.headless-svc
Successfully pinged pod: example-job-1.headless-svc
Successfully pinged pod: example-job-2.headless-svc
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Keep in mind that the <code>&lt;pod-hostname>.&lt;headless-service-name></code> name format used
in this example would not work with DNS policy set to <code>None</code> or <code>Default</code>.
You can learn more about pod DNS policies <a href=/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy>here</a>.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-da7c2b067953d239eb4457e8978ad8f6>9.6 - Parallel Processing using Expansions</h1><p>This task demonstrates running multiple <a class=glossary-tooltip title='A finite or batch task that runs to completion.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/job/ target=_blank aria-label=Jobs>Jobs</a>
based on a common template. You can use this approach to process batches of work in
parallel.</p><p>For this example there are only three items: <em>apple</em>, <em>banana</em>, and <em>cherry</em>.
The sample Jobs process each item by printing a string then pausing.</p><p>See <a href=#using-jobs-in-real-workloads>using Jobs in real workloads</a> to learn about how
this pattern fits more realistic use cases.</p><h2 id=before-you-begin>Before you begin</h2><p>You should be familiar with the basic,
non-parallel, use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>For basic templating you need the command-line utility <code>sed</code>.</p><p>To follow the advanced templating example, you need a working installation of
<a href=https://www.python.org/>Python</a>, and the Jinja2 template
library for Python.</p><p>Once you have Python set up, you can install Jinja2 by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip install --user jinja2
</span></span></code></pre></div><h2 id=create-jobs-based-on-a-template>Create Jobs based on a template</h2><p>First, download the following template of a Job to a file called <code>job-tmpl.yaml</code>.
Here's what you'll download:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/job-tmpl.yaml download=application/job/job-tmpl.yaml><code>application/job/job-tmpl.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-job-tmpl-yaml")' title="Copy application/job/job-tmpl.yaml to clipboard"></img></div><div class=includecode id=application-job-job-tmpl-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>process-item-$ITEM<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>jobgroup</span>:<span style=color:#bbb> </span>jobexample<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>jobexample<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>jobgroup</span>:<span style=color:#bbb> </span>jobexample<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;echo Processing item $ITEM &amp;&amp; sleep 5&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Use curl to download job-tmpl.yaml</span>
</span></span><span style=display:flex><span>curl -L -s -O https://k8s.io/examples/application/job/job-tmpl.yaml
</span></span></code></pre></div><p>The file you downloaded is not yet a valid Kubernetes
<a class=glossary-tooltip title='A serialized specification of one or more Kubernetes API objects.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-manifest' target=_blank aria-label=manifest>manifest</a>.
Instead that template is a YAML representation of a Job object with some placeholders
that need to be filled in before it can be used. The <code>$ITEM</code> syntax is not meaningful to Kubernetes.</p><h3 id=create-manifests-from-the-template>Create manifests from the template</h3><p>The following shell snippet uses <code>sed</code> to replace the string <code>$ITEM</code> with the loop
variable, writing into a temporary directory named <code>jobs</code>. Run this now:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Expand the template into multiple files, one for each item to be processed.</span>
</span></span><span style=display:flex><span>mkdir ./jobs
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> i in apple banana cherry
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>  cat job-tmpl.yaml | sed <span style=color:#b44>&#34;s/\$ITEM/</span><span style=color:#b8860b>$i</span><span style=color:#b44>/&#34;</span> &gt; ./jobs/job-<span style=color:#b8860b>$i</span>.yaml
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>Check if it worked:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ls jobs/
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>job-apple.yaml
job-banana.yaml
job-cherry.yaml
</code></pre><p>You could use any type of template language (for example: Jinja2; ERB), or
write a program to generate the Job manifests.</p><h3 id=create-jobs-from-the-manifests>Create Jobs from the manifests</h3><p>Next, create all the Jobs with one kubectl command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f ./jobs
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>job.batch/process-item-apple created
job.batch/process-item-banana created
job.batch/process-item-cherry created
</code></pre><p>Now, check on the jobs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get <span style=color:#a2f>jobs</span> -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME                  COMPLETIONS   DURATION   AGE
process-item-apple    1/1           14s        22s
process-item-banana   1/1           12s        21s
process-item-cherry   1/1           12s        20s
</code></pre><p>Using the <code>-l</code> option to kubectl selects only the Jobs that are part
of this group of jobs (there might be other unrelated jobs in the system).</p><p>You can check on the Pods as well using the same
<a class=glossary-tooltip title='Allows users to filter a list of resources based on labels.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/labels/ target=_blank aria-label='label selector'>label selector</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>NAME                        READY     STATUS      RESTARTS   AGE
process-item-apple-kixwv    0/1       Completed   0          4m
process-item-banana-wrsf7   0/1       Completed   0          4m
process-item-cherry-dnfu9   0/1       Completed   0          4m
</code></pre><p>We can use this single command to check on the output of all jobs at once:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs -f -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>Processing item apple
Processing item banana
Processing item cherry
</code></pre><h3 id=cleanup-1>Clean up</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Remove the Jobs you created</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Your cluster automatically cleans up their Pods</span>
</span></span><span style=display:flex><span>kubectl delete job -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><h2 id=use-advanced-template-parameters>Use advanced template parameters</h2><p>In the <a href=#create-jobs-based-on-a-template>first example</a>, each instance of the template had one
parameter, and that parameter was also used in the Job's name. However,
<a href=/docs/concepts/overview/working-with-objects/names/#names>names</a> are restricted
to contain only certain characters.</p><p>This slightly more complex example uses the
<a href=https://palletsprojects.com/p/jinja/>Jinja template language</a> to generate manifests
and then objects from those manifests, with a multiple parameters for each Job.</p><p>For this part of the task, you are going to use a one-line Python script to
convert the template to a set of manifests.</p><p>First, copy and paste the following template of a Job object, into a file called <code>job.yaml.jinja2</code>:</p><pre tabindex=0><code class=language-liquid data-lang=liquid>{% set params = [{ &#34;name&#34;: &#34;apple&#34;, &#34;url&#34;: &#34;http://dbpedia.org/resource/Apple&#34;, },
                  { &#34;name&#34;: &#34;banana&#34;, &#34;url&#34;: &#34;http://dbpedia.org/resource/Banana&#34;, },
                  { &#34;name&#34;: &#34;cherry&#34;, &#34;url&#34;: &#34;http://dbpedia.org/resource/Cherry&#34; }]
%}
{% for p in params %}
{% set name = p[&#34;name&#34;] %}
{% set url = p[&#34;url&#34;] %}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: jobexample-{{ name }}
  labels:
    jobgroup: jobexample
spec:
  template:
    metadata:
      name: jobexample
      labels:
        jobgroup: jobexample
    spec:
      containers:
      - name: c
        image: busybox:1.28
        command: [&#34;sh&#34;, &#34;-c&#34;, &#34;echo Processing URL {{ url }} &amp;&amp; sleep 5&#34;]
      restartPolicy: Never
{% endfor %}
</code></pre><p>The above template defines two parameters for each Job object using a list of
python dicts (lines 1-4). A <code>for</code> loop emits one Job manifest for each
set of parameters (remaining lines).</p><p>This example relies on a feature of YAML. One YAML file can contain multiple
documents (Kubernetes manifests, in this case), separated by <code>---</code> on a line
by itself.
You can pipe the output directly to <code>kubectl</code> to create the Jobs.</p><p>Next, use this one-line Python program to expand the template:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>alias</span> <span style=color:#b8860b>render_template</span><span style=color:#666>=</span><span style=color:#b44>&#39;python -c &#34;from jinja2 import Template; import sys; print(Template(sys.stdin.read()).render());&#34;&#39;</span>
</span></span></code></pre></div><p>Use <code>render_template</code> to convert the parameters and template into a single
YAML file containing Kubernetes manifests:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># This requires the alias you defined earlier</span>
</span></span><span style=display:flex><span>cat job.yaml.jinja2 | render_template &gt; jobs.yaml
</span></span></code></pre></div><p>You can view <code>jobs.yaml</code> to verify that the <code>render_template</code> script worked
correctly.</p><p>Once you are happy that <code>render_template</code> is working how you intend,
you can pipe its output into <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat job.yaml.jinja2 | render_template | kubectl apply -f -
</span></span></code></pre></div><p>Kubernetes accepts and runs the Jobs you created.</p><h3 id=cleanup-2>Clean up</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Remove the Jobs you created</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Your cluster automatically cleans up their Pods</span>
</span></span><span style=display:flex><span>kubectl delete job -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><h2 id=using-jobs-in-real-workloads>Using Jobs in real workloads</h2><p>In a real use case, each Job performs some substantial computation, such as rendering a frame
of a movie, or processing a range of rows in a database. If you were rendering a movie
you would set <code>$ITEM</code> to the frame number. If you were processing rows from a database
table, you would set <code>$ITEM</code> to represent the range of database rows to process.</p><p>In the task, you ran a command to collect the output from Pods by fetching
their logs. In a real use case, each Pod for a Job writes its output to
durable storage before completing. You can use a PersistentVolume for each Job,
or an external storage service. For example, if you are rendering frames for a movie,
use HTTP to <code>PUT</code> the rendered frame data to a URL, using a different URL for each
frame.</p><h2 id=labels-on-jobs-and-pods>Labels on Jobs and Pods</h2><p>After you create a Job, Kubernetes automatically adds additional
<a class=glossary-tooltip title='Tags objects with identifying attributes that are meaningful and relevant to users.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/labels target=_blank aria-label=labels>labels</a> that
distinguish one Job's pods from another Job's pods.</p><p>In this example, each Job and its Pod template have a label:
<code>jobgroup=jobexample</code>.</p><p>Kubernetes itself pays no attention to labels named <code>jobgroup</code>. Setting a label
for all the Jobs you create from a template makes it convenient to operate on all
those Jobs at once.
In the <a href=#create-jobs-based-on-a-template>first example</a> you used a template to
create several Jobs. The template ensures that each Pod also gets the same label, so
you can check on all Pods for these templated Jobs with a single command.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The label key <code>jobgroup</code> is not special or reserved.
You can pick your own labelling scheme.
There are <a href=/docs/concepts/overview/working-with-objects/common-labels/#labels>recommended labels</a>
that you can use if you wish.</div><h2 id=alternatives>Alternatives</h2><p>If you plan to create a large number of Job objects, you may find that:</p><ul><li>Even using labels, managing so many Jobs is cumbersome.</li><li>If you create many Jobs in a batch, you might place high load
on the Kubernetes control plane. Alternatively, the Kubernetes API
server could rate limit you, temporarily rejecting your requests with a 429 status.</li><li>You are limited by a <a class=glossary-tooltip title='Provides constraints that limit aggregate resource consumption per namespace.' data-toggle=tooltip data-placement=top href=/docs/concepts/policy/resource-quotas/ target=_blank aria-label='resource quota'>resource quota</a>
on Jobs: the API server permanently rejects some of your requests
when you create a great deal of work in one batch.</li></ul><p>There are other <a href=/docs/concepts/workloads/controllers/job/#job-patterns>job patterns</a>
that you can use to process large amounts of work without creating very many Job
objects.</p><p>You could also consider writing your own <a href=/docs/concepts/architecture/controller/>controller</a>
to manage Job objects automatically.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ecb5ec00bbce2e57292c6687437beae0>9.7 - Handling retriable and non-retriable pod failures with Pod failure policy</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [alpha]</code></div><p>This document shows you how to use the
<a href=/docs/concepts/workloads/controllers/job#pod-failure-policy>Pod failure policy</a>,
in combination with the default
<a href=/docs/concepts/workloads/controllers/job#pod-backoff-failure-policy>Pod backoff failure policy</a>,
to improve the control over the handling of container- or Pod-level failure
within a <a class=glossary-tooltip title='A finite or batch task that runs to completion.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/job/ target=_blank aria-label=Job>Job</a>.</p><p>The definition of Pod failure policy may help you to:</p><ul><li>better utilize the computational resources by avoiding unnecessary Pod retries.</li><li>avoid Job failures due to Pod disruptions (such <a class=glossary-tooltip title='Preemption logic in Kubernetes helps a pending Pod to find a suitable Node by evicting low priority Pods existing on that Node.' data-toggle=tooltip data-placement=top href=/docs/concepts/scheduling-eviction/pod-priority-preemption/#preemption target=_blank aria-label=preemption>preemption</a>,
<a class=glossary-tooltip title='API-initiated eviction is the process by which you use the Eviction API to create an Eviction object that triggers graceful pod termination.' data-toggle=tooltip data-placement=top href=/docs/concepts/scheduling-eviction/api-eviction/ target=_blank aria-label='API-initiated eviction'>API-initiated eviction</a>
or <a class=glossary-tooltip title='A core object consisting of three required properties: key, value, and effect. Taints prevent the scheduling of pods on nodes or node groups.' data-toggle=tooltip data-placement=top href=/docs/concepts/scheduling-eviction/taint-and-toleration/ target=_blank aria-label=taint>taint</a>-based eviction).</li></ul><h2 id=before-you-begin>Before you begin</h2><p>You should already be familiar with the basic use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be version v1.25.
To check the version, enter <code>kubectl version</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> As the features are in Alpha, prepare the Kubernetes cluster with the two
<a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gates</a>
enabled: <code>JobPodFailurePolicy</code> and <code>PodDisruptionConditions</code>.</div><h2 id=using-pod-failure-policy-to-avoid-unnecessary-pod-retries>Using Pod failure policy to avoid unnecessary Pod retries</h2><p>With the following example, you can learn how to use Pod failure policy to
avoid unnecessary Pod restarts when a Pod failure indicates a non-retriable
software bug.</p><p>First, create a Job based on the config:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples//controllers/job-pod-failure-policy-failjob.yaml download=/controllers/job-pod-failure-policy-failjob.yaml><code>/controllers/job-pod-failure-policy-failjob.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("controllers-job-pod-failure-policy-failjob-yaml")' title="Copy /controllers/job-pod-failure-policy-failjob.yaml to clipboard"></img></div><div class=includecode id=controllers-job-pod-failure-policy-failjob-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-pod-failure-policy-failjob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>8</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>main<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>docker.io/library/bash:5<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;bash&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- echo &#34;Hello world! I&#39;m going to exit with 42 to simulate a software bug.&#34; &amp;&amp; sleep 30 &amp;&amp; exit 42<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>backoffLimit</span>:<span style=color:#bbb> </span><span style=color:#666>6</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podFailurePolicy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>action</span>:<span style=color:#bbb> </span>FailJob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>onExitCodes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>main<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>In<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>values</span>:<span style=color:#bbb> </span>[<span style=color:#666>42</span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create -f job-pod-failure-policy-failjob.yaml
</span></span></code></pre></div><p>After around 30s the entire Job should be terminated. Inspect the status of the Job by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get <span style=color:#a2f>jobs</span> -l job-name<span style=color:#666>=</span>job-pod-failure-policy-failjob -o yaml
</span></span></code></pre></div><p>In the Job status, see a job <code>Failed</code> condition with the field <code>reason</code>
equal <code>PodFailurePolicy</code>. Additionally, the <code>message</code> field contains a
more detailed information about the Job termination, such as:
<code>Container main for pod default/job-pod-failure-policy-failjob-8ckj8 failed with exit code 42 matching FailJob rule at index 0</code>.</p><p>For comparison, if the Pod failure policy was disabled it would take 6 retries
of the Pod, taking at least 2 minutes.</p><h3 id=clean-up>Clean up</h3><p>Delete the Job you created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl delete jobs/job-pod-failure-policy-failjob
</span></span></code></pre></div><p>The cluster automatically cleans up the Pods.</p><h2 id=using-pod-failure-policy-to-ignore-pod-disruptions>Using Pod failure policy to ignore Pod disruptions</h2><p>With the following example, you can learn how to use Pod failure policy to
ignore Pod disruptions from incrementing the Pod retry counter towards the
<code>.spec.backoffLimit</code> limit.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Timing is important for this example, so you may want to read the steps before
execution. In order to trigger a Pod disruption it is important to drain the
node while the Pod is running on it (within 90s since the Pod is scheduled).</div><ol><li><p>Create a Job based on the config:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples//controllers/job-pod-failure-policy-ignore.yaml download=/controllers/job-pod-failure-policy-ignore.yaml><code>/controllers/job-pod-failure-policy-ignore.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("controllers-job-pod-failure-policy-ignore-yaml")' title="Copy /controllers/job-pod-failure-policy-ignore.yaml to clipboard"></img></div><div class=includecode id=controllers-job-pod-failure-policy-ignore-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-pod-failure-policy-ignore<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>4</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>main<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>docker.io/library/bash:5<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;bash&#34;</span>]<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -c<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- echo &#34;Hello world! I&#39;m going to exit with 0 (success).&#34; &amp;&amp; sleep 90 &amp;&amp; exit 0<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>backoffLimit</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podFailurePolicy</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>action</span>:<span style=color:#bbb> </span>Ignore<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>onPodConditions</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DisruptionTarget<span style=color:#bbb>
   </span></span></span></code></pre></div></div></div><p>by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create -f job-pod-failure-policy-ignore.yaml
</span></span></code></pre></div></li><li><p>Run this command to check the <code>nodeName</code> the Pod is scheduled to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#b8860b>nodeName</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get pods -l job-name<span style=color:#666>=</span>job-pod-failure-policy-ignore -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.items[0].spec.nodeName}&#39;</span><span style=color:#a2f;font-weight:700>)</span>
</span></span></code></pre></div></li><li><p>Drain the node to evict the Pod before it completes (within 90s):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl drain nodes/<span style=color:#b8860b>$nodeName</span> --ignore-daemonsets --grace-period<span style=color:#666>=</span><span style=color:#666>0</span>
</span></span></code></pre></div></li><li><p>Inspect the <code>.status.failed</code> to check the counter for the Job is not incremented:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get <span style=color:#a2f>jobs</span> -l job-name<span style=color:#666>=</span>job-pod-failure-policy-ignore -o yaml
</span></span></code></pre></div></li><li><p>Uncordon the node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl uncordon nodes/<span style=color:#b8860b>$nodeName</span>
</span></span></code></pre></div></li></ol><p>The Job resumes and succeeds.</p><p>For comparison, if the Pod failure policy was disabled the Pod disruption would
result in terminating the entire Job (as the <code>.spec.backoffLimit</code> is set to 0).</p><h3 id=cleaning-up>Cleaning up</h3><p>Delete the Job you created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl delete jobs/job-pod-failure-policy-ignore
</span></span></code></pre></div><p>The cluster automatically cleans up the Pods.</p><h2 id=alternatives>Alternatives</h2><p>You could rely solely on the
<a href=/docs/concepts/workloads/controllers/job#pod-backoff-failure-policy>Pod backoff failure policy</a>,
by specifying the Job's <code>.spec.backoffLimit</code> field. However, in many situations
it is problematic to find a balance between setting a low value for <code>.spec.backoffLimit</code>
to avoid unnecessary Pod retries, yet high enough to make sure the Job would
not be terminated by Pod disruptions.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b74b959f5a531003dd0653dfbfc2e88b>10 - Access Applications in a Cluster</h1><div class=lead>Configure load balancing, port forwarding, or setup firewall or DNS configurations to access applications in a cluster.</div></div><div class=td-content><h1 id=pg-777447042cd4e81df3fa5beb3357a485>10.1 - Deploy and Access the Kubernetes Dashboard</h1><div class=lead>Deploy the web UI (Kubernetes Dashboard) and access it.</div><p>Dashboard is a web-based Kubernetes user interface.
You can use Dashboard to deploy containerized applications to a Kubernetes cluster,
troubleshoot your containerized application, and manage the cluster resources.
You can use Dashboard to get an overview of applications running on your cluster,
as well as for creating or modifying individual Kubernetes resources
(such as Deployments, Jobs, DaemonSets, etc).
For example, you can scale a Deployment, initiate a rolling update, restart a pod
or deploy new applications using a deploy wizard.</p><p>Dashboard also provides information on the state of Kubernetes resources in your cluster and on any errors that may have occurred.</p><p><img src=/images/docs/ui-dashboard.png alt="Kubernetes Dashboard UI"></p><h2 id=deploying-the-dashboard-ui>Deploying the Dashboard UI</h2><p>The Dashboard UI is not deployed by default. To deploy it, run the following command:</p><pre tabindex=0><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.1/aio/deploy/recommended.yaml
</code></pre><h2 id=accessing-the-dashboard-ui>Accessing the Dashboard UI</h2><p>To protect your cluster data, Dashboard deploys with a minimal RBAC configuration by default.
Currently, Dashboard only supports logging in with a Bearer Token.
To create a token for this demo, you can follow our guide on
<a href=https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md>creating a sample user</a>.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> The sample user created in the tutorial will have administrative privileges and is for educational purposes only.</div><h3 id=command-line-proxy>Command line proxy</h3><p>You can enable access to the Dashboard using the <code>kubectl</code> command-line tool,
by running the following command:</p><pre tabindex=0><code>kubectl proxy
</code></pre><p>Kubectl will make Dashboard available at <a href=http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/>http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</a>.</p><p>The UI can <em>only</em> be accessed from the machine where the command is executed. See <code>kubectl proxy --help</code> for more options.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The kubeconfig authentication method does <strong>not</strong> support external identity providers
or X.509 certificate-based authentication.</div><h2 id=welcome-view>Welcome view</h2><p>When you access Dashboard on an empty cluster, you'll see the welcome page.
This page contains a link to this document as well as a button to deploy your first application.
In addition, you can view which system applications are running by default in the <code>kube-system</code>
<a href=/docs/tasks/administer-cluster/namespaces/>namespace</a> of your cluster, for example the Dashboard itself.</p><p><img src=/images/docs/ui-dashboard-zerostate.png alt="Kubernetes Dashboard welcome page"></p><h2 id=deploying-containerized-applications>Deploying containerized applications</h2><p>Dashboard lets you create and deploy a containerized application as a Deployment and optional Service with a simple wizard.
You can either manually specify application details, or upload a YAML or JSON <em>manifest</em> file containing application configuration.</p><p>Click the <strong>CREATE</strong> button in the upper right corner of any page to begin.</p><h3 id=specifying-application-details>Specifying application details</h3><p>The deploy wizard expects that you provide the following information:</p><ul><li><p><strong>App name</strong> (mandatory): Name for your application.
A <a href=/docs/concepts/overview/working-with-objects/labels/>label</a> with the name will be
added to the Deployment and Service, if any, that will be deployed.</p><p>The application name must be unique within the selected Kubernetes <a href=/docs/tasks/administer-cluster/namespaces/>namespace</a>.
It must start with a lowercase character, and end with a lowercase character or a number,
and contain only lowercase letters, numbers and dashes (-). It is limited to 24 characters.
Leading and trailing spaces are ignored.</p></li><li><p><strong>Container image</strong> (mandatory):
The URL of a public Docker <a href=/docs/concepts/containers/images/>container image</a> on any registry,
or a private image (commonly hosted on the Google Container Registry or Docker Hub).
The container image specification must end with a colon.</p></li><li><p><strong>Number of pods</strong> (mandatory): The target number of Pods you want your application to be deployed in.
The value must be a positive integer.</p><p>A <a href=/docs/concepts/workloads/controllers/deployment/>Deployment</a> will be created to
maintain the desired number of Pods across your cluster.</p></li><li><p><strong>Service</strong> (optional): For some parts of your application (e.g. frontends) you may want to expose a
<a href=/docs/concepts/services-networking/service/>Service</a> onto an external,
maybe public IP address outside of your cluster (external Service).</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> For external Services, you may need to open up one or more ports to do so.</div><p>Other Services that are only visible from inside the cluster are called internal Services.</p><p>Irrespective of the Service type, if you choose to create a Service and your container listens
on a port (incoming), you need to specify two ports.
The Service will be created mapping the port (incoming) to the target port seen by the container.
This Service will route to your deployed Pods. Supported protocols are TCP and UDP.
The internal DNS name for this Service will be the value you specified as application name above.</p></li></ul><p>If needed, you can expand the <strong>Advanced options</strong> section where you can specify more settings:</p><ul><li><p><strong>Description</strong>: The text you enter here will be added as an
<a href=/docs/concepts/overview/working-with-objects/annotations/>annotation</a>
to the Deployment and displayed in the application's details.</p></li><li><p><strong>Labels</strong>: Default <a href=/docs/concepts/overview/working-with-objects/labels/>labels</a> to be used
for your application are application name and version.
You can specify additional labels to be applied to the Deployment, Service (if any), and Pods,
such as release, environment, tier, partition, and release track.</p><p>Example:</p><pre tabindex=0><code class=language-conf data-lang=conf>release=1.0
tier=frontend
environment=pod
track=stable
</code></pre></li><li><p><strong>Namespace</strong>: Kubernetes supports multiple virtual clusters backed by the same physical cluster.
These virtual clusters are called <a href=/docs/tasks/administer-cluster/namespaces/>namespaces</a>.
They let you partition resources into logically named groups.</p><p>Dashboard offers all available namespaces in a dropdown list, and allows you to create a new namespace.
The namespace name may contain a maximum of 63 alphanumeric characters and dashes (-) but can not contain capital letters.
Namespace names should not consist of only numbers.
If the name is set as a number, such as 10, the pod will be put in the default namespace.</p><p>In case the creation of the namespace is successful, it is selected by default.
If the creation fails, the first namespace is selected.</p></li><li><p><strong>Image Pull Secret</strong>:
In case the specified Docker container image is private, it may require
<a href=/docs/concepts/configuration/secret/>pull secret</a> credentials.</p><p>Dashboard offers all available secrets in a dropdown list, and allows you to create a new secret.
The secret name must follow the DNS domain name syntax, for example <code>new.image-pull.secret</code>.
The content of a secret must be base64-encoded and specified in a
<a href=/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod><code>.dockercfg</code></a> file.
The secret name may consist of a maximum of 253 characters.</p><p>In case the creation of the image pull secret is successful, it is selected by default. If the creation fails, no secret is applied.</p></li><li><p><strong>CPU requirement (cores)</strong> and <strong>Memory requirement (MiB)</strong>:
You can specify the minimum <a href=/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/>resource limits</a>
for the container. By default, Pods run with unbounded CPU and memory limits.</p></li><li><p><strong>Run command</strong> and <strong>Run command arguments</strong>:
By default, your containers run the specified Docker image's default
<a href=/docs/tasks/inject-data-application/define-command-argument-container/>entrypoint command</a>.
You can use the command options and arguments to override the default.</p></li><li><p><strong>Run as privileged</strong>: This setting determines whether processes in
<a href=/docs/concepts/workloads/pods/#privileged-mode-for-containers>privileged containers</a>
are equivalent to processes running as root on the host.
Privileged containers can make use of capabilities like manipulating the network stack and accessing devices.</p></li><li><p><strong>Environment variables</strong>: Kubernetes exposes Services through
<a href=/docs/tasks/inject-data-application/environment-variable-expose-pod-information/>environment variables</a>.
You can compose environment variable or pass arguments to your commands using the values of environment variables.
They can be used in applications to find a Service.
Values can reference other variables using the <code>$(VAR_NAME)</code> syntax.</p></li></ul><h3 id=uploading-a-yaml-or-json-file>Uploading a YAML or JSON file</h3><p>Kubernetes supports declarative configuration.
In this style, all configuration is stored in manifests (YAML or JSON configuration files).
The manifests use Kubernetes <a href=/docs/concepts/overview/kubernetes-api/>API</a> resource schemas.</p><p>As an alternative to specifying application details in the deploy wizard,
you can define your application in one or more manifests, and upload the files using Dashboard.</p><h2 id=using-dashboard>Using Dashboard</h2><p>Following sections describe views of the Kubernetes Dashboard UI; what they provide and how can they be used.</p><h3 id=navigation>Navigation</h3><p>When there are Kubernetes objects defined in the cluster, Dashboard shows them in the initial view.
By default only objects from the <em>default</em> namespace are shown and
this can be changed using the namespace selector located in the navigation menu.</p><p>Dashboard shows most Kubernetes object kinds and groups them in a few menu categories.</p><h4 id=admin-overview>Admin overview</h4><p>For cluster and namespace administrators, Dashboard lists Nodes, Namespaces and PersistentVolumes and has detail views for them.
Node list view contains CPU and memory usage metrics aggregated across all Nodes.
The details view shows the metrics for a Node, its specification, status,
allocated resources, events and pods running on the node.</p><h4 id=workloads>Workloads</h4><p>Shows all applications running in the selected namespace.
The view lists applications by workload kind (for example: Deployments, ReplicaSets, StatefulSets).
Each workload kind can be viewed separately.
The lists summarize actionable information about the workloads,
such as the number of ready pods for a ReplicaSet or current memory usage for a Pod.</p><p>Detail views for workloads show status and specification information and
surface relationships between objects.
For example, Pods that ReplicaSet is controlling or new ReplicaSets and HorizontalPodAutoscalers for Deployments.</p><h4 id=services>Services</h4><p>Shows Kubernetes resources that allow for exposing services to external world and
discovering them within a cluster.
For that reason, Service and Ingress views show Pods targeted by them,
internal endpoints for cluster connections and external endpoints for external users.</p><h4 id=storage>Storage</h4><p>Storage view shows PersistentVolumeClaim resources which are used by applications for storing data.</p><h4 id=config-maps-and-secrets>ConfigMaps and Secrets</h4><p>Shows all Kubernetes resources that are used for live configuration of applications running in clusters.
The view allows for editing and managing config objects and displays secrets hidden by default.</p><h4 id=logs-viewer>Logs viewer</h4><p>Pod lists and detail pages link to a logs viewer that is built into Dashboard.
The viewer allows for drilling down logs from containers belonging to a single Pod.</p><p><img src=/images/docs/ui-dashboard-logs-view.png alt="Logs viewer"></p><h2 id=what-s-next>What's next</h2><p>For more information, see the
<a href=https://github.com/kubernetes/dashboard>Kubernetes Dashboard project page</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6a8d9e9e05f2b6825afbb8889c957370>10.2 - Accessing Clusters</h1><p>This topic discusses multiple ways to interact with clusters.</p><h2 id=accessing-for-the-first-time-with-kubectl>Accessing for the first time with kubectl</h2><p>When accessing the Kubernetes API for the first time, we suggest using the
Kubernetes CLI, <code>kubectl</code>.</p><p>To access a cluster, you need to know the location of the cluster and have credentials
to access it. Typically, this is automatically set-up when you work through
a <a href=/docs/setup/>Getting started guide</a>,
or someone else set up the cluster and provided you with credentials and a location.</p><p>Check the location and credentials that kubectl knows about with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config view
</span></span></code></pre></div><p>Many of the <a href=/docs/reference/kubectl/cheatsheet/>examples</a> provide an introduction to using
<code>kubectl</code>, and complete documentation is found in the
<a href=/docs/reference/kubectl/>kubectl reference</a>.</p><h2 id=directly-accessing-the-rest-api>Directly accessing the REST API</h2><p>Kubectl handles locating and authenticating to the apiserver.
If you want to directly access the REST API with an http client like
curl or wget, or a browser, there are several ways to locate and authenticate:</p><ul><li>Run kubectl in proxy mode.<ul><li>Recommended approach.</li><li>Uses stored apiserver location.</li><li>Verifies identity of apiserver using self-signed cert. No MITM possible.</li><li>Authenticates to apiserver.</li><li>In future, may do intelligent client-side load-balancing and failover.</li></ul></li><li>Provide the location and credentials directly to the http client.<ul><li>Alternate approach.</li><li>Works with some types of client code that are confused by using a proxy.</li><li>Need to import a root cert into your browser to protect against MITM.</li></ul></li></ul><h3 id=using-kubectl-proxy>Using kubectl proxy</h3><p>The following command runs kubectl in a mode where it acts as a reverse proxy. It handles
locating the apiserver and authenticating.
Run it like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl proxy --port<span style=color:#666>=</span><span style=color:#666>8080</span>
</span></span></code></pre></div><p>See <a href=/docs/reference/generated/kubectl/kubectl-commands/#proxy>kubectl proxy</a> for more details.</p><p>Then you can explore the API with curl, wget, or a browser, replacing localhost
with [::1] for IPv6, like so:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl http://localhost:8080/api/
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;kind&#34;</span>: <span style=color:#b44>&#34;APIVersions&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;versions&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;v1&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;serverAddressByClientCIDRs&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;clientCIDR&#34;</span>: <span style=color:#b44>&#34;0.0.0.0/0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;serverAddress&#34;</span>: <span style=color:#b44>&#34;10.0.1.149:443&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=without-kubectl-proxy>Without kubectl proxy</h3><p>Use <code>kubectl apply</code> and <code>kubectl describe secret...</code> to create a token for the default service account with grep/cut:</p><p>First, create the Secret, requesting a token for the default ServiceAccount:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#b44>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: default-token
</span></span></span><span style=display:flex><span><span style=color:#b44>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#b44>    kubernetes.io/service-account.name: default
</span></span></span><span style=display:flex><span><span style=color:#b44>type: kubernetes.io/service-account-token
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Next, wait for the token controller to populate the Secret with a token:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f;font-weight:700>while</span> ! kubectl describe secret default-token | grep -E <span style=color:#b44>&#39;^token&#39;</span> &gt;/dev/null; <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>  <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;waiting for token...&#34;</span> &gt;&amp;<span style=color:#666>2</span>
</span></span><span style=display:flex><span>  sleep <span style=color:#666>1</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>Capture and use the generated token:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>APISERVER</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl config view --minify | grep server | cut -f 2- -d <span style=color:#b44>&#34;:&#34;</span> | tr -d <span style=color:#b44>&#34; &#34;</span><span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>TOKEN</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl describe secret default-token | grep -E <span style=color:#b44>&#39;^token&#39;</span> | cut -f2 -d<span style=color:#b44>&#39;:&#39;</span> | tr -d <span style=color:#b44>&#34; &#34;</span><span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl <span style=color:#b8860b>$APISERVER</span>/api --header <span style=color:#b44>&#34;Authorization: Bearer </span><span style=color:#b8860b>$TOKEN</span><span style=color:#b44>&#34;</span> --insecure
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;kind&#34;</span>: <span style=color:#b44>&#34;APIVersions&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;versions&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;v1&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;serverAddressByClientCIDRs&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;clientCIDR&#34;</span>: <span style=color:#b44>&#34;0.0.0.0/0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;serverAddress&#34;</span>: <span style=color:#b44>&#34;10.0.1.149:443&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Using <code>jsonpath</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>APISERVER</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl config view --minify -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.clusters[0].cluster.server}&#39;</span><span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>TOKEN</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get secret default-token -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.data.token}&#39;</span> | base64 --decode<span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl <span style=color:#b8860b>$APISERVER</span>/api --header <span style=color:#b44>&#34;Authorization: Bearer </span><span style=color:#b8860b>$TOKEN</span><span style=color:#b44>&#34;</span> --insecure
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;kind&#34;</span>: <span style=color:#b44>&#34;APIVersions&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;versions&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;v1&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;serverAddressByClientCIDRs&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;clientCIDR&#34;</span>: <span style=color:#b44>&#34;0.0.0.0/0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;serverAddress&#34;</span>: <span style=color:#b44>&#34;10.0.1.149:443&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The above examples use the <code>--insecure</code> flag. This leaves it subject to MITM
attacks. When kubectl accesses the cluster it uses a stored root certificate
and client certificates to access the server. (These are installed in the
<code>~/.kube</code> directory). Since cluster certificates are typically self-signed, it
may take special configuration to get your http client to use root
certificate.</p><p>On some clusters, the apiserver does not require authentication; it may serve
on localhost, or be protected by a firewall. There is not a standard
for this. <a href=/docs/concepts/security/controlling-access>Controlling Access to the API</a>
describes how a cluster admin can configure this.</p><h2 id=programmatic-access-to-the-api>Programmatic access to the API</h2><p>Kubernetes officially supports <a href=#go-client>Go</a> and <a href=#python-client>Python</a>
client libraries.</p><h3 id=go-client>Go client</h3><ul><li>To get the library, run the following command: <code>go get k8s.io/client-go@kubernetes-&lt;kubernetes-version-number></code>, see <a href=https://github.com/kubernetes/client-go/blob/master/INSTALL.md#for-the-casual-user>INSTALL.md</a> for detailed installation instructions. See <a href=https://github.com/kubernetes/client-go#compatibility-matrix>https://github.com/kubernetes/client-go</a> to see which versions are supported.</li><li>Write an application atop of the client-go clients. Note that client-go defines its own API objects, so if needed, please import API definitions from client-go rather than from the main repository, e.g., <code>import "k8s.io/client-go/kubernetes"</code> is correct.</li></ul><p>The Go client can use the same <a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>
as the kubectl CLI does to locate and authenticate to the apiserver. See this <a href=https://git.k8s.io/client-go/examples/out-of-cluster-client-configuration/main.go>example</a>.</p><p>If the application is deployed as a Pod in the cluster, please refer to the <a href=#accessing-the-api-from-a-pod>next section</a>.</p><h3 id=python-client>Python client</h3><p>To use <a href=https://github.com/kubernetes-client/python>Python client</a>, run the following command: <code>pip install kubernetes</code>. See <a href=https://github.com/kubernetes-client/python>Python Client Library page</a> for more installation options.</p><p>The Python client can use the same <a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig file</a>
as the kubectl CLI does to locate and authenticate to the apiserver. See this <a href=https://github.com/kubernetes-client/python/tree/master/examples>example</a>.</p><h3 id=other-languages>Other languages</h3><p>There are <a href=/docs/reference/using-api/client-libraries/>client libraries</a> for accessing the API from other languages.
See documentation for other libraries for how they authenticate.</p><h2 id=accessing-the-api-from-a-pod>Accessing the API from a Pod</h2><p>When accessing the API from a pod, locating and authenticating
to the API server are somewhat different.</p><p>Please check <a href=/docs/tasks/run-application/access-api-from-pod/>Accessing the API from within a Pod</a>
for more details.</p><h2 id=accessing-services-running-on-the-cluster>Accessing services running on the cluster</h2><p>The previous section describes how to connect to the Kubernetes API server.
For information about connecting to other services running on a Kubernetes cluster, see
<a href=/docs/tasks/access-application-cluster/access-cluster-services/>Access Cluster Services</a>.</p><h2 id=requesting-redirects>Requesting redirects</h2><p>The redirect capabilities have been deprecated and removed. Please use a proxy (see below) instead.</p><h2 id=so-many-proxies>So Many Proxies</h2><p>There are several different proxies you may encounter when using Kubernetes:</p><ol><li><p>The <a href=#directly-accessing-the-rest-api>kubectl proxy</a>:</p><ul><li>runs on a user's desktop or in a pod</li><li>proxies from a localhost address to the Kubernetes apiserver</li><li>client to proxy uses HTTP</li><li>proxy to apiserver uses HTTPS</li><li>locates apiserver</li><li>adds authentication headers</li></ul></li><li><p>The <a href=/docs/tasks/access-application-cluster/access-cluster-services/#discovering-builtin-services>apiserver proxy</a>:</p><ul><li>is a bastion built into the apiserver</li><li>connects a user outside of the cluster to cluster IPs which otherwise might not be reachable</li><li>runs in the apiserver processes</li><li>client to proxy uses HTTPS (or http if apiserver so configured)</li><li>proxy to target may use HTTP or HTTPS as chosen by proxy using available information</li><li>can be used to reach a Node, Pod, or Service</li><li>does load balancing when used to reach a Service</li></ul></li><li><p>The <a href=/docs/concepts/services-networking/service/#ips-and-vips>kube proxy</a>:</p><ul><li>runs on each node</li><li>proxies UDP and TCP</li><li>does not understand HTTP</li><li>provides load balancing</li><li>is only used to reach services</li></ul></li><li><p>A Proxy/Load-balancer in front of apiserver(s):</p><ul><li>existence and implementation varies from cluster to cluster (e.g. nginx)</li><li>sits between all clients and one or more apiservers</li><li>acts as load balancer if there are several apiservers.</li></ul></li><li><p>Cloud Load Balancers on external services:</p><ul><li>are provided by some cloud providers (e.g. AWS ELB, Google Cloud Load Balancer)</li><li>are created automatically when the Kubernetes service has type <code>LoadBalancer</code></li><li>use UDP/TCP only</li><li>implementation varies by cloud provider.</li></ul></li></ol><p>Kubernetes users will typically not need to worry about anything other than the first two types. The cluster admin
will typically ensure that the latter types are set up correctly.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5a233e14205d77fe1294917d2da6f876>10.3 - Configure Access to Multiple Clusters</h1><p>This page shows how to configure access to multiple clusters by using
configuration files. After your clusters, users, and contexts are defined in
one or more configuration files, you can quickly switch between clusters by using the
<code>kubectl config use-context</code> command.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> A file that is used to configure access to a cluster is sometimes called
a <em>kubeconfig file</em>. This is a generic way of referring to configuration files.
It does not mean that there is a file named <code>kubeconfig</code>.</div><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Only use kubeconfig files from trusted sources. Using a specially-crafted kubeconfig
file could result in malicious code execution or file exposure.
If you must use an untrusted kubeconfig file, inspect it carefully first, much as you would a shell script.</div><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>To check that <a class=glossary-tooltip title='A command line tool for communicating with a Kubernetes cluster.' data-toggle=tooltip data-placement=top href=/docs/user-guide/kubectl-overview/ target=_blank aria-label=kubectl>kubectl</a> is installed,
run <code>kubectl version --client</code>. The kubectl version should be
<a href=/releases/version-skew-policy/#kubectl>within one minor version</a> of your
cluster's API server.</p><h2 id=define-clusters-users-and-contexts>Define clusters, users, and contexts</h2><p>Suppose you have two clusters, one for development work and one for scratch work.
In the <code>development</code> cluster, your frontend developers work in a namespace called <code>frontend</code>,
and your storage developers work in a namespace called <code>storage</code>. In your <code>scratch</code> cluster,
developers work in the default namespace, or they create auxiliary namespaces as they
see fit. Access to the development cluster requires authentication by certificate. Access
to the scratch cluster requires authentication by username and password.</p><p>Create a directory named <code>config-exercise</code>. In your
<code>config-exercise</code> directory, create a file named <code>config-demo</code> with this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>preferences</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>clusters</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>scratch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>experimenter<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>contexts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>exp-scratch<span style=color:#bbb>
</span></span></span></code></pre></div><p>A configuration file describes clusters, users, and contexts. Your <code>config-demo</code> file
has the framework to describe two clusters, two users, and three contexts.</p><p>Go to your <code>config-exercise</code> directory. Enter these commands to add cluster details to
your configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo set-cluster development --server<span style=color:#666>=</span>https://1.2.3.4 --certificate-authority<span style=color:#666>=</span>fake-ca-file
</span></span><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo set-cluster scratch --server<span style=color:#666>=</span>https://5.6.7.8 --insecure-skip-tls-verify
</span></span></code></pre></div><p>Add user details to your configuration file:</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Storing passwords in Kubernetes client config is risky. A better alternative would be to use a credential plugin and store them separately. See: <a href=/docs/reference/access-authn-authz/authentication/#client-go-credential-plugins>client-go credential plugins</a></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo set-credentials developer --client-certificate<span style=color:#666>=</span>fake-cert-file --client-key<span style=color:#666>=</span>fake-key-seefile
</span></span><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo set-credentials experimenter --username<span style=color:#666>=</span>exp --password<span style=color:#666>=</span>some-password
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><ul><li>To delete a user you can run <code>kubectl --kubeconfig=config-demo config unset users.&lt;name></code></li><li>To remove a cluster, you can run <code>kubectl --kubeconfig=config-demo config unset clusters.&lt;name></code></li><li>To remove a context, you can run <code>kubectl --kubeconfig=config-demo config unset contexts.&lt;name></code></li></ul></div><p>Add context details to your configuration file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo set-context dev-frontend --cluster<span style=color:#666>=</span>development --namespace<span style=color:#666>=</span>frontend --user<span style=color:#666>=</span>developer
</span></span><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo set-context dev-storage --cluster<span style=color:#666>=</span>development --namespace<span style=color:#666>=</span>storage --user<span style=color:#666>=</span>developer
</span></span><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo set-context exp-scratch --cluster<span style=color:#666>=</span>scratch --namespace<span style=color:#666>=</span>default --user<span style=color:#666>=</span>experimenter
</span></span></code></pre></div><p>Open your <code>config-demo</code> file to see the added details. As an alternative to opening the
<code>config-demo</code> file, you can use the <code>config view</code> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo view
</span></span></code></pre></div><p>The output shows the two clusters, two users, and three contexts:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>clusters</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>certificate-authority</span>:<span style=color:#bbb> </span>fake-ca-file<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>server</span>:<span style=color:#bbb> </span>https://1.2.3.4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>insecure-skip-tls-verify</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>server</span>:<span style=color:#bbb> </span>https://5.6.7.8<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>scratch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>contexts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>scratch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>experimenter<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>exp-scratch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>current-context</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>preferences</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-certificate</span>:<span style=color:#bbb> </span>fake-cert-file<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-key</span>:<span style=color:#bbb> </span>fake-key-file<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>experimenter<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Documentation note (this comment is NOT part of the command output).</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Storing passwords in Kubernetes client config is risky.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># A better alternative would be to use a credential plugin</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># and store the credentials separately.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># See https://kubernetes.io/docs/reference/access-authn-authz/authentication/#client-go-credential-plugins</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>password</span>:<span style=color:#bbb> </span>some-password<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>exp<span style=color:#bbb>
</span></span></span></code></pre></div><p>The <code>fake-ca-file</code>, <code>fake-cert-file</code> and <code>fake-key-file</code> above are the placeholders
for the pathnames of the certificate files. You need to change these to the actual pathnames
of certificate files in your environment.</p><p>Sometimes you may want to use Base64-encoded data embedded here instead of separate
certificate files; in that case you need to add the suffix <code>-data</code> to the keys, for example,
<code>certificate-authority-data</code>, <code>client-certificate-data</code>, <code>client-key-data</code>.</p><p>Each context is a triple (cluster, user, namespace). For example, the
<code>dev-frontend</code> context says, "Use the credentials of the <code>developer</code>
user to access the <code>frontend</code> namespace of the <code>development</code> cluster".</p><p>Set the current context:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo use-context dev-frontend
</span></span></code></pre></div><p>Now whenever you enter a <code>kubectl</code> command, the action will apply to the cluster,
and namespace listed in the <code>dev-frontend</code> context. And the command will use
the credentials of the user listed in the <code>dev-frontend</code> context.</p><p>To see only the configuration information associated with
the current context, use the <code>--minify</code> flag.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo view --minify
</span></span></code></pre></div><p>The output shows configuration information associated with the <code>dev-frontend</code> context:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>clusters</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>certificate-authority</span>:<span style=color:#bbb> </span>fake-ca-file<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>server</span>:<span style=color:#bbb> </span>https://1.2.3.4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>contexts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>current-context</span>:<span style=color:#bbb> </span>dev-frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>preferences</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-certificate</span>:<span style=color:#bbb> </span>fake-cert-file<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-key</span>:<span style=color:#bbb> </span>fake-key-file<span style=color:#bbb>
</span></span></span></code></pre></div><p>Now suppose you want to work for a while in the scratch cluster.</p><p>Change the current context to <code>exp-scratch</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo use-context exp-scratch
</span></span></code></pre></div><p>Now any <code>kubectl</code> command you give will apply to the default namespace of
the <code>scratch</code> cluster. And the command will use the credentials of the user
listed in the <code>exp-scratch</code> context.</p><p>View configuration associated with the new current context, <code>exp-scratch</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo view --minify
</span></span></code></pre></div><p>Finally, suppose you want to work for a while in the <code>storage</code> namespace of the
<code>development</code> cluster.</p><p>Change the current context to <code>dev-storage</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo use-context dev-storage
</span></span></code></pre></div><p>View configuration associated with the new current context, <code>dev-storage</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config --kubeconfig<span style=color:#666>=</span>config-demo view --minify
</span></span></code></pre></div><h2 id=create-a-second-configuration-file>Create a second configuration file</h2><p>In your <code>config-exercise</code> directory, create a file named <code>config-demo-2</code> with this content:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>preferences</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>contexts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>ramp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-ramp-up<span style=color:#bbb>
</span></span></span></code></pre></div><p>The preceding configuration file defines a new context named <code>dev-ramp-up</code>.</p><h2 id=set-the-kubeconfig-environment-variable>Set the KUBECONFIG environment variable</h2><p>See whether you have an environment variable named <code>KUBECONFIG</code>. If so, save the
current value of your <code>KUBECONFIG</code> environment variable, so you can restore it later.
For example:</p><h3 id=linux>Linux</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>KUBECONFIG_SAVED</span><span style=color:#666>=</span><span style=color:#b44>&#34;</span><span style=color:#b8860b>$KUBECONFIG</span><span style=color:#b44>&#34;</span>
</span></span></code></pre></div><h3 id=windows-powershell>Windows PowerShell</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b8860b>$Env:KUBECONFIG_SAVED</span>=<span style=color:#b8860b>$ENV:KUBECONFIG</span>
</span></span></code></pre></div><p>The <code>KUBECONFIG</code> environment variable is a list of paths to configuration files. The list is
colon-delimited for Linux and Mac, and semicolon-delimited for Windows. If you have
a <code>KUBECONFIG</code> environment variable, familiarize yourself with the configuration files
in the list.</p><p>Temporarily append two paths to your <code>KUBECONFIG</code> environment variable. For example:</p><h3 id=linux-1>Linux</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span><span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>KUBECONFIG</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>:config-demo:config-demo-2&#34;</span>
</span></span></code></pre></div><h3 id=windows-powershell-1>Windows PowerShell</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b8860b>$Env:KUBECONFIG</span>=(<span style=color:#b44>&#34;config-demo;config-demo-2&#34;</span>)
</span></span></code></pre></div><p>In your <code>config-exercise</code> directory, enter this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config view
</span></span></code></pre></div><p>The output shows merged information from all the files listed in your <code>KUBECONFIG</code>
environment variable. In particular, notice that the merged information has the
<code>dev-ramp-up</code> context from the <code>config-demo-2</code> file and the three contexts from
the <code>config-demo</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>contexts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>ramp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-ramp-up<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>development<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>developer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>dev-storage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>scratch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>experimenter<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>exp-scratch<span style=color:#bbb>
</span></span></span></code></pre></div><p>For more information about how kubeconfig files are merged, see
<a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>Organizing Cluster Access Using kubeconfig Files</a></p><h2 id=explore-the-home-kube-directory>Explore the $HOME/.kube directory</h2><p>If you already have a cluster, and you can use <code>kubectl</code> to interact with
the cluster, then you probably have a file named <code>config</code> in the <code>$HOME/.kube</code>
directory.</p><p>Go to <code>$HOME/.kube</code>, and see what files are there. Typically, there is a file named
<code>config</code>. There might also be other configuration files in this directory. Briefly
familiarize yourself with the contents of these files.</p><h2 id=append-home-kube-config-to-your-kubeconfig-environment-variable>Append $HOME/.kube/config to your KUBECONFIG environment variable</h2><p>If you have a <code>$HOME/.kube/config</code> file, and it's not already listed in your
<code>KUBECONFIG</code> environment variable, append it to your <code>KUBECONFIG</code> environment variable now.
For example:</p><h3 id=linux-2>Linux</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span><span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>KUBECONFIG</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOME</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>/.kube/config&#34;</span>
</span></span></code></pre></div><h3 id=windows-powershell-2>Windows Powershell</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b8860b>$Env:KUBECONFIG</span>=<span style=color:#b44>&#34;</span><span style=color:#b8860b>$Env:KUBECONFIG</span><span style=color:#b44>;</span><span style=color:#b8860b>$HOME</span><span style=color:#b44>\.kube\config&#34;</span>
</span></span></code></pre></div><p>View configuration information merged from all the files that are now listed
in your <code>KUBECONFIG</code> environment variable. In your config-exercise directory, enter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl config view
</span></span></code></pre></div><h2 id=clean-up>Clean up</h2><p>Return your <code>KUBECONFIG</code> environment variable to its original value. For example:<br></p><h3 id=linux-3>Linux</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span><span style=color:#b44>&#34;</span><span style=color:#b8860b>$KUBECONFIG_SAVED</span><span style=color:#b44>&#34;</span>
</span></span></code></pre></div><h3 id=windows-powershell-3>Windows PowerShell</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b8860b>$Env:KUBECONFIG</span>=<span style=color:#b8860b>$ENV:KUBECONFIG_SAVED</span>
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>Organizing Cluster Access Using kubeconfig Files</a></li><li><a href=/docs/reference/generated/kubectl/kubectl-commands#config>kubectl config</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-72d3dddbc0c166c9a364e753d2b31ff0>10.4 - Use Port Forwarding to Access Applications in a Cluster</h1><p>This page shows how to use <code>kubectl port-forward</code> to connect to a MongoDB
server running in a Kubernetes cluster. This type of connection can be useful
for database debugging.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.10.
To check the version, enter <code>kubectl version</code>.</li><li>Install <a href=https://www.mongodb.com/try/download/shell>MongoDB Shell</a>.</li></ul><h2 id=creating-mongodb-deployment-and-service>Creating MongoDB deployment and service</h2><ol><li><p>Create a Deployment that runs MongoDB:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/mongodb/mongo-deployment.yaml
</span></span></code></pre></div><p>The output of a successful command verifies that the deployment was created:</p><pre tabindex=0><code>deployment.apps/mongo created
</code></pre><p>View the pod status to check that it is ready:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>The output displays the pod created:</p><pre tabindex=0><code>NAME                     READY   STATUS    RESTARTS   AGE
mongo-75f59d57f4-4nd6q   1/1     Running   0          2m4s
</code></pre><p>View the Deployment's status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment
</span></span></code></pre></div><p>The output displays that the Deployment was created:</p><pre tabindex=0><code>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
mongo   1/1     1            1           2m21s
</code></pre><p>The Deployment automatically manages a ReplicaSet.
View the ReplicaSet status using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get replicaset
</span></span></code></pre></div><p>The output displays that the ReplicaSet was created:</p><pre tabindex=0><code>NAME               DESIRED   CURRENT   READY   AGE
mongo-75f59d57f4   1         1         1       3m12s
</code></pre></li><li><p>Create a Service to expose MongoDB on the network:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/application/mongodb/mongo-service.yaml
</span></span></code></pre></div><p>The output of a successful command verifies that the Service was created:</p><pre tabindex=0><code>service/mongo created
</code></pre><p>Check the Service created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service mongo
</span></span></code></pre></div><p>The output displays the service created:</p><pre tabindex=0><code>NAME    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE
mongo   ClusterIP   10.96.41.183   &lt;none&gt;        27017/TCP   11s
</code></pre></li><li><p>Verify that the MongoDB server is running in the Pod, and listening on port 27017:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Change mongo-75f59d57f4-4nd6q to the name of the Pod</span>
</span></span><span style=display:flex><span>kubectl get pod mongo-75f59d57f4-4nd6q --template<span style=color:#666>=</span><span style=color:#b44>&#39;{{(index (index .spec.containers 0).ports 0).containerPort}}{{&#34;\n&#34;}}&#39;</span>
</span></span></code></pre></div><p>The output displays the port for MongoDB in that Pod:</p><pre tabindex=0><code>27017
</code></pre><p>27017 is the TCP port allocated to MongoDB on the internet.</p></li></ol><h2 id=forward-a-local-port-to-a-port-on-the-pod>Forward a local port to a port on the Pod</h2><ol><li><p><code>kubectl port-forward</code> allows using resource name, such as a pod name, to select a matching pod to port forward to.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Change mongo-75f59d57f4-4nd6q to the name of the Pod</span>
</span></span><span style=display:flex><span>kubectl port-forward mongo-75f59d57f4-4nd6q 28015:27017
</span></span></code></pre></div><p>which is the same as</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward pods/mongo-75f59d57f4-4nd6q 28015:27017
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward deployment/mongo 28015:27017
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward replicaset/mongo-75f59d57f4 28015:27017
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward service/mongo 28015:27017
</span></span></code></pre></div><p>Any of the above commands works. The output is similar to this:</p><pre tabindex=0><code>Forwarding from 127.0.0.1:28015 -&gt; 27017
Forwarding from [::1]:28015 -&gt; 27017
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>kubectl port-forward</code> does not return. To continue with the exercises, you will need to open another terminal.</div></li><li><p>Start the MongoDB command line interface:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongosh --port <span style=color:#666>28015</span>
</span></span></code></pre></div></li><li><p>At the MongoDB command line prompt, enter the <code>ping</code> command:</p><pre tabindex=0><code>db.runCommand( { ping: 1 } )
</code></pre><p>A successful ping request returns:</p><pre tabindex=0><code>{ ok: 1 }
</code></pre></li></ol><h3 id=let-kubectl-choose-local-port>Optionally let <em>kubectl</em> choose the local port</h3><p>If you don't need a specific local port, you can let <code>kubectl</code> choose and allocate
the local port and thus relieve you from having to manage local port conflicts, with
the slightly simpler syntax:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward deployment/mongo :27017
</span></span></code></pre></div><p>The <code>kubectl</code> tool finds a local port number that is not in use (avoiding low ports numbers,
because these might be used by other applications). The output is similar to:</p><pre tabindex=0><code>Forwarding from 127.0.0.1:63753 -&gt; 27017
Forwarding from [::1]:63753 -&gt; 27017
</code></pre><h2 id=discussion>Discussion</h2><p>Connections made to local port 28015 are forwarded to port 27017 of the Pod that
is running the MongoDB server. With this connection in place, you can use your
local workstation to debug the database that is running in the Pod.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> <code>kubectl port-forward</code> is implemented for TCP ports only.
The support for UDP protocol is tracked in
<a href=https://github.com/kubernetes/kubernetes/issues/47862>issue 47862</a>.</div><h2 id=what-s-next>What's next</h2><p>Learn more about <a href=/docs/reference/generated/kubectl/kubectl-commands/#port-forward>kubectl port-forward</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-312f29f850826b74618634cd877aa065>10.5 - Use a Service to Access an Application in a Cluster</h1><p>This page shows how to create a Kubernetes Service object that external
clients can use to access an application running in a cluster. The Service
provides load balancing for an application that has two running instances.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=objectives>Objectives</h2><ul><li>Run two instances of a Hello World application.</li><li>Create a Service object that exposes a node port.</li><li>Use the Service object to access the running application.</li></ul><h2 id=creating-a-service-for-an-application-running-in-two-pods>Creating a service for an application running in two pods</h2><p>Here is the configuration file for the application Deployment:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/access/hello-application.yaml download=service/access/hello-application.yaml><code>service/access/hello-application.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-access-hello-application-yaml")' title="Copy service/access/hello-application.yaml to clipboard"></img></div><div class=includecode id=service-access-hello-application-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello-world<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>load-balancer-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>run</span>:<span style=color:#bbb> </span>load-balancer-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello-world<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/google-samples/node-hello:1.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><ol><li><p>Run a Hello World application in your cluster:
Create the application Deployment using the file above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/service/access/hello-application.yaml
</span></span></code></pre></div><p>The preceding command creates a
<a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployment>Deployment</a>
and an associated
<a class=glossary-tooltip title='ReplicaSet ensures that a specified number of Pod replicas are running at one time' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/replicaset/ target=_blank aria-label=ReplicaSet>ReplicaSet</a>.
The ReplicaSet has two
<a class=glossary-tooltip title='A Pod represents a set of running containers in your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pods>Pods</a>
each of which runs the Hello World application.</p></li><li><p>Display information about the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployments hello-world
</span></span><span style=display:flex><span>kubectl describe deployments hello-world
</span></span></code></pre></div></li><li><p>Display information about your ReplicaSet objects:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get replicasets
</span></span><span style=display:flex><span>kubectl describe replicasets
</span></span></code></pre></div></li><li><p>Create a Service object that exposes the deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl expose deployment hello-world --type<span style=color:#666>=</span>NodePort --name<span style=color:#666>=</span>example-service
</span></span></code></pre></div></li><li><p>Display information about the Service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe services example-service
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Name:                   example-service
</span></span><span style=display:flex><span>Namespace:              default
</span></span><span style=display:flex><span>Labels:                 <span style=color:#b8860b>run</span><span style=color:#666>=</span>load-balancer-example
</span></span><span style=display:flex><span>Annotations:            &lt;none&gt;
</span></span><span style=display:flex><span>Selector:               <span style=color:#b8860b>run</span><span style=color:#666>=</span>load-balancer-example
</span></span><span style=display:flex><span>Type:                   NodePort
</span></span><span style=display:flex><span>IP:                     10.32.0.16
</span></span><span style=display:flex><span>Port:                   &lt;unset&gt; 8080/TCP
</span></span><span style=display:flex><span>TargetPort:             8080/TCP
</span></span><span style=display:flex><span>NodePort:               &lt;unset&gt; 31496/TCP
</span></span><span style=display:flex><span>Endpoints:              10.200.1.4:8080,10.200.2.5:8080
</span></span><span style=display:flex><span>Session Affinity:       None
</span></span><span style=display:flex><span>Events:                 &lt;none&gt;
</span></span></code></pre></div><p>Make a note of the NodePort value for the service. For example,
in the preceding output, the NodePort value is 31496.</p></li><li><p>List the pods that are running the Hello World application:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --selector<span style=color:#666>=</span><span style=color:#b44>&#34;run=load-balancer-example&#34;</span> --output<span style=color:#666>=</span>wide
</span></span></code></pre></div><p>The output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME                           READY   STATUS    ...  IP           NODE
</span></span><span style=display:flex><span>hello-world-2895499144-bsbk5   1/1     Running   ...  10.200.1.4   worker1
</span></span><span style=display:flex><span>hello-world-2895499144-m1pwt   1/1     Running   ...  10.200.2.5   worker2
</span></span></code></pre></div></li><li><p>Get the public IP address of one of your nodes that is running
a Hello World pod. How you get this address depends on how you set
up your cluster. For example, if you are using Minikube, you can
see the node address by running <code>kubectl cluster-info</code>. If you are
using Google Compute Engine instances, you can use the
<code>gcloud compute instances list</code> command to see the public addresses of your
nodes.</p></li><li><p>On your chosen node, create a firewall rule that allows TCP traffic
on your node port. For example, if your Service has a NodePort value of
31568, create a firewall rule that allows TCP traffic on port 31568. Different
cloud providers offer different ways of configuring firewall rules.</p></li><li><p>Use the node address and node port to access the Hello World application:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl http://&lt;public-node-ip&gt;:&lt;node-port&gt;
</span></span></code></pre></div><p>where <code>&lt;public-node-ip></code> is the public IP address of your node,
and <code>&lt;node-port></code> is the NodePort value for your service. The
response to a successful request is a hello message:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Hello Kubernetes!
</span></span></code></pre></div></li></ol><h2 id=using-a-service-configuration-file>Using a service configuration file</h2><p>As an alternative to using <code>kubectl expose</code>, you can use a
<a href=/docs/concepts/services-networking/service/>service configuration file</a>
to create a Service.</p><h2 id=cleaning-up>Cleaning up</h2><p>To delete the Service, enter this command:</p><pre><code>kubectl delete services example-service
</code></pre><p>To delete the Deployment, the ReplicaSet, and the Pods that are running
the Hello World application, enter this command:</p><pre><code>kubectl delete deployment hello-world
</code></pre><h2 id=what-s-next>What's next</h2><p>Follow the
<a href=/docs/tutorials/services/connect-applications-service/>Connecting Applications with Services</a>
tutorial.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f3dac629bea950fc026d920306f09fb4>10.6 - Connect a Frontend to a Backend Using Services</h1><p>This task shows how to create a <em>frontend</em> and a <em>backend</em> microservice. The backend
microservice is a hello greeter. The frontend exposes the backend using nginx and a
Kubernetes <a class=glossary-tooltip title='A way to expose an application running on a set of Pods as a network service.' data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=Service>Service</a> object.</p><h2 id=objectives>Objectives</h2><ul><li>Create and run a sample <code>hello</code> backend microservice using a
<a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployment>Deployment</a> object.</li><li>Use a Service object to send traffic to the backend microservice's multiple replicas.</li><li>Create and run a <code>nginx</code> frontend microservice, also using a Deployment object.</li><li>Configure the frontend microservice to send traffic to the backend microservice.</li><li>Use a Service object of <code>type=LoadBalancer</code> to expose the frontend microservice
outside the cluster.</li></ul><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><p>This task uses
<a href=/docs/tasks/access-application-cluster/create-external-load-balancer/>Services with external load balancers</a>, which
require a supported environment. If your environment does not support this, you can use a Service of type
<a href=/docs/concepts/services-networking/service/#type-nodeport>NodePort</a> instead.</p><h2 id=creating-the-backend-using-a-deployment>Creating the backend using a Deployment</h2><p>The backend is a simple hello greeter microservice. Here is the configuration
file for the backend Deployment:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/access/backend-deployment.yaml download=service/access/backend-deployment.yaml><code>service/access/backend-deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-access-backend-deployment-yaml")' title="Copy service/access/backend-deployment.yaml to clipboard"></img></div><div class=includecode id=service-access-backend-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>backend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>backend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>track</span>:<span style=color:#bbb> </span>stable<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>backend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>track</span>:<span style=color:#bbb> </span>stable<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;gcr.io/google-samples/hello-go-gke:1.0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span></span></span></code></pre></div></div></div><p>Create the backend Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/service/access/backend-deployment.yaml
</span></span></code></pre></div><p>View information about the backend Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe deployment backend
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>Name:                           backend
Namespace:                      default
CreationTimestamp:              Mon, 24 Oct 2016 14:21:02 -0700
Labels:                         app=hello
                                tier=backend
                                track=stable
Annotations:                    deployment.kubernetes.io/revision=1
Selector:                       app=hello,tier=backend,track=stable
Replicas:                       3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:                   RollingUpdate
MinReadySeconds:                0
RollingUpdateStrategy:          1 max unavailable, 1 max surge
Pod Template:
  Labels:       app=hello
                tier=backend
                track=stable
  Containers:
   hello:
    Image:              &#34;gcr.io/google-samples/hello-go-gke:1.0&#34;
    Port:               80/TCP
    Environment:        &lt;none&gt;
    Mounts:             &lt;none&gt;
  Volumes:              &lt;none&gt;
Conditions:
  Type          Status  Reason
  ----          ------  ------
  Available     True    MinimumReplicasAvailable
  Progressing   True    NewReplicaSetAvailable
OldReplicaSets:                 &lt;none&gt;
NewReplicaSet:                  hello-3621623197 (3/3 replicas created)
Events:
...
</code></pre><h2 id=creating-the-hello-service-object>Creating the <code>hello</code> Service object</h2><p>The key to sending requests from a frontend to a backend is the backend
Service. A Service creates a persistent IP address and DNS name entry
so that the backend microservice can always be reached. A Service uses
<a class=glossary-tooltip title='Allows users to filter a list of resources based on labels.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/labels/ target=_blank aria-label=selectors>selectors</a> to find
the Pods that it routes traffic to.</p><p>First, explore the Service configuration file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/access/backend-service.yaml download=service/access/backend-service.yaml><code>service/access/backend-service.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-access-backend-service-yaml")' title="Copy service/access/backend-service.yaml to clipboard"></img></div><div class=includecode id=service-access-backend-service-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>backend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span></span></span></code></pre></div></div></div><p>In the configuration file, you can see that the Service, named <code>hello</code> routes
traffic to Pods that have the labels <code>app: hello</code> and <code>tier: backend</code>.</p><p>Create the backend Service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/service/access/backend-service.yaml
</span></span></code></pre></div><p>At this point, you have a <code>backend</code> Deployment running three replicas of your <code>hello</code>
application, and you have a Service that can route traffic to them. However, this
service is neither available nor resolvable outside the cluster.</p><h2 id=creating-the-frontend>Creating the frontend</h2><p>Now that you have your backend running, you can create a frontend that is accessible
outside the cluster, and connects to the backend by proxying requests to it.</p><p>The frontend sends requests to the backend worker Pods by using the DNS name
given to the backend Service. The DNS name is <code>hello</code>, which is the value
of the <code>name</code> field in the <code>examples/service/access/backend-service.yaml</code>
configuration file.</p><p>The Pods in the frontend Deployment run a nginx image that is configured
to proxy requests to the <code>hello</code> backend Service. Here is the nginx configuration file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/access/frontend-nginx.conf download=service/access/frontend-nginx.conf><code>service/access/frontend-nginx.conf</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-access-frontend-nginx-conf")' title="Copy service/access/frontend-nginx.conf to clipboard"></img></div><div class=includecode id=service-access-frontend-nginx-conf><pre tabindex=0><code class=language-conf data-lang=conf># The identifier Backend is internal to nginx, and used to name this specific upstream
upstream Backend {
    # hello is the internal DNS name used by the backend Service inside Kubernetes
    server hello;
}

server {
    listen 80;

    location / {
        # The following statement will proxy traffic to the upstream named Backend
        proxy_pass http://Backend;
    }
}
</code></pre></div></div><p>Similar to the backend, the frontend has a Deployment and a Service. An important
difference to notice between the backend and frontend services, is that the
configuration for the frontend Service has <code>type: LoadBalancer</code>, which means that
the Service uses a load balancer provisioned by your cloud provider and will be
accessible from outside the cluster.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/access/frontend-service.yaml download=service/access/frontend-service.yaml><code>service/access/frontend-service.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-access-frontend-service-yaml")' title="Copy service/access/frontend-service.yaml to clipboard"></img></div><div class=includecode id=service-access-frontend-service-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;TCP&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span></span></span></code></pre></div></div></div><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/access/frontend-deployment.yaml download=service/access/frontend-deployment.yaml><code>service/access/frontend-deployment.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-access-frontend-deployment-yaml")' title="Copy service/access/frontend-deployment.yaml to clipboard"></img></div><div class=includecode id=service-access-frontend-deployment-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>track</span>:<span style=color:#bbb> </span>stable<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>frontend<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>track</span>:<span style=color:#bbb> </span>stable<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;gcr.io/google-samples/hello-frontend:1.0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>lifecycle</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>preStop</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>exec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/usr/sbin/nginx&#34;</span>,<span style=color:#b44>&#34;-s&#34;</span>,<span style=color:#b44>&#34;quit&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span></span></span></code></pre></div></div></div><p>Create the frontend Deployment and Service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/service/access/frontend-deployment.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/service/access/frontend-service.yaml
</span></span></code></pre></div><p>The output verifies that both resources were created:</p><pre tabindex=0><code>deployment.apps/frontend created
service/frontend created
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The nginx configuration is baked into the
<a href=/examples/service/access/Dockerfile>container image</a>. A better way to do this would
be to use a
<a href=/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMap</a>,
so that you can change the configuration more easily.</div><h2 id=interact-with-the-frontend-service>Interact with the frontend Service</h2><p>Once you've created a Service of type LoadBalancer, you can use this
command to find the external IP:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service frontend --watch
</span></span></code></pre></div><p>This displays the configuration for the <code>frontend</code> Service and watches for
changes. Initially, the external IP is listed as <code>&lt;pending></code>:</p><pre tabindex=0><code>NAME       TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)  AGE
frontend   LoadBalancer   10.51.252.116   &lt;pending&gt;     80/TCP   10s
</code></pre><p>As soon as an external IP is provisioned, however, the configuration updates
to include the new IP under the <code>EXTERNAL-IP</code> heading:</p><pre tabindex=0><code>NAME       TYPE           CLUSTER-IP      EXTERNAL-IP        PORT(S)  AGE
frontend   LoadBalancer   10.51.252.116   XXX.XXX.XXX.XXX    80/TCP   1m
</code></pre><p>That IP can now be used to interact with the <code>frontend</code> service from outside the
cluster.</p><h2 id=send-traffic-through-the-frontend>Send traffic through the frontend</h2><p>The frontend and backend are now connected. You can hit the endpoint
by using the curl command on the external IP of your frontend Service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl http://<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>EXTERNAL_IP</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#080;font-style:italic># replace this with the EXTERNAL-IP you saw earlier</span>
</span></span></code></pre></div><p>The output shows the message generated by the backend:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:green;font-weight:700>&#34;message&#34;</span>:<span style=color:#b44>&#34;Hello&#34;</span>}
</span></span></code></pre></div><h2 id=cleaning-up>Cleaning up</h2><p>To delete the Services, enter this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete services frontend backend
</span></span></code></pre></div><p>To delete the Deployments, the ReplicaSets and the Pods that are running the backend and frontend applications, enter this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deployment frontend backend
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Learn more about <a href=/docs/concepts/services-networking/service/>Services</a></li><li>Learn more about <a href=/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMaps</a></li><li>Learn more about <a href=/docs/concepts/services-networking/dns-pod-service/>DNS for Service and Pods</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-21cd8f87563675fb0278d3694ba9ecb0>10.7 - Create an External Load Balancer</h1><p>This page shows how to create an external load balancer.</p><p>When creating a <a class=glossary-tooltip title='A way to expose an application running on a set of Pods as a network service.' data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=Service>Service</a>, you have
the option of automatically creating a cloud load balancer. This provides an
externally-accessible IP address that sends traffic to the correct port on your cluster
nodes,
<em>provided your cluster runs in a supported environment and is configured with
the correct cloud load balancer provider package</em>.</p><p>You can also use an <a class=glossary-tooltip title='An API object that manages external access to the services in a cluster, typically HTTP.' data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/ingress/ target=_blank aria-label=Ingress>Ingress</a> in place of Service.
For more information, check the <a href=/docs/concepts/services-networking/ingress/>Ingress</a>
documentation.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>Your cluster must be running in a cloud or other environment that already has support
for configuring external load balancers.</p><h2 id=create-a-service>Create a Service</h2><h3 id=create-a-service-from-a-manifest>Create a Service from a manifest</h3><p>To create an external load balancer, add the following line to your
Service manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span></code></pre></div><p>Your manifest might then look like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8765</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>9376</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=create-a-service-using-kubectl>Create a Service using kubectl</h3><p>You can alternatively create the service with the <code>kubectl expose</code> command and
its <code>--type=LoadBalancer</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl expose deployment example --port<span style=color:#666>=</span><span style=color:#666>8765</span> --target-port<span style=color:#666>=</span><span style=color:#666>9376</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>        --name<span style=color:#666>=</span>example-service --type<span style=color:#666>=</span>LoadBalancer
</span></span></code></pre></div><p>This command creates a new Service using the same selectors as the referenced
resource (in the case of the example above, a
<a class=glossary-tooltip title='Manages a replicated application on your cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/deployment/ target=_blank aria-label=Deployment>Deployment</a> named <code>example</code>).</p><p>For more information, including optional flags, refer to the
<a href=/docs/reference/generated/kubectl/kubectl-commands/#expose><code>kubectl expose</code> reference</a>.</p><h2 id=finding-your-ip-address>Finding your IP address</h2><p>You can find the IP address created for your service by getting the service
information through <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl describe services example-service
</span></span></code></pre></div><p>which should produce output similar to:</p><pre tabindex=0><code>Name:                     example-service
Namespace:                default
Labels:                   app=example
Annotations:              &lt;none&gt;
Selector:                 app=example
Type:                     LoadBalancer
IP Families:              &lt;none&gt;
IP:                       10.3.22.96
IPs:                      10.3.22.96
LoadBalancer Ingress:     192.0.2.89
Port:                     &lt;unset&gt;  8765/TCP
TargetPort:               9376/TCP
NodePort:                 &lt;unset&gt;  30593/TCP
Endpoints:                172.17.0.3:9376
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &lt;none&gt;
</code></pre><p>The load balancer's IP address is listed next to <code>LoadBalancer Ingress</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>If you are running your service on Minikube, you can find the assigned IP address and port with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>minikube service example-service --url
</span></span></code></pre></div></div><h2 id=preserving-the-client-source-ip>Preserving the client source IP</h2><p>By default, the source IP seen in the target container is <em>not the original
source IP</em> of the client. To enable preservation of the client IP, the following
fields can be configured in the <code>.spec</code> of the Service:</p><ul><li><code>.spec.externalTrafficPolicy</code> - denotes if this Service desires to route
external traffic to node-local or cluster-wide endpoints. There are two available
options: <code>Cluster</code> (default) and <code>Local</code>. <code>Cluster</code> obscures the client source
IP and may cause a second hop to another node, but should have good overall
load-spreading. <code>Local</code> preserves the client source IP and avoids a second hop
for LoadBalancer and NodePort type Services, but risks potentially imbalanced
traffic spreading.</li><li><code>.spec.healthCheckNodePort</code> - specifies the health check node port
(numeric port number) for the service. If you don't specify
<code>healthCheckNodePort</code>, the service controller allocates a port from your
cluster's NodePort range.<br>You can configure that range by setting an API server command line option,
<code>--service-node-port-range</code>. The Service will use the user-specified
<code>healthCheckNodePort</code> value if you specify it, provided that the
Service <code>type</code> is set to LoadBalancer and <code>externalTrafficPolicy</code> is set
to <code>Local</code>.</li></ul><p>Setting <code>externalTrafficPolicy</code> to Local in the Service manifest
activates this feature. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8765</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>9376</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>externalTrafficPolicy</span>:<span style=color:#bbb> </span>Local<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=caveats-and-limitations-when-preserving-source-ips>Caveats and limitations when preserving source IPs</h3><p>Load balancing services from some cloud providers do not let you configure different weights for each target.</p><p>With each target weighted equally in terms of sending traffic to Nodes, external
traffic is not equally load balanced across different Pods. The external load balancer
is unaware of the number of Pods on each node that are used as a target.</p><p>Where <code>NumServicePods &lt;&lt; _NumNodes</code> or <code>NumServicePods >> NumNodes</code>, a fairly close-to-equal
distribution will be seen, even without weights.</p><p>Internal pod to pod traffic should behave similar to ClusterIP services, with equal probability across all pods.</p><h2 id=garbage-collecting-load-balancers>Garbage collecting load balancers</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.17 [stable]</code></div><p>In usual case, the correlating load balancer resources in cloud provider should
be cleaned up soon after a LoadBalancer type Service is deleted. But it is known
that there are various corner cases where cloud resources are orphaned after the
associated Service is deleted. Finalizer Protection for Service LoadBalancers was
introduced to prevent this from happening. By using finalizers, a Service resource
will never be deleted until the correlating load balancer resources are also deleted.</p><p>Specifically, if a Service has <code>type</code> LoadBalancer, the service controller will attach
a finalizer named <code>service.kubernetes.io/load-balancer-cleanup</code>.
The finalizer will only be removed after the load balancer resource is cleaned up.
This prevents dangling load balancer resources even in corner cases such as the
service controller crashing.</p><h2 id=external-load-balancer-providers>External load balancer providers</h2><p>It is important to note that the datapath for this functionality is provided by a load balancer external to the Kubernetes cluster.</p><p>When the Service <code>type</code> is set to LoadBalancer, Kubernetes provides functionality equivalent to <code>type</code> equals ClusterIP to pods
within the cluster and extends it by programming the (external to Kubernetes) load balancer with entries for the nodes
hosting the relevant Kubernetes pods. The Kubernetes control plane automates the creation of the external load balancer,
health checks (if needed), and packet filtering rules (if needed). Once the cloud provider allocates an IP address for the load
balancer, the control plane looks up that external IP address and populates it into the Service object.</p><h2 id=what-s-next>What's next</h2><ul><li>Follow the <a href=/docs/tutorials/services/connect-applications-service/>Connecting Applications with Services</a> tutorial</li><li>Read about <a href=/docs/concepts/services-networking/service/>Service</a></li><li>Read about <a href=/docs/concepts/services-networking/ingress/>Ingress</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-48e8f306f919c5b81265e265a2b76ab4>10.8 - List All Container Images Running in a Cluster</h1><p>This page shows how to use kubectl to list all of the Container images
for Pods running in a cluster.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><p>In this exercise you will use kubectl to fetch all of the Pods
running in a cluster, and format the output to pull out the list
of Containers for each.</p><h2 id=list-all-container-images-in-all-namespaces>List all Container images in all namespaces</h2><ul><li>Fetch all Pods in all namespaces using <code>kubectl get pods --all-namespaces</code></li><li>Format the output to include only the list of Container image names
using <code>-o jsonpath={.items[*].spec.containers[*].image}</code>. This will recursively parse out the
<code>image</code> field from the returned json.<ul><li>See the <a href=/docs/reference/kubectl/jsonpath/>jsonpath reference</a>
for further information on how to use jsonpath.</li></ul></li><li>Format the output using standard tools: <code>tr</code>, <code>sort</code>, <code>uniq</code><ul><li>Use <code>tr</code> to replace spaces with newlines</li><li>Use <code>sort</code> to sort the results</li><li>Use <code>uniq</code> to aggregate image counts</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --all-namespaces -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{.items[*].spec.containers[*].image}&#34;</span> |<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>tr -s <span style=color:#b44>&#39;[[:space:]]&#39;</span> <span style=color:#b44>&#39;\n&#39;</span> |<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>sort |<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>uniq -c
</span></span></code></pre></div><p>The jsonpath is interpreted as follows:</p><ul><li><code>.items[*]</code>: for each returned value</li><li><code>.spec</code>: get the spec</li><li><code>.containers[*]</code>: for each container</li><li><code>.image</code>: get the image</li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> When fetching a single Pod by name, for example <code>kubectl get pod nginx</code>,
the <code>.items[*]</code> portion of the path should be omitted because a single
Pod is returned instead of a list of items.</div><h2 id=list-container-images-by-pod>List Container images by Pod</h2><p>The formatting can be controlled further by using the <code>range</code> operation to
iterate over elements individually.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --all-namespaces -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{range .items[*]}{&#34;\n&#34;}{.metadata.name}{&#34;:\t&#34;}{range .spec.containers[*]}{.image}{&#34;, &#34;}{end}{end}&#39;</span> |<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>sort
</span></span></code></pre></div><h2 id=list-container-images-filtering-by-pod-label>List Container images filtering by Pod label</h2><p>To target only Pods matching a specific label, use the -l flag. The
following matches only Pods with labels matching <code>app=nginx</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --all-namespaces -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{.items[*].spec.containers[*].image}&#34;</span> -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>nginx
</span></span></code></pre></div><h2 id=list-container-images-filtering-by-pod-namespace>List Container images filtering by Pod namespace</h2><p>To target only pods in a specific namespace, use the namespace flag. The
following matches only Pods in the <code>kube-system</code> namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --namespace kube-system -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#34;{.items[*].spec.containers[*].image}&#34;</span>
</span></span></code></pre></div><h2 id=list-container-images-using-a-go-template-instead-of-jsonpath>List Container images using a go-template instead of jsonpath</h2><p>As an alternative to jsonpath, Kubectl supports using <a href=https://golang.org/pkg/text/template/>go-templates</a>
for formatting the output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --all-namespaces -o go-template --template<span style=color:#666>=</span><span style=color:#b44>&#34;{{range .items}}{{range .spec.containers}}{{.image}} {{end}}{{end}}&#34;</span>
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><h3 id=reference>Reference</h3><ul><li><a href=/docs/reference/kubectl/jsonpath/>Jsonpath</a> reference guide</li><li><a href=https://golang.org/pkg/text/template/>Go template</a> reference guide</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1839d8468a083839ed1cc8d18fe1142e>10.9 - Set up Ingress on Minikube with the NGINX Ingress Controller</h1><p>An <a href=/docs/concepts/services-networking/ingress/>Ingress</a> is an API object that defines rules which allow external access
to services in a cluster. An <a href=/docs/concepts/services-networking/ingress-controllers/>Ingress controller</a> fulfills the rules set in the Ingress.</p><p>This page shows you how to set up a simple Ingress which routes requests to Service web or web2 depending on the HTTP URI.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.19.
To check the version, enter <code>kubectl version</code>.
If you are using an older Kubernetes version, switch to the documentation
for that version.</p><h3 id=create-a-minikube-cluster>Create a Minikube cluster</h3><dl><dt>Using Katacoda</dt><dd><script defer src=https://katacoda.com/embed.js></script>
<button class=button onclick=window.katacoda.init()>Launch Terminal</button></dd><dt>Locally</dt><dd>If you already <a href=/docs/tasks/tools/#minikube>installed Minikube</a>
locally, run <code>minikube start</code> to create a cluster.</dd></dl><h2 id=enable-the-ingress-controller>Enable the Ingress controller</h2><ol><li><p>To enable the NGINX Ingress controller, run the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube addons <span style=color:#a2f>enable</span> ingress
</span></span></code></pre></div></li><li><p>Verify that the NGINX Ingress controller is running</p><ul class="nav nav-tabs" id=tab-with-md role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tab-with-md-0 role=tab aria-controls=tab-with-md-0 aria-selected=true>minikube v1.19 or later</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-with-md-1 role=tab aria-controls=tab-with-md-1>minikube v1.18.1 or earlier</a></li></ul><div class=tab-content id=tab-with-md><div id=tab-with-md-0 class="tab-pane show active" role=tabpanel aria-labelledby=tab-with-md-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -n ingress-nginx
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> It can take up to a minute before you see these pods running OK.</div><p>The output is similar to:</p><pre tabindex=0><code>NAME                                        READY   STATUS      RESTARTS    AGE
ingress-nginx-admission-create-g9g49        0/1     Completed   0          11m
ingress-nginx-admission-patch-rqp78         0/1     Completed   1          11m
ingress-nginx-controller-59b45fb494-26npt   1/1     Running     0          11m
</code></pre></div><div id=tab-with-md-1 class=tab-pane role=tabpanel aria-labelledby=tab-with-md-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -n kube-system
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> It can take up to a minute before you see these pods running OK.</div><p>The output is similar to:</p><pre tabindex=0><code>NAME                                        READY     STATUS    RESTARTS   AGE
default-http-backend-59868b7dd6-xb8tq       1/1       Running   0          1m
kube-addon-manager-minikube                 1/1       Running   0          3m
kube-dns-6dcb57bcc8-n4xd4                   3/3       Running   0          2m
kubernetes-dashboard-5498ccf677-b8p5h       1/1       Running   0          2m
nginx-ingress-controller-5984b97644-rnkrg   1/1       Running   0          1m
storage-provisioner                         1/1       Running   0          2m
</code></pre><p>Make sure that you see a Pod with a name that starts with <code>nginx-ingress-controller-</code>.</p></div></div></li></ol><h2 id=deploy-a-hello-world-app>Deploy a hello, world app</h2><ol><li><p>Create a Deployment using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create deployment web --image<span style=color:#666>=</span>gcr.io/google-samples/hello-app:1.0
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>deployment.apps/web created
</code></pre></li><li><p>Expose the Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl expose deployment web --type<span style=color:#666>=</span>NodePort --port<span style=color:#666>=</span><span style=color:#666>8080</span>
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>service/web exposed
</code></pre></li><li><p>Verify the Service is created and is available on a node port:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service web
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>NAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
web       NodePort   10.104.133.249   &lt;none&gt;        8080:31637/TCP   12m
</code></pre></li><li><p>Visit the Service via NodePort:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>minikube service web --url
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>http://172.17.0.15:31637
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Katacoda environment only: at the top of the terminal panel, click the plus sign, and then click <strong>Select port to view on Host 1</strong>. Enter the NodePort, in this case <code>31637</code>, and then click <strong>Display Port</strong>.</div><p>The output is similar to:</p><pre tabindex=0><code>Hello, world!
Version: 1.0.0
Hostname: web-55b8c6998d-8k564
</code></pre><p>You can now access the sample app via the Minikube IP address and NodePort. The next step lets you access
the app using the Ingress resource.</p></li></ol><h2 id=create-an-ingress>Create an Ingress</h2><p>The following manifest defines an Ingress that sends traffic to your Service via hello-world.info.</p><ol><li><p>Create <code>example-ingress.yaml</code> from the following file:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/example-ingress.yaml download=service/networking/example-ingress.yaml><code>service/networking/example-ingress.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-networking-example-ingress-yaml")' title="Copy service/networking/example-ingress.yaml to clipboard"></img></div><div class=includecode id=service-networking-example-ingress-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>networking.k8s.io/v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Ingress<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-ingress<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>nginx.ingress.kubernetes.io/rewrite-target</span>:<span style=color:#bbb> </span>/$1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>host</span>:<span style=color:#bbb> </span>hello-world.info<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>http</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>paths</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>pathType</span>:<span style=color:#bbb> </span>Prefix<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>backend</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>web<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>number</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span></span></span></code></pre></div></div></div></li><li><p>Create the Ingress object by running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/service/networking/example-ingress.yaml
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>ingress.networking.k8s.io/example-ingress created
</code></pre></li><li><p>Verify the IP address is set:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get ingress
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This can take a couple of minutes.</div><p>You should see an IPv4 address in the ADDRESS column; for example:</p><pre tabindex=0><code>NAME              CLASS    HOSTS              ADDRESS        PORTS   AGE
example-ingress   &lt;none&gt;   hello-world.info   172.17.0.15    80      38s
</code></pre></li><li><p>Add the following line to the bottom of the <code>/etc/hosts</code> file on
your computer (you will need administrator access):</p><pre tabindex=0><code>172.17.0.15 hello-world.info
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you are running Minikube locally, use <code>minikube ip</code> to get the external IP. The IP address displayed within the ingress list will be the internal IP.</div><p>After you make this change, your web browser sends requests for
hello-world.info URLs to Minikube.</p></li><li><p>Verify that the Ingress controller is directing traffic:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl hello-world.info
</span></span></code></pre></div><p>You should see:</p><pre tabindex=0><code>Hello, world!
Version: 1.0.0
Hostname: web-55b8c6998d-8k564
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you are running Minikube locally, you can visit hello-world.info from your browser.</div></li></ol><h2 id=create-a-second-deployment>Create a second Deployment</h2><ol><li><p>Create another Deployment using the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create deployment web2 --image<span style=color:#666>=</span>gcr.io/google-samples/hello-app:2.0
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>deployment.apps/web2 created
</code></pre></li><li><p>Expose the second Deployment:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl expose deployment web2 --port<span style=color:#666>=</span><span style=color:#666>8080</span> --type<span style=color:#666>=</span>NodePort
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>service/web2 exposed
</code></pre></li></ol><h2 id=edit-ingress>Edit the existing Ingress</h2><ol><li><p>Edit the existing <code>example-ingress.yaml</code> manifest, and add the
following lines at the end:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/v2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>pathType</span>:<span style=color:#bbb> </span>Prefix<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>backend</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>web2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>number</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span><span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>Apply the changes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f example-ingress.yaml
</span></span></code></pre></div><p>You should see:</p><pre tabindex=0><code>ingress.networking/example-ingress configured
</code></pre></li></ol><h2 id=test-your-ingress>Test your Ingress</h2><ol><li><p>Access the 1st version of the Hello World app.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl hello-world.info
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>Hello, world!
Version: 1.0.0
Hostname: web-55b8c6998d-8k564
</code></pre></li><li><p>Access the 2nd version of the Hello World app.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl hello-world.info/v2
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>Hello, world!
Version: 2.0.0
Hostname: web2-75cd47646f-t8cjk
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you are running Minikube locally, you can visit hello-world.info and hello-world.info/v2 from your browser.</div></li></ol><h2 id=what-s-next>What's next</h2><ul><li>Read more about <a href=/docs/concepts/services-networking/ingress/>Ingress</a></li><li>Read more about <a href=/docs/concepts/services-networking/ingress-controllers/>Ingress Controllers</a></li><li>Read more about <a href=/docs/concepts/services-networking/service/>Services</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7c319a9981586e5fbcfa21b392720650>10.10 - Communicate Between Containers in the Same Pod Using a Shared Volume</h1><p>This page shows how to use a Volume to communicate between two Containers running
in the same Pod. See also how to allow processes to communicate by
<a href=/docs/tasks/configure-pod-container/share-process-namespace/>sharing process namespace</a>
between containers.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=creating-a-pod-that-runs-two-containers>Creating a Pod that runs two Containers</h2><p>In this exercise, you create a Pod that runs two Containers. The two containers
share a Volume that they can use to communicate. Here is the configuration file
for the Pod:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/two-container-pod.yaml download=pods/two-container-pod.yaml><code>pods/two-container-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-two-container-pod-yaml")' title="Copy pods/two-container-pod.yaml to clipboard"></img></div><div class=includecode id=pods-two-container-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>two-containers<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>shared-data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>nginx-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>shared-data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/usr/share/nginx/html<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>debian-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>debian<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>shared-data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/pod-data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/bin/sh&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;echo Hello from the debian container &gt; /pod-data/index.html&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the configuration file, you can see that the Pod has a Volume named
<code>shared-data</code>.</p><p>The first container listed in the configuration file runs an nginx server. The
mount path for the shared Volume is <code>/usr/share/nginx/html</code>.
The second container is based on the debian image, and has a mount path of
<code>/pod-data</code>. The second container runs the following command and then terminates.</p><pre><code>echo Hello from the debian container &gt; /pod-data/index.html
</code></pre><p>Notice that the second container writes the <code>index.html</code> file in the root
directory of the nginx server.</p><p>Create the Pod and the two Containers:</p><pre><code>kubectl apply -f https://k8s.io/examples/pods/two-container-pod.yaml
</code></pre><p>View information about the Pod and the Containers:</p><pre><code>kubectl get pod two-containers --output=yaml
</code></pre><p>Here is a portion of the output:</p><pre><code>apiVersion: v1
kind: Pod
metadata:
  ...
  name: two-containers
  namespace: default
  ...
spec:
  ...
  containerStatuses:

  - containerID: docker://c1d8abd1 ...
    image: debian
    ...
    lastState:
      terminated:
        ...
    name: debian-container
    ...

  - containerID: docker://96c1ff2c5bb ...
    image: nginx
    ...
    name: nginx-container
    ...
    state:
      running:
    ...
</code></pre><p>You can see that the debian Container has terminated, and the nginx Container
is still running.</p><p>Get a shell to nginx Container:</p><pre><code>kubectl exec -it two-containers -c nginx-container -- /bin/bash
</code></pre><p>In your shell, verify that nginx is running:</p><pre><code>root@two-containers:/# apt-get update
root@two-containers:/# apt-get install curl procps
root@two-containers:/# ps aux
</code></pre><p>The output is similar to this:</p><pre><code>USER       PID  ...  STAT START   TIME COMMAND
root         1  ...  Ss   21:12   0:00 nginx: master process nginx -g daemon off;
</code></pre><p>Recall that the debian Container created the <code>index.html</code> file in the nginx root
directory. Use <code>curl</code> to send a GET request to the nginx server:</p><pre tabindex=0><code>root@two-containers:/# curl localhost
</code></pre><p>The output shows that nginx serves a web page written by the debian container:</p><pre tabindex=0><code>Hello from the debian container
</code></pre><h2 id=discussion>Discussion</h2><p>The primary reason that Pods can have multiple containers is to support
helper applications that assist a primary application. Typical examples of
helper applications are data pullers, data pushers, and proxies.
Helper and primary applications often need to communicate with each other.
Typically this is done through a shared filesystem, as shown in this exercise,
or through the loopback network interface, localhost. An example of this pattern is a
web server along with a helper program that polls a Git repository for new updates.</p><p>The Volume in this exercise provides a way for Containers to communicate during
the life of the Pod. If the Pod is deleted and recreated, any data stored in
the shared Volume is lost.</p><h2 id=what-s-next>What's next</h2><ul><li><p>Learn more about <a href=/blog/2015/06/the-distributed-system-toolkit-patterns/>patterns for composite containers</a>.</p></li><li><p>Learn about <a href=https://www.slideshare.net/Docker/slideshare-burns>composite containers for modular architecture</a>.</p></li><li><p>See <a href=/docs/tasks/configure-pod-container/configure-volume-storage/>Configuring a Pod to Use a Volume for Storage</a>.</p></li><li><p>See <a href=/docs/tasks/configure-pod-container/share-process-namespace/>Configure a Pod to share process namespace between containers in a Pod</a></p></li><li><p>See <a href=/docs/reference/generated/kubernetes-api/v1.25/#volume-v1-core>Volume</a>.</p></li><li><p>See <a href=/docs/reference/generated/kubernetes-api/v1.25/#pod-v1-core>Pod</a>.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-322786b38586b210fab68f785259c5f6>10.11 - Configure DNS for a Cluster</h1><p>Kubernetes offers a DNS cluster addon, which most of the supported environments enable by default. In Kubernetes version 1.11 and later, CoreDNS is recommended and is installed by default with kubeadm.</p><p>For more information on how to configure CoreDNS for a Kubernetes cluster, see the <a href=/docs/tasks/administer-cluster/dns-custom-nameservers/>Customizing DNS Service</a>. An example demonstrating how to use Kubernetes DNS with kube-dns, see the <a href=https://github.com/kubernetes/examples/tree/master/staging/cluster-dns>Kubernetes DNS sample plugin</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-43591bb11cc02c39e278cf07f6546810>10.12 - Access Services Running on Clusters</h1><p>This page shows how to connect to services running on the Kubernetes cluster.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=accessing-services-running-on-the-cluster>Accessing services running on the cluster</h2><p>In Kubernetes, <a href=/docs/concepts/architecture/nodes/>nodes</a>,
<a href=/docs/concepts/workloads/pods/>pods</a> and <a href=/docs/concepts/services-networking/service/>services</a> all have
their own IPs. In many cases, the node IPs, pod IPs, and some service IPs on a cluster will not be
routable, so they will not be reachable from a machine outside the cluster,
such as your desktop machine.</p><h3 id=ways-to-connect>Ways to connect</h3><p>You have several options for connecting to nodes, pods and services from outside the cluster:</p><ul><li>Access services through public IPs.<ul><li>Use a service with type <code>NodePort</code> or <code>LoadBalancer</code> to make the service reachable outside
the cluster. See the <a href=/docs/concepts/services-networking/service/>services</a> and
<a href=/docs/reference/generated/kubectl/kubectl-commands/#expose>kubectl expose</a> documentation.</li><li>Depending on your cluster environment, this may only expose the service to your corporate network,
or it may expose it to the internet. Think about whether the service being exposed is secure.
Does it do its own authentication?</li><li>Place pods behind services. To access one specific pod from a set of replicas, such as for debugging,
place a unique label on the pod and create a new service which selects this label.</li><li>In most cases, it should not be necessary for application developer to directly access
nodes via their nodeIPs.</li></ul></li><li>Access services, nodes, or pods using the Proxy Verb.<ul><li>Does apiserver authentication and authorization prior to accessing the remote service.
Use this if the services are not secure enough to expose to the internet, or to gain
access to ports on the node IP, or for debugging.</li><li>Proxies may cause problems for some web applications.</li><li>Only works for HTTP/HTTPS.</li><li>Described <a href=#manually-constructing-apiserver-proxy-urls>here</a>.</li></ul></li><li>Access from a node or pod in the cluster.<ul><li>Run a pod, and then connect to a shell in it using <a href=/docs/reference/generated/kubectl/kubectl-commands/#exec>kubectl exec</a>.
Connect to other nodes, pods, and services from that shell.</li><li>Some clusters may allow you to ssh to a node in the cluster. From there you may be able to
access cluster services. This is a non-standard method, and will work on some clusters but
not others. Browsers and other tools may or may not be installed. Cluster DNS may not work.</li></ul></li></ul><h3 id=discovering-builtin-services>Discovering builtin services</h3><p>Typically, there are several services which are started on a cluster by kube-system. Get a list of these
with the <code>kubectl cluster-info</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>Kubernetes master is running at https://192.0.2.1
elasticsearch-logging is running at https://192.0.2.1/api/v1/namespaces/kube-system/services/elasticsearch-logging/proxy
kibana-logging is running at https://192.0.2.1/api/v1/namespaces/kube-system/services/kibana-logging/proxy
kube-dns is running at https://192.0.2.1/api/v1/namespaces/kube-system/services/kube-dns/proxy
grafana is running at https://192.0.2.1/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy
heapster is running at https://192.0.2.1/api/v1/namespaces/kube-system/services/monitoring-heapster/proxy
</code></pre><p>This shows the proxy-verb URL for accessing each service.
For example, this cluster has cluster-level logging enabled (using Elasticsearch), which can be reached
at <code>https://192.0.2.1/api/v1/namespaces/kube-system/services/elasticsearch-logging/proxy/</code> if suitable credentials are passed, or through a kubectl proxy at, for example:
<code>http://localhost:8080/api/v1/namespaces/kube-system/services/elasticsearch-logging/proxy/</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> See <a href=/docs/tasks/administer-cluster/access-cluster-api/#accessing-the-cluster-api>Access Clusters Using the Kubernetes API</a> for how to pass credentials or use kubectl proxy.</div><h4 id=manually-constructing-apiserver-proxy-urls>Manually constructing apiserver proxy URLs</h4><p>As mentioned above, you use the <code>kubectl cluster-info</code> command to retrieve the service's proxy URL. To create proxy URLs that include service endpoints, suffixes, and parameters, you append to the service's proxy URL:
<code>http://</code><em><code>kubernetes_master_address</code></em><code>/api/v1/namespaces/</code><em><code>namespace_name</code></em><code>/services/</code><em><code>[https:]service_name[:port_name]</code></em><code>/proxy</code></p><p>If you haven't specified a name for your port, you don't have to specify <em>port_name</em> in the URL. You can also use the port number in place of the <em>port_name</em> for both named and unnamed ports.</p><p>By default, the API server proxies to your service using HTTP. To use HTTPS, prefix the service name with <code>https:</code>:
<code>http://&lt;kubernetes_master_address>/api/v1/namespaces/&lt;namespace_name>/services/&lt;service_name>/proxy</code></p><p>The supported formats for the <code>&lt;service_name></code> segment of the URL are:</p><ul><li><code>&lt;service_name></code> - proxies to the default or unnamed port using http</li><li><code>&lt;service_name>:&lt;port_name></code> - proxies to the specified port name or port number using http</li><li><code>https:&lt;service_name>:</code> - proxies to the default or unnamed port using https (note the trailing colon)</li><li><code>https:&lt;service_name>:&lt;port_name></code> - proxies to the specified port name or port number using https</li></ul><h5 id=examples>Examples</h5><ul><li><p>To access the Elasticsearch service endpoint <code>_search?q=user:kimchy</code>, you would use:</p><pre tabindex=0><code>http://192.0.2.1/api/v1/namespaces/kube-system/services/elasticsearch-logging/proxy/_search?q=user:kimchy
</code></pre></li><li><p>To access the Elasticsearch cluster health information <code>_cluster/health?pretty=true</code>, you would use:</p><pre tabindex=0><code>https://192.0.2.1/api/v1/namespaces/kube-system/services/elasticsearch-logging/proxy/_cluster/health?pretty=true
</code></pre><p>The health information is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;cluster_name&#34;</span> : <span style=color:#b44>&#34;kubernetes_logging&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;status&#34;</span> : <span style=color:#b44>&#34;yellow&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;timed_out&#34;</span> : <span style=color:#a2f;font-weight:700>false</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;number_of_nodes&#34;</span> : <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;number_of_data_nodes&#34;</span> : <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;active_primary_shards&#34;</span> : <span style=color:#666>5</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;active_shards&#34;</span> : <span style=color:#666>5</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;relocating_shards&#34;</span> : <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;initializing_shards&#34;</span> : <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;unassigned_shards&#34;</span> : <span style=color:#666>5</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>To access the <em>https</em> Elasticsearch service health information <code>_cluster/health?pretty=true</code>, you would use:</p><pre tabindex=0><code>https://192.0.2.1/api/v1/namespaces/kube-system/services/https:elasticsearch-logging:/proxy/_cluster/health?pretty=true
</code></pre></li></ul><h4 id=using-web-browsers-to-access-services-running-on-the-cluster>Using web browsers to access services running on the cluster</h4><p>You may be able to put an apiserver proxy URL into the address bar of a browser. However:</p><ul><li>Web browsers cannot usually pass tokens, so you may need to use basic (password) auth. Apiserver can be configured to accept basic auth,
but your cluster may not be configured to accept basic auth.</li><li>Some web apps may not work, particularly those with client side javascript that construct URLs in a
way that is unaware of the proxy path prefix.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-11a6d16334428909c99e7208ab8fa5e9>11 - Extend Kubernetes</h1><div class=lead>Understand advanced ways to adapt your Kubernetes cluster to the needs of your work environment.</div></div><div class=td-content><h1 id=pg-2bd28753e62a14a597073fa8ea18a5d8>11.1 - Configure the Aggregation Layer</h1><p>Configuring the <a href=/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>aggregation layer</a> allows the Kubernetes apiserver to be extended with additional APIs, which are not part of the core Kubernetes APIs.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> There are a few setup requirements for getting the aggregation layer working in your environment to support mutual TLS auth between the proxy and extension apiservers. Kubernetes and the kube-apiserver have multiple CAs, so make sure that the proxy is signed by the aggregation layer CA and not by something else, like the Kubernetes general CA.</div><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Reusing the same CA for different client types can negatively impact the cluster's ability to function. For more information, see <a href=#ca-reusage-and-conflicts>CA Reusage and Conflicts</a>.</div><h2 id=authentication-flow>Authentication Flow</h2><p>Unlike Custom Resource Definitions (CRDs), the Aggregation API involves another server - your Extension apiserver - in addition to the standard Kubernetes apiserver. The Kubernetes apiserver will need to communicate with your extension apiserver, and your extension apiserver will need to communicate with the Kubernetes apiserver. In order for this communication to be secured, the Kubernetes apiserver uses x509 certificates to authenticate itself to the extension apiserver.</p><p>This section describes how the authentication and authorization flows work, and how to configure them.</p><p>The high-level flow is as follows:</p><ol><li>Kubernetes apiserver: authenticate the requesting user and authorize their rights to the requested API path.</li><li>Kubernetes apiserver: proxy the request to the extension apiserver</li><li>Extension apiserver: authenticate the request from the Kubernetes apiserver</li><li>Extension apiserver: authorize the request from the original user</li><li>Extension apiserver: execute</li></ol><p>The rest of this section describes these steps in detail.</p><p>The flow can be seen in the following diagram.</p><p><img src=/images/docs/aggregation-api-auth-flow.png alt="aggregation auth flows">.</p><p>The source for the above swimlanes can be found in the source of this document.</p><h3 id=kubernetes-apiserver-authentication-and-authorization>Kubernetes Apiserver Authentication and Authorization</h3><p>A request to an API path that is served by an extension apiserver begins the same way as all API requests: communication to the Kubernetes apiserver. This path already has been registered with the Kubernetes apiserver by the extension apiserver.</p><p>The user communicates with the Kubernetes apiserver, requesting access to the path. The Kubernetes apiserver uses standard authentication and authorization configured with the Kubernetes apiserver to authenticate the user and authorize access to the specific path.</p><p>For an overview of authenticating to a Kubernetes cluster, see <a href=/docs/reference/access-authn-authz/authentication/>"Authenticating to a Cluster"</a>. For an overview of authorization of access to Kubernetes cluster resources, see <a href=/docs/reference/access-authn-authz/authorization/>"Authorization Overview"</a>.</p><p>Everything to this point has been standard Kubernetes API requests, authentication and authorization.</p><p>The Kubernetes apiserver now is prepared to send the request to the extension apiserver.</p><h3 id=kubernetes-apiserver-proxies-the-request>Kubernetes Apiserver Proxies the Request</h3><p>The Kubernetes apiserver now will send, or proxy, the request to the extension apiserver that registered to handle the request. In order to do so, it needs to know several things:</p><ol><li>How should the Kubernetes apiserver authenticate to the extension apiserver, informing the extension apiserver that the request, which comes over the network, is coming from a valid Kubernetes apiserver?</li><li>How should the Kubernetes apiserver inform the extension apiserver of the username and group for which the original request was authenticated?</li></ol><p>In order to provide for these two, you must configure the Kubernetes apiserver using several flags.</p><h4 id=kubernetes-apiserver-client-authentication>Kubernetes Apiserver Client Authentication</h4><p>The Kubernetes apiserver connects to the extension apiserver over TLS, authenticating itself using a client certificate. You must provide the following to the Kubernetes apiserver upon startup, using the provided flags:</p><ul><li>private key file via <code>--proxy-client-key-file</code></li><li>signed client certificate file via <code>--proxy-client-cert-file</code></li><li>certificate of the CA that signed the client certificate file via <code>--requestheader-client-ca-file</code></li><li>valid Common Name values (CNs) in the signed client certificate via <code>--requestheader-allowed-names</code></li></ul><p>The Kubernetes apiserver will use the files indicated by <code>--proxy-client-*-file</code> to authenticate to the extension apiserver. In order for the request to be considered valid by a compliant extension apiserver, the following conditions must be met:</p><ol><li>The connection must be made using a client certificate that is signed by the CA whose certificate is in <code>--requestheader-client-ca-file</code>.</li><li>The connection must be made using a client certificate whose CN is one of those listed in <code>--requestheader-allowed-names</code>.</li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> You can set this option to blank as <code>--requestheader-allowed-names=""</code>. This will indicate to an extension apiserver that <em>any</em> CN is acceptable.</div><p>When started with these options, the Kubernetes apiserver will:</p><ol><li>Use them to authenticate to the extension apiserver.</li><li>Create a configmap in the <code>kube-system</code> namespace called <code>extension-apiserver-authentication</code>, in which it will place the CA certificate and the allowed CNs. These in turn can be retrieved by extension apiservers to validate requests.</li></ol><p>Note that the same client certificate is used by the Kubernetes apiserver to authenticate against <em>all</em> extension apiservers. It does not create a client certificate per extension apiserver, but rather a single one to authenticate as the Kubernetes apiserver. This same one is reused for all extension apiserver requests.</p><h4 id=original-request-username-and-group>Original Request Username and Group</h4><p>When the Kubernetes apiserver proxies the request to the extension apiserver, it informs the extension apiserver of the username and group with which the original request successfully authenticated. It provides these in http headers of its proxied request. You must inform the Kubernetes apiserver of the names of the headers to be used.</p><ul><li>the header in which to store the username via <code>--requestheader-username-headers</code></li><li>the header in which to store the group via <code>--requestheader-group-headers</code></li><li>the prefix to append to all extra headers via <code>--requestheader-extra-headers-prefix</code></li></ul><p>These header names are also placed in the <code>extension-apiserver-authentication</code> configmap, so they can be retrieved and used by extension apiservers.</p><h3 id=extension-apiserver-authenticates-the-request>Extension Apiserver Authenticates the Request</h3><p>The extension apiserver, upon receiving a proxied request from the Kubernetes apiserver, must validate that the request actually did come from a valid authenticating proxy, which role the Kubernetes apiserver is fulfilling. The extension apiserver validates it via:</p><ol><li>Retrieve the following from the configmap in <code>kube-system</code>, as described above:<ul><li>Client CA certificate</li><li>List of allowed names (CNs)</li><li>Header names for username, group and extra info</li></ul></li><li>Check that the TLS connection was authenticated using a client certificate which:<ul><li>Was signed by the CA whose certificate matches the retrieved CA certificate.</li><li>Has a CN in the list of allowed CNs, unless the list is blank, in which case all CNs are allowed.</li><li>Extract the username and group from the appropriate headers</li></ul></li></ol><p>If the above passes, then the request is a valid proxied request from a legitimate authenticating proxy, in this case the Kubernetes apiserver.</p><p>Note that it is the responsibility of the extension apiserver implementation to provide the above. Many do it by default, leveraging the <code>k8s.io/apiserver/</code> package. Others may provide options to override it using command-line options.</p><p>In order to have permission to retrieve the configmap, an extension apiserver requires the appropriate role. There is a default role named <code>extension-apiserver-authentication-reader</code> in the <code>kube-system</code> namespace which can be assigned.</p><h3 id=extension-apiserver-authorizes-the-request>Extension Apiserver Authorizes the Request</h3><p>The extension apiserver now can validate that the user/group retrieved from the headers are authorized to execute the given request. It does so by sending a standard <a href=/docs/reference/access-authn-authz/authorization/>SubjectAccessReview</a> request to the Kubernetes apiserver.</p><p>In order for the extension apiserver to be authorized itself to submit the <code>SubjectAccessReview</code> request to the Kubernetes apiserver, it needs the correct permissions. Kubernetes includes a default <code>ClusterRole</code> named <code>system:auth-delegator</code> that has the appropriate permissions. It can be granted to the extension apiserver's service account.</p><h3 id=extension-apiserver-executes>Extension Apiserver Executes</h3><p>If the <code>SubjectAccessReview</code> passes, the extension apiserver executes the request.</p><h2 id=enable-kubernetes-apiserver-flags>Enable Kubernetes Apiserver flags</h2><p>Enable the aggregation layer via the following <code>kube-apiserver</code> flags. They may have already been taken care of by your provider.</p><pre><code>--requestheader-client-ca-file=&lt;path to aggregator CA cert&gt;
--requestheader-allowed-names=front-proxy-client
--requestheader-extra-headers-prefix=X-Remote-Extra-
--requestheader-group-headers=X-Remote-Group
--requestheader-username-headers=X-Remote-User
--proxy-client-cert-file=&lt;path to aggregator proxy cert&gt;
--proxy-client-key-file=&lt;path to aggregator proxy key&gt;
</code></pre><h3 id=ca-reusage-and-conflicts>CA Reusage and Conflicts</h3><p>The Kubernetes apiserver has two client CA options:</p><ul><li><code>--client-ca-file</code></li><li><code>--requestheader-client-ca-file</code></li></ul><p>Each of these functions independently and can conflict with each other, if not used correctly.</p><ul><li><code>--client-ca-file</code>: When a request arrives to the Kubernetes apiserver, if this option is enabled, the Kubernetes apiserver checks the certificate of the request. If it is signed by one of the CA certificates in the file referenced by <code>--client-ca-file</code>, then the request is treated as a legitimate request, and the user is the value of the common name <code>CN=</code>, while the group is the organization <code>O=</code>. See the <a href=/docs/reference/access-authn-authz/authentication/#x509-client-certs>documentation on TLS authentication</a>.</li><li><code>--requestheader-client-ca-file</code>: When a request arrives to the Kubernetes apiserver, if this option is enabled, the Kubernetes apiserver checks the certificate of the request. If it is signed by one of the CA certificates in the file reference by <code>--requestheader-client-ca-file</code>, then the request is treated as a potentially legitimate request. The Kubernetes apiserver then checks if the common name <code>CN=</code> is one of the names in the list provided by <code>--requestheader-allowed-names</code>. If the name is allowed, the request is approved; if it is not, the request is not.</li></ul><p>If <em>both</em> <code>--client-ca-file</code> and <code>--requestheader-client-ca-file</code> are provided, then the request first checks the <code>--requestheader-client-ca-file</code> CA and then the <code>--client-ca-file</code>. Normally, different CAs, either root CAs or intermediate CAs, are used for each of these options; regular client requests match against <code>--client-ca-file</code>, while aggregation requests match against <code>--requestheader-client-ca-file</code>. However, if both use the <em>same</em> CA, then client requests that normally would pass via <code>--client-ca-file</code> will fail, because the CA will match the CA in <code>--requestheader-client-ca-file</code>, but the common name <code>CN=</code> will <strong>not</strong> match one of the acceptable common names in <code>--requestheader-allowed-names</code>. This can cause your kubelets and other control plane components, as well as end-users, to be unable to authenticate to the Kubernetes apiserver.</p><p>For this reason, use different CA certs for the <code>--client-ca-file</code> option - to authorize control plane components and end-users - and the <code>--requestheader-client-ca-file</code> option - to authorize aggregation apiserver requests.</p><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Do <strong>not</strong> reuse a CA that is used in a different context unless you understand the risks and the mechanisms to protect the CA's usage.</div><p>If you are not running kube-proxy on a host running the API server, then you must make sure that the system is enabled with the following <code>kube-apiserver</code> flag:</p><pre><code>--enable-aggregator-routing=true
</code></pre><h3 id=register-apiservice-objects>Register APIService objects</h3><p>You can dynamically configure what client requests are proxied to extension
apiserver. The following is an example registration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiregistration.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>APIService<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>&lt;name of the registration object&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>&lt;API group name this extension apiserver hosts&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>&lt;API version this extension apiserver hosts&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>groupPriorityMinimum</span>:<span style=color:#bbb> </span>&lt;priority this APIService for this group, see API documentation&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versionPriority</span>:<span style=color:#bbb> </span>&lt;prioritizes ordering of this version within a group, see API documentation&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>&lt;namespace of the extension apiserver service&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>&lt;name of the extension apiserver service&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span>&lt;pem encoded ca cert that signs the server cert used by the webhook&gt;<span style=color:#bbb>
</span></span></span></code></pre></div><p>The name of an APIService object must be a valid
<a href=/docs/concepts/overview/working-with-objects/names#path-segment-names>path segment name</a>.</p><h4 id=contacting-the-extension-apiserver>Contacting the extension apiserver</h4><p>Once the Kubernetes apiserver has determined a request should be sent to an extension apiserver,
it needs to know how to contact it.</p><p>The <code>service</code> stanza is a reference to the service for an extension apiserver.
The service namespace and name are required. The port is optional and defaults to 443.</p><p>Here is an example of an extension apiserver that is configured to be called on port "1234",
and to verify the TLS connection against the ServerName
<code>my-service-name.my-service-namespace.svc</code> using a custom CA bundle.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiregistration.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>APIService<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-service-namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service-name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>1234</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/tasks/extend-kubernetes/setup-extension-api-server/>Set up an extension api-server</a> to work with the aggregation layer.</li><li>For a high level overview, see <a href=/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>Extending the Kubernetes API with the aggregation layer</a>.</li><li>Learn how to <a href=/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/>Extend the Kubernetes API Using Custom Resource Definitions</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8f1f7f0d3a1cc21537506bd4f9103a29>11.2 - Use Custom Resources</h1></div><div class=td-content><h1 id=pg-dc64883f1fd119402b112d3ff6733452>11.2.1 - Extend the Kubernetes API with CustomResourceDefinitions</h1><p>This page shows how to install a
<a href=/docs/concepts/extend-kubernetes/api-extension/custom-resources/>custom resource</a>
into the Kubernetes API by creating a
<a href=/docs/reference/generated/kubernetes-api/v1.25/#customresourcedefinition-v1-apiextensions-k8s-io>CustomResourceDefinition</a>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.16.
To check the version, enter <code>kubectl version</code>.
If you are using an older version of Kubernetes that is still supported, switch to
the documentation for that version to see advice that is relevant for your cluster.</p><h2 id=create-a-customresourcedefinition>Create a CustomResourceDefinition</h2><p>When you create a new CustomResourceDefinition (CRD), the Kubernetes API Server
creates a new RESTful resource path for each version you specify. The custom
resource created from a CRD object can be either namespaced or cluster-scoped,
as specified in the CRD's <code>spec.scope</code> field. As with existing built-in
objects, deleting a namespace deletes all custom objects in that namespace.
CustomResourceDefinitions themselves are non-namespaced and are available to
all namespaces.</p><p>For example, if you save the following CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># list of versions supported by this CustomResourceDefinition</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Each version can be enabled/disabled by Served flag.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># One and only one version must be marked as the storage version.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># either Namespaced or Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># singular name to be used as an alias on the CLI and for display</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind is normally the CamelCased singular type. Your resource manifests use this.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames allow shorter string to match your resource on the CLI</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div><p>and create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>Then a new namespaced RESTful API endpoint is created at:</p><pre tabindex=0><code>/apis/stable.example.com/v1/namespaces/*/crontabs/...
</code></pre><p>This endpoint URL can then be used to create and manage custom objects.
The <code>kind</code> of these objects will be <code>CronTab</code> from the spec of the
CustomResourceDefinition object you created above.</p><p>It might take a few seconds for the endpoint to be created.
You can watch the <code>Established</code> condition of your CustomResourceDefinition
to be true or watch the discovery information of the API server for your
resource to show up.</p><h2 id=create-custom-objects>Create custom objects</h2><p>After the CustomResourceDefinition object has been created, you can create
custom objects. Custom objects can contain custom fields. These fields can
contain arbitrary JSON.
In the following example, the <code>cronSpec</code> and <code>image</code> custom fields are set in a
custom object of kind <code>CronTab</code>. The kind <code>CronTab</code> comes from the spec of the
CustomResourceDefinition object you created above.</p><p>If you save the following YAML to <code>my-crontab.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span></code></pre></div><p>and create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>You can then manage your CronTab objects using kubectl. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get crontab
</span></span></code></pre></div><p>Should print a list like this:</p><pre tabindex=0><code class=language-none data-lang=none>NAME                 AGE
my-new-cron-object   6s
</code></pre><p>Resource names are not case-sensitive when using kubectl, and you can use either
the singular or plural forms defined in the CRD, as well as any short names.</p><p>You can also view the raw YAML data:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get ct -o yaml
</span></span></code></pre></div><p>You should see that it contains the custom <code>cronSpec</code> and <code>image</code> fields
from the YAML you used to create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>stable.example.com/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        </span><span style=color:#bbb>        </span>{<span style=color:#b44>&#34;apiVersion&#34;</span>:<span style=color:#b44>&#34;stable.example.com/v1&#34;</span>,<span style=color:#b44>&#34;kind&#34;</span>:<span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#b44>&#34;metadata&#34;</span>:{<span style=color:#b44>&#34;annotations&#34;</span>:{},<span style=color:#b44>&#34;name&#34;</span>:<span style=color:#b44>&#34;my-new-cron-object&#34;</span>,<span style=color:#b44>&#34;namespace&#34;</span>:<span style=color:#b44>&#34;default&#34;</span>},<span style=color:#b44>&#34;spec&#34;</span>:{<span style=color:#b44>&#34;cronSpec&#34;</span>:<span style=color:#b44>&#34;* * * * */5&#34;</span>,<span style=color:#b44>&#34;image&#34;</span>:<span style=color:#b44>&#34;my-awesome-cron-image&#34;</span>}}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2021-06-20T07:35:27Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>generation</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1326&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>9aab1d66-628e-41bb-a422-57b8b3b1f5a9<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;* * * * */5&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>List<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selfLink</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=delete-a-customresourcedefinition>Delete a CustomResourceDefinition</h2><p>When you delete a CustomResourceDefinition, the server will uninstall the RESTful API endpoint
and delete all custom objects stored in it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f resourcedefinition.yaml
</span></span><span style=display:flex><span>kubectl get crontabs
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Error from server (NotFound): Unable to list {&#34;stable.example.com&#34; &#34;v1&#34; &#34;crontabs&#34;}: the server could not
find the requested resource (get crontabs.stable.example.com)
</code></pre><p>If you later recreate the same CustomResourceDefinition, it will start out empty.</p><h2 id=specifying-a-structural-schema>Specifying a structural schema</h2><p>CustomResources store structured data in custom fields (alongside the built-in
fields <code>apiVersion</code>, <code>kind</code> and <code>metadata</code>, which the API server validates
implicitly). With <a href=#validation>OpenAPI v3.0 validation</a> a schema can be
specified, which is validated during creation and updates, compare below for
details and limits of such a schema.</p><p>With <code>apiextensions.k8s.io/v1</code> the definition of a structural schema is
mandatory for CustomResourceDefinitions. In the beta version of
CustomResourceDefinition, the structural schema was optional.</p><p>A structural schema is an <a href=#validation>OpenAPI v3.0 validation schema</a> which:</p><ol><li>specifies a non-empty type (via <code>type</code> in OpenAPI) for the root, for each specified field of an object node
(via <code>properties</code> or <code>additionalProperties</code> in OpenAPI) and for each item in an array node
(via <code>items</code> in OpenAPI), with the exception of:<ul><li>a node with <code>x-kubernetes-int-or-string: true</code></li><li>a node with <code>x-kubernetes-preserve-unknown-fields: true</code></li></ul></li><li>for each field in an object and each item in an array which is specified within any of <code>allOf</code>, <code>anyOf</code>,
<code>oneOf</code> or <code>not</code>, the schema also specifies the field/item outside of those logical junctors (compare example 1 and 2).</li><li>does not set <code>description</code>, <code>type</code>, <code>default</code>, <code>additionalProperties</code>, <code>nullable</code> within an <code>allOf</code>, <code>anyOf</code>,
<code>oneOf</code> or <code>not</code>, with the exception of the two pattern for <code>x-kubernetes-int-or-string: true</code> (see below).</li><li>if <code>metadata</code> is specified, then only restrictions on <code>metadata.name</code> and <code>metadata.generateName</code> are allowed.</li></ol><p>Non-structural example 1:</p><pre tabindex=0><code class=language-none data-lang=none>allOf:
- properties:
    foo:
      ...
</code></pre><p>conflicts with rule 2. The following would be correct:</p><pre tabindex=0><code class=language-none data-lang=none>properties:
  foo:
    ...
allOf:
- properties:
    foo:
      ...
</code></pre><p>Non-structural example 2:</p><pre tabindex=0><code class=language-none data-lang=none>allOf:
- items:
    properties:
      foo:
        ...
</code></pre><p>conflicts with rule 2. The following would be correct:</p><pre tabindex=0><code class=language-none data-lang=none>items:
  properties:
    foo:
      ...
allOf:
- items:
    properties:
      foo:
        ...
</code></pre><p>Non-structural example 3:</p><pre tabindex=0><code class=language-none data-lang=none>properties:
  foo:
    pattern: &#34;abc&#34;
  metadata:
    type: object
    properties:
      name:
        type: string
        pattern: &#34;^a&#34;
      finalizers:
        type: array
        items:
          type: string
          pattern: &#34;my-finalizer&#34;
anyOf:
- properties:
    bar:
      type: integer
      minimum: 42
  required: [&#34;bar&#34;]
  description: &#34;foo bar object&#34;
</code></pre><p>is not a structural schema because of the following violations:</p><ul><li>the type at the root is missing (rule 1).</li><li>the type of <code>foo</code> is missing (rule 1).</li><li><code>bar</code> inside of <code>anyOf</code> is not specified outside (rule 2).</li><li><code>bar</code>'s <code>type</code> is within <code>anyOf</code> (rule 3).</li><li>the description is set within <code>anyOf</code> (rule 3).</li><li><code>metadata.finalizers</code> might not be restricted (rule 4).</li></ul><p>In contrast, the following, corresponding schema is structural:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;foo bar object&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;abc&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;^a&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>anyOf</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>42</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>required</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;bar&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div><p>Violations of the structural schema rules are reported in the <code>NonStructural</code> condition in the
CustomResourceDefinition.</p><h3 id=field-pruning>Field pruning</h3><p>CustomResourceDefinitions store validated resource data in the cluster's persistence store, <a class=glossary-tooltip title='Consistent and highly-available key value store used as backing store of Kubernetes for all cluster data.' data-toggle=tooltip data-placement=top href=/docs/tasks/administer-cluster/configure-upgrade-etcd/ target=_blank aria-label=etcd>etcd</a>.
As with native Kubernetes resources such as <a class=glossary-tooltip title='An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a>,
if you specify a field that the API server does not recognize, the unknown field is <em>pruned</em> (removed) before being persisted.</p><p>CRDs converted from <code>apiextensions.k8s.io/v1beta1</code> to <code>apiextensions.k8s.io/v1</code> might lack
structural schemas, and <code>spec.preserveUnknownFields</code> might be <code>true</code>.</p><p>For legacy CustomResourceDefinition objects created as
<code>apiextensions.k8s.io/v1beta1</code> with <code>spec.preserveUnknownFields</code> set to
<code>true</code>, the following is also true:</p><ul><li>Pruning is not enabled.</li><li>You can store arbitrary data.</li></ul><p>For compatibility with <code>apiextensions.k8s.io/v1</code>, update your custom
resource definitions to:</p><ol><li>Use a structural OpenAPI schema.</li><li>Set <code>spec.preserveUnknownFields</code> to <code>false</code>.</li></ol><p>If you save the following YAML to <code>my-crontab.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>someRandomField</span>:<span style=color:#bbb> </span><span style=color:#666>42</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>and create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create --validate<span style=color:#666>=</span><span style=color:#a2f>false</span> -f my-crontab.yaml -o yaml
</span></span></code></pre></div><p>Your output is similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>stable.example.com/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2017-05-31T12:56:35Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>generation</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;285&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>9423255b-4600-11e7-af6a-28d2447dc82b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;* * * * */5&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span></code></pre></div><p>Notice that the field <code>someRandomField</code> was pruned.</p><p>This example turned off client-side validation to demonstrate the API server's behavior, by adding
the <code>--validate=false</code> command line option.
Because the <a href=#publish-validation-schema-in-openapi-v2>OpenAPI validation schemas are also published</a>
to clients, <code>kubectl</code> also checks for unknown fields and rejects those objects well before they
would be sent to the API server.</p><h4 id=controlling-pruning>Controlling pruning</h4><p>By default, all unspecified fields for a custom resource, across all versions, are pruned. It is possible though to
opt-out of that for specifc sub-trees of fields by adding <code>x-kubernetes-preserve-unknown-fields: true</code> in the
<a href=#specifying-a-structural-schema>structural OpenAPI v3 validation schema</a>.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>The field <code>json</code> can store any JSON value, without anything being pruned.</p><p>You can also partially specify the permitted JSON; for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>this is arbitrary JSON<span style=color:#bbb>
</span></span></span></code></pre></div><p>With this, only <code>object</code> type values are allowed.</p><p>Pruning is enabled again for each specified property (or <code>additionalProperties</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span></code></pre></div><p>With this, the value:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span>abc<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span>def<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span></span></span></code></pre></div><p>is pruned to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span>abc<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span>def<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span></span></span></code></pre></div><p>This means that the <code>something</code> field in the specified <code>spec</code> object is pruned, but everything outside is not.</p><h3 id=intorstring>IntOrString</h3><p>Nodes in a schema with <code>x-kubernetes-int-or-string: true</code> are excluded from rule 1, such that the
following is structural:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-int-or-string</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Also those nodes are partially excluded from rule 3 in the sense that the following two patterns are allowed
(exactly those, without variations in order to additional fields):</p><pre tabindex=0><code class=language-none data-lang=none>x-kubernetes-int-or-string: true
anyOf:
  - type: integer
  - type: string
...
</code></pre><p>and</p><pre tabindex=0><code class=language-none data-lang=none>x-kubernetes-int-or-string: true
allOf:
  - anyOf:
      - type: integer
      - type: string
  - ... # zero or more
...
</code></pre><p>With one of those specification, both an integer and a string validate.</p><p>In <a href=#publish-validation-schema-in-openapi-v2>Validation Schema Publishing</a>,
<code>x-kubernetes-int-or-string: true</code> is unfolded to one of the two patterns shown above.</p><h3 id=rawextension>RawExtension</h3><p>RawExtensions (as in <a href=/docs/reference//kubernetes-api/workload-resources/controller-revision-v1#RawExtension><code>runtime.RawExtension</code></a>)
holds complete Kubernetes objects, i.e. with <code>apiVersion</code> and <code>kind</code> fields.</p><p>It is possible to specify those embedded objects (both completely without constraints or partially specified)
by setting <code>x-kubernetes-embedded-resource: true</code>. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-embedded-resource</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Here, the field <code>foo</code> holds a complete object, e.g.:</p><pre tabindex=0><code class=language-none data-lang=none>foo:
  apiVersion: v1
  kind: Pod
  spec:
    ...
</code></pre><p>Because <code>x-kubernetes-preserve-unknown-fields: true</code> is specified alongside, nothing is pruned.
The use of <code>x-kubernetes-preserve-unknown-fields: true</code> is optional though.</p><p>With <code>x-kubernetes-embedded-resource: true</code>, the <code>apiVersion</code>, <code>kind</code> and <code>metadata</code> are implicitly specified and validated.</p><h2 id=serving-multiple-versions-of-a-crd>Serving multiple versions of a CRD</h2><p>See <a href=/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/>Custom resource definition versioning</a>
for more information about serving multiple versions of your
CustomResourceDefinition and migrating your objects from one version to another.</p><h2 id=advanced-topics>Advanced topics</h2><h3 id=finalizers>Finalizers</h3><p><em>Finalizers</em> allow controllers to implement asynchronous pre-delete hooks.
Custom objects support finalizers similar to built-in objects.</p><p>You can add a finalizer to a custom object like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>finalizers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- stable.example.com/finalizer<span style=color:#bbb>
</span></span></span></code></pre></div><p>Identifiers of custom finalizers consist of a domain name, a forward slash and the name of
the finalizer. Any controller can add a finalizer to any object's list of finalizers.</p><p>The first delete request on an object with finalizers sets a value for the
<code>metadata.deletionTimestamp</code> field but does not delete it. Once this value is set,
entries in the <code>finalizers</code> list can only be removed. While any finalizers remain it is also
impossible to force the deletion of an object.</p><p>When the <code>metadata.deletionTimestamp</code> field is set, controllers watching the object execute any
finalizers they handle and remove the finalizer from the list after they are done. It is the
responsibility of each controller to remove its finalizer from the list.</p><p>The value of <code>metadata.deletionGracePeriodSeconds</code> controls the interval between polling updates.</p><p>Once the list of finalizers is empty, meaning all finalizers have been executed, the resource is
deleted by Kubernetes.</p><h3 id=validation>Validation</h3><p>Custom resources are validated via
<a href=https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#schemaObject>OpenAPI v3 schemas</a>,
by x-kubernetes-validations when the <a href=#validation-rules>Validation Rules feature</a> is enabled, and you
can add additional validation using
<a href=/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook>admission webhooks</a>.</p><p>Additionally, the following restrictions are applied to the schema:</p><ul><li><p>These fields cannot be set:</p><ul><li><code>definitions</code>,</li><li><code>dependencies</code>,</li><li><code>deprecated</code>,</li><li><code>discriminator</code>,</li><li><code>id</code>,</li><li><code>patternProperties</code>,</li><li><code>readOnly</code>,</li><li><code>writeOnly</code>,</li><li><code>xml</code>,</li><li><code>$ref</code>.</li></ul></li><li><p>The field <code>uniqueItems</code> cannot be set to <code>true</code>.</p></li><li><p>The field <code>additionalProperties</code> cannot be set to <code>false</code>.</p></li><li><p>The field <code>additionalProperties</code> is mutually exclusive with <code>properties</code>.</p></li></ul><p>The <code>x-kubernetes-validations</code> extension can be used to validate custom resources using
<a href=https://github.com/google/cel-spec>Common Expression Language (CEL)</a> expressions when the
<a href=#validation-rules>Validation rules</a> feature is enabled and the CustomResourceDefinition schema is a
<a href=#specifying-a-structural-schema>structural schema</a>.</p><p>Refer to the <a href=#specifying-a-structural-schema>structural schemas</a> section for other
restrictions and CustomResourceDefinition features.</p><p>The schema is defined in the CustomResourceDefinition. In the following example, the
CustomResourceDefinition applies the following validations on the custom object:</p><ul><li><code>spec.cronSpec</code> must be a string and must be of the form described by the regular expression.</li><li><code>spec.replicas</code> must be an integer and must have a minimum value of 1 and a maximum value of 10.</li></ul><p>Save the CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># openAPIV3Schema is the schema for validating custom objects.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>maximum</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div><p>and create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>A request to create a custom object of kind CronTab is rejected if there are invalid values in its fields.
In the following example, the custom object contains fields with invalid values:</p><ul><li><code>spec.cronSpec</code> does not match the regular expression.</li><li><code>spec.replicas</code> is greater than 10.</li></ul><p>If you save the following YAML to <code>my-crontab.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * *&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>and attempt to create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>then you get an error:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>The CronTab &#34;my-new-cron-object&#34; is invalid: []: Invalid value: map[string]interface {}{&#34;apiVersion&#34;:&#34;stable.example.com/v1&#34;, &#34;kind&#34;:&#34;CronTab&#34;, &#34;metadata&#34;:map[string]interface {}{&#34;name&#34;:&#34;my-new-cron-object&#34;, &#34;namespace&#34;:&#34;default&#34;, &#34;deletionTimestamp&#34;:interface {}(nil), &#34;deletionGracePeriodSeconds&#34;:(*int64)(nil), &#34;creationTimestamp&#34;:&#34;2017-09-05T05:20:07Z&#34;, &#34;uid&#34;:&#34;e14d79e7-91f9-11e7-a598-f0761cb232d1&#34;, &#34;clusterName&#34;:&#34;&#34;}, &#34;spec&#34;:map[string]interface {}{&#34;cronSpec&#34;:&#34;* * * *&#34;, &#34;image&#34;:&#34;my-awesome-cron-image&#34;, &#34;replicas&#34;:15}}:
</span></span></span><span style=display:flex><span><span style=color:#888>validation failure list:
</span></span></span><span style=display:flex><span><span style=color:#888>spec.cronSpec in body should match &#39;^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$&#39;
</span></span></span><span style=display:flex><span><span style=color:#888>spec.replicas in body should be less than or equal to 10
</span></span></span></code></pre></div><p>If the fields contain valid values, the object creation request is accepted.</p><p>Save the following YAML to <code>my-crontab.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>And create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span><span style=display:flex><span>crontab <span style=color:#b44>&#34;my-new-cron-object&#34;</span> created
</span></span></code></pre></div><h2 id=validation-rules>Validation rules</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [beta]</code></div><p>Validation rules are in beta since 1.25 and the <code>CustomResourceValidationExpressions</code>
<a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gate</a> is enabled by default to
validate custom resource based on <em>validation rules</em>. You can disable this feature by explicitly
setting the <code>CustomResourceValidationExpressions</code> feature gate to <code>false</code>, for the
<a href=/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver</a> component. This
feature is only available if the schema is a <a href=#specifying-a-structural-schema>structural schema</a>.</p><p>Validation rules use the <a href=https://github.com/google/cel-spec>Common Expression Language (CEL)</a>
to validate custom resource values. Validation rules are included in
CustomResourceDefinition schemas using the <code>x-kubernetes-validations</code> extension.</p><p>The Rule is scoped to the location of the <code>x-kubernetes-validations</code> extension in the schema.
And <code>self</code> variable in the CEL expression is bound to the scoped value.</p><p>All validation rules are scoped to the current object: no cross-object or stateful validation
rules are supported.</p><p>For example:</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        x-kubernetes-validations:
          - rule: &#34;self.minReplicas &lt;= self.replicas&#34;
            message: &#34;replicas should be greater than or equal to minReplicas.&#34;
          - rule: &#34;self.replicas &lt;= self.maxReplicas&#34;
            message: &#34;replicas should be smaller than or equal to maxReplicas.&#34;
        properties:
          ...
          minReplicas:
            type: integer
          replicas:
            type: integer
          maxReplicas:
            type: integer
        required:
          - minReplicas
          - replicas
          - maxReplicas 
</code></pre><p>will reject a request to create this custom resource:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>20</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>maxReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>with the response:</p><pre tabindex=0><code>The CronTab &#34;my-new-cron-object&#34; is invalid:
* spec: Invalid value: map[string]interface {}{&#34;maxReplicas&#34;:10, &#34;minReplicas&#34;:0, &#34;replicas&#34;:20}: replicas should be smaller than or equal to maxReplicas.
</code></pre><p><code>x-kubernetes-validations</code> could have multiple rules.
The <code>rule</code> under <code>x-kubernetes-validations</code> represents the expression which will be evaluated by CEL.
The <code>message</code> represents the message displayed when validation fails. If message is unset, the
above response would be:</p><pre tabindex=0><code>The CronTab &#34;my-new-cron-object&#34; is invalid:
* spec: Invalid value: map[string]interface {}{&#34;maxReplicas&#34;:10, &#34;minReplicas&#34;:0, &#34;replicas&#34;:20}: failed rule: self.replicas &lt;= self.maxReplicas
</code></pre><p>Validation rules are compiled when CRDs are created/updated.
The request of CRDs create/update will fail if compilation of validation rules fail.
Compilation process includes type checking as well.</p><p>The compilation failure:</p><ul><li><p><code>no_matching_overload</code>: this function has no overload for the types of the arguments.</p><p>For example, a rule like <code>self == true</code> against a field of integer type will get error:</p><pre tabindex=0><code class=language-none data-lang=none>Invalid value: apiextensions.ValidationRule{Rule:&#34;self == true&#34;, Message:&#34;&#34;}: compilation failed: ERROR: \&lt;input&gt;:1:6: found no matching overload for &#39;_==_&#39; applied to &#39;(int, bool)&#39;
</code></pre></li><li><p><code>no_such_field</code>: does not contain the desired field.</p><p>For example, a rule like <code>self.nonExistingField > 0</code> against a non-existing field will return
the following error:</p><pre tabindex=0><code class=language-none data-lang=none>Invalid value: apiextensions.ValidationRule{Rule:&#34;self.nonExistingField &gt; 0&#34;, Message:&#34;&#34;}: compilation failed: ERROR: \&lt;input&gt;:1:5: undefined field &#39;nonExistingField&#39;
</code></pre></li><li><p><code>invalid argument</code>: invalid argument to macros.</p><p>For example, a rule like <code>has(self)</code> will return error:</p><pre tabindex=0><code class=language-none data-lang=none>Invalid value: apiextensions.ValidationRule{Rule:&#34;has(self)&#34;, Message:&#34;&#34;}: compilation failed: ERROR: &lt;input&gt;:1:4: invalid argument to has() macro
</code></pre></li></ul><p>Validation Rules Examples:</p><table><thead><tr><th>Rule</th><th>Purpose</th></tr></thead><tbody><tr><td><code>self.minReplicas &lt;= self.replicas && self.replicas &lt;= self.maxReplicas</code></td><td>Validate that the three fields defining replicas are ordered appropriately</td></tr><tr><td><code>'Available' in self.stateCounts</code></td><td>Validate that an entry with the 'Available' key exists in a map</td></tr><tr><td><code>(size(self.list1) == 0) != (size(self.list2) == 0)</code></td><td>Validate that one of two lists is non-empty, but not both</td></tr><tr><td><code>!('MY_KEY' in self.map1) || self['MY_KEY'].matches('^[a-zA-Z]*$')</code></td><td>Validate the value of a map for a specific key, if it is in the map</td></tr><tr><td><code>self.envars.filter(e, e.name == 'MY_ENV').all(e, e.value.matches('^[a-zA-Z]*$')</code></td><td>Validate the 'value' field of a listMap entry where key field 'name' is 'MY_ENV'</td></tr><tr><td><code>has(self.expired) && self.created + self.ttl &lt; self.expired</code></td><td>Validate that 'expired' date is after a 'create' date plus a 'ttl' duration</td></tr><tr><td><code>self.health.startsWith('ok')</code></td><td>Validate a 'health' string field has the prefix 'ok'</td></tr><tr><td><code>self.widgets.exists(w, w.key == 'x' && w.foo &lt; 10)</code></td><td>Validate that the 'foo' property of a listMap item with a key 'x' is less than 10</td></tr><tr><td><code>type(self) == string ? self == '100%' : self == 1000</code></td><td>Validate an int-or-string field for both the int and string cases</td></tr><tr><td><code>self.metadata.name.startsWith(self.prefix)</code></td><td>Validate that an object's name has the prefix of another field value</td></tr><tr><td><code>self.set1.all(e, !(e in self.set2))</code></td><td>Validate that two listSets are disjoint</td></tr><tr><td><code>size(self.names) == size(self.details) && self.names.all(n, n in self.details)</code></td><td>Validate the 'details' map is keyed by the items in the 'names' listSet</td></tr><tr><td><code>size(self.clusters.filter(c, c.name == self.primary)) == 1</code></td><td>Validate that the 'primary' property has one and only one occurrence in the 'clusters' listMap</td></tr></tbody></table><p>Xref: <a href=https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#evaluation>Supported evaluation on CEL</a></p><ul><li><p>If the Rule is scoped to the root of a resource, it may make field selection into any fields
declared in the OpenAPIv3 schema of the CRD as well as <code>apiVersion</code>, <code>kind</code>, <code>metadata.name</code> and
<code>metadata.generateName</code>. This includes selection of fields in both the <code>spec</code> and <code>status</code> in the
same expression:</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    x-kubernetes-validations:
      - rule: &#34;self.status.availableReplicas &gt;= self.spec.minReplicas&#34;
    properties:
        spec:
          type: object
          properties:
            minReplicas:
              type: integer
            ...
        status:
          type: object
          properties:
            availableReplicas:
              type: integer
</code></pre></li><li><p>If the Rule is scoped to an object with properties, the accessible properties of the object are field selectable
via <code>self.field</code> and field presence can be checked via <code>has(self.field)</code>. Null valued fields are treated as
absent fields in CEL expressions.</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        x-kubernetes-validations:
          - rule: &#34;has(self.foo)&#34;
        properties:
          ...
          foo:
            type: integer
</code></pre></li><li><p>If the Rule is scoped to an object with additionalProperties (i.e. a map) the value of the map
are accessible via <code>self[mapKey]</code>, map containment can be checked via <code>mapKey in self</code> and all
entries of the map are accessible via CEL macros and functions such as <code>self.all(...)</code>.</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        x-kubernetes-validations:
          - rule: &#34;self[&#39;xyz&#39;].foo &gt; 0&#34;
        additionalProperties:
          ...
          type: object
          properties:
            foo:
              type: integer
</code></pre></li><li><p>If the Rule is scoped to an array, the elements of the array are accessible via <code>self[i]</code> and
also by macros and functions.</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      ...
      foo:
        type: array
        x-kubernetes-validations:
          - rule: &#34;size(self) == 1&#34;
        items:
          type: string
</code></pre></li><li><p>If the Rule is scoped to a scalar, <code>self</code> is bound to the scalar value.</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        properties:
          ...
          foo:
            type: integer
            x-kubernetes-validations:
            - rule: &#34;self &gt; 0&#34;
</code></pre></li></ul><p>Examples:</p><table><thead><tr><th>type of the field rule scoped to</th><th>Rule example</th></tr></thead><tbody><tr><td>root object</td><td><code>self.status.actual &lt;= self.spec.maxDesired</code></td></tr><tr><td>map of objects</td><td><code>self.components['Widget'].priority &lt; 10</code></td></tr><tr><td>list of integers</td><td><code>self.values.all(value, value >= 0 && value &lt; 100)</code></td></tr><tr><td>string</td><td><code>self.startsWith('kube')</code></td></tr></tbody></table><p>The <code>apiVersion</code>, <code>kind</code>, <code>metadata.name</code> and <code>metadata.generateName</code> are always accessible from
the root of the object and from any <code>x-kubernetes-embedded-resource</code> annotated objects. No other
metadata properties are accessible.</p><p>Unknown data preserved in custom resources via <code>x-kubernetes-preserve-unknown-fields</code> is not
accessible in CEL expressions. This includes:</p><ul><li><p>Unknown field values that are preserved by object schemas with <code>x-kubernetes-preserve-unknown-fields</code>.</p></li><li><p>Object properties where the property schema is of an "unknown type". An "unknown type" is
recursively defined as:</p><ul><li>A schema with no type and x-kubernetes-preserve-unknown-fields set to true</li><li>An array where the items schema is of an "unknown type"</li><li>An object where the additionalProperties schema is of an "unknown type"</li></ul></li></ul><p>Only property names of the form <code>[a-zA-Z_.-/][a-zA-Z0-9_.-/]*</code> are accessible.
Accessible property names are escaped according to the following rules when accessed in the expression:</p><table><thead><tr><th>escape sequence</th><th>property name equivalent</th></tr></thead><tbody><tr><td><code>__underscores__</code></td><td><code>__</code></td></tr><tr><td><code>__dot__</code></td><td><code>.</code></td></tr><tr><td><code>__dash__</code></td><td><code>-</code></td></tr><tr><td><code>__slash__</code></td><td><code>/</code></td></tr><tr><td><code>__{keyword}__</code></td><td><a href=https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#syntax>CEL RESERVED keyword</a></td></tr></tbody></table><p>Note: CEL RESERVED keyword needs to match the exact property name to be escaped (e.g. int in the word sprint would not be escaped).</p><p>Examples on escaping:</p><table><thead><tr><th>property name</th><th>rule with escaped property name</th></tr></thead><tbody><tr><td>namespace</td><td><code>self.__namespace__ > 0</code></td></tr><tr><td>x-prop</td><td><code>self.x__dash__prop > 0</code></td></tr><tr><td>redact__d</td><td><code>self.redact__underscores__d > 0</code></td></tr><tr><td>string</td><td><code>self.startsWith('kube')</code></td></tr></tbody></table><p>Equality on arrays with <code>x-kubernetes-list-type</code> of <code>set</code> or <code>map</code> ignores element order,
i.e., <code>[1, 2] == [2, 1]</code>. Concatenation on arrays with x-kubernetes-list-type use the semantics of
the list type:</p><ul><li><p><code>set</code>: <code>X + Y</code> performs a union where the array positions of all elements in <code>X</code> are preserved
and non-intersecting elements in <code>Y</code> are appended, retaining their partial order.</p></li><li><p><code>map</code>: <code>X + Y</code> performs a merge where the array positions of all keys in <code>X</code> are preserved but
the values are overwritten by values in <code>Y</code> when the key sets of <code>X</code> and <code>Y</code> intersect. Elements
in <code>Y</code> with non-intersecting keys are appended, retaining their partial order.</p></li></ul><p>Here is the declarations type mapping between OpenAPIv3 and CEL type:</p><table><thead><tr><th>OpenAPIv3 type</th><th>CEL type</th></tr></thead><tbody><tr><td>'object' with Properties</td><td>object / "message type"</td></tr><tr><td>'object' with AdditionalProperties</td><td>map</td></tr><tr><td>'object' with x-kubernetes-embedded-type</td><td>object / "message type", 'apiVersion', 'kind', 'metadata.name' and 'metadata.generateName' are implicitly included in schema</td></tr><tr><td>'object' with x-kubernetes-preserve-unknown-fields</td><td>object / "message type", unknown fields are NOT accessible in CEL expression</td></tr><tr><td>x-kubernetes-int-or-string</td><td>dynamic object that is either an int or a string, <code>type(value)</code> can be used to check the type</td></tr><tr><td>'array</td><td>list</td></tr><tr><td>'array' with x-kubernetes-list-type=map</td><td>list with map based Equality & unique key guarantees</td></tr><tr><td>'array' with x-kubernetes-list-type=set</td><td>list with set based Equality & unique entry guarantees</td></tr><tr><td>'boolean'</td><td>boolean</td></tr><tr><td>'number' (all formats)</td><td>double</td></tr><tr><td>'integer' (all formats)</td><td>int (64)</td></tr><tr><td>'null'</td><td>null_type</td></tr><tr><td>'string'</td><td>string</td></tr><tr><td>'string' with format=byte (base64 encoded)</td><td>bytes</td></tr><tr><td>'string' with format=date</td><td>timestamp (google.protobuf.Timestamp)</td></tr><tr><td>'string' with format=datetime</td><td>timestamp (google.protobuf.Timestamp)</td></tr><tr><td>'string' with format=duration</td><td>duration (google.protobuf.Duration)</td></tr></tbody></table><p>xref: <a href=https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#values>CEL types</a>,
<a href=https://swagger.io/specification/#data-types>OpenAPI types</a>,
<a href=/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#specifying-a-structural-schema>Kubernetes Structural Schemas</a>.</p><h4 id=available-validation-functions>Validation functions</h4><p>Functions available include:</p><ul><li>CEL standard functions, defined in the <a href=https://github.com/google/cel-spec/blob/v0.7.0/doc/langdef.md#list-of-standard-definitions>list of standard definitions</a></li><li>CEL standard <a href=https://github.com/google/cel-spec/blob/v0.7.0/doc/langdef.md#macros>macros</a></li><li>CEL <a href=https://pkg.go.dev/github.com/google/cel-go@v0.11.2/ext#Strings>extended string function library</a></li><li>Kubernetes <a href=https://pkg.go.dev/k8s.io/apiextensions-apiserver@v0.24.0/pkg/apiserver/schema/cel/library#pkg-functions>CEL extension library</a></li></ul><h4 id=transition-rules>Transition rules</h4><p>A rule that contains an expression referencing the identifier <code>oldSelf</code> is implicitly considered a
<em>transition rule</em>. Transition rules allow schema authors to prevent certain transitions between two
otherwise valid states. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>enum</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;low&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;medium&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;high&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;!(self == &#39;high&#39; &amp;&amp; oldSelf == &#39;low&#39;) &amp;&amp; !(self == &#39;low&#39; &amp;&amp; oldSelf == &#39;high&#39;)&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>cannot transition directly between &#39;low&#39; and &#39;high&#39;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Unlike other rules, transition rules apply only to operations meeting the following criteria:</p><ul><li><p>The operation updates an existing object. Transition rules never apply to create operations.</p></li><li><p>Both an old and a new value exist. It remains possible to check if a value has been added or
removed by placing a transition rule on the parent node. Transition rules are never applied to
custom resource creation. When placed on an optional field, a transition rule will not apply to
update operations that set or unset the field.</p></li><li><p>The path to the schema node being validated by a transition rule must resolve to a node that is
comparable between the old object and the new object. For example, list items and their
descendants (<code>spec.foo[10].bar</code>) can't necessarily be correlated between an existing object and a
later update to the same object.</p></li></ul><p>Errors will be generated on CRD writes if a schema node contains a transition rule that can never be
applied, e.g. "<em>path</em>: update rule <em>rule</em> cannot be set on schema because the schema or its parent
schema is not mergeable".</p><p>Transition rules are only allowed on <em>correlatable portions</em> of a schema.
A portion of the schema is correlatable if all <code>array</code> parent schemas are of type <code>x-kubernetes-list-type=map</code>;
any <code>set</code>or <code>atomic</code>array parent schemas make it impossible to unambiguously correlate a <code>self</code> with <code>oldSelf</code>.</p><p>Here are some examples for transition rules:</p><table><caption style=display:none>Transition rules examples</caption><thead><tr><th>Use Case</th><th>Rule</th></tr></thead><tbody><tr><td>Immutability</td><td><code>self.foo == oldSelf.foo</code></td></tr><tr><td>Prevent modification/removal once assigned</td><td><code>oldSelf != 'bar' || self == 'bar'</code> or <code>!has(oldSelf.field) || has(self.field)</code></td></tr><tr><td>Append-only set</td><td><code>self.all(element, element in oldSelf)</code></td></tr><tr><td>If previous value was X, new value can only be A or B, not Y or Z</td><td><code>oldSelf != 'X' || self in ['A', 'B']</code></td></tr><tr><td>Monotonic (non-decreasing) counters</td><td><code>self >= oldSelf</code></td></tr></tbody></table><h4 id=resource-use-by-validation-functions>Resource use by validation functions</h4><p>When you create or update a CustomResourceDefinition that uses validation rules,
the API server checks the likely impact of running those validation rules. If a rule is
estimated to be prohibitively expensive to execute, the API server rejects the create
or update operation, and returns an error message.
A similar system is used at runtime that observes the actions the interpreter takes. If the interpreter executes
too many instructions, execution of the rule will be halted, and an error will result.
Each CustomResourceDefinition is also allowed a certain amount of resources to finish executing all of
its validation rules. If the sum total of its rules are estimated at creation time to go over that limit,
then a validation error will also occur.</p><p>You are unlikely to encounter issues with the resource budget for validation if you only
specify rules that always take the same amount of time regardless of how large their input is.
For example, a rule that asserts that <code>self.foo == 1</code> does not by itself have any
risk of rejection on validation resource budget groups.
But if <code>foo</code> is a string and you define a validation rule <code>self.foo.contains("someString")</code>, that rule takes
longer to execute depending on how long <code>foo</code> is.
Another example would be if <code>foo</code> were an array, and you specified a validation rule <code>self.foo.all(x, x > 5)</code>.
The cost system always assumes the worst-case scenario if a limit on the length of <code>foo</code> is not
given, and this will happen for anything that can be iterated over (lists, maps, etc.).</p><p>Because of this, it is considered best practice to put a limit via <code>maxItems</code>, <code>maxProperties</code>, and
<code>maxLength</code> for anything that will be processed in a validation rule in order to prevent validation
errors during cost estimation. For example, given this schema with one rule:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.all(x, x.contains(&#39;a string&#39;))&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>then the API server rejects this rule on validation budget grounds with error:</p><pre tabindex=0><code>spec.validation.openAPIV3Schema.properties[spec].properties[foo].x-kubernetes-validations[0].rule: Forbidden: 
CEL rule exceeded budget by more than 100x (try simplifying the rule, or adding maxItems, maxProperties, and 
maxLength where arrays, maps, and strings are used)
</code></pre><p>The rejection happens because <code>self.all</code> implies calling <code>contains()</code> on every string in <code>foo</code>,
which in turn will check the given string to see if it contains <code>'a string'</code>. Without limits, this
is a very expensive rule.</p><p>If you do not specify any validation limit, the estimated cost of this rule will exceed the
per-rule cost limit. But if you add limits in the appropriate places, the rule will be allowed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxItems</span>:<span style=color:#bbb> </span><span style=color:#666>25</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>maxLength</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.all(x, x.contains(&#39;a string&#39;))&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>The cost estimation system takes into account how many times the rule will be executed in addition to the
estimated cost of the rule itself. For instance, the following rule will have the same estimated cost as the
previous example (despite the rule now being defined on the individual array items):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxItems</span>:<span style=color:#bbb> </span><span style=color:#666>25</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.contains(&#39;a string&#39;))&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>maxLength</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>If a list inside of a list has a validation rule that uses <code>self.all</code>, that is significantly more expensive
than a non-nested list with the same rule. A rule that would have been allowed on a non-nested list might need
lower limits set on both nested lists in order to be allowed. For example, even without having limits set,
the following rule is allowed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.all(x, x == 5)&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>But the same rule on the following schema (with a nested array added) produces a validation error:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.all(x, x == 5)&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>This is because each item of <code>foo</code> is itself an array, and each subarray in turn calls <code>self.all</code>.
Avoid nested lists and maps if possible where validation rules are used.</p><h3 id=defaulting>Defaulting</h3><div class="alert alert-info note callout" role=alert><strong>Note:</strong> To use defaulting, your CustomResourceDefinition must use API version <code>apiextensions.k8s.io/v1</code>.</div><p>Defaulting allows to specify default values in the <a href=#validation>OpenAPI v3 validation schema</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># openAPIV3Schema is the schema for validating custom objects.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;5 0 * * *&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>maximum</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div><p>With this both <code>cronSpec</code> and <code>replicas</code> are defaulted:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span></code></pre></div><p>leads to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;5 0 * * *&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Defaulting happens on the object</p><ul><li>in the request to the API server using the request version defaults,</li><li>when reading from etcd using the storage version defaults,</li><li>after mutating admission plugins with non-empty patches using the admission webhook object version defaults.</li></ul><p>Defaults applied when reading data from etcd are not automatically written back to etcd.
An update request via the API is required to persist those defaults back into etcd.</p><p>Default values must be pruned (with the exception of defaults for <code>metadata</code> fields) and must
validate against a provided schema.</p><p>Default values for <code>metadata</code> fields of <code>x-kubernetes-embedded-resources: true</code> nodes (or parts of
a default value covering <code>metadata</code>) are not pruned during CustomResourceDefinition creation, but
through the pruning step during handling of requests.</p><h4 id=defaulting-and-nullable>Defaulting and Nullable</h4><p>Null values for fields that either don't specify the nullable flag, or give it a
<code>false</code> value, will be pruned before defaulting happens. If a default is present, it will be
applied. When nullable is <code>true</code>, null values will be conserved and won't be defaulted.</p><p>For example, given the OpenAPI schema below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>nullable</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;default&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>nullable</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>baz</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span></code></pre></div><p>creating an object with null values for <code>foo</code> and <code>bar</code> and <code>baz</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>baz</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>leads to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;default&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>with <code>foo</code> pruned and defaulted because the field is non-nullable, <code>bar</code> maintaining the null
value due to <code>nullable: true</code>, and <code>baz</code> pruned because the field is non-nullable and has no
default.</p><h3 id=publish-validation-schema-in-openapi-v2>Publish Validation Schema in OpenAPI v2</h3><p>CustomResourceDefinition <a href=#validation>OpenAPI v3 validation schemas</a> which are
<a href=#specifying-a-structural-schema>structural</a> and <a href=#field-pruning>enable pruning</a> are published
as part of the <a href=/docs/concepts/overview/kubernetes-api/#openapi-and-swagger-definitions>OpenAPI v2 spec</a>
from Kubernetes API server.</p><p>The <a href=/docs/reference/kubectl/>kubectl</a> command-line tool consumes the published schema to perform
client-side validation (<code>kubectl create</code> and <code>kubectl apply</code>), schema explanation (<code>kubectl explain</code>)
on custom resources. The published schema can be consumed for other purposes as well, like client generation or documentation.</p><p>The OpenAPI v3 validation schema is converted to OpenAPI v2 schema, and
show up in <code>definitions</code> and <code>paths</code> fields in the
<a href=/docs/concepts/overview/kubernetes-api/#openapi-and-swagger-definitions>OpenAPI v2 spec</a>.</p><p>The following modifications are applied during the conversion to keep backwards compatibility with
kubectl in previous 1.13 version. These modifications prevent kubectl from being over-strict and rejecting
valid OpenAPI schemas that it doesn't understand. The conversion won't modify the validation schema defined in CRD,
and therefore won't affect <a href=#validation>validation</a> in the API server.</p><ol><li><p>The following fields are removed as they aren't supported by OpenAPI v2
(in future versions OpenAPI v3 will be used without these restrictions)</p><ul><li>The fields <code>allOf</code>, <code>anyOf</code>, <code>oneOf</code> and <code>not</code> are removed</li></ul></li><li><p>If <code>nullable: true</code> is set, we drop <code>type</code>, <code>nullable</code>, <code>items</code> and <code>properties</code> because OpenAPI v2 is
not able to express nullable. To avoid kubectl to reject good objects, this is necessary.</p></li></ol><h3 id=additional-printer-columns>Additional printer columns</h3><p>The kubectl tool relies on server-side output formatting. Your cluster's API server decides which
columns are shown by the <code>kubectl get</code> command. You can customize these columns for a
CustomResourceDefinition. The following example adds the <code>Spec</code>, <code>Replicas</code>, and <code>Age</code>
columns.</p><p>Save the CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>additionalPrinterColumns</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Spec<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>The cron spec defining the interval a CronJob is run<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.spec.cronSpec<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Replicas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>The number of jobs launched by the CronJob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.spec.replicas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Age<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>date<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.metadata.creationTimestamp<span style=color:#bbb>
</span></span></span></code></pre></div><p>Create the CustomResourceDefinition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>Create an instance using the <code>my-crontab.yaml</code> from the previous section.</p><p>Invoke the server-side printing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get crontab my-new-cron-object
</span></span></code></pre></div><p>Notice the <code>NAME</code>, <code>SPEC</code>, <code>REPLICAS</code>, and <code>AGE</code> columns in the output:</p><pre tabindex=0><code>NAME                 SPEC        REPLICAS   AGE
my-new-cron-object   * * * * *   1          7s
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The <code>NAME</code> column is implicit and does not need to be defined in the CustomResourceDefinition.</div><h4 id=priority>Priority</h4><p>Each column includes a <code>priority</code> field. Currently, the priority
differentiates between columns shown in standard view or wide view (using the <code>-o wide</code> flag).</p><ul><li>Columns with priority <code>0</code> are shown in standard view.</li><li>Columns with priority greater than <code>0</code> are shown only in wide view.</li></ul><h4 id=type>Type</h4><p>A column's <code>type</code> field can be any of the following (compare
<a href=https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#dataTypes>OpenAPI v3 data types</a>):</p><ul><li><code>integer</code> – non-floating-point numbers</li><li><code>number</code> – floating point numbers</li><li><code>string</code> – strings</li><li><code>boolean</code> – <code>true</code> or <code>false</code></li><li><code>date</code> – rendered differentially as time since this timestamp.</li></ul><p>If the value inside a CustomResource does not match the type specified for the column,
the value is omitted. Use CustomResource validation to ensure that the value
types are correct.</p><h4 id=format>Format</h4><p>A column's <code>format</code> field can be any of the following:</p><ul><li><code>int32</code></li><li><code>int64</code></li><li><code>float</code></li><li><code>double</code></li><li><code>byte</code></li><li><code>date</code></li><li><code>date-time</code></li><li><code>password</code></li></ul><p>The column's <code>format</code> controls the style used when <code>kubectl</code> prints the value.</p><h3 id=subresources>Subresources</h3><p>Custom resources support <code>/status</code> and <code>/scale</code> subresources.</p><p>The status and scale subresources can be optionally enabled by
defining them in the CustomResourceDefinition.</p><h4 id=status-subresource>Status subresource</h4><p>When the status subresource is enabled, the <code>/status</code> subresource for the custom resource is exposed.</p><ul><li><p>The status and the spec stanzas are represented by the <code>.status</code> and <code>.spec</code> JSONPaths
respectively inside of a custom resource.</p></li><li><p><code>PUT</code> requests to the <code>/status</code> subresource take a custom resource object and ignore changes to
anything except the status stanza.</p></li><li><p><code>PUT</code> requests to the <code>/status</code> subresource only validate the status stanza of the custom
resource.</p></li><li><p><code>PUT</code>/<code>POST</code>/<code>PATCH</code> requests to the custom resource ignore changes to the status stanza.</p></li><li><p>The <code>.metadata.generation</code> value is incremented for all changes, except for changes to
<code>.metadata</code> or <code>.status</code>.</p></li><li><p>Only the following constructs are allowed at the root of the CRD OpenAPI validation schema:</p><ul><li><code>description</code></li><li><code>example</code></li><li><code>exclusiveMaximum</code></li><li><code>exclusiveMinimum</code></li><li><code>externalDocs</code></li><li><code>format</code></li><li><code>items</code></li><li><code>maximum</code></li><li><code>maxItems</code></li><li><code>maxLength</code></li><li><code>minimum</code></li><li><code>minItems</code></li><li><code>minLength</code></li><li><code>multipleOf</code></li><li><code>pattern</code></li><li><code>properties</code></li><li><code>required</code></li><li><code>title</code></li><li><code>type</code></li><li><code>uniqueItems</code></li></ul></li></ul><h4 id=scale-subresource>Scale subresource</h4><p>When the scale subresource is enabled, the <code>/scale</code> subresource for the custom resource is exposed.
The <code>autoscaling/v1.Scale</code> object is sent as the payload for <code>/scale</code>.</p><p>To enable the scale subresource, the following fields are defined in the CustomResourceDefinition.</p><ul><li><p><code>specReplicasPath</code> defines the JSONPath inside of a custom resource that corresponds to <code>scale.spec.replicas</code>.</p><ul><li>It is a required value.</li><li>Only JSONPaths under <code>.spec</code> and with the dot notation are allowed.</li><li>If there is no value under the <code>specReplicasPath</code> in the custom resource,
the <code>/scale</code> subresource will return an error on GET.</li></ul></li><li><p><code>statusReplicasPath</code> defines the JSONPath inside of a custom resource that corresponds to <code>scale.status.replicas</code>.</p><ul><li>It is a required value.</li><li>Only JSONPaths under <code>.status</code> and with the dot notation are allowed.</li><li>If there is no value under the <code>statusReplicasPath</code> in the custom resource,
the status replica value in the <code>/scale</code> subresource will default to 0.</li></ul></li><li><p><code>labelSelectorPath</code> defines the JSONPath inside of a custom resource that corresponds to
<code>Scale.Status.Selector</code>.</p><ul><li>It is an optional value.</li><li>It must be set to work with HPA.</li><li>Only JSONPaths under <code>.status</code> or <code>.spec</code> and with the dot notation are allowed.</li><li>If there is no value under the <code>labelSelectorPath</code> in the custom resource,
the status selector value in the <code>/scale</code> subresource will default to the empty string.</li><li>The field pointed by this JSON path must be a string field (not a complex selector struct)
which contains a serialized label selector in string form.</li></ul></li></ul><p>In the following example, both status and scale subresources are enabled.</p><p>Save the CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>labelSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># subresources describes the subresources for custom resources.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>subresources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># status enables the status subresource.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># scale enables the scale subresource.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>scale</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># specReplicasPath defines the JSONPath inside of a custom resource that corresponds to Scale.Spec.Replicas.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>specReplicasPath</span>:<span style=color:#bbb> </span>.spec.replicas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># statusReplicasPath defines the JSONPath inside of a custom resource that corresponds to Scale.Status.Replicas.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>statusReplicasPath</span>:<span style=color:#bbb> </span>.status.replicas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># labelSelectorPath defines the JSONPath inside of a custom resource that corresponds to Scale.Status.Selector.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>labelSelectorPath</span>:<span style=color:#bbb> </span>.status.labelSelector<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div><p>And create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>After the CustomResourceDefinition object has been created, you can create custom objects.</p><p>If you save the following YAML to <code>my-crontab.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>and create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>Then new namespaced RESTful API endpoints are created at:</p><pre tabindex=0><code class=language-none data-lang=none>/apis/stable.example.com/v1/namespaces/*/crontabs/status
</code></pre><p>and</p><pre tabindex=0><code class=language-none data-lang=none>/apis/stable.example.com/v1/namespaces/*/crontabs/scale
</code></pre><p>A custom resource can be scaled using the <code>kubectl scale</code> command.
For example, the following command sets <code>.spec.replicas</code> of the
custom resource created above to 5:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl scale --replicas<span style=color:#666>=</span><span style=color:#666>5</span> crontabs/my-new-cron-object
</span></span><span style=display:flex><span>crontabs <span style=color:#b44>&#34;my-new-cron-object&#34;</span> scaled
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get crontabs my-new-cron-object -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.spec.replicas}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#666>5</span>
</span></span></code></pre></div><p>You can use a <a href=/docs/tasks/run-application/configure-pdb/>PodDisruptionBudget</a> to protect custom
resources that have the scale subresource enabled.</p><h3 id=categories>Categories</h3><p>Categories is a list of grouped resources the custom resource belongs to (eg. <code>all</code>).
You can use <code>kubectl get &lt;category-name></code> to list the resources belonging to the category.</p><p>The following example adds <code>all</code> in the list of categories in the CustomResourceDefinition
and illustrates how to output the custom resource using <code>kubectl get all</code>.</p><p>Save the following CustomResourceDefinition to <code>resourcedefinition.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># categories is a list of grouped resources the custom resource belongs to.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>categories</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- all<span style=color:#bbb>
</span></span></span></code></pre></div><p>and create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>After the CustomResourceDefinition object has been created, you can create custom objects.</p><p>Save the following YAML to <code>my-crontab.yaml</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span></code></pre></div><p>and create it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>You can specify the category when using <code>kubectl get</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get all
</span></span></code></pre></div><p>and it will include the custom resources of kind <code>CronTab</code>:</p><pre tabindex=0><code class=language-none data-lang=none>NAME                          AGE
crontabs/my-new-cron-object   3s
</code></pre><h2 id=what-s-next>What's next</h2><ul><li><p>Read about <a href=/docs/concepts/extend-kubernetes/api-extension/custom-resources/>custom resources</a>.</p></li><li><p>See <a href=/docs/reference/generated/kubernetes-api/v1.25/#customresourcedefinition-v1-apiextensions-k8s-io>CustomResourceDefinition</a>.</p></li><li><p>Serve <a href=/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/>multiple versions</a> of a
CustomResourceDefinition.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7d2e2400f208b1637530752794e5a3bd>11.2.2 - Versions in CustomResourceDefinitions</h1><p>This page explains how to add versioning information to
<a href=/docs/reference/kubernetes-api/extend-resources/custom-resource-definition-v1/>CustomResourceDefinitions</a>, to indicate the stability
level of your CustomResourceDefinitions or advance your API to a new version with conversion between API representations. It also describes how to upgrade an object from one version to another.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You should have an initial understanding of <a href=/docs/concepts/extend-kubernetes/api-extension/custom-resources/>custom resources</a>.</p>Your Kubernetes server must be at or later than version v1.16.
To check the version, enter <code>kubectl version</code>.<h2 id=overview>Overview</h2><p>The CustomResourceDefinition API provides a workflow for introducing and upgrading
to new versions of a CustomResourceDefinition.</p><p>When a CustomResourceDefinition is created, the first version is set in the
CustomResourceDefinition <code>spec.versions</code> list to an appropriate stability level
and a version number. For example <code>v1beta1</code> would indicate that the first
version is not yet stable. All custom resource objects will initially be stored
at this version.</p><p>Once the CustomResourceDefinition is created, clients may begin using the
<code>v1beta1</code> API.</p><p>Later it might be necessary to add new version such as <code>v1</code>.</p><p>Adding a new version:</p><ol><li>Pick a conversion strategy. Since custom resource objects need the ability to
be served at both versions, that means they will sometimes be served in a
different version than the one stored. To make this possible, the custom resource objects must sometimes be converted between the
version they are stored at and the version they are served at. If the
conversion involves schema changes and requires custom logic, a conversion
webhook should be used. If there are no schema changes, the default <code>None</code>
conversion strategy may be used and only the <code>apiVersion</code> field will be
modified when serving different versions.</li><li>If using conversion webhooks, create and deploy the conversion webhook. See
the <a href=#webhook-conversion>Webhook conversion</a> for more details.</li><li>Update the CustomResourceDefinition to include the new version in the
<code>spec.versions</code> list with <code>served:true</code>. Also, set <code>spec.conversion</code> field
to the selected conversion strategy. If using a conversion webhook, configure
<code>spec.conversion.webhookClientConfig</code> field to call the webhook.</li></ol><p>Once the new version is added, clients may incrementally migrate to the new
version. It is perfectly safe for some clients to use the old version while
others use the new version.</p><p>Migrate stored objects to the new version:</p><ol><li>See the <a href=#upgrade-existing-objects-to-a-new-stored-version>upgrade existing objects to a new stored version</a> section.</li></ol><p>It is safe for clients to use both the old and new version before, during and
after upgrading the objects to a new stored version.</p><p>Removing an old version:</p><ol><li>Ensure all clients are fully migrated to the new version. The kube-apiserver
logs can be reviewed to help identify any clients that are still accessing via
the old version.</li><li>Set <code>served</code> to <code>false</code> for the old version in the <code>spec.versions</code> list. If
any clients are still unexpectedly using the old version they may begin reporting
errors attempting to access the custom resource objects at the old version.
If this occurs, switch back to using <code>served:true</code> on the old version, migrate the
remaining clients to the new version and repeat this step.</li><li>Ensure the <a href=#upgrade-existing-objects-to-a-new-stored-version>upgrade of existing objects to the new stored version</a> step has been completed.<ol><li>Verify that the <code>storage</code> is set to <code>true</code> for the new version in the <code>spec.versions</code> list in the CustomResourceDefinition.</li><li>Verify that the old version is no longer listed in the CustomResourceDefinition <code>status.storedVersions</code>.</li></ol></li><li>Remove the old version from the CustomResourceDefinition <code>spec.versions</code> list.</li><li>Drop conversion support for the old version in conversion webhooks.</li></ol><h2 id=specify-multiple-versions>Specify multiple versions</h2><p>The CustomResourceDefinition API <code>versions</code> field can be used to support multiple versions of custom resources that you
have developed. Versions can have different schemas, and conversion webhooks can convert custom resources between versions.
Webhook conversions should follow the <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md>Kubernetes API conventions</a> wherever applicable.
Specifically, See the <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api_changes.md>API change documentation</a> for a set of useful gotchas and suggestions.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In <code>apiextensions.k8s.io/v1beta1</code>, there was a <code>version</code> field instead of <code>versions</code>. The
<code>version</code> field is deprecated and optional, but if it is not empty, it must
match the first item in the <code>versions</code> field.</div><p>This example shows a CustomResourceDefinition with two versions. For the first
example, the assumption is all versions share the same schema with no conversion
between them. The comments in the YAML provide more context.</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-1 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-1-0 role=tab aria-controls=customresourcedefinition-versioning-example-1-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-1-1 role=tab aria-controls=customresourcedefinition-versioning-example-1-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-example-1><div id=customresourcedefinition-versioning-example-1-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-1-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># list of versions supported by this CustomResourceDefinition</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Each version can be enabled/disabled by Served flag.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># One and only one version must be marked as the storage version.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># A schema is required</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># The conversion section is introduced in Kubernetes 1.13+ with a default value of</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># None conversion (strategy sub-field set to None).</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># None conversion assumes the same schema for all versions and only sets the apiVersion</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># field of custom resources to the proper value</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># either Namespaced or Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># singular name to be used as an alias on the CLI and for display</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind is normally the CamelCased singular type. Your resource manifests use this.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames allow shorter string to match your resource on the CLI</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-example-1-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-1-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># list of versions supported by this CustomResourceDefinition</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Each version can be enabled/disabled by Served flag.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># One and only one version must be marked as the storage version.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>validation</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># The conversion section is introduced in Kubernetes 1.13+ with a default value of</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># None conversion (strategy sub-field set to None).</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># None conversion assumes the same schema for all versions and only sets the apiVersion</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># field of custom resources to the proper value</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># either Namespaced or Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># singular name to be used as an alias on the CLI and for display</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind is normally the PascalCased singular type. Your resource manifests use this.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames allow shorter string to match your resource on the CLI</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>You can save the CustomResourceDefinition in a YAML file, then use
<code>kubectl apply</code> to create it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-versioned-crontab.yaml
</span></span></code></pre></div><p>After creation, the API server starts to serve each enabled version at an HTTP
REST endpoint. In the above example, the API versions are available at
<code>/apis/example.com/v1beta1</code> and <code>/apis/example.com/v1</code>.</p><h3 id=version-priority>Version priority</h3><p>Regardless of the order in which versions are defined in a
CustomResourceDefinition, the version with the highest priority is used by
kubectl as the default version to access objects. The priority is determined
by parsing the <em>name</em> field to determine the version number, the stability
(GA, Beta, or Alpha), and the sequence within that stability level.</p><p>The algorithm used for sorting the versions is designed to sort versions in the
same way that the Kubernetes project sorts Kubernetes versions. Versions start with a
<code>v</code> followed by a number, an optional <code>beta</code> or <code>alpha</code> designation, and
optional additional numeric versioning information. Broadly, a version string might look
like <code>v2</code> or <code>v2beta1</code>. Versions are sorted using the following algorithm:</p><ul><li>Entries that follow Kubernetes version patterns are sorted before those that
do not.</li><li>For entries that follow Kubernetes version patterns, the numeric portions of
the version string is sorted largest to smallest.</li><li>If the strings <code>beta</code> or <code>alpha</code> follow the first numeric portion, they sorted
in that order, after the equivalent string without the <code>beta</code> or <code>alpha</code>
suffix (which is presumed to be the GA version).</li><li>If another number follows the <code>beta</code>, or <code>alpha</code>, those numbers are also
sorted from largest to smallest.</li><li>Strings that don't fit the above format are sorted alphabetically and the
numeric portions are not treated specially. Notice that in the example below,
<code>foo1</code> is sorted above <code>foo10</code>. This is different from the sorting of the
numeric portion of entries that do follow the Kubernetes version patterns.</li></ul><p>This might make sense if you look at the following sorted version list:</p><pre tabindex=0><code class=language-none data-lang=none>- v10
- v2
- v1
- v11beta2
- v10beta3
- v3beta1
- v12alpha1
- v11alpha2
- foo1
- foo10
</code></pre><p>For the example in <a href=#specify-multiple-versions>Specify multiple versions</a>, the
version sort order is <code>v1</code>, followed by <code>v1beta1</code>. This causes the kubectl
command to use <code>v1</code> as the default version unless the provided object specifies
the version.</p><h3 id=version-deprecation>Version deprecation</h3><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.19 [stable]</code></div><p>Starting in v1.19, a CustomResourceDefinition can indicate a particular version of the resource it defines is deprecated.
When API requests to a deprecated version of that resource are made, a warning message is returned in the API response as a header.
The warning message for each deprecated version of the resource can be customized if desired.</p><p>A customized warning message should indicate the deprecated API group, version, and kind,
and should indicate what API group, version, and kind should be used instead, if applicable.</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-deprecated role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-deprecated-0 role=tab aria-controls=customresourcedefinition-versioning-deprecated-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-deprecated-1 role=tab aria-controls=customresourcedefinition-versioning-deprecated-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-deprecated><div id=customresourcedefinition-versioning-deprecated-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-deprecated-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1alpha1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This indicates the v1alpha1 version of the custom resource is deprecated.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># API requests to this version receive a warning header in the server response.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This overrides the default warning returned to API clients making v1alpha1 API requests.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecationWarning</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This indicates the v1beta1 version of the custom resource is deprecated.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># API requests to this version receive a warning header in the server response.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># A default warning message is returned for this version.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-deprecated-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-deprecated-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>validation</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1alpha1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This indicates the v1alpha1 version of the custom resource is deprecated.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># API requests to this version receive a warning header in the server response.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This overrides the default warning returned to API clients making v1alpha1 API requests.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecationWarning</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This indicates the v1beta1 version of the custom resource is deprecated.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># API requests to this version receive a warning header in the server response.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># A default warning message is returned for this version.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h3 id=version-removal>Version removal</h3><p>An older API version cannot be dropped from a CustomResourceDefinition manifest until existing persisted data has been migrated to the newer API version for all clusters that served the older version of the custom resource, and the old version is removed from the <code>status.storedVersions</code> of the CustomResourceDefinition.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This indicates the v1beta1 version of the custom resource is no longer served.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># API requests to this version receive a not found error in the server response.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The new served version should be set as the storage version</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=webhook-conversion>Webhook conversion</h2><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.16 [stable]</code></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Webhook conversion is available as beta since 1.15, and as alpha since Kubernetes 1.13. The
<code>CustomResourceWebhookConversion</code> feature must be enabled, which is the case automatically for many clusters for beta features. Please refer to the <a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gate</a> documentation for more information.</div><p>The above example has a None conversion between versions which only sets the <code>apiVersion</code> field
on conversion and does not change the rest of the object. The API server also supports webhook
conversions that call an external service in case a conversion is required. For example when:</p><ul><li>custom resource is requested in a different version than stored version.</li><li>Watch is created in one version but the changed object is stored in another version.</li><li>custom resource PUT request is in a different version than storage version.</li></ul><p>To cover all of these cases and to optimize conversion by the API server,
the conversion requests may contain multiple objects in order to minimize the external calls.
The webhook should perform these conversions independently.</p><h3 id=write-a-conversion-webhook-server>Write a conversion webhook server</h3><p>Please refer to the implementation of the <a href=https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/main.go>custom resource conversion webhook
server</a>
that is validated in a Kubernetes e2e test. The webhook handles the
<code>ConversionReview</code> requests sent by the API servers, and sends back conversion
results wrapped in <code>ConversionResponse</code>. Note that the request
contains a list of custom resources that need to be converted independently without
changing the order of objects.
The example server is organized in a way to be reused for other conversions.
Most of the common code are located in the
<a href=https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/converter/framework.go>framework file</a>
that leaves only
<a href=https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/converter/example_converter.go#L29-L80>one function</a>
to be implemented for different conversions.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The example conversion webhook server leaves the <code>ClientAuth</code> field
<a href=https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/config.go#L47-L48>empty</a>,
which defaults to <code>NoClientCert</code>. This means that the webhook server does not
authenticate the identity of the clients, supposedly API servers. If you need
mutual TLS or other ways to authenticate the clients, see
how to <a href=/docs/reference/access-authn-authz/extensible-admission-controllers/#authenticate-apiservers>authenticate API servers</a>.</div><h4 id=permissible-mutations>Permissible mutations</h4><p>A conversion webhook must not mutate anything inside of <code>metadata</code> of the converted object
other than <code>labels</code> and <code>annotations</code>.
Attempted changes to <code>name</code>, <code>UID</code> and <code>namespace</code> are rejected and fail the request
which caused the conversion. All other changes are ignored.</p><h3 id=deploy-the-conversion-webhook-service>Deploy the conversion webhook service</h3><p>Documentation for deploying the conversion webhook is the same as for the
<a href=/docs/reference/access-authn-authz/extensible-admission-controllers/#deploy_the_admission_webhook_service>admission webhook example service</a>.
The assumption for next sections is that the conversion webhook server is deployed to a service
named <code>example-conversion-webhook-server</code> in <code>default</code> namespace and serving traffic on path <code>/crdconvert</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> When the webhook server is deployed into the Kubernetes cluster as a
service, it has to be exposed via a service on port 443 (The server
itself can have an arbitrary port but the service object should map it to port 443).
The communication between the API server and the webhook service may fail
if a different port is used for the service.</div><h3 id=configure-customresourcedefinition-to-use-conversion-webhooks>Configure CustomResourceDefinition to use conversion webhooks</h3><p>The <code>None</code> conversion example can be extended to use the conversion webhook by modifying <code>conversion</code>
section of the <code>spec</code>:</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-2 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-2-0 role=tab aria-controls=customresourcedefinition-versioning-example-2-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-2-1 role=tab aria-controls=customresourcedefinition-versioning-example-2-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-example-2><div id=customresourcedefinition-versioning-example-2-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-2-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># list of versions supported by this CustomResourceDefinition</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Each version can be enabled/disabled by Served flag.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># One and only one version must be marked as the storage version.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Each version can define its own schema when there is no top-level</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># schema is defined.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># a Webhook strategy instruct API server to call an external webhook for any conversion between custom resources.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># webhook is required when strategy is `Webhook` and it configures the webhook endpoint to be called by API server.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># conversionReviewVersions indicates what ConversionReview versions are understood/preferred by the webhook.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># The first version in the list understood by the API server is sent to the webhook.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># The webhook must respond with a ConversionReview object in the same version it received.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-conversion-webhook-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/crdconvert<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># either Namespaced or Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># singular name to be used as an alias on the CLI and for display</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind is normally the CamelCased singular type. Your resource manifests use this.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames allow shorter string to match your resource on the CLI</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-example-2-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-2-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># prunes object fields that are not specified in OpenAPI schemas below.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>preserveUnknownFields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># list of versions supported by this CustomResourceDefinition</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Each version can be enabled/disabled by Served flag.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># One and only one version must be marked as the storage version.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Each version can define its own schema when there is no top-level</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># schema is defined.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># a Webhook strategy instruct API server to call an external webhook for any conversion between custom resources.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># webhookClientConfig is required when strategy is `Webhook` and it configures the webhook endpoint to be called by API server.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-conversion-webhook-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/crdconvert<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># either Namespaced or Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># singular name to be used as an alias on the CLI and for display</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind is normally the CamelCased singular type. Your resource manifests use this.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames allow shorter string to match your resource on the CLI</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>You can save the CustomResourceDefinition in a YAML file, then use
<code>kubectl apply</code> to apply it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-versioned-crontab-with-conversion.yaml
</span></span></code></pre></div><p>Make sure the conversion service is up and running before applying new changes.</p><h3 id=contacting-the-webhook>Contacting the webhook</h3><p>Once the API server has determined a request should be sent to a conversion webhook,
it needs to know how to contact the webhook. This is specified in the <code>webhookClientConfig</code>
stanza of the webhook configuration.</p><p>Conversion webhooks can either be called via a URL or a service reference,
and can optionally include a custom CA bundle to use to verify the TLS connection.</p><h3 id=url>URL</h3><p><code>url</code> gives the location of the webhook, in standard URL form
(<code>scheme://host:port/path</code>).</p><p>The <code>host</code> should not refer to a service running in the cluster; use
a service reference by specifying the <code>service</code> field instead.
The host might be resolved via external DNS in some apiservers
(i.e., <code>kube-apiserver</code> cannot resolve in-cluster DNS as that would
be a layering violation). <code>host</code> may also be an IP address.</p><p>Please note that using <code>localhost</code> or <code>127.0.0.1</code> as a <code>host</code> is
risky unless you take great care to run this webhook on all hosts
which run an apiserver which might need to make calls to this
webhook. Such installations are likely to be non-portable or not readily run in a new cluster.</p><p>The scheme must be "https"; the URL must begin with "https://".</p><p>Attempting to use a user or basic auth (for example "user:password@") is not allowed.
Fragments ("#...") and query parameters ("?...") are also not allowed.</p><p>Here is an example of a conversion webhook configured to call a URL
(and expects the TLS certificate to be verified using system trust roots, so does not specify a caBundle):</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-3 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-3-0 role=tab aria-controls=customresourcedefinition-versioning-example-3-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-3-1 role=tab aria-controls=customresourcedefinition-versioning-example-3-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-example-3><div id=customresourcedefinition-versioning-example-3-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-3-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;https://my-webhook.example.com:9443/my-webhook-path&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-example-3-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-3-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;https://my-webhook.example.com:9443/my-webhook-path&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h3 id=service-reference>Service Reference</h3><p>The <code>service</code> stanza inside <code>webhookClientConfig</code> is a reference to the service for a conversion webhook.
If the webhook is running within the cluster, then you should use <code>service</code> instead of <code>url</code>.
The service namespace and name are required. The port is optional and defaults to 443.
The path is optional and defaults to "/".</p><p>Here is an example of a webhook that is configured to call a service on port "1234"
at the subpath "/my-path", and to verify the TLS connection against the ServerName
<code>my-service-name.my-service-namespace.svc</code> using a custom CA bundle.</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-4 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-4-0 role=tab aria-controls=customresourcedefinition-versioning-example-4-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-4-1 role=tab aria-controls=customresourcedefinition-versioning-example-4-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-example-4><div id=customresourcedefinition-versioning-example-4-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-4-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-service-namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service-name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/my-path<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>1234</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-example-4-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-4-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-service-namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service-name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/my-path<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>1234</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h2 id=webhook-request-and-response>Webhook request and response</h2><h3 id=request>Request</h3><p>Webhooks are sent a POST request, with <code>Content-Type: application/json</code>,
with a <code>ConversionReview</code> API object in the <code>apiextensions.k8s.io</code> API group
serialized to JSON as the body.</p><p>Webhooks can specify what versions of <code>ConversionReview</code> objects they accept
with the <code>conversionReviewVersions</code> field in their CustomResourceDefinition:</p><ul class="nav nav-tabs" id=conversionreviewversions role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreviewversions-0 role=tab aria-controls=conversionreviewversions-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreviewversions-1 role=tab aria-controls=conversionreviewversions-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=conversionreviewversions><div id=conversionreviewversions-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreviewversions-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>conversionReviewVersions</code> is a required field when creating
<code>apiextensions.k8s.io/v1</code> custom resource definitions.
Webhooks are required to support at least one <code>ConversionReview</code>
version understood by the current and previous API server.</p></div><div id=conversionreviewversions-1 class=tab-pane role=tabpanel aria-labelledby=conversionreviewversions-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><p>If no <code>conversionReviewVersions</code> are specified, the default when creating
<code>apiextensions.k8s.io/v1beta1</code> custom resource definitions is <code>v1beta1</code>.</p></div></div><p>API servers send the first <code>ConversionReview</code> version in the <code>conversionReviewVersions</code> list they support.
If none of the versions in the list are supported by the API server, the custom resource definition will not be allowed to be created.
If an API server encounters a conversion webhook configuration that was previously created and does not support any of the <code>ConversionReview</code>
versions the API server knows how to send, attempts to call to the webhook will fail.</p><p>This example shows the data contained in an <code>ConversionReview</code> object
for a request to convert <code>CronTab</code> objects to <code>example.com/v1</code>:</p><ul class="nav nav-tabs" id=conversionreview-request role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-request-0 role=tab aria-controls=conversionreview-request-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-request-1 role=tab aria-controls=conversionreview-request-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=conversionreview-request><div id=conversionreview-request-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-request-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;request&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Random uid uniquely identifying this conversion call</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The API group and version the objects should be converted to</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;desiredAPIVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The list of objects to convert.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># May contain one or more objects, in one or more versions.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;objects&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;local-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;hostPort&#34;: </span><span style=color:#b44>&#34;localhost:1234&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;remote-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;hostPort&#34;: </span><span style=color:#b44>&#34;example.com:2345&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=conversionreview-request-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-request-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;request&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Random uid uniquely identifying this conversion call</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The API group and version the objects should be converted to</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;desiredAPIVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The list of objects to convert.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># May contain one or more objects, in one or more versions.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;objects&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;local-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;hostPort&#34;: </span><span style=color:#b44>&#34;localhost:1234&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;remote-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;hostPort&#34;: </span><span style=color:#b44>&#34;example.com:2345&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h3 id=response>Response</h3><p>Webhooks respond with a 200 HTTP status code, <code>Content-Type: application/json</code>,
and a body containing a <code>ConversionReview</code> object (in the same version they were sent),
with the <code>response</code> stanza populated, serialized to JSON.</p><p>If conversion succeeds, a webhook should return a <code>response</code> stanza containing the following fields:</p><ul><li><code>uid</code>, copied from the <code>request.uid</code> sent to the webhook</li><li><code>result</code>, set to <code>{"status":"Success"}</code></li><li><code>convertedObjects</code>, containing all of the objects from <code>request.objects</code>, converted to <code>request.desiredVersion</code></li></ul><p>Example of a minimal successful response from a webhook:</p><ul class="nav nav-tabs" id=conversionreview-response-success role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-response-success-0 role=tab aria-controls=conversionreview-response-success-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-response-success-1 role=tab aria-controls=conversionreview-response-success-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=conversionreview-response-success><div id=conversionreview-response-success-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-response-success-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;response&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># must match &lt;request.uid&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;result&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;status&#34;: </span><span style=color:#b44>&#34;Success&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Objects must match the order of request.objects, and have apiVersion set to &lt;request.desiredAPIVersion&gt;.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind, metadata.uid, metadata.name, and metadata.namespace fields must not be changed by the webhook.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># metadata.labels and metadata.annotations fields may be changed by the webhook.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># All other changes to metadata fields by the webhook are ignored.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;convertedObjects&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;local-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;host&#34;: </span><span style=color:#b44>&#34;localhost&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;port&#34;: </span><span style=color:#b44>&#34;1234&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;remote-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;host&#34;: </span><span style=color:#b44>&#34;example.com&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;port&#34;: </span><span style=color:#b44>&#34;2345&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=conversionreview-response-success-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-response-success-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;response&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># must match &lt;request.uid&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;result&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;status&#34;: </span><span style=color:#b44>&#34;Failed&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Objects must match the order of request.objects, and have apiVersion set to &lt;request.desiredAPIVersion&gt;.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind, metadata.uid, metadata.name, and metadata.namespace fields must not be changed by the webhook.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># metadata.labels and metadata.annotations fields may be changed by the webhook.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># All other changes to metadata fields by the webhook are ignored.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;convertedObjects&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;local-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;host&#34;: </span><span style=color:#b44>&#34;localhost&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;port&#34;: </span><span style=color:#b44>&#34;1234&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;remote-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;host&#34;: </span><span style=color:#b44>&#34;example.com&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;port&#34;: </span><span style=color:#b44>&#34;2345&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>If conversion fails, a webhook should return a <code>response</code> stanza containing the following fields:</p><ul><li><code>uid</code>, copied from the <code>request.uid</code> sent to the webhook</li><li><code>result</code>, set to <code>{"status":"Failed"}</code></li></ul><div class="alert alert-danger warning callout" role=alert><strong>Warning:</strong> Failing conversion can disrupt read and write access to the custom resources,
including the ability to update or delete the resources. Conversion failures
should be avoided whenever possible, and should not be used to enforce validation
constraints (use validation schemas or webhook admission instead).</div><p>Example of a response from a webhook indicating a conversion request failed, with an optional message:<ul class="nav nav-tabs" id=conversionreview-response-failure role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-response-failure-0 role=tab aria-controls=conversionreview-response-failure-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-response-failure-1 role=tab aria-controls=conversionreview-response-failure-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=conversionreview-response-failure><div id=conversionreview-response-failure-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-response-failure-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;response&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;&lt;value from request.uid&gt;&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;result&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;status&#34;: </span><span style=color:#b44>&#34;Failed&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;message&#34;: </span><span style=color:#b44>&#34;hostPort could not be parsed into a separate host and port&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=conversionreview-response-failure-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-response-failure-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;response&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;&lt;value from request.uid&gt;&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;result&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;status&#34;: </span><span style=color:#b44>&#34;Failed&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;message&#34;: </span><span style=color:#b44>&#34;hostPort could not be parsed into a separate host and port&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div></p><h2 id=writing-reading-and-updating-versioned-customresourcedefinition-objects>Writing, reading, and updating versioned CustomResourceDefinition objects</h2><p>When an object is written, it is persisted at the version designated as the
storage version at the time of the write. If the storage version changes,
existing objects are never converted automatically. However, newly-created
or updated objects are written at the new storage version. It is possible for an
object to have been written at a version that is no longer served.</p><p>When you read an object, you specify the version as part of the path. If you
specify a version that is different from the object's persisted version,
Kubernetes returns the object to you at the version you requested, but the
persisted object is neither changed on disk, nor converted in any way
(other than changing the <code>apiVersion</code> string) while serving the request.
You can request an object at any version that is currently served.</p><p>If you update an existing object, it is rewritten at the version that is
currently the storage version. This is the only way that objects can change from
one version to another.</p><p>To illustrate this, consider the following hypothetical series of events:</p><ol><li>The storage version is <code>v1beta1</code>. You create an object. It is persisted in
storage at version <code>v1beta1</code></li><li>You add version <code>v1</code> to your CustomResourceDefinition and designate it as
the storage version.</li><li>You read your object at version <code>v1beta1</code>, then you read the object again at
version <code>v1</code>. Both returned objects are identical except for the apiVersion
field.</li><li>You create a new object. It is persisted in storage at version <code>v1</code>. You now
have two objects, one of which is at <code>v1beta1</code>, and the other of which is at
<code>v1</code>.</li><li>You update the first object. It is now persisted at version <code>v1</code> since that
is the current storage version.</li></ol><h3 id=previous-storage-versions>Previous storage versions</h3><p>The API server records each version which has ever been marked as the storage
version in the status field <code>storedVersions</code>. Objects may have been persisted
at any version that has ever been designated as a storage version. No objects
can exist in storage at a version that has never been a storage version.</p><h2 id=upgrade-existing-objects-to-a-new-stored-version>Upgrade existing objects to a new stored version</h2><p>When deprecating versions and dropping support, select a storage upgrade
procedure.</p><p><em>Option 1:</em> Use the Storage Version Migrator</p><ol><li>Run the <a href=https://github.com/kubernetes-sigs/kube-storage-version-migrator>storage Version migrator</a></li><li>Remove the old version from the CustomResourceDefinition <code>status.storedVersions</code> field.</li></ol><p><em>Option 2:</em> Manually upgrade the existing objects to a new stored version</p><p>The following is an example procedure to upgrade from <code>v1beta1</code> to <code>v1</code>.</p><ol><li>Set <code>v1</code> as the storage in the CustomResourceDefinition file and apply it
using kubectl. The <code>storedVersions</code> is now <code>v1beta1, v1</code>.</li><li>Write an upgrade procedure to list all existing objects and write them with
the same content. This forces the backend to write objects in the current
storage version, which is <code>v1</code>.</li><li>Remove <code>v1beta1</code> from the CustomResourceDefinition <code>status.storedVersions</code> field.</li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>The flag <code>--subresource</code> is used with the kubectl get, patch, edit, and replace commands to
fetch and update the subresources, <code>status</code> and <code>scale</code>, for all the API resources that
support them. This flag is available starting from kubectl version v1.24. Previously, reading
subresources (like <code>status</code>) via kubectl involved using <code>kubectl --raw</code>, and updating
subresources using kubectl was not possible at all. Starting from v1.24, the <code>kubectl</code> tool
can be used to edit or patch the <code>status</code> subresource on a CRD object. See <a href=/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#scale-kubectl-patch>How to patch a Deployment using the subresource flag</a>.</p><p>This page is part of the documentation for Kubernetes v1.25.
If you are running a different version of Kubernetes, consult the documentation for that release.</p><p>Here is an example of how to patch the <code>status</code> subresource for a CRD object using <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch customresourcedefinitions &lt;CRD_Name&gt; --subresource<span style=color:#666>=</span><span style=color:#b44>&#39;status&#39;</span> --type<span style=color:#666>=</span><span style=color:#b44>&#39;merge&#39;</span> -p <span style=color:#b44>&#39;{&#34;status&#34;:{&#34;storedVersions&#34;:[&#34;v1&#34;]}}&#39;</span>
</span></span></code></pre></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c4798e42eaccc051e396542befb3c57b>11.3 - Set up an Extension API Server</h1><p>Setting up an extension API server to work with the aggregation layer allows the Kubernetes apiserver to be extended with additional APIs, which are not part of the core Kubernetes APIs.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><ul><li>You must <a href=/docs/tasks/extend-kubernetes/configure-aggregation-layer/>configure the aggregation layer</a> and enable the apiserver flags.</li></ul><h2 id=set-up-an-extension-api-server-to-work-with-the-aggregation-layer>Set up an extension api-server to work with the aggregation layer</h2><p>The following steps describe how to set up an extension-apiserver <em>at a high level</em>. These steps apply regardless if you're using YAML configs or using APIs. An attempt is made to specifically identify any differences between the two. For a concrete example of how they can be implemented using YAML configs, you can look at the <a href=https://github.com/kubernetes/sample-apiserver/blob/master/README.md>sample-apiserver</a> in the Kubernetes repo.</p><p>Alternatively, you can use an existing 3rd party solution, such as <a href=https://github.com/kubernetes-sigs/apiserver-builder-alpha/blob/master/README.md>apiserver-builder</a>, which should generate a skeleton and automate all of the following steps for you.</p><ol><li>Make sure the APIService API is enabled (check <code>--runtime-config</code>). It should be on by default, unless it's been deliberately turned off in your cluster.</li><li>You may need to make an RBAC rule allowing you to add APIService objects, or get your cluster administrator to make one. (Since API extensions affect the entire cluster, it is not recommended to do testing/development/debug of an API extension in a live cluster.)</li><li>Create the Kubernetes namespace you want to run your extension api-service in.</li><li>Create/get a CA cert to be used to sign the server cert the extension api-server uses for HTTPS.</li><li>Create a server cert/key for the api-server to use for HTTPS. This cert should be signed by the above CA. It should also have a CN of the Kube DNS name. This is derived from the Kubernetes service and be of the form <code>&lt;service name>.&lt;service name namespace>.svc</code></li><li>Create a Kubernetes secret with the server cert/key in your namespace.</li><li>Create a Kubernetes deployment for the extension api-server and make sure you are loading the secret as a volume. It should contain a reference to a working image of your extension api-server. The deployment should also be in your namespace.</li><li>Make sure that your extension-apiserver loads those certs from that volume and that they are used in the HTTPS handshake.</li><li>Create a Kubernetes service account in your namespace.</li><li>Create a Kubernetes cluster role for the operations you want to allow on your resources.</li><li>Create a Kubernetes cluster role binding from the service account in your namespace to the cluster role you created.</li><li>Create a Kubernetes cluster role binding from the service account in your namespace to the <code>system:auth-delegator</code> cluster role to delegate auth decisions to the Kubernetes core API server.</li><li>Create a Kubernetes role binding from the service account in your namespace to the <code>extension-apiserver-authentication-reader</code> role. This allows your extension api-server to access the <code>extension-apiserver-authentication</code> configmap.</li><li>Create a Kubernetes apiservice. The CA cert above should be base64 encoded, stripped of new lines and used as the spec.caBundle in the apiservice. This should not be namespaced. If using the <a href=https://github.com/kubernetes/kube-aggregator/>kube-aggregator API</a>, only pass in the PEM encoded CA bundle because the base 64 encoding is done for you.</li><li>Use kubectl to get your resource. When run, kubectl should return "No resources found.". This message
indicates that everything worked but you currently have no objects of that resource type created.</li></ol><h2 id=what-s-next>What's next</h2><ul><li>Walk through the steps to <a href=/docs/tasks/extend-kubernetes/configure-aggregation-layer/>configure the API aggregation layer</a> and enable the apiserver flags.</li><li>For a high level overview, see <a href=/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>Extending the Kubernetes API with the aggregation layer</a>.</li><li>Learn how to <a href=/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/>Extend the Kubernetes API using Custom Resource Definitions</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c00a2767fac9dbfafce583cf489cc423>11.4 - Configure Multiple Schedulers</h1><p>Kubernetes ships with a default scheduler that is described
<a href=/docs/reference/command-line-tools-reference/kube-scheduler/>here</a>.
If the default scheduler does not suit your needs you can implement your own scheduler.
Moreover, you can even run multiple schedulers simultaneously alongside the default
scheduler and instruct Kubernetes what scheduler to use for each of your pods. Let's
learn how to run multiple schedulers in Kubernetes with an example.</p><p>A detailed description of how to implement a scheduler is outside the scope of this
document. Please refer to the kube-scheduler implementation in
<a href=https://github.com/kubernetes/kubernetes/tree/master/pkg/scheduler>pkg/scheduler</a>
in the Kubernetes source directory for a canonical example.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><h2 id=package-the-scheduler>Package the scheduler</h2><p>Package your scheduler binary into a container image. For the purposes of this example,
you can use the default scheduler (kube-scheduler) as your second scheduler.
Clone the <a href=https://github.com/kubernetes/kubernetes>Kubernetes source code from GitHub</a>
and build the source.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/kubernetes/kubernetes.git
</span></span><span style=display:flex><span><span style=color:#a2f>cd</span> kubernetes
</span></span><span style=display:flex><span>make
</span></span></code></pre></div><p>Create a container image containing the kube-scheduler binary. Here is the <code>Dockerfile</code>
to build the image:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#b44> busybox</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ADD</span> ./_output/local/bin/linux/amd64/kube-scheduler /usr/local/bin/kube-scheduler<span>
</span></span></span></code></pre></div><p>Save the file as <code>Dockerfile</code>, build the image and push it to a registry. This example
pushes the image to
<a href=https://cloud.google.com/container-registry/>Google Container Registry (GCR)</a>.
For more details, please read the GCR
<a href=https://cloud.google.com/container-registry/docs/>documentation</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build -t gcr.io/my-gcp-project/my-kube-scheduler:1.0 .
</span></span><span style=display:flex><span>gcloud docker -- push gcr.io/my-gcp-project/my-kube-scheduler:1.0
</span></span></code></pre></div><h2 id=define-a-kubernetes-deployment-for-the-scheduler>Define a Kubernetes Deployment for the scheduler</h2><p>Now that you have your scheduler in a container image, create a pod
configuration for it and run it in your Kubernetes cluster. But instead of creating a pod
directly in the cluster, you can use a <a href=/docs/concepts/workloads/controllers/deployment/>Deployment</a>
for this example. A <a href=/docs/concepts/workloads/controllers/deployment/>Deployment</a> manages a
<a href=/docs/concepts/workloads/controllers/replicaset/>Replica Set</a> which in turn manages the pods,
thereby making the scheduler resilient to failures. Here is the deployment
config. Save it as <code>my-scheduler.yaml</code>:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/my-scheduler.yaml download=admin/sched/my-scheduler.yaml><code>admin/sched/my-scheduler.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-sched-my-scheduler-yaml")' title="Copy admin/sched/my-scheduler.yaml to clipboard"></img></div><div class=includecode id=admin-sched-my-scheduler-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler-as-kube-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:kube-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler-as-volume-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:volume-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler-config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>my-scheduler-config.yaml</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    apiVersion: kubescheduler.config.k8s.io/v1beta2
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    kind: KubeSchedulerConfiguration
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    profiles:
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      - schedulerName: my-scheduler
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>    leaderElection:
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>      leaderElect: false</span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>second<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- /usr/local/bin/kube-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- --config=/etc/kubernetes/my-scheduler/my-scheduler-config.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/my-gcp-project/my-kube-scheduler:1.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>10259</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>scheme</span>:<span style=color:#bbb> </span>HTTPS<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-second-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>readinessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>10259</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>scheme</span>:<span style=color:#bbb> </span>HTTPS<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;0.1&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>privileged</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/my-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPID</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler-config<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the above manifest, you use a <a href=/docs/reference/scheduling/config/>KubeSchedulerConfiguration</a>
to customize the behavior of your scheduler implementation. This configuration has been passed to
the <code>kube-scheduler</code> during initialization with the <code>--config</code> option. The <code>my-scheduler-config</code> ConfigMap stores the configuration file. The Pod of the<code>my-scheduler</code> Deployment mounts the <code>my-scheduler-config</code> ConfigMap as a volume.</p><p>In the aforementioned Scheduler Configuration, your scheduler implementation is represented via
a <a href=/docs/reference/config-api/kube-scheduler-config.v1beta3/#kubescheduler-config-k8s-io-v1beta3-KubeSchedulerProfile>KubeSchedulerProfile</a>.<div class="alert alert-info note callout" role=alert><strong>Note:</strong> To determine if a scheduler is responsible for scheduling a specific Pod, the <code>spec.schedulerName</code> field in a
PodTemplate or Pod manifest must match the <code>schedulerName</code> field of the <code>KubeSchedulerProfile</code>.
All schedulers running in the cluster must have unique names.</div></p><p>Also, note that you create a dedicated service account <code>my-scheduler</code> and bind the ClusterRole
<code>system:kube-scheduler</code> to it so that it can acquire the same privileges as <code>kube-scheduler</code>.</p><p>Please see the
<a href=/docs/reference/command-line-tools-reference/kube-scheduler/>kube-scheduler documentation</a> for
detailed description of other command line arguments and
<a href=/docs/reference/config-api/kube-scheduler-config.v1beta3/>Scheduler Configuration reference</a> for
detailed description of other customizable <code>kube-scheduler</code> configurations.</p><h2 id=run-the-second-scheduler-in-the-cluster>Run the second scheduler in the cluster</h2><p>In order to run your scheduler in a Kubernetes cluster, create the deployment
specified in the config above in a Kubernetes cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f my-scheduler.yaml
</span></span></code></pre></div><p>Verify that the scheduler pod is running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --namespace<span style=color:#666>=</span>kube-system
</span></span></code></pre></div><pre tabindex=0><code>NAME                                           READY     STATUS    RESTARTS   AGE
....
my-scheduler-lnf4s-4744f                       1/1       Running   0          2m
...
</code></pre><p>You should see a "Running" my-scheduler pod, in addition to the default kube-scheduler
pod in this list.</p><h3 id=enable-leader-election>Enable leader election</h3><p>To run multiple-scheduler with leader election enabled, you must do the following:</p><p>Update the following fields for the KubeSchedulerConfiguration in the <code>my-scheduler-config</code> ConfigMap in your YAML file:</p><ul><li><code>leaderElection.leaderElect</code> to <code>true</code></li><li><code>leaderElection.resourceNamespace</code> to <code>&lt;lock-object-namespace></code></li><li><code>leaderElection.resourceName</code> to <code>&lt;lock-object-name></code></li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The control plane creates the lock objects for you, but the namespace must already exist.
You can use the <code>kube-system</code> namespace.</div><p>If RBAC is enabled on your cluster, you must update the <code>system:kube-scheduler</code> cluster role.
Add your scheduler name to the resourceNames of the rule applied for <code>endpoints</code> and <code>leases</code> resources, as in the following example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit clusterrole system:kube-scheduler
</span></span></code></pre></div><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/clusterrole.yaml download=admin/sched/clusterrole.yaml><code>admin/sched/clusterrole.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-sched-clusterrole-yaml")' title="Copy admin/sched/clusterrole.yaml to clipboard"></img></div><div class=includecode id=admin-sched-clusterrole-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rbac.authorization.kubernetes.io/autoupdate</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/bootstrapping</span>:<span style=color:#bbb> </span>rbac-defaults<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:kube-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- coordination.k8s.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- leases<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- create<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- coordination.k8s.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resourceNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- kube-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- my-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- leases<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- get<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- update<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resourceNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- kube-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- my-scheduler<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- endpoints<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- delete<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- get<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- patch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- update<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h2 id=specify-schedulers-for-pods>Specify schedulers for pods</h2><p>Now that your second scheduler is running, create some pods, and direct them
to be scheduled by either the default scheduler or the one you deployed.
In order to schedule a given pod using a specific scheduler, specify the name of the
scheduler in that pod spec. Let's look at three examples.</p><ul><li><p>Pod spec without any scheduler name</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/pod1.yaml download=admin/sched/pod1.yaml><code>admin/sched/pod1.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-sched-pod1-yaml")' title="Copy admin/sched/pod1.yaml to clipboard"></img></div><div class=includecode id=admin-sched-pod1-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>no</span>-annotation<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>multischeduler-example<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-with-no-annotation-container<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/pause:2.0</span></span></code></pre></div></div></div><p>When no scheduler name is supplied, the pod is automatically scheduled using the
default-scheduler.</p><p>Save this file as <code>pod1.yaml</code> and submit it to the Kubernetes cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f pod1.yaml
</span></span></code></pre></div></li><li><p>Pod spec with <code>default-scheduler</code></p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/pod2.yaml download=admin/sched/pod2.yaml><code>admin/sched/pod2.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-sched-pod2-yaml")' title="Copy admin/sched/pod2.yaml to clipboard"></img></div><div class=includecode id=admin-sched-pod2-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>annotation-default-scheduler<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>multischeduler-example<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>schedulerName</span>:<span style=color:#bbb> </span>default-scheduler<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-with-default-annotation-container<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/pause:2.0<span style=color:#bbb>
  </span></span></span></code></pre></div></div></div><p>A scheduler is specified by supplying the scheduler name as a value to <code>spec.schedulerName</code>. In this case, we supply the name of the
default scheduler which is <code>default-scheduler</code>.</p><p>Save this file as <code>pod2.yaml</code> and submit it to the Kubernetes cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f pod2.yaml
</span></span></code></pre></div></li><li><p>Pod spec with <code>my-scheduler</code></p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/sched/pod3.yaml download=admin/sched/pod3.yaml><code>admin/sched/pod3.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-sched-pod3-yaml")' title="Copy admin/sched/pod3.yaml to clipboard"></img></div><div class=includecode id=admin-sched-pod3-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>annotation-second-scheduler<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>multischeduler-example<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>schedulerName</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-with-second-annotation-container<span style=color:#bbb>
  </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/pause:2.0<span style=color:#bbb>
  </span></span></span></code></pre></div></div></div><p>In this case, we specify that this pod should be scheduled using the scheduler that we
deployed - <code>my-scheduler</code>. Note that the value of <code>spec.schedulerName</code> should match the name supplied for the scheduler
in the <code>schedulerName</code> field of the mapping <code>KubeSchedulerProfile</code>.</p><p>Save this file as <code>pod3.yaml</code> and submit it to the Kubernetes cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f pod3.yaml
</span></span></code></pre></div><p>Verify that all three pods are running.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div></li></ul><h3 id=verifying-that-the-pods-were-scheduled-using-the-desired-schedulers>Verifying that the pods were scheduled using the desired schedulers</h3><p>In order to make it easier to work through these examples, we did not verify that the
pods were actually scheduled using the desired schedulers. We can verify that by
changing the order of pod and deployment config submissions above. If we submit all the
pod configs to a Kubernetes cluster before submitting the scheduler deployment config,
we see that the pod <code>annotation-second-scheduler</code> remains in "Pending" state forever
while the other two pods get scheduled. Once we submit the scheduler deployment config
and our new scheduler starts running, the <code>annotation-second-scheduler</code> pod gets
scheduled as well.</p><p>Alternatively, you can look at the "Scheduled" entries in the event logs to
verify that the pods were scheduled by the desired schedulers.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get events
</span></span></code></pre></div><p>You can also use a <a href=/docs/reference/scheduling/config/#multiple-profiles>custom scheduler configuration</a>
or a custom container image for the cluster's main scheduler by modifying its static pod manifest
on the relevant control plane nodes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1707517970dd390995f760308c2e2de6>11.5 - Use an HTTP Proxy to Access the Kubernetes API</h1><p>This page shows how to use an HTTP proxy to access the Kubernetes API.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>To check the version, enter <code>kubectl version</code>.</p><p>If you do not already have an application running in your cluster, start
a Hello world application by entering this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create deployment node-hello --image<span style=color:#666>=</span>gcr.io/google-samples/node-hello:1.0 --port<span style=color:#666>=</span><span style=color:#666>8080</span>
</span></span></code></pre></div><h2 id=using-kubectl-to-start-a-proxy-server>Using kubectl to start a proxy server</h2><p>This command starts a proxy to the Kubernetes API server:</p><pre><code>kubectl proxy --port=8080
</code></pre><h2 id=exploring-the-kubernetes-api>Exploring the Kubernetes API</h2><p>When the proxy server is running, you can explore the API using <code>curl</code>, <code>wget</code>,
or a browser.</p><p>Get the API versions:</p><pre><code>curl http://localhost:8080/api/
</code></pre><p>The output should look similar to this:</p><pre><code>{
  &quot;kind&quot;: &quot;APIVersions&quot;,
  &quot;versions&quot;: [
    &quot;v1&quot;
  ],
  &quot;serverAddressByClientCIDRs&quot;: [
    {
      &quot;clientCIDR&quot;: &quot;0.0.0.0/0&quot;,
      &quot;serverAddress&quot;: &quot;10.0.2.15:8443&quot;
    }
  ]
}
</code></pre><p>Get a list of pods:</p><pre><code>curl http://localhost:8080/api/v1/namespaces/default/pods
</code></pre><p>The output should look similar to this:</p><pre><code>{
  &quot;kind&quot;: &quot;PodList&quot;,
  &quot;apiVersion&quot;: &quot;v1&quot;,
  &quot;metadata&quot;: {
    &quot;resourceVersion&quot;: &quot;33074&quot;
  },
  &quot;items&quot;: [
    {
      &quot;metadata&quot;: {
        &quot;name&quot;: &quot;kubernetes-bootcamp-2321272333-ix8pt&quot;,
        &quot;generateName&quot;: &quot;kubernetes-bootcamp-2321272333-&quot;,
        &quot;namespace&quot;: &quot;default&quot;,
        &quot;uid&quot;: &quot;ba21457c-6b1d-11e6-85f7-1ef9f1dab92b&quot;,
        &quot;resourceVersion&quot;: &quot;33003&quot;,
        &quot;creationTimestamp&quot;: &quot;2016-08-25T23:43:30Z&quot;,
        &quot;labels&quot;: {
          &quot;pod-template-hash&quot;: &quot;2321272333&quot;,
          &quot;run&quot;: &quot;kubernetes-bootcamp&quot;
        },
        ...
}
</code></pre><h2 id=what-s-next>What's next</h2><p>Learn more about <a href=/docs/reference/generated/kubectl/kubectl-commands#proxy>kubectl proxy</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-46417c7cdd2da2c530aaeddca1861e5c>11.6 - Use a SOCKS5 Proxy to Access the Kubernetes API</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.24 [stable]</code></div><p>This page shows how to use a SOCKS5 proxy to access the API of a remote Kubernetes cluster.
This is useful when the cluster you want to access does not expose its API directly on the public internet.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.24.
To check the version, enter <code>kubectl version</code>.</p><p>You need SSH client software (the <code>ssh</code> tool), and an SSH service running on the remote server.
You must be able to log in to the SSH service on the remote server.</p><h2 id=task-context>Task context</h2><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This example tunnels traffic using SSH, with the SSH client and server acting as a SOCKS proxy.
You can instead use any other kind of <a href=https://en.wikipedia.org/wiki/SOCKS#SOCKS5>SOCKS5</a> proxies.</div><p>Figure 1 represents what you're going to achieve in this task.</p><ul><li>You have a client computer, referred to as local in the steps ahead, from where you're going to create requests to talk to the Kubernetes API.</li><li>The Kubernetes server/API is hosted on a remote server.</li><li>You will use SSH client and server software to create a secure SOCKS5 tunnel between the local and
the remote server. The HTTPS traffic between the client and the Kubernetes API will flow over the SOCKS5
tunnel, which is itself tunnelled over SSH.</li></ul><p><figure><div class=mermaid>graph LR;
subgraph local[Local client machine]
client([client])-- local<br>traffic .-> local_ssh[Local SSH<br>SOCKS5 proxy];
end
local_ssh[SSH<br>SOCKS5<br>proxy]-- SSH Tunnel -->sshd
subgraph remote[Remote server]
sshd[SSH<br>server]-- local traffic -->service1;
end
client([client])-. proxied HTTPs traffic<br>going through the proxy .->service1[Kubernetes API];
classDef plain fill:#ddd,stroke:#fff,stroke-width:4px,color:#000;
classDef k8s fill:#326ce5,stroke:#fff,stroke-width:4px,color:#fff;
classDef cluster fill:#fff,stroke:#bbb,stroke-width:2px,color:#326ce5;
class ingress,service1,service2,pod1,pod2,pod3,pod4 k8s;
class client plain;
class cluster cluster;</div></figure><noscript><div class="alert alert-secondary callout" role=alert><em class=javascript-required>JavaScript must be <a href=https://www.enable-javascript.com/>enabled</a> to view this content</em></div></noscript>Figure 1. SOCKS5 tutorial components</p><h2 id=using-ssh-to-create-a-socks5-proxy>Using ssh to create a SOCKS5 proxy</h2><p>This command starts a SOCKS5 proxy between your client machine and the remote server.
The SOCKS5 proxy lets you connect to your cluster's API server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># The SSH tunnel continues running in the foreground after you run this</span>
</span></span><span style=display:flex><span>ssh -D <span style=color:#666>1080</span> -q -N username@kubernetes-remote-server.example
</span></span></code></pre></div><ul><li><code>-D 1080</code>: opens a SOCKS proxy on local port :1080.</li><li><code>-q</code>: quiet mode. Causes most warning and diagnostic messages to be suppressed.</li><li><code>-N</code>: Do not execute a remote command. Useful for just forwarding ports.</li><li><code>username@kubernetes-remote-server.example</code>: the remote SSH server where the Kubernetes cluster is running.</li></ul><h2 id=client-configuration>Client configuration</h2><p>To explore the Kubernetes API you'll first need to instruct your clients to send their queries through
the SOCKS5 proxy we created earlier.</p><p>For command-line tools, set the <code>https_proxy</code> environment variable and pass it to commands that you run.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>https_proxy</span><span style=color:#666>=</span>socks5h://localhost:1080
</span></span></code></pre></div><p>When you set the <code>https_proxy</code> variable, tools such as <code>curl</code> route HTTPS traffic through the proxy
you configured. For this to work, the tool must support SOCKS5 proxying.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In the URL https://localhost:6443/api, <code>localhost</code> does not refer to your local client computer.
Instead, it refers to the endpoint on the remote server known as <code>localhost</code>.
The <code>curl</code> tool sends the hostname from the HTTPS URL over SOCKS, and the remote server
resolves that locally (to an address that belongs to its loopback interface).</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -k -v https://localhost:6443/api
</span></span></code></pre></div><p>To use the official Kubernetes client <code>kubectl</code> with a proxy, set the <code>proxy-url</code> element
for the relevant <code>cluster</code> entry within your <code>~/.kube/config</code> file. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>clusters</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>certificate-authority-data</span>:<span style=color:#bbb> </span>LRMEMMW2<span style=color:#bbb> </span><span style=color:#080;font-style:italic># shortened for readability </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>server</span>:<span style=color:#bbb> </span>https://&lt;API_SERVER_IP_ADRESS&gt;:6443 <span style=color:#bbb> </span><span style=color:#080;font-style:italic># the &#34;Kubernetes API&#34; server, in other words the IP address of kubernetes-remote-server.example</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>proxy-url</span>:<span style=color:#bbb> </span>socks5://localhost:1080  <span style=color:#bbb> </span><span style=color:#080;font-style:italic># the &#34;SSH SOCKS5 proxy&#34; in the diagram above (DNS resolution over socks is built-in)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>contexts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>context</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>current-context</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>preferences</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-certificate-data</span>:<span style=color:#bbb> </span>LS0tLS1CR==<span style=color:#bbb> </span><span style=color:#080;font-style:italic># shortened for readability</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>client-key-data</span>:<span style=color:#bbb> </span>LS0tLS1CRUdJT=     <span style=color:#bbb> </span><span style=color:#080;font-style:italic># shortened for readability</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>If the tunnel is operating and you use <code>kubectl</code> with a context that uses this cluster, you can interact with your cluster through that proxy. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE
</span></span></span><span style=display:flex><span><span style=color:#888>kube-system   coredns-85cb69466-klwq8                  1/1     Running     0          5m46s
</span></span></span></code></pre></div><h2 id=clean-up>Clean up</h2><p>Stop the ssh port-forwarding process by pressing <code>CTRL+C</code> on the terminal where it is running.</p><p>Type <code>unset https_proxy</code> in a terminal to stop forwarding http traffic through the proxy.</p><h2 id=further-reading>Further reading</h2><ul><li><a href=https://man.openbsd.org/ssh>OpenSSH remote login client</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-61cf1f2f0fbe98e7635fce65f04a775f>11.7 - Set up Konnectivity service</h1><p>The Konnectivity service provides a TCP level proxy for the control plane to cluster
communication.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this
tutorial on a cluster with at least two nodes that are not acting as control
plane hosts. If you do not already have a cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>.</p><h2 id=configure-the-konnectivity-service>Configure the Konnectivity service</h2><p>The following steps require an egress configuration, for example:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/konnectivity/egress-selector-configuration.yaml download=admin/konnectivity/egress-selector-configuration.yaml><code>admin/konnectivity/egress-selector-configuration.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-konnectivity-egress-selector-configuration-yaml")' title="Copy admin/konnectivity/egress-selector-configuration.yaml to clipboard"></img></div><div class=includecode id=admin-konnectivity-egress-selector-configuration-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EgressSelectorConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>egressSelections</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Since we want to control the egress traffic to the cluster, we use the</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># &#34;cluster&#34; as the name. Other supported values are &#34;etcd&#34;, and &#34;controlplane&#34;.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>connection</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This controls the protocol between the API Server and the Konnectivity</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># server. Supported values are &#34;GRPC&#34; and &#34;HTTPConnect&#34;. There is no</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># end user visible difference between the two modes. You need to set the</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Konnectivity server to work in the same mode.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>proxyProtocol</span>:<span style=color:#bbb> </span>GRPC<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>transport</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># This controls what transport the API Server uses to communicate with the</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Konnectivity server. UDS is recommended if the Konnectivity server</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># locates on the same machine as the API Server. You need to configure the</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Konnectivity server to listen on the same UDS socket.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># The other supported transport is &#34;tcp&#34;. You will need to set up TLS </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># config to secure the TCP transport.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>uds</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>udsName</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server/konnectivity-server.socket<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>You need to configure the API Server to use the Konnectivity service
and direct the network traffic to the cluster nodes:</p><ol><li>Make sure that
<a href=/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>Service Account Token Volume Projection</a>
feature enabled in your cluster. It is enabled by default since Kubernetes v1.20.</li><li>Create an egress configuration file such as <code>admin/konnectivity/egress-selector-configuration.yaml</code>.</li><li>Set the <code>--egress-selector-config-file</code> flag of the API Server to the path of
your API Server egress configuration file.</li><li>If you use UDS connection, add volumes config to the kube-apiserver:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-uds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-uds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DirectoryOrCreate<span style=color:#bbb>
</span></span></span></code></pre></div></li></ol><p>Generate or obtain a certificate and kubeconfig for konnectivity-server.
For example, you can use the OpenSSL command line tool to issue a X.509 certificate,
using the cluster CA certificate <code>/etc/kubernetes/pki/ca.crt</code> from a control-plane host.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl req -subj <span style=color:#b44>&#34;/CN=system:konnectivity-server&#34;</span> -new -newkey rsa:2048 -nodes -out konnectivity.csr -keyout konnectivity.key
</span></span><span style=display:flex><span>openssl x509 -req -in konnectivity.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out konnectivity.crt -days <span style=color:#666>375</span> -sha256
</span></span><span style=display:flex><span><span style=color:#b8860b>SERVER</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl config view -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.clusters..server}&#39;</span><span style=color:#a2f;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-credentials system:konnectivity-server --client-certificate konnectivity.crt --client-key konnectivity.key --embed-certs<span style=color:#666>=</span><span style=color:#a2f>true</span>
</span></span><span style=display:flex><span>kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-cluster kubernetes --server <span style=color:#b44>&#34;</span><span style=color:#b8860b>$SERVER</span><span style=color:#b44>&#34;</span> --certificate-authority /etc/kubernetes/pki/ca.crt --embed-certs<span style=color:#666>=</span><span style=color:#a2f>true</span>
</span></span><span style=display:flex><span>kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-context system:konnectivity-server@kubernetes --cluster kubernetes --user system:konnectivity-server
</span></span><span style=display:flex><span>kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config use-context system:konnectivity-server@kubernetes
</span></span><span style=display:flex><span>rm -f konnectivity.crt konnectivity.key konnectivity.csr
</span></span></code></pre></div><p>Next, you need to deploy the Konnectivity server and agents.
<a href=https://github.com/kubernetes-sigs/apiserver-network-proxy>kubernetes-sigs/apiserver-network-proxy</a>
is a reference implementation.</p><p>Deploy the Konnectivity server on your control plane node. The provided
<code>konnectivity-server.yaml</code> manifest assumes
that the Kubernetes components are deployed as a <a class=glossary-tooltip title='A pod managed directly by the kubelet daemon on a specific node.' data-toggle=tooltip data-placement=top href=/docs/tasks/configure-pod-container/static-pod/ target=_blank aria-label='static Pod'>static Pod</a> in your cluster. If not, you can deploy the Konnectivity
server as a DaemonSet.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/konnectivity/konnectivity-server.yaml download=admin/konnectivity/konnectivity-server.yaml><code>admin/konnectivity/konnectivity-server.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-konnectivity-konnectivity-server-yaml")' title="Copy admin/konnectivity/konnectivity-server.yaml to clipboard"></img></div><div class=includecode id=admin-konnectivity-konnectivity-server-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>priorityClassName</span>:<span style=color:#bbb> </span>system-cluster-critical<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-server-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>registry.k8s.io/kas-network-proxy/proxy-server:v0.0.32<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/proxy-server&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--logtostderr=true&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># This needs to be consistent with the value set in egressSelectorConfiguration.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--uds-name=/etc/kubernetes/konnectivity-server/konnectivity-server.socket&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># The following two lines assume the Konnectivity server is</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># deployed on the same machine as the apiserver, and the certs and</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># key of the API Server are at the specified location.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--cluster-cert=/etc/kubernetes/pki/apiserver.crt&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--cluster-key=/etc/kubernetes/pki/apiserver.key&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># This needs to be consistent with the value set in egressSelectorConfiguration.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--mode=grpc&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--server-port=0&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--agent-port=8132&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--admin-port=8133&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--health-port=8134&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--agent-namespace=kube-system&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--agent-service-account=konnectivity-agent&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--kubeconfig=/etc/kubernetes/konnectivity-server.conf&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--authentication-audience=system:konnectivity-server&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>scheme</span>:<span style=color:#bbb> </span>HTTP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb> </span><span style=color:#666>127.0.0.1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8134</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>timeoutSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>agentport<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8132</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8132</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>adminport<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8133</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8133</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>healthport<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8134</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8134</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>k8s-certs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubeconfig<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server.conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-uds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>k8s-certs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubeconfig<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server.conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>FileOrCreate<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-uds<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DirectoryOrCreate<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Then deploy the Konnectivity agents in your cluster:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/konnectivity/konnectivity-agent.yaml download=admin/konnectivity/konnectivity-agent.yaml><code>admin/konnectivity/konnectivity-agent.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-konnectivity-konnectivity-agent-yaml")' title="Copy admin/konnectivity/konnectivity-agent.yaml to clipboard"></img></div><div class=includecode id=admin-konnectivity-konnectivity-agent-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Alternatively, you can deploy the agents as Deployments. It is not necessary</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># to have an agent on each node.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>addonmanager.kubernetes.io/mode</span>:<span style=color:#bbb> </span>Reconcile<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>priorityClassName</span>:<span style=color:#bbb> </span>system-cluster-critical<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;CriticalAddonsOnly&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Exists&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>us.gcr.io/k8s-artifacts-prod/kas-network-proxy/proxy-agent:v0.0.16<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/proxy-agent&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--logtostderr=true&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--ca-cert=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#080;font-style:italic># Since the konnectivity server runs with hostNetwork=true,</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#080;font-style:italic># this is the IP address of the master machine.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--proxy-server-host=35.225.206.7&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--proxy-server-port=8132&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--admin-server-port=8133&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--health-server-port=8134&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--service-account-token-path=/var/run/secrets/tokens/konnectivity-agent-token&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/run/secrets/tokens<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent-token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8134</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>timeoutSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent-token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>projected</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>sources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span>- <span style=color:green;font-weight:700>serviceAccountToken</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>konnectivity-agent-token<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>audience</span>:<span style=color:#bbb> </span>system:konnectivity-server<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Last, if RBAC is enabled in your cluster, create the relevant RBAC rules:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/admin/konnectivity/konnectivity-rbac.yaml download=admin/konnectivity/konnectivity-rbac.yaml><code>admin/konnectivity/konnectivity-rbac.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("admin-konnectivity-konnectivity-rbac-yaml")' title="Copy admin/konnectivity/konnectivity-rbac.yaml to clipboard"></img></div><div class=includecode id=admin-konnectivity-konnectivity-rbac-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:konnectivity-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>addonmanager.kubernetes.io/mode</span>:<span style=color:#bbb> </span>Reconcile<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:auth-delegator<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>User<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:konnectivity-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>addonmanager.kubernetes.io/mode</span>:<span style=color:#bbb> </span>Reconcile<span style=color:#bbb>
</span></span></span></code></pre></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-d3c88a8663f58e9ec0bed73faff5b670>12 - TLS</h1><div class=lead>Understand how to protect traffic within your cluster using Transport Layer Security (TLS).</div></div><div class=td-content><h1 id=pg-1272b18ac0c008f6ffc2c62a29fa929f>12.1 - Configure Certificate Rotation for the Kubelet</h1><p>This page shows how to enable and configure certificate rotation for the kubelet.</p><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.19 [stable]</code></div><h2 id=before-you-begin>Before you begin</h2><ul><li>Kubernetes version 1.8.0 or later is required</li></ul><h2 id=overview>Overview</h2><p>The kubelet uses certificates for authenticating to the Kubernetes API. By
default, these certificates are issued with one year expiration so that they do
not need to be renewed too frequently.</p><p>Kubernetes contains <a href=/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/>kubelet certificate
rotation</a>,
that will automatically generate a new key and request a new certificate from
the Kubernetes API as the current certificate approaches expiration. Once the
new certificate is available, it will be used for authenticating connections to
the Kubernetes API.</p><h2 id=enabling-client-certificate-rotation>Enabling client certificate rotation</h2><p>The <code>kubelet</code> process accepts an argument <code>--rotate-certificates</code> that controls
if the kubelet will automatically request a new certificate as the expiration of
the certificate currently in use approaches.</p><p>The <code>kube-controller-manager</code> process accepts an argument
<code>--cluster-signing-duration</code> (<code>--experimental-cluster-signing-duration</code> prior to 1.19)
that controls how long certificates will be issued for.</p><h2 id=understanding-the-certificate-rotation-configuration>Understanding the certificate rotation configuration</h2><p>When a kubelet starts up, if it is configured to bootstrap (using the
<code>--bootstrap-kubeconfig</code> flag), it will use its initial certificate to connect
to the Kubernetes API and issue a certificate signing request. You can view the
status of certificate signing requests using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get csr
</span></span></code></pre></div><p>Initially a certificate signing request from the kubelet on a node will have a
status of <code>Pending</code>. If the certificate signing requests meets specific
criteria, it will be auto approved by the controller manager, then it will have
a status of <code>Approved</code>. Next, the controller manager will sign a certificate,
issued for the duration specified by the
<code>--cluster-signing-duration</code> parameter, and the signed certificate
will be attached to the certificate signing request.</p><p>The kubelet will retrieve the signed certificate from the Kubernetes API and
write that to disk, in the location specified by <code>--cert-dir</code>. Then the kubelet
will use the new certificate to connect to the Kubernetes API.</p><p>As the expiration of the signed certificate approaches, the kubelet will
automatically issue a new certificate signing request, using the Kubernetes API.
This can happen at any point between 30% and 10% of the time remaining on the
certificate. Again, the controller manager will automatically approve the certificate
request and attach a signed certificate to the certificate signing request. The
kubelet will retrieve the new signed certificate from the Kubernetes API and
write that to disk. Then it will update the connections it has to the
Kubernetes API to reconnect using the new certificate.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9a87de8ee8332cb487f34a05debb1125>12.2 - Manage TLS Certificates in a Cluster</h1><p>Kubernetes provides a <code>certificates.k8s.io</code> API, which lets you provision TLS
certificates signed by a Certificate Authority (CA) that you control. These CA
and certificates can be used by your workloads to establish trust.</p><p><code>certificates.k8s.io</code> API uses a protocol that is similar to the <a href=https://github.com/ietf-wg-acme/acme/>ACME
draft</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Certificates created using the <code>certificates.k8s.io</code> API are signed by a
<a href=#configuring-your-cluster-to-provide-signing>dedicated CA</a>. It is possible to configure your cluster to use the cluster root
CA for this purpose, but you should never rely on this. Do not assume that
these certificates will validate against the cluster root CA.</div><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>You need the <code>cfssl</code> tool. You can download <code>cfssl</code> from
<a href=https://github.com/cloudflare/cfssl/releases>https://github.com/cloudflare/cfssl/releases</a>.</p><p>Some steps in this page use the <code>jq</code> tool. If you don't have <code>jq</code>, you can
install it via your operating system's software sources, or fetch it from
<a href=https://stedolan.github.io/jq/>https://stedolan.github.io/jq/</a>.</p><h2 id=trusting-tls-in-a-cluster>Trusting TLS in a cluster</h2><p>Trusting the <a href=#configuring-your-cluster-to-provide-signing>custom CA</a> from an application running as a pod usually requires
some extra application configuration. You will need to add the CA certificate
bundle to the list of CA certificates that the TLS client or server trusts. For
example, you would do this with a golang TLS config by parsing the certificate
chain and adding the parsed certificates to the <code>RootCAs</code> field in the
<a href=https://pkg.go.dev/crypto/tls#Config><code>tls.Config</code></a> struct.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>Even though the custom CA certificate may be included in the filesystem (in the
ConfigMap <code>kube-root-ca.crt</code>),
you should not use that certificate authority for any purpose other than to verify internal
Kubernetes endpoints. An example of an internal Kubernetes endpoint is the
Service named <code>kubernetes</code> in the default namespace.</p><p>If you want to use a custom certificate authority for your workloads, you should generate
that CA separately, and distribute its CA certificate using a
<a href=/docs/tasks/configure-pod-container/configure-pod-configmap>ConfigMap</a> that your pods
have access to read.</p></div><h2 id=requesting-a-certificate>Requesting a certificate</h2><p>The following section demonstrates how to create a TLS certificate for a
Kubernetes service accessed through DNS.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This tutorial uses CFSSL: Cloudflare's PKI and TLS toolkit <a href=https://blog.cloudflare.com/introducing-cfssl/>click here</a> to know more.</div><h2 id=create-a-certificate-signing-request>Create a certificate signing request</h2><p>Generate a private key and certificate signing request (or CSR) by running
the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF | cfssl genkey - | cfssljson -bare server
</span></span></span><span style=display:flex><span><span style=color:#b44>{
</span></span></span><span style=display:flex><span><span style=color:#b44>  &#34;hosts&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#b44>    &#34;my-svc.my-namespace.svc.cluster.local&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>    &#34;my-pod.my-namespace.pod.cluster.local&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>    &#34;192.0.2.24&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>    &#34;10.0.34.2&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44>  ],
</span></span></span><span style=display:flex><span><span style=color:#b44>  &#34;CN&#34;: &#34;my-pod.my-namespace.pod.cluster.local&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>  &#34;key&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#b44>    &#34;algo&#34;: &#34;ecdsa&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>    &#34;size&#34;: 256
</span></span></span><span style=display:flex><span><span style=color:#b44>  }
</span></span></span><span style=display:flex><span><span style=color:#b44>}
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Where <code>192.0.2.24</code> is the service's cluster IP,
<code>my-svc.my-namespace.svc.cluster.local</code> is the service's DNS name,
<code>10.0.34.2</code> is the pod's IP and <code>my-pod.my-namespace.pod.cluster.local</code>
is the pod's DNS name. You should see the output similar to:</p><pre tabindex=0><code>2022/02/01 11:45:32 [INFO] generate received request
2022/02/01 11:45:32 [INFO] received CSR
2022/02/01 11:45:32 [INFO] generating key: ecdsa-256
2022/02/01 11:45:32 [INFO] encoded CSR
</code></pre><p>This command generates two files; it generates <code>server.csr</code> containing the PEM
encoded <a href=https://tools.ietf.org/html/rfc2986>PKCS#10</a> certification request,
and <code>server-key.pem</code> containing the PEM encoded key to the certificate that
is still to be created.</p><h2 id=create-a-certificatesigningrequest-object-to-send-to-the-kubernetes-api>Create a CertificateSigningRequest object to send to the Kubernetes API</h2><p>Generate a CSR manifest (in YAML), and send it to the API server. You can do that by
running the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: certificates.k8s.io/v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: CertificateSigningRequest
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: my-svc.my-namespace
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  request: $(cat server.csr | base64 | tr -d &#39;\n&#39;)
</span></span></span><span style=display:flex><span><span style=color:#b44>  signerName: example.com/serving
</span></span></span><span style=display:flex><span><span style=color:#b44>  usages:
</span></span></span><span style=display:flex><span><span style=color:#b44>  - digital signature
</span></span></span><span style=display:flex><span><span style=color:#b44>  - key encipherment
</span></span></span><span style=display:flex><span><span style=color:#b44>  - server auth
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Notice that the <code>server.csr</code> file created in step 1 is base64 encoded
and stashed in the <code>.spec.request</code> field. You are also requesting a
certificate with the "digital signature", "key encipherment", and "server
auth" key usages, signed by an example <code>example.com/serving</code> signer.
A specific <code>signerName</code> must be requested.
View documentation for <a href=/docs/reference/access-authn-authz/certificate-signing-requests/#signers>supported signer names</a>
for more information.</p><p>The CSR should now be visible from the API in a Pending state. You can see
it by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe csr my-svc.my-namespace
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Name:                   my-svc.my-namespace
Labels:                 &lt;none&gt;
Annotations:            &lt;none&gt;
CreationTimestamp:      Tue, 01 Feb 2022 11:49:15 -0500
Requesting User:        yourname@example.com
Signer:                 example.com/serving
Status:                 Pending
Subject:
        Common Name:    my-pod.my-namespace.pod.cluster.local
        Serial Number:
Subject Alternative Names:
        DNS Names:      my-pod.my-namespace.pod.cluster.local
                        my-svc.my-namespace.svc.cluster.local
        IP Addresses:   192.0.2.24
                        10.0.34.2
Events: &lt;none&gt;
</code></pre><h2 id=get-the-certificate-signing-request-approved>Get the CertificateSigningRequest approved</h2><p>Approving the <a href=/docs/reference/access-authn-authz/certificate-signing-requests/>certificate signing request</a>
is either done by an automated approval process or on a one off basis by a cluster
administrator. If you're authorized to approve a certificate request, you can do that
manually using <code>kubectl</code>; for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl certificate approve my-svc.my-namespace
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>certificatesigningrequest.certificates.k8s.io/my-svc.my-namespace approved
</code></pre><p>You should now see the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get csr
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>NAME                  AGE   SIGNERNAME            REQUESTOR              REQUESTEDDURATION   CONDITION
my-svc.my-namespace   10m   example.com/serving   yourname@example.com   &lt;none&gt;              Approved
</code></pre><p>This means the certificate request has been approved and is waiting for the
requested signer to sign it.</p><h2 id=sign-the-certificate-signing-request>Sign the CertificateSigningRequest</h2><p>Next, you'll play the part of a certificate signer, issue the certificate, and upload it to the API.</p><p>A signer would typically watch the CertificateSigningRequest API for objects with its <code>signerName</code>,
check that they have been approved, sign certificates for those requests,
and update the API object status with the issued certificate.</p><h3 id=create-a-certificate-authority>Create a Certificate Authority</h3><p>You need an authority to provide the digital signature on the new certificate.</p><p>First, create a signing certificate by running the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF | cfssl gencert -initca - | cfssljson -bare ca
</span></span></span><span style=display:flex><span><span style=color:#b44>{
</span></span></span><span style=display:flex><span><span style=color:#b44>  &#34;CN&#34;: &#34;My Example Signer&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>  &#34;key&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#b44>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>    &#34;size&#34;: 2048
</span></span></span><span style=display:flex><span><span style=color:#b44>  }
</span></span></span><span style=display:flex><span><span style=color:#b44>}
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>You should see output similar to:</p><pre tabindex=0><code class=language-none data-lang=none>2022/02/01 11:50:39 [INFO] generating a new CA key and certificate from CSR
2022/02/01 11:50:39 [INFO] generate received request
2022/02/01 11:50:39 [INFO] received CSR
2022/02/01 11:50:39 [INFO] generating key: rsa-2048
2022/02/01 11:50:39 [INFO] encoded CSR
2022/02/01 11:50:39 [INFO] signed certificate with serial number 263983151013686720899716354349605500797834580472
</code></pre><p>This produces a certificate authority key file (<code>ca-key.pem</code>) and certificate (<code>ca.pem</code>).</p><h3 id=issue-a-certificate>Issue a certificate</h3><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/tls/server-signing-config.json download=tls/server-signing-config.json><code>tls/server-signing-config.json</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("tls-server-signing-config-json")' title="Copy tls/server-signing-config.json to clipboard"></img></div><div class=includecode id=tls-server-signing-config-json><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;signing&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;default&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;usages&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;digital signature&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;key encipherment&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;server auth&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;expiry&#34;</span>: <span style=color:#b44>&#34;876000h&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;ca_constraint&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;is_ca&#34;</span>: <span style=color:#a2f;font-weight:700>false</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div><p>Use a <code>server-signing-config.json</code> signing configuration and the certificate authority key file
and certificate to sign the certificate request:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get csr my-svc.my-namespace -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.spec.request}&#39;</span> | <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  base64 --decode | <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  cfssl sign -ca ca.pem -ca-key ca-key.pem -config server-signing-config.json - | <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  cfssljson -bare ca-signed-server
</span></span></code></pre></div><p>You should see the output similar to:</p><pre tabindex=0><code>2022/02/01 11:52:26 [INFO] signed certificate with serial number 576048928624926584381415936700914530534472870337
</code></pre><p>This produces a signed serving certificate file, <code>ca-signed-server.pem</code>.</p><h3 id=upload-the-signed-certificate>Upload the signed certificate</h3><p>Finally, populate the signed certificate in the API object's status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get csr my-svc.my-namespace -o json | <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  jq <span style=color:#b44>&#39;.status.certificate = &#34;&#39;</span><span style=color:#a2f;font-weight:700>$(</span>base64 ca-signed-server.pem | tr -d <span style=color:#b44>&#39;\n&#39;</span><span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>&#39;&#34;&#39;</span> | <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  kubectl replace --raw /apis/certificates.k8s.io/v1/certificatesigningrequests/my-svc.my-namespace/status -f -
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This uses the command line tool <a href=https://stedolan.github.io/jq/><code>jq</code></a> to populate the base64-encoded
content in the <code>.status.certificate</code> field.
If you do not have <code>jq</code>, you can also save the JSON output to a file, populate this field manually, and
upload the resulting file.</div><p>Once the CSR is approved and the signed certificate is uploaded, run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get csr
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code class=language-none data-lang=none>NAME                  AGE   SIGNERNAME            REQUESTOR              REQUESTEDDURATION   CONDITION
my-svc.my-namespace   20m   example.com/serving   yourname@example.com   &lt;none&gt;              Approved,Issued
</code></pre><h2 id=download-the-certificate-and-use-it>Download the certificate and use it</h2><p>Now, as the requesting user, you can download the issued certificate
and save it to a <code>server.crt</code> file by running the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get csr my-svc.my-namespace -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.status.certificate}&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    | base64 --decode &gt; server.crt
</span></span></code></pre></div><p>Now you can populate <code>server.crt</code> and <code>server-key.pem</code> in a
<a class=glossary-tooltip title='Stores sensitive information, such as passwords, OAuth tokens, and ssh keys.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/secret/ target=_blank aria-label=Secret>Secret</a>
that you could later mount into a Pod (for example, to use with a webserver
that serves HTTPS).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls server --cert server.crt --key server-key.pem
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>secret/server created
</code></pre><p>Finally, you can populate <code>ca.pem</code> into a <a class=glossary-tooltip title='An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume.' data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a>
and use it as the trust root to verify the serving certificate:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap example-serving-ca --from-file ca.crt<span style=color:#666>=</span>ca.pem
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>configmap/example-serving-ca created
</code></pre><h2 id=approving-certificate-signing-requests>Approving CertificateSigningRequests</h2><p>A Kubernetes administrator (with appropriate permissions) can manually approve
(or deny) CertificateSigningRequests by using the <code>kubectl certificate approve</code> and <code>kubectl certificate deny</code> commands. However if you intend
to make heavy usage of this API, you might consider writing an automated
certificates controller.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong><p>The ability to approve CSRs decides who trusts whom within your environment. The
ability to approve CSRs should not be granted broadly or lightly.</p><p>You should make sure that you confidently understand both the verification requirements
that fall on the approver <strong>and</strong> the repercussions of issuing a specific certificate
before you grant the <code>approve</code> permission.</p></div><p>Whether a machine or a human using kubectl as above, the role of the <em>approver</em> is
to verify that the CSR satisfies two requirements:</p><ol><li>The subject of the CSR controls the private key used to sign the CSR. This
addresses the threat of a third party masquerading as an authorized subject.
In the above example, this step would be to verify that the pod controls the
private key used to generate the CSR.</li><li>The subject of the CSR is authorized to act in the requested context. This
addresses the threat of an undesired subject joining the cluster. In the
above example, this step would be to verify that the pod is allowed to
participate in the requested service.</li></ol><p>If and only if these two requirements are met, the approver should approve
the CSR and otherwise should deny the CSR.</p><p>For more information on certificate approval and access control, read
the <a href=/docs/reference/access-authn-authz/certificate-signing-requests/>Certificate Signing Requests</a>
reference page.</p><h2 id=configuring-your-cluster-to-provide-signing>Configuring your cluster to provide signing</h2><p>This page assumes that a signer is set up to serve the certificates API. The
Kubernetes controller manager provides a default implementation of a signer. To
enable it, pass the <code>--cluster-signing-cert-file</code> and
<code>--cluster-signing-key-file</code> parameters to the controller manager with paths to
your Certificate Authority's keypair.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-43d5e2b1fc2a7e104e66d481d08578dc>12.3 - Manual Rotation of CA Certificates</h1><p>This page shows how to manually rotate the certificate authority (CA) certificates.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><ul><li>For more information about authentication in Kubernetes, see
<a href=/docs/reference/access-authn-authz/authentication>Authenticating</a>.</li><li>For more information about best practices for CA certificates, see
<a href=/docs/setup/best-practices/certificates/#single-root-ca>Single root CA</a>.</li></ul><h2 id=rotate-the-ca-certificates-manually>Rotate the CA certificates manually</h2><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong><p>Make sure to back up your certificate directory along with configuration files and any other necessary files.</p><p>This approach assumes operation of the Kubernetes control plane in a HA configuration with multiple API servers.
Graceful termination of the API server is also assumed so clients can cleanly disconnect from one API server and
reconnect to another.</p><p>Configurations with a single API server will experience unavailability while the API server is being restarted.</p></div><ol><li><p>Distribute the new CA certificates and private keys (for example: <code>ca.crt</code>, <code>ca.key</code>, <code>front-proxy-ca.crt</code>,
and <code>front-proxy-ca.key</code>) to all your control plane nodes in the Kubernetes certificates directory.</p></li><li><p>Update the <code>--root-ca-file</code> flag for the <a class=glossary-tooltip title='Control Plane component that runs controller processes.' data-toggle=tooltip data-placement=top href=/docs/reference/command-line-tools-reference/kube-controller-manager/ target=_blank aria-label=kube-controller-manager>kube-controller-manager</a> to include
both old and new CA, then restart the kube-controller-manager.</p><p>Any <a class=glossary-tooltip title='Provides an identity for processes that run in a Pod.' data-toggle=tooltip data-placement=top href=/docs/tasks/configure-pod-container/configure-service-account/ target=_blank aria-label=ServiceAccount>ServiceAccount</a> created after this point will get
Secrets that include both old and new CAs.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>The files specified by the kube-controller-manager flags <code>--client-ca-file</code> and <code>--cluster-signing-cert-file</code>
cannot be CA bundles. If these flags and <code>--root-ca-file</code> point to the same <code>ca.crt</code> file which is now a
bundle (includes both old and new CA) you will face an error. To workaround this problem you can copy the new CA
to a separate file and make the flags <code>--client-ca-file</code> and <code>--cluster-signing-cert-file</code> point to the copy.
Once <code>ca.crt</code> is no longer a bundle you can restore the problem flags to point to <code>ca.crt</code> and delete the copy.</p><p><a href=https://github.com/kubernetes/kubeadm/issues/1350>Issue 1350</a> for kubeadm tracks an bug with the
kube-controller-manager being unable to accept a CA bundle.</p></div></li><li><p>Wait for the controller manager to update <code>ca.crt</code> in the service account Secrets to include both old and new CA certificates.</p><p>If any Pods are started before new CA is used by API servers, the new Pods get this update and will trust both
old and new CAs.</p></li><li><p>Restart all pods using in-cluster configurations (for example: kube-proxy, CoreDNS, etc) so they can use the
updated certificate authority data from Secrets that link to ServiceAccounts.</p><ul><li>Make sure CoreDNS, kube-proxy and other Pods using in-cluster configurations are working as expected.</li></ul></li><li><p>Append the both old and new CA to the file against <code>--client-ca-file</code> and <code>--kubelet-certificate-authority</code>
flag in the <code>kube-apiserver</code> configuration.</p></li><li><p>Append the both old and new CA to the file against <code>--client-ca-file</code> flag in the <code>kube-scheduler</code> configuration.</p></li><li><p>Update certificates for user accounts by replacing the content of <code>client-certificate-data</code> and <code>client-key-data</code>
respectively.</p><p>For information about creating certificates for individual user accounts, see
<a href=/docs/setup/best-practices/certificates/#configure-certificates-for-user-accounts>Configure certificates for user accounts</a>.</p><p>Additionally, update the <code>certificate-authority-data</code> section in the kubeconfig files,
respectively with Base64-encoded old and new certificate authority data</p></li><li><p>Update the <code>--root-ca-file</code> flag for the <a class=glossary-tooltip title='Control plane component that integrates Kubernetes with third-party cloud providers.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/cloud-controller/ target=_blank aria-label='Cloud Controller Manager'>Cloud Controller Manager</a> to include
both old and new CA, then restart the cloud-controller-manager.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If your cluster does not have a cloud-controller-manager, you can skip this step.</div></li><li><p>Follow the steps below in a rolling fashion.</p><ol><li><p>Restart any other
<a href=/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>aggregated API servers</a> or
webhook handlers to trust the new CA certificates.</p></li><li><p>Restart the kubelet by update the file against <code>clientCAFile</code> in kubelet configuration and
<code>certificate-authority-data</code> in <code>kubelet.conf</code> to use both the old and new CA on all nodes.</p><p>If your kubelet is not using client certificate rotation, update <code>client-certificate-data</code> and
<code>client-key-data</code> in <code>kubelet.conf</code> on all nodes along with the kubelet client certificate file
usually found in <code>/var/lib/kubelet/pki</code>.</p></li><li><p>Restart API servers with the certificates (<code>apiserver.crt</code>, <code>apiserver-kubelet-client.crt</code> and
<code>front-proxy-client.crt</code>) signed by new CA.
You can use the existing private keys or new private keys.
If you changed the private keys then update these in the Kubernetes certificates directory as well.</p><p>Since the Pods in your cluster trust both old and new CAs, there will be a momentarily disconnection
after which pods' Kubernetes clients reconnect to the new API server.
The new API server uses a certificate signed by the new CA.</p><ul><li>Restart the <a class=glossary-tooltip title='Control plane component that watches for newly created pods with no assigned node, and selects a node for them to run on.' data-toggle=tooltip data-placement=top href=/docs/reference/command-line-tools-reference/kube-scheduler/ target=_blank aria-label=kube-scheduler>kube-scheduler</a> to use and
trust the new CAs.</li><li>Make sure control plane components logs no TLS errors.</li></ul><div class="alert alert-info note callout" role=alert><strong>Note:</strong> To generate certificates and private keys for your cluster using the <code>openssl</code> command line tool,
see <a href=/docs/tasks/administer-cluster/certificates/#openssl>Certificates (<code>openssl</code>)</a>.
You can also use <a href=/docs/tasks/administer-cluster/certificates/#cfssl><code>cfssl</code></a>.</div></li><li><p>Annotate any DaemonSets and Deployments to trigger pod replacement in a safer rolling fashion.</p></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> namespace in <span style=color:#a2f;font-weight:700>$(</span>kubectl get namespace -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.items[*].metadata.name}&#39;</span><span style=color:#a2f;font-weight:700>)</span>; <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>for</span> name in <span style=color:#a2f;font-weight:700>$(</span>kubectl get deployments -n <span style=color:#b8860b>$namespace</span> -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.items[*].metadata.name}&#39;</span><span style=color:#a2f;font-weight:700>)</span>; <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>        kubectl patch deployment -n <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>namespace</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>name</span><span style=color:#b68;font-weight:700>}</span> -p <span style=color:#b44>&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;ca-rotation&#34;: &#34;1&#34;}}}}}&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>done</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>for</span> name in <span style=color:#a2f;font-weight:700>$(</span>kubectl get daemonset -n <span style=color:#b8860b>$namespace</span> -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.items[*].metadata.name}&#39;</span><span style=color:#a2f;font-weight:700>)</span>; <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>        kubectl patch daemonset -n <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>namespace</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>name</span><span style=color:#b68;font-weight:700>}</span> -p <span style=color:#b44>&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;ca-rotation&#34;: &#34;1&#34;}}}}}&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> To limit the number of concurrent disruptions that your application experiences,
see <a href=/docs/tasks/run-application/configure-pdb/>configure pod disruption budget</a>.</div><pre><code> Depending on how you use StatefulSets you may also need to perform similar rolling replacement.
</code></pre></li><li><p>If your cluster is using bootstrap tokens to join nodes, update the ConfigMap <code>cluster-info</code> in the <code>kube-public</code>
namespace with new CA.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>base64_encoded_ca</span><span style=color:#666>=</span><span style=color:#b44>&#34;</span><span style=color:#a2f;font-weight:700>$(</span>base64 -w0 /etc/kubernetes/pki/ca.crt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get cm/cluster-info --namespace kube-public -o yaml | <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    /bin/sed <span style=color:#b44>&#34;s/\(certificate-authority-data:\).*/\1 </span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>base64_encoded_ca</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>/&#34;</span> | <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    kubectl apply -f -
</span></span></code></pre></div></li><li><p>Verify the cluster functionality.</p><ol><li><p>Check the logs from control plane components, along with the kubelet and the kube-proxy.
Ensure those components are not reporting any TLS errors; see
<a href=/docs/tasks/debug/debug-cluster/#looking-at-logs>looking at the logs</a> for more details.</p></li><li><p>Validate logs from any aggregated api servers and pods using in-cluster config.</p></li></ol></li><li><p>Once the cluster functionality is successfully verified:</p><ol><li><p>Update all service account tokens to include new CA certificate only.</p><ul><li>All pods using an in-cluster kubeconfig will eventually need to be restarted to pick up the new Secret,
so that no Pods are relying on the old cluster CA.</li></ul></li><li><p>Restart the control plane components by removing the old CA from the kubeconfig files and the files against
<code>--client-ca-file</code>, <code>--root-ca-file</code> flags resp.</p></li><li><p>On each node, restart the kubelet by removing the old CA from file against the <code>clientCAFile</code> flag
and from the kubelet kubeconfig file. You should carry this out as a rolling update.</p><p>If your cluster lets you make this change, you can also roll it out by replacing nodes rather than
reconfiguring them.</p></li></ol></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ba58efa15c6d46f10e34d799be220965>13 - Manage Cluster Daemons</h1><div class=lead>Perform common tasks for managing a DaemonSet, such as performing a rolling update.</div></div><div class=td-content><h1 id=pg-bcfd795e4b59420f7db275a0482af37c>13.1 - Perform a Rolling Update on a DaemonSet</h1><p>This page shows how to perform a rolling update on a DaemonSet.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=daemonset-update-strategy>DaemonSet Update Strategy</h2><p>DaemonSet has two update strategy types:</p><ul><li><code>OnDelete</code>: With <code>OnDelete</code> update strategy, after you update a DaemonSet template, new
DaemonSet pods will <em>only</em> be created when you manually delete old DaemonSet
pods. This is the same behavior of DaemonSet in Kubernetes version 1.5 or
before.</li><li><code>RollingUpdate</code>: This is the default update strategy.<br>With <code>RollingUpdate</code> update strategy, after you update a
DaemonSet template, old DaemonSet pods will be killed, and new DaemonSet pods
will be created automatically, in a controlled fashion. At most one pod of
the DaemonSet will be running on each node during the whole update process.</li></ul><h2 id=performing-a-rolling-update>Performing a Rolling Update</h2><p>To enable the rolling update feature of a DaemonSet, you must set its
<code>.spec.updateStrategy.type</code> to <code>RollingUpdate</code>.</p><p>You may want to set
<a href=/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#DaemonSetSpec><code>.spec.updateStrategy.rollingUpdate.maxUnavailable</code></a>
(default to 1),
<a href=/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#DaemonSetSpec><code>.spec.minReadySeconds</code></a>
(default to 0) and
<a href=/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/#DaemonSetSpec><code>.spec.updateStrategy.rollingUpdate.maxSurge</code></a>
(defaults to 0) as well.</p><h3 id=creating-a-daemonset-with-rollingupdate-update-strategy>Creating a DaemonSet with <code>RollingUpdate</code> update strategy</h3><p>This YAML file specifies a DaemonSet with an update strategy as 'RollingUpdate'</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/controllers/fluentd-daemonset.yaml download=controllers/fluentd-daemonset.yaml><code>controllers/fluentd-daemonset.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("controllers-fluentd-daemonset-yaml")' title="Copy controllers/fluentd-daemonset.yaml to clipboard"></img></div><div class=includecode id=controllers-fluentd-daemonset-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fluentd-elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>fluentd-logging<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fluentd-elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>updateStrategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>RollingUpdate<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rollingUpdate</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxUnavailable</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fluentd-elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># these tolerations are to have the daemonset runnable on control plane nodes</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># remove them if your control plane nodes should not run pods</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node-role.kubernetes.io/control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exists<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node-role.kubernetes.io/master<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exists<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fluentd-elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>quay.io/fluentd_elasticsearch/fluentd:v2.5.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>varlog<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>varlibdockercontainers<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/lib/docker/containers<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>terminationGracePeriodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>varlog<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>varlibdockercontainers<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/lib/docker/containers<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>After verifying the update strategy of the DaemonSet manifest, create the DaemonSet:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/controllers/fluentd-daemonset.yaml
</span></span></code></pre></div><p>Alternatively, use <code>kubectl apply</code> to create the same DaemonSet if you plan to
update the DaemonSet with <code>kubectl apply</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/controllers/fluentd-daemonset.yaml
</span></span></code></pre></div><h3 id=checking-daemonset-rollingupdate-update-strategy>Checking DaemonSet <code>RollingUpdate</code> update strategy</h3><p>Check the update strategy of your DaemonSet, and make sure it's set to
<code>RollingUpdate</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get ds/fluentd-elasticsearch -o go-template<span style=color:#666>=</span><span style=color:#b44>&#39;{{.spec.updateStrategy.type}}{{&#34;\n&#34;}}&#39;</span> -n kube-system
</span></span></code></pre></div><p>If you haven't created the DaemonSet in the system, check your DaemonSet
manifest with the following command instead:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/controllers/fluentd-daemonset.yaml --dry-run<span style=color:#666>=</span>client -o go-template<span style=color:#666>=</span><span style=color:#b44>&#39;{{.spec.updateStrategy.type}}{{&#34;\n&#34;}}&#39;</span>
</span></span></code></pre></div><p>The output from both commands should be:</p><pre tabindex=0><code>RollingUpdate
</code></pre><p>If the output isn't <code>RollingUpdate</code>, go back and modify the DaemonSet object or
manifest accordingly.</p><h3 id=updating-a-daemonset-template>Updating a DaemonSet template</h3><p>Any updates to a <code>RollingUpdate</code> DaemonSet <code>.spec.template</code> will trigger a rolling
update. Let's update the DaemonSet by applying a new YAML file. This can be done with several different <code>kubectl</code> commands.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/controllers/fluentd-daemonset-update.yaml download=controllers/fluentd-daemonset-update.yaml><code>controllers/fluentd-daemonset-update.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("controllers-fluentd-daemonset-update-yaml")' title="Copy controllers/fluentd-daemonset-update.yaml to clipboard"></img></div><div class=includecode id=controllers-fluentd-daemonset-update-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fluentd-elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>fluentd-logging<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fluentd-elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>updateStrategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>RollingUpdate<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rollingUpdate</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxUnavailable</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fluentd-elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># these tolerations are to have the daemonset runnable on control plane nodes</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># remove them if your control plane nodes should not run pods</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node-role.kubernetes.io/control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exists<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>node-role.kubernetes.io/master<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exists<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fluentd-elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>quay.io/fluentd_elasticsearch/fluentd:v2.5.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>200Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>100m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>200Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>varlog<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>varlibdockercontainers<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/lib/docker/containers<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>terminationGracePeriodSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>varlog<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>varlibdockercontainers<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/lib/docker/containers<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h4 id=declarative-commands>Declarative commands</h4><p>If you update DaemonSets using
<a href=/docs/tasks/manage-kubernetes-objects/declarative-config/>configuration files</a>,
use <code>kubectl apply</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/controllers/fluentd-daemonset-update.yaml
</span></span></code></pre></div><h4 id=imperative-commands>Imperative commands</h4><p>If you update DaemonSets using
<a href=/docs/tasks/manage-kubernetes-objects/imperative-command/>imperative commands</a>,
use <code>kubectl edit</code> :</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit ds/fluentd-elasticsearch -n kube-system
</span></span></code></pre></div><h5 id=updating-only-the-container-image>Updating only the container image</h5><p>If you only need to update the container image in the DaemonSet template, i.e.
<code>.spec.template.spec.containers[*].image</code>, use <code>kubectl set image</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>set</span> image ds/fluentd-elasticsearch fluentd-elasticsearch<span style=color:#666>=</span>quay.io/fluentd_elasticsearch/fluentd:v2.6.0 -n kube-system
</span></span></code></pre></div><h3 id=watching-the-rolling-update-status>Watching the rolling update status</h3><p>Finally, watch the rollout status of the latest DaemonSet rolling update:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout status ds/fluentd-elasticsearch -n kube-system
</span></span></code></pre></div><p>When the rollout is complete, the output is similar to this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>daemonset <span style=color:#b44>&#34;fluentd-elasticsearch&#34;</span> successfully rolled out
</span></span></code></pre></div><h2 id=troubleshooting>Troubleshooting</h2><h3 id=daemonset-rolling-update-is-stuck>DaemonSet rolling update is stuck</h3><p>Sometimes, a DaemonSet rolling update may be stuck. Here are some possible
causes:</p><h4 id=some-nodes-run-out-of-resources>Some nodes run out of resources</h4><p>The rollout is stuck because new DaemonSet pods can't be scheduled on at least one
node. This is possible when the node is
<a href=/docs/concepts/scheduling-eviction/node-pressure-eviction/>running out of resources</a>.</p><p>When this happens, find the nodes that don't have the DaemonSet pods scheduled on
by comparing the output of <code>kubectl get nodes</code> and the output of:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>name</span><span style=color:#666>=</span>fluentd-elasticsearch -o wide -n kube-system
</span></span></code></pre></div><p>Once you've found those nodes, delete some non-DaemonSet pods from the node to
make room for new DaemonSet pods.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> This will cause service disruption when deleted pods are not controlled by any controllers or pods are not
replicated. This does not respect <a href=/docs/tasks/run-application/configure-pdb/>PodDisruptionBudget</a>
either.</div><h4 id=broken-rollout>Broken rollout</h4><p>If the recent DaemonSet template update is broken, for example, the container is
crash looping, or the container image doesn't exist (often due to a typo),
DaemonSet rollout won't progress.</p><p>To fix this, update the DaemonSet template again. New rollout won't be
blocked by previous unhealthy rollouts.</p><h4 id=clock-skew>Clock skew</h4><p>If <code>.spec.minReadySeconds</code> is specified in the DaemonSet, clock skew between
master and nodes will make DaemonSet unable to detect the right rollout
progress.</p><h2 id=clean-up>Clean up</h2><p>Delete DaemonSet from a namespace :</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete ds fluentd-elasticsearch -n kube-system
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>See <a href=/docs/tasks/manage-daemon/rollback-daemon-set/>Performing a rollback on a DaemonSet</a></li><li>See <a href=/docs/concepts/workloads/controllers/daemonset/>Creating a DaemonSet to adopt existing DaemonSet pods</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f1bf7e426f482a85e1a417d1fd9ea7b7>13.2 - Perform a Rollback on a DaemonSet</h1><p>This page shows how to perform a rollback on a <a class=glossary-tooltip title='Ensures a copy of a Pod is running across a set of nodes in a cluster.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/daemonset target=_blank aria-label=DaemonSet>DaemonSet</a>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.7.
To check the version, enter <code>kubectl version</code>.</p><p>You should already know how to <a href=/docs/tasks/manage-daemon/update-daemon-set/>perform a rolling update on a
DaemonSet</a>.</p><h2 id=performing-a-rollback-on-a-daemonset>Performing a rollback on a DaemonSet</h2><h3 id=step-1-find-the-daemonset-revision-you-want-to-roll-back-to>Step 1: Find the DaemonSet revision you want to roll back to</h3><p>You can skip this step if you only want to roll back to the last revision.</p><p>List all revisions of a DaemonSet:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout <span style=color:#a2f>history</span> daemonset &lt;daemonset-name&gt;
</span></span></code></pre></div><p>This returns a list of DaemonSet revisions:</p><pre tabindex=0><code>daemonsets &#34;&lt;daemonset-name&gt;&#34;
REVISION        CHANGE-CAUSE
1               ...
2               ...
...
</code></pre><ul><li>Change cause is copied from DaemonSet annotation <code>kubernetes.io/change-cause</code>
to its revisions upon creation. You may specify <code>--record=true</code> in <code>kubectl</code>
to record the command executed in the change cause annotation.</li></ul><p>To see the details of a specific revision:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout <span style=color:#a2f>history</span> daemonset &lt;daemonset-name&gt; --revision<span style=color:#666>=</span><span style=color:#666>1</span>
</span></span></code></pre></div><p>This returns the details of that revision:</p><pre tabindex=0><code>daemonsets &#34;&lt;daemonset-name&gt;&#34; with revision #1
Pod Template:
Labels:       foo=bar
Containers:
app:
 Image:        ...
 Port:         ...
 Environment:  ...
 Mounts:       ...
Volumes:      ...
</code></pre><h3 id=step-2-roll-back-to-a-specific-revision>Step 2: Roll back to a specific revision</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Specify the revision number you get from Step 1 in --to-revision</span>
</span></span><span style=display:flex><span>kubectl rollout undo daemonset &lt;daemonset-name&gt; --to-revision<span style=color:#666>=</span>&lt;revision&gt;
</span></span></code></pre></div><p>If it succeeds, the command returns:</p><pre tabindex=0><code>daemonset &#34;&lt;daemonset-name&gt;&#34; rolled back
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If <code>--to-revision</code> flag is not specified, kubectl picks the most recent revision.</div><h3 id=step-3-watch-the-progress-of-the-daemonset-rollback>Step 3: Watch the progress of the DaemonSet rollback</h3><p><code>kubectl rollout undo daemonset</code> tells the server to start rolling back the
DaemonSet. The real rollback is done asynchronously inside the cluster
<a class=glossary-tooltip title='The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label='control plane'>control plane</a>.</p><p>To watch the progress of the rollback:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout status ds/&lt;daemonset-name&gt;
</span></span></code></pre></div><p>When the rollback is complete, the output is similar to:</p><pre tabindex=0><code>daemonset &#34;&lt;daemonset-name&gt;&#34; successfully rolled out
</code></pre><h2 id=understanding-daemonset-revisions>Understanding DaemonSet revisions</h2><p>In the previous <code>kubectl rollout history</code> step, you got a list of DaemonSet
revisions. Each revision is stored in a resource named ControllerRevision.</p><p>To see what is stored in each revision, find the DaemonSet revision raw
resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get controllerrevision -l &lt;daemonset-selector-key&gt;<span style=color:#666>=</span>&lt;daemonset-selector-value&gt;
</span></span></code></pre></div><p>This returns a list of ControllerRevisions:</p><pre tabindex=0><code>NAME                               CONTROLLER                     REVISION   AGE
&lt;daemonset-name&gt;-&lt;revision-hash&gt;   DaemonSet/&lt;daemonset-name&gt;     1          1h
&lt;daemonset-name&gt;-&lt;revision-hash&gt;   DaemonSet/&lt;daemonset-name&gt;     2          1h
</code></pre><p>Each ControllerRevision stores the annotations and template of a DaemonSet
revision.</p><p><code>kubectl rollout undo</code> takes a specific ControllerRevision and replaces
DaemonSet template with the template stored in the ControllerRevision.
<code>kubectl rollout undo</code> is equivalent to updating DaemonSet template to a
previous revision through other commands, such as <code>kubectl edit</code> or <code>kubectl apply</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> DaemonSet revisions only roll forward. That is to say, after a
rollback completes, the revision number (<code>.revision</code> field) of the
ControllerRevision being rolled back to will advance. For example, if you
have revision 1 and 2 in the system, and roll back from revision 2 to revision
1, the ControllerRevision with <code>.revision: 1</code> will become <code>.revision: 3</code>.</div><h2 id=troubleshooting>Troubleshooting</h2><ul><li>See <a href=/docs/tasks/manage-daemon/update-daemon-set/#troubleshooting>troubleshooting DaemonSet rolling
update</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a701e71f3b32dae474c63ae4c596c856>14 - Networking</h1><div class=lead>Learn how to configure networking for your cluster.</div></div><div class=td-content><h1 id=pg-2edb5b02ea1e646c333c9fe4d5f02ff1>14.1 - Adding entries to Pod /etc/hosts with HostAliases</h1><p>Adding entries to a Pod's <code>/etc/hosts</code> file provides Pod-level override of hostname resolution when DNS and other options are not applicable. You can add these custom entries with the HostAliases field in PodSpec.</p><p>Modification not using HostAliases is not suggested because the file is managed by the kubelet and can be overwritten on during Pod creation/restart.</p><h2 id=default-hosts-file-content>Default hosts file content</h2><p>Start an Nginx Pod which is assigned a Pod IP:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run nginx --image nginx
</span></span></code></pre></div><pre tabindex=0><code>pod/nginx created
</code></pre><p>Examine a Pod IP:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods --output<span style=color:#666>=</span>wide
</span></span></code></pre></div><pre tabindex=0><code>NAME     READY     STATUS    RESTARTS   AGE    IP           NODE
nginx    1/1       Running   0          13s    10.200.0.4   worker0
</code></pre><p>The hosts file content would look like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> nginx -- cat /etc/hosts
</span></span></code></pre></div><pre tabindex=0><code># Kubernetes-managed hosts file.
127.0.0.1	localhost
::1	localhost ip6-localhost ip6-loopback
fe00::0	ip6-localnet
fe00::0	ip6-mcastprefix
fe00::1	ip6-allnodes
fe00::2	ip6-allrouters
10.200.0.4	nginx
</code></pre><p>By default, the <code>hosts</code> file only includes IPv4 and IPv6 boilerplates like
<code>localhost</code> and its own hostname.</p><h2 id=adding-additional-entries-with-hostaliases>Adding additional entries with hostAliases</h2><p>In addition to the default boilerplate, you can add additional entries to the
<code>hosts</code> file.
For example: to resolve <code>foo.local</code>, <code>bar.local</code> to <code>127.0.0.1</code> and <code>foo.remote</code>,
<code>bar.remote</code> to <code>10.1.2.3</code>, you can configure HostAliases for a Pod under
<code>.spec.hostAliases</code>:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/hostaliases-pod.yaml download=service/networking/hostaliases-pod.yaml><code>service/networking/hostaliases-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-networking-hostaliases-pod-yaml")' title="Copy service/networking/hostaliases-pod.yaml to clipboard"></img></div><div class=includecode id=service-networking-hostaliases-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hostaliases-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostAliases</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>ip</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;127.0.0.1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostnames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;foo.local&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;bar.local&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>ip</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;10.1.2.3&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostnames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;foo.remote&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;bar.remote&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cat-hosts<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- cat<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;/etc/hosts&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>You can start a Pod with that configuration by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/service/networking/hostaliases-pod.yaml
</span></span></code></pre></div><pre tabindex=0><code>pod/hostaliases-pod created
</code></pre><p>Examine a Pod's details to see its IPv4 address and its status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod --output<span style=color:#666>=</span>wide
</span></span></code></pre></div><pre tabindex=0><code>NAME                           READY     STATUS      RESTARTS   AGE       IP              NODE
hostaliases-pod                0/1       Completed   0          6s        10.200.0.5      worker0
</code></pre><p>The <code>hosts</code> file content looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs hostaliases-pod
</span></span></code></pre></div><pre tabindex=0><code># Kubernetes-managed hosts file.
127.0.0.1	localhost
::1	localhost ip6-localhost ip6-loopback
fe00::0	ip6-localnet
fe00::0	ip6-mcastprefix
fe00::1	ip6-allnodes
fe00::2	ip6-allrouters
10.200.0.5	hostaliases-pod

# Entries added by HostAliases.
127.0.0.1	foo.local	bar.local
10.1.2.3	foo.remote	bar.remote
</code></pre><p>with the additional entries specified at the bottom.</p><h2 id=why-does-kubelet-manage-the-hosts-file>Why does the kubelet manage the hosts file?</h2><p>The kubelet manages the
<code>hosts</code> file for each container of the Pod to prevent the container runtime from
modifying the file after the containers have already been started.
Historically, Kubernetes always used Docker Engine as its container runtime, and Docker Engine would
then modify the <code>/etc/hosts</code> file after each container had started.</p><p>Current Kubernetes can use a variety of container runtimes; even so, the kubelet manages the
hosts file within each container so that the outcome is as intended regardless of which
container runtime you use.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong><p>Avoid making manual changes to the hosts file inside a container.</p><p>If you make manual changes to the hosts file,
those changes are lost when the container exits.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-eebac062766222247063d6513f95c7b2>14.2 - Validate IPv4/IPv6 dual-stack</h1><p>This document shares how to validate IPv4/IPv6 dual-stack enabled Kubernetes clusters.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>Provider support for dual-stack networking (Cloud provider or otherwise must be able to provide Kubernetes nodes with routable IPv4/IPv6 network interfaces)</li><li>A <a href=/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/>network plugin</a> that supports dual-stack networking.</li><li><a href=/docs/concepts/services-networking/dual-stack/>Dual-stack enabled</a> cluster</li></ul>Your Kubernetes server must be at or later than version v1.23.
To check the version, enter <code>kubectl version</code>.<div class="alert alert-info note callout" role=alert><strong>Note:</strong> While you can validate with an earlier version, the feature is only GA and officially supported since v1.23.</div><h2 id=validate-addressing>Validate addressing</h2><h3 id=validate-node-addressing>Validate node addressing</h3><p>Each dual-stack Node should have a single IPv4 block and a single IPv6 block allocated. Validate that IPv4/IPv6 Pod address ranges are configured by running the following command. Replace the sample node name with a valid dual-stack Node from your cluster. In this example, the Node's name is <code>k8s-linuxpool1-34450317-0</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes k8s-linuxpool1-34450317-0 -o go-template --template<span style=color:#666>=</span><span style=color:#b44>&#39;{{range .spec.podCIDRs}}{{printf &#34;%s\n&#34; .}}{{end}}&#39;</span>
</span></span></code></pre></div><pre tabindex=0><code>10.244.1.0/24
2001:db8::/64
</code></pre><p>There should be one IPv4 block and one IPv6 block allocated.</p><p>Validate that the node has an IPv4 and IPv6 interface detected. Replace node name with a valid node from the cluster. In this example the node name is <code>k8s-linuxpool1-34450317-0</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes k8s-linuxpool1-34450317-0 -o go-template --template<span style=color:#666>=</span><span style=color:#b44>&#39;{{range .status.addresses}}{{printf &#34;%s: %s\n&#34; .type .address}}{{end}}&#39;</span>
</span></span></code></pre></div><pre tabindex=0><code>Hostname: k8s-linuxpool1-34450317-0
InternalIP: 10.0.0.5
InternalIP: 2001:db8:10::5
</code></pre><h3 id=validate-pod-addressing>Validate Pod addressing</h3><p>Validate that a Pod has an IPv4 and IPv6 address assigned. Replace the Pod name with a valid Pod in your cluster. In this example the Pod name is <code>pod01</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods pod01 -o go-template --template<span style=color:#666>=</span><span style=color:#b44>&#39;{{range .status.podIPs}}{{printf &#34;%s\n&#34; .ip}}{{end}}&#39;</span>
</span></span></code></pre></div><pre tabindex=0><code>10.244.1.4
2001:db8::4
</code></pre><p>You can also validate Pod IPs using the Downward API via the <code>status.podIPs</code> fieldPath. The following snippet demonstrates how you can expose the Pod IPs via an environment variable called <code>MY_POD_IPS</code> within a container.</p><pre tabindex=0><code>        env:
        - name: MY_POD_IPS
          valueFrom:
            fieldRef:
              fieldPath: status.podIPs
</code></pre><p>The following command prints the value of the <code>MY_POD_IPS</code> environment variable from within a container. The value is a comma separated list that corresponds to the Pod's IPv4 and IPv6 addresses.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it pod01 -- <span style=color:#a2f>set</span> | grep MY_POD_IPS
</span></span></code></pre></div><pre tabindex=0><code>MY_POD_IPS=10.244.1.4,2001:db8::4
</code></pre><p>The Pod's IP addresses will also be written to <code>/etc/hosts</code> within a container. The following command executes a cat on <code>/etc/hosts</code> on a dual stack Pod. From the output you can verify both the IPv4 and IPv6 IP address for the Pod.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> -it pod01 -- cat /etc/hosts
</span></span></code></pre></div><pre tabindex=0><code># Kubernetes-managed hosts file.
127.0.0.1    localhost
::1    localhost ip6-localhost ip6-loopback
fe00::0    ip6-localnet
fe00::0    ip6-mcastprefix
fe00::1    ip6-allnodes
fe00::2    ip6-allrouters
10.244.1.4    pod01
2001:db8::4    pod01
</code></pre><h2 id=validate-services>Validate Services</h2><p>Create the following Service that does not explicitly define <code>.spec.ipFamilyPolicy</code>. Kubernetes will assign a cluster IP for the Service from the first configured <code>service-cluster-ip-range</code> and set the <code>.spec.ipFamilyPolicy</code> to <code>SingleStack</code>.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/dual-stack-default-svc.yaml download=service/networking/dual-stack-default-svc.yaml><code>service/networking/dual-stack-default-svc.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-networking-dual-stack-default-svc-yaml")' title="Copy service/networking/dual-stack-default-svc.yaml to clipboard"></img></div><div class=includecode id=service-networking-dual-stack-default-svc-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Use <code>kubectl</code> to view the YAML for the Service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc my-service -o yaml
</span></span></code></pre></div><p>The Service has <code>.spec.ipFamilyPolicy</code> set to <code>SingleStack</code> and <code>.spec.clusterIP</code> set to an IPv4 address from the first configured range set via <code>--service-cluster-ip-range</code> flag on kube-controller-manager.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIP</span>:<span style=color:#bbb> </span><span style=color:#666>10.0.217.164</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIPs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:#666>10.0.217.164</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ipFamilies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- IPv4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ipFamilyPolicy</span>:<span style=color:#bbb> </span>SingleStack<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>9376</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>sessionAffinity</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>ClusterIP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>loadBalancer</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span></code></pre></div><p>Create the following Service that explicitly defines <code>IPv6</code> as the first array element in <code>.spec.ipFamilies</code>. Kubernetes will assign a cluster IP for the Service from the IPv6 range configured <code>service-cluster-ip-range</code> and set the <code>.spec.ipFamilyPolicy</code> to <code>SingleStack</code>.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/dual-stack-ipfamilies-ipv6.yaml download=service/networking/dual-stack-ipfamilies-ipv6.yaml><code>service/networking/dual-stack-ipfamilies-ipv6.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-networking-dual-stack-ipfamilies-ipv6-yaml")' title="Copy service/networking/dual-stack-ipfamilies-ipv6.yaml to clipboard"></img></div><div class=includecode id=service-networking-dual-stack-ipfamilies-ipv6-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ipFamilies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- IPv6<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Use <code>kubectl</code> to view the YAML for the Service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc my-service -o yaml
</span></span></code></pre></div><p>The Service has <code>.spec.ipFamilyPolicy</code> set to <code>SingleStack</code> and <code>.spec.clusterIP</code> set to an IPv6 address from the IPv6 range set via <code>--service-cluster-ip-range</code> flag on kube-controller-manager.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIP</span>:<span style=color:#bbb> </span><span style=color:#666>2001</span>:db8:fd00::5118<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIPs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:#666>2001</span>:db8:fd00::5118<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ipFamilies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- IPv6<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ipFamilyPolicy</span>:<span style=color:#bbb> </span>SingleStack<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>sessionAffinity</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>ClusterIP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>loadBalancer</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span></code></pre></div><p>Create the following Service that explicitly defines <code>PreferDualStack</code> in <code>.spec.ipFamilyPolicy</code>. Kubernetes will assign both IPv4 and IPv6 addresses (as this cluster has dual-stack enabled) and select the <code>.spec.ClusterIP</code> from the list of <code>.spec.ClusterIPs</code> based on the address family of the first element in the <code>.spec.ipFamilies</code> array.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/dual-stack-preferred-svc.yaml download=service/networking/dual-stack-preferred-svc.yaml><code>service/networking/dual-stack-preferred-svc.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-networking-dual-stack-preferred-svc-yaml")' title="Copy service/networking/dual-stack-preferred-svc.yaml to clipboard"></img></div><div class=includecode id=service-networking-dual-stack-preferred-svc-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ipFamilyPolicy</span>:<span style=color:#bbb> </span>PreferDualStack<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>The <code>kubectl get svc</code> command will only show the primary IP in the <code>CLUSTER-IP</code> field.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc -l app.kubernetes.io/name<span style=color:#666>=</span>MyApp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style=color:#666>(</span>S<span style=color:#666>)</span>   AGE
</span></span><span style=display:flex><span>my-service   ClusterIP   10.0.216.242   &lt;none&gt;        80/TCP    5s
</span></span></code></pre></div></div><p>Validate that the Service gets cluster IPs from the IPv4 and IPv6 address blocks using <code>kubectl describe</code>. You may then validate access to the service via the IPs and ports.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe svc -l app.kubernetes.io/name<span style=color:#666>=</span>MyApp
</span></span></code></pre></div><pre tabindex=0><code>Name:              my-service
Namespace:         default
Labels:            app.kubernetes.io/name=MyApp
Annotations:       &lt;none&gt;
Selector:          app.kubernetes.io/name=MyApp
Type:              ClusterIP
IP Family Policy:  PreferDualStack
IP Families:       IPv4,IPv6
IP:                10.0.216.242
IPs:               10.0.216.242,2001:db8:fd00::af55
Port:              &lt;unset&gt;  80/TCP
TargetPort:        9376/TCP
Endpoints:         &lt;none&gt;
Session Affinity:  None
Events:            &lt;none&gt;
</code></pre><h3 id=create-a-dual-stack-load-balanced-service>Create a dual-stack load balanced Service</h3><p>If the cloud provider supports the provisioning of IPv6 enabled external load balancers, create the following Service with <code>PreferDualStack</code> in <code>.spec.ipFamilyPolicy</code>, <code>IPv6</code> as the first element of the <code>.spec.ipFamilies</code> array and the <code>type</code> field set to <code>LoadBalancer</code>.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/dual-stack-prefer-ipv6-lb-svc.yaml download=service/networking/dual-stack-prefer-ipv6-lb-svc.yaml><code>service/networking/dual-stack-prefer-ipv6-lb-svc.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("service-networking-dual-stack-prefer-ipv6-lb-svc-yaml")' title="Copy service/networking/dual-stack-prefer-ipv6-lb-svc.yaml to clipboard"></img></div><div class=includecode id=service-networking-dual-stack-prefer-ipv6-lb-svc-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ipFamilyPolicy</span>:<span style=color:#bbb> </span>PreferDualStack<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ipFamilies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- IPv6<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app.kubernetes.io/name</span>:<span style=color:#bbb> </span>MyApp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Check the Service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get svc -l app.kubernetes.io/name<span style=color:#666>=</span>MyApp
</span></span></code></pre></div><p>Validate that the Service receives a <code>CLUSTER-IP</code> address from the IPv6 address block along with an <code>EXTERNAL-IP</code>. You may then validate access to the service via the IP and port.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>NAME         TYPE           CLUSTER-IP            EXTERNAL-IP        PORT<span style=color:#666>(</span>S<span style=color:#666>)</span>        AGE
</span></span><span style=display:flex><span>my-service   LoadBalancer   2001:db8:fd00::7ebc   2603:1030:805::5   80:30790/TCP   35s
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0c4484d31ad3902880897e694bbd306f>15 - Configure a kubelet image credential provider</h1><div class=lead>Configure the kubelet's image credential provider plugin</div><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.24 [beta]</code></div><p>Starting from Kubernetes v1.20, the kubelet can dynamically retrieve credentials for a container image registry
using exec plugins. The kubelet and the exec plugin communicate through stdio (stdin, stdout, and stderr) using
Kubernetes versioned APIs. These plugins allow the kubelet to request credentials for a container registry dynamically
as opposed to storing static credentials on disk. For example, the plugin may talk to a local metadata server to retrieve
short-lived credentials for an image that is being pulled by the kubelet.</p><p>You may be interested in using this capability if any of the below are true:</p><ul><li>API calls to a cloud provider service are required to retrieve authentication information for a registry.</li><li>Credentials have short expiration times and requesting new credentials frequently is required.</li><li>Storing registry credentials on disk or in imagePullSecrets is not acceptable.</li></ul><p>This guide demonstrates how to configure the kubelet's image credential provider plugin mechanism.</p><h2 id=before-you-begin>Before you begin</h2><ul><li>The kubelet image credential provider is introduced in v1.20 as an alpha feature. As with other alpha features,
a feature gate <code>KubeletCredentialProviders</code> must be enabled on only the kubelet for the feature to work.</li><li>A working implementation of a credential provider exec plugin. You can build your own plugin or use one provided by cloud providers.</li></ul><h2 id=installing-plugins-on-nodes>Installing Plugins on Nodes</h2><p>A credential provider plugin is an executable binary that will be run by the kubelet. Ensure that the plugin binary exists on
every node in your cluster and stored in a known directory. The directory will be required later when configuring kubelet flags.</p><h2 id=configuring-the-kubelet>Configuring the Kubelet</h2><p>In order to use this feature, the kubelet expects two flags to be set:</p><ul><li><code>--image-credential-provider-config</code> - the path to the credential provider plugin config file.</li><li><code>--image-credential-provider-bin-dir</code> - the path to the directory where credential provider plugin binaries are located.</li></ul><h3 id=configure-a-kubelet-credential-provider>Configure a kubelet credential provider</h3><p>The configuration file passed into <code>--image-credential-provider-config</code> is read by the kubelet to determine which exec plugins
should be invoked for which container images. Here's an example configuration file you may end up using if you are using the
<a href=https://aws.amazon.com/ecr/>ECR</a>-based plugin:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubelet.config.k8s.io/v1alpha1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CredentialProviderConfig<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># providers is a list of credential provider plugins that will be enabled by the kubelet.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Multiple providers may match against a single image, in which case credentials</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># from all providers will be returned to the kubelet. If multiple providers are called</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># for a single image, the results are combined. If providers return overlapping</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># auth keys, the value from the provider earlier in this list is used.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>providers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name is the required name of the credential provider. It must match the name of the</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># provider executable as seen by the kubelet. The executable must be in the kubelet&#39;s</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># bin directory (set by the --image-credential-provider-bin-dir flag).</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>ecr<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># matchImages is a required list of strings used to match against images in order to</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># determine if this provider should be invoked. If one of the strings matches the</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># requested image from the kubelet, the plugin will be invoked and given a chance</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># to provide credentials. Images are expected to contain the registry domain</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># and URL path.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic>#</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Each entry in matchImages is a pattern which can optionally contain a port and a path.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Globs can be used in the domain, but not in the port or the path. Globs are supported</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># as subdomains like &#39;*.k8s.io&#39; or &#39;k8s.*.io&#39;, and top-level-domains such as &#39;k8s.*&#39;.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Matching partial subdomains like &#39;app*.k8s.io&#39; is also supported. Each glob can only match</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># a single subdomain segment, so *.io does not match *.k8s.io.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic>#</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># A match exists between an image and a matchImage when all of the below are true:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - Both contain the same number of domain parts and each part matches.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - The URL path of an imageMatch must be a prefix of the target image URL path.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - If the imageMatch contains a port, then the port must match in the image as well.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic>#</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Example values of matchImages:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - 123456789.dkr.ecr.us-east-1.amazonaws.com</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - *.azurecr.io</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - gcr.io</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - *.*.registry.io</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - registry.io:8080/path</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchImages</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;*.dkr.ecr.*.amazonaws.com&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;*.dkr.ecr.*.amazonaws.cn&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;*.dkr.ecr-fips.*.amazonaws.com&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;*.dkr.ecr.us-iso-east-1.c2s.ic.gov&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;*.dkr.ecr.us-isob-east-1.sc2s.sgov.gov&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># defaultCacheDuration is the default duration the plugin will cache credentials in-memory</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># if a cache duration is not provided in the plugin response. This field is required.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>defaultCacheDuration</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;12h&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Required input version of the exec CredentialProviderRequest. The returned CredentialProviderResponse</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># MUST use the same encoding version as the input. Current supported values are:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># - credentialprovider.kubelet.k8s.io/v1alpha1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>credentialprovider.kubelet.k8s.io/v1alpha1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Arguments to pass to the command when executing it.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># +optional</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- get-credentials<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Env defines additional environment variables to expose to the process. These</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># are unioned with the host&#39;s environment, as well as variables client-go uses</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># to pass argument to the plugin.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># +optional</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>AWS_PROFILE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>example_profile<span style=color:#bbb>
</span></span></span></code></pre></div><p>The <code>providers</code> field is a list of enabled plugins used by the kubelet. Each entry has a few required fields:</p><ul><li><code>name</code>: the name of the plugin which MUST match the name of the executable binary that exists
in the directory passed into <code>--image-credential-provider-bin-dir</code>.</li><li><code>matchImages</code>: a list of strings used to match against images in order to determine
if this provider should be invoked. More on this below.</li><li><code>defaultCacheDuration</code>: the default duration the kubelet will cache credentials in-memory
if a cache duration was not specified by the plugin.</li><li><code>apiVersion</code>: the API version that the kubelet and the exec plugin will use when communicating.</li></ul><p>Each credential provider can also be given optional args and environment variables as well.
Consult the plugin implementors to determine what set of arguments and environment variables are required for a given plugin.</p><h4 id=configure-image-matching>Configure image matching</h4><p>The <code>matchImages</code> field for each credential provider is used by the kubelet to determine whether a plugin should be invoked
for a given image that a Pod is using. Each entry in <code>matchImages</code> is an image pattern which can optionally contain a port and a path.
Globs can be used in the domain, but not in the port or the path. Globs are supported as subdomains like <code>*.k8s.io</code> or <code>k8s.*.io</code>,
and top-level domains such as <code>k8s.*</code>. Matching partial subdomains like <code>app*.k8s.io</code> is also supported. Each glob can only match
a single subdomain segment, so <code>*.io</code> does NOT match <code>*.k8s.io</code>.</p><p>A match exists between an image name and a <code>matchImage</code> entry when all of the below are true:</p><ul><li>Both contain the same number of domain parts and each part matches.</li><li>The URL path of match image must be a prefix of the target image URL path.</li><li>If the imageMatch contains a port, then the port must match in the image as well.</li></ul><p>Some example values of <code>matchImages</code> patterns are:</p><ul><li><code>123456789.dkr.ecr.us-east-1.amazonaws.com</code></li><li><code>*.azurecr.io</code></li><li><code>gcr.io</code></li><li><code>*.*.registry.io</code></li><li><code>foo.registry.io:8080/path</code></li></ul><h2 id=what-s-next>What's next</h2><ul><li>Read the details about <code>CredentialProviderConfig</code> in the
<a href=/docs/reference/config-api/kubelet-config.v1alpha1/>kubelet configuration API (v1alpha1) reference</a>.</li><li>Read the <a href=/docs/reference/config-api/kubelet-credentialprovider.v1alpha1/>kubelet credential provider API reference (v1alpha1)</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f34d6e348a8e677d6c6eb155cd1a99aa>16 - Extend kubectl with plugins</h1><div class=lead>Extend kubectl by creating and installing kubectl plugins.</div><p>This guide demonstrates how to install and write extensions for <a href=/docs/reference/kubectl/kubectl/>kubectl</a>. By thinking of core <code>kubectl</code> commands as essential building blocks for interacting with a Kubernetes cluster, a cluster administrator can think
of plugins as a means of utilizing these building blocks to create more complex behavior. Plugins extend <code>kubectl</code> with new sub-commands, allowing for new and custom features not included in the main distribution of <code>kubectl</code>.</p><h2 id=before-you-begin>Before you begin</h2><p>You need to have a working <code>kubectl</code> binary installed.</p><h2 id=installing-kubectl-plugins>Installing kubectl plugins</h2><p>A plugin is a standalone executable file, whose name begins with <code>kubectl-</code>. To install a plugin, move its executable file to anywhere on your <code>PATH</code>.</p><p>You can also discover and install kubectl plugins available in the open source
using <a href=https://krew.dev/>Krew</a>. Krew is a plugin manager maintained by
the Kubernetes SIG CLI community.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Kubectl plugins available via the Krew <a href=https://krew.sigs.k8s.io/plugins/>plugin index</a>
are not audited for security. You should install and run third-party plugins at your
own risk, since they are arbitrary programs running on your machine.</div><h3 id=discovering-plugins>Discovering plugins</h3><p><code>kubectl</code> provides a command <code>kubectl plugin list</code> that searches your <code>PATH</code> for valid plugin executables.
Executing this command causes a traversal of all files in your <code>PATH</code>. Any files that are executable, and begin with <code>kubectl-</code> will show up <em>in the order in which they are present in your <code>PATH</code></em> in this command's output.
A warning will be included for any files beginning with <code>kubectl-</code> that are <em>not</em> executable.
A warning will also be included for any valid plugin files that overlap each other's name.</p><p>You can use <a href=https://krew.dev/>Krew</a> to discover and install <code>kubectl</code>
plugins from a community-curated
<a href=https://krew.sigs.k8s.io/plugins/>plugin index</a>.</p><h4 id=limitations>Limitations</h4><p>It is currently not possible to create plugins that overwrite existing <code>kubectl</code> commands. For example, creating a plugin <code>kubectl-version</code> will cause that plugin to never be executed, as the existing <code>kubectl version</code> command will always take precedence over it. Due to this limitation, it is also <em>not</em> possible to use plugins to add new subcommands to existing <code>kubectl</code> commands. For example, adding a subcommand <code>kubectl create foo</code> by naming your plugin <code>kubectl-create-foo</code> will cause that plugin to be ignored.</p><p><code>kubectl plugin list</code> shows warnings for any valid plugins that attempt to do this.</p><h2 id=writing-kubectl-plugins>Writing kubectl plugins</h2><p>You can write a plugin in any programming language or script that allows you to write command-line commands.</p><p>There is no plugin installation or pre-loading required. Plugin executables receive
the inherited environment from the <code>kubectl</code> binary.
A plugin determines which command path it wishes to implement based on its name.
For example, a plugin named <code>kubectl-foo</code> provides a command <code>kubectl foo</code>. You must
install the plugin executable somewhere in your <code>PATH</code>.</p><h3 id=example-plugin>Example plugin</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#080></span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># optional argument handling</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>[[</span> <span style=color:#b44>&#34;</span><span style=color:#b8860b>$1</span><span style=color:#b44>&#34;</span> <span style=color:#666>==</span> <span style=color:#b44>&#34;version&#34;</span> <span style=color:#666>]]</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;1.0.0&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>exit</span> <span style=color:#666>0</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># optional argument handling</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>if</span> <span style=color:#666>[[</span> <span style=color:#b44>&#34;</span><span style=color:#b8860b>$1</span><span style=color:#b44>&#34;</span> <span style=color:#666>==</span> <span style=color:#b44>&#34;config&#34;</span> <span style=color:#666>]]</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>echo</span> <span style=color:#b44>&#34;</span><span style=color:#b8860b>$KUBECONFIG</span><span style=color:#b44>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f>exit</span> <span style=color:#666>0</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;I am a plugin named kubectl-foo&#34;</span>
</span></span></code></pre></div><h3 id=using-a-plugin>Using a plugin</h3><p>To use a plugin, make the plugin executable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo chmod +x ./kubectl-foo
</span></span></code></pre></div><p>and place it anywhere in your <code>PATH</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo mv ./kubectl-foo /usr/local/bin
</span></span></code></pre></div><p>You may now invoke your plugin as a <code>kubectl</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl foo
</span></span></code></pre></div><pre tabindex=0><code>I am a plugin named kubectl-foo
</code></pre><p>All args and flags are passed as-is to the executable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl foo version
</span></span></code></pre></div><pre tabindex=0><code>1.0.0
</code></pre><p>All environment variables are also passed as-is to the executable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>export</span> <span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span>~/.kube/config
</span></span><span style=display:flex><span>kubectl foo config
</span></span></code></pre></div><pre tabindex=0><code>/home/&lt;user&gt;/.kube/config
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span>/etc/kube/config kubectl foo config
</span></span></code></pre></div><pre tabindex=0><code>/etc/kube/config
</code></pre><p>Additionally, the first argument that is passed to a plugin will always be the full path to the location where it was invoked (<code>$0</code> would equal <code>/usr/local/bin/kubectl-foo</code> in the example above).</p><h3 id=naming-a-plugin>Naming a plugin</h3><p>As seen in the example above, a plugin determines the command path that it will implement based on its filename. Every sub-command in the command path that a plugin targets, is separated by a dash (<code>-</code>).
For example, a plugin that wishes to be invoked whenever the command <code>kubectl foo bar baz</code> is invoked by the user, would have the filename of <code>kubectl-foo-bar-baz</code>.</p><h4 id=flags-and-argument-handling>Flags and argument handling</h4><div class="alert alert-info note callout" role=alert><strong>Note:</strong><p>The plugin mechanism does <em>not</em> create any custom, plugin-specific values or environment variables for a plugin process.</p><p>An older kubectl plugin mechanism provided environment variables such as <code>KUBECTL_PLUGINS_CURRENT_NAMESPACE</code>; that no longer happens.</p></div><p>kubectl plugins must parse and validate all of the arguments passed to them.
See <a href=#using-the-command-line-runtime-package>using the command line runtime package</a> for details of a Go library aimed at plugin authors.</p><p>Here are some additional cases where users invoke your plugin while providing additional flags and arguments. This builds upon the <code>kubectl-foo-bar-baz</code> plugin from the scenario above.</p><p>If you run <code>kubectl foo bar baz arg1 --flag=value arg2</code>, kubectl's plugin mechanism will first try to find the plugin with the longest possible name, which in this case
would be <code>kubectl-foo-bar-baz-arg1</code>. Upon not finding that plugin, kubectl then treats the last dash-separated value as an argument (<code>arg1</code> in this case), and attempts to find the next longest possible name, <code>kubectl-foo-bar-baz</code>.
Upon having found a plugin with this name, kubectl then invokes that plugin, passing all args and flags after the plugin's name as arguments to the plugin process.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># create a plugin</span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -e <span style=color:#b44>&#39;#!/bin/bash\n\necho &#34;My first command-line argument was $1&#34;&#39;</span> &gt; kubectl-foo-bar-baz
</span></span><span style=display:flex><span>sudo chmod +x ./kubectl-foo-bar-baz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># &#34;install&#34; your plugin by moving it to a directory in your $PATH</span>
</span></span><span style=display:flex><span>sudo mv ./kubectl-foo-bar-baz /usr/local/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># check that kubectl recognizes your plugin</span>
</span></span><span style=display:flex><span>kubectl plugin list
</span></span></code></pre></div><pre tabindex=0><code>The following kubectl-compatible plugins are available:

/usr/local/bin/kubectl-foo-bar-baz
</code></pre><pre tabindex=0><code># test that calling your plugin via a &#34;kubectl&#34; command works
# even when additional arguments and flags are passed to your
# plugin executable by the user.
kubectl foo bar baz arg1 --meaningless-flag=true
</code></pre><pre tabindex=0><code>My first command-line argument was arg1
</code></pre><p>As you can see, your plugin was found based on the <code>kubectl</code> command specified by a user, and all extra arguments and flags were passed as-is to the plugin executable once it was found.</p><h4 id=names-with-dashes-and-underscores>Names with dashes and underscores</h4><p>Although the <code>kubectl</code> plugin mechanism uses the dash (<code>-</code>) in plugin filenames to separate the sequence of sub-commands processed by the plugin, it is still possible to create a plugin
command containing dashes in its commandline invocation by using underscores (<code>_</code>) in its filename.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># create a plugin containing an underscore in its filename</span>
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -e <span style=color:#b44>&#39;#!/bin/bash\n\necho &#34;I am a plugin with a dash in my name&#34;&#39;</span> &gt; ./kubectl-foo_bar
</span></span><span style=display:flex><span>sudo chmod +x ./kubectl-foo_bar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># move the plugin into your $PATH</span>
</span></span><span style=display:flex><span>sudo mv ./kubectl-foo_bar /usr/local/bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># You can now invoke your plugin via kubectl:</span>
</span></span><span style=display:flex><span>kubectl foo-bar
</span></span></code></pre></div><pre tabindex=0><code>I am a plugin with a dash in my name
</code></pre><p>Note that the introduction of underscores to a plugin filename does not prevent you from having commands such as <code>kubectl foo_bar</code>.
The command from the above example, can be invoked using either a dash (<code>-</code>) or an underscore (<code>_</code>):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># You can invoke your custom command with a dash</span>
</span></span><span style=display:flex><span>kubectl foo-bar
</span></span></code></pre></div><pre tabindex=0><code>I am a plugin with a dash in my name
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># You can also invoke your custom command with an underscore</span>
</span></span><span style=display:flex><span>kubectl foo_bar
</span></span></code></pre></div><pre tabindex=0><code>I am a plugin with a dash in my name
</code></pre><h4 id=name-conflicts-and-overshadowing>Name conflicts and overshadowing</h4><p>It is possible to have multiple plugins with the same filename in different locations throughout your <code>PATH</code>.
For example, given a <code>PATH</code> with the following value: <code>PATH=/usr/local/bin/plugins:/usr/local/bin/moreplugins</code>, a copy of plugin <code>kubectl-foo</code> could exist in <code>/usr/local/bin/plugins</code> and <code>/usr/local/bin/moreplugins</code>,
such that the output of the <code>kubectl plugin list</code> command is:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#b8860b>PATH</span><span style=color:#666>=</span>/usr/local/bin/plugins:/usr/local/bin/moreplugins kubectl plugin list
</span></span></code></pre></div><pre tabindex=0><code>The following kubectl-compatible plugins are available:

/usr/local/bin/plugins/kubectl-foo
/usr/local/bin/moreplugins/kubectl-foo
  - warning: /usr/local/bin/moreplugins/kubectl-foo is overshadowed by a similarly named plugin: /usr/local/bin/plugins/kubectl-foo

error: one plugin warning was found
</code></pre><p>In the above scenario, the warning under <code>/usr/local/bin/moreplugins/kubectl-foo</code> tells you that this plugin will never be executed. Instead, the executable that appears first in your <code>PATH</code>, <code>/usr/local/bin/plugins/kubectl-foo</code>, will always be found and executed first by the <code>kubectl</code> plugin mechanism.</p><p>A way to resolve this issue is to ensure that the location of the plugin that you wish to use with <code>kubectl</code> always comes first in your <code>PATH</code>. For example, if you want to always use <code>/usr/local/bin/moreplugins/kubectl-foo</code> anytime that the <code>kubectl</code> command <code>kubectl foo</code> was invoked, change the value of your <code>PATH</code> to be <code>/usr/local/bin/moreplugins:/usr/local/bin/plugins</code>.</p><h4 id=invocation-of-the-longest-executable-filename>Invocation of the longest executable filename</h4><p>There is another kind of overshadowing that can occur with plugin filenames. Given two plugins present in a user's <code>PATH</code>: <code>kubectl-foo-bar</code> and <code>kubectl-foo-bar-baz</code>, the <code>kubectl</code> plugin mechanism will always choose the longest possible plugin name for a given user command. Some examples below, clarify this further:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># for a given kubectl command, the plugin with the longest possible filename will always be preferred</span>
</span></span><span style=display:flex><span>kubectl foo bar baz
</span></span></code></pre></div><pre tabindex=0><code>Plugin kubectl-foo-bar-baz is executed
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl foo bar
</span></span></code></pre></div><pre tabindex=0><code>Plugin kubectl-foo-bar is executed
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl foo bar baz buz
</span></span></code></pre></div><pre tabindex=0><code>Plugin kubectl-foo-bar-baz is executed, with &#34;buz&#34; as its first argument
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl foo bar buz
</span></span></code></pre></div><pre tabindex=0><code>Plugin kubectl-foo-bar is executed, with &#34;buz&#34; as its first argument
</code></pre><p>This design choice ensures that plugin sub-commands can be implemented across multiple files, if needed, and that these sub-commands can be nested under a "parent" plugin command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls ./plugin_command_tree
</span></span></code></pre></div><pre tabindex=0><code>kubectl-parent
kubectl-parent-subcommand
kubectl-parent-subcommand-subsubcommand
</code></pre><h3 id=checking-for-plugin-warnings>Checking for plugin warnings</h3><p>You can use the aforementioned <code>kubectl plugin list</code> command to ensure that your plugin is visible by <code>kubectl</code>, and verify that there are no warnings preventing it from being called as a <code>kubectl</code> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl plugin list
</span></span></code></pre></div><pre tabindex=0><code>The following kubectl-compatible plugins are available:

test/fixtures/pkg/kubectl/plugins/kubectl-foo
/usr/local/bin/kubectl-foo
  - warning: /usr/local/bin/kubectl-foo is overshadowed by a similarly named plugin: test/fixtures/pkg/kubectl/plugins/kubectl-foo
plugins/kubectl-invalid
  - warning: plugins/kubectl-invalid identified as a kubectl plugin, but it is not executable

error: 2 plugin warnings were found
</code></pre><h3 id=using-the-command-line-runtime-package>Using the command line runtime package</h3><p>If you're writing a plugin for kubectl and you're using Go, you can make use
of the
<a href=https://github.com/kubernetes/cli-runtime>cli-runtime</a> utility libraries.</p><p>These libraries provide helpers for parsing or updating a user's
<a href=/docs/concepts/configuration/organize-cluster-access-kubeconfig/>kubeconfig</a>
file, for making REST-style requests to the API server, or to bind flags
associated with configuration and printing.</p><p>See the <a href=https://github.com/kubernetes/sample-cli-plugin>Sample CLI Plugin</a> for
an example usage of the tools provided in the CLI Runtime repo.</p><h2 id=distributing-kubectl-plugins>Distributing kubectl plugins</h2><p>If you have developed a plugin for others to use, you should consider how you
package it, distribute it and deliver updates to your users.</p><h3 id=distributing-krew>Krew</h3><p><a href=https://krew.dev/>Krew</a> offers a cross-platform way to package and
distribute your plugins. This way, you use a single packaging format for all
target platforms (Linux, Windows, macOS etc) and deliver updates to your users.
Krew also maintains a <a href=https://krew.sigs.k8s.io/plugins/>plugin
index</a> so that other people can
discover your plugin and install it.</p><h3 id=distributing-native>Native / platform specific package management</h3><p>Alternatively, you can use traditional package managers such as, <code>apt</code> or <code>yum</code>
on Linux, Chocolatey on Windows, and Homebrew on macOS. Any package
manager will be suitable if it can place new executables placed somewhere
in the user's <code>PATH</code>.
As a plugin author, if you pick this option then you also have the burden
of updating your kubectl plugin's distribution package across multiple
platforms for each release.</p><h3 id=distributing-source-code>Source code</h3><p>You can publish the source code; for example, as a Git repository. If you
choose this option, someone who wants to use that plugin must fetch the code,
set up a build environment (if it needs compiling), and deploy the plugin.
If you also make compiled packages available, or use Krew, that will make
installs easier.</p><h2 id=what-s-next>What's next</h2><ul><li>Check the Sample CLI Plugin repository for a
<a href=https://github.com/kubernetes/sample-cli-plugin>detailed example</a> of a
plugin written in Go.
In case of any questions, feel free to reach out to the
<a href=https://github.com/kubernetes/community/tree/master/sig-cli>SIG CLI team</a>.</li><li>Read about <a href=https://krew.dev/>Krew</a>, a package manager for kubectl plugins.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fdfb2a2cba62a1e624897eaebac0168e>17 - Manage HugePages</h1><div class=lead>Configure and manage huge pages as a schedulable resource in a cluster.</div><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [stable]</code></div><p>Kubernetes supports the allocation and consumption of pre-allocated huge pages
by applications in a Pod. This page describes how users can consume huge pages.</p><h2 id=before-you-begin>Before you begin</h2><ol><li>Kubernetes nodes must pre-allocate huge pages in order for the node to report
its huge page capacity. A node can pre-allocate huge pages for multiple
sizes.</li></ol><p>The nodes will automatically discover and report all huge page resources as
schedulable resources.</p><h2 id=api>API</h2><p>Huge pages can be consumed via container level resource requirements using the
resource name <code>hugepages-&lt;size></code>, where <code>&lt;size></code> is the most compact binary
notation using integer values supported on a particular node. For example, if a
node supports 2048KiB and 1048576KiB page sizes, it will expose a schedulable
resources <code>hugepages-2Mi</code> and <code>hugepages-1Gi</code>. Unlike CPU or memory, huge pages
do not support overcommit. Note that when requesting hugepage resources, either
memory or CPU resources must be requested as well.</p><p>A pod may consume multiple huge page sizes in a single pod spec. In this case it
must use <code>medium: HugePages-&lt;hugepagesize></code> notation for all volume mounts.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>huge-pages-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>fedora:latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- sleep<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- inf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/hugepages-2Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hugepage-2mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/hugepages-1Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hugepage-1gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hugepages-2Mi</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hugepages-1Gi</span>:<span style=color:#bbb> </span>2Gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hugepage-2mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>medium</span>:<span style=color:#bbb> </span>HugePages-2Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hugepage-1gi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>medium</span>:<span style=color:#bbb> </span>HugePages-1Gi<span style=color:#bbb>
</span></span></span></code></pre></div><p>A pod may use <code>medium: HugePages</code> only if it requests huge pages of one size.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>huge-pages-example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>fedora:latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- sleep<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- inf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/hugepages<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hugepage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hugepages-2Mi</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>100Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hugepage<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>medium</span>:<span style=color:#bbb> </span>HugePages<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li>Huge page requests must equal the limits. This is the default if limits are
specified, but requests are not.</li><li>Huge pages are isolated at a container scope, so each container has own
limit on their cgroup sandbox as requested in a container spec.</li><li>EmptyDir volumes backed by huge pages may not consume more huge page memory
than the pod request.</li><li>Applications that consume huge pages via <code>shmget()</code> with <code>SHM_HUGETLB</code> must
run with a supplemental group that matches <code>proc/sys/vm/hugetlb_shm_group</code>.</li><li>Huge page usage in a namespace is controllable via ResourceQuota similar
to other compute resources like <code>cpu</code> or <code>memory</code> using the <code>hugepages-&lt;size></code>
token.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5ab7bc7f14942c5c4b29d19f4a87271c>18 - Schedule GPUs</h1><div class=lead>Configure and schedule GPUs for use as a resource by nodes in a cluster.</div><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.10 [beta]</code></div><p>Kubernetes includes <strong>experimental</strong> support for managing GPUs
(graphical processing units) across several nodes.</p><p>This page describes how users can consume GPUs, and outlines
some of the limitations in the implementation.</p><h2 id=using-device-plugins>Using device plugins</h2><p>Kubernetes implements <a class=glossary-tooltip title='Software extensions to let Pods access devices that need vendor-specific initialization or setup' data-toggle=tooltip data-placement=top href=/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/ target=_blank aria-label='device plugins'>device plugins</a>
to let Pods access specialized hardware features such as GPUs.</p><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>As an administrator, you have to install GPU drivers from the corresponding
hardware vendor on the nodes and run the corresponding device plugin from the
GPU vendor. Here are some links to vendors' instructions:</p><ul><li><a href=https://github.com/RadeonOpenCompute/k8s-device-plugin#deployment>AMD</a></li><li><a href=https://intel.github.io/intel-device-plugins-for-kubernetes/cmd/gpu_plugin/README.html>Intel</a></li><li><a href=https://github.com/NVIDIA/k8s-device-plugin#quick-start>NVIDIA</a></li></ul><p>Once you have installed the plugin, your cluster exposes a custom schedulable resource such as <code>amd.com/gpu</code> or <code>nvidia.com/gpu</code>.</p><p>You can consume these GPUs from your containers by requesting
the custom GPU resource, the same way you request <code>cpu</code> or <code>memory</code>.
However, there are some limitations in how you specify the resource
requirements for custom devices.</p><p>GPUs are only supposed to be specified in the <code>limits</code> section, which means:</p><ul><li>You can specify GPU <code>limits</code> without specifying <code>requests</code>, because
Kubernetes will use the limit as the request value by default.</li><li>You can specify GPU in both <code>limits</code> and <code>requests</code> but these two values
must be equal.</li><li>You cannot specify GPU <code>requests</code> without specifying <code>limits</code>.</li></ul><p>Here's an example manifest for a Pod that requests a GPU:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-vector-add<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-vector-add<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;registry.example/example-vector-add:v42&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>gpu-vendor.example/example-gpu</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># requesting 1 GPU</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=clusters-containing-different-types-of-gpus>Clusters containing different types of GPUs</h2><p>If different nodes in your cluster have different types of GPUs, then you
can use <a href=/docs/tasks/configure-pod-container/assign-pods-nodes/>Node Labels and Node Selectors</a>
to schedule pods to appropriate nodes.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Label your nodes with the accelerator type they have.</span>
</span></span><span style=display:flex><span>kubectl label nodes node1 <span style=color:#b8860b>accelerator</span><span style=color:#666>=</span>example-gpu-x100
</span></span><span style=display:flex><span>kubectl label nodes node2 <span style=color:#b8860b>accelerator</span><span style=color:#666>=</span>other-gpu-k915
</span></span></code></pre></div><p>That label key <code>accelerator</code> is just an example; you can use
a different label key if you prefer.</p><h2 id=node-labeller>Automatic node labelling</h2><p>If you're using AMD GPU devices, you can deploy
<a href=https://github.com/RadeonOpenCompute/k8s-device-plugin/tree/master/cmd/k8s-node-labeller>Node Labeller</a>.
Node Labeller is a <a class=glossary-tooltip title='A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/controller/ target=_blank aria-label=controller>controller</a> that automatically
labels your nodes with GPU device properties.</p><p>At the moment, that controller can add labels for:</p><ul><li>Device ID (-device-id)</li><li>VRAM Size (-vram)</li><li>Number of SIMD (-simd-count)</li><li>Number of Compute Unit (-cu-count)</li><li>Firmware and Feature Versions (-firmware)</li><li>GPU Family, in two letters acronym (-family)<ul><li>SI - Southern Islands</li><li>CI - Sea Islands</li><li>KV - Kaveri</li><li>VI - Volcanic Islands</li><li>CZ - Carrizo</li><li>AI - Arctic Islands</li><li>RV - Raven</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe node cluster-node-23
</span></span></code></pre></div><pre tabindex=0><code>Name:               cluster-node-23
Roles:              &lt;none&gt;
Labels:             beta.amd.com/gpu.cu-count.64=1
                    beta.amd.com/gpu.device-id.6860=1
                    beta.amd.com/gpu.family.AI=1
                    beta.amd.com/gpu.simd-count.256=1
                    beta.amd.com/gpu.vram.16G=1
                    kubernetes.io/arch=amd64
                    kubernetes.io/os=linux
                    kubernetes.io/hostname=cluster-node-23
Annotations:        node.alpha.kubernetes.io/ttl: 0
…
</code></pre><p>With the Node Labeller in use, you can specify the GPU type in the Pod spec:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cuda-vector-add<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cuda-vector-add<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># https://github.com/kubernetes/kubernetes/blob/v1.7.11/test/images/nvidia-cuda/Dockerfile</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;registry.k8s.io/cuda-vector-add:v0.1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>nvidia.com/gpu</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>affinity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>nodeAffinity</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>requiredDuringSchedulingIgnoredDuringExecution</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>nodeSelectorTerms</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>– matchExpressions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>– key</span>:<span style=color:#bbb> </span>beta.amd.com/gpu.family.AI<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Arctic Islands GPU family</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Exist<span style=color:#bbb>
</span></span></span></code></pre></div><p>This ensures that the Pod will be scheduled to a node that has the GPU type
you specified.</p></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/docs/home/>Home</a>
<a class=text-white href=/blog/>Blog</a>
<a class=text-white href=/training/>Training</a>
<a class=text-white href=/partners/>Partners</a>
<a class=text-white href=/community/>Community</a>
<a class=text-white href=/case-studies/>Case Studies</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a></small><br><small class=text-white>Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>