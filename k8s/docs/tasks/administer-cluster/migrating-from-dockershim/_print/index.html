<!doctype html><html lang=en class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=zh-cn href=https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/migrating-from-dockershim/><link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/tasks/administer-cluster/migrating-from-dockershim/><link rel=alternate hreflang=ja href=https://kubernetes.io/ja/docs/tasks/administer-cluster/migrating-from-dockershim/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>Migrating from dockershim | Kubernetes</title><meta property="og:title" content="Migrating from dockershim"><meta property="og:description" content="Production-Grade Container Orchestration"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="Migrating from dockershim"><meta itemprop=description content="Production-Grade Container Orchestration"><meta name=twitter:card content="summary"><meta name=twitter:title content="Migrating from dockershim"><meta name=twitter:description content="Production-Grade Container Orchestration"><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content="This section presents information you need to know when migrating from dockershim to other container runtimes.
Since the announcement of dockershim deprecation in Kubernetes 1.20, there were questions on how this will affect various workloads and Kubernetes installations. Our Dockershim Removal FAQ is there to help you to understand the problem better.
Dockershim was removed from Kubernetes with the release of v1.24. If you use Docker Engine via dockershim as your container runtime, and wish to upgrade to v1."><meta property="og:description" content="This section presents information you need to know when migrating from dockershim to other container runtimes.
Since the announcement of dockershim deprecation in Kubernetes 1.20, there were questions on how this will affect various workloads and Kubernetes installations. Our Dockershim Removal FAQ is there to help you to understand the problem better.
Dockershim was removed from Kubernetes with the release of v1.24. If you use Docker Engine via dockershim as your container runtime, and wish to upgrade to v1."><meta name=twitter:description content="This section presents information you need to know when migrating from dockershim to other container runtimes.
Since the announcement of dockershim deprecation in Kubernetes 1.20, there were questions on how this will affect various workloads and Kubernetes installations. Our Dockershim Removal FAQ is there to help you to understand the problem better.
Dockershim was removed from Kubernetes with the release of v1.24. If you use Docker Engine via dockershim as your container runtime, and wish to upgrade to v1."><meta property="og:url" content="https://kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/"><meta property="og:title" content="Migrating from dockershim"><meta name=twitter:title content="Migrating from dockershim"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/docs/>Documentation</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/blog/>Kubernetes Blog</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/training/>Training</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/partners/>Partners</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/community/>Community</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/case-studies/>Case Studies</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/>v1.21</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/docs/tasks/administer-cluster/migrating-from-dockershim/>中文 (Chinese)</a>
<a class=dropdown-item href=/ko/docs/tasks/administer-cluster/migrating-from-dockershim/>한국어 (Korean)</a>
<a class=dropdown-item href=/ja/docs/tasks/administer-cluster/migrating-from-dockershim/>日本語 (Japanese)</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/>Return to the regular view of this page</a>.</p></div><h1 class=title>Migrating from dockershim</h1><ul><li>1: <a href=#pg-b8acce0768c2f92cdb8eaa31e8072353>Changing the Container Runtime on a Node from Docker Engine to containerd</a></li><li>2: <a href=#pg-d81ef0973a7bb4813e1797a452864742>Migrate Docker Engine nodes from dockershim to cri-dockerd</a></li><li>3: <a href=#pg-d79db9ed1698f75ec5f2228987290e49>Find Out What Container Runtime is Used on a Node</a></li><li>4: <a href=#pg-c4b5bb78bc6c59690d21c44e41f12270>Troubleshooting CNI plugin-related errors</a></li><li>5: <a href=#pg-cbd252cc297e67c1b73a84d5882474fb>Check whether dockershim removal affects you</a></li><li>6: <a href=#pg-eb3e279a6c5e1224e744080a52ee3f28>Migrating telemetry and security agents from dockershim</a></li></ul><div class=content><p>This section presents information you need to know when migrating from
dockershim to other container runtimes.</p><p>Since the announcement of <a href=/blog/2020/12/08/kubernetes-1-20-release-announcement/#dockershim-deprecation>dockershim deprecation</a>
in Kubernetes 1.20, there were questions on how this will affect various workloads and Kubernetes
installations. Our <a href=/blog/2022/02/17/dockershim-faq/>Dockershim Removal FAQ</a> is there to help you
to understand the problem better.</p><p>Dockershim was removed from Kubernetes with the release of v1.24.
If you use Docker Engine via dockershim as your container runtime, and wish to upgrade to v1.24,
it is recommended that you either migrate to another runtime or find an alternative means to obtain Docker Engine support.
Check out <a href=/docs/setup/production-environment/container-runtimes/>container runtimes</a>
section to know your options. Make sure to
<a href=https://github.com/kubernetes/kubernetes/issues>report issues</a> you encountered
with the migration. So the issue can be fixed in a timely manner and your cluster would be
ready for dockershim removal.</p><p>Your cluster might have more than one kind of node, although this is not a common
configuration.</p><p>These tasks will help you to migrate:</p><ul><li><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/check-if-dockershim-removal-affects-you/>Check whether Dockershim removal affects you</a></li><li><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/migrate-dockershim-dockerd/>Migrate Docker Engine nodes from dockershim to cri-dockerd</a></li><li><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/migrating-telemetry-and-security-agents/>Migrating telemetry and security agents from dockershim</a></li></ul><h2 id=what-s-next>What's next</h2><ul><li>Check out <a href=/docs/setup/production-environment/container-runtimes/>container runtimes</a>
to understand your options for a container runtime.</li><li>There is a
<a href=https://github.com/kubernetes/kubernetes/issues/106917>GitHub issue</a>
to track discussion about the deprecation and removal of dockershim.</li><li>If you found a defect or other technical concern relating to migrating away from dockershim,
you can <a href=https://github.com/kubernetes/kubernetes/issues/new/choose>report an issue</a>
to the Kubernetes project.</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b8acce0768c2f92cdb8eaa31e8072353>1 - Changing the Container Runtime on a Node from Docker Engine to containerd</h1><p>This task outlines the steps needed to update your container runtime to containerd from Docker. It
is applicable for cluster operators running Kubernetes 1.23 or earlier. This also covers an
example scenario for migrating from dockershim to containerd. Alternative container runtimes
can be picked from this <a href=/docs/setup/production-environment/container-runtimes/>page</a>.</p><h2 id=before-you-begin>Before you begin</h2><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>Install containerd. For more information see
<a href=https://containerd.io/docs/getting-started/>containerd's installation documentation</a>
and for specific prerequisite follow
<a href=/docs/setup/production-environment/container-runtimes/#containerd>the containerd guide</a>.</p><h2 id=drain-the-node>Drain the node</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</span></span></code></pre></div><p>Replace <code>&lt;node-to-drain></code> with the name of your node you are draining.</p><h2 id=stop-the-docker-daemon>Stop the Docker daemon</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl stop kubelet
</span></span><span style=display:flex><span>systemctl disable docker.service --now
</span></span></code></pre></div><h2 id=install-containerd>Install Containerd</h2><p>Follow the <a href=/docs/setup/production-environment/container-runtimes/#containerd>guide</a>
for detailed steps to install containerd.</p><ul class="nav nav-tabs" id=tab-cri-containerd-installation role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tab-cri-containerd-installation-0 role=tab aria-controls=tab-cri-containerd-installation-0 aria-selected=true>Linux</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-cri-containerd-installation-1 role=tab aria-controls=tab-cri-containerd-installation-1>Windows (PowerShell)</a></li></ul><div class=tab-content id=tab-cri-containerd-installation><div id=tab-cri-containerd-installation-0 class="tab-pane show active" role=tabpanel aria-labelledby=tab-cri-containerd-installation-0><p><ol><li><p>Install the <code>containerd.io</code> package from the official Docker repositories.
Instructions for setting up the Docker repository for your respective Linux distribution and
installing the <code>containerd.io</code> package can be found at
<a href=https://github.com/containerd/containerd/blob/main/docs/getting-started.md>Getting started with containerd</a>.</p></li><li><p>Configure containerd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo mkdir -p /etc/containerd
</span></span><span style=display:flex><span>containerd config default | sudo tee /etc/containerd/config.toml
</span></span></code></pre></div></li><li><p>Restart containerd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl restart containerd
</span></span></code></pre></div></li></ol></div><div id=tab-cri-containerd-installation-1 class=tab-pane role=tabpanel aria-labelledby=tab-cri-containerd-installation-1><p><p>Start a Powershell session, set <code>$Version</code> to the desired version (ex: <code>$Version="1.4.3"</code>), and
then run the following commands:</p><ol><li><p>Download containerd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>curl.exe -L https<span>:</span>//github.com/containerd/containerd/releases/download/v<span style=color:#b8860b>$Version</span>/containerd-<span style=color:#b8860b>$Version</span>-windows-amd64.tar.gz -o <span style=color:#a2f>containerd-windows</span>-amd64.tar.gz
</span></span><span style=display:flex><span>tar.exe xvf .\<span style=color:#a2f>containerd-windows</span>-amd64.tar.gz
</span></span></code></pre></div></li><li><p>Extract and configure:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>Copy-Item</span> -Path <span style=color:#b44>&#34;.\bin\&#34;</span> -Destination <span style=color:#b44>&#34;</span><span style=color:#b8860b>$Env:ProgramFiles</span><span style=color:#b44>\containerd&#34;</span> -Recurse -Force
</span></span><span style=display:flex><span><span style=color:#a2f>cd </span><span style=color:#b8860b>$Env:ProgramFiles</span>\containerd\
</span></span><span style=display:flex><span>.\containerd.exe config <span style=color:#a2f;font-weight:700>default</span> | <span style=color:#a2f>Out-File</span> config.toml -Encoding ascii
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Review the configuration. Depending on setup you may want to adjust:</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># - the sandbox_image (Kubernetes pause image)</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># - cni bin_dir and conf_dir locations</span>
</span></span><span style=display:flex><span><span style=color:#a2f>Get-Content</span> config.toml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># (Optional - but highly recommended) Exclude containerd from Windows Defender Scans</span>
</span></span><span style=display:flex><span><span style=color:#a2f>Add-MpPreference</span> -ExclusionProcess <span style=color:#b44>&#34;</span><span style=color:#b8860b>$Env:ProgramFiles</span><span style=color:#b44>\containerd\containerd.exe&#34;</span>
</span></span></code></pre></div></li><li><p>Start containerd:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\containerd.exe --register-service
</span></span><span style=display:flex><span><span style=color:#a2f>Start-Service</span> containerd
</span></span></code></pre></div></li></ol></div></div><h2 id=configure-the-kubelet-to-use-containerd-as-its-container-runtime>Configure the kubelet to use containerd as its container runtime</h2><p>Edit the file <code>/var/lib/kubelet/kubeadm-flags.env</code> and add the containerd runtime to the flags.
<code>--container-runtime=remote</code> and
<code>--container-runtime-endpoint=unix:///run/containerd/containerd.sock</code>.</p><p>Users using kubeadm should be aware that the <code>kubeadm</code> tool stores the CRI socket for each host as
an annotation in the Node object for that host. To change it you can execute the following command
on a machine that has the kubeadm <code>/etc/kubernetes/admin.conf</code> file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit no &lt;node-name&gt;
</span></span></code></pre></div><p>This will start a text editor where you can edit the Node object.
To choose a text editor you can set the <code>KUBE_EDITOR</code> environment variable.</p><ul><li><p>Change the value of <code>kubeadm.alpha.kubernetes.io/cri-socket</code> from <code>/var/run/dockershim.sock</code>
to the CRI socket path of your choice (for example <code>unix:///run/containerd/containerd.sock</code>).</p><p>Note that new CRI socket paths must be prefixed with <code>unix://</code> ideally.</p></li><li><p>Save the changes in the text editor, which will update the Node object.</p></li></ul><h2 id=restart-the-kubelet>Restart the kubelet</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start kubelet
</span></span></code></pre></div><h2 id=verify-that-the-node-is-healthy>Verify that the node is healthy</h2><p>Run <code>kubectl get nodes -o wide</code> and containerd appears as the runtime for the node we just changed.</p><h2 id=remove-docker-engine>Remove Docker Engine</h2><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>Finally if everything goes well, remove Docker.</p><ul class="nav nav-tabs" id=tab-remove-docker-engine role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tab-remove-docker-engine-0 role=tab aria-controls=tab-remove-docker-engine-0 aria-selected=true>CentOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-remove-docker-engine-1 role=tab aria-controls=tab-remove-docker-engine-1>Debian</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-remove-docker-engine-2 role=tab aria-controls=tab-remove-docker-engine-2>Fedora</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-remove-docker-engine-3 role=tab aria-controls=tab-remove-docker-engine-3>Ubuntu</a></li></ul><div class=tab-content id=tab-remove-docker-engine><div id=tab-remove-docker-engine-0 class="tab-pane show active" role=tabpanel aria-labelledby=tab-remove-docker-engine-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum remove docker-ce docker-ce-cli
</span></span></code></pre></div></div><div id=tab-remove-docker-engine-1 class=tab-pane role=tabpanel aria-labelledby=tab-remove-docker-engine-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get purge docker-ce docker-ce-cli
</span></span></code></pre></div></div><div id=tab-remove-docker-engine-2 class=tab-pane role=tabpanel aria-labelledby=tab-remove-docker-engine-2><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo dnf remove docker-ce docker-ce-cli
</span></span></code></pre></div></div><div id=tab-remove-docker-engine-3 class=tab-pane role=tabpanel aria-labelledby=tab-remove-docker-engine-3><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get purge docker-ce docker-ce-cli
</span></span></code></pre></div></div></div><p>The preceding commands don't remove images, containers, volumes, or customized configuration files on your host.
To delete them, follow Docker's instructions to <a href=https://docs.docker.com/engine/install/ubuntu/#uninstall-docker-engine>Uninstall Docker Engine</a>.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Docker's instructions for uninstalling Docker Engine create a risk of deleting containerd. Be careful when executing commands.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-d81ef0973a7bb4813e1797a452864742>2 - Migrate Docker Engine nodes from dockershim to cri-dockerd</h1><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>This page shows you how to migrate your Docker Engine nodes to use <code>cri-dockerd</code>
instead of dockershim. You should follow these steps in these scenarios:</p><ul><li>You want to switch away from dockershim and still use Docker Engine to run
containers in Kubernetes.</li><li>You want to upgrade to Kubernetes v1.25 and your
existing cluster relies on dockershim, in which case you must migrate
from dockershim and <code>cri-dockerd</code> is one of your options.</li></ul><p>To learn more about the removal of dockershim, read the <a href=/dockershim>FAQ page</a>.</p><h2 id=what-is-cri-dockerd>What is cri-dockerd?</h2><p>In Kubernetes 1.23 and earlier, you could use Docker Engine with Kubernetes,
relying on a built-in component of Kubernetes named <em>dockershim</em>.
The dockershim component was removed in the Kubernetes 1.24 release; however,
a third-party replacement, <code>cri-dockerd</code>, is available. The <code>cri-dockerd</code> adapter
lets you use Docker Engine through the <a class=glossary-tooltip title='An API for container runtimes to integrate with kubelet' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/components/#container-runtime target=_blank aria-label='Container Runtime Interface'>Container Runtime Interface</a>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you already use <code>cri-dockerd</code>, you aren't affected by the dockershim removal.
Before you begin, <a href=/docs/tasks/administer-cluster/migrating-from-dockershim/find-out-runtime-you-use/>Check whether your nodes use the dockershim</a>.</div><p>If you want to migrate to <code>cri-dockerd</code> so that you can continue using Docker
Engine as your container runtime, you should do the following for each affected
node:</p><ol><li>Install <code>cri-dockerd</code>.</li><li>Cordon and drain the node.</li><li>Configure the kubelet to use <code>cri-dockerd</code>.</li><li>Restart the kubelet.</li><li>Verify that the node is healthy.</li></ol><p>Test the migration on non-critical nodes first.</p><p>You should perform the following steps for each node that you want to migrate
to <code>cri-dockerd</code>.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><a href=https://github.com/mirantis/cri-dockerd#build-and-install><code>cri-dockerd</code></a>
installed and started on each node.</li><li>A <a href=/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/>network plugin</a>.</li></ul><h2 id=cordon-and-drain-the-node>Cordon and drain the node</h2><ol><li><p>Cordon the node to stop new Pods scheduling on it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cordon &lt;NODE_NAME&gt;
</span></span></code></pre></div><p>Replace <code>&lt;NODE_NAME></code> with the name of the node.</p></li><li><p>Drain the node to safely evict running Pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl drain &lt;NODE_NAME&gt; <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --ignore-daemonsets
</span></span></code></pre></div></li></ol><h2 id=configure-the-kubelet-to-use-cri-dockerd>Configure the kubelet to use cri-dockerd</h2><p>The following steps apply to clusters set up using the kubeadm tool. If you use
a different tool, you should modify the kubelet using the configuration
instructions for that tool.</p><ol><li>Open <code>/var/lib/kubelet/kubeadm-flags.env</code> on each affected node.</li><li>Modify the <code>--container-runtime-endpoint</code> flag to
<code>unix:///var/run/cri-dockerd.sock</code>.</li></ol><p>The kubeadm tool stores the node's socket as an annotation on the <code>Node</code> object
in the control plane. To modify this socket for each affected node:</p><ol><li><p>Edit the YAML representation of the <code>Node</code> object:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span>/path/to/admin.conf kubectl edit no &lt;NODE_NAME&gt;
</span></span></code></pre></div><p>Replace the following:</p><ul><li><code>/path/to/admin.conf</code>: the path to the kubectl configuration file,
<code>admin.conf</code>.</li><li><code>&lt;NODE_NAME></code>: the name of the node you want to modify.</li></ul></li><li><p>Change <code>kubeadm.alpha.kubernetes.io/cri-socket</code> from
<code>/var/run/dockershim.sock</code> to <code>unix:///var/run/cri-dockerd.sock</code>.</p></li><li><p>Save the changes. The <code>Node</code> object is updated on save.</p></li></ol><h2 id=restart-the-kubelet>Restart the kubelet</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl restart kubelet
</span></span></code></pre></div><h2 id=verify-that-the-node-is-healthy>Verify that the node is healthy</h2><p>To check whether the node uses the <code>cri-dockerd</code> endpoint, follow the
instructions in <a href=/docs/tasks/administer-cluster/migrating-from-dockershim/find-out-runtime-you-use/>Find out which runtime you use</a>.
The <code>--container-runtime-endpoint</code> flag for the kubelet should be <code>unix:///var/run/cri-dockerd.sock</code>.</p><h2 id=uncordon-the-node>Uncordon the node</h2><p>Uncordon the node to let Pods schedule on it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl uncordon &lt;NODE_NAME&gt;
</span></span></code></pre></div><h2 id=what-s-next>What's next</h2><ul><li>Read the <a href=/dockershim/>dockershim removal FAQ</a>.</li><li><a href=/docs/tasks/administer-cluster/migrating-from-dockershim/change-runtime-containerd/>Learn how to migrate from Docker Engine with dockershim to containerd</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d79db9ed1698f75ec5f2228987290e49>3 - Find Out What Container Runtime is Used on a Node</h1><p>This page outlines steps to find out what <a href=/docs/setup/production-environment/container-runtimes/>container runtime</a>
the nodes in your cluster use.</p><p>Depending on the way you run your cluster, the container runtime for the nodes may
have been pre-configured or you need to configure it. If you're using a managed
Kubernetes service, there might be vendor-specific ways to check what container runtime is
configured for the nodes. The method described on this page should work whenever
the execution of <code>kubectl</code> is allowed.</p><h2 id=before-you-begin>Before you begin</h2><p>Install and configure <code>kubectl</code>. See <a href=/docs/tasks/tools/#kubectl>Install Tools</a> section for details.</p><h2 id=find-out-the-container-runtime-used-on-a-node>Find out the container runtime used on a Node</h2><p>Use <code>kubectl</code> to fetch and show node information:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes -o wide
</span></span></code></pre></div><p>The output is similar to the following. The column <code>CONTAINER-RUNTIME</code> outputs
the runtime and its version.</p><p>For Docker Engine, the output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>NAME         STATUS   VERSION    CONTAINER-RUNTIME
node-1       Ready    v1.16.15   docker://19.3.1
node-2       Ready    v1.16.15   docker://19.3.1
node-3       Ready    v1.16.15   docker://19.3.1
</code></pre><p>If your runtime shows as Docker Engine, you still might not be affected by the
removal of dockershim in Kubernetes v1.24. <a href=#which-endpoint>Check the runtime
endpoint</a> to see if you use dockershim. If you don't use
dockershim, you aren't affected.</p><p>For containerd, the output is similar to this:</p><pre tabindex=0><code class=language-none data-lang=none>NAME         STATUS   VERSION   CONTAINER-RUNTIME
node-1       Ready    v1.19.6   containerd://1.4.1
node-2       Ready    v1.19.6   containerd://1.4.1
node-3       Ready    v1.19.6   containerd://1.4.1
</code></pre><p>Find out more information about container runtimes
on <a href=/docs/setup/production-environment/container-runtimes/>Container Runtimes</a>
page.</p><h2 id=which-endpoint>Find out what container runtime endpoint you use</h2><p>The container runtime talks to the kubelet over a Unix socket using the <a href=/docs/concepts/architecture/cri/>CRI
protocol</a>, which is based on the gRPC
framework. The kubelet acts as a client, and the runtime acts as the server.
In some cases, you might find it useful to know which socket your nodes use. For
example, with the removal of dockershim in Kubernetes v1.24 and later, you might
want to know whether you use Docker Engine with dockershim.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you currently use Docker Engine in your nodes with <code>cri-dockerd</code>, you aren't
affected by the dockershim removal.</div><p>You can check which socket you use by checking the kubelet configuration on your
nodes.</p><ol><li><p>Read the starting commands for the kubelet process:</p><pre tabindex=0><code>tr \\0 &#39; &#39; &lt; /proc/&#34;$(pgrep kubelet)&#34;/cmdline
</code></pre><p>If you don't have <code>tr</code> or <code>pgrep</code>, check the command line for the kubelet
process manually.</p></li><li><p>In the output, look for the <code>--container-runtime</code> flag and the
<code>--container-runtime-endpoint</code> flag.</p><ul><li>If your nodes use Kubernetes v1.23 and earlier and these flags aren't
present or if the <code>--container-runtime</code> flag is not <code>remote</code>,
you use the dockershim socket with Docker Engine.</li><li>If the <code>--container-runtime-endpoint</code> flag is present, check the socket
name to find out which runtime you use. For example,
<code>unix:///run/containerd/containerd.sock</code> is the containerd endpoint.</li></ul></li></ol><p>If you want to change the Container Runtime on a Node from Docker Engine to containerd,
you can find out more information on <a href=/docs/tasks/administer-cluster/migrating-from-dockershim/change-runtime-containerd/>migrating from Docker Engine to containerd</a>,
or, if you want to continue using Docker Engine in Kubernetes v1.24 and later, migrate to a
CRI-compatible adapter like <a href=https://github.com/Mirantis/cri-dockerd><code>cri-dockerd</code></a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c4b5bb78bc6c59690d21c44e41f12270>4 - Troubleshooting CNI plugin-related errors</h1><p>To avoid CNI plugin-related errors, verify that you are using or upgrading to a
container runtime that has been tested to work correctly with your version of
Kubernetes.</p><h2 id=about-the-incompatible-cni-versions-and-failed-to-destroy-network-for-sandbox-errors>About the "Incompatible CNI versions" and "Failed to destroy network for sandbox" errors</h2><p>Service issues exist for pod CNI network setup and tear down in containerd
v1.6.0-v1.6.3 when the CNI plugins have not been upgraded and/or the CNI config
version is not declared in the CNI config files. The containerd team reports, "these issues are resolved in containerd v1.6.4."</p><p>With containerd v1.6.0-v1.6.3, if you do not upgrade the CNI plugins and/or
declare the CNI config version, you might encounter the following "Incompatible
CNI versions" or "Failed to destroy network for sandbox" error conditions.</p><h3 id=incompatible-cni-versions-error>Incompatible CNI versions error</h3><p>If the version of your CNI plugin does not correctly match the plugin version in
the config because the config version is later than the plugin version, the
containerd log will likely show an error message on startup of a pod similar
to:</p><pre tabindex=0><code>incompatible CNI versions; config is \&#34;1.0.0\&#34;, plugin supports [\&#34;0.1.0\&#34; \&#34;0.2.0\&#34; \&#34;0.3.0\&#34; \&#34;0.3.1\&#34; \&#34;0.4.0\&#34;]&#34;
</code></pre><p>To fix this issue, <a href=#updating-your-cni-plugins-and-cni-config-files>update your CNI plugins and CNI config files</a>.</p><h3 id=failed-to-destroy-network-for-sandbox-error>Failed to destroy network for sandbox error</h3><p>If the version of the plugin is missing in the CNI plugin config, the pod may
run. However, stopping the pod generates an error similar to:</p><pre tabindex=0><code>ERRO[2022-04-26T00:43:24.518165483Z] StopPodSandbox for &#34;b&#34; failed
error=&#34;failed to destroy network for sandbox \&#34;bbc85f891eaf060c5a879e27bba9b6b06450210161dfdecfbb2732959fb6500a\&#34;: invalid version \&#34;\&#34;: the version is empty&#34;
</code></pre><p>This error leaves the pod in the not-ready state with a network namespace still
attached. To recover from this problem, <a href=#updating-your-cni-plugins-and-cni-config-files>edit the CNI config file</a> to add
the missing version information. The next attempt to stop the pod should
be successful.</p><h3 id=updating-your-cni-plugins-and-cni-config-files>Updating your CNI plugins and CNI config files</h3><p>If you're using containerd v1.6.0-v1.6.3 and encountered "Incompatible CNI
versions" or "Failed to destroy network for sandbox" errors, consider updating
your CNI plugins and editing the CNI config files.</p><p>Here's an overview of the typical steps for each node:</p><ol><li><a href=/docs/tasks/administer-cluster/safely-drain-node/>Safely drain and cordon the
node</a>.</li><li>After stopping your container runtime and kubelet services, perform the
following upgrade operations:</li></ol><ul><li>If you're running CNI plugins, upgrade them to the latest version.</li><li>If you're using non-CNI plugins, replace them with CNI plugins. Use the
latest version of the plugins.</li><li>Update the plugin configuration file to specify or match a version of the
CNI specification that the plugin supports, as shown in the following <a href=#an-example-containerd-configuration-file>"An
example containerd configuration
file"</a> section.</li><li>For <code>containerd</code>, ensure that you have installed the latest version (v1.0.0
or later) of the CNI loopback plugin.</li><li>Upgrade node components (for example, the kubelet) to Kubernetes v1.24</li><li>Upgrade to or install the most current version of the container runtime.</li></ul><ol start=3><li>Bring the node back into your cluster by restarting your container runtime
and kubelet. Uncordon the node (<code>kubectl uncordon &lt;nodename></code>).</li></ol><h2 id=an-example-containerd-configuration-file>An example containerd configuration file</h2><p>The following example shows a configuration for <code>containerd</code> runtime v1.6.x,
which supports a recent version of the CNI specification (v1.0.0).</p><p>Please see the documentation from your plugin and networking provider for
further instructions on configuring your system.</p><p>On Kubernetes, containerd runtime adds a loopback interface, <code>lo</code>, to pods as a
default behavior. The containerd runtime configures the loopback interface via a
CNI plugin, <code>loopback</code>. The <code>loopback</code> plugin is distributed as part of the
<code>containerd</code> release packages that have the <code>cni</code> designation. <code>containerd</code>
v1.6.0 and later includes a CNI v1.0.0-compatible loopback plugin as well as
other default CNI plugins. The configuration for the loopback plugin is done
internally by containerd, and is set to use CNI v1.0.0. This also means that the
version of the <code>loopback</code> plugin must be v1.0.0 or later when this newer version
<code>containerd</code> is started.</p><p>The following bash command generates an example CNI config. Here, the 1.0.0
value for the config version is assigned to the <code>cniVersion</code> field for use when
<code>containerd</code> invokes the CNI bridge plugin.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt; EOF | tee /etc/cni/net.d/10-containerd-net.conflist
</span></span></span><span style=display:flex><span><span style=color:#b44>{
</span></span></span><span style=display:flex><span><span style=color:#b44> &#34;cniVersion&#34;: &#34;1.0.0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44> &#34;name&#34;: &#34;containerd-net&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44> &#34;plugins&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#b44>   {
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;type&#34;: &#34;bridge&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;bridge&#34;: &#34;cni0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;isGateway&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;ipMasq&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;promiscMode&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;ipam&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#b44>       &#34;type&#34;: &#34;host-local&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>       &#34;ranges&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#b44>         [{
</span></span></span><span style=display:flex><span><span style=color:#b44>           &#34;subnet&#34;: &#34;10.88.0.0/16&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44>         }],
</span></span></span><span style=display:flex><span><span style=color:#b44>         [{
</span></span></span><span style=display:flex><span><span style=color:#b44>           &#34;subnet&#34;: &#34;2001:db8:4860::/64&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44>         }]
</span></span></span><span style=display:flex><span><span style=color:#b44>       ],
</span></span></span><span style=display:flex><span><span style=color:#b44>       &#34;routes&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#b44>         { &#34;dst&#34;: &#34;0.0.0.0/0&#34; },
</span></span></span><span style=display:flex><span><span style=color:#b44>         { &#34;dst&#34;: &#34;::/0&#34; }
</span></span></span><span style=display:flex><span><span style=color:#b44>       ]
</span></span></span><span style=display:flex><span><span style=color:#b44>     }
</span></span></span><span style=display:flex><span><span style=color:#b44>   },
</span></span></span><span style=display:flex><span><span style=color:#b44>   {
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;type&#34;: &#34;portmap&#34;,
</span></span></span><span style=display:flex><span><span style=color:#b44>     &#34;capabilities&#34;: {&#34;portMappings&#34;: true}
</span></span></span><span style=display:flex><span><span style=color:#b44>   }
</span></span></span><span style=display:flex><span><span style=color:#b44> ]
</span></span></span><span style=display:flex><span><span style=color:#b44>}
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div><p>Update the IP address ranges in the preceding example with ones that are based
on your use case and network addressing plan.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cbd252cc297e67c1b73a84d5882474fb>5 - Check whether dockershim removal affects you</h1><p>The <code>dockershim</code> component of Kubernetes allows to use Docker as a Kubernetes's
<a class=glossary-tooltip title='The container runtime is the software that is responsible for running containers.' data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label='container runtime'>container runtime</a>.
Kubernetes' built-in <code>dockershim</code> component was removed in release v1.24.</p><p>This page explains how your cluster could be using Docker as a container runtime,
provides details on the role that <code>dockershim</code> plays when in use, and shows steps
you can take to check whether any workloads could be affected by <code>dockershim</code> removal.</p><h2 id=find-docker-dependencies>Finding if your app has a dependencies on Docker</h2><p>If you are using Docker for building your application containers, you can still
run these containers on any container runtime. This use of Docker does not count
as a dependency on Docker as a container runtime.</p><p>When alternative container runtime is used, executing Docker commands may either
not work or yield unexpected output. This is how you can find whether you have a
dependency on Docker:</p><ol><li>Make sure no privileged Pods execute Docker commands (like <code>docker ps</code>),
restart the Docker service (commands such as <code>systemctl restart docker.service</code>),
or modify Docker-specific files such as <code>/etc/docker/daemon.json</code>.</li><li>Check for any private registries or image mirror settings in the Docker
configuration file (like <code>/etc/docker/daemon.json</code>). Those typically need to
be reconfigured for another container runtime.</li><li>Check that scripts and apps running on nodes outside of your Kubernetes
infrastructure do not execute Docker commands. It might be:<ul><li>SSH to nodes to troubleshoot;</li><li>Node startup scripts;</li><li>Monitoring and security agents installed on nodes directly.</li></ul></li><li>Third-party tools that perform above mentioned privileged operations. See
<a href=/docs/tasks/administer-cluster/migrating-from-dockershim/migrating-telemetry-and-security-agents>Migrating telemetry and security agents from dockershim</a>
for more information.</li><li>Make sure there is no indirect dependencies on dockershim behavior.
This is an edge case and unlikely to affect your application. Some tooling may be configured
to react to Docker-specific behaviors, for example, raise alert on specific metrics or search for
a specific log message as part of troubleshooting instructions.
If you have such tooling configured, test the behavior on test
cluster before migration.</li></ol><h2 id=role-of-dockershim>Dependency on Docker explained</h2><p>A <a href=/docs/concepts/containers/#container-runtimes>container runtime</a> is software that can
execute the containers that make up a Kubernetes pod. Kubernetes is responsible for orchestration
and scheduling of Pods; on each node, the <a class=glossary-tooltip title='An agent that runs on each node in the cluster. It makes sure that containers are running in a pod.' data-toggle=tooltip data-placement=top href=/docs/reference/generated/kubelet target=_blank aria-label=kubelet>kubelet</a>
uses the container runtime interface as an abstraction so that you can use any compatible
container runtime.</p><p>In its earliest releases, Kubernetes offered compatibility with one container runtime: Docker.
Later in the Kubernetes project's history, cluster operators wanted to adopt additional container runtimes.
The CRI was designed to allow this kind of flexibility - and the kubelet began supporting CRI. However,
because Docker existed before the CRI specification was invented, the Kubernetes project created an
adapter component, <code>dockershim</code>. The dockershim adapter allows the kubelet to interact with Docker as
if Docker were a CRI compatible runtime.</p><p>You can read about it in <a href=/blog/2018/05/24/kubernetes-containerd-integration-goes-ga/>Kubernetes Containerd integration goes GA</a> blog post.</p><p><img src=/images/blog/2018-05-24-kubernetes-containerd-integration-goes-ga/cri-containerd.png alt="Dockershim vs. CRI with Containerd"></p><p>Switching to Containerd as a container runtime eliminates the middleman. All the
same containers can be run by container runtimes like Containerd as before. But
now, since containers schedule directly with the container runtime, they are not visible to Docker.
So any Docker tooling or fancy UI you might have used
before to check on these containers is no longer available.</p><p>You cannot get container information using <code>docker ps</code> or <code>docker inspect</code>
commands. As you cannot list containers, you cannot get logs, stop containers,
or execute something inside container using <code>docker exec</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you're running workloads via Kubernetes, the best way to stop a container is through
the Kubernetes API rather than directly through the container runtime (this advice applies
for all container runtimes, not only Docker).</div><p>You can still pull images or build them using <code>docker build</code> command. But images
built or pulled by Docker would not be visible to container runtime and
Kubernetes. They needed to be pushed to some registry to allow them to be used
by Kubernetes.</p><h2 id=what-s-next>What's next</h2><ul><li>Read <a href=/docs/tasks/administer-cluster/migrating-from-dockershim/>Migrating from dockershim</a> to understand your next steps</li><li>Read the <a href=/blog/2020/12/02/dockershim-faq/>dockershim deprecation FAQ</a> article for more information.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-eb3e279a6c5e1224e744080a52ee3f28>6 - Migrating telemetry and security agents from dockershim</h1><div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div><p>Kubernetes' support for direct integration with Docker Engine is deprecated and
has been removed. Most apps do not have a direct dependency on runtime hosting
containers. However, there are still a lot of telemetry and monitoring agents
that have a dependency on Docker to collect containers metadata, logs, and
metrics. This document aggregates information on how to detect these
dependencies as well as links on how to migrate these agents to use generic tools or
alternative runtimes.</p><h2 id=telemetry-and-security-agents>Telemetry and security agents</h2><p>Within a Kubernetes cluster there are a few different ways to run telemetry or
security agents. Some agents have a direct dependency on Docker Engine when
they run as DaemonSets or directly on nodes.</p><h3 id=why-do-some-telemetry-agents-communicate-with-docker-engine>Why do some telemetry agents communicate with Docker Engine?</h3><p>Historically, Kubernetes was written to work specifically with Docker Engine.
Kubernetes took care of networking and scheduling, relying on Docker Engine for
launching and running containers (within Pods) on a node. Some information that
is relevant to telemetry, such as a pod name, is only available from Kubernetes
components. Other data, such as container metrics, is not the responsibility of
the container runtime. Early telemetry agents needed to query the container
runtime <em>and</em> Kubernetes to report an accurate picture. Over time, Kubernetes
gained the ability to support multiple runtimes, and now supports any runtime
that is compatible with the <a href=/docs/concepts/architecture/cri/>container runtime interface</a>.</p><p>Some telemetry agents rely specifically on Docker Engine tooling. For example, an agent
might run a command such as
<a href=https://docs.docker.com/engine/reference/commandline/ps/><code>docker ps</code></a>
or <a href=https://docs.docker.com/engine/reference/commandline/top/><code>docker top</code></a> to list
containers and processes or <a href=https://docs.docker.com/engine/reference/commandline/logs/><code>docker logs</code></a>
to receive streamed logs. If nodes in your existing cluster use
Docker Engine, and you switch to a different container runtime,
these commands will not work any longer.</p><h3 id=identify-docker-dependency>Identify DaemonSets that depend on Docker Engine</h3><p>If a pod wants to make calls to the <code>dockerd</code> running on the node, the pod must either:</p><ul><li>mount the filesystem containing the Docker daemon's privileged socket, as a
<a class=glossary-tooltip title='A directory containing data, accessible to the containers in a pod.' data-toggle=tooltip data-placement=top href=/docs/concepts/storage/volumes/ target=_blank aria-label=volume>volume</a>; or</li><li>mount the specific path of the Docker daemon's privileged socket directly, also as a volume.</li></ul><p>For example: on COS images, Docker exposes its Unix domain socket at
<code>/var/run/docker.sock</code> This means that the pod spec will include a
<code>hostPath</code> volume mount of <code>/var/run/docker.sock</code>.</p><p>Here's a sample shell script to find Pods that have a mount directly mapping the
Docker socket. This script outputs the namespace and name of the pod. You can
remove the <code>grep '/var/run/docker.sock'</code> to review other mounts.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods --all-namespaces <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>-o<span style=color:#666>=</span><span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{range .items[*]}{&#34;\n&#34;}{.metadata.namespace}{&#34;:\t&#34;}{.metadata.name}{&#34;:\t&#34;}{range .spec.volumes[*]}{.hostPath.path}{&#34;, &#34;}{end}{end}&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>| sort <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>| grep <span style=color:#b44>&#39;/var/run/docker.sock&#39;</span>
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>Note:</strong> There are alternative ways for a pod to access Docker on the host. For instance, the parent
directory <code>/var/run</code> may be mounted instead of the full path (like in <a href=https://gist.github.com/itaysk/7bc3e56d69c4d72a549286d98fd557dd>this
example</a>).
The script above only detects the most common uses.</div><h3 id=detecting-docker-dependency-from-node-agents>Detecting Docker dependency from node agents</h3><p>If your cluster nodes are customized and install additional security and
telemetry agents on the node, check with the agent vendor
to verify whether it has any dependency on Docker.</p><h3 id=telemetry-and-security-agent-vendors>Telemetry and security agent vendors</h3><p>This section is intended to aggregate information about various telemetry and
security agents that may have a dependency on container runtimes.</p><p>We keep the work in progress version of migration instructions for various telemetry and security agent vendors
in <a href=https://docs.google.com/document/d/1ZFi4uKit63ga5sxEiZblfb-c23lFhvy6RXVPikS8wf0/edit#>Google doc</a>.
Please contact the vendor to get up to date instructions for migrating from dockershim.</p><h2 id=migration-from-dockershim>Migration from dockershim</h2><h3 id=aqua-https-www-aquasec-com><a href=https://www.aquasec.com>Aqua</a></h3><p>No changes are needed: everything should work seamlessly on the runtime switch.</p><h3 id=datadog-https-www-datadoghq-com-product><a href=https://www.datadoghq.com/product/>Datadog</a></h3><p>How to migrate:
<a href=https://docs.datadoghq.com/agent/guide/docker-deprecation/>Docker deprecation in Kubernetes</a>
The pod that accesses Docker Engine may have a name containing any of:</p><ul><li><code>datadog-agent</code></li><li><code>datadog</code></li><li><code>dd-agent</code></li></ul><h3 id=dynatrace-https-www-dynatrace-com><a href=https://www.dynatrace.com/>Dynatrace</a></h3><p>How to migrate:
<a href=https://community.dynatrace.com/t5/Best-practices/Migrating-from-Docker-only-to-generic-container-metrics-in/m-p/167030#M49>Migrating from Docker-only to generic container metrics in Dynatrace</a></p><p>Containerd support announcement: <a href=https://www.dynatrace.com/news/blog/get-automated-full-stack-visibility-into-containerd-based-kubernetes-environments/>Get automated full-stack visibility into
containerd-based Kubernetes
environments</a></p><p>CRI-O support announcement: <a href=https://www.dynatrace.com/news/blog/get-automated-full-stack-visibility-into-your-cri-o-kubernetes-containers-beta/>Get automated full-stack visibility into your CRI-O Kubernetes containers (Beta)</a></p><p>The pod accessing Docker may have name containing:</p><ul><li><code>dynatrace-oneagent</code></li></ul><h3 id=falco-https-falco-org><a href=https://falco.org>Falco</a></h3><p>How to migrate:</p><p><a href=https://falco.org/docs/getting-started/deployment/#docker-deprecation-in-kubernetes>Migrate Falco from dockershim</a>
Falco supports any CRI-compatible runtime (containerd is used in the default configuration); the documentation explains all details.
The pod accessing Docker may have name containing:</p><ul><li><code>falco</code></li></ul><h3 id=prisma-cloud-compute-https-docs-paloaltonetworks-com-prisma-prisma-cloud-html><a href=https://docs.paloaltonetworks.com/prisma/prisma-cloud.html>Prisma Cloud Compute</a></h3><p>Check <a href=https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin-compute/install/install_kubernetes.html>documentation for Prisma Cloud</a>,
under the "Install Prisma Cloud on a CRI (non-Docker) cluster" section.
The pod accessing Docker may be named like:</p><ul><li><code>twistlock-defender-ds</code></li></ul><h3 id=signalfx-splunk-https-www-splunk-com-en-us-investor-relations-acquisitions-signalfx-html><a href=https://www.splunk.com/en_us/investor-relations/acquisitions/signalfx.html>SignalFx (Splunk)</a></h3><p>The SignalFx Smart Agent (deprecated) uses several different monitors for Kubernetes including
<code>kubernetes-cluster</code>, <code>kubelet-stats/kubelet-metrics</code>, and <code>docker-container-stats</code>.
The <code>kubelet-stats</code> monitor was previously deprecated by the vendor, in favor of <code>kubelet-metrics</code>.
The <code>docker-container-stats</code> monitor is the one affected by dockershim removal.
Do not use the <code>docker-container-stats</code> with container runtimes other than Docker Engine.</p><p>How to migrate from dockershim-dependent agent:</p><ol><li>Remove <code>docker-container-stats</code> from the list of <a href=https://github.com/signalfx/signalfx-agent/blob/main/docs/monitor-config.md>configured monitors</a>.
Note, keeping this monitor enabled with non-dockershim runtime will result in incorrect metrics
being reported when docker is installed on node and no metrics when docker is not installed.</li><li><a href=https://github.com/signalfx/signalfx-agent/blob/main/docs/monitors/kubelet-metrics.md>Enable and configure <code>kubelet-metrics</code></a> monitor.</li></ol><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The set of collected metrics will change. Review your alerting rules and dashboards.</div><p>The Pod accessing Docker may be named something like:</p><ul><li><code>signalfx-agent</code></li></ul><h3 id=yahoo-kubectl-flame>Yahoo Kubectl Flame</h3><p>Flame does not support container runtimes other than Docker. See
<a href=https://github.com/yahoo/kubectl-flame/issues/51>https://github.com/yahoo/kubectl-flame/issues/51</a></p></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/docs/home/>Home</a>
<a class=text-white href=/blog/>Blog</a>
<a class=text-white href=/training/>Training</a>
<a class=text-white href=/partners/>Partners</a>
<a class=text-white href=/community/>Community</a>
<a class=text-white href=/case-studies/>Case Studies</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a></small><br><small class=text-white>Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>