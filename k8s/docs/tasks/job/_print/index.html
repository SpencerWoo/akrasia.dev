<!doctype html><html lang=en class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=zh-cn href=https://kubernetes.io/zh-cn/docs/tasks/job/><link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/tasks/job/><link rel=alternate hreflang=ja href=https://kubernetes.io/ja/docs/tasks/job/><link rel=alternate hreflang=fr href=https://kubernetes.io/fr/docs/tasks/job/><link rel=alternate hreflang=de href=https://kubernetes.io/de/docs/tasks/job/><link rel=alternate hreflang=es href=https://kubernetes.io/es/docs/tasks/job/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://kubernetes.io/docs/tasks/job/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>Run Jobs | Kubernetes</title><meta property="og:title" content="Run Jobs"><meta property="og:description" content="Run Jobs using parallel processing."><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/docs/tasks/job/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="Run Jobs"><meta itemprop=description content="Run Jobs using parallel processing."><meta name=twitter:card content="summary"><meta name=twitter:title content="Run Jobs"><meta name=twitter:description content="Run Jobs using parallel processing."><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content="Run Jobs using parallel processing."><meta property="og:description" content="Run Jobs using parallel processing."><meta name=twitter:description content="Run Jobs using parallel processing."><meta property="og:url" content="https://kubernetes.io/docs/tasks/job/"><meta property="og:title" content="Run Jobs"><meta name=twitter:title content="Run Jobs"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/docs/>Documentation</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/blog/>Kubernetes Blog</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/training/>Training</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/partners/>Partners</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/community/>Community</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/case-studies/>Case Studies</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/docs/tasks/job/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/docs/tasks/job/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/docs/tasks/job/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/docs/tasks/job/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/docs/tasks/job/>v1.21</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/docs/tasks/job/>中文 (Chinese)</a>
<a class=dropdown-item href=/ko/docs/tasks/job/>한국어 (Korean)</a>
<a class=dropdown-item href=/ja/docs/tasks/job/>日本語 (Japanese)</a>
<a class=dropdown-item href=/fr/docs/tasks/job/>Français (French)</a>
<a class=dropdown-item href=/de/docs/tasks/job/>Deutsch (German)</a>
<a class=dropdown-item href=/es/docs/tasks/job/>Español (Spanish)</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/tasks/job/>Return to the regular view of this page</a>.</p></div><h1 class=title>Run Jobs</h1><div class=lead>Run Jobs using parallel processing.</div><ul><li>1: <a href=#pg-964bdff888520740e5e221695245678d>Running Automated Tasks with a CronJob</a></li><li>2: <a href=#pg-1058efa4d70f13c015e6a2094ff85068>Coarse Parallel Processing Using a Work Queue</a></li><li>3: <a href=#pg-457c9dd93aed2b05615ed28dc38075d3>Fine Parallel Processing Using a Work Queue</a></li><li>4: <a href=#pg-9e63850014876afaebd1561f70bb8f6b>Indexed Job for Parallel Processing with Static Work Assignment</a></li><li>5: <a href=#pg-d65c40e1d2df81b94a09634c2432b055>Job with Pod-to-Pod Communication</a></li><li>6: <a href=#pg-da7c2b067953d239eb4457e8978ad8f6>Parallel Processing using Expansions</a></li><li>7: <a href=#pg-ecb5ec00bbce2e57292c6687437beae0>Handling retriable and non-retriable pod failures with Pod failure policy</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-964bdff888520740e5e221695245678d>1 - Running Automated Tasks with a CronJob</h1><p>You can use a <a class=glossary-tooltip title='A repeating task (a Job) that runs on a regular schedule.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/cron-jobs/ target=_blank aria-label=CronJob>CronJob</a> to run <a class=glossary-tooltip title='A finite or batch task that runs to completion.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/job/ target=_blank aria-label=Jobs>Jobs</a>
on a time-based schedule.
These automated jobs run like <a href=https://en.wikipedia.org/wiki/Cron>Cron</a> tasks on a Linux or UNIX system.</p><p>Cron jobs are useful for creating periodic and recurring tasks, like running backups or sending emails.
Cron jobs can also schedule individual tasks for a specific time, such as if you want to schedule a job for a low activity period.</p><p>Cron jobs have limitations and idiosyncrasies.
For example, in certain circumstances, a single cron job can create multiple jobs.
Therefore, jobs should be idempotent.</p><p>For more limitations, see <a href=/docs/concepts/workloads/controllers/cron-jobs>CronJobs</a>.</p><h2 id=before-you-begin>Before you begin</h2><ul><li><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul></li></ul><h2 id=creating-a-cron-job>Creating a CronJob</h2><p>Cron jobs require a config file.
Here is a manifest for a CronJob that runs a simple demonstration task every minute:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/cronjob.yaml download=application/job/cronjob.yaml><code>application/job/cronjob.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-cronjob-yaml")' title="Copy application/job/cronjob.yaml to clipboard"></img></div><div class=includecode id=application-job-cronjob-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronJob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>schedule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * *&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>jobTemplate</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>imagePullPolicy</span>:<span style=color:#bbb> </span>IfNotPresent<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- /bin/sh<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>- date; echo Hello from the Kubernetes cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Run the example CronJob by using this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://k8s.io/examples/application/job/cronjob.yaml
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>cronjob.batch/hello created
</code></pre><p>After creating the cron job, get its status using this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get cronjob hello
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
hello   */1 * * * *   False     0        &lt;none&gt;          10s
</code></pre><p>As you can see from the results of the command, the cron job has not scheduled or run any jobs yet.
Watch for the job to be created in around one minute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get <span style=color:#a2f>jobs</span> --watch
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME               COMPLETIONS   DURATION   AGE
hello-4111706356   0/1                      0s
hello-4111706356   0/1           0s         0s
hello-4111706356   1/1           5s         5s
</code></pre><p>Now you've seen one running job scheduled by the "hello" cron job.
You can stop watching the job and view the cron job again to see that it scheduled the job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get cronjob hello
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
hello   */1 * * * *   False     0        50s             75s
</code></pre><p>You should see that the cron job <code>hello</code> successfully scheduled a job at the time specified in
<code>LAST SCHEDULE</code>. There are currently 0 active jobs, meaning that the job has completed or failed.</p><p>Now, find the pods that the last scheduled job created and view the standard output of one of the pods.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The job name is different from the pod name.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Replace &#34;hello-4111706356&#34; with the job name in your system</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>pods</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get pods --selector<span style=color:#666>=</span>job-name<span style=color:#666>=</span>hello-4111706356 --output<span style=color:#666>=</span><span style=color:#b8860b>jsonpath</span><span style=color:#666>={</span>.items<span style=color:#666>[</span>*<span style=color:#666>]</span>.metadata.name<span style=color:#666>}</span><span style=color:#a2f;font-weight:700>)</span>
</span></span></code></pre></div><p>Show the pod log:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs <span style=color:#b8860b>$pods</span>
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>Fri Feb 22 11:02:09 UTC 2019
Hello from the Kubernetes cluster
</code></pre><h2 id=deleting-a-cron-job>Deleting a CronJob</h2><p>When you don't need a cron job any more, delete it with <code>kubectl delete cronjob &lt;cronjob name></code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete cronjob hello
</span></span></code></pre></div><p>Deleting the cron job removes all the jobs and pods it created and stops it from creating additional jobs.
You can read more about removing jobs in <a href=/docs/concepts/architecture/garbage-collection/>garbage collection</a>.</p><h2 id=writing-a-cron-job-spec>Writing a CronJob Spec</h2><p>As with all other Kubernetes objects, a CronJob must have <code>apiVersion</code>, <code>kind</code>, and <code>metadata</code> fields.
For more information about working with Kubernetes objects and their
<a class=glossary-tooltip title='A serialized specification of one or more Kubernetes API objects.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-manifest' target=_blank aria-label=manifests>manifests</a>, see the
<a href=/docs/concepts/cluster-administration/manage-deployment/>managing resources</a>,
and <a href=/docs/concepts/overview/working-with-objects/object-management/>using kubectl to manage resources</a> documents.</p><p>Each manifest for a CronJob also needs a <a href=/docs/concepts/overview/working-with-objects/kubernetes-objects/#object-spec-and-status><code>.spec</code></a> section.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you modify a CronJob, the changes you make will apply to new jobs that start to run after your modification
is complete. Jobs (and their Pods) that have already started continue to run without changes.
That is, the CronJob does <em>not</em> update existing jobs, even if those remain running.</div><h3 id=schedule>Schedule</h3><p>The <code>.spec.schedule</code> is a required field of the <code>.spec</code>.
It takes a <a href=https://en.wikipedia.org/wiki/Cron>Cron</a> format string, such as <code>0 * * * *</code> or <code>@hourly</code>,
as schedule time of its jobs to be created and executed.</p><p>The format also includes extended "Vixie cron" step values. As explained in the
<a href=https://www.freebsd.org/cgi/man.cgi?crontab%285%29>FreeBSD manual</a>:</p><blockquote><p>Step values can be used in conjunction with ranges. Following a range
with <code>/&lt;number></code> specifies skips of the number's value through the
range. For example, <code>0-23/2</code> can be used in the hours field to specify
command execution every other hour (the alternative in the V7 standard is
<code>0,2,4,6,8,10,12,14,16,18,20,22</code>). Steps are also permitted after an
asterisk, so if you want to say "every two hours", just use <code>*/2</code>.</p></blockquote><div class="alert alert-info note callout" role=alert><strong>Note:</strong> A question mark (<code>?</code>) in the schedule has the same meaning as an asterisk <code>*</code>, that is,
it stands for any of available value for a given field.</div><h3 id=job-template>Job Template</h3><p>The <code>.spec.jobTemplate</code> is the template for the job, and it is required.
It has exactly the same schema as a <a href=/docs/concepts/workloads/controllers/job/>Job</a>, except that
it is nested and does not have an <code>apiVersion</code> or <code>kind</code>.
For information about writing a job <code>.spec</code>, see <a href=/docs/concepts/workloads/controllers/job/#writing-a-job-spec>Writing a Job Spec</a>.</p><h3 id=starting-deadline>Starting Deadline</h3><p>The <code>.spec.startingDeadlineSeconds</code> field is optional.
It stands for the deadline in seconds for starting the job if it misses its scheduled time for any reason.
After the deadline, the cron job does not start the job.
Jobs that do not meet their deadline in this way count as failed jobs.
If this field is not specified, the jobs have no deadline.</p><p>If the <code>.spec.startingDeadlineSeconds</code> field is set (not null), the CronJob
controller measures the time between when a job is expected to be created and
now. If the difference is higher than that limit, it will skip this execution.</p><p>For example, if it is set to <code>200</code>, it allows a job to be created for up to 200
seconds after the actual schedule.</p><h3 id=concurrency-policy>Concurrency Policy</h3><p>The <code>.spec.concurrencyPolicy</code> field is also optional.
It specifies how to treat concurrent executions of a job that is created by this cron job.
The spec may specify only one of the following concurrency policies:</p><ul><li><code>Allow</code> (default): The cron job allows concurrently running jobs</li><li><code>Forbid</code>: The cron job does not allow concurrent runs; if it is time for a new job run and the
previous job run hasn't finished yet, the cron job skips the new job run</li><li><code>Replace</code>: If it is time for a new job run and the previous job run hasn't finished yet, the
cron job replaces the currently running job run with a new job run</li></ul><p>Note that concurrency policy only applies to the jobs created by the same cron job.
If there are multiple cron jobs, their respective jobs are always allowed to run concurrently.</p><h3 id=suspend>Suspend</h3><p>The <code>.spec.suspend</code> field is also optional.
If it is set to <code>true</code>, all subsequent executions are suspended.
This setting does not apply to already started executions.
Defaults to false.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Executions that are suspended during their scheduled time count as missed jobs.
When <code>.spec.suspend</code> changes from <code>true</code> to <code>false</code> on an existing cron job without a
<a href=#starting-deadline>starting deadline</a>, the missed jobs are scheduled immediately.</div><h3 id=jobs-history-limits>Jobs History Limits</h3><p>The <code>.spec.successfulJobsHistoryLimit</code> and <code>.spec.failedJobsHistoryLimit</code> fields are optional.
These fields specify how many completed and failed jobs should be kept.
By default, they are set to 3 and 1 respectively. Setting a limit to <code>0</code> corresponds to keeping
none of the corresponding kind of jobs after they finish.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1058efa4d70f13c015e6a2094ff85068>2 - Coarse Parallel Processing Using a Work Queue</h1><p>In this example, we will run a Kubernetes Job with multiple parallel
worker processes.</p><p>In this example, as each pod is created, it picks up one unit of work
from a task queue, completes it, deletes it from the queue, and exits.</p><p>Here is an overview of the steps in this example:</p><ol><li><strong>Start a message queue service.</strong> In this example, we use RabbitMQ, but you could use another
one. In practice you would set up a message queue service once and reuse it for many jobs.</li><li><strong>Create a queue, and fill it with messages.</strong> Each message represents one task to be done. In
this example, a message is an integer that we will do a lengthy computation on.</li><li><strong>Start a Job that works on tasks from the queue</strong>. The Job starts several pods. Each pod takes
one task from the message queue, processes it, and repeats until the end of the queue is reached.</li></ol><h2 id=before-you-begin>Before you begin</h2><p>Be familiar with the basic,
non-parallel, use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=starting-a-message-queue-service>Starting a message queue service</h2><p>This example uses RabbitMQ, however, you can adapt the example to use another AMQP-type message service.</p><p>In practice you could set up a message queue service once in a
cluster and reuse it for many jobs, as well as for long-running services.</p><p>Start RabbitMQ as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://raw.githubusercontent.com/kubernetes/kubernetes/release-1.3/examples/celery-rabbitmq/rabbitmq-service.yaml
</span></span></code></pre></div><pre tabindex=0><code>service &#34;rabbitmq-service&#34; created
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f https://raw.githubusercontent.com/kubernetes/kubernetes/release-1.3/examples/celery-rabbitmq/rabbitmq-controller.yaml
</span></span></code></pre></div><pre tabindex=0><code>replicationcontroller &#34;rabbitmq-controller&#34; created
</code></pre><p>We will only use the rabbitmq part from the <a href=https://github.com/kubernetes/kubernetes/tree/release-1.3/examples/celery-rabbitmq>celery-rabbitmq example</a>.</p><h2 id=testing-the-message-queue-service>Testing the message queue service</h2><p>Now, we can experiment with accessing the message queue. We will
create a temporary interactive pod, install some tools on it,
and experiment with queues.</p><p>First create a temporary interactive Pod.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Create a temporary interactive container</span>
</span></span><span style=display:flex><span>kubectl run -i --tty temp --image ubuntu:18.04
</span></span></code></pre></div><pre tabindex=0><code>Waiting for pod default/temp-loe07 to be running, status is Pending, pod ready: false
... [ previous line repeats several times .. hit return when it stops ] ...
</code></pre><p>Note that your pod name and command prompt will be different.</p><p>Next install the <code>amqp-tools</code> so we can work with message queues.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Install some tools</span>
</span></span><span style=display:flex><span>root@temp-loe07:/# apt-get update
</span></span><span style=display:flex><span>.... <span style=color:#666>[</span> lots of output <span style=color:#666>]</span> ....
</span></span><span style=display:flex><span>root@temp-loe07:/# apt-get install -y curl ca-certificates amqp-tools python dnsutils
</span></span><span style=display:flex><span>.... <span style=color:#666>[</span> lots of output <span style=color:#666>]</span> ....
</span></span></code></pre></div><p>Later, we will make a docker image that includes these packages.</p><p>Next, we will check that we can discover the rabbitmq service:</p><pre tabindex=0><code># Note the rabbitmq-service has a DNS name, provided by Kubernetes:

root@temp-loe07:/# nslookup rabbitmq-service
Server:        10.0.0.10
Address:    10.0.0.10#53

Name:    rabbitmq-service.default.svc.cluster.local
Address: 10.0.147.152

# Your address will vary.
</code></pre><p>If Kube-DNS is not set up correctly, the previous step may not work for you.
You can also find the service IP in an env var:</p><pre tabindex=0><code># env | grep RABBIT | grep HOST
RABBITMQ_SERVICE_SERVICE_HOST=10.0.147.152
# Your address will vary.
</code></pre><p>Next we will verify we can create a queue, and publish and consume messages.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># In the next line, rabbitmq-service is the hostname where the rabbitmq-service</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># can be reached.  5672 is the standard port for rabbitmq.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@temp-loe07:/# <span style=color:#a2f>export</span> <span style=color:#b8860b>BROKER_URL</span><span style=color:#666>=</span>amqp://guest:guest@rabbitmq-service:5672
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># If you could not resolve &#34;rabbitmq-service&#34; in the previous step,</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># then use this command instead:</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># root@temp-loe07:/# BROKER_URL=amqp://guest:guest@$RABBITMQ_SERVICE_SERVICE_HOST:5672</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Now create a queue:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@temp-loe07:/# /usr/bin/amqp-declare-queue --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -q foo -d
</span></span><span style=display:flex><span>foo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Publish one message to it:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@temp-loe07:/# /usr/bin/amqp-publish --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -r foo -p -b Hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># And get it back.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@temp-loe07:/# /usr/bin/amqp-consume --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -q foo -c <span style=color:#666>1</span> cat <span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span>
</span></span><span style=display:flex><span>Hello
</span></span><span style=display:flex><span>root@temp-loe07:/#
</span></span></code></pre></div><p>In the last command, the <code>amqp-consume</code> tool takes one message (<code>-c 1</code>)
from the queue, and passes that message to the standard input of an arbitrary command. In this case, the program <code>cat</code> prints out the characters read from standard input, and the echo adds a carriage
return so the example is readable.</p><h2 id=filling-the-queue-with-tasks>Filling the Queue with tasks</h2><p>Now let's fill the queue with some "tasks". In our example, our tasks are strings to be
printed.</p><p>In a practice, the content of the messages might be:</p><ul><li>names of files to that need to be processed</li><li>extra flags to the program</li><li>ranges of keys in a database table</li><li>configuration parameters to a simulation</li><li>frame numbers of a scene to be rendered</li></ul><p>In practice, if there is large data that is needed in a read-only mode by all pods
of the Job, you will typically put that in a shared file system like NFS and mount
that readonly on all the pods, or the program in the pod will natively read data from
a cluster file system like HDFS.</p><p>For our example, we will create the queue and fill it using the amqp command line tools.
In practice, you might write a program to fill the queue using an amqp client library.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/usr/bin/amqp-declare-queue --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -q job1  -d
</span></span><span style=display:flex><span>job1
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> f in apple banana cherry date fig grape lemon melon
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>  /usr/bin/amqp-publish --url<span style=color:#666>=</span><span style=color:#b8860b>$BROKER_URL</span> -r job1 -p -b <span style=color:#b8860b>$f</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>So, we filled the queue with 8 messages.</p><h2 id=create-an-image>Create an Image</h2><p>Now we are ready to create an image that we will run as a job.</p><p>We will use the <code>amqp-consume</code> utility to read the message
from the queue and run our actual program. Here is a very simple
example program:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/rabbitmq/worker.py download=application/job/rabbitmq/worker.py><code>application/job/rabbitmq/worker.py</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-rabbitmq-worker-py")' title="Copy application/job/rabbitmq/worker.py to clipboard"></img></div><div class=includecode id=application-job-rabbitmq-worker-py><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#080;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Just prints standard out and sleeps for 10 seconds.</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>sys</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>time</span>
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Processing &#34;</span> <span style=color:#666>+</span> sys<span style=color:#666>.</span>stdin<span style=color:#666>.</span>readlines()[<span style=color:#666>0</span>])
</span></span><span style=display:flex><span>time<span style=color:#666>.</span>sleep(<span style=color:#666>10</span>)
</span></span></code></pre></div></div></div><p>Give the script execution permission:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chmod +x worker.py
</span></span></code></pre></div><p>Now, build an image. If you are working in the source
tree, then change directory to <code>examples/job/work-queue-1</code>.
Otherwise, make a temporary directory, change to it,
download the <a href=/examples/application/job/rabbitmq/Dockerfile>Dockerfile</a>,
and <a href=/examples/application/job/rabbitmq/worker.py>worker.py</a>. In either case,
build the image with this command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build -t job-wq-1 .
</span></span></code></pre></div><p>For the <a href=https://hub.docker.com/>Docker Hub</a>, tag your app image with
your username and push to the Hub with the below commands. Replace
<code>&lt;username></code> with your Hub username.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag job-wq-1 &lt;username&gt;/job-wq-1
</span></span><span style=display:flex><span>docker push &lt;username&gt;/job-wq-1
</span></span></code></pre></div><p>If you are using <a href=https://cloud.google.com/tools/container-registry/>Google Container
Registry</a>, tag
your app image with your project ID, and push to GCR. Replace
<code>&lt;project></code> with your project ID.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag job-wq-1 gcr.io/&lt;project&gt;/job-wq-1
</span></span><span style=display:flex><span>gcloud docker -- push gcr.io/&lt;project&gt;/job-wq-1
</span></span></code></pre></div><h2 id=defining-a-job>Defining a Job</h2><p>Here is a job definition. You'll need to make a copy of the Job and edit the
image to match the name you used, and call it <code>./job.yaml</code>.</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/rabbitmq/job.yaml download=application/job/rabbitmq/job.yaml><code>application/job/rabbitmq/job.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-rabbitmq-job-yaml")' title="Copy application/job/rabbitmq/job.yaml to clipboard"></img></div><div class=includecode id=application-job-rabbitmq-job-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-wq-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>8</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-wq-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/&lt;project&gt;/job-wq-1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>BROKER_URL<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>amqp://guest:guest@rabbitmq-service:5672<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>QUEUE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span>job1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In this example, each pod works on one item from the queue and then exits.
So, the completion count of the Job corresponds to the number of work items
done. So we set, <code>.spec.completions: 8</code> for the example, since we put 8 items in the queue.</p><h2 id=running-the-job>Running the Job</h2><p>So, now run the Job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f ./job.yaml
</span></span></code></pre></div><p>You can wait for the Job to succeed, with a timeout:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># The check for condition name is case insensitive</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a2f>wait</span> --for<span style=color:#666>=</span><span style=color:#b8860b>condition</span><span style=color:#666>=</span><span style=color:#a2f>complete</span> --timeout<span style=color:#666>=</span>300s job/job-wq-1
</span></span></code></pre></div><p>Next, check on the Job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe jobs/job-wq-1
</span></span></code></pre></div><pre tabindex=0><code>Name:             job-wq-1
Namespace:        default
Selector:         controller-uid=41d75705-92df-11e7-b85e-fa163ee3c11f
Labels:           controller-uid=41d75705-92df-11e7-b85e-fa163ee3c11f
                  job-name=job-wq-1
Annotations:      &lt;none&gt;
Parallelism:      2
Completions:      8
Start Time:       Wed, 06 Sep 2017 16:42:02 +0800
Pods Statuses:    0 Running / 8 Succeeded / 0 Failed
Pod Template:
  Labels:       controller-uid=41d75705-92df-11e7-b85e-fa163ee3c11f
                job-name=job-wq-1
  Containers:
   c:
    Image:      gcr.io/causal-jigsaw-637/job-wq-1
    Port:
    Environment:
      BROKER_URL:       amqp://guest:guest@rabbitmq-service:5672
      QUEUE:            job1
    Mounts:             &lt;none&gt;
  Volumes:              &lt;none&gt;
Events:
  FirstSeen  LastSeen   Count    From    SubobjectPath    Type      Reason              Message
  ─────────  ────────   ─────    ────    ─────────────    ──────    ──────              ───────
  27s        27s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-hcobb
  27s        27s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-weytj
  27s        27s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-qaam5
  27s        27s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-b67sr
  26s        26s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-xe5hj
  15s        15s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-w2zqe
  14s        14s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-d6ppa
  14s        14s        1        {job }                   Normal    SuccessfulCreate    Created pod: job-wq-1-p17e0
</code></pre><p>All the pods for that Job succeeded. Yay.</p><h2 id=alternatives>Alternatives</h2><p>This approach has the advantage that you
do not need to modify your "worker" program to be aware that there is a work queue.</p><p>It does require that you run a message queue service.
If running a queue service is inconvenient, you may
want to consider one of the other <a href=/docs/concepts/workloads/controllers/job/#job-patterns>job patterns</a>.</p><p>This approach creates a pod for every work item. If your work items only take a few seconds,
though, creating a Pod for every work item may add a lot of overhead. Consider another
<a href=/docs/tasks/job/fine-parallel-processing-work-queue/>example</a>, that executes multiple work items per Pod.</p><p>In this example, we use the <code>amqp-consume</code> utility to read the message
from the queue and run our actual program. This has the advantage that you
do not need to modify your program to be aware of the queue.
A <a href=/docs/tasks/job/fine-parallel-processing-work-queue/>different example</a>, shows how to
communicate with the work queue using a client library.</p><h2 id=caveats>Caveats</h2><p>If the number of completions is set to less than the number of items in the queue, then
not all items will be processed.</p><p>If the number of completions is set to more than the number of items in the queue,
then the Job will not appear to be completed, even though all items in the queue
have been processed. It will start additional pods which will block waiting
for a message.</p><p>There is an unlikely race with this pattern. If the container is killed in between the time
that the message is acknowledged by the amqp-consume command and the time that the container
exits with success, or if the node crashes before the kubelet is able to post the success of the pod
back to the api-server, then the Job will not appear to be complete, even though all items
in the queue have been processed.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-457c9dd93aed2b05615ed28dc38075d3>3 - Fine Parallel Processing Using a Work Queue</h1><p>In this example, we will run a Kubernetes Job with multiple parallel
worker processes in a given pod.</p><p>In this example, as each pod is created, it picks up one unit of work
from a task queue, processes it, and repeats until the end of the queue is reached.</p><p>Here is an overview of the steps in this example:</p><ol><li><strong>Start a storage service to hold the work queue.</strong> In this example, we use Redis to store
our work items. In the previous example, we used RabbitMQ. In this example, we use Redis and
a custom work-queue client library because AMQP does not provide a good way for clients to
detect when a finite-length work queue is empty. In practice you would set up a store such
as Redis once and reuse it for the work queues of many jobs, and other things.</li><li><strong>Create a queue, and fill it with messages.</strong> Each message represents one task to be done. In
this example, a message is an integer that we will do a lengthy computation on.</li><li><strong>Start a Job that works on tasks from the queue</strong>. The Job starts several pods. Each pod takes
one task from the message queue, processes it, and repeats until the end of the queue is reached.</li></ol><h2 id=before-you-begin>Before you begin</h2><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>Be familiar with the basic,
non-parallel, use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><h2 id=starting-redis>Starting Redis</h2><p>For this example, for simplicity, we will start a single instance of Redis.
See the <a href=https://github.com/kubernetes/examples/tree/master/guestbook>Redis Example</a> for an example
of deploying Redis scalably and redundantly.</p><p>You could also download the following files directly:</p><ul><li><a href=/examples/application/job/redis/redis-pod.yaml><code>redis-pod.yaml</code></a></li><li><a href=/examples/application/job/redis/redis-service.yaml><code>redis-service.yaml</code></a></li><li><a href=/examples/application/job/redis/Dockerfile><code>Dockerfile</code></a></li><li><a href=/examples/application/job/redis/job.yaml><code>job.yaml</code></a></li><li><a href=/examples/application/job/redis/rediswq.py><code>rediswq.py</code></a></li><li><a href=/examples/application/job/redis/worker.py><code>worker.py</code></a></li></ul><h2 id=filling-the-queue-with-tasks>Filling the Queue with tasks</h2><p>Now let's fill the queue with some "tasks". In our example, our tasks are strings to be
printed.</p><p>Start a temporary interactive pod for running the Redis CLI.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run -i --tty temp --image redis --command <span style=color:#b44>&#34;/bin/sh&#34;</span>
</span></span><span style=display:flex><span>Waiting <span style=color:#a2f;font-weight:700>for</span> pod default/redis2-c7h78 to be running, status is Pending, pod ready: <span style=color:#a2f>false</span>
</span></span><span style=display:flex><span>Hit enter <span style=color:#a2f;font-weight:700>for</span> <span style=color:#a2f>command</span> prompt
</span></span></code></pre></div><p>Now hit enter, start the redis CLI, and create a list with some work items in it.</p><pre tabindex=0><code># redis-cli -h redis
redis:6379&gt; rpush job2 &#34;apple&#34;
(integer) 1
redis:6379&gt; rpush job2 &#34;banana&#34;
(integer) 2
redis:6379&gt; rpush job2 &#34;cherry&#34;
(integer) 3
redis:6379&gt; rpush job2 &#34;date&#34;
(integer) 4
redis:6379&gt; rpush job2 &#34;fig&#34;
(integer) 5
redis:6379&gt; rpush job2 &#34;grape&#34;
(integer) 6
redis:6379&gt; rpush job2 &#34;lemon&#34;
(integer) 7
redis:6379&gt; rpush job2 &#34;melon&#34;
(integer) 8
redis:6379&gt; rpush job2 &#34;orange&#34;
(integer) 9
redis:6379&gt; lrange job2 0 -1
1) &#34;apple&#34;
2) &#34;banana&#34;
3) &#34;cherry&#34;
4) &#34;date&#34;
5) &#34;fig&#34;
6) &#34;grape&#34;
7) &#34;lemon&#34;
8) &#34;melon&#34;
9) &#34;orange&#34;
</code></pre><p>So, the list with key <code>job2</code> will be our work queue.</p><p>Note: if you do not have Kube DNS setup correctly, you may need to change
the first step of the above block to <code>redis-cli -h $REDIS_SERVICE_HOST</code>.</p><h2 id=create-an-image>Create an Image</h2><p>Now we are ready to create an image that we will run.</p><p>We will use a python worker program with a redis client to read
the messages from the message queue.</p><p>A simple Redis work queue client library is provided,
called rediswq.py (<a href=/examples/application/job/redis/rediswq.py>Download</a>).</p><p>The "worker" program in each Pod of the Job uses the work queue
client library to get work. Here it is:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/redis/worker.py download=application/job/redis/worker.py><code>application/job/redis/worker.py</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-redis-worker-py")' title="Copy application/job/redis/worker.py to clipboard"></img></div><div class=includecode id=application-job-redis-worker-py><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#080;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>time</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>import</span> <span style=color:#00f;font-weight:700>rediswq</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>host<span style=color:#666>=</span><span style=color:#b44>&#34;redis&#34;</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Uncomment next two lines if you do not have Kube-DNS working.</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># import os</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># host = os.getenv(&#34;REDIS_SERVICE_HOST&#34;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>q <span style=color:#666>=</span> rediswq<span style=color:#666>.</span>RedisWQ(name<span style=color:#666>=</span><span style=color:#b44>&#34;job2&#34;</span>, host<span style=color:#666>=</span>host)
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Worker with sessionID: &#34;</span> <span style=color:#666>+</span>  q<span style=color:#666>.</span>sessionID())
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Initial queue state: empty=&#34;</span> <span style=color:#666>+</span> <span style=color:#a2f>str</span>(q<span style=color:#666>.</span>empty()))
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>while</span> <span style=color:#a2f;font-weight:700>not</span> q<span style=color:#666>.</span>empty():
</span></span><span style=display:flex><span>  item <span style=color:#666>=</span> q<span style=color:#666>.</span>lease(lease_secs<span style=color:#666>=</span><span style=color:#666>10</span>, block<span style=color:#666>=</span><span style=color:#a2f;font-weight:700>True</span>, timeout<span style=color:#666>=</span><span style=color:#666>2</span>) 
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>if</span> item <span style=color:#a2f;font-weight:700>is</span> <span style=color:#a2f;font-weight:700>not</span> <span style=color:#a2f;font-weight:700>None</span>:
</span></span><span style=display:flex><span>    itemstr <span style=color:#666>=</span> item<span style=color:#666>.</span>decode(<span style=color:#b44>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Working on &#34;</span> <span style=color:#666>+</span> itemstr)
</span></span><span style=display:flex><span>    time<span style=color:#666>.</span>sleep(<span style=color:#666>10</span>) <span style=color:#080;font-style:italic># Put your actual work here instead of sleep.</span>
</span></span><span style=display:flex><span>    q<span style=color:#666>.</span>complete(item)
</span></span><span style=display:flex><span>  <span style=color:#a2f;font-weight:700>else</span>:
</span></span><span style=display:flex><span>    <span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Waiting for work&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a2f>print</span>(<span style=color:#b44>&#34;Queue empty, exiting&#34;</span>)
</span></span></code></pre></div></div></div><p>You could also download <a href=/examples/application/job/redis/worker.py><code>worker.py</code></a>,
<a href=/examples/application/job/redis/rediswq.py><code>rediswq.py</code></a>, and
<a href=/examples/application/job/redis/Dockerfile><code>Dockerfile</code></a> files, then build
the image:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build -t job-wq-2 .
</span></span></code></pre></div><h3 id=push-the-image>Push the image</h3><p>For the <a href=https://hub.docker.com/>Docker Hub</a>, tag your app image with
your username and push to the Hub with the below commands. Replace
<code>&lt;username></code> with your Hub username.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag job-wq-2 &lt;username&gt;/job-wq-2
</span></span><span style=display:flex><span>docker push &lt;username&gt;/job-wq-2
</span></span></code></pre></div><p>You need to push to a public repository or <a href=/docs/concepts/containers/images/>configure your cluster to be able to access
your private repository</a>.</p><p>If you are using <a href=https://cloud.google.com/tools/container-registry/>Google Container
Registry</a>, tag
your app image with your project ID, and push to GCR. Replace
<code>&lt;project></code> with your project ID.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker tag job-wq-2 gcr.io/&lt;project&gt;/job-wq-2
</span></span><span style=display:flex><span>gcloud docker -- push gcr.io/&lt;project&gt;/job-wq-2
</span></span></code></pre></div><h2 id=defining-a-job>Defining a Job</h2><p>Here is the job definition:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/redis/job.yaml download=application/job/redis/job.yaml><code>application/job/redis/job.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-redis-job-yaml")' title="Copy application/job/redis/job.yaml to clipboard"></img></div><div class=includecode id=application-job-redis-job-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-wq-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-wq-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/myproject/job-wq-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>OnFailure<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>Be sure to edit the job template to
change <code>gcr.io/myproject</code> to your own path.</p><p>In this example, each pod works on several items from the queue and then exits when there are no more items.
Since the workers themselves detect when the workqueue is empty, and the Job controller does not
know about the workqueue, it relies on the workers to signal when they are done working.
The workers signal that the queue is empty by exiting with success. So, as soon as any worker
exits with success, the controller knows the work is done, and the Pods will exit soon.
So, we set the completion count of the Job to 1. The job controller will wait for the other pods to complete
too.</p><h2 id=running-the-job>Running the Job</h2><p>So, now run the Job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f ./job.yaml
</span></span></code></pre></div><p>Now wait a bit, then check on the job.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe jobs/job-wq-2
</span></span><span style=display:flex><span>Name:             job-wq-2
</span></span><span style=display:flex><span>Namespace:        default
</span></span><span style=display:flex><span>Selector:         controller-uid<span style=color:#666>=</span>b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
</span></span><span style=display:flex><span>Labels:           controller-uid<span style=color:#666>=</span>b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
</span></span><span style=display:flex><span>                  job-name<span style=color:#666>=</span>job-wq-2
</span></span><span style=display:flex><span>Annotations:      &lt;none&gt;
</span></span><span style=display:flex><span>Parallelism:      <span style=color:#666>2</span>
</span></span><span style=display:flex><span>Completions:      &lt;unset&gt;
</span></span><span style=display:flex><span>Start Time:       Mon, <span style=color:#666>11</span> Jan <span style=color:#666>2016</span> 17:07:59 -0800
</span></span><span style=display:flex><span>Pods Statuses:    <span style=color:#666>1</span> Running / <span style=color:#666>0</span> Succeeded / <span style=color:#666>0</span> Failed
</span></span><span style=display:flex><span>Pod Template:
</span></span><span style=display:flex><span>  Labels:       controller-uid<span style=color:#666>=</span>b1c7e4e3-92e1-11e7-b85e-fa163ee3c11f
</span></span><span style=display:flex><span>                job-name<span style=color:#666>=</span>job-wq-2
</span></span><span style=display:flex><span>  Containers:
</span></span><span style=display:flex><span>   c:
</span></span><span style=display:flex><span>    Image:              gcr.io/exampleproject/job-wq-2
</span></span><span style=display:flex><span>    Port:
</span></span><span style=display:flex><span>    Environment:        &lt;none&gt;
</span></span><span style=display:flex><span>    Mounts:             &lt;none&gt;
</span></span><span style=display:flex><span>  Volumes:              &lt;none&gt;
</span></span><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  FirstSeen    LastSeen    Count    From            SubobjectPath    Type        Reason            Message
</span></span><span style=display:flex><span>  ---------    --------    -----    ----            -------------    --------    ------            -------
</span></span><span style=display:flex><span>  33s          33s         <span style=color:#666>1</span>        <span style=color:#666>{</span>job-controller <span style=color:#666>}</span>                Normal      SuccessfulCreate  Created pod: job-wq-2-lglf8
</span></span></code></pre></div><p>You can wait for the Job to succeed, with a timeout:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># The check for condition name is case insensitive</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a2f>wait</span> --for<span style=color:#666>=</span><span style=color:#b8860b>condition</span><span style=color:#666>=</span><span style=color:#a2f>complete</span> --timeout<span style=color:#666>=</span>300s job/job-wq-2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs pods/job-wq-2-7r7b2
</span></span></code></pre></div><pre tabindex=0><code>Worker with sessionID: bbd72d0a-9e5c-4dd6-abf6-416cc267991f
Initial queue state: empty=False
Working on banana
Working on date
Working on lemon
</code></pre><p>As you can see, one of our pods worked on several work units.</p><h2 id=alternatives>Alternatives</h2><p>If running a queue service or modifying your containers to use a work queue is inconvenient, you may
want to consider one of the other
<a href=/docs/concepts/workloads/controllers/job/#job-patterns>job patterns</a>.</p><p>If you have a continuous stream of background processing work to run, then
consider running your background workers with a <code>ReplicaSet</code> instead,
and consider running a background processing library such as
<a href=https://github.com/resque/resque>https://github.com/resque/resque</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9e63850014876afaebd1561f70bb8f6b>4 - Indexed Job for Parallel Processing with Static Work Assignment</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.24 [stable]</code></div><p>In this example, you will run a Kubernetes Job that uses multiple parallel
worker processes.
Each worker is a different container running in its own Pod. The Pods have an
<em>index number</em> that the control plane sets automatically, which allows each Pod
to identify which part of the overall task to work on.</p><p>The pod index is available in the <a class=glossary-tooltip title='A key-value pair that is used to attach arbitrary non-identifying metadata to objects.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/annotations target=_blank aria-label=annotation>annotation</a>
<code>batch.kubernetes.io/job-completion-index</code> as a string representing its
decimal value. In order for the containerized task process to obtain this index,
you can publish the value of the annotation using the <a href=/docs/concepts/workloads/pods/downward-api/>downward API</a>
mechanism.
For convenience, the control plane automatically sets the downward API to
expose the index in the <code>JOB_COMPLETION_INDEX</code> environment variable.</p><p>Here is an overview of the steps in this example:</p><ol><li><strong>Define a Job manifest using indexed completion</strong>.
The downward API allows you to pass the pod index annotation as an
environment variable or file to the container.</li><li><strong>Start an <code>Indexed</code> Job based on that manifest</strong>.</li></ol><h2 id=before-you-begin>Before you begin</h2><p>You should already be familiar with the basic,
non-parallel, use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.21.
To check the version, enter <code>kubectl version</code>.</p><h2 id=choose-an-approach>Choose an approach</h2><p>To access the work item from the worker program, you have a few options:</p><ol><li>Read the <code>JOB_COMPLETION_INDEX</code> environment variable. The Job
<a class=glossary-tooltip title='A control loop that watches the shared state of the cluster through the apiserver and makes changes attempting to move the current state towards the desired state.' data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/controller/ target=_blank aria-label=controller>controller</a>
automatically links this variable to the annotation containing the completion
index.</li><li>Read a file that contains the completion index.</li><li>Assuming that you can't modify the program, you can wrap it with a script
that reads the index using any of the methods above and converts it into
something that the program can use as input.</li></ol><p>For this example, imagine that you chose option 3 and you want to run the
<a href=https://man7.org/linux/man-pages/man1/rev.1.html>rev</a> utility. This
program accepts a file as an argument and prints its content reversed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rev data.txt
</span></span></code></pre></div><p>You'll use the <code>rev</code> tool from the
<a href=https://hub.docker.com/_/busybox><code>busybox</code></a> container image.</p><p>As this is only an example, each Pod only does a tiny piece of work (reversing a short
string). In a real workload you might, for example, create a Job that represents
the
task of producing 60 seconds of video based on scene data.
Each work item in the video rendering Job would be to render a particular
frame of that video clip. Indexed completion would mean that each Pod in
the Job knows which frame to render and publish, by counting frames from
the start of the clip.</p><h2 id=define-an-indexed-job>Define an Indexed Job</h2><p>Here is a sample Job manifest that uses <code>Indexed</code> completion mode:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/indexed-job.yaml download=application/job/indexed-job.yaml><code>application/job/indexed-job.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-indexed-job-yaml")' title="Copy application/job/indexed-job.yaml to clipboard"></img></div><div class=includecode id=application-job-indexed-job-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;indexed-job&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completionMode</span>:<span style=color:#bbb> </span>Indexed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initContainers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;input&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;docker.io/library/bash&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;bash&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;-c&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          items=(foo bar baz qux xyz)
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          echo ${items[$JOB_COMPLETION_INDEX]} &gt; /input/data.txt</span><span style=color:#bbb>          
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;worker&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;docker.io/library/busybox&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;rev&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;/input/data.txt&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>emptyDir</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>In the example above, you use the builtin <code>JOB_COMPLETION_INDEX</code> environment
variable set by the Job controller for all containers. An <a href=/docs/concepts/workloads/pods/init-containers/>init container</a>
maps the index to a static value and writes it to a file that is shared with the
container running the worker through an <a href=/docs/concepts/storage/volumes/#emptydir>emptyDir volume</a>.
Optionally, you can <a href=/docs/tasks/inject-data-application/environment-variable-expose-pod-information/>define your own environment variable through the downward
API</a>
to publish the index to containers. You can also choose to load a list of values
from a <a href=/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMap as an environment variable or file</a>.</p><p>Alternatively, you can directly <a href=/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#store-pod-fields>use the downward API to pass the annotation
value as a volume file</a>,
like shown in the following example:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/indexed-job-vol.yaml download=application/job/indexed-job-vol.yaml><code>application/job/indexed-job-vol.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-indexed-job-vol-yaml")' title="Copy application/job/indexed-job-vol.yaml to clipboard"></img></div><div class=includecode id=application-job-indexed-job-vol-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;indexed-job&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completionMode</span>:<span style=color:#bbb> </span>Indexed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;worker&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;docker.io/library/busybox&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;rev&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;/input/data.txt&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>input<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>downwardAPI</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;data.txt&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>fieldRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>fieldPath</span>:<span style=color:#bbb> </span>metadata.annotations[&#39;batch.kubernetes.io/job-completion-index&#39;]</span></span></code></pre></div></div></div><h2 id=running-the-job>Running the Job</h2><p>Now run the Job:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># This uses the first approach (relying on $JOB_COMPLETION_INDEX)</span>
</span></span><span style=display:flex><span>kubectl apply -f https://kubernetes.io/examples/application/job/indexed-job.yaml
</span></span></code></pre></div><p>When you create this Job, the control plane creates a series of Pods, one for each index you specified. The value of <code>.spec.parallelism</code> determines how many can run at once whereas <code>.spec.completions</code> determines how many Pods the Job creates in total.</p><p>Because <code>.spec.parallelism</code> is less than <code>.spec.completions</code>, the control plane waits for some of the first Pods to complete before starting more of them.</p><p>You can wait for the Job to succeed, with a timeout:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># The check for condition name is case insensitive</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#a2f>wait</span> --for<span style=color:#666>=</span><span style=color:#b8860b>condition</span><span style=color:#666>=</span><span style=color:#a2f>complete</span> --timeout<span style=color:#666>=</span>300s job/indexed-job
</span></span></code></pre></div><p>Now, describe the Job and check that it was successful.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe jobs/indexed-job
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>Name:              indexed-job
Namespace:         default
Selector:          controller-uid=bf865e04-0b67-483b-9a90-74cfc4c3e756
Labels:            controller-uid=bf865e04-0b67-483b-9a90-74cfc4c3e756
                   job-name=indexed-job
Annotations:       &lt;none&gt;
Parallelism:       3
Completions:       5
Start Time:        Thu, 11 Mar 2021 15:47:34 +0000
Pods Statuses:     2 Running / 3 Succeeded / 0 Failed
Completed Indexes: 0-2
Pod Template:
  Labels:  controller-uid=bf865e04-0b67-483b-9a90-74cfc4c3e756
           job-name=indexed-job
  Init Containers:
   input:
    Image:      docker.io/library/bash
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Command:
      bash
      -c
      items=(foo bar baz qux xyz)
      echo ${items[$JOB_COMPLETION_INDEX]} &gt; /input/data.txt

    Environment:  &lt;none&gt;
    Mounts:
      /input from input (rw)
  Containers:
   worker:
    Image:      docker.io/library/busybox
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Command:
      rev
      /input/data.txt
    Environment:  &lt;none&gt;
    Mounts:
      /input from input (rw)
  Volumes:
   input:
    Type:       EmptyDir (a temporary directory that shares a pod&#39;s lifetime)
    Medium:
    SizeLimit:  &lt;unset&gt;
Events:
  Type    Reason            Age   From            Message
  ----    ------            ----  ----            -------
  Normal  SuccessfulCreate  4s    job-controller  Created pod: indexed-job-njkjj
  Normal  SuccessfulCreate  4s    job-controller  Created pod: indexed-job-9kd4h
  Normal  SuccessfulCreate  4s    job-controller  Created pod: indexed-job-qjwsz
  Normal  SuccessfulCreate  1s    job-controller  Created pod: indexed-job-fdhq5
  Normal  SuccessfulCreate  1s    job-controller  Created pod: indexed-job-ncslj
</code></pre><p>In this example, you run the Job with custom values for each index. You can
inspect the output of one of the pods:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs indexed-job-fdhq5 <span style=color:#080;font-style:italic># Change this to match the name of a Pod from that Job</span>
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>xuq
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-d65c40e1d2df81b94a09634c2432b055>5 - Job with Pod-to-Pod Communication</h1><p>In this example, you will run a Job in <a href=/blog/2021/04/19/introducing-indexed-jobs/>Indexed completion mode</a> configured such that
the pods created by the Job can communicate with each other using pod hostnames rather than pod IP addresses.</p><p>Pods within a Job might need to communicate among themselves. The user workload running in each pod could query the Kubernetes API server
to learn the IPs of the other Pods, but it's much simpler to rely on Kubernetes' built-in DNS resolution.</p><p>Jobs in Indexed completion mode automatically set the pods' hostname to be in the format of
<code>${jobName}-${completionIndex}</code>. You can use this format to deterministically build
pod hostnames and enable pod communication <em>without</em> needing to create a client connection to
the Kubernetes control plane to obtain pod hostnames/IPs via API requests.</p><p>This configuration is useful
for use cases where pod networking is required but you don't want to depend on a network
connection with the Kubernetes API server.</p><h2 id=before-you-begin>Before you begin</h2><p>You should already be familiar with the basic use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version v1.21.
To check the version, enter <code>kubectl version</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> If you are using MiniKube or a similar tool, you may need to take
<a href=https://minikube.sigs.k8s.io/docs/handbook/addons/ingress-dns/>extra steps</a>
to ensure you have DNS.</div><h2 id=starting-a-job-with-pod-to-pod-communication>Starting a Job with Pod-to-Pod Communication</h2><p>To enable pod-to-pod communication using pod hostnames in a Job, you must do the following:</p><ol><li><p>Set up a <a href=/docs/concepts/services-networking/service/#headless-services>headless service</a>
with a valid label selector for the pods created by your Job. The headless service must be in the same namespace as
the Job. One easy way to do this is to use the <code>job-name: &lt;your-job-name></code> selector, since the <code>job-name</code> label will be automatically added by Kubernetes. This configuration will trigger the DNS system to create records of the hostnames of
the pods running your Job.</p></li><li><p>Configure the headless service as subdomain service for the Job pods by including the following value in your Job template spec:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>subdomain</span>:<span style=color:#bbb> </span>&lt;headless-svc-name&gt;<span style=color:#bbb>
</span></span></span></code></pre></div></li></ol><h3 id=example>Example</h3><p>Below is a working example of a Job with pod-to-pod communication via pod hostnames enabled.
The Job is completed only after all pods successfully ping each other using hostnames.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> In the Bash script executed on each pod in the example below, the pod hostnames can be prefixed
by the namespace as well if the pod needs to be reached from outside the namespace.</div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>headless-svc<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>clusterIP</span>:<span style=color:#bbb> </span>None<span style=color:#bbb> </span><span style=color:#080;font-style:italic># clusterIP must be None to create a headless service</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>job-name</span>:<span style=color:#bbb> </span>example-job<span style=color:#bbb> </span><span style=color:#080;font-style:italic># must match Job name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completionMode</span>:<span style=color:#bbb> </span>Indexed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>subdomain</span>:<span style=color:#bbb> </span>headless-svc<span style=color:#bbb> </span><span style=color:#080;font-style:italic># has to match Service name</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-workload<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>bash:latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- bash<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          for i in 0 1 2
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          do
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            gotStatus=&#34;-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            wantStatus=&#34;0&#34;             
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            while [ $gotStatus -ne $wantStatus ]
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            do                                       
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>              ping -c 1 example-job-${i}.headless-svc &gt; /dev/null 2&gt;&amp;1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>              gotStatus=$?                
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>              if [ $gotStatus -ne $wantStatus ]; then
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                echo &#34;Failed to ping pod example-job-${i}.headless-svc, retrying in 1 second...&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>                sleep 1
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>              fi
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            done                                                         
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            echo &#34;Successfully pinged pod: example-job-${i}.headless-svc&#34;
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          done</span><span style=color:#bbb>          
</span></span></span></code></pre></div><p>After applying the example above, reach each other over the network
using: <code>&lt;pod-hostname>.&lt;headless-service-name></code>. You should see output similar to the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs example-job-0-qws42
</span></span></code></pre></div><pre tabindex=0><code>Failed to ping pod example-job-0.headless-svc, retrying in 1 second...
Successfully pinged pod: example-job-0.headless-svc
Successfully pinged pod: example-job-1.headless-svc
Successfully pinged pod: example-job-2.headless-svc
</code></pre><div class="alert alert-info note callout" role=alert><strong>Note:</strong> Keep in mind that the <code>&lt;pod-hostname>.&lt;headless-service-name></code> name format used
in this example would not work with DNS policy set to <code>None</code> or <code>Default</code>.
You can learn more about pod DNS policies <a href=/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy>here</a>.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-da7c2b067953d239eb4457e8978ad8f6>6 - Parallel Processing using Expansions</h1><p>This task demonstrates running multiple <a class=glossary-tooltip title='A finite or batch task that runs to completion.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/job/ target=_blank aria-label=Jobs>Jobs</a>
based on a common template. You can use this approach to process batches of work in
parallel.</p><p>For this example there are only three items: <em>apple</em>, <em>banana</em>, and <em>cherry</em>.
The sample Jobs process each item by printing a string then pausing.</p><p>See <a href=#using-jobs-in-real-workloads>using Jobs in real workloads</a> to learn about how
this pattern fits more realistic use cases.</p><h2 id=before-you-begin>Before you begin</h2><p>You should be familiar with the basic,
non-parallel, use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><p>For basic templating you need the command-line utility <code>sed</code>.</p><p>To follow the advanced templating example, you need a working installation of
<a href=https://www.python.org/>Python</a>, and the Jinja2 template
library for Python.</p><p>Once you have Python set up, you can install Jinja2 by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip install --user jinja2
</span></span></code></pre></div><h2 id=create-jobs-based-on-a-template>Create Jobs based on a template</h2><p>First, download the following template of a Job to a file called <code>job-tmpl.yaml</code>.
Here's what you'll download:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/job/job-tmpl.yaml download=application/job/job-tmpl.yaml><code>application/job/job-tmpl.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("application-job-job-tmpl-yaml")' title="Copy application/job/job-tmpl.yaml to clipboard"></img></div><div class=includecode id=application-job-job-tmpl-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>process-item-$ITEM<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>jobgroup</span>:<span style=color:#bbb> </span>jobexample<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>jobexample<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>jobgroup</span>:<span style=color:#bbb> </span>jobexample<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;echo Processing item $ITEM &amp;&amp; sleep 5&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Use curl to download job-tmpl.yaml</span>
</span></span><span style=display:flex><span>curl -L -s -O https://k8s.io/examples/application/job/job-tmpl.yaml
</span></span></code></pre></div><p>The file you downloaded is not yet a valid Kubernetes
<a class=glossary-tooltip title='A serialized specification of one or more Kubernetes API objects.' data-toggle=tooltip data-placement=top href='/docs/reference/glossary/?all=true#term-manifest' target=_blank aria-label=manifest>manifest</a>.
Instead that template is a YAML representation of a Job object with some placeholders
that need to be filled in before it can be used. The <code>$ITEM</code> syntax is not meaningful to Kubernetes.</p><h3 id=create-manifests-from-the-template>Create manifests from the template</h3><p>The following shell snippet uses <code>sed</code> to replace the string <code>$ITEM</code> with the loop
variable, writing into a temporary directory named <code>jobs</code>. Run this now:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Expand the template into multiple files, one for each item to be processed.</span>
</span></span><span style=display:flex><span>mkdir ./jobs
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> i in apple banana cherry
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>  cat job-tmpl.yaml | sed <span style=color:#b44>&#34;s/\$ITEM/</span><span style=color:#b8860b>$i</span><span style=color:#b44>/&#34;</span> &gt; ./jobs/job-<span style=color:#b8860b>$i</span>.yaml
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>Check if it worked:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ls jobs/
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>job-apple.yaml
job-banana.yaml
job-cherry.yaml
</code></pre><p>You could use any type of template language (for example: Jinja2; ERB), or
write a program to generate the Job manifests.</p><h3 id=create-jobs-from-the-manifests>Create Jobs from the manifests</h3><p>Next, create all the Jobs with one kubectl command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f ./jobs
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>job.batch/process-item-apple created
job.batch/process-item-banana created
job.batch/process-item-cherry created
</code></pre><p>Now, check on the jobs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get <span style=color:#a2f>jobs</span> -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><p>The output is similar to this:</p><pre tabindex=0><code>NAME                  COMPLETIONS   DURATION   AGE
process-item-apple    1/1           14s        22s
process-item-banana   1/1           12s        21s
process-item-cherry   1/1           12s        20s
</code></pre><p>Using the <code>-l</code> option to kubectl selects only the Jobs that are part
of this group of jobs (there might be other unrelated jobs in the system).</p><p>You can check on the Pods as well using the same
<a class=glossary-tooltip title='Allows users to filter a list of resources based on labels.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/labels/ target=_blank aria-label='label selector'>label selector</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pods -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><p>The output is similar to:</p><pre tabindex=0><code>NAME                        READY     STATUS      RESTARTS   AGE
process-item-apple-kixwv    0/1       Completed   0          4m
process-item-banana-wrsf7   0/1       Completed   0          4m
process-item-cherry-dnfu9   0/1       Completed   0          4m
</code></pre><p>We can use this single command to check on the output of all jobs at once:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl logs -f -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><p>The output should be:</p><pre tabindex=0><code>Processing item apple
Processing item banana
Processing item cherry
</code></pre><h3 id=cleanup-1>Clean up</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Remove the Jobs you created</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Your cluster automatically cleans up their Pods</span>
</span></span><span style=display:flex><span>kubectl delete job -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><h2 id=use-advanced-template-parameters>Use advanced template parameters</h2><p>In the <a href=#create-jobs-based-on-a-template>first example</a>, each instance of the template had one
parameter, and that parameter was also used in the Job's name. However,
<a href=/docs/concepts/overview/working-with-objects/names/#names>names</a> are restricted
to contain only certain characters.</p><p>This slightly more complex example uses the
<a href=https://palletsprojects.com/p/jinja/>Jinja template language</a> to generate manifests
and then objects from those manifests, with a multiple parameters for each Job.</p><p>For this part of the task, you are going to use a one-line Python script to
convert the template to a set of manifests.</p><p>First, copy and paste the following template of a Job object, into a file called <code>job.yaml.jinja2</code>:</p><pre tabindex=0><code class=language-liquid data-lang=liquid>{% set params = [{ &#34;name&#34;: &#34;apple&#34;, &#34;url&#34;: &#34;http://dbpedia.org/resource/Apple&#34;, },
                  { &#34;name&#34;: &#34;banana&#34;, &#34;url&#34;: &#34;http://dbpedia.org/resource/Banana&#34;, },
                  { &#34;name&#34;: &#34;cherry&#34;, &#34;url&#34;: &#34;http://dbpedia.org/resource/Cherry&#34; }]
%}
{% for p in params %}
{% set name = p[&#34;name&#34;] %}
{% set url = p[&#34;url&#34;] %}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: jobexample-{{ name }}
  labels:
    jobgroup: jobexample
spec:
  template:
    metadata:
      name: jobexample
      labels:
        jobgroup: jobexample
    spec:
      containers:
      - name: c
        image: busybox:1.28
        command: [&#34;sh&#34;, &#34;-c&#34;, &#34;echo Processing URL {{ url }} &amp;&amp; sleep 5&#34;]
      restartPolicy: Never
{% endfor %}
</code></pre><p>The above template defines two parameters for each Job object using a list of
python dicts (lines 1-4). A <code>for</code> loop emits one Job manifest for each
set of parameters (remaining lines).</p><p>This example relies on a feature of YAML. One YAML file can contain multiple
documents (Kubernetes manifests, in this case), separated by <code>---</code> on a line
by itself.
You can pipe the output directly to <code>kubectl</code> to create the Jobs.</p><p>Next, use this one-line Python program to expand the template:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a2f>alias</span> <span style=color:#b8860b>render_template</span><span style=color:#666>=</span><span style=color:#b44>&#39;python -c &#34;from jinja2 import Template; import sys; print(Template(sys.stdin.read()).render());&#34;&#39;</span>
</span></span></code></pre></div><p>Use <code>render_template</code> to convert the parameters and template into a single
YAML file containing Kubernetes manifests:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># This requires the alias you defined earlier</span>
</span></span><span style=display:flex><span>cat job.yaml.jinja2 | render_template &gt; jobs.yaml
</span></span></code></pre></div><p>You can view <code>jobs.yaml</code> to verify that the <code>render_template</code> script worked
correctly.</p><p>Once you are happy that <code>render_template</code> is working how you intend,
you can pipe its output into <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat job.yaml.jinja2 | render_template | kubectl apply -f -
</span></span></code></pre></div><p>Kubernetes accepts and runs the Jobs you created.</p><h3 id=cleanup-2>Clean up</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># Remove the Jobs you created</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Your cluster automatically cleans up their Pods</span>
</span></span><span style=display:flex><span>kubectl delete job -l <span style=color:#b8860b>jobgroup</span><span style=color:#666>=</span>jobexample
</span></span></code></pre></div><h2 id=using-jobs-in-real-workloads>Using Jobs in real workloads</h2><p>In a real use case, each Job performs some substantial computation, such as rendering a frame
of a movie, or processing a range of rows in a database. If you were rendering a movie
you would set <code>$ITEM</code> to the frame number. If you were processing rows from a database
table, you would set <code>$ITEM</code> to represent the range of database rows to process.</p><p>In the task, you ran a command to collect the output from Pods by fetching
their logs. In a real use case, each Pod for a Job writes its output to
durable storage before completing. You can use a PersistentVolume for each Job,
or an external storage service. For example, if you are rendering frames for a movie,
use HTTP to <code>PUT</code> the rendered frame data to a URL, using a different URL for each
frame.</p><h2 id=labels-on-jobs-and-pods>Labels on Jobs and Pods</h2><p>After you create a Job, Kubernetes automatically adds additional
<a class=glossary-tooltip title='Tags objects with identifying attributes that are meaningful and relevant to users.' data-toggle=tooltip data-placement=top href=/docs/concepts/overview/working-with-objects/labels target=_blank aria-label=labels>labels</a> that
distinguish one Job's pods from another Job's pods.</p><p>In this example, each Job and its Pod template have a label:
<code>jobgroup=jobexample</code>.</p><p>Kubernetes itself pays no attention to labels named <code>jobgroup</code>. Setting a label
for all the Jobs you create from a template makes it convenient to operate on all
those Jobs at once.
In the <a href=#create-jobs-based-on-a-template>first example</a> you used a template to
create several Jobs. The template ensures that each Pod also gets the same label, so
you can check on all Pods for these templated Jobs with a single command.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> The label key <code>jobgroup</code> is not special or reserved.
You can pick your own labelling scheme.
There are <a href=/docs/concepts/overview/working-with-objects/common-labels/#labels>recommended labels</a>
that you can use if you wish.</div><h2 id=alternatives>Alternatives</h2><p>If you plan to create a large number of Job objects, you may find that:</p><ul><li>Even using labels, managing so many Jobs is cumbersome.</li><li>If you create many Jobs in a batch, you might place high load
on the Kubernetes control plane. Alternatively, the Kubernetes API
server could rate limit you, temporarily rejecting your requests with a 429 status.</li><li>You are limited by a <a class=glossary-tooltip title='Provides constraints that limit aggregate resource consumption per namespace.' data-toggle=tooltip data-placement=top href=/docs/concepts/policy/resource-quotas/ target=_blank aria-label='resource quota'>resource quota</a>
on Jobs: the API server permanently rejects some of your requests
when you create a great deal of work in one batch.</li></ul><p>There are other <a href=/docs/concepts/workloads/controllers/job/#job-patterns>job patterns</a>
that you can use to process large amounts of work without creating very many Job
objects.</p><p>You could also consider writing your own <a href=/docs/concepts/architecture/controller/>controller</a>
to manage Job objects automatically.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ecb5ec00bbce2e57292c6687437beae0>7 - Handling retriable and non-retriable pod failures with Pod failure policy</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.25 [alpha]</code></div><p>This document shows you how to use the
<a href=/docs/concepts/workloads/controllers/job#pod-failure-policy>Pod failure policy</a>,
in combination with the default
<a href=/docs/concepts/workloads/controllers/job#pod-backoff-failure-policy>Pod backoff failure policy</a>,
to improve the control over the handling of container- or Pod-level failure
within a <a class=glossary-tooltip title='A finite or batch task that runs to completion.' data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/job/ target=_blank aria-label=Job>Job</a>.</p><p>The definition of Pod failure policy may help you to:</p><ul><li>better utilize the computational resources by avoiding unnecessary Pod retries.</li><li>avoid Job failures due to Pod disruptions (such <a class=glossary-tooltip title='Preemption logic in Kubernetes helps a pending Pod to find a suitable Node by evicting low priority Pods existing on that Node.' data-toggle=tooltip data-placement=top href=/docs/concepts/scheduling-eviction/pod-priority-preemption/#preemption target=_blank aria-label=preemption>preemption</a>,
<a class=glossary-tooltip title='API-initiated eviction is the process by which you use the Eviction API to create an Eviction object that triggers graceful pod termination.' data-toggle=tooltip data-placement=top href=/docs/concepts/scheduling-eviction/api-eviction/ target=_blank aria-label='API-initiated eviction'>API-initiated eviction</a>
or <a class=glossary-tooltip title='A core object consisting of three required properties: key, value, and effect. Taints prevent the scheduling of pods on nodes or node groups.' data-toggle=tooltip data-placement=top href=/docs/concepts/scheduling-eviction/taint-and-toleration/ target=_blank aria-label=taint>taint</a>-based eviction).</li></ul><h2 id=before-you-begin>Before you begin</h2><p>You should already be familiar with the basic use of <a href=/docs/concepts/workloads/controllers/job/>Job</a>.</p><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a
cluster, you can create one by using
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be version v1.25.
To check the version, enter <code>kubectl version</code>.</p><div class="alert alert-info note callout" role=alert><strong>Note:</strong> As the features are in Alpha, prepare the Kubernetes cluster with the two
<a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gates</a>
enabled: <code>JobPodFailurePolicy</code> and <code>PodDisruptionConditions</code>.</div><h2 id=using-pod-failure-policy-to-avoid-unnecessary-pod-retries>Using Pod failure policy to avoid unnecessary Pod retries</h2><p>With the following example, you can learn how to use Pod failure policy to
avoid unnecessary Pod restarts when a Pod failure indicates a non-retriable
software bug.</p><p>First, create a Job based on the config:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples//controllers/job-pod-failure-policy-failjob.yaml download=/controllers/job-pod-failure-policy-failjob.yaml><code>/controllers/job-pod-failure-policy-failjob.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("controllers-job-pod-failure-policy-failjob-yaml")' title="Copy /controllers/job-pod-failure-policy-failjob.yaml to clipboard"></img></div><div class=includecode id=controllers-job-pod-failure-policy-failjob-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-pod-failure-policy-failjob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>8</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>main<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>docker.io/library/bash:5<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;bash&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -c<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- echo &#34;Hello world! I&#39;m going to exit with 42 to simulate a software bug.&#34; &amp;&amp; sleep 30 &amp;&amp; exit 42<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>backoffLimit</span>:<span style=color:#bbb> </span><span style=color:#666>6</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podFailurePolicy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>action</span>:<span style=color:#bbb> </span>FailJob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>onExitCodes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>containerName</span>:<span style=color:#bbb> </span>main<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>In<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>values</span>:<span style=color:#bbb> </span>[<span style=color:#666>42</span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create -f job-pod-failure-policy-failjob.yaml
</span></span></code></pre></div><p>After around 30s the entire Job should be terminated. Inspect the status of the Job by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get <span style=color:#a2f>jobs</span> -l job-name<span style=color:#666>=</span>job-pod-failure-policy-failjob -o yaml
</span></span></code></pre></div><p>In the Job status, see a job <code>Failed</code> condition with the field <code>reason</code>
equal <code>PodFailurePolicy</code>. Additionally, the <code>message</code> field contains a
more detailed information about the Job termination, such as:
<code>Container main for pod default/job-pod-failure-policy-failjob-8ckj8 failed with exit code 42 matching FailJob rule at index 0</code>.</p><p>For comparison, if the Pod failure policy was disabled it would take 6 retries
of the Pod, taking at least 2 minutes.</p><h3 id=clean-up>Clean up</h3><p>Delete the Job you created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl delete jobs/job-pod-failure-policy-failjob
</span></span></code></pre></div><p>The cluster automatically cleans up the Pods.</p><h2 id=using-pod-failure-policy-to-ignore-pod-disruptions>Using Pod failure policy to ignore Pod disruptions</h2><p>With the following example, you can learn how to use Pod failure policy to
ignore Pod disruptions from incrementing the Pod retry counter towards the
<code>.spec.backoffLimit</code> limit.</p><div class="alert alert-warning caution callout" role=alert><strong>Caution:</strong> Timing is important for this example, so you may want to read the steps before
execution. In order to trigger a Pod disruption it is important to drain the
node while the Pod is running on it (within 90s since the Pod is scheduled).</div><ol><li><p>Create a Job based on the config:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples//controllers/job-pod-failure-policy-ignore.yaml download=/controllers/job-pod-failure-policy-ignore.yaml><code>/controllers/job-pod-failure-policy-ignore.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("controllers-job-pod-failure-policy-ignore-yaml")' title="Copy /controllers/job-pod-failure-policy-ignore.yaml to clipboard"></img></div><div class=includecode id=controllers-job-pod-failure-policy-ignore-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>batch/v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>job-pod-failure-policy-ignore<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>completions</span>:<span style=color:#bbb> </span><span style=color:#666>4</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>parallelism</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>restartPolicy</span>:<span style=color:#bbb> </span>Never<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>main<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>docker.io/library/bash:5<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;bash&#34;</span>]<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -c<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- echo &#34;Hello world! I&#39;m going to exit with 0 (success).&#34; &amp;&amp; sleep 90 &amp;&amp; exit 0<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>backoffLimit</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podFailurePolicy</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>action</span>:<span style=color:#bbb> </span>Ignore<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>onPodConditions</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DisruptionTarget<span style=color:#bbb>
   </span></span></span></code></pre></div></div></div><p>by running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl create -f job-pod-failure-policy-ignore.yaml
</span></span></code></pre></div></li><li><p>Run this command to check the <code>nodeName</code> the Pod is scheduled to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#b8860b>nodeName</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl get pods -l job-name<span style=color:#666>=</span>job-pod-failure-policy-ignore -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.items[0].spec.nodeName}&#39;</span><span style=color:#a2f;font-weight:700>)</span>
</span></span></code></pre></div></li><li><p>Drain the node to evict the Pod before it completes (within 90s):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl drain nodes/<span style=color:#b8860b>$nodeName</span> --ignore-daemonsets --grace-period<span style=color:#666>=</span><span style=color:#666>0</span>
</span></span></code></pre></div></li><li><p>Inspect the <code>.status.failed</code> to check the counter for the Job is not incremented:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl get <span style=color:#a2f>jobs</span> -l job-name<span style=color:#666>=</span>job-pod-failure-policy-ignore -o yaml
</span></span></code></pre></div></li><li><p>Uncordon the node:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl uncordon nodes/<span style=color:#b8860b>$nodeName</span>
</span></span></code></pre></div></li></ol><p>The Job resumes and succeeds.</p><p>For comparison, if the Pod failure policy was disabled the Pod disruption would
result in terminating the entire Job (as the <code>.spec.backoffLimit</code> is set to 0).</p><h3 id=cleaning-up>Cleaning up</h3><p>Delete the Job you created:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl delete jobs/job-pod-failure-policy-ignore
</span></span></code></pre></div><p>The cluster automatically cleans up the Pods.</p><h2 id=alternatives>Alternatives</h2><p>You could rely solely on the
<a href=/docs/concepts/workloads/controllers/job#pod-backoff-failure-policy>Pod backoff failure policy</a>,
by specifying the Job's <code>.spec.backoffLimit</code> field. However, in many situations
it is problematic to find a balance between setting a low value for <code>.spec.backoffLimit</code>
to avoid unnecessary Pod retries, yet high enough to make sure the Job would
not be terminated by Pod disruptions.</p></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/docs/home/>Home</a>
<a class=text-white href=/blog/>Blog</a>
<a class=text-white href=/training/>Training</a>
<a class=text-white href=/partners/>Partners</a>
<a class=text-white href=/community/>Community</a>
<a class=text-white href=/case-studies/>Case Studies</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a></small><br><small class=text-white>Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>