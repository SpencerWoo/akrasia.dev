<!doctype html><html lang=ja class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=en href=https://kubernetes.io/docs/tasks/debug/debug-cluster/><link rel=alternate hreflang=zh-cn href=https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/><link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/tasks/debug/debug-cluster/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://kubernetes.io/ja/docs/tasks/debug/debug-cluster/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>クラスターのトラブルシューティング | Kubernetes</title><meta property="og:title" content="クラスターのトラブルシューティング"><meta property="og:description" content="一般的なクラスターの問題をデバッグします。"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/ja/docs/tasks/debug/debug-cluster/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="クラスターのトラブルシューティング"><meta itemprop=description content="一般的なクラスターの問題をデバッグします。"><meta name=twitter:card content="summary"><meta name=twitter:title content="クラスターのトラブルシューティング"><meta name=twitter:description content="一般的なクラスターの問題をデバッグします。"><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content="一般的なクラスターの問題をデバッグします。"><meta property="og:description" content="一般的なクラスターの問題をデバッグします。"><meta name=twitter:description content="一般的なクラスターの問題をデバッグします。"><meta property="og:url" content="https://kubernetes.io/ja/docs/tasks/debug/debug-cluster/"><meta property="og:title" content="クラスターのトラブルシューティング"><meta name=twitter:title content="クラスターのトラブルシューティング"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/ja/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/ja/docs/>ドキュメント</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/blog/>Blogs</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/training/>トレーニング</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/partners/>パートナー</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/community/>コミュニティ</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/case-studies/>ケーススタディ</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>バージョン</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/ja/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/ja/docs/tasks/debug/debug-cluster/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/ja/docs/tasks/debug/debug-cluster/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/ja/docs/tasks/debug/debug-cluster/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/ja/docs/tasks/debug/debug-cluster/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/ja/docs/tasks/debug/debug-cluster/>v1.21</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>日本語 (Japanese)</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/tasks/debug/debug-cluster/>English</a>
<a class=dropdown-item href=/zh-cn/docs/tasks/debug/debug-cluster/>中文 (Chinese)</a>
<a class=dropdown-item href=/ko/docs/tasks/debug/debug-cluster/>한국어 (Korean)</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>これは、このセクションの複数ページの印刷可能なビューです。
<a href=# onclick="return print(),!1">印刷するには、ここをクリックしてください</a>.</p><p><a href=/ja/docs/tasks/debug/debug-cluster/>このページの通常のビューに戻る</a>.</p></div><h1 class=title>クラスターのトラブルシューティング</h1><div class=lead>一般的なクラスターの問題をデバッグします。</div><ul><li>1: <a href=#pg-5ff0cdcf7701f887e45d629f5cfe0424>リソースメトリクスパイプライン</a></li><li>2: <a href=#pg-cb9e28c208c6cfbabdb15ba2e42e9ef0>リソース監視のためのツール</a></li><li>3: <a href=#pg-20165c8269bed123bfb94fb6e7f85643>ノードの健全性を監視します</a></li><li>4: <a href=#pg-6ca4f22ef4d1713577ada4815f0a3b5a>crictlによるKubernetesノードのデバッグ</a></li><li>5: <a href=#pg-60dca0ec8d41f0045e7d73e1d6bd7bce>テレプレゼンスを使用したローカルでのサービス開発・デバッグ</a></li><li>6: <a href=#pg-38387ad04dd284933cb502944ea3515b>監査</a></li></ul><div class=content><p>このドキュメントはクラスターのトラブルシューティングに関するもので、あなたが経験している問題の根本原因として、アプリケーションをすでに除外していることを前提としています。
アプリケーションのデバッグのコツは、<a href=/ja/docs/tasks/debug/debug-application/>アプリケーションのトラブルシューティングガイド</a>をご覧ください。
また、<a href=/ja/docs/tasks/debug/debug>トラブルシューティングドキュメント</a>にも詳しい情報があります。</p><h2 id=クラスターのリストアップ>クラスターのリストアップ</h2><p>クラスターで最初にデバッグするのは、ノードがすべて正しく登録されているかどうかです。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p>そして、期待するノードがすべて存在し、それらがすべて <code>Ready</code> 状態であることを確認します。</p><p>クラスター全体の健全性に関する詳細な情報を得るには、以下を実行します。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info dump
</span></span></code></pre></div><h2 id=ログの確認>ログの確認</h2><p>今のところ、クラスターをより深く掘り下げるには、関連するマシンにログインする必要があります。
以下は、関連するログファイルの場所です。
(systemdベースのシステムでは、代わりに <code>journalctl</code> を使う必要があるかもしれないことに注意してください)</p><h3 id=マスターノード>マスターノード</h3><ul><li><code>/var/log/kube-apiserver.log</code> - APIの提供を担当するAPIサーバーのログ</li><li><code>/var/log/kube-scheduler.log</code> - スケジューリング決定責任者であるスケジューラーのログ</li><li><code>/var/log/kube-controller-manager.log</code> - レプリケーションコントローラーを管理するコントローラーのログ</li></ul><h3 id=ワーカーノード>ワーカーノード</h3><ul><li><code>/var/log/kubelet.log</code> - ノード上でコンテナの実行を担当するKubeletのログ</li><li><code>/var/log/kube-proxy.log</code> - サービスのロードバランシングを担うKube Proxyのログ</li></ul><h2 id=クラスター障害モードの一般的な概要>クラスター障害モードの一般的な概要</h2><p>これは、問題が発生する可能性のある事柄と、問題を軽減するためにクラスターのセットアップを調整する方法の不完全なリストです。</p><h3 id=根本的な原因>根本的な原因</h3><ul><li>VMのシャットダウン</li><li>クラスター内、またはクラスターとユーザー間のネットワークパーティション</li><li>Kubernetesソフトウェアのクラッシュ</li><li>データの損失や永続的ストレージ(GCE PDやAWS EBSボリュームなど)の使用不能</li><li>Kubernetesソフトウェアやアプリケーションソフトウェアの設定ミスなど、オペレーターのミス</li></ul><h3 id=具体的なシナリオ>具体的なシナリオ</h3><ul><li><p>apiserver VMのシャットダウンまたはapiserverのクラッシュ</p><ul><li>新しいPod、サービス、レプリケーションコントローラの停止、更新、起動ができない</li><li>Kubernetes APIに依存していない限り、既存のPodやサービスは正常に動作し続けるはずです</li></ul></li><li><p>apiserverのバックアップストレージが失われた</p><ul><li>apiserverが立ち上がらない</li><li>kubeletsは到達できなくなりますが、同じPodを実行し、同じサービスのプロキシを提供し続けます</li><li>apiserverを再起動する前に、手動でapiserverの状態を回復または再現する必要がある</li></ul></li><li><p>サポートサービス(ノードコントローラ、レプリケーションコントローラーマネージャー、スケジューラーなど)VMのシャットダウンまたはクラッシュ</p><ul><li>現在、これらはapiserverとコロケーションしており、使用できない場合はapiserverと同様の影響があります</li><li>将来的には、これらも複製されるようになり、同じ場所に配置されない可能性があります</li><li>独自の永続的な状態を持っていない。</li></ul></li><li><p>個別ノード(VMまたは物理マシン)のシャットダウン</p><ul><li>そのノード上のPodの実行を停止</li></ul></li><li><p>ネットワークパーティション</p><ul><li>パーティションAはパーティションBのノードがダウンしていると考え、パーティションBはapiserverがダウンしていると考えています。(マスターVMがパーティションAで終了したと仮定)</li></ul></li><li><p>Kubeletソフトウェア障害</p><ul><li>クラッシュしたkubeletがノード上で新しいPodを起動できない</li><li>kubeletがPodを削除するかどうか</li><li>ノードが不健全と判定される</li><li>レプリケーションコントローラーが別の場所で新しいPodを起動する</li></ul></li><li><p>クラスターオペレーターエラー</p><ul><li>PodやServiceなどの損失</li><li>apiserverのバックエンドストレージの紛失</li><li>ユーザーがAPIを読めなくなる</li><li>その他</li></ul></li></ul><h3 id=軽減策>軽減策</h3><ul><li><p>対処法: IaaSプロバイダーの自動VM再起動機能をIaaS VMに使用する</p><ul><li>異常: Apiserver VMのシャットダウンまたはApiserverのクラッシュ</li><li>異常: サポートサービスのVMシャットダウンまたはクラッシュ</li></ul></li><li><p>対処法: IaaSプロバイダーの信頼できるストレージ(GCE PDやAWS EBSボリュームなど)をapiserver+etcdを使用するVMに使用する</p><ul><li>異常: Apiserverのバックエンドストレージが失われる</li></ul></li><li><p>対処法: <a href=/docs/setup/production-environment/tools/kubeadm/high-availability/>高可用性</a>構成を使用します</p><ul><li>異常: コントロールプレーンノードのシャットダウンまたはコントロールプレーンコンポーネント(スケジューラー、APIサーバー、コントローラーマネージャー)のクラッシュ<ul><li>1つ以上のノードまたはコンポーネントの同時故障に耐えることができる</li></ul></li><li>異常: APIサーバーのバックアップストレージ(etcdのデータディレクトリーなど)が消失<ul><li>HA(高可用性) etcdの構成を想定しています</li></ul></li></ul></li><li><p>対処法: apiserver PDs/EBS-volumesを定期的にスナップショットする</p><ul><li>異常: Apiserver のバックエンドストレージが失われる</li><li>異常: 操作ミスが発生する場合がある</li><li>異常: Kubernetesのソフトウェアに障害が発生する場合がある</li></ul></li><li><p>対処法：レプリケーションコントローラーとServiceをPodの前に使用する</p><ul><li>異常: ノードのシャットダウン</li><li>異常: Kubeletソフトウェア障害</li></ul></li><li><p>対処法: 予期せぬ再起動に耐えられるように設計されたアプリケーション(コンテナ)</p><ul><li>異常: ノードのシャットダウン</li><li>異常: Kubeletソフトウェア障害</li></ul></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5ff0cdcf7701f887e45d629f5cfe0424>1 - リソースメトリクスパイプライン</h1><p>Kubernetesでは、コンテナのCPU使用率やメモリ使用率といったリソース使用量のメトリクスが、メトリクスAPIを通じて提供されています。これらのメトリクスは、ユーザーが<code>kubectl top</code>コマンドで直接アクセスするか、クラスター内のコントローラー(例えばHorizontal Pod Autoscaler)が判断するためにアクセスすることができます。</p><h2 id=メトリクスapi>メトリクスAPI</h2><p>メトリクスAPIを使用すると、指定したノードやPodが現在使用しているリソース量を取得することができます。
このAPIはメトリックの値を保存しないので、例えば10分前に指定されたノードが使用したリソース量を取得することはできません。</p><p>メトリクスAPIは他のAPIと何ら変わりはありません。</p><ul><li>他のKubernetes APIと同じエンドポイントを経由して、<code>/apis/metrics.k8s.io/</code>パスの下で発見できます。</li><li>同じセキュリティ、スケーラビリティ、信頼性の保証を提供します。</li></ul><p>メトリクスAPIは<a href=https://github.com/kubernetes/metrics/blob/master/pkg/apis/metrics/v1beta1/types.go>k8s.io/metrics</a>リポジトリで定義されています。
メトリクスAPIについての詳しい情報はそちらをご覧ください。</p><div class="alert alert-info note callout" role=alert><strong>備考:</strong> メトリクスAPIを使用するには、クラスター内にメトリクスサーバーが配置されている必要があります。そうでない場合は利用できません。</div><h2 id=リソース使用量の測定>リソース使用量の測定</h2><h3 id=cpu>CPU</h3><p>CPUは、一定期間の平均使用量を<a href=/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu>CPU cores</a>という単位で報告されます。
この値は、カーネルが提供する累積CPUカウンターの比率を取得することで得られます(LinuxとWindowsの両カーネルで)。
kubeletは、比率計算のためのウィンドウを選択します。</p><h3 id=メモリ>メモリ</h3><p>メモリは、測定値が収集された時点のワーキングセットとして、バイト単位で報告されます。
理想的な世界では、「ワーキングセット」は、メモリ不足で解放できない使用中のメモリ量です。
しかし、ワーキングセットの計算はホストOSによって異なり、一般に推定値を生成するために経験則を多用しています。
Kubernetesはスワップをサポートしていないため、すべての匿名(非ファイルバックアップ)メモリが含まれます。
ホストOSは常にそのようなページを再請求することができないため、メトリックには通常、一部のキャッシュされた(ファイルバックされた)メモリも含まれます。</p><h2 id=メトリクスサーバー>メトリクスサーバー</h2><p><a href=https://github.com/kubernetes-sigs/metrics-server>メトリクスサーバー</a>は、クラスター全体のリソース使用量データのアグリゲーターです。
デフォルトでは、<code>kube-up.sh</code>スクリプトで作成されたクラスターにDeploymentオブジェクトとしてデプロイされます。
別のKubernetesセットアップ機構を使用する場合は、提供される<a href=https://github.com/kubernetes-sigs/metrics-server/releases>deployment components.yaml</a>ファイルを使用してデプロイすることができます。
メトリクスサーバーは、Summary APIからメトリクスを収集します。
各ノードの<a href=/docs/reference/command-line-tools-reference/kubelet/>Kubelet</a>から<a href=/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>Kubernetes aggregator</a>経由でメインAPIサーバーに登録されるようになっています。</p><p>メトリクスサーバーについては、<a href=https://github.com/kubernetes/design-proposals-archive/blob/main/instrumentation/metrics-server.md>Design proposals</a>で詳しく解説しています。</p><h3 id=summary-apiソース>Summary APIソース</h3><p><a href=/docs/reference/command-line-tools-reference/kubelet/>Kubelet</a>は、ノード、ボリューム、Pod、コンテナレベルの統計情報を収集し、<a href=https://github.com/kubernetes/kubernetes/blob/7d309e0104fedb57280b261e5677d919cb2a0e2d/staging/src/k8s.io/kubelet/pkg/apis/stats/v1alpha1/types.go>Summary API</a>で省略して消費者が読めるようにするものです。</p><p>1.23以前は、これらのリソースは主に<a href=https://github.com/google/cadvisor>cAdvisor</a>から収集されていました。しかし、1.23では<code>PodAndContainerStatsFromCRI</code>フィーチャーゲートの導入により、コンテナとPodレベルの統計情報をCRI実装で収集することができます。</p><p>注意: これはCRI実装によるサポートも必要です(containerd >= 1.6.0, CRI-O >= 1.23.0)。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cb9e28c208c6cfbabdb15ba2e42e9ef0>2 - リソース監視のためのツール</h1><p>アプリケーションを拡張し、信頼性の高いサービスを提供するために、デプロイ時にアプリケーションがどのように動作するかを理解する必要があります。
コンテナ、<a href=/docs/concepts/workloads/pods/>Pod</a>、<a href=/docs/concepts/services-networking/service/>Service</a>、クラスター全体の特性を調べることにより、Kubernetesクラスターのアプリケーションパフォーマンスを調査することができます。
Kubernetesは、これらの各レベルでアプリケーションのリソース使用に関する詳細な情報を提供します。
この情報により、アプリケーションのパフォーマンスを評価し、ボトルネックを取り除くことで全体のパフォーマンスを向上させることができます。</p><p>Kubernetesでは、アプリケーションの監視は1つの監視ソリューションに依存することはありません。
新しいクラスターでは、<a href=#resource-metrics-pipeline>リソースメトリクス</a>または<a href=#full-metrics-pipeline>フルメトリクス</a>パイプラインを使用してモニタリング統計を収集することができます。</p><h2 id=リソースメトリクスパイプライン>リソースメトリクスパイプライン</h2><p>リソースメトリックパイプラインは、<a href=/docs/tasks/run-application/horizontal-pod-autoscale/>Horizontal Pod Autoscaler</a>コントローラーなどのクラスターコンポーネントや、<code>kubectl top</code>ユーティリティに関連する限定的なメトリックセットを提供します。</p><p>これらのメトリクスは軽量、短期、インメモリーの<a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a>によって収集され、<code>metrics.k8s.io</code> APIを通じて公開されます。</p><p>metrics-serverはクラスター上のすべてのノードを検出し
各ノードの<a href=/docs/reference/command-line-tools-reference/kubelet/>kubelet</a>にCPUとメモリーの使用量を問い合わせます。</p><p>kubeletはKubernetesマスターとノードの橋渡し役として、マシン上で動作するPodやコンテナを管理する。
kubeletは各Podを構成するコンテナに変換し、コンテナランタイムインターフェースを介してコンテナランタイムから個々のコンテナ使用統計情報を取得します。この情報は、レガシーDocker統合のための統合cAdvisorから取得されます。</p><p>そして、集約されたPodリソース使用統計情報を、metrics-server Resource Metrics APIを通じて公開します。
このAPIは、kubeletの認証済みおよび読み取り専用ポート上の <code>/metrics/resource/v1beta1</code> で提供されます。</p><h2 id=フルメトリクスパイプライン>フルメトリクスパイプライン</h2><p>フルメトリクスパイプラインは、より豊富なメトリクスにアクセスすることができます。
Kubernetesは、Horizontal Pod Autoscalerなどのメカニズムを使用して、現在の状態に基づいてクラスターを自動的にスケールまたは適応させることによって、これらのメトリクスに対応することができます。
モニタリングパイプラインは、kubeletからメトリクスを取得し、<code>custom.metrics.k8s.io</code> または <code>external.metrics.k8s.io</code> APIを実装してアダプタ経由でKubernetesにそれらを公開します。
CNCFプロジェクトの<a href=https://prometheus.io>Prometheus</a>は、Kubernetes、ノード、Prometheus自身をネイティブに監視することができます。
CNCFに属さない完全なメトリクスパイプラインのプロジェクトは、Kubernetesのドキュメントの範囲外です。</p><h2 id=次の項目>次の項目</h2><p>以下のような追加のデバッグツールについて学びます:</p><ul><li><a href=/ja/docs/concepts/cluster-administration/logging/>ロギング</a></li><li><a href=/ja/docs/tasks/debug-application-cluster/resource-usage-monitoring/>モニタリング</a></li><li><a href=/ja/docs/tasks/debug-application-cluster/get-shell-running-container/><code>exec</code>でコンテナに入る</a></li><li><a href=/docs/tasks/extend-kubernetes/http-proxy-access-api/>Connecting to containers via proxies</a></li><li><a href=/docs/tasks/access-application-cluster/port-forward-access-application-cluster/>Connecting to containers via port forwarding</a></li><li><a href=/ja/docs/tasks/debug-application-cluster/crictl/>crictlでKubernetesのノードを検査する</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-20165c8269bed123bfb94fb6e7f85643>3 - ノードの健全性を監視します</h1><p><em>Node Problem Detector</em>は、ノードの健全性を監視し、報告するためのデーモンです。
<code>Node Problem Detector</code>は<code>DaemonSet</code>として、あるいはスタンドアロンデーモンとして実行することができます。</p><p><code>Node Problem Detector</code>は様々なデーモンからノードの問題に関する情報を収集し、これらの状態を<a href=/ja/docs/concepts/architecture/nodes/#condition>NodeCondition</a>および<a href=/docs/reference/generated/kubernetes-api/v1.25/#event-v1-core>Event</a>としてAPIサーバーにレポートします。
<code>Node Problem Detector</code>のインストール方法と使用方法については、<a href=https://github.com/kubernetes/node-problem-detector>Node Problem Detectorプロジェクトドキュメント</a>を参照してください。</p><h2 id=始める前に>始める前に</h2><p>Kubernetesクラスターが必要、かつそのクラスターと通信するためにkubectlコマンドラインツールが設定されている必要があります。
このチュートリアルは、コントロールプレーンのホストとして動作していない少なくとも2つのノードを持つクラスターで実行することをおすすめします。
まだクラスターがない場合、<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>を使って作成するか、
以下のいずれかのKubernetesプレイグラウンドも使用できます:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul><h2 id=制限事項>制限事項</h2><ul><li><p>Node Problem Detectorは、ファイルベースのカーネルログのみをサポートします。
<code>journald</code>のようなログツールはサポートされていません。</p></li><li><p>Node Problem Detectorは、カーネルの問題を報告するためにカーネルログフォーマットを使用します。
カーネルログフォーマットを拡張する方法については、<a href=#support-other-log-format>Add support for another log format</a> を参照してください。</p></li></ul><h2 id=ノード問題検出の有効化>ノード問題検出の有効化</h2><p>クラウドプロバイダーによっては、<code>Node Problem Detector</code>を<a class=glossary-tooltip title='Resources that extend the functionality of Kubernetes.' data-toggle=tooltip data-placement=top href=/docs/concepts/cluster-administration/addons/ target=_blank aria-label=Addon>Addon</a>として有効にしている場合があります。
また、<code>kubectl</code>を使って<code>Node Problem Detector</code>を有効にするか、<code>Addon pod</code>を作成することで有効にできます。</p><h3 id=using-kubectl>kubectlを使用してNode Problem Detectorを有効化します</h3><p><code>kubectl</code>は<code>Node Problem Detector</code>を最も柔軟に管理することができます。
デフォルトの設定を上書きして自分の環境に合わせたり、カスタマイズしたノードの問題を検出したりすることができます。
例えば:</p><ol><li><p><code>node-problem-detector.yaml</code>のような<code>Node Problem Detector</code>の設定を作成します:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/ja/examples/debug/node-problem-detector.yaml download=debug/node-problem-detector.yaml><code>debug/node-problem-detector.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("debug-node-problem-detector-yaml")' title="Copy debug/node-problem-detector.yaml to clipboard"></img></div><div class=includecode id=debug-node-problem-detector-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector-v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector  <span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>k8s.gcr.io/node-problem-detector:v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>privileged</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200m&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20m&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20Mi&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/log/</span></span></code></pre></div></div></div><div class="alert alert-info note callout" role=alert><strong>備考:</strong> システムログのディレクトリが、お使いのOSのディストリビューションに合っていることを確認する必要があります。</div></li><li><p><code>Node Problem Detector</code>を<code>kubectl</code>で起動します。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/debug/node-problem-detector.yaml
</span></span></code></pre></div></li></ol><h3 id=using-addon-pod>Addon podを使用してNode Problem Detectorを有効化します</h3><p>カスタムのクラスターブートストラップソリューションを使用していて、デフォルトの設定を上書きする必要がない場合は、<code>Addon Pod</code>を利用してデプロイをさらに自動化できます。
<code>node-problem-detector.yaml</code>を作成し、制御プレーンノードの<code>Addon Pod</code>のディレクトリ<code>/etc/kubernetes/addons/node-problem-detector</code>に設定を保存します。</p><h2 id=コンフィギュレーションを上書きします>コンフィギュレーションを上書きします</h2><p><code>Node Problem Detector</code>の Dockerイメージをビルドする際に、<a href=https://github.com/kubernetes/node-problem-detector/tree/v0.1/config>default configuration</a>が埋め込まれます。</p><p><a href=/ja/docs/tasks/configure-pod-container/configure-pod-configmap/><code>ConfigMap</code></a> を使用することで設定を上書きすることができます。</p><ol><li><p><code>config/</code> にある設定ファイルを変更します</p></li><li><p><code>ConfigMap</code> <code>node-problem-detector-config</code>を作成します。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create configmap node-problem-detector-config --from-file<span style=color:#666>=</span>config/
</span></span></code></pre></div></li><li><p><code>node-problem-detector.yaml</code>を変更して、<code>ConfigMap</code>を使用するようにします。</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/ja/examples/debug/node-problem-detector-configmap.yaml download=debug/node-problem-detector-configmap.yaml><code>debug/node-problem-detector-configmap.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("debug-node-problem-detector-configmap-yaml")' title="Copy debug/node-problem-detector-configmap.yaml to clipboard"></img></div><div class=includecode id=debug-node-problem-detector-configmap-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector-v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector  <span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>k8s.gcr.io/node-problem-detector:v0.1<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>privileged</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;200m&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;100Mi&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20m&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;20Mi&#34;</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Overwrite the config/ directory with ConfigMap volume</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/config<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>log<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/log/<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config<span style=color:#bbb> </span><span style=color:#080;font-style:italic># Define ConfigMap volume</span><span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
   </span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>node-problem-detector-config</span></span></code></pre></div></div></div></li><li><p>新しい設定ファイルで<code>Node Problem Detector</code>を再作成します。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># If you have a node-problem-detector running, delete before recreating</span>
</span></span><span style=display:flex><span>kubectl delete -f https://k8s.io/examples/debug/node-problem-detector.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/debug/node-problem-detector-configmap.yaml
</span></span></code></pre></div></li></ol><div class="alert alert-info note callout" role=alert><strong>備考:</strong> この方法は <code>kubectl</code> で起動された Node Problem Detector にのみ適用されます。</div><p>ノード問題検出装置がクラスターアドオンとして実行されている場合、設定の上書きはサポートされていません。
<code>Addon Manager</code>は、<code>ConfigMap</code>をサポートしていません。</p><h2 id=kernel-monitor>Kernel Monitor</h2><p><em>Kernel Monitor</em>は<code>Node Problem Detector</code>でサポートされるシステムログ監視デーモンです。
<em>Kernel Monitor</em>はカーネルログを監視し、事前に定義されたルールに従って既知のカーネル問題を検出します。
<em>Kernel Monitor</em>は<a href=https://github.com/kubernetes/node-problem-detector/blob/v0.1/config/kernel-monitor.json><code>config/kernel-monitor.json</code></a>にある一連の定義済みルールリストに従ってカーネルの問題を照合します。
ルールリストは拡張可能です。設定を上書きすることで、ルールリストを拡張することができます。</p><h3 id=新しいnodeconditionsの追加>新しいNodeConditionsの追加</h3><p>新しい<code>NodeCondition</code>をサポートするには、例えば<code>config/kernel-monitor.json</code>の<code>conditions</code>フィールド内に条件定義を作成します。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;type&#34;</span>: <span style=color:#b44>&#34;NodeConditionType&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;reason&#34;</span>: <span style=color:#b44>&#34;CamelCaseDefaultNodeConditionReason&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;message&#34;</span>: <span style=color:#b44>&#34;arbitrary default node condition message&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=新たな問題の発見>新たな問題の発見</h3><p>新しい問題を検出するために、<code>config/kernel-monitor.json</code>の<code>rules</code>フィールドを新しいルール定義で拡張することができます。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;type&#34;</span>: <span style=color:#b44>&#34;temporary/permanent&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;condition&#34;</span>: <span style=color:#b44>&#34;NodeConditionOfPermanentIssue&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;reason&#34;</span>: <span style=color:#b44>&#34;CamelCaseShortReason&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;message&#34;</span>: <span style=color:#b44>&#34;regexp matching the issue in the kernel log&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=kernel-log-device-path>カーネルログデバイスのパスの設定</h3><p>ご使用のオペレーティングシステム(OS)ディストリビューションのカーネルログパスをご確認ください。
Linuxカーネルの<a href=https://www.kernel.org/doc/Documentation/ABI/testing/dev-kmsg>ログデバイス</a>は通常<code>/dev/kmsg</code>として表示されます。
しかし、OSのディストリビューションによって、ログパスの位置は異なります。
<code>config/kernel-monitor.json</code>の<code>log</code>フィールドは、コンテナ内のログパスを表します。
<code>log</code>フィールドは、<code>Node Problem Detector</code>で見たデバイスパスと一致するように設定することができます。</p><h3 id=support-other-log-format>別のログ形式をサポートします</h3><p>Kernel monitorは<a href=https://github.com/kubernetes/node-problem-detector/blob/v0.1/pkg/kernelmonitor/translator/translator.go><code>Translator</code></a>プラグインを使用して、カーネルログの内部データ構造を変換します。
新しいログフォーマット用に新しいトランスレータを実装することができます。</p><h2 id=推奨-制限事項>推奨・制限事項</h2><p>ノードの健全性を監視するために、クラスターでNode Problem Detectorを実行することが推奨されます。
<code>Node Problem Detector</code>を実行する場合、各ノードで余分なリソースのオーバーヘッドが発生することが予想されます。</p><p>通常これは問題ありません。</p><ul><li>カーネルログは比較的ゆっくりと成長します。</li><li>Node Problem Detector にはリソース制限が設定されています。</li><li>高負荷時であっても、リソースの使用は許容範囲内です。</li></ul><p>詳細は<code>Node Problem Detector</code><a href=https://github.com/kubernetes/node-problem-detector/issues/2#issuecomment-220255629>ベンチマーク結果</a>を参照してください。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6ca4f22ef4d1713577ada4815f0a3b5a>4 - crictlによるKubernetesノードのデバッグ</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.11 [stable]</code></div><p><code>crictl</code>はCRI互換のコンテナランタイム用のコマンドラインインターフェイスです。</p><p>これを使って、Kubernetesノード上のコンテナランタイムやアプリケーションの検査やデバッグを行うことができます。
<code>crictl</code>とそのソースコードは<a href=https://github.com/kubernetes-sigs/cri-tools>cri-tools</a>リポジトリにホストされています。</p><h2 id=始める前に>始める前に</h2><p><code>crictl</code>にはCRIランタイムを搭載したLinuxが必要です。</p><h2 id=crictlのインストール>crictlのインストール</h2><p>cri-toolsの<a href=https://github.com/kubernetes-sigs/cri-tools/releases>リリースページ</a>から、いくつかの異なるアーキテクチャ用の圧縮アーカイブ<code>crictl</code>をダウンロードできます。</p><p>お使いのKubernetesのバージョンに対応するバージョンをダウンロードしてください。
それを解凍してシステムパス上の<code>/usr/local/bin/</code>などの場所に移動します。</p><h2 id=一般的な使い方>一般的な使い方</h2><p><code>crictl</code>コマンドにはいくつかのサブコマンドとランタイムフラグがあります。
詳細は<code>crictl help</code>または<code>crictl &lt;subcommand> help</code>を参照してください。
<code>crictl</code>はデフォルトでは<code>unix:///var/run/dockershim.sock</code>に接続します。</p><p>他のランタイムの場合は、複数の異なる方法でエンドポイントを設定することができます:</p><ul><li>フラグ<code>--runtime-endpoint</code>と<code>--image-endpoint</code>の設定により</li><li>環境変数<code>CONTAINER_RUNTIME_ENDPOINT</code>と<code>IMAGE_SERVICE_ENDPOINT</code>の設定により</li><li>設定ファイル<code>--config=/etc/crictl.yaml</code>でエンドポイントの設定により</li></ul><p>また、サーバーに接続する際のタイムアウト値を指定したり、デバッグを有効／無効にしたりすることもできます。
これには、設定ファイルで<code>timeout</code>や<code>debug</code>を指定するか、<code>--timeout</code>や<code>--debug</code>のコマンドラインフラグを使用します。</p><p>現在の設定を表示または編集するには、<code>/etc/crictl.yaml</code>の内容を表示または編集します。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat /etc/crictl.yaml
</span></span><span style=display:flex><span>runtime-endpoint: unix:///var/run/dockershim.sock
</span></span><span style=display:flex><span>image-endpoint: unix:///var/run/dockershim.sock
</span></span><span style=display:flex><span>timeout: <span style=color:#666>10</span>
</span></span><span style=display:flex><span>debug: <span style=color:#a2f>true</span>
</span></span></code></pre></div><h2 id=crictlコマンドの例>crictlコマンドの例</h2><p>以下の例では、いくつかの<code>crictl</code>コマンドとその出力例を示しています。</p><div class="alert alert-danger warning callout" role=alert><strong>警告:</strong> 実行中のKubernetesクラスターに<code>crictl</code>を使ってポッドのサンドボックスやコンテナを作成しても、Kubeletは最終的にそれらを削除します。<code>crictl</code> は汎用のワークフローツールではなく、デバッグに便利なツールです。</div><h3 id=podsの一覧>podsの一覧</h3><p>すべてのポッドをリストアップ:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl pods
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>POD ID              CREATED              STATE               NAME                         NAMESPACE           ATTEMPT
926f1b5a1d33a       About a minute ago   Ready               sh-84d7dcf559-4r2gq          default             0
4dccb216c4adb       About a minute ago   Ready               nginx-65899c769f-wv2gp       default             0
a86316e96fa89       17 hours ago         Ready               kube-proxy-gblk4             kube-system         0
919630b8f81f1       17 hours ago         Ready               nvidia-device-plugin-zgbbv   kube-system         0
</code></pre><p>Podを名前でリストアップします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl pods --name nginx-65899c769f-wv2gp
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>POD ID              CREATED             STATE               NAME                     NAMESPACE           ATTEMPT
4dccb216c4adb       2 minutes ago       Ready               nginx-65899c769f-wv2gp   default             0
</code></pre><p>Podをラベルでリストアップします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl pods --label <span style=color:#b8860b>run</span><span style=color:#666>=</span>nginx
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>POD ID              CREATED             STATE               NAME                     NAMESPACE           ATTEMPT
4dccb216c4adb       2 minutes ago       Ready               nginx-65899c769f-wv2gp   default             0
</code></pre><h3 id=イメージの一覧>イメージの一覧</h3><p>すべてのイメージをリストアップします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl images
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>IMAGE                                     TAG                 IMAGE ID            SIZE
busybox                                   latest              8c811b4aec35f       1.15MB
k8s-gcrio.azureedge.net/hyperkube-amd64   v1.10.3             e179bbfe5d238       665MB
k8s-gcrio.azureedge.net/pause-amd64       3.1                 da86e6ba6ca19       742kB
nginx                                     latest              cd5239a0906a6       109MB
</code></pre><p>イメージをリポジトリでリストアップします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl images nginx
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>IMAGE               TAG                 IMAGE ID            SIZE
nginx               latest              cd5239a0906a6       109MB
</code></pre><p>イメージのIDのみをリストアップします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl images -q
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>sha256:8c811b4aec35f259572d0f79207bc0678df4c736eeec50bc9fec37ed936a472a
sha256:e179bbfe5d238de6069f3b03fccbecc3fb4f2019af741bfff1233c4d7b2970c5
sha256:da86e6ba6ca197bf6bc5e9d900febd906b133eaa4750e6bed647b0fbe50ed43e
sha256:cd5239a0906a6ccf0562354852fae04bc5b52d72a2aff9a871ddb6bd57553569
</code></pre><h3 id=list-containers>List containers</h3><p>すべてのコンテナをリストアップします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl ps -a
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>CONTAINER ID        IMAGE                                                                                                             CREATED             STATE               NAME                       ATTEMPT
1f73f2d81bf98       busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47                                   7 minutes ago       Running             sh                         1
9c5951df22c78       busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47                                   8 minutes ago       Exited              sh                         0
87d3992f84f74       nginx@sha256:d0a8828cccb73397acb0073bf34f4d7d8aa315263f1e7806bf8c55d8ac139d5f                                     8 minutes ago       Running             nginx                      0
1941fb4da154f       k8s-gcrio.azureedge.net/hyperkube-amd64@sha256:00d814b1f7763f4ab5be80c58e98140dfc69df107f253d7fdd714b30a714260a   18 hours ago        Running             kube-proxy                 0
</code></pre><p>ランニングコンテナをリストアップします:</p><pre tabindex=0><code>crictl ps
</code></pre><p>出力はこのようになります:</p><pre tabindex=0><code>CONTAINER ID        IMAGE                                                                                                             CREATED             STATE               NAME                       ATTEMPT
1f73f2d81bf98       busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47                                   6 minutes ago       Running             sh                         1
87d3992f84f74       nginx@sha256:d0a8828cccb73397acb0073bf34f4d7d8aa315263f1e7806bf8c55d8ac139d5f                                     7 minutes ago       Running             nginx                      0
1941fb4da154f       k8s-gcrio.azureedge.net/hyperkube-amd64@sha256:00d814b1f7763f4ab5be80c58e98140dfc69df107f253d7fdd714b30a714260a   17 hours ago        Running             kube-proxy                 0
</code></pre><h3 id=実行中のコンテナでコマンドの実行>実行中のコンテナでコマンドの実行</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl <span style=color:#a2f>exec</span> -i -t 1f73f2d81bf98 ls
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>bin   dev   etc   home  proc  root  sys   tmp   usr   var
</code></pre><h3 id=コンテナログの取得>コンテナログの取得</h3><p>すべてのコンテナログを取得します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl logs 87d3992f84f74
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>10.240.0.96 - - [06/Jun/2018:02:45:49 +0000] &#34;GET / HTTP/1.1&#34; 200 612 &#34;-&#34; &#34;curl/7.47.0&#34; &#34;-&#34;
10.240.0.96 - - [06/Jun/2018:02:45:50 +0000] &#34;GET / HTTP/1.1&#34; 200 612 &#34;-&#34; &#34;curl/7.47.0&#34; &#34;-&#34;
10.240.0.96 - - [06/Jun/2018:02:45:51 +0000] &#34;GET / HTTP/1.1&#34; 200 612 &#34;-&#34; &#34;curl/7.47.0&#34; &#34;-&#34;
</code></pre><p>最新の<code>N</code>行のログのみを取得します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl logs --tail<span style=color:#666>=</span><span style=color:#666>1</span> 87d3992f84f74
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>10.240.0.96 - - [06/Jun/2018:02:45:51 +0000] &#34;GET / HTTP/1.1&#34; 200 612 &#34;-&#34; &#34;curl/7.47.0&#34; &#34;-&#34;
</code></pre><h3 id=podサンドボックスの実行>Podサンドボックスの実行</h3><p><code>crictl</code>を使ってPodサンドボックスを実行することは、コンテナのランタイムをデバッグするのに便利です。
稼働中のKubernetesクラスタでは、サンドボックスは最終的にKubeletによって停止され、削除されます。</p><ol><li><p>以下のようなJSONファイルを作成します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#b44>&#34;nginx-sandbox&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;namespace&#34;</span>: <span style=color:#b44>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;attempt&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;uid&#34;</span>: <span style=color:#b44>&#34;hdishd83djaidwnduwk28bcsb&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;logDirectory&#34;</span>: <span style=color:#b44>&#34;/tmp&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;linux&#34;</span>: {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>JSONを適用してサンドボックスを実行するには、<code>crictl runp</code>コマンドを使用します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl runp pod-config.json
</span></span></code></pre></div><p>サンドボックスのIDが返されます。</p></li></ol><h3 id=コンテナの作成>コンテナの作成</h3><p>コンテナの作成に<code>crictl</code>を使うと、コンテナのランタイムをデバッグするのに便利です。
稼働中のKubernetesクラスタでは、サンドボックスは最終的にKubeletによって停止され、削除されます。</p><ol><li><p>busyboxイメージをプルします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl pull busybox
</span></span><span style=display:flex><span>Image is up to date <span style=color:#a2f;font-weight:700>for</span> busybox@sha256:141c253bc4c3fd0a201d32dc1f493bcf3fff003b6df416dea4f41046e0f37d47
</span></span></code></pre></div></li><li><p>Podとコンテナのコンフィグを作成します:</p><p><strong>Pod config</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;nginx-sandbox&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;attempt&#34;: </span><span style=color:#666>1</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;hdishd83djaidwnduwk28bcsb&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;log_directory&#34;: </span><span style=color:#b44>&#34;/tmp&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;linux&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><strong>Container config</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;busybox&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#b44>&#34;image&#34;</span>:{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;image&#34;: </span><span style=color:#b44>&#34;busybox&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;command&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#b44>&#34;top&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>],<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#b44>&#34;log_path&#34;</span>:<span style=color:#b44>&#34;busybox.log&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;linux&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></li><li><p>先に作成されたPodのID、コンテナの設定ファイル、Podの設定ファイルを渡して、コンテナを作成します。コンテナのIDが返されます。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl create f84dd361f8dc51518ed291fbadd6db537b0496536c1d2d6c05ff943ce8c9a54f container-config.json pod-config.json
</span></span></code></pre></div></li><li><p>すべてのコンテナをリストアップし、新しく作成されたコンテナの状態が<code>Created</code>に設定されていることを確認します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl ps -a
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>CONTAINER ID        IMAGE               CREATED             STATE               NAME                ATTEMPT
3e025dd50a72d       busybox             32 seconds ago      Created             busybox             0
</code></pre></li></ol><h3 id=コンテナの起動>コンテナの起動</h3><p>コンテナを起動するには、そのコンテナのIDを<code>crictl start</code>に渡します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl start 3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>3e025dd50a72d956c4f14881fbb5b1080c9275674e95fb67f965f6478a957d60
</code></pre><p>コンテナの状態が「Running」に設定されていることを確認します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>crictl ps
</span></span></code></pre></div><p>出力はこのようになります:</p><pre tabindex=0><code>CONTAINER ID        IMAGE               CREATED              STATE               NAME                ATTEMPT
3e025dd50a72d       busybox             About a minute ago   Running             busybox             0
</code></pre><p>詳しくは<a href=https://github.com/kubernetes-sigs/cri-tools>kubernetes-sigs/cri-tools</a>をご覧ください。</p><h2 id=docker-cliからcrictlへのマッピング>docker cliからcrictlへのマッピング</h2><p>以下のマッピング表の正確なバージョンは、<code>docker cli v1.40</code>と<code>crictl v1.19.0</code>のものです。
この一覧はすべてを網羅しているわけではないことに注意してください。
たとえば、<code>docker cli</code>の実験的なコマンドは含まれていません。</p><div class="alert alert-info note callout" role=alert><strong>備考:</strong> CRICTLの出力形式はDocker CLIと似ていますが、いくつかのCLIでは列が欠けています。</div><h3 id=デバッグ情報の取得>デバッグ情報の取得</h3><table><caption style=display:none>mapping from docker cli to crictl - retrieve debugging information</caption><thead><tr><th>docker cli</th><th>crictl</th><th>説明</th><th>サポートされていない機能</th></tr></thead><tbody><tr><td><code>attach</code></td><td><code>attach</code></td><td>実行中のコンテナにアタッチ</td><td><code>--detach-keys</code>, <code>--sig-proxy</code></td></tr><tr><td><code>exec</code></td><td><code>exec</code></td><td>実行中のコンテナでコマンドの実行</td><td><code>--privileged</code>, <code>--user</code>, <code>--detach-keys</code></td></tr><tr><td><code>images</code></td><td><code>images</code></td><td>イメージのリストアップ</td><td> </td></tr><tr><td><code>info</code></td><td><code>info</code></td><td>システム全体の情報の表示</td><td> </td></tr><tr><td><code>inspect</code></td><td><code>inspect</code>, <code>inspecti</code></td><td>コンテナ、イメージ、タスクの低レベルの情報を返します</td><td> </td></tr><tr><td><code>logs</code></td><td><code>logs</code></td><td>コンテナのログを取得します</td><td><code>--details</code></td></tr><tr><td><code>ps</code></td><td><code>ps</code></td><td>コンテナのリストアップ</td><td> </td></tr><tr><td><code>stats</code></td><td><code>stats</code></td><td>コンテナのリソース使用状況をライブで表示</td><td>Column: NET/BLOCK I/O, PIDs</td></tr><tr><td><code>version</code></td><td><code>version</code></td><td>ランタイム(Docker、ContainerD、その他)のバージョン情報を表示します</td><td> </td></tr></tbody></table><h3 id=変更を行います>変更を行います</h3><table><caption style=display:none>mapping from docker cli to crictl - perform changes</caption><thead><tr><th>docker cli</th><th>crictl</th><th>説明</th><th>サポートされていない機能</th></tr></thead><tbody><tr><td><code>create</code></td><td><code>create</code></td><td>新しいコンテナを作成します</td><td> </td></tr><tr><td><code>kill</code></td><td><code>stop</code> (timeout = 0)</td><td>1つ以上の実行中のコンテナを停止します</td><td><code>--signal</code></td></tr><tr><td><code>pull</code></td><td><code>pull</code></td><td>レジストリーからイメージやリポジトリをプルします</td><td><code>--all-tags</code>, <code>--disable-content-trust</code></td></tr><tr><td><code>rm</code></td><td><code>rm</code></td><td>1つまたは複数のコンテナを削除します</td><td> </td></tr><tr><td><code>rmi</code></td><td><code>rmi</code></td><td>1つまたは複数のイメージを削除します</td><td> </td></tr><tr><td><code>run</code></td><td><code>run</code></td><td>新しいコンテナでコマンドを実行</td><td> </td></tr><tr><td><code>start</code></td><td><code>start</code></td><td>停止した1つまたは複数のコンテナを起動</td><td><code>--detach-keys</code></td></tr><tr><td><code>stop</code></td><td><code>stop</code></td><td>実行中の1つまたは複数のコンテナの停止</td><td> </td></tr><tr><td><code>update</code></td><td><code>update</code></td><td>1つまたは複数のコンテナの構成を更新</td><td><code>--restart</code>、<code>--blkio-weight</code>とその他</td></tr></tbody></table><h3 id=crictlでのみ対応>crictlでのみ対応</h3><table><caption style=display:none>mapping from docker cli to crictl - supported only in crictl</caption><thead><tr><th>crictl</th><th>説明</th></tr></thead><tbody><tr><td><code>imagefsinfo</code></td><td>イメージファイルシステムの情報を返します</td></tr><tr><td><code>inspectp</code></td><td>1つまたは複数のPodの状態を表示します</td></tr><tr><td><code>port-forward</code></td><td>ローカルポートをPodに転送します</td></tr><tr><td><code>runp</code></td><td>新しいPodを実行します</td></tr><tr><td><code>rmp</code></td><td>1つまたは複数のPodを削除します</td></tr><tr><td><code>stopp</code></td><td>稼働中の1つまたは複数のPodを停止します</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-60dca0ec8d41f0045e7d73e1d6bd7bce>5 - テレプレゼンスを使用したローカルでのサービス開発・デバッグ</h1><p>Kubernetesアプリケーションは通常、複数の独立したサービスから構成され、それぞれが独自のコンテナで動作しています。これらのサービスをリモートのKubernetesクラスター上で開発・デバッグするには、<a href=/docs/task/debug-application-cluster/get-shell-running-container/>get a shell on a running container</a>してリモートシェル内でツールを実行しなければならず面倒な場合があります。</p><p><code>telepresence</code>は、リモートKubernetesクラスターにサービスをプロキシーしながら、ローカルでサービスを開発・デバッグするプロセスを容易にするためのツールです。
<code>telepresence</code> を使用すると、デバッガーやIDEなどのカスタムツールをローカルサービスで使用でき、ConfigMapやsecret、リモートクラスター上で動作しているサービスへのフルアクセスをサービスに提供します。</p><p>このドキュメントでは、リモートクラスタ上で動作しているサービスをローカルで開発・デバッグするために<code>telepresence</code>を使用する方法を説明します。</p><h2 id=始める前に>始める前に</h2><ul><li>Kubernetesクラスターがインストールされていること</li><li>クラスターと通信するために <code>kubectl</code> が設定されていること</li><li><a href=https://www.telepresence.io/reference/install>telepresence</a>がインストールされていること</li></ul><h2 id=リモートクラスター上でシェルの取得>リモートクラスター上でシェルの取得</h2><p>ターミナルを開いて、引数なしで<code>telepresence</code>を実行すると、<code>telepresence</code>シェルが表示されます。
このシェルはローカルで動作し、ローカルのファイルシステムに完全にアクセスすることができます。</p><p>この<code>telepresence</code>シェルは様々な方法で使用することができます。
例えば、ラップトップでシェルスクリプトを書いて、それをシェルから直接リアルタイムで実行することができます。これはリモートシェルでもできますが、好みのコードエディターが使えないかもしれませんし、コンテナが終了するとスクリプトは削除されます。</p><p>終了してシェルを閉じるには<code>exit</code>と入力してください。</p><h2 id=既存サービスの開発-デバッグ>既存サービスの開発・デバッグ</h2><p>Kubernetes上でアプリケーションを開発する場合、通常は1つのサービスをプログラミングまたはデバッグすることになります。
そのサービスは、テストやデバッグのために他のサービスへのアクセスを必要とする場合があります。
継続的なデプロイメントパイプラインを使用することも一つの選択肢ですが、最速のデプロイメントパイプラインでさえ、プログラムやデバッグサイクルに遅延が発生します。</p><p>既存のデプロイメントとtelepresenceプロキシーを交換するには、<code>--swap-deployment</code> オプションを使用します。
スワップすることで、ローカルでサービスを実行し、リモートのKubernetesクラスターに接続することができます。
リモートクラスター内のサービスは、ローカルで実行されているインスタンスにアクセスできるようになりました。</p><p>telepresenceを「--swap-deployment」で実行するには、次のように入力します。</p><p><code>telepresence --swap-deployment $DEPLOYMENT_NAME</code></p><p>ここで、$DEPLOYMENT_NAMEは既存のDeploymentの名前です。</p><p>このコマンドを実行すると、シェルが起動します。そのシェルで、サービスを起動します。
そして、ローカルでソースコードの編集を行い、保存すると、すぐに変更が反映されるのを確認できます。
また、デバッガーやその他のローカルな開発ツールでサービスを実行することもできます。</p><h2 id=次の項目>次の項目</h2><p>もしハンズオンのチュートリアルに興味があるなら、Google Kubernetes Engine上でGuestbookアプリケーションをローカルに開発する手順を説明した<a href=https://cloud.google.com/community/tutorials/developing-services-with-k8s>こちらのチュートリアル</a>をチェックしてみてください。</p><p>telepresenceには、状況に応じて<a href=https://www.telepresence.io/reference/methods>numerous proxying options</a>があります。</p><p>さらに詳しい情報は、<a href=https://www.telepresence.io>telepresence website</a>をご覧ください。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-38387ad04dd284933cb502944ea3515b>6 - 監査</h1><p>Kubernetesの監査はクラスター内の一連の行動を記録するセキュリティに関連した時系列の記録を提供します。
クラスターはユーザー、Kubernetes APIを使用するアプリケーション、
およびコントロールプレーン自体によって生成されたアクティビティなどを監査します。</p><p>監査により、クラスター管理者は以下の質問に答えることができます:</p><ul><li>何が起きたのか？</li><li>いつ起こったのか？</li><li>誰がそれを始めたのか？</li><li>何のために起こったのか？</li><li>それはどこで観察されたのか？</li><li>それはどこから始まったのか？</li><li>それはどこへ向かっていたのか？</li></ul><p>監査記録のライフサイクルは<a href=/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver</a>コンポーネントの中で始まります。
各リクエストの実行の各段階で、監査イベントが生成されます。
ポリシーに従って前処理され、バックエンドに書き込まれます。 ポリシーが何を記録するかを決定し、
バックエンドがその記録を永続化します。現在のバックエンドの実装はログファイルやWebhookなどがあります。</p><p>各リクエストは関連する <em>stage</em> で記録されます。
定義されたステージは以下の通りです:</p><ul><li><code>RequestReceived</code> - 監査ハンドラーがリクエストを受信すると同時に生成されるイベントのステージ。
つまり、ハンドラーチェーンに委譲される前に生成されるイベントのステージです。</li><li><code>ResponseStarted</code> - レスポンスヘッダーが送信された後、レスポンスボディが送信される前のステージです。
このステージは長時間実行されるリクエスト(watchなど)でのみ発生します。</li><li><code>ResponseComplete</code> - レスポンスボディの送信が完了して、それ以上のバイトは送信されません。</li><li><code>Panic</code> - パニックが起きたときに発生するイベント。</li></ul><div class="alert alert-info note callout" role=alert><strong>備考:</strong> <a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Event>Audit Event configuration</a>の設定は<a href=/docs/reference/generated/kubernetes-api/v1.25/#event-v1-core>Event</a>APIオブジェクトとは異なります。</div><p>監査ログ機能は、リクエストごとに監査に必要なコンテキストが保存されるため、APIサーバーのメモリー消費量が増加します。
メモリーの消費量は、監査ログ機能の設定によって異なります。</p><h2 id=監査ポリシー>監査ポリシー</h2><p>監査ポリシーはどのようなイベントを記録し、どのようなデータを含むべきかについてのルールを定義します。
監査ポリシーのオブジェクト構造は、<a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy><code>audit.k8s.io</code> API group</a>で定義されています。</p><p>イベントが処理されると、そのイベントは順番にルールのリストと比較されます。
最初のマッチングルールは、イベントの監査レベルを設定します。</p><p>定義されている監査レベルは:</p><ul><li><code>None</code> - ルールに一致するイベントを記録しません。</li><li><code>Metadata</code> - リクエストのメタデータ(リクエストしたユーザー、タイムスタンプ、リソース、動作など)を記録しますが、リクエストやレスポンスのボディは記録しません。</li><li><code>Request</code> - ログイベントのメタデータとリクエストボディは表示されますが、レスポンスボディは表示されません。
これは非リソースリクエストには適用されません。</li><li><code>RequestResponse</code> - イベントのメタデータ、リクエストとレスポンスのボディを記録しますが、
非リソースリクエストには適用されません。</li></ul><p><code>audit-policy-file</code>フラグを使って、ポリシーを記述したファイルを <code>kube-apiserver</code>に渡すことができます。
このフラグが省略された場合イベントは記録されません。
監査ポリシーファイルでは、<code>rules</code>フィールドが必ず指定されることに注意してください。
ルールがない(0)ポリシーは不当なものとして扱われます。</p><p>以下は監査ポリシーファイルの例です:</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/ja/examples/audit/audit-policy.yaml download=audit/audit-policy.yaml><code>audit/audit-policy.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("audit-audit-policy-yaml")' title="Copy audit/audit-policy.yaml to clipboard"></img></div><div class=includecode id=audit-audit-policy-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>audit.k8s.io/v1<span style=color:#bbb> </span><span style=color:#080;font-style:italic># This is required.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Policy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Don&#39;t generate audit events for all requests in RequestReceived stage.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>omitStages</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:#b44>&#34;RequestReceived&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log pod changes at RequestResponse level</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>RequestResponse<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Resource &#34;pods&#34; doesn&#39;t match requests to any subresource of pods,</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># which is consistent with the RBAC policy.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;pods&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log &#34;pods/log&#34;, &#34;pods/status&#34; at Metadata level</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Metadata<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;pods/log&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;pods/status&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Don&#39;t log requests to a configmap called &#34;controller-leader&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;configmaps&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resourceNames</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;controller-leader&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Don&#39;t log watch requests by the &#34;system:kube-proxy&#34; on endpoints or services</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;system:kube-proxy&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;watch&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># core API group</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;endpoints&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;services&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Don&#39;t log authenticated requests to certain non-resource URL paths.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>userGroups</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;system:authenticated&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>nonResourceURLs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;/api*&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># Wildcard matching.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;/version&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log the request body of configmap changes in kube-system.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Request<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># core API group</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;configmaps&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This rule only applies to resources in the &#34;kube-system&#34; namespace.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># The empty string &#34;&#34; can be used to select non-namespaced resources.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespaces</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;kube-system&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log configmap and secret changes in all other namespaces at the Metadata level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Metadata<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># core API group</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;secrets&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;configmaps&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Log all other resources in core and extensions at the Request level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Request<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># core API group</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;extensions&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># Version of group should NOT be included.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># A catch-all rule to log all other requests at the Metadata level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Metadata<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Long-running requests like watches that fall under this rule will not</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># generate an audit event in RequestReceived.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>omitStages</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;RequestReceived&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>最小限の監査ポリシーファイルを使用して、すべてのリクエストを <code>Metadata</code>レベルで記録することができます。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Log all requests at the Metadata level.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>audit.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Policy<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>level</span>:<span style=color:#bbb> </span>Metadata<span style=color:#bbb>
</span></span></span></code></pre></div><p>独自の監査プロファイルを作成する場合は、Google Container-Optimized OSの監査プロファイルを出発点として使用できます。
監査ポリシーファイルを生成する<a href=https://github.com/kubernetes/kubernetes/blob/master/cluster/gce/gci/configure-helper.sh>configure-helper.sh</a>スクリプトを確認することができます。
スクリプトを直接見ることで、監査ポリシーファイルのほとんどを見ることができます。</p><p>また、定義されているフィールドの詳細については、<a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy>Policy` configuration reference</a>を参照できます。</p><h2 id=監査バックエンド>監査バックエンド</h2><p>監査バックエンドは監査イベントを外部ストレージに永続化します。
kube-apiserverには2つのバックエンドが用意されています。</p><ul><li>イベントをファイルシステムに書き込むログバックエンド</li><li>外部のHTTP APIにイベントを送信するWebhookバックエンド</li></ul><p>いずれの場合も、監査イベントはKubernetes API<a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Event><code>audit.k8s.io</code> API group</a>で定義されている構造に従います。</p><div class="alert alert-info note callout" role=alert><strong>備考:</strong><p>パッチの場合、リクエストボディはパッチ操作を含むJSON配列であり、適切なKubernetes APIオブジェクトを含むJSONオブジェクトではありません。
例えば、以下のリクエストボディは<code>/apis/batch/v1/namespaces/some-namespace/jobs/some-job-name</code>に対する有効なパッチリクエストです。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;op&#34;</span>: <span style=color:#b44>&#34;replace&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;path&#34;</span>: <span style=color:#b44>&#34;/spec/parallelism&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;value&#34;</span>: <span style=color:#666>0</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;op&#34;</span>: <span style=color:#b44>&#34;remove&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;path&#34;</span>: <span style=color:#b44>&#34;/spec/template/spec/containers/0/terminationMessagePolicy&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div></div><h3 id=ログバックエンド>ログバックエンド</h3><p>ログバックエンドは監査イベントを<a href=https://jsonlines.org/>JSONlines</a>形式のファイルに書き込みます。
以下の <code>kube-apiserver</code> フラグを使ってログ監査バックエンドを設定できます。</p><ul><li><code>--audit-log-path</code> は、ログバックエンドが監査イベントを書き込む際に使用するログファイルのパスを指定します。
このフラグを指定しないと、ログバックエンドは無効になります。<code>-</code> は標準出力を意味します。</li><li><code>--audit-log-maxage</code> は、古い監査ログファイルを保持する最大日数を定義します。</li><li><code>audit-log-maxbackup</code>は、保持する監査ログファイルの最大数を定義します。</li><li><code>--audit-log-maxsize</code> は、監査ログファイルがローテーションされるまでの最大サイズをメガバイト単位で定義します。</li></ul><p>クラスターのコントロールプレーンでkube-apiserverをPodとして動作させている場合は、監査記録が永久化されるように、ポリシーファイルとログファイルの場所に<code>hostPath</code>をマウントすることを忘れないでください。
例えば:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>    --audit-policy-file<span style=color:#666>=</span>/etc/kubernetes/audit-policy.yaml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --audit-log-path<span style=color:#666>=</span>/var/log/audit.log
</span></span></code></pre></div><p>それからボリュームをマウントします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/audit-policy.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/log/audit.log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit-log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>最後に<code>hostPath</code>を設定します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/audit-policy.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>File<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit-log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/var/log/audit.log<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>FileOrCreate<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=webhookバックエンド>Webhookバックエンド</h3><p>Webhook監査バックエンドは、監査イベントをリモートのWeb APIに送信しますが、
これは認証手段を含むKubernetes APIの形式であると想定されます。</p><p>Webhook監査バックエンドを設定するには、以下のkube-apiserverフラグを使用します。</p><ul><li><code>--audit-webhook-config-file</code> は、Webhookの設定ファイルのパスを指定します。
webhookの設定は、事実上特化した<a href=/docs/tasks/access-application-cluster/configure-access-multiple-clusters>kubeconfig</a>です。</li><li><code>--audit-webhook-initial-backoff</code> は、最初に失敗したリクエストの後、再試行するまでに待つ時間を指定します。
それ以降のリクエストは、指数関数的なバックオフで再試行されます。</li></ul><p>Webhookの設定ファイルは、kubeconfig形式でサービスのリモートアドレスと接続に使用する認証情報を指定します。</p><h2 id=batching>イベントバッチ</h2><p>ログバックエンドとwebhookバックエンドの両方がバッチ処理をサポートしています。
webhookを例に、利用可能なフラグの一覧を示します。
ログバックエンドで同じフラグを取得するには、フラグ名の<code>webhook</code>を<code>log</code>に置き換えてください。
デフォルトでは、バッチングは<code>webhook</code>では有効で、<code>log</code>では無効です。
同様に、デフォルトではスロットリングは <code>webhook</code> で有効で、<code>log</code>では無効です。</p><ul><li><code>--audit-webhook-mode</code> は、バッファリング戦略を定義します。以下のいずれかとなります。<ul><li><code>batch</code> - イベントをバッファリングして、非同期にバッチ処理します。これがデフォルトです。</li><li><code>blocking</code> - 個々のイベントを処理する際に、APIサーバーの応答をブロックします。</li><li><code>blocking-strict</code> - blockingと同じですが、RequestReceivedステージでの監査ログに失敗した場合は RequestReceivedステージで監査ログに失敗すると、kube-apiserverへのリクエスト全体が失敗します。</li></ul></li></ul><p>以下のフラグは <code>batch</code> モードでのみ使用されます:</p><ul><li><code>--audit-webhook-batch-buffer-size</code>は、バッチ処理を行う前にバッファリングするイベントの数を定義します。
入力イベントの割合がバッファをオーバーフローすると、イベントはドロップされます。</li><li><code>--audit-webhook-batch-max-size</code>は、1つのバッチに入れるイベントの最大数を定義します。</li><li><code>--audit-webhook-batch-max-wait</code>は、キュー内のイベントを無条件にバッチ処理するまでの最大待機時間を定義します。</li><li><code>--audit-webhook-batch-throttle-qps</code>は、1秒あたりに生成されるバッチの最大平均数を定義します。</li><li><code>--audit-webhook-batch-throttle-burst</code>は、許可された QPS が低い場合に、同じ瞬間に生成されるバッチの最大数を定義します。</li></ul><h2 id=パラメーターチューニング>パラメーターチューニング</h2><p>パラメーターは、APIサーバーの負荷に合わせて設定してください。</p><p>例えば、kube-apiserverが毎秒100件のリクエストを受け取り、それぞれのリクエストが<code>ResponseStarted</code>と<code>ResponseComplete</code>の段階でのみ監査されるとします。毎秒≅200の監査イベントが発生すると考えてください。
1つのバッチに最大100個のイベントがあるの場合、スロットリングレベルを少なくとも2クエリ/秒に設定する必要があります。
バックエンドがイベントを書き込むのに最大で5秒かかる場合、5秒分のイベントを保持するようにバッファーサイズを設定する必要があります。</p><p>10バッチ、または1000イベントとなります。</p><p>しかし、ほとんどの場合デフォルトのパラメーターで十分であり、手動で設定する必要はありません。
kube-apiserverが公開している以下のPrometheusメトリクスや、ログを見て監査サブシステムの状態を監視することができます。</p><ul><li><code>apiserver_audit_event_total</code>メトリックには、エクスポートされた監査イベントの合計数が含まれます。</li><li><code>apiserver_audit_error_total</code>メトリックには、エクスポート中にエラーが発生してドロップされたイベントの総数が含まれます。</li></ul><h3 id=truncate>ログエントリー・トランケーション</h3><p>logバックエンドとwebhookバックエンドは、ログに記録されるイベントのサイズを制限することをサポートしています。</p><p>例として、logバックエンドで利用可能なフラグの一覧を以下に示します</p><ul><li><code>audit-log-truncate-enabled</code>イベントとバッチの切り捨てを有効にするかどうかです。</li><li><code>audit-log-truncate-max-batch-size</code>バックエンドに送信されるバッチのバイト単位の最大サイズ。</li><li><code>audit-log-truncate-max-event-size</code>バックエンドに送信される監査イベントのバイト単位の最大サイズです。</li></ul><p>デフォルトでは、<code>webhook</code>と<code>log</code>の両方で切り捨ては無効になっていますが、クラスター管理者は <code>audit-log-truncate-enabled</code>または<code>audit-webhook-truncate-enabled</code>を設定して、この機能を有効にする必要があります。</p><h2 id=次の項目>次の項目</h2><ul><li><a href=/docs/reference/access-authn-authz/extensible-admission-controllers/#mutating-webhook-auditing-annotations>Mutating webhook auditing annotations</a>.</li><li><a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Event><code>Event</code></a></li><li><a href=/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy><code>Policy</code></a></li></ul></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/ja/docs/home/>ホーム</a>
<a class=text-white href=/ja/blog/>Blogs</a>
<a class=text-white href=/ja/training/>トレーニング</a>
<a class=text-white href=/ja/partners/>パートナー</a>
<a class=text-white href=/ja/community/>コミュニティ</a>
<a class=text-white href=/ja/case-studies/>ケーススタディ</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a></small><br><small class=text-white>Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>