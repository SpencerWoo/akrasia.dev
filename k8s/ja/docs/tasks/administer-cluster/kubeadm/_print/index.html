<!doctype html><html lang=ja class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=en href=https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=zh-cn href=https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=fr href=https://kubernetes.io/fr/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=de href=https://kubernetes.io/de/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=es href=https://kubernetes.io/es/docs/tasks/administer-cluster/kubeadm/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>kubeadmによる管理 | Kubernetes</title><meta property="og:title" content="kubeadmによる管理"><meta property="og:description" content="プロダクショングレードのコンテナ管理基盤"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="kubeadmによる管理"><meta itemprop=description content="プロダクショングレードのコンテナ管理基盤"><meta name=twitter:card content="summary"><meta name=twitter:title content="kubeadmによる管理"><meta name=twitter:description content="プロダクショングレードのコンテナ管理基盤"><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content><meta property="og:description" content><meta name=twitter:description content><meta property="og:url" content="https://kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/"><meta property="og:title" content="kubeadmによる管理"><meta name=twitter:title content="kubeadmによる管理"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/ja/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/ja/docs/>ドキュメント</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/blog/>Blogs</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/training/>トレーニング</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/partners/>パートナー</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/community/>コミュニティ</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/ja/case-studies/>ケーススタディ</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>バージョン</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/ja/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/ja/docs/tasks/administer-cluster/kubeadm/>v1.21</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>日本語 (Japanese)</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/tasks/administer-cluster/kubeadm/>English</a>
<a class=dropdown-item href=/zh-cn/docs/tasks/administer-cluster/kubeadm/>中文 (Chinese)</a>
<a class=dropdown-item href=/ko/docs/tasks/administer-cluster/kubeadm/>한국어 (Korean)</a>
<a class=dropdown-item href=/fr/docs/tasks/administer-cluster/kubeadm/>Français (French)</a>
<a class=dropdown-item href=/de/docs/tasks/administer-cluster/kubeadm/>Deutsch (German)</a>
<a class=dropdown-item href=/es/docs/tasks/administer-cluster/kubeadm/>Español (Spanish)</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>これは、このセクションの複数ページの印刷可能なビューです。
<a href=# onclick="return print(),!1">印刷するには、ここをクリックしてください</a>.</p><p><a href=/ja/docs/tasks/administer-cluster/kubeadm/>このページの通常のビューに戻る</a>.</p></div><h1 class=title>kubeadmによる管理</h1><ul><li>1: <a href=#pg-6134c5061298affa145ddb801b5c29da>cgroupドライバーの設定</a></li><li>2: <a href=#pg-f62fba1de4084f3be070785757c8079c>kubeadmによる証明書管理</a></li><li>3: <a href=#pg-9133578f1e75663bb031e5a377ca896d>Windowsノードの追加</a></li><li>4: <a href=#pg-e805c7d8d4ad6195cb82dbbc843bfc29>Windowsノードのアップグレード</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-6134c5061298affa145ddb801b5c29da>1 - cgroupドライバーの設定</h1><p>このページでは、kubeadmクラスターのコンテナランタイムcgroupドライバーに合わせて、kubelet cgroupドライバーを設定する方法について説明します。</p><h2 id=始める前に>始める前に</h2><p>Kubernetesの<a href=/docs/setup/production-environment/container-runtimes>コンテナランタイムの要件</a>を熟知している必要があります。</p><h2 id=コンテナランタイムのcgroupドライバーの設定>コンテナランタイムのcgroupドライバーの設定</h2><p><a href=/docs/setup/production-environment/container-runtimes>Container runtimes</a>ページでは、kubeadmベースのセットアップでは<code>cgroupfs</code>ドライバーではなく、<code>systemd</code>ドライバーが推奨されると説明されています。</p><p>このページでは、デフォルトの<code>systemd</code>ドライバーを使用して多くの異なるコンテナランタイムをセットアップする方法についての詳細も説明されています。</p><h2 id=kubelet-cgroupドライバーの設定>kubelet cgroupドライバーの設定</h2><p>kubeadmでは、<code>kubeadm init</code>の際に<code>KubeletConfiguration</code>構造体を渡すことができます。</p><p>この<code>KubeletConfiguration</code>には、kubeletのcgroupドライバーを制御する<code>cgroupDriver</code>フィールドを含めることができます。</p><div class="alert alert-info note callout" role=alert><strong>備考:</strong> v1.22では、ユーザーが<code>KubeletConfiguration</code>の<code>cgroupDriver</code>フィールドを設定していない場合、<code>kubeadm</code>はデフォルトで<code>systemd</code>を設定するようになりました。</div><p>フィールドを明示的に設定する最小限の例です:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># kubeadm-config.yaml</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kubernetesVersion</span>:<span style=color:#bbb> </span>v1.21.0<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>KubeletConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubelet.config.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>cgroupDriver</span>:<span style=color:#bbb> </span>systemd<span style=color:#bbb>
</span></span></span></code></pre></div><p>このような設定ファイルは、kubeadmコマンドに渡すことができます:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubeadm init --config kubeadm-config.yaml
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>備考:</strong><p>Kubeadmはクラスター内の全ノードで同じ<code>KubeletConfiguration</code>を使用します。</p><p><code>KubeletConfiguration</code>は<code>kube-system</code>名前空間下の<a href=/docs/concepts/configuration/configmap>ConfigMap</a>オブジェクトに格納されます。</p><p>サブコマンド<code>init</code>、<code>join</code>、<code>upgrade</code>を実行すると、kubeadmが<code>KubeletConfiguration</code>を<code>/var/lib/kubelet/config.yaml</code>以下にファイルとして書き込み、ローカルノードのkubeletに渡します。</p></div><h2 id=cgroupfsドライバーの使用>cgroupfsドライバーの使用</h2><p>このガイドで説明するように、<code>cgroupfs</code>ドライバーをkubeadmと一緒に使用することは推奨されません。
<code>cgroupfs</code>を使い続け、<code>kubeadm upgrade</code>が既存のセットアップで<code>KubeletConfiguration</code> cgroupドライバーを変更しないようにするには、その値を明示的に指定する必要があります。
これは、将来のバージョンのkubeadmに<code>systemd</code>ドライバーをデフォルトで適用させたくない場合に適用されます。
値を明示する方法については、後述の「kubelet ConfigMapの修正」の項を参照してください。
<code>cgroupfs</code>ドライバーを使用するようにコンテナランタイムを設定したい場合は、選択したコンテナランタイムのドキュメントを参照する必要があります。</p><h2 id=systemd-ドライバーへの移行><code>systemd</code>ドライバーへの移行</h2><p>既存のkubeadmクラスターのcgroupドライバーを<code>systemd</code>にインプレースで変更する場合は、kubeletのアップグレードと同様の手順が必要です。
これには、以下に示す両方の手順を含める必要があります。</p><div class="alert alert-info note callout" role=alert><strong>備考:</strong> あるいは、クラスター内の古いノードを<code>systemd</code>ドライバーを使用する新しいノードに置き換えることも可能です。
この場合、新しいノードに参加する前に以下の最初のステップのみを実行し、古いノードを削除する前にワークロードが新しいノードに安全に移動できることを確認する必要があります。</div><h3 id=kubelet-configmapの修正>kubelet ConfigMapの修正</h3><ul><li><code>kubectl get cm -n kube-system | grep kubelet-config</code>で、kubelet ConfigMapの名前を探します。</li><li><code>kubectl edit cm kubelet-config-x.yy -n kube-system</code>を呼び出します(<code>x.yy</code>はKubernetesのバージョンに置き換えてください)。</li><li>既存の<code>cgroupDriver</code>の値を修正するか、以下のような新しいフィールドを追加します。</li></ul><p>``yaml
cgroupDriver: systemd</p><pre tabindex=0><code>
このフィールドは、ConfigMapの`kubelet:`セクションの下に存在する必要があります。

### 全ノードでcgroupドライバーを更新

クラスター内の各ノードについて:

- [Drain the node](/docs/tasks/administer-cluster/safely-drain-node)を`kubectl drain &lt;node-name&gt; --ignore-daemonsets`を使ってドレーンします。
- `systemctl stop kubelet`を使用して、kubeletを停止します。
- コンテナランタイムの停止。
- コンテナランタイムのcgroupドライバーを`systemd`に変更します。
- `var/lib/kubelet/config.yaml`に`cgroupDriver: systemd`を設定します。
- コンテナランタイムの開始。
- `systemctl start kubelet`でkubeletを起動します。
- [Drain the node](/docs/tasks/administer-cluster/safely-drain-node)を`kubectl uncordon &lt;node-name&gt;`を使って行います。

ワークロードが異なるノードでスケジュールするための十分な時間を確保するために、これらのステップを1つずつノード上で実行します。
プロセスが完了したら、すべてのノードとワークロードが健全であることを確認します。
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-f62fba1de4084f3be070785757c8079c>2 - kubeadmによる証明書管理</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.15 [stable]</code></div><p><a href=/docs/reference/setup-tools/kubeadm/>kubeadm</a>で生成されたクライアント証明書は1年で失効します。
このページでは、kubeadmで証明書の更新を管理する方法について説明します。</p><h2 id=始める前に>始める前に</h2><p><a href=/docs/setup/best-practices/certificates/>KubernetesにおけるPKI証明書と要件</a>を熟知している必要があります。</p><h2 id=custom-certificates>カスタム証明書の使用</h2><p>デフォルトでは、kubeadmはクラスターの実行に必要なすべての証明書を生成します。
独自の証明書を提供することで、この動作をオーバーライドできます。</p><p>そのためには、<code>--cert-dir</code>フラグまたはkubeadmの<code>ClusterConfiguration</code>の<code>certificatesDir</code>フィールドで指定された任意のディレクトリに配置する必要があります。
デフォルトは<code>/etc/kubernetes/pki</code>です。</p><p><code>kubeadm init</code> を実行する前に与えられた証明書と秘密鍵のペアが存在する場合、kubeadmはそれらを上書きしません。
つまり、例えば既存のCAを<code>/etc/kubernetes/pki/ca.crt</code>と<code>/etc/kubernetes/pki/ca.key</code>にコピーすれば、kubeadmは残りの証明書に署名する際、このCAを使用できます。</p><h2 id=external-ca-mode>外部CAモード</h2><p>また、<code>ca.crt</code>ファイルのみを提供し、<code>ca.key</code>ファイルを提供しないことも可能です(これはルートCAファイルのみに有効で、他の証明書ペアには有効ではありません)。
他の証明書とkubeconfigファイルがすべて揃っている場合、kubeadmはこの状態を認識し、外部CAモードを有効にします。
kubeadmはディスク上のCAキーがなくても処理を進めます。</p><p>代わりに、Controller-managerをスタンドアロンで、<code>--controllers=csrsigner</code>と実行し、CA証明書と鍵を指し示します。</p><p><a href=/docs/setup/best-practices/certificates/>PKI certificates and requirements</a>には、外部CAを使用するためのクラスターのセットアップに関するガイダンスが含まれています。</p><h2 id=証明書の有効期限の確認>証明書の有効期限の確認</h2><p><code>check-expiration</code>サブコマンドを使うと、証明書の有効期限を確認することができます。</p><pre tabindex=0><code>kubeadm certs check-expiration
</code></pre><p>このような出力になります:</p><pre tabindex=0><code>CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Dec 30, 2020 23:36 UTC   364d                                    no
apiserver                  Dec 30, 2020 23:36 UTC   364d            ca                      no
apiserver-etcd-client      Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
apiserver-kubelet-client   Dec 30, 2020 23:36 UTC   364d            ca                      no
controller-manager.conf    Dec 30, 2020 23:36 UTC   364d                                    no
etcd-healthcheck-client    Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-peer                  Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-server                Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
front-proxy-client         Dec 30, 2020 23:36 UTC   364d            front-proxy-ca          no
scheduler.conf             Dec 30, 2020 23:36 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Dec 28, 2029 23:36 UTC   9y              no
etcd-ca                 Dec 28, 2029 23:36 UTC   9y              no
front-proxy-ca          Dec 28, 2029 23:36 UTC   9y              no
</code></pre><p>このコマンドは、<code>/etc/kubernetes/pki</code>フォルダ内のクライアント証明書と、kubeadmが使用するKUBECONFIGファイル(<code>admin.conf</code>,<code>controller-manager.conf</code>,<code>scheduler.conf</code>)に埋め込まれたクライアント証明書の有効期限/残余時間を表示します。</p><p>また、証明書が外部管理されている場合、kubeadmはユーザーに通知します。この場合、ユーザーは証明書の更新を手動または他のツールを使用して管理する必要があります。</p><div class="alert alert-danger warning callout" role=alert><strong>警告:</strong> <code>kubeadm</code>は外部CAによって署名された証明書を管理することができません。</div><div class="alert alert-info note callout" role=alert><strong>備考:</strong><p>kubeadmは<code>/var/lib/kubelet/pki</code>以下にあるローテート可能な証明書でkubeletの<a href=/docs/task/tls/certificate-rotation/>証明書の自動更新</a>を構成するので<code>kubelet.conf</code>は上記のリストに含まれません。</p><p>期限切れのkubeletクライアント証明書を修復するには、<a href=/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/#kubelet-client-cert>Kubelet クライアント証明書のローテーションに失敗しました</a>を参照ください。</p></div><div class="alert alert-danger warning callout" role=alert><strong>警告:</strong><p>kubeadm version 1.17より前の<code>kubeadm init</code>で作成したノードでは、<code>kubelet.conf</code>の内容を手動で変更しなければならないという<a href=https://github.com/kubernetes/kubeadm/issues/1753>bug</a>が存在します。</p><p><code>kubeadm init</code>が終了したら、<code>client-certificate-data</code>と<code>client-key-data</code>を置き換えて、ローテーションされたkubeletクライアント証明書を指すように<code>kubelet.conf</code>を更新してください。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>client-certificate</span>:<span style=color:#bbb> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>client-key</span>:<span style=color:#bbb> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style=color:#bbb>
</span></span></span></code></pre></div></div><h2 id=証明書の自動更新>証明書の自動更新</h2><p>kubeadmはコントロールプレーンの<a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>アップグレード</a>時にすべての証明書を更新します。</p><p>この機能は、最もシンプルなユースケースに対応するために設計されています。
証明書の更新に特別な要件がなく、Kubernetesのバージョンアップを定期的に行う場合(各アップグレードの間隔が1年未満)、kubeadmがクラスターを最新かつ適度に安全に保つための処理を行います。</p><div class="alert alert-info note callout" role=alert><strong>備考:</strong> 安全性を維持するために、クラスターを頻繁にアップグレードすることがベストプラクティスです。</div><p>証明書の更新に関してより複雑な要求がある場合は、<code>--certificate-renewal=false</code>を<code>kubeadm upgrade apply</code>や<code>kubeadm upgrade node</code>に渡して、デフォルトの動作から外れるようにすることができます。</p><div class="alert alert-danger warning callout" role=alert><strong>警告:</strong> kubeadmバージョン1.17より前のバージョンでは、<code>kubeadm upgrade node</code>コマンドの<code>--certificate-renewal</code>のデフォルト値が<code>false</code>になっているという[bug(https://github.com/kubernetes/kubeadm/issues/1818)]問題があります。
この場合、明示的に<code>--certificate-renewal=true</code>を設定する必要があります。</div><h2 id=手動による証明書更新>手動による証明書更新</h2><p><code>kubeadm certs renew</code> コマンドを使えば、いつでも証明書を手動で更新することができます。</p><p>このコマンドは<code>/etc/kubernetes/pki</code>に格納されているCA(またはfront-proxy-CA)の証明書と鍵を使って更新を行います。</p><p>コマンド実行後、コントロールプレーンのPodを再起動する必要があります。
これは、現在すべてのコンポーネントと証明書について動的な証明書のリロードがサポートされていないため、必要な作業です。
<a href=/docs/tasks/configure-pod-container/static-pod/>スタティックPod</a>はローカルkubeletによって管理され、API Serverによって管理されないため、kubectlで削除および再起動することはできません。</p><p>スタティックPodを再起動するには、一時的に<code>/etc/kubernetes/manifests/</code>からマニフェストファイルを削除して20秒間待ちます(<a href=/docs/reference/config-api/kubelet-config.v1beta1/>KubeletConfiguration struct</a>の<code>fileCheckFrequency</code>値を参照してください)。
マニフェストディレクトリにPodが無くなると、kubeletはPodを終了します。
その後ファイルを戻して、さらに<code>fileCheckFrequency</code>期間後に、kubeletはPodを再作成し、コンポーネントの証明書更新を完了することができます。</p><div class="alert alert-danger warning callout" role=alert><strong>警告:</strong> HAクラスターを実行している場合、このコマンドはすべての制御プレーンノードで実行する必要があります。</div><div class="alert alert-info note callout" role=alert><strong>備考:</strong> <code>certs renew</code>は、属性(Common Name、Organization、SANなど)の信頼できるソースとして、kubeadm-config ConfigMapではなく、既存の証明書を使用します。両者を同期させておくことが強く推奨されます。</div><p><code>kubeadm certs renew</code> は以下のオプションを提供します:</p><p>Kubernetesの証明書は通常1年後に有効期限を迎えます。</p><ul><li><p><code>--csr-only</code>を使用すると、証明書署名要求を生成して外部CAとの証明書を更新することができます(実際にはその場で証明書を更新しません)。詳しくは次の段落を参照してください。</p></li><li><p>また、すべての証明書を更新するのではなく、1つの証明書を更新することも可能です。</p></li></ul><h2 id=kubernetes-certificates-apiによる証明書の更新>Kubernetes certificates APIによる証明書の更新</h2><p>ここでは、Kubernetes certificates APIを使用して手動で証明書更新を実行する方法について詳しく説明します。</p><div class="alert alert-warning caution callout" role=alert><strong>注意:</strong> これらは、組織の証明書インフラをkubeadmで構築されたクラスターに統合する必要があるユーザー向けの上級者向けのトピックです。
kubeadmのデフォルトの設定で満足できる場合は、代わりにkubeadmに証明書を管理させる必要があります。</div><h3 id=署名者の設定>署名者の設定</h3><p>Kubernetesの認証局は、そのままでは機能しません。
<a href=https://cert-manager.io/docs/configuration/ca/>cert-manager</a>などの外部署名者を設定するか、組み込みの署名者を使用することができます。</p><p>ビルトインサイナーは<a href=/docs/reference/command-line-tools-reference/kube-controller-manager/><code>kube-controller-manager</code></a>に含まれるものです。</p><p>ビルトインサイナーを有効にするには、<code>--cluster-signing-cert-file</code>と<code>--cluster-signing-key-file</code>フラグを渡す必要があります。</p><p>新しいクラスターを作成する場合は、kubeadm<a href=https://pkg.go.dev/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta3>設定ファイル</a>を使用します。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerManager</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraArgs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster-signing-cert-file</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/ca.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster-signing-key-file</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/ca.key<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=証明書署名要求の作成-csr>証明書署名要求の作成 (CSR)</h3><p>Kubernetes APIでのCSR作成については、<a href=/docs/reference/access-authn-authz/certificate-signing-requests/#create-certificatesigningrequest>Create CertificateSigningRequest</a>を参照ください。</p><h2 id=外部caによる証明書の更新>外部CAによる証明書の更新</h2><p>ここでは、外部認証局を利用して手動で証明書更新を行う方法について詳しく説明します。</p><p>外部CAとの連携を強化するために、kubeadmは証明書署名要求(CSR)を生成することもできます。
CSRとは、クライアント用の署名付き証明書をCAに要求することを表します。
kubeadmの用語では、通常ディスク上のCAによって署名される証明書をCSRとして生成することができます。しかし、CAはCSRとして生成することはできません。</p><h3 id=証明書署名要求の作成-csr-1>証明書署名要求の作成 (CSR)</h3><p><code>kubeadm certs renew --csr-only</code>で証明書署名要求を作成することができます。</p><p>CSRとそれに付随する秘密鍵の両方が出力されます。
ディレクトリを<code>--csr-dir</code>で渡すと、指定した場所にCSRを出力することができます。
<code>csr-dir</code>を指定しない場合は、デフォルトの証明書ディレクトリ(<code>/etc/kubernetes/pki</code>)が使用されます。</p><p>証明書は<code>kubeadm certs renew --csr-only</code>で更新することができます。
<code>kubeadm init</code>と同様に、<code>--csr-dir</code>フラグで出力先ディレクトリを指定することができます。</p><p>CSRには、証明書の名前、ドメイン、IPが含まれますが、用途は指定されません。
証明書を発行する際に、<a href=/docs/setup/best-practices/certificates/#all-certificates>正しい証明書の使用法</a>を指定するのはCAの責任です。</p><ul><li><p><code>openssl</code>では、<a href=https://superuser.com/questions/738612/openssl-ca-keyusage-extension><code>openssl ca</code>コマンド</a>を使って行います。</p></li><li><p><code>cfssl</code>では、<a href=https://github.com/cloudflare/cfssl/blob/master/doc/cmd/cfssl.txt#L170>configファイルのusages</a>で指定します。</p></li></ul><p>お好みの方法で証明書に署名した後、証明書と秘密鍵をPKIディレクトリ(デフォルトでは<code>/etc/kubernetes/pki</code>)にコピーする必要があります。</p><h2 id=certificate-authority-rotation>認証局(CA)のローテーション</h2><p>Kubeadmは、CA証明書のローテーションや交換を最初からサポートしているわけではありません。</p><p>CAの手動ローテーションや交換についての詳細は、<a href=/docs/tasks/tls/manual-rotation-of-ca-certificates/>manual rotation of CA certificates</a>を参照してください。</p><h2 id=kubelet-serving-certs>署名付きkubeletサービング証明書の有効化</h2><p>デフォルトでは、kubeadmによって展開されるkubeletサービング証明書は自己署名されています。
これは、<a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a>のような外部サービスからキューブレットへの接続がTLSで保護されないことを意味します。
新しいkubeadmクラスター内のkubeletが適切に署名されたサービング証明書を取得するように設定するには、<code>kubeadm init</code>に以下の最小限の設定を渡す必要があります。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubelet.config.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>KubeletConfiguration<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>serverTLSBootstrap</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>すでにクラスターを作成している場合は、以下の手順で適応させる必要があります。</p><ul><li>kube-system<code>ネームスペースにある</code>kubelet-config-1.25` ConfigMapを見つけて編集します。</li></ul><p>そのConfigMapの<code>kubelet</code>キーの値として<a href=/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration>KubeletConfiguration</a>ドキュメントを指定します。KubeletConfigurationドキュメントを編集し、<code>serverTLSBootstrap: true</code>を設定します。</p><ul><li>各ノードで、<code>/var/lib/kubelet/config.yaml</code>に<code>serverTLSBootstrap: true</code>フィールドを追加し、<code>systemctl restart kubelet</code>でkubeletを再起動します。</li></ul><p><code>serverTLSBootstrap: true</code>フィールドは、kubeleサービングのブートストラップを有効にします。
証明書を<code>certificates.k8s.io</code>APIにリクエストすることで、証明書を発行することができます。</p><p>既知の制限事項として、これらの証明書のCSR(Certificate Signing Requests)はkube-controller-managerのデフォルトサイナーによって自動的に承認されないことがあります。
<a href=/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers><code>kubernetes.io/kubelet-serving</code></a> を参照してください。</p><p>これには、ユーザーまたはサードパーティーのコントローラーからのアクションが必要です。</p><p>これらのCSRは、以下を使用して表示できます:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get csr
</span></span><span style=display:flex><span>NAME        AGE     SIGNERNAME                        REQUESTOR                      CONDITION
</span></span><span style=display:flex><span>csr-9wvgt   112s    kubernetes.io/kubelet-serving     system:node:worker-1           Pending
</span></span><span style=display:flex><span>csr-lz97v   1m58s   kubernetes.io/kubelet-serving     system:node:control-plane-1    Pending
</span></span></code></pre></div><p>承認するためには、次のようにします:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl certificate approve &lt;CSR-name&gt;
</span></span></code></pre></div><p>デフォルトでは、これらのサービング証明書は1年後に失効します。</p><p>Kubeadmは<code>KubeletConfiguration</code>フィールド<code>rotateCertificates</code>を<code>true</code>に設定します。これは有効期限が切れる間際に、サービング証明書のための新しいCSRセットを作成し、ローテーションを完了するために承認する必要があることを意味します。</p><p>詳しくは<a href=/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#certificate-rotation>Certificate Rotation</a>をご覧ください。</p><p>これらのCSRを自動的に承認するためのソリューションをお探しの場合は、以下をお勧めします。
クラウドプロバイダーに連絡し、ノードの識別をアウトオブバンドのメカニズムで行うCSRの署名者がいるかどうか尋ねてください。</p><div class="alert alert-secondary callout third-party-content" role=alert><strong>備考:</strong>
このセクションでは、Kubernetesが必要とする機能を提供するサードパーティープロジェクトにリンクしています。これらのプロジェクトはアルファベット順に記載されていて、Kubernetesプロジェクトの作者は責任を持ちません。このリストにプロジェクトを追加するには、変更を提出する前に<a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a>をお読みください。<a href=#third-party-content-disclaimer>詳細はこちら。</a></div><p>サードパーティーのカスタムコントローラーを使用することができます。</p><ul><li><a href=https://github.com/postfinance/kubelet-csr-approver>kubelet-csr-approver</a></li></ul><p>このようなコントローラーは、CSRのCommonNameを検証するだけでなく、要求されたIPやドメイン名も検証しなければ、安全なメカニズムとは言えません。これにより、kubeletクライアント証明書にアクセスできる悪意のあるアクターが、任意のIPやドメイン名に対してサービング証明書を要求するCSRを作成することを防ぐことができます。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9133578f1e75663bb031e5a377ca896d>3 - Windowsノードの追加</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [beta]</code></div><p>Kubernetesを使用してLinuxノードとWindowsノードを混在させて実行できるため、Linuxで実行するPodとWindowsで実行するPodを混在させることができます。このページでは、Windowsノードをクラスターに登録する方法を示します。</p><h2 id=始める前に>始める前に</h2>作業するKubernetesサーバーは次のバージョン以降のものである必要があります: 1.17.
バージョンを確認するには次のコマンドを実行してください: <code>kubectl version</code>.<ul><li><p>WindowsコンテナをホストするWindowsノードを構成するには、<a href=https://www.microsoft.com/en-us/cloud-platform/windows-server-pricing>Windows Server 2019ライセンス</a>(またはそれ以上)を取得します。
VXLAN/オーバーレイネットワークを使用している場合は、<a href=https://support.microsoft.com/help/4489899>KB4489899</a>もインストールされている必要があります。</p></li><li><p>コントロールプレーンにアクセスできるLinuxベースのKubernetes kubeadmクラスター(<a href=/ja/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/>kubeadmを使用したシングルコントロールプレーンクラスターの作成</a>を参照)</p></li></ul><h2 id=目標>目標</h2><ul><li>Windowsノードをクラスターに登録する</li><li>LinuxとWindowsのPodとServiceが相互に通信できるようにネットワークを構成する</li></ul><h2 id=はじめに-クラスターへのwindowsノードの追加>はじめに: クラスターへのWindowsノードの追加</h2><h3 id=ネットワーク構成>ネットワーク構成</h3><p>LinuxベースのKubernetesコントロールプレーンノードを取得したら、ネットワーキングソリューションを選択できます。このガイドでは、簡単にするためにVXLANモードでのFlannelの使用について説明します。</p><h4 id=flannel構成>Flannel構成</h4><ol><li><p>FlannelのためにKubernetesコントロールプレーンを準備する</p><p>クラスター内のKubernetesコントロールプレーンでは、多少の準備が推奨されます。Flannelを使用する場合は、iptablesチェーンへのブリッジIPv4トラフィックを有効にすることをお勧めします。すべてのLinuxノードで次のコマンドを実行する必要があります:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sysctl net.bridge.bridge-nf-call-iptables<span style=color:#666>=</span><span style=color:#666>1</span>
</span></span></code></pre></div></li><li><p>Linux用のFlannelをダウンロードして構成する</p><p>最新のFlannelマニフェストをダウンロード:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span></code></pre></div><p>VNIを4096、ポートを4789に設定するために、flannelマニフェストの<code>net-conf.json</code>セクションを変更します。次のようになります:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>net-conf.json:</span> <span>|</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;Network&#34;</span>: <span style=color:#b44>&#34;10.244.0.0/16&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;Backend&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;Type&#34;</span>: <span style=color:#b44>&#34;vxlan&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;VNI&#34;</span> : <span style=color:#666>4096</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;Port&#34;</span>: <span style=color:#666>4789</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>備考:</strong> Linux上のFlannelがWindows上のFlannelと相互運用するには、VNIを4096およびポート4789に設定する必要があります。これらのフィールドの説明については、<a href=https://github.com/coreos/flannel/blob/master/Documentation/backends.md#vxlan>VXLANドキュメント</a>を参照してください。</div><div class="alert alert-info note callout" role=alert><strong>備考:</strong> L2Bridge/Host-gatewayモードを使用するには、代わりに<code>Type</code>の値を<code>"host-gw"</code>に変更し、<code>VNI</code>と<code>Port</code>を省略します。</div></li><li><p>Flannelマニフェストを適用して検証する</p><p>Flannelの構成を適用しましょう:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f kube-flannel.yml
</span></span></code></pre></div><p>数分後、Flannel Podネットワークがデプロイされていれば、すべてのPodが実行されていることがわかります。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods -n kube-system
</span></span></code></pre></div><p>出力結果には、実行中のLinux flannel DaemonSetが含まれているはずです:</p><pre tabindex=0><code>NAMESPACE     NAME                                      READY        STATUS    RESTARTS   AGE
...
kube-system   kube-flannel-ds-54954                     1/1          Running   0          1m
</code></pre></li><li><p>Windows Flannelとkube-proxy DaemonSetを追加する</p><p>これで、Windows互換バージョンのFlannelおよびkube-proxyを追加できます。
互換性のあるバージョンのkube-proxyを確実に入手するには、イメージのタグを置換する必要があります。
次の例は、Kubernetesv1.25.0の使用方法を示していますが、
独自のデプロイに合わせてバージョンを調整する必要があります。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/kube-proxy.yml | sed <span style=color:#b44>&#39;s/VERSION/v1.25.0/g&#39;</span> | kubectl apply -f -
</span></span><span style=display:flex><span>kubectl apply -f https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-overlay.yml
</span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>備考:</strong> ホストゲートウェイを使用している場合は、代わりに <a href=https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-host-gw.yml>https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-host-gw.yml</a> を使用してください。</div><div class="alert alert-info note callout" role=alert><strong>備考:</strong><p>Windowsノードでイーサネット(「Ethernet0 2」など)ではなく別のインターフェースを使用している場合は、次の行を変更する必要があります:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>wins <span style=color:#a2f>cli </span><span style=color:#a2f;font-weight:700>process</span> run --path /k/flannel/setup.exe --args <span style=color:#b44>&#34;--mode=overlay --interface=Ethernet&#34;</span>
</span></span></code></pre></div><p><code>flannel-host-gw.yml</code>または<code>flannel-overlay.yml</code>ファイルで、それに応じてインターフェースを指定します。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 例</span>
</span></span><span style=display:flex><span>curl -L https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-overlay.yml | sed <span style=color:#b44>&#39;s/Ethernet/Ethernet0 2/g&#39;</span> | kubectl apply -f -
</span></span></code></pre></div></div></li></ol><h3 id=windowsワーカーノードの参加>Windowsワーカーノードの参加</h3><div class="alert alert-info note callout" role=alert><strong>備考:</strong> <code>Containers</code>機能をインストールし、Dockerをインストールする必要があります。
行うための指示としては、<a href=https://docs.mirantis.com/docker-enterprise/v3.1/dockeree-products/docker-engine-enterprise/dee-windows.html>Dockerエンジンのインストール - Windowsサーバー上のエンタープライズ</a>を利用できます。</div><div class="alert alert-info note callout" role=alert><strong>備考:</strong> Windowsセクションのすべてのコードスニペットは、
Windowsワーカーノードの(管理者)権限を持つPowerShell環境で実行されます。</div><ol><li><p>wins、kubelet、kubeadmをインストールします。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span>curl.exe -LO https<span>:</span>//raw.githubusercontent.com/<span style=color:#a2f>kubernetes-sigs</span>/<span style=color:#a2f>sig-windows</span>-tools/master/kubeadm/scripts/PrepareNode.ps1
</span></span><span style=display:flex><span>.\PrepareNode.ps1 -KubernetesVersion <span style=color:#a2f>
</span></span></code></pre></div></li><li><p><code>kubeadm</code>を実行してノードに参加します</p><p>コントロールプレーンホストで<code>kubeadm init</code>を実行したときに提供されたコマンドを使用します。
このコマンドがなくなった場合、またはトークンの有効期限が切れている場合は、<code>kubeadm token create --print-join-command</code>
(コントロールプレーンホスト上で)を実行して新しいトークンを生成します。</p></li></ol><h4 id=インストールの確認>インストールの確認</h4><p>次のコマンドを実行して、クラスター内のWindowsノードを表示できるようになります:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes -o wide
</span></span></code></pre></div><p>新しいノードが<code>NotReady</code>状態の場合は、flannelイメージがまだダウンロード中の可能性があります。
<code>kube-system</code>名前空間のflannel Podを確認することで、以前と同様に進行状況を確認できます:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n kube-system get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>flannel
</span></span></code></pre></div><p>flannel Podが実行されると、ノードは<code>Ready</code>状態になり、ワークロードを処理できるようになります。</p><h2 id=次の項目>次の項目</h2><ul><li><a href=/ja/docs/tasks/administer-cluster/kubeadm/upgrading-windows-nodes>Windows kubeadmノードのアップグレード</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e805c7d8d4ad6195cb82dbbc843bfc29>4 - Windowsノードのアップグレード</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [beta]</code></div><p>このページでは、<a href=/ja/docs/tasks/administer-cluster/kubeadm/adding-windows-nodes>kubeadmで作られた</a>Windowsノードをアップグレードする方法について説明します。</p><h2 id=始める前に>始める前に</h2><p><p>Kubernetesクラスターが必要、かつそのクラスターと通信するためにkubectlコマンドラインツールが設定されている必要があります。
このチュートリアルは、コントロールプレーンのホストとして動作していない少なくとも2つのノードを持つクラスターで実行することをおすすめします。
まだクラスターがない場合、<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a>を使って作成するか、
以下のいずれかのKubernetesプレイグラウンドも使用できます:</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>作業するKubernetesサーバーは次のバージョン以降のものである必要があります: 1.17.
バージョンを確認するには次のコマンドを実行してください: <code>kubectl version</code>.</p><ul><li><a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade>残りのkubeadmクラスターをアップグレードするプロセス</a>を理解します。
Windowsノードをアップグレードする前にコントロールプレーンノードをアップグレードしたいと思うかもしれません。</li></ul><h2 id=ワーカーノードをアップグレード>ワーカーノードをアップグレード</h2><h3 id=kubeadmをアップグレード>kubeadmをアップグレード</h3><ol><li><p>Windowsノードから、kubeadmをアップグレードします。:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#080;font-style:italic># v1.25.0を目的のバージョンに置き換えます</span>
</span></span><span style=display:flex><span>curl.exe -Lo C:\k\kubeadm.exe https<span>:</span>//dl.k8s.io/<span style=color:#a2f>/bin/windows/amd64/kubeadm.exe
</span></span></code></pre></div></li></ol><h3 id=ノードをドレインする>ノードをドレインする</h3><ol><li><p>Kubernetes APIにアクセスできるマシンから、
ノードをスケジュール不可としてマークして、ワークロードを削除することでノードのメンテナンスを準備します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># &lt;node-to-drain&gt;をドレインするノードの名前に置き換えます</span>
</span></span><span style=display:flex><span>kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</span></span></code></pre></div><p>このような出力結果が表示されるはずです:</p><pre tabindex=0><code>node/ip-172-31-85-18 cordoned
node/ip-172-31-85-18 drained
</code></pre></li></ol><h3 id=kubeletの構成をアップグレード>kubeletの構成をアップグレード</h3><ol><li><p>Windowsノードから、次のコマンドを呼び出して新しいkubelet構成を同期します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>kubeadm upgrade node
</span></span></code></pre></div></li></ol><h3 id=kubeletをアップグレード>kubeletをアップグレード</h3><ol><li><p>Windowsノードから、kubeletをアップグレードして再起動します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>stop-service</span> kubelet
</span></span><span style=display:flex><span>curl.exe -Lo C:\k\kubelet.exe https<span>:</span>//dl.k8s.io/<span style=color:#a2f>/bin/windows/amd64/kubelet.exe
</span></span><span style=display:flex><span><span style=color:#a2f>restart-service</span> kubelet
</span></span></code></pre></div></li></ol><h3 id=ノードをオンライン状態に>ノードをオンライン状態に</h3><ol><li><p>Kubernetes APIにアクセスできるマシンから、
スケジュール可能としてマークして、ノードをオンラインに戻します:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># &lt;node-to-drain&gt;をノードの名前に置き換えます</span>
</span></span><span style=display:flex><span>kubectl uncordon &lt;node-to-drain&gt;
</span></span></code></pre></div></li></ol><h3 id=kube-proxyをアップグレード>kube-proxyをアップグレード</h3><ol><li><p>Kubernetes APIにアクセスできるマシンから、次を実行します、
もう一度v1.25.0を目的のバージョンに置き換えます:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/kube-proxy.yml | sed <span style=color:#b44>&#39;s/VERSION/v1.25.0/g&#39;</span> | kubectl apply -f -
</span></span></code></pre></div></li></ol></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/ja/docs/home/>ホーム</a>
<a class=text-white href=/ja/blog/>Blogs</a>
<a class=text-white href=/ja/training/>トレーニング</a>
<a class=text-white href=/ja/partners/>パートナー</a>
<a class=text-white href=/ja/community/>コミュニティ</a>
<a class=text-white href=/ja/case-studies/>ケーススタディ</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a></small><br><small class=text-white>Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>