<!doctype html><html lang=zh-cn class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=en href=https://kubernetes.io/docs/tutorials/security/><link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/tutorials/security/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://kubernetes.io/zh-cn/docs/tutorials/security/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>å®‰å…¨ | Kubernetes</title><meta property="og:title" content="å®‰å…¨"><meta property="og:description" content="ç”Ÿäº§çº§åˆ«çš„å®¹å™¨ç¼–æ’ç³»ç»Ÿ"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/zh-cn/docs/tutorials/security/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="å®‰å…¨"><meta itemprop=description content="ç”Ÿäº§çº§åˆ«çš„å®¹å™¨ç¼–æ’ç³»ç»Ÿ"><meta name=twitter:card content="summary"><meta name=twitter:title content="å®‰å…¨"><meta name=twitter:description content="ç”Ÿäº§çº§åˆ«çš„å®¹å™¨ç¼–æ’ç³»ç»Ÿ"><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content><meta property="og:description" content><meta name=twitter:description content><meta property="og:url" content="https://kubernetes.io/zh-cn/docs/tutorials/security/"><meta property="og:title" content="å®‰å…¨"><meta name=twitter:title content="å®‰å…¨"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/zh-cn/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/zh-cn/docs/>æ–‡æ¡£</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/blog/>Kubernetes åšå®¢</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/training/>åŸ¹è®­</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/partners/>åˆä½œä¼™ä¼´</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/community/>ç¤¾åŒº</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/case-studies/>æ¡ˆä¾‹åˆ†æ</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>ç‰ˆæœ¬åˆ—è¡¨</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/zh-cn/docs/tutorials/security/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/zh-cn/docs/tutorials/security/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/zh-cn/docs/tutorials/security/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/zh-cn/docs/tutorials/security/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/zh-cn/docs/tutorials/security/>v1.21</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>ä¸­æ–‡ (Chinese)</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/tutorials/security/>English</a>
<a class=dropdown-item href=/ko/docs/tutorials/security/>í•œêµ­ì–´ (Korean)</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>è¿™æ˜¯æœ¬èŠ‚çš„å¤šé¡µæ‰“å°è§†å›¾ã€‚
<a href=# onclick="return print(),!1">ç‚¹å‡»æ­¤å¤„æ‰“å°</a>.</p><p><a href=/zh-cn/docs/tutorials/security/>è¿”å›æœ¬é¡µå¸¸è§„è§†å›¾</a>.</p></div><h1 class=title>å®‰å…¨</h1><ul><li>1: <a href=#pg-fca078b8ac6b82352ed52187a2da91b7>ä½¿ç”¨ AppArmor é™åˆ¶å®¹å™¨å¯¹èµ„æºçš„è®¿é—®</a></li><li>2: <a href=#pg-d5f847bcdb6f7efbfc9c8a180d73e29a>åœ¨é›†ç¾¤çº§åˆ«åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</a></li><li>3: <a href=#pg-31a6c137cfc5bfea9d88f4b109109465>åœ¨åå­—ç©ºé—´çº§åˆ«åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</a></li><li>4: <a href=#pg-8b105172a11322c70d0223bc9dff1904>ä½¿ç”¨ seccomp é™åˆ¶å®¹å™¨çš„ç³»ç»Ÿè°ƒç”¨</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-fca078b8ac6b82352ed52187a2da91b7>1 - ä½¿ç”¨ AppArmor é™åˆ¶å®¹å™¨å¯¹èµ„æºçš„è®¿é—®</h1><div style=margin-top:10px;margin-bottom:10px><b>ç‰¹æ€§çŠ¶æ€ï¼š</b> <code>Kubernetes v1.4 [beta]</code></div><p>AppArmor æ˜¯ä¸€ä¸ª Linux å†…æ ¸å®‰å…¨æ¨¡å—ï¼Œ
å®ƒè¡¥å……äº†åŸºäºæ ‡å‡† Linux ç”¨æˆ·å’Œç»„çš„æƒé™ï¼Œå°†ç¨‹åºé™åˆ¶åœ¨ä¸€ç»„æœ‰é™çš„èµ„æºä¸­ã€‚
AppArmor å¯ä»¥é…ç½®ä¸ºä»»ä½•åº”ç”¨ç¨‹åºå‡å°‘æ½œåœ¨çš„æ”»å‡»é¢ï¼Œå¹¶ä¸”æä¾›æ›´åŠ æ·±å…¥çš„é˜²å¾¡ã€‚
å®ƒé€šè¿‡è°ƒæ•´é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œä»¥å…è®¸ç‰¹å®šç¨‹åºæˆ–å®¹å™¨æ‰€éœ€çš„è®¿é—®ï¼Œ
å¦‚ Linux æƒèƒ½å­—ã€ç½‘ç»œè®¿é—®ã€æ–‡ä»¶æƒé™ç­‰ã€‚
æ¯ä¸ªé…ç½®æ–‡ä»¶éƒ½å¯ä»¥åœ¨ <strong>å¼ºåˆ¶ï¼ˆenforcingï¼‰</strong>
æ¨¡å¼ï¼ˆé˜»æ­¢è®¿é—®ä¸å…è®¸çš„èµ„æºï¼‰æˆ– <strong>æŠ•è¯‰ï¼ˆcomplainï¼‰</strong> æ¨¡å¼ï¼ˆä»…æŠ¥å‘Šå†²çªï¼‰ä¸‹è¿è¡Œã€‚</p><p>AppArmor å¯ä»¥é€šè¿‡é™åˆ¶å…è®¸å®¹å™¨æ‰§è¡Œçš„æ“ä½œï¼Œ
å’Œ/æˆ–é€šè¿‡ç³»ç»Ÿæ—¥å¿—æä¾›æ›´å¥½çš„å®¡è®¡æ¥å¸®åŠ©ä½ è¿è¡Œæ›´å®‰å…¨çš„éƒ¨ç½²ã€‚
ä½†æ˜¯ï¼Œé‡è¦çš„æ˜¯è¦è®°ä½ AppArmor ä¸æ˜¯çµä¸¹å¦™è¯ï¼Œ
åªèƒ½åšéƒ¨åˆ†äº‹æƒ…æ¥é˜²æ­¢åº”ç”¨ç¨‹åºä»£ç ä¸­çš„æ¼æ´ã€‚
æä¾›è‰¯å¥½çš„é™åˆ¶æ€§é…ç½®æ–‡ä»¶ï¼Œå¹¶ä»å…¶ä»–è§’åº¦å¼ºåŒ–ä½ çš„åº”ç”¨ç¨‹åºå’Œé›†ç¾¤éå¸¸é‡è¦ã€‚</p><h2 id=æ•™ç¨‹ç›®æ ‡>æ•™ç¨‹ç›®æ ‡</h2><ul><li>æŸ¥çœ‹å¦‚ä½•åœ¨èŠ‚ç‚¹ä¸ŠåŠ è½½é…ç½®æ–‡ä»¶ç¤ºä¾‹</li><li>äº†è§£å¦‚ä½•åœ¨ Pod ä¸Šå¼ºåˆ¶æ‰§è¡Œé…ç½®æ–‡ä»¶</li><li>äº†è§£å¦‚ä½•æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å·²åŠ è½½</li><li>æŸ¥çœ‹è¿åé…ç½®æ–‡ä»¶æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ</li><li>æŸ¥çœ‹æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ</li></ul><h2 id=å‡†å¤‡å¼€å§‹>å‡†å¤‡å¼€å§‹</h2><p>ç¡®ä¿ï¼š</p><ol><li><p>Kubernetes ç‰ˆæœ¬è‡³å°‘æ˜¯ v1.4 â€”â€” AppArmor åœ¨ Kubernetes v1.4 ç‰ˆæœ¬ä¸­æ‰æ·»åŠ äº†å¯¹ AppArmor çš„æ”¯æŒã€‚
æ—©äº v1.4 ç‰ˆæœ¬çš„ Kubernetes ç»„ä»¶ä¸çŸ¥é“æ–°çš„ AppArmor
æ³¨è§£å¹¶ä¸”å°†ä¼š <strong>é»˜è®¤å¿½ç•¥</strong> æä¾›çš„ä»»ä½• AppArmor è®¾ç½®ã€‚
ä¸ºäº†ç¡®ä¿ä½ çš„ Pod èƒ½å¤Ÿå¾—åˆ°é¢„æœŸçš„ä¿æŠ¤ï¼Œå¿…é¡»éªŒè¯èŠ‚ç‚¹çš„ Kubelet ç‰ˆæœ¬ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes -o<span style=color:#666>=</span><span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>$&#39;{range .items[*]}{@.metadata.name}: {@.status.nodeInfo.kubeletVersion}\n{end}&#39;</span>
</span></span></code></pre></div><pre tabindex=0><code>gke-test-default-pool-239f5d02-gyn2: v1.4.0
gke-test-default-pool-239f5d02-x1kf: v1.4.0
gke-test-default-pool-239f5d02-xwux: v1.4.0
</code></pre></li></ol><ol start=2><li><p>AppArmor å†…æ ¸æ¨¡å—å·²å¯ç”¨ â€”â€” è¦ä½¿ Linux å†…æ ¸å¼ºåˆ¶æ‰§è¡Œ AppArmor é…ç½®æ–‡ä»¶ï¼Œ
å¿…é¡»å®‰è£…å¹¶ä¸”å¯åŠ¨ AppArmor å†…æ ¸æ¨¡å—ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ‰å‡ ä¸ªå‘è¡Œç‰ˆæ”¯æŒè¯¥æ¨¡å—ï¼Œ
å¦‚ Ubuntu å’Œ SUSEï¼Œè¿˜æœ‰è®¸å¤šå‘è¡Œç‰ˆæä¾›å¯é€‰æ”¯æŒã€‚è¦æ£€æŸ¥æ¨¡å—æ˜¯å¦å·²å¯ç”¨ï¼Œè¯·æ£€æŸ¥
<code>/sys/module/apparmor/parameters/enabled</code> æ–‡ä»¶ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat /sys/module/apparmor/parameters/enabled
</span></span><span style=display:flex><span>Y
</span></span></code></pre></div><p>å¦‚æœ Kubelet åŒ…å« AppArmor æ”¯æŒï¼ˆ>= v1.4ï¼‰ï¼Œ
ä½†æ˜¯å†…æ ¸æ¨¡å—æœªå¯ç”¨ï¼Œå®ƒå°†æ‹’ç»è¿è¡Œå¸¦æœ‰ AppArmor é€‰é¡¹çš„ Podã€‚</p></li></ol><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p>Ubuntu æºå¸¦äº†è®¸å¤šæ²¡æœ‰åˆå¹¶åˆ°ä¸Šæ¸¸ Linux å†…æ ¸ä¸­çš„ AppArmor è¡¥ä¸ï¼Œ
åŒ…æ‹¬æ·»åŠ é™„åŠ é’©å­å’Œç‰¹æ€§çš„è¡¥ä¸ã€‚Kubernetes åªåœ¨ä¸Šæ¸¸ç‰ˆæœ¬ä¸­æµ‹è¯•è¿‡ï¼Œä¸æ‰¿è¯ºæ”¯æŒå…¶ä»–ç‰¹æ€§ã€‚</div><ol start=3><li>å®¹å™¨è¿è¡Œæ—¶æ”¯æŒ AppArmor â€”â€” ç›®å‰æ‰€æœ‰å¸¸è§çš„ Kubernetes æ”¯æŒçš„å®¹å™¨è¿è¡Œæ—¶éƒ½åº”è¯¥æ”¯æŒ AppArmorï¼Œ
åƒ <a class=glossary-tooltip title='Docker æ˜¯ä¸€ç§å¯ä»¥æä¾›æ“ä½œç³»ç»Ÿçº§åˆ«è™šæ‹ŸåŒ–ï¼ˆä¹Ÿç§°ä½œå®¹å™¨ï¼‰çš„è½¯ä»¶æŠ€æœ¯ã€‚' data-toggle=tooltip data-placement=top href=https://docs.docker.com/engine/ target=_blank aria-label=Docker>Docker</a>ã€<a class=glossary-tooltip title='ä¸“ç”¨äº Kubernetes çš„è½»é‡çº§å®¹å™¨è¿è¡Œæ—¶è½¯ä»¶' data-toggle=tooltip data-placement=top href=https://cri-o.io/#what-is-cri-o target=_blank aria-label=CRI-O>CRI-O</a>
æˆ– <a class=glossary-tooltip title=å¼ºè°ƒç®€å•æ€§ã€å¥å£®æ€§å’Œå¯ç§»æ¤æ€§çš„ä¸€ç§å®¹å™¨è¿è¡Œæ—¶ data-toggle=tooltip data-placement=top href=https://containerd.io/docs/ target=_blank aria-label=containerd>containerd</a>ã€‚
è¯·å‚è€ƒç›¸åº”çš„è¿è¡Œæ—¶æ–‡æ¡£å¹¶éªŒè¯é›†ç¾¤æ˜¯å¦æ»¡è¶³ä½¿ç”¨ AppArmor çš„è¦æ±‚ã€‚</li></ol><ol start=4><li><p>é…ç½®æ–‡ä»¶å·²åŠ è½½ â€”â€” é€šè¿‡æŒ‡å®šæ¯ä¸ªå®¹å™¨éƒ½åº”ä½¿ç”¨çš„ AppArmor é…ç½®æ–‡ä»¶ï¼Œ
AppArmor ä¼šè¢«åº”ç”¨åˆ° Pod ä¸Šã€‚å¦‚æœæŒ‡å®šçš„ä»»ä½•é…ç½®æ–‡ä»¶å°šæœªåŠ è½½åˆ°å†…æ ¸ï¼Œ
Kubeletï¼ˆ>= v1.4ï¼‰å°†æ‹’ç» Podã€‚
é€šè¿‡æ£€æŸ¥ <code>/sys/kernel/security/apparmor/profiles</code> æ–‡ä»¶ï¼Œ
å¯ä»¥æŸ¥çœ‹èŠ‚ç‚¹åŠ è½½äº†å“ªäº›é…ç½®æ–‡ä»¶ã€‚ä¾‹å¦‚:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh gke-test-default-pool-239f5d02-gyn2 <span style=color:#b44>&#34;sudo cat /sys/kernel/security/apparmor/profiles | sort&#34;</span>
</span></span></code></pre></div><pre tabindex=0><code>apparmor-test-deny-write (enforce)
apparmor-test-audit-write (enforce)
docker-default (enforce)
k8s-nginx (enforce)
</code></pre><p>æœ‰å…³åœ¨èŠ‚ç‚¹ä¸ŠåŠ è½½é…ç½®æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a href=#setting-up-nodes-with-profiles>ä½¿ç”¨é…ç½®æ–‡ä»¶è®¾ç½®èŠ‚ç‚¹</a>ã€‚</p></li></ol><p>åªè¦ Kubelet ç‰ˆæœ¬åŒ…å« AppArmor æ”¯æŒ(>=v1.4)ï¼Œ
å¦‚æœä¸æ»¡è¶³è¿™äº›å…ˆå†³æ¡ä»¶ï¼ŒKubelet å°†æ‹’ç»å¸¦æœ‰ AppArmor é€‰é¡¹çš„ Podã€‚
ä½ è¿˜å¯ä»¥é€šè¿‡æ£€æŸ¥èŠ‚ç‚¹å°±ç»ªçŠ¶å†µæ¶ˆæ¯æ¥éªŒè¯èŠ‚ç‚¹ä¸Šçš„ AppArmor æ”¯æŒï¼ˆå°½ç®¡è¿™å¯èƒ½ä¼šåœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­åˆ é™¤ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get nodes -o<span style=color:#666>=</span><span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{range .items[*]}{@.metadata.name}: {.status.conditions[?(@.reason==&#34;KubeletReady&#34;)].message}{&#34;\n&#34;}{end}&#39;</span>
</span></span></code></pre></div><pre tabindex=0><code>gke-test-default-pool-239f5d02-gyn2: kubelet is posting ready status. AppArmor enabled
gke-test-default-pool-239f5d02-x1kf: kubelet is posting ready status. AppArmor enabled
gke-test-default-pool-239f5d02-xwux: kubelet is posting ready status. AppArmor enabled
</code></pre><h2 id=securing-a-pod>ä¿æŠ¤ Pod</h2><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p>AppArmor ç›®å‰å¤„äº Beta é˜¶æ®µï¼Œå› æ­¤é€‰é¡¹ä»¥æ³¨è§£å½¢å¼è®¾å®šã€‚
ä¸€æ—¦ AppArmor æ”¯æŒè¿›å…¥æ­£å¼å‘å¸ƒé˜¶æ®µï¼Œæ³¨è§£å°†è¢«æ›¿æ¢ä¸ºä¸€é˜¶çš„èµ„æºå­—æ®µ
ï¼ˆæ›´å¤šè¯¦æƒ…å‚è§<a href=#upgrade-path-to-general-availability>å‡çº§åˆ° GA çš„é€”å¾„</a>ï¼‰ã€‚</div><p>AppArmor é…ç½®æ–‡ä»¶æ˜¯æŒ‰ <strong>é€ä¸ªå®¹å™¨</strong> çš„å½¢å¼æ¥è®¾ç½®çš„ã€‚
è¦æŒ‡å®šç”¨æ¥è¿è¡Œ Pod å®¹å™¨çš„ AppArmor é…ç½®æ–‡ä»¶ï¼Œè¯·å‘ Pod çš„ metadata æ·»åŠ æ³¨è§£ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>container.apparmor.security.beta.kubernetes.io/&lt;container_name&gt;</span>:<span style=color:#bbb> </span>&lt;profile_ref&gt;<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>&lt;container_name></code> çš„åç§°æ˜¯é…ç½®æ–‡ä»¶æ‰€é’ˆå¯¹çš„å®¹å™¨çš„åç§°ï¼Œ<code>&lt;profile_def></code> åˆ™è®¾ç½®è¦åº”ç”¨çš„é…ç½®æ–‡ä»¶ã€‚
<code>&lt;profile_ref></code> å¯ä»¥æ˜¯ä»¥ä¸‹å–å€¼ä¹‹ä¸€ï¼š</p><ul><li><code>runtime/default</code> åº”ç”¨è¿è¡Œæ—¶çš„é»˜è®¤é…ç½®</li><li><code>localhost/&lt;profile_name></code> åº”ç”¨åœ¨ä¸»æœºä¸ŠåŠ è½½çš„åä¸º <code>&lt;profile_name></code> çš„é…ç½®æ–‡ä»¶</li><li><code>unconfined</code> è¡¨ç¤ºä¸åŠ è½½é…ç½®æ–‡ä»¶</li></ul><p>æœ‰å…³æ³¨è§£å’Œé…ç½®æ–‡ä»¶åç§°æ ¼å¼çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… <a href=#api-reference>API å‚è€ƒ</a>ã€‚</p><p>Kubernetes AppArmor å¼ºåˆ¶æ‰§è¡Œæœºåˆ¶é¦–å…ˆæ£€æŸ¥æ‰€æœ‰å…ˆå†³æ¡ä»¶éƒ½å·²æ»¡è¶³ï¼Œ
ç„¶åå°†æ‰€é€‰çš„é…ç½®æ–‡ä»¶è½¬å‘åˆ°å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œå¼ºåˆ¶æ‰§è¡Œã€‚
å¦‚æœæœªæ»¡è¶³å…ˆå†³æ¡ä»¶ï¼ŒPod å°†è¢«æ‹’ç»ï¼Œå¹¶ä¸”ä¸ä¼šè¿è¡Œã€‚</p><p>è¦éªŒè¯æ˜¯å¦åº”ç”¨äº†é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨å®¹å™¨åˆ›å»ºäº‹ä»¶ä¸­æŸ¥æ‰¾æ‰€åˆ—å‡ºçš„ AppArmor å®‰å…¨é€‰é¡¹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get events | grep Created
</span></span></code></pre></div><pre tabindex=0><code>22s        22s         1         hello-apparmor     Pod       spec.containers{hello}   Normal    Created     {kubelet e2e-test-stclair-node-pool-31nt}   Created container with docker id 269a53b202d3; Security:[seccomp=unconfined apparmor=k8s-apparmor-example-deny-write]
</code></pre><p>ä½ è¿˜å¯ä»¥é€šè¿‡æ£€æŸ¥å®¹å™¨çš„ proc attrï¼Œç›´æ¥éªŒè¯å®¹å™¨çš„æ ¹è¿›ç¨‹æ˜¯å¦ä»¥æ­£ç¡®çš„é…ç½®æ–‡ä»¶è¿è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> &lt;pod_name&gt; -- cat /proc/1/attr/current
</span></span></code></pre></div><pre tabindex=0><code>k8s-apparmor-example-deny-write (enforce)
</code></pre><h2 id=example>ä¸¾ä¾‹</h2><p><strong>æœ¬ä¾‹å‡è®¾ä½ å·²ç»è®¾ç½®äº†ä¸€ä¸ªé›†ç¾¤ä½¿ç”¨ AppArmor æ”¯æŒã€‚</strong></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†è¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶åŠ è½½åˆ°èŠ‚ç‚¹ä¸Šã€‚é…ç½®æ–‡ä»¶æ‹’ç»æ‰€æœ‰æ–‡ä»¶å†™å…¥ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic>#include &lt;tunables/global&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>profile k8s-apparmor-example-deny-write <span style=color:#b8860b>flags</span><span style=color:#666>=(</span>attach_disconnected<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic>#include &lt;abstractions/base&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  file,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#080;font-style:italic># æ‹’ç»æ‰€æœ‰æ–‡ä»¶å†™å…¥</span>
</span></span><span style=display:flex><span>  deny /** w,
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>ç”±äºæˆ‘ä»¬ä¸çŸ¥é“ Pod å°†è¢«è°ƒåº¦åˆ°å“ªé‡Œï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸ŠåŠ è½½é…ç½®æ–‡ä»¶ã€‚
åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ SSH æ¥å®‰è£…æ¦‚è¦æ–‡ä»¶ï¼Œ
ä½†æ˜¯åœ¨<a href=#setting-up-nodes-with-profiles>ä½¿ç”¨é…ç½®æ–‡ä»¶è®¾ç½®èŠ‚ç‚¹</a>ä¸­è®¨è®ºäº†å…¶ä»–æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#b8860b>NODES</span><span style=color:#666>=(</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ä½ çš„èŠ‚ç‚¹çš„å¯é€šè¿‡ SSH è®¿é—®çš„åŸŸå</span>
</span></span><span style=display:flex><span>    gke-test-default-pool-239f5d02-gyn2.us-central1-a.my-k8s
</span></span><span style=display:flex><span>    gke-test-default-pool-239f5d02-x1kf.us-central1-a.my-k8s
</span></span><span style=display:flex><span>    gke-test-default-pool-239f5d02-xwux.us-central1-a.my-k8s<span style=color:#666>)</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>for</span> NODE in <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>NODES</span>[*]<span style=color:#b68;font-weight:700>}</span>; <span style=color:#a2f;font-weight:700>do</span> ssh <span style=color:#b8860b>$NODE</span> <span style=color:#b44>&#39;sudo apparmor_parser -q &lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>#include &lt;tunables/global&gt;
</span></span></span><span style=display:flex><span><span style=color:#b44>
</span></span></span><span style=display:flex><span><span style=color:#b44>profile k8s-apparmor-example-deny-write flags=(attach_disconnected) {
</span></span></span><span style=display:flex><span><span style=color:#b44>  #include &lt;abstractions/base&gt;
</span></span></span><span style=display:flex><span><span style=color:#b44>
</span></span></span><span style=display:flex><span><span style=color:#b44>  file,
</span></span></span><span style=display:flex><span><span style=color:#b44>
</span></span></span><span style=display:flex><span><span style=color:#b44>  # Deny all file writes.
</span></span></span><span style=display:flex><span><span style=color:#b44>  deny /** w,
</span></span></span><span style=display:flex><span><span style=color:#b44>}
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF&#39;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿è¡Œä¸€ä¸ªå¸¦æœ‰æ‹’ç»å†™å…¥é…ç½®æ–‡ä»¶çš„ç®€å• â€œHello AppArmorâ€ Podï¼š</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/hello-apparmor.yaml download=pods/security/hello-apparmor.yaml><code>pods/security/hello-apparmor.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-hello-apparmor-yaml")' title="Copy pods/security/hello-apparmor.yaml to clipboard"></img></div><div class=includecode id=pods-security-hello-apparmor-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello-apparmor<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># å‘ŠçŸ¥ Kubernetes å»åº”ç”¨ AppArmor é…ç½® &#34;k8s-apparmor-example-deny-write&#34;ã€‚</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># è¯·æ³¨æ„ï¼Œå¦‚æœèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Kubernetes ä¸æ˜¯ 1.4 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œæ­¤æ³¨è§£å°†è¢«å¿½ç•¥ã€‚</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>container.apparmor.security.beta.kubernetes.io/hello</span>:<span style=color:#bbb> </span>localhost/k8s-apparmor-example-deny-write<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;echo &#39;Hello AppArmor!&#39; &amp;&amp; sleep 1h&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f ./hello-apparmor.yaml
</span></span></code></pre></div><p>å¦‚æœæˆ‘ä»¬æŸ¥çœ‹ Pod äº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Pod å®¹å™¨æ˜¯ç”¨ AppArmor
é…ç½®æ–‡ä»¶ â€œk8s-apparmor-example-deny-writeâ€ æ‰€åˆ›å»ºçš„ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get events | grep hello-apparmor
</span></span></code></pre></div><pre tabindex=0><code>14s        14s         1         hello-apparmor   Pod                                Normal    Scheduled   {default-scheduler }                           Successfully assigned hello-apparmor to gke-test-default-pool-239f5d02-gyn2
14s        14s         1         hello-apparmor   Pod       spec.containers{hello}   Normal    Pulling     {kubelet gke-test-default-pool-239f5d02-gyn2}   pulling image &#34;busybox&#34;
13s        13s         1         hello-apparmor   Pod       spec.containers{hello}   Normal    Pulled      {kubelet gke-test-default-pool-239f5d02-gyn2}   Successfully pulled image &#34;busybox&#34;
13s        13s         1         hello-apparmor   Pod       spec.containers{hello}   Normal    Created     {kubelet gke-test-default-pool-239f5d02-gyn2}   Created container with docker id 06b6cd1c0989; Security:[seccomp=unconfined apparmor=k8s-apparmor-example-deny-write]
13s        13s         1         hello-apparmor   Pod       spec.containers{hello}   Normal    Started     {kubelet gke-test-default-pool-239f5d02-gyn2}   Started container with docker id 06b6cd1c0989
</code></pre><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥è¯¥é…ç½®æ–‡ä»¶çš„ proc attr æ¥éªŒè¯å®¹å™¨æ˜¯å¦å®é™…ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶è¿è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> hello-apparmor -- cat /proc/1/attr/current
</span></span></code></pre></div><pre tabindex=0><code>k8s-apparmor-example-deny-write (enforce)
</code></pre><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•é€šè¿‡å†™å…¥æ–‡ä»¶æ¥è¿åé…ç½®æ–‡ä»¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#a2f>exec</span> hello-apparmor -- touch /tmp/test
</span></span></code></pre></div><pre tabindex=0><code>touch: /tmp/test: Permission denied
error: error executing remote command: command terminated with non-zero exit code: Error executing in Docker Container: 1
</code></pre><p>æœ€åï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœæˆ‘ä»¬è¯•å›¾æŒ‡å®šä¸€ä¸ªå°šæœªåŠ è½½çš„é…ç½®æ–‡ä»¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f /dev/stdin &lt;&lt;EOF
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello-apparmor-2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>container.apparmor.security.beta.kubernetes.io/hello</span>:<span style=color:#bbb> </span>localhost/k8s-apparmor-example-allow-write<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>hello<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>busybox:1.28<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#bbb> </span><span style=color:#b44>&#34;sh&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;-c&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;echo &#39;Hello AppArmor!&#39; &amp;&amp; sleep 1h&#34;</span><span style=color:#bbb> </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>EOF<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>pod/hello-apparmor-2 created<span style=color:#bbb>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl describe pod hello-apparmor-2
</span></span></code></pre></div><pre tabindex=0><code>Name:          hello-apparmor-2
Namespace:     default
Node:          gke-test-default-pool-239f5d02-x1kf/
Start Time:    Tue, 30 Aug 2016 17:58:56 -0700
Labels:        &lt;none&gt;
Annotations:   container.apparmor.security.beta.kubernetes.io/hello=localhost/k8s-apparmor-example-allow-write
Status:        Pending
Reason:        AppArmor
Message:       Pod Cannot enforce AppArmor: profile &#34;k8s-apparmor-example-allow-write&#34; is not loaded
IP:
Controllers:   &lt;none&gt;
Containers:
  hello:
    Container ID:
    Image:     busybox
    Image ID:
    Port:
    Command:
      sh
      -c
      echo &#39;Hello AppArmor!&#39; &amp;&amp; sleep 1h
    State:              Waiting
      Reason:           Blocked
    Ready:              False
    Restart Count:      0
    Environment:        &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-dnz7v (ro)
Conditions:
  Type          Status
  Initialized   True
  Ready         False
  PodScheduled  True
Volumes:
  default-token-dnz7v:
    Type:    Secret (a volume populated by a Secret)
    SecretName:    default-token-dnz7v
    Optional:   false
QoS Class:      BestEffort
Node-Selectors: &lt;none&gt;
Tolerations:    &lt;none&gt;
Events:
  FirstSeen    LastSeen    Count    From                        SubobjectPath    Type        Reason        Message
  ---------    --------    -----    ----                        -------------    --------    ------        -------
  23s          23s         1        {default-scheduler }                         Normal      Scheduled     Successfully assigned hello-apparmor-2 to e2e-test-stclair-node-pool-t1f5
  23s          23s         1        {kubelet e2e-test-stclair-node-pool-t1f5}             Warning        AppArmor    Cannot enforce AppArmor: profile &#34;k8s-apparmor-example-allow-write&#34; is not loaded
</code></pre><p>æ³¨æ„ Pod å‘ˆç° Pending çŠ¶æ€ï¼Œå¹¶ä¸”æ˜¾ç¤ºä¸€æ¡æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯ï¼š
<code>Pod Cannot enforce AppArmor: profile "k8s-apparmor-example-allow-write" is not loaded</code>ã€‚
è¿˜ç”¨ç›¸åŒçš„æ¶ˆæ¯è®°å½•äº†ä¸€ä¸ªäº‹ä»¶ã€‚</p><h2 id=administration>ç®¡ç†</h2><h3 id=setting-up-nodes-with-profiles>ä½¿ç”¨é…ç½®æ–‡ä»¶è®¾ç½®èŠ‚ç‚¹</h3><p>Kubernetes ç›®å‰ä¸æä¾›ä»»ä½•æœ¬åœ°æœºåˆ¶æ¥å°† AppArmor é…ç½®æ–‡ä»¶åŠ è½½åˆ°èŠ‚ç‚¹ä¸Šã€‚
æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è®¾ç½®é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p><ul><li>é€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ Pod çš„
<a href=/zh-cn/docs/concepts/workloads/controllers/daemonset/>DaemonSet</a> æ¥ç¡®ä¿åŠ è½½äº†æ­£ç¡®çš„é…ç½®æ–‡ä»¶ã€‚
å¯ä»¥åœ¨<a href=https://git.k8s.io/kubernetes/test/images/apparmor-loader>è¿™é‡Œ</a>æ‰¾åˆ°å®ç°ç¤ºä¾‹ã€‚</li><li>åœ¨èŠ‚ç‚¹åˆå§‹åŒ–æ—¶ï¼Œä½¿ç”¨èŠ‚ç‚¹åˆå§‹åŒ–è„šæœ¬(ä¾‹å¦‚ Saltã€Ansible ç­‰)æˆ–é•œåƒã€‚</li><li>é€šè¿‡å°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°æ¯ä¸ªèŠ‚ç‚¹å¹¶é€šè¿‡ SSH åŠ è½½å®ƒä»¬ï¼Œå¦‚<a href=#example>ç¤ºä¾‹</a>ã€‚</li></ul><p>è°ƒåº¦ç¨‹åºä¸çŸ¥é“å“ªäº›é…ç½®æ–‡ä»¶åŠ è½½åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤å¿…é¡»å°†å…¨å¥—é…ç½®æ–‡ä»¶åŠ è½½åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šã€‚
å¦ä¸€ç§æ–¹æ³•æ˜¯ä¸ºèŠ‚ç‚¹ä¸Šçš„æ¯ä¸ªé…ç½®æ–‡ä»¶ï¼ˆæˆ–é…ç½®æ–‡ä»¶ç±»ï¼‰æ·»åŠ èŠ‚ç‚¹æ ‡ç­¾ï¼Œ
å¹¶ä½¿ç”¨<a href=/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/>èŠ‚ç‚¹é€‰æ‹©å™¨</a>ç¡®ä¿
Pod åœ¨å…·æœ‰æ‰€éœ€é…ç½®æ–‡ä»¶çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p><h3 id=disabling-apparmor>ç¦ç”¨ AppArmor</h3><p>å¦‚æœä½ ä¸å¸Œæœ› AppArmor åœ¨é›†ç¾¤ä¸Šå¯ç”¨ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæ ‡å¿—ç¦ç”¨å®ƒï¼š</p><pre tabindex=0><code>--feature-gates=AppArmor=false
</code></pre><p>ç¦ç”¨æ—¶ï¼Œä»»ä½•åŒ…å« AppArmor é…ç½®æ–‡ä»¶çš„ Pod éƒ½å°†å¯¼è‡´éªŒè¯å¤±è´¥ï¼Œä¸”è¿”å› â€œForbiddenâ€ é”™è¯¯ã€‚</p><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p>å³ä½¿æ­¤ Kubernetes ç‰¹æ€§è¢«ç¦ç”¨ï¼Œè¿è¡Œæ—¶ä»å¯èƒ½å¼ºåˆ¶æ‰§è¡Œé»˜è®¤é…ç½®æ–‡ä»¶ã€‚
å½“ AppArmor å‡çº§ä¸ºæ­£å¼ç‰ˆ (GA) æ—¶ï¼Œç¦ç”¨ AppArmor åŠŸèƒ½çš„é€‰é¡¹å°†è¢«åˆ é™¤ã€‚</div><h2 id=authoring-profiles>ç¼–å†™é…ç½®æ–‡ä»¶</h2><p>è·å¾—æ­£ç¡®æŒ‡å®šçš„ AppArmor é…ç½®æ–‡ä»¶å¯èƒ½æ˜¯ä¸€ä»¶æ£˜æ‰‹çš„äº‹æƒ…ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€äº›å·¥å…·å¯ä»¥å¸®åŠ©ä½ åšåˆ°è¿™ä¸€ç‚¹ï¼š</p><ul><li><code>aa-genprof</code> å’Œ <code>aa-logprof</code>
é€šè¿‡ç›‘è§†åº”ç”¨ç¨‹åºçš„æ´»åŠ¨å’Œæ—¥å¿—å¹¶å‡†è®¸å®ƒæ‰€æ‰§è¡Œçš„æ“ä½œæ¥ç”Ÿæˆé…ç½®æ–‡ä»¶è§„åˆ™ã€‚
<a href=https://gitlab.com/apparmor/apparmor/wikis/Profiling_with_tools>AppArmor æ–‡æ¡£</a>æä¾›äº†è¿›ä¸€æ­¥çš„æŒ‡å¯¼ã€‚</li><li><a href=https://github.com/jfrazelle/bane>bane</a>
æ˜¯ä¸€ä¸ªç”¨äº Dockerçš„ AppArmor é…ç½®æ–‡ä»¶ç”Ÿæˆå™¨ï¼Œå®ƒä½¿ç”¨ä¸€ç§ç®€åŒ–çš„ç”»åƒè¯­è¨€ï¼ˆprofile languageï¼‰ã€‚</li></ul><p>æƒ³è¦è°ƒè¯• AppArmor çš„é—®é¢˜ï¼Œä½ å¯ä»¥æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼ŒæŸ¥çœ‹å…·ä½“æ‹’ç»äº†ä»€ä¹ˆã€‚
AppArmor å°†è¯¦ç»†æ¶ˆæ¯è®°å½•åˆ° <code>dmesg</code>ï¼Œ
é”™è¯¯é€šå¸¸å¯ä»¥åœ¨ç³»ç»Ÿæ—¥å¿—ä¸­æˆ–é€šè¿‡ <code>journalctl</code> æ‰¾åˆ°ã€‚
æ›´å¤šè¯¦ç»†ä¿¡æ¯å‚è§ <a href=https://gitlab.com/apparmor/apparmor/wikis/AppArmor_Failures>AppArmor å¤±è´¥</a>ã€‚</p><h2 id=api-reference>API å‚è€ƒ</h2><h3 id=pod-annotation>Pod æ³¨è§£</h3><p>æŒ‡å®šå®¹å™¨å°†ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼š</p><ul><li><strong>é”®å</strong>ï¼š<code>container.apparmor.security.beta.kubernetes.io/&lt;container_name></code>ï¼Œ
å…¶ä¸­ <code>&lt;container_name></code> ä¸ Pod ä¸­æŸå®¹å™¨çš„åç§°åŒ¹é…ã€‚
å¯ä»¥ä¸º Pod ä¸­çš„æ¯ä¸ªå®¹å™¨æŒ‡å®šå•ç‹¬çš„é…ç½®æ–‡ä»¶ã€‚</li><li><strong>é”®å€¼</strong>ï¼šå¯¹é…ç½®æ–‡ä»¶çš„å¼•ç”¨ï¼Œå¦‚ä¸‹æ‰€è¿°</li></ul><h3 id=profile-reference>é…ç½®æ–‡ä»¶å¼•ç”¨</h3><ul><li><code>runtime/default</code>ï¼šæŒ‡é»˜è®¤è¿è¡Œæ—¶é…ç½®æ–‡ä»¶ã€‚<ul><li>ç­‰åŒäºä¸æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œåªæ˜¯å®ƒä»ç„¶éœ€è¦å¯ç”¨ AppArmorã€‚</li><li>å®é™…ä¸Šï¼Œè®¸å¤šå®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ç›¸åŒçš„ OCI é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œåœ¨æ­¤å¤„å®šä¹‰ï¼š
<a href=https://github.com/containers/common/blob/main/pkg/apparmor/apparmor_linux_template.go>https://github.com/containers/common/blob/main/pkg/apparmor/apparmor_linux_template.go</a></li></ul></li><li><code>localhost/&lt;profile_name></code>ï¼šæŒ‰åç§°å¼•ç”¨åŠ è½½åˆ°èŠ‚ç‚¹ï¼ˆlocalhostï¼‰ä¸Šçš„é…ç½®æ–‡ä»¶ã€‚<ul><li>å¯èƒ½çš„é…ç½®æ–‡ä»¶ååœ¨<a href=https://gitlab.com/apparmor/apparmor/wikis/AppArmor_Core_Policy_Reference#profile-names-and-attachment-specifications>æ ¸å¿ƒç­–ç•¥å‚è€ƒ</a>ã€‚</li></ul></li><li><code>unconfined</code>ï¼šè¿™ç›¸å½“äºä¸ºå®¹å™¨ç¦ç”¨ AppArmorã€‚</li></ul><p>ä»»ä½•å…¶ä»–é…ç½®æ–‡ä»¶å¼•ç”¨æ ¼å¼æ— æ•ˆã€‚</p><h2 id=æ¥ä¸‹æ¥>æ¥ä¸‹æ¥</h2><p>å…¶ä»–èµ„æºï¼š</p><ul><li><a href=https://gitlab.com/apparmor/apparmor/wikis/QuickProfileLanguage>Apparmor é…ç½®æ–‡ä»¶è¯­è¨€å¿«é€ŸæŒ‡å—</a></li><li><a href=https://gitlab.com/apparmor/apparmor/wikis/Policy_Layout>Apparmor æ ¸å¿ƒç­–ç•¥å‚è€ƒ</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d5f847bcdb6f7efbfc9c8a180d73e29a>2 - åœ¨é›†ç¾¤çº§åˆ«åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</h1><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>æœ¬æ•™ç¨‹ä»…é€‚ç”¨äºæ–°é›†ç¾¤ã€‚</div><p>Pod å®‰å…¨å‡†å…¥ï¼ˆPSAï¼‰åœ¨ v1.23 åŠæ›´é«˜ç‰ˆæœ¬é»˜è®¤å¯ç”¨ï¼Œ
å› ä¸ºå®ƒå·²<a href=/blog/2021/12/09/pod-security-admission-beta/>è¿›é˜¶ä¸º Beta</a>ã€‚
Pod å®‰å…¨å‡†å…¥æ˜¯åœ¨åˆ›å»º Pod æ—¶åº”ç”¨
<a href=/zh-cn/docs/concepts/security/pod-security-standards/>Pod å®‰å…¨æ ‡å‡†</a>çš„å‡†å…¥æ§åˆ¶å™¨ã€‚
æœ¬æ•™ç¨‹å°†å‘ä½ å±•ç¤ºå¦‚ä½•åœ¨é›†ç¾¤çº§åˆ«å®æ–½ <code>baseline</code> Pod å®‰å…¨æ ‡å‡†ï¼Œ
è¯¥æ ‡å‡†å°†æ ‡å‡†é…ç½®åº”ç”¨äºé›†ç¾¤ä¸­çš„æ‰€æœ‰åå­—ç©ºé—´ã€‚</p><p>è¦å°† Pod å®‰å…¨æ ‡å‡†åº”ç”¨äºç‰¹å®šåå­—ç©ºé—´ï¼Œ
è¯·å‚é˜…<a href=/zh-cn/docs/tutorials/security/ns-level-pss>åœ¨åå­—ç©ºé—´çº§åˆ«åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</a>ã€‚</p><p>å¦‚æœä½ æ­£åœ¨è¿è¡Œ v1.25 ä»¥å¤–çš„ Kubernetes ç‰ˆæœ¬ï¼Œ
è¯·æŸ¥é˜…è¯¥ç‰ˆæœ¬çš„æ–‡æ¡£ã€‚</p><h2 id=å‡†å¤‡å¼€å§‹>å‡†å¤‡å¼€å§‹</h2><p>åœ¨ä½ çš„å·¥ä½œç«™ä¸­å®‰è£…ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li><a href=https://kind.sigs.k8s.io/docs/user/quick-start/#installation>KinD</a></li><li><a href=/zh-cn/docs/tasks/tools/>kubectl</a></li></ul><h2 id=choose-the-right-pod-security-standard-to-apply>æ­£ç¡®é€‰æ‹©è¦åº”ç”¨çš„ Pod å®‰å…¨æ ‡å‡†</h2><p><a href=/zh-cn/docs/concepts/security/pod-security-admission/>Pod å®‰å…¨å‡†å…¥</a>
å…è®¸ä½ ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼åº”ç”¨å†…ç½®çš„
<a href=/zh-cn/docs/concepts/security/pod-security-standards/>Pod å®‰å…¨æ ‡å‡†</a>ï¼š
<code>enforce</code>ã€<code>audit</code> å’Œ <code>warn</code>ã€‚</p><p>è¦æ”¶é›†ä¿¡æ¯ä»¥ä¾¿é€‰æ‹©æœ€é€‚åˆä½ çš„é…ç½®çš„ Pod å®‰å…¨æ ‡å‡†ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li><p>åˆ›å»ºä¸€ä¸ªæ²¡æœ‰åº”ç”¨ Pod å®‰å…¨æ ‡å‡†çš„é›†ç¾¤ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kind create cluster --name psa-wo-cluster-pss --image kindest/node:v1.24.0
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>Creating cluster &#34;psa-wo-cluster-pss&#34; ...
âœ“ Ensuring node image (kindest/node:v1.24.0) ğŸ–¼
âœ“ Preparing nodes ğŸ“¦  
âœ“ Writing configuration ğŸ“œ
âœ“ Starting control-plane ğŸ•¹ï¸
âœ“ Installing CNI ğŸ”Œ
âœ“ Installing StorageClass ğŸ’¾
Set kubectl context to &#34;kind-psa-wo-cluster-pss&#34;
You can now use your cluster with:

kubectl cluster-info --context kind-psa-wo-cluster-pss

Thanks for using kind! ğŸ˜Š
</code></pre></li></ol><ol start=2><li><p>å°† kubectl ä¸Šä¸‹æ–‡è®¾ç½®ä¸ºæ–°é›†ç¾¤ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info --context kind-psa-wo-cluster-pss
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>Kubernetes control plane is running at https://127.0.0.1:61350 
CoreDNS is running at https://127.0.0.1:61350/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
</code></pre></li></ol><ol start=3><li><p>è·å–é›†ç¾¤ä¸­çš„åå­—ç©ºé—´åˆ—è¡¨ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get ns
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>NAME                 STATUS   AGE
default              Active   9m30s
kube-node-lease      Active   9m32s
kube-public          Active   9m32s
kube-system          Active   9m32s
local-path-storage   Active   9m26s
</code></pre></li></ol><ol start=4><li><p>ä½¿ç”¨ <code>--dry-run=server</code> æ¥äº†è§£åº”ç”¨ä¸åŒçš„ Pod å®‰å…¨æ ‡å‡†æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p><ol><li><p>Privileged</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label --dry-run<span style=color:#666>=</span>server --overwrite ns --all <span style=color:#b62;font-weight:700>\ </span>                   
</span></span><span style=display:flex><span>pod-security.kubernetes.io/enforce<span style=color:#666>=</span>privileged
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>namespace/default labeled
namespace/kube-node-lease labeled
namespace/kube-public labeled
namespace/kube-system labeled
namespace/local-path-storage labeled
</code></pre></li><li><p>Baseline</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label --dry-run<span style=color:#666>=</span>server --overwrite ns --all <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>pod-security.kubernetes.io/enforce<span style=color:#666>=</span>baseline
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>namespace/default labeled
namespace/kube-node-lease labeled
namespace/kube-public labeled
Warning: existing pods in namespace &#34;kube-system&#34; violate the new PodSecurity enforce level &#34;baseline:latest&#34;
Warning: etcd-psa-wo-cluster-pss-control-plane (and 3 other pods): host namespaces, hostPath volumes
Warning: kindnet-vzj42: non-default capabilities, host namespaces, hostPath volumes
Warning: kube-proxy-m6hwf: host namespaces, hostPath volumes, privileged
namespace/kube-system labeled
namespace/local-path-storage labeled
</code></pre></li><li><p>Restricted</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label --dry-run<span style=color:#666>=</span>server --overwrite ns --all <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>pod-security.kubernetes.io/enforce<span style=color:#666>=</span>restricted
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>namespace/default labeled
namespace/kube-node-lease labeled
namespace/kube-public labeled
Warning: existing pods in namespace &#34;kube-system&#34; violate the new PodSecurity enforce level &#34;restricted:latest&#34;
Warning: coredns-7bb9c7b568-hsptc (and 1 other pod): unrestricted capabilities, runAsNonRoot != true, seccompProfile
Warning: etcd-psa-wo-cluster-pss-control-plane (and 3 other pods): host namespaces, hostPath volumes, allowPrivilegeEscalation != false, unrestricted capabilities, restricted volume types, runAsNonRoot != true
Warning: kindnet-vzj42: non-default capabilities, host namespaces, hostPath volumes, allowPrivilegeEscalation != false, unrestricted capabilities, restricted volume types, runAsNonRoot != true, seccompProfile
Warning: kube-proxy-m6hwf: host namespaces, hostPath volumes, privileged, allowPrivilegeEscalation != false, unrestricted capabilities, restricted volume types, runAsNonRoot != true, seccompProfile
namespace/kube-system labeled
Warning: existing pods in namespace &#34;local-path-storage&#34; violate the new PodSecurity enforce level &#34;restricted:latest&#34;
Warning: local-path-provisioner-d6d9f7ffc-lw9lh: allowPrivilegeEscalation != false, unrestricted capabilities, runAsNonRoot != true, seccompProfile
namespace/local-path-storage labeled
</code></pre></li></ol></li></ol><p>ä»å‰é¢çš„è¾“å‡ºä¸­ï¼Œä½ ä¼šæ³¨æ„åˆ°åº”ç”¨ <code>privileged</code> Pod å®‰å…¨æ ‡å‡†ä¸ä¼šæ˜¾ç¤ºä»»ä½•åå­—ç©ºé—´çš„è­¦å‘Šã€‚
ç„¶è€Œï¼Œ<code>baseline</code> å’Œ <code>restricted</code> æ ‡å‡†éƒ½æœ‰è­¦å‘Šï¼Œç‰¹åˆ«æ˜¯åœ¨ <code>kube-system</code> åå­—ç©ºé—´ä¸­ã€‚</p><h2 id=set-modes-versions-and-standards>è®¾ç½®æ¨¡å¼ã€ç‰ˆæœ¬å’Œæ ‡å‡†</h2><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œä½ å°†ä»¥ä¸‹ Pod å®‰å…¨æ ‡å‡†åº”ç”¨äºæœ€æ–°ï¼ˆ<code>latest</code>ï¼‰ç‰ˆæœ¬ï¼š</p><ul><li>åœ¨ <code>enforce</code> æ¨¡å¼ä¸‹çš„ <code>baseline</code> æ ‡å‡†ã€‚</li><li><code>warn</code> å’Œ <code>audit</code> æ¨¡å¼ä¸‹çš„ <code>restricted</code> æ ‡å‡†ã€‚</li></ul><p><code>baseline</code> Pod å®‰å…¨æ ‡å‡†æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„ä¸­é—´ç«‹åœºï¼Œèƒ½å¤Ÿä¿æŒè±å…åˆ—è¡¨ç®€çŸ­å¹¶é˜²æ­¢å·²çŸ¥çš„ç‰¹æƒå‡çº§ã€‚</p><p>æ­¤å¤–ï¼Œä¸ºäº†é˜²æ­¢ <code>kube-system</code> ä¸­çš„ Pod å¤±è´¥ï¼Œä½ å°†å…é™¤è¯¥åå­—ç©ºé—´åº”ç”¨ Pod å®‰å…¨æ ‡å‡†ã€‚</p><p>åœ¨ä½ è‡ªå·±çš„ç¯å¢ƒä¸­å®æ–½ Pod å®‰å…¨å‡†å…¥æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹äº‹é¡¹ï¼š</p><ol><li><p>æ ¹æ®åº”ç”¨äºé›†ç¾¤çš„é£é™©çŠ¶å†µï¼Œæ›´ä¸¥æ ¼çš„ Pod å®‰å…¨æ ‡å‡†ï¼ˆå¦‚ <code>restricted</code>ï¼‰å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p></li><li><p>å¯¹ <code>kube-system</code> åå­—ç©ºé—´è¿›è¡Œèµ¦å…ä¼šå…è®¸ Pod åœ¨å…¶ä¸­ä»¥ <code>privileged</code> æ¨¡å¼è¿è¡Œã€‚
å¯¹äºå®é™…ä½¿ç”¨ï¼ŒKubernetes é¡¹ç›®å¼ºçƒˆå»ºè®®ä½ åº”ç”¨ä¸¥æ ¼çš„ RBAC ç­–ç•¥æ¥é™åˆ¶å¯¹ <code>kube-system</code> çš„è®¿é—®ï¼Œ
éµå¾ªæœ€å°ç‰¹æƒåŸåˆ™ã€‚</p></li><li><p>åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ŒPod å®‰å…¨å‡†å…¥æ§åˆ¶å™¨å¯ä»¥ä½¿ç”¨è¯¥æ–‡ä»¶æ¥å®ç°è¿™äº› Pod å®‰å…¨æ ‡å‡†ï¼š</p><pre tabindex=0><code>mkdir -p /tmp/pss
cat &lt;&lt;EOF &gt; /tmp/pss/cluster-level-pss.yaml 
apiVersion: apiserver.config.k8s.io/v1
kind: AdmissionConfiguration
plugins:
- name: PodSecurity
  configuration:
    apiVersion: pod-security.admission.config.k8s.io/v1
    kind: PodSecurityConfiguration
    defaults:
      enforce: &#34;baseline&#34;
      enforce-version: &#34;latest&#34;
      audit: &#34;restricted&#34;
      audit-version: &#34;latest&#34;
      warn: &#34;restricted&#34;
      warn-version: &#34;latest&#34;
    exemptions:
      usernames: []
      runtimeClasses: []
      namespaces: [kube-system]
EOF
</code></pre><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p><code>pod-security.admission.config.k8s.io/v1</code> é…ç½®éœ€è¦ v1.25+ã€‚
å¯¹äº v1.23 å’Œ v1.24ï¼Œä½¿ç”¨ <a href=https://v1-24.docs.kubernetes.io/zh-cn/docs/tasks/configure-pod-container/enforce-standards-admission-controller/>v1beta1</a>ã€‚
å¯¹äº v1.22ï¼Œä½¿ç”¨ <a href=https://v1-22.docs.kubernetes.io/docs/tasks/configure-pod-container/enforce-standards-admission-controller/>v1alpha1</a>ã€‚</div></li></ol><ol start=4><li><p>åœ¨åˆ›å»ºé›†ç¾¤æ—¶é…ç½® API æœåŠ¡å™¨ä½¿ç”¨æ­¤æ–‡ä»¶ï¼š</p><pre tabindex=0><code>cat &lt;&lt;EOF &gt; /tmp/pss/cluster-config.yaml 
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
        extraArgs:
          admission-control-config-file: /etc/config/cluster-level-pss.yaml
        extraVolumes:
          - name: accf
            hostPath: /etc/config
            mountPath: /etc/config
            readOnly: false
            pathType: &#34;DirectoryOrCreate&#34;
  extraMounts:
  - hostPath: /tmp/pss
    containerPath: /etc/config
    # optional: if set, the mount is read-only.
    # default false
    readOnly: false
    # optional: if set, the mount needs SELinux relabeling.
    # default false
    selinuxRelabel: false
    # optional: set propagation mode (None, HostToContainer or Bidirectional)
    # see https://kubernetes.io/docs/concepts/storage/volumes/#mount-propagation
    # default None
    propagation: None
EOF
</code></pre><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p>å¦‚æœä½ åœ¨ macOS ä¸Šä½¿ç”¨ Docker Desktop å’Œ KinDï¼Œ
ä½ å¯ä»¥åœ¨èœå•é¡¹ <strong>Preferences > Resources > File Sharing</strong>
ä¸‹æ·»åŠ  <code>/tmp</code> ä½œä¸ºå…±äº«ç›®å½•ã€‚</div></li></ol><ol start=5><li><p>åˆ›å»ºä¸€ä¸ªä½¿ç”¨ Pod å®‰å…¨å‡†å…¥çš„é›†ç¾¤æ¥åº”ç”¨è¿™äº› Pod å®‰å…¨æ ‡å‡†ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kind create cluster --name psa-with-cluster-pss --image kindest/node:v1.24.0 --config /tmp/pss/cluster-config.yaml
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>Creating cluster &#34;psa-with-cluster-pss&#34; ...
 âœ“ Ensuring node image (kindest/node:v1.24.0) ğŸ–¼ 
 âœ“ Preparing nodes ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
Set kubectl context to &#34;kind-psa-with-cluster-pss&#34;
You can now use your cluster with:

kubectl cluster-info --context kind-psa-with-cluster-pss

Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community ğŸ™‚
</code></pre></li></ol><ol start=6><li><p>å°† kubectl æŒ‡å‘é›†ç¾¤</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info --context kind-psa-with-cluster-pss
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>Kubernetes control plane is running at https://127.0.0.1:63855
CoreDNS is running at https://127.0.0.1:63855/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
</code></pre></li></ol><ol start=7><li><p>åˆ›å»ºä»¥ä¸‹ Pod è§„çº¦ä½œä¸ºåœ¨ default åå­—ç©ºé—´ä¸­çš„ä¸€ä¸ªæœ€å°é…ç½®ï¼š</p><pre tabindex=0><code>cat &lt;&lt;EOF &gt; /tmp/pss/nginx-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
    - image: nginx
      name: nginx
      ports:
        - containerPort: 80
EOF
</code></pre></li></ol><ol start=8><li><p>åœ¨é›†ç¾¤ä¸­åˆ›å»º Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f /tmp/pss/nginx-pod.yaml
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>Warning: would violate PodSecurity &#34;restricted:latest&#34;: allowPrivilegeEscalation != false (container &#34;nginx&#34; must set securityContext allowPrivilegeEscalation=false), unrestricted capabilities (container &#34;nginx&#34; must set securityContext.capabilities.drop=[&#34;ALL&#34;]), runAsNonRoot != true (pod or container &#34;nginx&#34; must set securityContext.runAsNonRoot=true), seccompProfile (pod or container &#34;nginx&#34; must set securityContext seccompProfile.type to &#34;RuntimeDefault&#34; or &#34;Localhost&#34;)
pod/nginx created
</code></pre></li></ol><h2 id=clean-up>æ¸…ç†</h2><p>è¿è¡Œ <code>kind delete cluster --name psa-with-cluster-pss</code> å’Œ
<code>kind delete cluster --name psa-wo-cluster-pss</code> æ¥åˆ é™¤ä½ åˆ›å»ºçš„é›†ç¾¤ã€‚</p><h2 id=æ¥ä¸‹æ¥>æ¥ä¸‹æ¥</h2><ul><li>è¿è¡Œä¸€ä¸ª <a href=/zh-cn/examples/security/kind-with-cluster-level-baseline-pod-security.sh>shell è„šæœ¬</a>
ä¸€æ¬¡æ‰§è¡Œå‰é¢çš„æ‰€æœ‰æ­¥éª¤ï¼š<ol><li>åˆ›å»ºä¸€ä¸ªåŸºäº Pod å®‰å…¨æ ‡å‡†çš„é›†ç¾¤çº§åˆ«é…ç½®</li><li>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è®© API æœåŠ¡å™¨æ¶ˆè´¹è¿™ä¸ªé…ç½®</li><li>åˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œç”¨è¿™ä¸ªé…ç½®åˆ›å»ºä¸€ä¸ª API æœåŠ¡å™¨</li><li>è®¾ç½® kubectl ä¸Šä¸‹æ–‡ä¸ºè¿™ä¸ªæ–°é›†ç¾¤</li><li>åˆ›å»ºä¸€ä¸ªæœ€å°çš„ Pod yaml æ–‡ä»¶</li><li>åº”ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨æ–°é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª Pod</li></ol></li><li><a href=/zh-cn/docs/concepts/security/pod-security-admission/>Pod å®‰å…¨å‡†å…¥</a></li><li><a href=/zh-cn/docs/concepts/security/pod-security-standards/>Pod å®‰å…¨æ ‡å‡†</a></li><li><a href=/zh-cn/docs/tutorials/security/ns-level-pss/>åœ¨åå­—ç©ºé—´çº§åˆ«åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-31a6c137cfc5bfea9d88f4b109109465>3 - åœ¨åå­—ç©ºé—´çº§åˆ«åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</h1><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>æœ¬æ•™ç¨‹ä»…é€‚ç”¨äºæ–°é›†ç¾¤ã€‚</div><p>Pod å®‰å…¨å‡†å…¥ï¼ˆPSAï¼‰åœ¨ v1.23 åŠæ›´é«˜ç‰ˆæœ¬é»˜è®¤å¯ç”¨ï¼Œ
å› ä¸ºå®ƒ<a href=/blog/2021/12/09/pod-security-admission-beta/>å‡çº§åˆ°æµ‹è¯•ç‰ˆï¼ˆbetaï¼‰</a>ã€‚
Pod å®‰å…¨å‡†å…¥æ˜¯åœ¨åˆ›å»º Pod æ—¶åº”ç”¨
<a href=/zh-cn/docs/concepts/security/pod-security-standards/>Pod å®‰å…¨æ ‡å‡†</a>çš„å‡†å…¥æ§åˆ¶å™¨ã€‚
åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œä½ å°†åº”ç”¨ <code>baseline</code> Pod å®‰å…¨æ ‡å‡†ï¼Œæ¯æ¬¡ä¸€ä¸ªåå­—ç©ºé—´ã€‚</p><p>ä½ è¿˜å¯ä»¥åœ¨é›†ç¾¤çº§åˆ«ä¸€æ¬¡å°† Pod å®‰å…¨æ ‡å‡†åº”ç”¨äºå¤šä¸ªåç§°ç©ºé—´ã€‚
æœ‰å…³è¯´æ˜ï¼Œè¯·å‚é˜…<a href=/zh-cn/docs/tutorials/security/cluster-level-pss/>åœ¨é›†ç¾¤çº§åˆ«åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</a>ã€‚</p><h2 id=å‡†å¤‡å¼€å§‹>å‡†å¤‡å¼€å§‹</h2><p>åœ¨ä½ çš„å·¥ä½œç«™ä¸­å®‰è£…ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li><a href=https://kind.sigs.k8s.io/docs/user/quick-start/#installation>KinD</a></li><li><a href=/zh-cn/docs/tasks/tools/>kubectl</a></li></ul><h2 id=create-cluster>åˆ›å»ºé›†ç¾¤</h2><ol start=2><li><p>æŒ‰ç…§å¦‚ä¸‹æ–¹å¼åˆ›å»ºä¸€ä¸ª <code>KinD</code> é›†ç¾¤ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kind create cluster --name psa-ns-level --image kindest/node:v1.23.0
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>Creating cluster &#34;psa-ns-level&#34; ...
 âœ“ Ensuring node image (kindest/node:v1.23.0) ğŸ–¼ 
 âœ“ Preparing nodes ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
Set kubectl context to &#34;kind-psa-ns-level&#34;
You can now use your cluster with:

kubectl cluster-info --context kind-psa-ns-level

Not sure what to do next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</code></pre></li></ol><ol><li><p>å°† kubectl ä¸Šä¸‹æ–‡è®¾ç½®ä¸ºæ–°é›†ç¾¤ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl cluster-info --context kind-psa-ns-level
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>Kubernetes control plane is running at https://127.0.0.1:50996
CoreDNS is running at https://127.0.0.1:50996/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
</code></pre></li></ol><h2 id=create-a-namespace>åˆ›å»ºåå­—ç©ºé—´</h2><p>åˆ›å»ºä¸€ä¸ªåä¸º <code>example</code> çš„æ–°åå­—ç©ºé—´ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create ns example
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>namespace/example created
</code></pre><h2 id=apply-pod-security-standards>åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</h2><ol><li><p>ä½¿ç”¨å†…ç½® Pod å®‰å…¨å‡†å…¥æ‰€æ”¯æŒçš„æ ‡ç­¾åœ¨æ­¤åå­—ç©ºé—´ä¸Šå¯ç”¨ Pod å®‰å…¨æ ‡å‡†ã€‚
åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†æ ¹æ®æœ€æ–°ç‰ˆæœ¬ï¼ˆé»˜è®¤å€¼ï¼‰å¯¹åŸºçº¿ Pod å®‰å…¨æ ‡å‡†å‘å‡ºè­¦å‘Šã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl label --overwrite ns example <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  pod-security.kubernetes.io/warn<span style=color:#666>=</span>baseline <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>  pod-security.kubernetes.io/warn-version<span style=color:#666>=</span>latest
</span></span></code></pre></div></li></ol><ol start=2><li><p>å¯ä»¥ä½¿ç”¨æ ‡ç­¾åœ¨ä»»ä½•åå­—ç©ºé—´ä¸Šå¯ç”¨å¤šä¸ª Pod å®‰å…¨æ ‡å‡†ã€‚
ä»¥ä¸‹å‘½ä»¤å°†å¼ºåˆ¶ï¼ˆ<code>enforce</code>ï¼‰ æ‰§è¡ŒåŸºçº¿ï¼ˆ<code>baseline</code>ï¼‰Pod å®‰å…¨æ ‡å‡†ï¼Œ
ä½†æ ¹æ®æœ€æ–°ç‰ˆæœ¬ï¼ˆé»˜è®¤å€¼ï¼‰å¯¹å—é™ï¼ˆ<code>restricted</code>ï¼‰Pod å®‰å…¨æ ‡å‡†æ‰§è¡Œè­¦å‘Šï¼ˆ<code>warn</code>ï¼‰å’Œå®¡æ ¸ï¼ˆ<code>audit</code>ï¼‰ã€‚</p><pre tabindex=0><code>kubectl label --overwrite ns example \
  pod-security.kubernetes.io/enforce=baseline \
  pod-security.kubernetes.io/enforce-version=latest \
  pod-security.kubernetes.io/warn=restricted \
  pod-security.kubernetes.io/warn-version=latest \
  pod-security.kubernetes.io/audit=restricted \
  pod-security.kubernetes.io/audit-version=latest
</code></pre></li></ol><h2 id=verify-the-pod-security-standards>éªŒè¯ Pod å®‰å…¨æ ‡å‡†</h2><ol><li><p>åœ¨ <code>example</code> åå­—ç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªæœ€å°çš„ Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#b44>&lt;&lt;EOF &gt; /tmp/pss/nginx-pod.yaml
</span></span></span><span style=display:flex><span><span style=color:#b44>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#b44>kind: Pod
</span></span></span><span style=display:flex><span><span style=color:#b44>metadata:
</span></span></span><span style=display:flex><span><span style=color:#b44>  name: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>spec:
</span></span></span><span style=display:flex><span><span style=color:#b44>  containers:
</span></span></span><span style=display:flex><span><span style=color:#b44>    - image: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>      name: nginx
</span></span></span><span style=display:flex><span><span style=color:#b44>      ports:
</span></span></span><span style=display:flex><span><span style=color:#b44>        - containerPort: 80
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></div></li></ol><ol><li><p>å°† Pod è§„çº¦åº”ç”¨åˆ°é›†ç¾¤ä¸­çš„ <code>example</code> åå­—ç©ºé—´ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -n example -f /tmp/pss/nginx-pod.yaml
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>Warning: would violate PodSecurity &#34;restricted:latest&#34;: allowPrivilegeEscalation != false (container &#34;nginx&#34; must set securityContext allowPrivilegeEscalation=false), unrestricted capabilities (container &#34;nginx&#34; must set securityContext.capabilities.drop=[&#34;ALL&#34;]), runAsNonRoot != true (pod or container &#34;nginx&#34; must set securityContext.runAsNonRoot=true), seccompProfile (pod or container &#34;nginx&#34; must set securityContext seccompProfile.type to &#34;RuntimeDefault&#34; or &#34;Localhost&#34;)
pod/nginx created
</code></pre></li></ol><ol start=3><li><p>å°† Pod è§„çº¦åº”ç”¨åˆ°é›†ç¾¤ä¸­çš„ <code>default</code> åå­—ç©ºé—´ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -n default -f /tmp/pss/nginx-pod.yaml
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>pod/nginx created
</code></pre></li></ol><p>ä»¥ä¸Š Pod å®‰å…¨æ ‡å‡†ä»…è¢«åº”ç”¨åˆ° <code>example</code> åå­—ç©ºé—´ã€‚
ä½ å¯ä»¥åœ¨æ²¡æœ‰è­¦å‘Šçš„æƒ…å†µä¸‹åœ¨ <code>default</code> åå­—ç©ºé—´ä¸­åˆ›å»ºç›¸åŒçš„ Podã€‚</p><h2 id=clean-up>æ¸…ç†</h2><p>è¿è¡Œ <code>kind delete cluster --name psa-ns-level</code> åˆ é™¤åˆ›å»ºçš„é›†ç¾¤ã€‚</p><h2 id=æ¥ä¸‹æ¥>æ¥ä¸‹æ¥</h2><ul><li><p>è¿è¡Œä¸€ä¸ª <a href=/examples/security/kind-with-namespace-level-baseline-pod-security.sh>shell è„šæœ¬</a>
ä¸€æ¬¡æ‰§è¡Œæ‰€æœ‰å‰é¢çš„æ­¥éª¤ã€‚</p><ol><li>åˆ›å»º KinD é›†ç¾¤</li><li>åˆ›å»ºæ–°çš„åå­—ç©ºé—´</li><li>åœ¨ <code>enforce</code> æ¨¡å¼ä¸‹åº”ç”¨ <code>baseline</code> Pod å®‰å…¨æ ‡å‡†ï¼Œ
åŒæ—¶åœ¨ <code>warn</code> å’Œ <code>audit</code> æ¨¡å¼ä¸‹åº”ç”¨ <code>restricted</code> Pod å®‰å…¨æ ‡å‡†ã€‚</li><li>åˆ›å»ºä¸€ä¸ªåº”ç”¨ä»¥ä¸‹ Pod å®‰å…¨æ ‡å‡†çš„æ–° Pod</li></ol></li><li><p><a href=/zh-cn/docs/concepts/security/pod-security-admission/>Pod å®‰å…¨å‡†å…¥</a></p></li><li><p><a href=/zh-cn/docs/concepts/security/pod-security-standards/>Pod å®‰å…¨æ ‡å‡†</a></p></li><li><p><a href=/zh-cn/docs/tutorials/security/cluster-level-pss/>åœ¨é›†ç¾¤çº§åˆ«åº”ç”¨ Pod å®‰å…¨æ ‡å‡†</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8b105172a11322c70d0223bc9dff1904>4 - ä½¿ç”¨ seccomp é™åˆ¶å®¹å™¨çš„ç³»ç»Ÿè°ƒç”¨</h1><div style=margin-top:10px;margin-bottom:10px><b>ç‰¹æ€§çŠ¶æ€ï¼š</b> <code>Kubernetes v1.19 [stable]</code></div><p>Seccomp ä»£è¡¨å®‰å…¨è®¡ç®—ï¼ˆSecure Computingï¼‰æ¨¡å¼ï¼Œè‡ª 2.6.12 ç‰ˆæœ¬ä»¥æ¥ï¼Œä¸€ç›´æ˜¯ Linux å†…æ ¸çš„ä¸€ä¸ªç‰¹æ€§ã€‚
å®ƒå¯ä»¥ç”¨æ¥æ²™ç®±åŒ–è¿›ç¨‹çš„æƒé™ï¼Œé™åˆ¶è¿›ç¨‹ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„è°ƒç”¨ã€‚
Kubernetes èƒ½ä½¿ä½ è‡ªåŠ¨å°†åŠ è½½åˆ° <a class=glossary-tooltip title='Kubernetes ä¸­çš„å·¥ä½œæœºå™¨ç§°ä½œèŠ‚ç‚¹ã€‚' data-toggle=tooltip data-placement=top href=/zh-cn/docs/concepts/architecture/nodes/ target=_blank aria-label=èŠ‚ç‚¹>èŠ‚ç‚¹</a>ä¸Šçš„
seccomp é…ç½®æ–‡ä»¶åº”ç”¨åˆ°ä½ çš„ Pod å’Œå®¹å™¨ã€‚</p><p>è¯†åˆ«ä½ çš„å·¥ä½œè´Ÿè½½æ‰€éœ€è¦çš„æƒé™æ˜¯å¾ˆå›°éš¾çš„ã€‚åœ¨æœ¬ç¯‡æ•™ç¨‹ä¸­ï¼Œ
ä½ å°†äº†è§£å¦‚ä½•å°† seccomp é…ç½®æ–‡ä»¶åŠ è½½åˆ°æœ¬åœ°çš„ Kubernetes é›†ç¾¤ä¸­ï¼Œ
å¦‚ä½•å°†å®ƒä»¬åº”ç”¨åˆ° Podï¼Œä»¥åŠå¦‚ä½•å¼€å§‹åˆ¶ä½œåªä¸ºå®¹å™¨è¿›ç¨‹æä¾›å¿…è¦çš„æƒé™çš„é…ç½®æ–‡ä»¶ã€‚</p><h2 id=æ•™ç¨‹ç›®æ ‡>æ•™ç¨‹ç›®æ ‡</h2><ul><li>äº†è§£å¦‚ä½•åœ¨èŠ‚ç‚¹ä¸ŠåŠ è½½ seccomp é…ç½®æ–‡ä»¶</li><li>äº†è§£å¦‚ä½•å°† seccomp é…ç½®æ–‡ä»¶åº”ç”¨åˆ°å®¹å™¨ä¸Š</li><li>è§‚å¯Ÿå®¹å™¨è¿›ç¨‹å¯¹ç³»ç»Ÿè°ƒç”¨çš„å®¡è®¡</li><li>è§‚å¯ŸæŒ‡å®šçš„é…ç½®æ–‡ä»¶ç¼ºå¤±æ—¶çš„è¡Œä¸º</li><li>è§‚å¯Ÿè¿å seccomp é…ç½®æ–‡ä»¶çš„è¡Œä¸º</li><li>äº†è§£å¦‚ä½•åˆ›å»ºç»†ç²’åº¦çš„ seccomp é…ç½®æ–‡ä»¶</li><li>äº†è§£å¦‚ä½•åº”ç”¨å®¹å™¨è¿è¡Œæ—¶æ‰€é»˜è®¤çš„ seccomp é…ç½®æ–‡ä»¶</li></ul><h2 id=å‡†å¤‡å¼€å§‹>å‡†å¤‡å¼€å§‹</h2><p>ä¸ºäº†å®Œæˆæœ¬ç¯‡æ•™ç¨‹ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼Œä½ å¿…é¡»å®‰è£… <a href=/zh-cn/docs/tasks/tools/#kind>kind</a>
å’Œ <a href=/zh-cn/docs/tasks/tools/#kubectl>kubectl</a>ã€‚</p><p>æœ¬ç¯‡æ•™ç¨‹æ¼”ç¤ºçš„æŸäº›ç¤ºä¾‹ä»ç„¶æ˜¯ Beta çŠ¶æ€ï¼ˆè‡ª v1.25 èµ·ï¼‰ï¼Œå¦ä¸€äº›ç¤ºä¾‹åˆ™ä»…ä½¿ç”¨ seccomp æ­£å¼å‘å¸ƒçš„åŠŸèƒ½ã€‚
ä½ åº”è¯¥ç¡®ä¿ï¼Œé’ˆå¯¹ä½ ä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œ
<a href=https://kind.sigs.k8s.io/docs/user/quick-start/#setting-kubernetes-version>æ­£ç¡®é…ç½®</a>äº†é›†ç¾¤ã€‚</p><p>æœ¬ç¯‡æ•™ç¨‹ä¹Ÿä½¿ç”¨äº† <code>curl</code> å·¥å…·æ¥ä¸‹è½½ç¤ºä¾‹åˆ°ä½ çš„è®¡ç®—æœºä¸Šã€‚
ä½ å¯ä»¥ä½¿ç”¨å…¶ä»–è‡ªå·±åå¥½çš„å·¥å…·æ¥è‡ªé€‚åº”è¿™äº›æ­¥éª¤ã€‚</p><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p>æ— æ³•å°† seccomp é…ç½®æ–‡ä»¶åº”ç”¨äºåœ¨å®¹å™¨çš„ <code>securityContext</code> ä¸­è®¾ç½®äº† <code>privileged: true</code> çš„å®¹å™¨ã€‚
ç‰¹æƒå®¹å™¨å§‹ç»ˆä»¥ <code>Unconfined</code> çš„æ–¹å¼è¿è¡Œã€‚</div><h2 id=download-profiles>ä¸‹è½½ç¤ºä¾‹ seccomp é…ç½®æ–‡ä»¶</h2><p>è¿™äº›é…ç½®æ–‡ä»¶çš„å†…å®¹å°†åœ¨ç¨åè¿›è¡Œåˆ†æï¼Œ
ç°åœ¨å…ˆå°†å®ƒä»¬ä¸‹è½½åˆ°åä¸º <code>profiles/</code> çš„ç›®å½•ä¸­ï¼Œä»¥ä¾¿å°†å®ƒä»¬åŠ è½½åˆ°é›†ç¾¤ä¸­ã€‚</p><ul class="nav nav-tabs" id=tab-with-code role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tab-with-code-0 role=tab aria-controls=tab-with-code-0 aria-selected=true>audit.json</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-with-code-1 role=tab aria-controls=tab-with-code-1>violation.json</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-with-code-2 role=tab aria-controls=tab-with-code-2>fine-grained.json</a></li></ul><div class=tab-content id=tab-with-code><div id=tab-with-code-0 class="tab-pane show active" role=tabpanel aria-labelledby=tab-with-code-0><p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/seccomp/profiles/audit.json download=pods/security/seccomp/profiles/audit.json><code>pods/security/seccomp/profiles/audit.json</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-seccomp-profiles-audit-json")' title="Copy pods/security/seccomp/profiles/audit.json to clipboard"></img></div><div class=includecode id=pods-security-seccomp-profiles-audit-json><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;defaultAction&#34;</span>: <span style=color:#b44>&#34;SCMP_ACT_LOG&#34;</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div><div id=tab-with-code-1 class=tab-pane role=tabpanel aria-labelledby=tab-with-code-1><p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/seccomp/profiles/violation.json download=pods/security/seccomp/profiles/violation.json><code>pods/security/seccomp/profiles/violation.json</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-seccomp-profiles-violation-json")' title="Copy pods/security/seccomp/profiles/violation.json to clipboard"></img></div><div class=includecode id=pods-security-seccomp-profiles-violation-json><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;defaultAction&#34;</span>: <span style=color:#b44>&#34;SCMP_ACT_ERRNO&#34;</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div><div id=tab-with-code-2 class=tab-pane role=tabpanel aria-labelledby=tab-with-code-2><p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/seccomp/profiles/fine-grained.json download=pods/security/seccomp/profiles/fine-grained.json><code>pods/security/seccomp/profiles/fine-grained.json</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-seccomp-profiles-fine-grained-json")' title="Copy pods/security/seccomp/profiles/fine-grained.json to clipboard"></img></div><div class=includecode id=pods-security-seccomp-profiles-fine-grained-json><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;defaultAction&#34;</span>: <span style=color:#b44>&#34;SCMP_ACT_ERRNO&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;architectures&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;SCMP_ARCH_X86_64&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;SCMP_ARCH_X86&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;SCMP_ARCH_X32&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;syscalls&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;names&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;accept4&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;epoll_wait&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;pselect6&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;futex&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;madvise&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;epoll_ctl&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;getsockname&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;setsockopt&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;vfork&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;mmap&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;read&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;write&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;close&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;arch_prctl&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;sched_getaffinity&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;munmap&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;brk&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;rt_sigaction&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;rt_sigprocmask&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;sigaltstack&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;gettid&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;clone&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;bind&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;socket&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;openat&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;readlinkat&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;exit_group&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;epoll_create1&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;listen&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;rt_sigreturn&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;sched_yield&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;clock_gettime&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;connect&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;dup2&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;epoll_pwait&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;execve&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;exit&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;fcntl&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;getpid&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;getuid&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;ioctl&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;mprotect&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;nanosleep&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;open&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;poll&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;recvfrom&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;sendto&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;set_tid_address&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;setitimer&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#b44>&#34;writev&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;action&#34;</span>: <span style=color:#b44>&#34;SCMP_ACT_ALLOW&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p>æ‰§è¡Œè¿™äº›å‘½ä»¤ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir ./profiles
</span></span><span style=display:flex><span>curl -L -o profiles/audit.json https://k8s.io/examples/pods/security/seccomp/profiles/audit.json
</span></span><span style=display:flex><span>curl -L -o profiles/violation.json https://k8s.io/examples/pods/security/seccomp/profiles/violation.json
</span></span><span style=display:flex><span>curl -L -o profiles/fine-grained.json https://k8s.io/examples/pods/security/seccomp/profiles/fine-grained.json
</span></span><span style=display:flex><span>ls profiles
</span></span></code></pre></div><p>ä½ åº”è¯¥çœ‹åˆ°åœ¨æœ€åä¸€æ­¥çš„æœ«å°¾åˆ—å‡ºæœ‰ä¸‰ä¸ªé…ç½®æ–‡ä»¶ï¼š</p><pre tabindex=0><code>audit.json  fine-grained.json  violation.json
</code></pre><h2 id=create-a-local-kubernetes-cluster-with-kind>ä½¿ç”¨ kind åˆ›å»ºæœ¬åœ° Kubernetes é›†ç¾¤</h2><p>ä¸ºç®€å•èµ·è§ï¼Œ<a href=https://kind.sigs.k8s.io/>kind</a> å¯ç”¨æ¥åˆ›å»ºåŠ è½½äº† seccomp é…ç½®æ–‡ä»¶çš„å•èŠ‚ç‚¹é›†ç¾¤ã€‚
Kind åœ¨ Docker ä¸­è¿è¡Œ Kubernetesï¼Œå› æ­¤é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªå®¹å™¨ã€‚
è¿™å…è®¸å°†æ–‡ä»¶æŒ‚è½½åˆ°æ¯ä¸ªå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç±»ä¼¼äºå°†æ–‡ä»¶åŠ è½½åˆ°èŠ‚ç‚¹ä¸Šã€‚</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/seccomp/kind.yaml download=pods/security/seccomp/kind.yaml><code>pods/security/seccomp/kind.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-seccomp-kind-yaml")' title="Copy pods/security/seccomp/kind.yaml to clipboard"></img></div><div class=includecode id=pods-security-seccomp-kind-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kind.x-k8s.io/v1alpha4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>nodes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>role</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraMounts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;./profiles&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>containerPath</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/var/lib/kubelet/seccomp/profiles&#34;</span></span></span></code></pre></div></div></div><p>ä¸‹è½½è¯¥ç¤ºä¾‹ kind é…ç½®ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°åä¸º <code>kind.yaml</code> çš„æ–‡ä»¶ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -L -O https://k8s.io/examples/pods/security/seccomp/kind.yaml
</span></span></code></pre></div><p>ä½ å¯ä»¥é€šè¿‡è®¾ç½®èŠ‚ç‚¹çš„å®¹å™¨é•œåƒæ¥è®¾ç½®ç‰¹å®šçš„ Kubernetes ç‰ˆæœ¬ã€‚
æœ‰å…³æ­¤ç±»é…ç½®çš„æ›´å¤šä¿¡æ¯ï¼Œ
å‚é˜… kind æ–‡æ¡£ä¸­<a href=https://kind.sigs.k8s.io/docs/user/configuration/#nodes>èŠ‚ç‚¹</a>å°èŠ‚ã€‚
æœ¬ç¯‡æ•™ç¨‹å‡å®šä½ æ­£åœ¨ä½¿ç”¨ Kubernetes v1.25ã€‚</p><p>ä½œä¸º Beta ç‰¹æ€§ï¼Œä½ å¯ä»¥å°† Kubernetes
é…ç½®ä¸ºä½¿ç”¨<a class=glossary-tooltip title=å®¹å™¨è¿è¡Œæ—¶æ˜¯è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶ã€‚ data-toggle=tooltip data-placement=top href=/zh-cn/docs/setup/production-environment/container-runtimes target=_blank aria-label=å®¹å™¨è¿è¡Œæ—¶>å®¹å™¨è¿è¡Œæ—¶</a>é»˜è®¤é¦–é€‰çš„é…ç½®æ–‡ä»¶ï¼Œ
è€Œä¸æ˜¯å›é€€åˆ° <code>Unconfined</code>ã€‚
å¦‚æœä½ æƒ³å°è¯•ï¼Œè¯·åœ¨ç»§ç»­ä¹‹å‰å‚é˜…
<a href=#enable-runtimedefault-as-default>å¯ç”¨ä½¿ç”¨ <code>RuntimeDefault</code> ä½œä¸ºæ‰€æœ‰å·¥ä½œè´Ÿè½½çš„é»˜è®¤ seccomp é…ç½®æ–‡ä»¶</a>ã€‚</p><p>æœ‰äº† kind é…ç½®åï¼Œä½¿ç”¨è¯¥é…ç½®åˆ›å»º kind é›†ç¾¤ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kind create cluster --config<span style=color:#666>=</span>kind.yaml
</span></span></code></pre></div><p>æ–°çš„ Kubernetes é›†ç¾¤å‡†å¤‡å°±ç»ªåï¼Œæ‰¾å‡ºä½œä¸ºå•èŠ‚ç‚¹é›†ç¾¤è¿è¡Œçš„ Docker å®¹å™¨ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker ps
</span></span></code></pre></div><p>ä½ åº”è¯¥çœ‹åˆ°è¾“å‡ºä¸­åä¸º <code>kind-control-plane</code> çš„å®¹å™¨æ­£åœ¨è¿è¡Œã€‚
è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS              PORTS                       NAMES
6a96207fed4b        kindest/node:v1.18.2   &#34;/usr/local/bin/entrâ€¦&#34;   27 seconds ago      Up 24 seconds       127.0.0.1:42223-&gt;6443/tcp   kind-control-plane
</code></pre><p>å¦‚æœè§‚å¯Ÿè¯¥å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿï¼Œ
ä½ åº”è¯¥ä¼šçœ‹åˆ° <code>profiles/</code> ç›®å½•å·²æˆåŠŸåŠ è½½åˆ° kubelet çš„é»˜è®¤ seccomp è·¯å¾„ä¸­ã€‚
ä½¿ç”¨ <code>docker exec</code> åœ¨ Pod ä¸­è¿è¡Œå‘½ä»¤ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># å°† 6a96207fed4b æ›´æ”¹ä¸ºä½ ä» â€œdocker psâ€ çœ‹åˆ°çš„å®¹å™¨ ID</span>
</span></span><span style=display:flex><span>docker <span style=color:#a2f>exec</span> -it 6a96207fed4b ls /var/lib/kubelet/seccomp/profiles
</span></span></code></pre></div><pre tabindex=0><code>audit.json  fine-grained.json  violation.json
</code></pre><p>ä½ å·²éªŒè¯è¿™äº› seccomp é…ç½®æ–‡ä»¶å¯ç”¨äºåœ¨ kind ä¸­è¿è¡Œçš„ kubeletã€‚</p><h2 id=enable-runtimedefault-as-default>å¯ç”¨ä½¿ç”¨ <code>RuntimeDefault</code> ä½œä¸ºæ‰€æœ‰å·¥ä½œè´Ÿè½½çš„é»˜è®¤ seccomp é…ç½®æ–‡ä»¶</h2><div style=margin-top:10px;margin-bottom:10px><b>ç‰¹æ€§çŠ¶æ€ï¼š</b> <code>Kubernetes v1.25 [beta]</code></div><p>è¦ä½¿ç”¨ Seccompï¼ˆå®‰å…¨è®¡ç®—æ¨¡å¼ï¼‰é…ç½®æ–‡ä»¶æ¥è®¾å®šé»˜è®¤å€¼ï¼Œä½ å¿…é¡»è¦åœ¨å¯ç”¨ <code>SeccompDefault</code>
<a href=/zh-cn/docs/reference/command-line-tools-reference/feature-gates/>ç‰¹æ€§é—¨æ§</a>çš„æƒ…å†µä¸‹è¿è¡Œ kubelet
ï¼ˆè¿™æ˜¯é»˜è®¤å€¼ï¼‰ã€‚
ä½ è¿˜å¿…é¡»æ˜¾å¼åœ°å¯ç”¨æ¯ä¸ªèŠ‚ç‚¹çš„é»˜è®¤è¡Œä¸ºï¼Œä»¥åŠç›¸åº”çš„
<code>--seccomp-default</code> <a href=/zh-cn/docs/reference/command-line-tools-reference/kubelet>å‘½ä»¤è¡Œæ ‡å¿—</a>ã€‚ä¸¤è€…å¿…é¡»åŒæ—¶å¯ç”¨æ‰èƒ½ä½¿ç”¨è¯¥ç‰¹æ€§ã€‚</p><p>å¦‚æœå¯ç”¨ï¼Œkubelet å°†ä¼šé»˜è®¤ä½¿ç”¨ <code>RuntimeDefault</code> seccomp é…ç½®æ–‡ä»¶ï¼Œ
ï¼ˆè¿™ä¸€é…ç½®æ–‡æ˜æ˜¯ç”±å®¹å™¨è¿è¡Œæ—¶å®šä¹‰çš„ï¼‰ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ <code>Unconfined</code>ï¼ˆç¦ç”¨ seccompï¼‰æ¨¡å¼ã€‚
é»˜è®¤çš„é…ç½®æ–‡ä»¶æ—¨åœ¨æä¾›ä¸€ç»„é™åˆ¶æ€§è¾ƒå¼ºä¸”èƒ½ä¿ç•™å·¥ä½œè´Ÿè½½åŠŸèƒ½çš„å®‰å…¨é»˜è®¤å€¼ã€‚
ä¸åŒå®¹å™¨è¿è¡Œæ—¶åŠå…¶ä¸åŒå‘å¸ƒç‰ˆæœ¬ä¹‹é—´çš„é»˜è®¤é…ç½®æ–‡ä»¶å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œ
ä¾‹å¦‚åœ¨æ¯”è¾ƒæ¥è‡ª CRI-O å’Œ containerd çš„é…ç½®æ–‡ä»¶æ—¶ã€‚</p><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p>å¯ç”¨è¯¥åŠŸèƒ½æ—¢ä¸ä¼šæ›´æ”¹ Kubernetes <code>securityContext.seccompProfile</code> API å­—æ®µï¼Œ
ä¹Ÿä¸ä¼šæ·»åŠ å·²å¼ƒç”¨çš„å·¥ä½œè´Ÿè½½æ³¨è§£ã€‚
è¿™ä¸ºç”¨æˆ·æä¾›äº†éšæ—¶å›æ»šçš„å¯èƒ½æ€§ï¼Œè€Œä¸”æ— éœ€å®é™…æ›´æ”¹å·¥ä½œè´Ÿè½½é…ç½®ã€‚
<a href=https://github.com/kubernetes-sigs/cri-tools><code>crictl inspect</code></a>
ä¹‹ç±»çš„å·¥å…·å¯ç”¨äºéªŒè¯å®¹å™¨æ­£åœ¨ä½¿ç”¨å“ªä¸ª seccomp é…ç½®æ–‡ä»¶ã€‚</div><p>ä¸å…¶ä»–å·¥ä½œè´Ÿè½½ç›¸æ¯”ï¼ŒæŸäº›å·¥ä½œè´Ÿè½½å¯èƒ½éœ€è¦æ›´å°‘çš„ç³»ç»Ÿè°ƒç”¨é™åˆ¶ã€‚
è¿™æ„å‘³ç€å³ä½¿ä½¿ç”¨ <code>RuntimeDefault</code> é…ç½®æ–‡ä»¶ï¼Œå®ƒä»¬ä¹Ÿå¯èƒ½åœ¨è¿è¡Œæ—¶å¤±è´¥ã€‚
è¦åº”å¯¹æ­¤ç±»æ•…éšœï¼Œä½ å¯ä»¥ï¼š</p><ul><li>å°†å·¥ä½œè´Ÿè½½æ˜¾å¼è¿è¡Œä¸º <code>Unconfined</code>ã€‚</li><li>ç¦ç”¨èŠ‚ç‚¹çš„ <code>SeccompDefault</code> ç‰¹æ€§ã€‚è¿˜è¦ç¡®ä¿å·¥ä½œè´Ÿè½½è¢«è°ƒåº¦åˆ°ç¦ç”¨è¯¥ç‰¹æ€§çš„èŠ‚ç‚¹ä¸Šã€‚</li><li>ä¸ºå·¥ä½œè´Ÿè½½åˆ›å»ºè‡ªå®šä¹‰ seccomp é…ç½®æ–‡ä»¶ã€‚</li></ul><p>å¦‚æœä½ å°†æ­¤ç‰¹æ€§å¼•å…¥åˆ°ç±»ä¼¼çš„ç”Ÿäº§é›†ç¾¤ä¸­ï¼Œ
Kubernetes é¡¹ç›®å»ºè®®ä½ åœ¨éƒ¨åˆ†èŠ‚ç‚¹ä¸Šå¯ç”¨æ­¤ç‰¹æ€§é—¨æ§ï¼Œ
ç„¶ååœ¨æ•´ä¸ªé›†ç¾¤èŒƒå›´å†…æ¨å‡ºæ›´æ”¹ä¹‹å‰ï¼Œæµ‹è¯•å·¥ä½œè´Ÿè½½æ‰§è¡Œæƒ…å†µã€‚</p><p>ä½ å¯ä»¥åœ¨ç›¸å…³çš„ Kubernetes å¢å¼ºææ¡ˆï¼ˆKEPï¼‰
ä¸­æ‰¾åˆ°å¯èƒ½çš„å‡çº§å’Œé™çº§ç­–ç•¥çš„æ›´è¯¦ç»†ä¿¡æ¯:
<a href=https://github.com/kubernetes/enhancements/tree/9a124fd29d1f9ddf2ff455c49a630e3181992c25/keps/sig-node/2413-seccomp-by-default#upgrade--downgrade-strategy>é»˜è®¤å¯ç”¨ Seccomp</a>ã€‚</p><p>Kubernetes 1.25 å…è®¸ä½ é…ç½® Seccomp é…ç½®æ–‡ä»¶ï¼Œ
å½“ Pod çš„è§„çº¦æœªå®šä¹‰ç‰¹å®šçš„ Seccomp é…ç½®æ–‡ä»¶æ—¶åº”ç”¨è¯¥é…ç½®æ–‡ä»¶ã€‚
è¿™æ˜¯ä¸€ä¸ª Beta ç‰¹æ€§ï¼Œé»˜è®¤å¯ç”¨ç›¸åº”çš„ <code>SeccompDefault</code> <a href=/zh-cn/docs/reference/command-line-tools-reference/feature-gates/>ç‰¹æ€§é—¨æ§</a>ã€‚
ä½†æ˜¯ï¼Œä½ ä»ç„¶éœ€è¦ä¸ºè¦ä½¿ç”¨å®ƒçš„æ¯ä¸ªèŠ‚ç‚¹å¯ç”¨æ­¤é»˜è®¤è®¾ç½®ã€‚</p><p>å¦‚æœä½ æ­£åœ¨è¿è¡Œ Kubernetes 1.25
é›†ç¾¤å¹¶å¸Œæœ›å¯ç”¨è¯¥ç‰¹æ€§ï¼Œè¯·ä½¿ç”¨ <code>--seccomp-default</code> å‘½ä»¤è¡Œå‚æ•°è¿è¡Œ kubeletï¼Œ
æˆ–é€šè¿‡ <a href=/zh-cn/docs/tasks/administer-cluster/kubelet-config-file/>kubelet é…ç½®æ–‡ä»¶</a>å¯ç”¨ã€‚</p><p>è¦åœ¨ <a href=https://kind.sigs.k8s.io>kind</a> å¯ç”¨ç‰¹æ€§é—¨æ§ï¼Œ
è¯·ç¡®ä¿ <code>kind</code> æä¾›æ‰€éœ€çš„æœ€ä½ Kubernetes ç‰ˆæœ¬ï¼Œ
å¹¶<a href=https://kind.sigs.k8s.io/docs/user/quick-start/#enable-feature-gates-in-your-cluster>åœ¨ kind é…ç½®ä¸­</a>
å¯ç”¨äº† <code>SeccompDefault</code> ç‰¹æ€§ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kind.x-k8s.io/v1alpha4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>featureGates</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>SeccompDefault</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>nodes</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>role</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>kindest/node:v1.23.0@sha256:49824ab1727c04e56a21a5d8372a402fcd32ea51ac96a2706a12af38934f81ac<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubeadmConfigPatches</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        kind: JoinConfiguration
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        nodeRegistration:
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          kubeletExtraArgs:
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            seccomp-default: &#34;true&#34;</span><span style=color:#bbb>        
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>role</span>:<span style=color:#bbb> </span>worker<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>kindest/node:v1.23.0@sha256:49824ab1727c04e56a21a5d8372a402fcd32ea51ac96a2706a12af38934f81ac<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubeadmConfigPatches</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- |<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        kind: JoinConfiguration
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        nodeRegistration:
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>          kubeletExtraArgs:
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            feature-gates: SeccompDefault=true
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>            seccomp-default: &#34;true&#34;</span><span style=color:#bbb>        
</span></span></span></code></pre></div><p>å¦‚æœé›†ç¾¤å·²å°±ç»ªï¼Œåˆ™è¿è¡Œä¸€ä¸ª Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run --rm -it --restart<span style=color:#666>=</span>Never --image<span style=color:#666>=</span>alpine alpine -- sh
</span></span></code></pre></div><p>ç°åœ¨åº”è¯¥é™„åŠ äº†é»˜è®¤çš„ seccomp é…ç½®æ–‡ä»¶ã€‚
è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>docker exec</code> ä¸º kind ä¸Šçš„å®¹å™¨è¿è¡Œ <code>crictl inspect</code> æ¥éªŒè¯ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker <span style=color:#a2f>exec</span> -it kind-worker bash -c <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    <span style=color:#b44>&#39;crictl inspect $(crictl ps --name=alpine -q) | jq .info.runtimeSpec.linux.seccomp&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;defaultAction&#34;</span>: <span style=color:#b44>&#34;SCMP_ACT_ERRNO&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;architectures&#34;</span>: [<span style=color:#b44>&#34;SCMP_ARCH_X86_64&#34;</span>, <span style=color:#b44>&#34;SCMP_ARCH_X86&#34;</span>, <span style=color:#b44>&#34;SCMP_ARCH_X32&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;syscalls&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;names&#34;</span>: [<span style=color:#b44>&#34;...&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=create-a-pod-with-a-seccomp-profile-for-syscall-auditing>ä½¿ç”¨ seccomp é…ç½®æ–‡ä»¶åˆ›å»º Pod ä»¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨å®¡è®¡</h2><p>é¦–å…ˆï¼Œå°† <code>audit.json</code> é…ç½®æ–‡ä»¶åº”ç”¨åˆ°æ–°çš„ Pod ä¸Šï¼Œè¯¥é…ç½®æ–‡ä»¶å°†è®°å½•è¿›ç¨‹çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>è¿™æ˜¯è¯¥ Pod çš„æ¸…å•ï¼š</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/seccomp/ga/audit-pod.yaml download=pods/security/seccomp/ga/audit-pod.yaml><code>pods/security/seccomp/ga/audit-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-seccomp-ga-audit-pod-yaml")' title="Copy pods/security/seccomp/ga/audit-pod.yaml to clipboard"></img></div><div class=includecode id=pods-security-seccomp-ga-audit-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>audit-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>audit-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>seccompProfile</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Localhost<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>localhostProfile</span>:<span style=color:#bbb> </span>profiles/audit.json<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>hashicorp/http-echo:0.2.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;-text=just made some syscalls!&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>allowPrivilegeEscalation</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span></span></span></code></pre></div></div></div><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p>å·²å¼ƒç”¨çš„ seccomp æ³¨è§£ <code>seccomp.security.alpha.kubernetes.io/pod</code>ï¼ˆé’ˆå¯¹æ•´ä¸ª Podï¼‰å’Œ
<code>container.seccomp.security.alpha.kubernetes.io/[name]</code>ï¼ˆé’ˆå¯¹å•ä¸ªå®¹å™¨ï¼‰
å°†éšç€æœªæ¥ Kubernetes çš„å‘å¸ƒè€Œè¢«åˆ é™¤ã€‚
è¯·åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨åŸç”Ÿ API å­—æ®µè€Œä¸æ˜¯æ³¨è§£ã€‚</p><p>ä» Kubernetes v1.25 å¼€å§‹ï¼Œkubelet ä¸å†æ”¯æŒè¿™äº›æ³¨è§£ï¼Œ
ä¹Ÿä¸å†æ”¯æŒåœ¨é™æ€ Pod ä¸­ä½¿ç”¨æ³¨è§£ï¼Œå¹¶ä¸”å½“åˆ›å»ºå¸¦æœ‰ seccomp å­—æ®µçš„ Pod æ—¶ä¸å†è‡ªåŠ¨å¡«å…… seccomp æ³¨è§£ã€‚
ä»æ³¨é‡Šä¸­è‡ªåŠ¨å¡«å…… seccomp å­—æ®µçš„ç‰¹æ€§ï¼Œå°†è®¡åˆ’åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤ã€‚</p></div><p>åœ¨é›†ç¾¤ä¸­åˆ›å»º Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/security/seccomp/ga/audit-pod.yaml
</span></span></code></pre></div><p>æ­¤é…ç½®æ–‡ä»¶ä¸é™åˆ¶ä»»ä½•ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤ Pod åº”è¯¥æˆåŠŸå¯åŠ¨ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod/audit-pod
</span></span></code></pre></div><pre tabindex=0><code>NAME        READY   STATUS    RESTARTS   AGE
audit-pod   1/1     Running   0          30s
</code></pre><p>ä¸ºäº†èƒ½å¤Ÿä¸å®¹å™¨æš´éœ²çš„ç«¯ç‚¹äº¤äº’ï¼Œ
åˆ›å»ºä¸€ä¸ª NodePort ç±»å‹çš„ <a class=glossary-tooltip title='å°†è¿è¡Œåœ¨ä¸€ç»„ Pods ä¸Šçš„åº”ç”¨ç¨‹åºå…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æŠ½è±¡æ–¹æ³•ã€‚' data-toggle=tooltip data-placement=top href=/zh-cn/docs/concepts/services-networking/service/ target=_blank aria-label=Service>Service</a>ï¼Œ
å…è®¸ä» kind æ§åˆ¶å¹³é¢å®¹å™¨å†…éƒ¨è®¿é—®ç«¯ç‚¹ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl expose pod audit-pod --type NodePort --port <span style=color:#666>5678</span>
</span></span></code></pre></div><p>æ£€æŸ¥ Service åœ¨èŠ‚ç‚¹ä¸Šåˆ†é…çš„ç«¯å£ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service audit-pod
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>NAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
audit-pod   NodePort   10.111.36.142   &lt;none&gt;        5678:32373/TCP   72s
</code></pre><p>ç°åœ¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>curl</code> ä» kind æ§åˆ¶å¹³é¢å®¹å™¨å†…éƒ¨è®¿é—®è¯¥ç«¯ç‚¹ï¼Œä½äºè¯¥æœåŠ¡æ‰€å…¬å¼€çš„ç«¯å£ä¸Šã€‚
ä½¿ç”¨ <code>docker exec</code> åœ¨å±äºè¯¥æ§åˆ¶å¹³é¢å®¹å™¨çš„å®¹å™¨ä¸­è¿è¡Œ <code>curl</code> å‘½ä»¤ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># å°† 6a96207fed4b æ›´æ”¹ä¸ºä½ ä» â€œdocker psâ€ çœ‹åˆ°çš„æ§åˆ¶å¹³é¢å®¹å™¨ ID</span>
</span></span><span style=display:flex><span>docker <span style=color:#a2f>exec</span> -it 6a96207fed4b curl localhost:32373
</span></span></code></pre></div><pre tabindex=0><code>just made some syscalls!
</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°è¯¥è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œä½†å®ƒå®é™…ä¸Šè¿›è¡Œäº†å“ªäº›ç³»ç»Ÿè°ƒç”¨ï¼Ÿ
å› ä¸ºè¿™ä¸ª Pod åœ¨æœ¬åœ°é›†ç¾¤ä¸­è¿è¡Œï¼Œä½ åº”è¯¥èƒ½å¤Ÿåœ¨ <code>/var/log/syslog</code> ä¸­çœ‹åˆ°å®ƒä»¬ã€‚
æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯çª—å£å¹¶ <code>tail</code> æ¥è‡ª <code>http-echo</code> çš„è°ƒç”¨çš„è¾“å‡ºï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>tail -f /var/log/syslog | grep <span style=color:#b44>&#39;http-echo&#39;</span>
</span></span></code></pre></div><p>ä½ åº”è¯¥å·²ç»çœ‹åˆ°äº†ä¸€äº›ç”± <code>http-echo</code> è¿›è¡Œçš„ç³»ç»Ÿè°ƒç”¨çš„æ—¥å¿—ï¼Œ
å¦‚æœä½ åœ¨æ§åˆ¶å¹³é¢å®¹å™¨ä¸­ <code>curl</code> ç«¯ç‚¹ï¼Œä½ ä¼šçœ‹åˆ°æ›´å¤šçš„å†™å…¥ã€‚</p><p>ä¾‹å¦‚ï¼š</p><pre tabindex=0><code>Jul  6 15:37:40 my-machine kernel: [369128.669452] audit: type=1326 audit(1594067860.484:14536): auid=4294967295 uid=0 gid=0 ses=4294967295 pid=29064 comm=&#34;http-echo&#34; exe=&#34;/http-echo&#34; sig=0 arch=c000003e syscall=51 compat=0 ip=0x46fe1f code=0x7ffc0000
Jul  6 15:37:40 my-machine kernel: [369128.669453] audit: type=1326 audit(1594067860.484:14537): auid=4294967295 uid=0 gid=0 ses=4294967295 pid=29064 comm=&#34;http-echo&#34; exe=&#34;/http-echo&#34; sig=0 arch=c000003e syscall=54 compat=0 ip=0x46fdba code=0x7ffc0000
Jul  6 15:37:40 my-machine kernel: [369128.669455] audit: type=1326 audit(1594067860.484:14538): auid=4294967295 uid=0 gid=0 ses=4294967295 pid=29064 comm=&#34;http-echo&#34; exe=&#34;/http-echo&#34; sig=0 arch=c000003e syscall=202 compat=0 ip=0x455e53 code=0x7ffc0000
Jul  6 15:37:40 my-machine kernel: [369128.669456] audit: type=1326 audit(1594067860.484:14539): auid=4294967295 uid=0 gid=0 ses=4294967295 pid=29064 comm=&#34;http-echo&#34; exe=&#34;/http-echo&#34; sig=0 arch=c000003e syscall=288 compat=0 ip=0x46fdba code=0x7ffc0000
Jul  6 15:37:40 my-machine kernel: [369128.669517] audit: type=1326 audit(1594067860.484:14540): auid=4294967295 uid=0 gid=0 ses=4294967295 pid=29064 comm=&#34;http-echo&#34; exe=&#34;/http-echo&#34; sig=0 arch=c000003e syscall=0 compat=0 ip=0x46fd44 code=0x7ffc0000
Jul  6 15:37:40 my-machine kernel: [369128.669519] audit: type=1326 audit(1594067860.484:14541): auid=4294967295 uid=0 gid=0 ses=4294967295 pid=29064 comm=&#34;http-echo&#34; exe=&#34;/http-echo&#34; sig=0 arch=c000003e syscall=270 compat=0 ip=0x4559b1 code=0x7ffc0000
Jul  6 15:38:40 my-machine kernel: [369188.671648] audit: type=1326 audit(1594067920.488:14559): auid=4294967295 uid=0 gid=0 ses=4294967295 pid=29064 comm=&#34;http-echo&#34; exe=&#34;/http-echo&#34; sig=0 arch=c000003e syscall=270 compat=0 ip=0x4559b1 code=0x7ffc0000
Jul  6 15:38:40 my-machine kernel: [369188.671726] audit: type=1326 audit(1594067920.488:14560): auid=4294967295 uid=0 gid=0 ses=4294967295 pid=29064 comm=&#34;http-echo&#34; exe=&#34;/http-echo&#34; sig=0 arch=c000003e syscall=202 compat=0 ip=0x455e53 code=0x7ffc0000
</code></pre><p>é€šè¿‡æŸ¥çœ‹æ¯ä¸€è¡Œçš„ <code>syscall=</code> æ¡ç›®ï¼Œä½ å¯ä»¥å¼€å§‹äº†è§£ <code>http-echo</code> è¿›ç¨‹æ‰€éœ€çš„ç³»ç»Ÿè°ƒç”¨ã€‚
è™½ç„¶è¿™äº›ä¸å¤ªå¯èƒ½åŒ…å«å®ƒä½¿ç”¨çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ï¼Œä½†å®ƒå¯ä»¥ä½œä¸ºæ­¤å®¹å™¨çš„ seccomp é…ç½®æ–‡ä»¶çš„åŸºç¡€ã€‚</p><p>åœ¨è½¬åˆ°ä¸‹ä¸€éƒ¨åˆ†ä¹‹å‰æ¸…ç†è¯¥ Pod å’Œ Serviceï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete service audit-pod --wait
</span></span><span style=display:flex><span>kubectl delete pod audit-pod --wait --now
</span></span></code></pre></div><h2 id=create-pod-with-a-seccomp-profile-that-causes-violation>ä½¿ç”¨å¯¼è‡´è¿è§„çš„ seccomp é…ç½®æ–‡ä»¶åˆ›å»º Pod</h2><p>å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œå°†é…ç½®æ–‡ä»¶åº”ç”¨äºä¸å…è®¸ä»»ä½•ç³»ç»Ÿè°ƒç”¨çš„ Pod ä¸Šã€‚</p><p>æ­¤æ¼”ç¤ºçš„æ¸…å•æ˜¯ï¼š</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/seccomp/ga/violation-pod.yaml download=pods/security/seccomp/ga/violation-pod.yaml><code>pods/security/seccomp/ga/violation-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-seccomp-ga-violation-pod-yaml")' title="Copy pods/security/seccomp/ga/violation-pod.yaml to clipboard"></img></div><div class=includecode id=pods-security-seccomp-ga-violation-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>violation-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>violation-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>seccompProfile</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Localhost<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>localhostProfile</span>:<span style=color:#bbb> </span>profiles/violation.json<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>hashicorp/http-echo:0.2.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;-text=just made some syscalls!&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>allowPrivilegeEscalation</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span></span></span></code></pre></div></div></div><p>å°è¯•åœ¨é›†ç¾¤ä¸­åˆ›å»º Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/security/seccomp/ga/violation-pod.yaml
</span></span></code></pre></div><p>Pod åˆ›å»ºï¼Œä½†å­˜åœ¨é—®é¢˜ã€‚
å¦‚æœä½ æ£€æŸ¥ Pod çŠ¶æ€ï¼Œä½ åº”è¯¥çœ‹åˆ°å®ƒæ²¡æœ‰å¯åŠ¨ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod/violation-pod
</span></span></code></pre></div><pre tabindex=0><code>NAME            READY   STATUS             RESTARTS   AGE
violation-pod   0/1     CrashLoopBackOff   1          6s
</code></pre><p>å¦‚ä¸Šä¾‹æ‰€ç¤ºï¼Œ<code>http-echo</code> è¿›ç¨‹éœ€è¦ç›¸å½“å¤šçš„ç³»ç»Ÿè°ƒç”¨ã€‚
è¿™é‡Œ seccomp å·²é€šè¿‡è®¾ç½® <code>"defaultAction": "SCMP_ACT_ERRNO"</code> è¢«æŒ‡ç¤ºä¸ºåœ¨å‘ç”Ÿä»»ä½•ç³»ç»Ÿè°ƒç”¨æ—¶æŠ¥é”™ã€‚
è¿™æ˜¯éå¸¸å®‰å…¨çš„ï¼Œä½†æ¶ˆé™¤äº†åšä»»ä½•æœ‰æ„ä¹‰çš„äº‹æƒ…çš„èƒ½åŠ›ã€‚
ä½ çœŸæ­£æƒ³è¦çš„æ˜¯åªç»™å·¥ä½œè´Ÿè½½å®ƒä»¬æ‰€éœ€è¦çš„æƒé™ã€‚</p><p>åœ¨è½¬åˆ°ä¸‹ä¸€éƒ¨åˆ†ä¹‹å‰æ¸…ç†è¯¥ Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod violation-pod --wait --now
</span></span></code></pre></div><h2 id=create-pod-with-a-seccomp-profile-that-only-allows-necessary-syscalls>ä½¿ç”¨åªå…è®¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨çš„ seccomp é…ç½®æ–‡ä»¶åˆ›å»º Pod</h2><p>å¦‚æœä½ çœ‹ä¸€çœ‹ <code>fine-grained.json</code> é…ç½®æ–‡ä»¶ï¼Œ
ä½ ä¼šæ³¨æ„åˆ°ç¬¬ä¸€ä¸ªç¤ºä¾‹çš„ syslog ä¸­çœ‹åˆ°çš„ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œ
å…¶ä¸­é…ç½®æ–‡ä»¶è®¾ç½®ä¸º <code>"defaultAction": "SCMP_ACT_LOG"</code>ã€‚
ç°åœ¨çš„é…ç½®æ–‡ä»¶è®¾ç½® <code>"defaultAction": "SCMP_ACT_ERRNO"</code>,
ä½†åœ¨ <code>"action": "SCMP_ACT_ALLOW"</code> å—ä¸­æ˜ç¡®å…è®¸ä¸€ç»„ç³»ç»Ÿè°ƒç”¨ã€‚
ç†æƒ³æƒ…å†µä¸‹ï¼Œå®¹å™¨å°†æˆåŠŸè¿è¡Œï¼Œå¹¶ä¸”ä½ çœ‹åˆ°æ²¡æœ‰æ¶ˆæ¯å‘é€åˆ° <code>syslog</code>ã€‚</p><p>æ­¤ç¤ºä¾‹çš„æ¸…å•æ˜¯ï¼š</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/seccomp/ga/fine-pod.yaml download=pods/security/seccomp/ga/fine-pod.yaml><code>pods/security/seccomp/ga/fine-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-seccomp-ga-fine-pod-yaml")' title="Copy pods/security/seccomp/ga/fine-pod.yaml to clipboard"></img></div><div class=includecode id=pods-security-seccomp-ga-fine-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>fine-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>fine-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>seccompProfile</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>Localhost<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>localhostProfile</span>:<span style=color:#bbb> </span>profiles/fine-grained.json<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>hashicorp/http-echo:0.2.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;-text=just made some syscalls!&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>allowPrivilegeEscalation</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span></span></span></code></pre></div></div></div><p>åœ¨ä½ çš„é›†ç¾¤ä¸­åˆ›å»º Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/security/seccomp/ga/fine-pod.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod fine-pod
</span></span></code></pre></div><p>æ­¤ Pod åº”è¯¥æ˜¾ç¤ºä¸ºå·²æˆåŠŸå¯åŠ¨ï¼š</p><pre tabindex=0><code>NAME        READY   STATUS    RESTARTS   AGE
fine-pod   1/1     Running   0          30s
</code></pre><p>æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯çª—å£å¹¶ä½¿ç”¨ <code>tail</code> æ¥ç›‘è§†æåˆ°æ¥è‡ª <code>http-echo</code> çš„è°ƒç”¨çš„æ—¥å¿—æ¡ç›®ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># ä½ è®¡ç®—æœºä¸Šçš„æ—¥å¿—è·¯å¾„å¯èƒ½ä¸ â€œ/var/log/syslogâ€ ä¸åŒ</span>
</span></span><span style=display:flex><span>tail -f /var/log/syslog | grep <span style=color:#b44>&#39;http-echo&#39;</span>
</span></span></code></pre></div><p>æ¥ç€ï¼Œä½¿ç”¨ NodePort Service å…¬å¼€ Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl expose pod fine-pod --type NodePort --port <span style=color:#666>5678</span>
</span></span></code></pre></div><p>æ£€æŸ¥èŠ‚ç‚¹ä¸Šçš„ Service åˆ†é…äº†ä»€ä¹ˆç«¯å£ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service fine-pod
</span></span></code></pre></div><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><pre tabindex=0><code>NAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
fine-pod    NodePort   10.111.36.142   &lt;none&gt;        5678:32373/TCP   72s
</code></pre><p>ä½¿ç”¨ <code>curl</code> ä» kind æ§åˆ¶å¹³é¢å®¹å™¨å†…éƒ¨è®¿é—®ç«¯ç‚¹ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># å°† 6a96207fed4b æ›´æ”¹ä¸ºä½ ä» â€œdocker psâ€ çœ‹åˆ°çš„æ§åˆ¶å¹³é¢å®¹å™¨ ID</span>
</span></span><span style=display:flex><span>docker <span style=color:#a2f>exec</span> -it 6a96207fed4b curl localhost:32373
</span></span></code></pre></div><pre tabindex=0><code>just made some syscalls!
</code></pre><p>ä½ åº”è¯¥åœ¨ <code>syslog</code> ä¸­çœ‹ä¸åˆ°ä»»ä½•è¾“å‡ºã€‚
è¿™æ˜¯å› ä¸ºé…ç½®æ–‡ä»¶å…è®¸æ‰€æœ‰å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶æŒ‡å®šå¦‚æœè°ƒç”¨åˆ—è¡¨ä¹‹å¤–çš„ç³»ç»Ÿè°ƒç”¨åº”å‘ç”Ÿé”™è¯¯ã€‚
ä»å®‰å…¨è§’åº¦æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ç§ç†æƒ³çš„æƒ…å†µï¼Œä½†éœ€è¦åœ¨åˆ†æç¨‹åºæ—¶ä»˜å‡ºä¸€äº›åŠªåŠ›ã€‚
å¦‚æœæœ‰ä¸€ç§ç®€å•çš„æ–¹æ³•å¯ä»¥åœ¨ä¸éœ€è¦å¤ªå¤šåŠªåŠ›çš„æƒ…å†µä¸‹æ›´æ¥è¿‘è¿™ç§å®‰å…¨æ€§ï¼Œé‚£å°±å¤ªå¥½äº†ã€‚</p><p>åœ¨è½¬åˆ°ä¸‹ä¸€éƒ¨åˆ†ä¹‹å‰æ¸…ç†è¯¥ Pod å’ŒæœåŠ¡ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete service fine-pod --wait
</span></span><span style=display:flex><span>kubectl delete pod fine-pod --wait --now
</span></span></code></pre></div><h2 id=create-pod-that-uses-the-container-runtime-default-seccomp-profile>åˆ›å»ºä½¿ç”¨å®¹å™¨è¿è¡Œæ—¶é»˜è®¤ seccomp é…ç½®æ–‡ä»¶çš„ Pod</h2><p>å¤§å¤šæ•°å®¹å™¨è¿è¡Œæ—¶éƒ½æä¾›äº†ä¸€ç»„åˆç†çš„é»˜è®¤ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥åŠæ˜¯å¦å…è®¸æ‰§è¡Œè¿™äº›ç³»ç»Ÿè°ƒç”¨ã€‚
ä½ å¯ä»¥é€šè¿‡å°† Pod æˆ–å®¹å™¨çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­çš„ seccomp ç±»å‹è®¾ç½®ä¸º <code>RuntimeDefault</code>
æ¥ä¸ºä½ çš„å·¥ä½œè´Ÿè½½é‡‡ç”¨è¿™äº›é»˜è®¤å€¼ã€‚</p><div class="alert alert-info note callout" role=alert><strong>è¯´æ˜ï¼š</strong><p>å¦‚æœä½ å·²ç»å¯ç”¨äº† <code>SeccompDefault</code> <a href=/zh-cn/docs/reference/command-line-tools-reference/feature-gates/>ç‰¹æ€§é—¨æ§</a>ï¼Œ
åªè¦æ²¡æœ‰æŒ‡å®šå…¶ä»– seccomp é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆ Pod å°±ä¼šä½¿ç”¨ <code>SeccompDefault</code> çš„ seccomp é…ç½®æ–‡ä»¶ã€‚
å¦åˆ™ï¼Œé»˜è®¤å€¼ä¸º <code>Unconfined</code>ã€‚</div><p>è¿™æ˜¯ä¸€ä¸ª Pod çš„æ¸…å•ï¼Œå®ƒè¦æ±‚å…¶æ‰€æœ‰å®¹å™¨ä½¿ç”¨ <code>RuntimeDefault</code> seccomp é…ç½®æ–‡ä»¶ï¼š</p><div class=highlight><div class=copy-code-icon style=text-align:right><a href=https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/pods/security/seccomp/ga/default-pod.yaml download=pods/security/seccomp/ga/default-pod.yaml><code>pods/security/seccomp/ga/default-pod.yaml</code></a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick='copyCode("pods-security-seccomp-ga-default-pod-yaml")' title="Copy pods/security/seccomp/ga/default-pod.yaml to clipboard"></img></div><div class=includecode id=pods-security-seccomp-ga-default-pod-yaml><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>default-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>default-pod<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>seccompProfile</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>RuntimeDefault<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>test-container<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>hashicorp/http-echo:0.2.3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;-text=just made some more syscalls!&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>allowPrivilegeEscalation</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span></span></span></code></pre></div></div></div><p>åˆ›å»ºæ­¤ Podï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://k8s.io/examples/pods/security/seccomp/ga/default-pod.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod default-pod
</span></span></code></pre></div><p>æ­¤ Pod åº”è¯¥æ˜¾ç¤ºä¸ºæˆåŠŸå¯åŠ¨ï¼š</p><pre tabindex=0><code>NAME        READY   STATUS    RESTARTS   AGE
default-pod 1/1     Running   0          20s
</code></pre><p>æœ€åï¼Œä½ çœ‹åˆ°ä¸€åˆ‡æ­£å¸¸ä¹‹åï¼Œè¯·æ¸…ç†ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete pod default-pod --wait --now
</span></span></code></pre></div><h2 id=æ¥ä¸‹æ¥>æ¥ä¸‹æ¥</h2><p>ä½ å¯ä»¥äº†è§£æœ‰å…³ Linux seccomp çš„æ›´å¤šä¿¡æ¯ï¼š</p><ul><li><a href=https://lwn.net/Articles/656307/>seccomp æ¦‚è¿°</a></li><li><a href=https://docs.docker.com/engine/security/seccomp/>Docker çš„ Seccomp å®‰å…¨é…ç½®æ–‡ä»¶</a></li></ul></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/zh-cn/docs/home/>ä¸»é¡µ</a>
<a class=text-white href=/zh-cn/blog/>åšå®¢</a>
<a class=text-white href=/zh-cn/training/>åŸ¹è®­</a>
<a class=text-white href=/zh-cn/partners/>åˆä½œä¼™ä¼´</a>
<a class=text-white href=/zh-cn/community/>ç¤¾åŒº</a>
<a class=text-white href=/zh-cn/case-studies/>æ¡ˆä¾‹åˆ†æ</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes ä½œè€… | æ–‡æ¡£å‘å¸ƒåŸºäº <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a> æˆæƒè®¸å¯</small><br><small class=text-white>Copyright &copy; 2023 Linux åŸºé‡‘ä¼š&reg;ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚Linux åŸºé‡‘ä¼šå·²æ³¨å†Œå¹¶ä½¿ç”¨å•†æ ‡ã€‚å¦‚éœ€äº†è§£ Linux åŸºé‡‘ä¼šçš„å•†æ ‡åˆ—è¡¨ï¼Œè¯·è®¿é—®<a href=https://www.linuxfoundation.org/trademark-usage class=light-text>å•†æ ‡ä½¿ç”¨é¡µé¢</a></small><br><small class=text-white>ICP license: äº¬ICPå¤‡17074266å·-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>