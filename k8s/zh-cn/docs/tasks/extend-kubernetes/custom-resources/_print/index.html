<!doctype html><html lang=zh-cn class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=en href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://kubernetes.io/zh-cn/docs/tasks/extend-kubernetes/custom-resources/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>使用自定义资源 | Kubernetes</title><meta property="og:title" content="使用自定义资源"><meta property="og:description" content="生产级别的容器编排系统"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/zh-cn/docs/tasks/extend-kubernetes/custom-resources/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="使用自定义资源"><meta itemprop=description content="生产级别的容器编排系统"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用自定义资源"><meta name=twitter:description content="生产级别的容器编排系统"><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content><meta property="og:description" content><meta name=twitter:description content><meta property="og:url" content="https://kubernetes.io/zh-cn/docs/tasks/extend-kubernetes/custom-resources/"><meta property="og:title" content="使用自定义资源"><meta name=twitter:title content="使用自定义资源"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/zh-cn/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/zh-cn/docs/>文档</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/blog/>Kubernetes 博客</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/training/>培训</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/partners/>合作伙伴</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/community/>社区</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/case-studies/>案例分析</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>版本列表</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/zh-cn/docs/tasks/extend-kubernetes/custom-resources/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/zh-cn/docs/tasks/extend-kubernetes/custom-resources/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/zh-cn/docs/tasks/extend-kubernetes/custom-resources/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/zh-cn/docs/tasks/extend-kubernetes/custom-resources/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/zh-cn/docs/tasks/extend-kubernetes/custom-resources/>v1.21</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 (Chinese)</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/tasks/extend-kubernetes/custom-resources/>English</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/zh-cn/docs/tasks/extend-kubernetes/custom-resources/>返回本页常规视图</a>.</p></div><h1 class=title>使用自定义资源</h1><ul><li>1: <a href=#pg-dc64883f1fd119402b112d3ff6733452>使用 CustomResourceDefinition 扩展 Kubernetes API</a></li><li>2: <a href=#pg-7d2e2400f208b1637530752794e5a3bd>CustomResourceDefinition 的版本</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-dc64883f1fd119402b112d3ff6733452>1 - 使用 CustomResourceDefinition 扩展 Kubernetes API</h1><p>本页展示如何使用
<a href=/docs/reference/generated/kubernetes-api/v1.25/#customresourcedefinition-v1-apiextensions-k8s-io>CustomResourceDefinition</a>
将<a href=/zh-cn/docs/concepts/extend-kubernetes/api-extension/custom-resources/>定制资源（Custom Resource）</a>
安装到 Kubernetes API 上。</p><h2 id=准备开始>准备开始</h2><p><p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。
建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。
如果你还没有集群，你可以通过 <a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>Minikube</a>
构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>玩转 Kubernetes</a></li></ul>你的 Kubernetes 服务器版本必须不低于版本 1.16.
要获知版本信息，请输入 <code>kubectl version</code>.</p><p>如果你在使用较老的、仍处于被支持范围的 Kubernetes 版本，
请切换到该版本的文档查看对于你的集群而言有用的建议。</p><h2 id=create-a-customresourcedefinition>创建 CustomResourceDefinition</h2><p>当你创建新的 CustomResourceDefinition（CRD）时，Kubernetes API 服务器会为你所指定的每个版本生成一个新的
RESTful 资源路径。
基于 CRD 对象所创建的自定义资源可以是名字空间作用域的，也可以是集群作用域的，
取决于 CRD 对象 <code>spec.scope</code> 字段的设置。</p><p>与其它的内置对象一样，删除名字空间也将删除该名字空间中的所有自定义对象。
CustomResourceDefinitions 本身是无名字空间的，可在所有名字空间中访问。</p><p>例如，如果你将下面的 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code>
文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 名字必需与下面的 spec 字段匹配，并且格式为 &#39;&lt;名称的复数形式&gt;.&lt;组名&gt;&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名称，用于 REST API: /apis/&lt;组&gt;/&lt;版本&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 列举此 CustomResourceDefinition 所支持的版本</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># 每个版本都可以通过 served 标志来独立启用或禁止</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># 其中一个且只有一个版本必需被标记为存储版本</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL：/apis/&lt;组&gt;/&lt;版本&gt;/&lt;名称的复数形式&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，作为命令行使用时和显示时的别名</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是单数形式的驼峰命名（CamelCased）形式。你的资源清单会使用这一形式。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行使用较短的字符串来匹配资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div><p>之后创建它：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>这样一个新的受名字空间约束的 RESTful API 端点会被创建在：</p><pre tabindex=0><code>/apis/stable.example.com/v1/namespaces/*/crontabs/...
</code></pre><p>此端点 URL 自此可以用来创建和管理定制对象。对象的 <code>kind</code> 将是来自你上面创建时
所用的 spec 中指定的 <code>CronTab</code>。</p><p>创建端点的操作可能需要几秒钟。你可以监测你的 CustomResourceDefinition 的
<code>Established</code> 状况变为 true，或者监测 API 服务器的发现信息等待你的资源出现在
那里。</p><h2 id=create-custom-objects>创建定制对象</h2><p>在创建了 CustomResourceDefinition 对象之后，你可以创建定制对象（Custom
Objects）。定制对象可以包含定制字段。这些字段可以包含任意的 JSON 数据。
在下面的例子中，在类别为 <code>CronTab</code> 的定制对象中，设置了<code>cronSpec</code> 和 <code>image</code>
定制字段。类别 <code>CronTab</code> 来自你在上面所创建的 CRD 的规约。</p><p>如果你将下面的 YAML 保存到 <code>my-crontab.yaml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span></code></pre></div><p>并执行创建命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>你就可以使用 kubectl 来管理你的 CronTab 对象了。例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get crontab
</span></span></code></pre></div><p>应该会输出如下列表：</p><pre tabindex=0><code class=language-none data-lang=none>NAME                 AGE
my-new-cron-object   6s
</code></pre><p>使用 kubectl 时，资源名称是大小写不敏感的，而且你既可以使用 CRD 中所定义的单数
形式或复数形式，也可以使用其短名称：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get ct -o yaml
</span></span></code></pre></div><p>你可以看到输出中包含了你创建定制对象时在 YAML 文件中指定的定制字段 <code>cronSpec</code>
和 <code>image</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>stable.example.com/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#b44;font-style:italic>        </span><span style=color:#bbb>        </span>{<span style=color:#b44>&#34;apiVersion&#34;</span>:<span style=color:#b44>&#34;stable.example.com/v1&#34;</span>,<span style=color:#b44>&#34;kind&#34;</span>:<span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#b44>&#34;metadata&#34;</span>:{<span style=color:#b44>&#34;annotations&#34;</span>:{},<span style=color:#b44>&#34;name&#34;</span>:<span style=color:#b44>&#34;my-new-cron-object&#34;</span>,<span style=color:#b44>&#34;namespace&#34;</span>:<span style=color:#b44>&#34;default&#34;</span>},<span style=color:#b44>&#34;spec&#34;</span>:{<span style=color:#b44>&#34;cronSpec&#34;</span>:<span style=color:#b44>&#34;* * * * */5&#34;</span>,<span style=color:#b44>&#34;image&#34;</span>:<span style=color:#b44>&#34;my-awesome-cron-image&#34;</span>}}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2021-06-20T07:35:27Z&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>generation</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1326&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>9aab1d66-628e-41bb-a422-57b8b3b1f5a9<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;* * * * */5&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>List<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selfLink</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=delete-a-customresourcedefinition>删除 CustomResourceDefinition</h2><p>当你删除某 CustomResourceDefinition 时，服务器会卸载其 RESTful API
端点，并删除服务器上存储的所有定制对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f resourcedefinition.yaml
</span></span><span style=display:flex><span>kubectl get crontabs
</span></span></code></pre></div><pre tabindex=0><code class=language-none data-lang=none>Error from server (NotFound): Unable to list {&#34;stable.example.com&#34; &#34;v1&#34; &#34;crontabs&#34;}: the server could not
find the requested resource (get crontabs.stable.example.com)
</code></pre><p>如果你在以后创建相同的 CustomResourceDefinition 时，该 CRD 会是一个空的结构。</p><h2 id=specifying-a-structural-schema>设置结构化的模式</h2><p>CustomResource 对象在定制字段中保存结构化的数据，这些字段和内置的字段
<code>apiVersion</code>、<code>kind</code> 和 <code>metadata</code> 等一起存储，不过内置的字段都会被 API
服务器隐式完成合法性检查。有了 <a href=#validation>OpenAPI v3.0 检查</a>
能力之后，你可以设置一个模式（Schema），在创建和更新定制对象时，这一模式会被用来
对对象内容进行合法性检查。参阅下文了解这类模式的细节和局限性。</p><p>在 <code>apiextensions.k8s.io/v1</code> 版本中，CustomResourceDefinition 的这一结构化模式
定义是必需的。
在 CustomResourceDefinition 的 beta 版本中，结构化模式定义是可选的。</p><p>结构化模式本身是一个 <a href=#validation>OpenAPI v3.0 验证模式</a>，其中：</p><ol><li>为对象根（root）设置一个非空的 type 值（藉由 OpenAPI 中的 <code>type</code>），对每个
object 节点的每个字段（藉由 OpenAPI 中的 <code>properties</code> 或 <code>additionalProperties</code>）以及
array 节点的每个条目（藉由 OpenAPI 中的 <code>items</code>）也要设置非空的 type 值，
除非：<ul><li>节点包含属性 <code>x-kubernetes-int-or-string: true</code></li><li>节点包含属性 <code>x-kubernetes-preserve-unknown-fields: true</code></li></ul></li><li>对于 object 的每个字段或 array 中的每个条目，如果其定义中包含 <code>allOf</code>、<code>anyOf</code>、<code>oneOf</code>
或 <code>not</code>，则模式也要指定这些逻辑组合之外的字段或条目（试比较例 1 和例 2)。</li><li>在 <code>allOf</code>、<code>anyOf</code>、<code>oneOf</code> 或 <code>not</code> 上下文内不设置 <code>description</code>、<code>type</code>、<code>default</code>、
<code>additionalProperties</code> 或者 <code>nullable</code>。此规则的例外是
<code>x-kubernetes-int-or-string</code> 的两种模式（见下文）。</li><li>如果 <code>metadata</code> 被设置，则只允许对 <code>metadata.name</code> 和 <code>metadata.generateName</code> 设置约束。</li></ol><p>非结构化的例 1:</p><pre tabindex=0><code class=language-none data-lang=none>allOf:
- properties:
    foo:
      ...
</code></pre><p>违反了第 2 条规则。下面的是正确的：</p><pre tabindex=0><code class=language-none data-lang=none>properties:
  foo:
    ...
allOf:
- properties:
    foo:
      ...
</code></pre><p>非结构化的例 2：</p><pre tabindex=0><code class=language-none data-lang=none>allOf:
- items:
    properties:
      foo:
        ...
</code></pre><p>违反了第 2 条规则。下面的是正确的：</p><pre tabindex=0><code class=language-none data-lang=none>items:
  properties:
    foo:
      ...
allOf:
- items:
    properties:
      foo:
        ...
</code></pre><p>非结构化的例 3：</p><pre tabindex=0><code class=language-none data-lang=none>properties:
  foo:
    pattern: &#34;abc&#34;
  metadata:
    type: object
    properties:
      name:
        type: string
        pattern: &#34;^a&#34;
      finalizers:
        type: array
        items:
          type: string
          pattern: &#34;my-finalizer&#34;
anyOf:
- properties:
    bar:
      type: integer
      minimum: 42
  required: [&#34;bar&#34;]
  description: &#34;foo bar object&#34;
</code></pre><p>不是一个结构化的模式，因为其中存在以下违例：</p><ul><li>根节点缺失 type 设置（规则 1）</li><li><code>foo</code> 的 type 缺失（规则 1）</li><li><code>anyOf</code> 中的 <code>bar</code> 未在外部指定（规则 2）</li><li><code>bar</code> 的 <code>type</code> 位于 <code>anyOf</code> 中（规则 3）</li><li><code>anyOf</code> 中设置了 <code>description</code> （规则 3）</li><li><code>metadata.finalizers</code> 不可以被限制 (规则 4）</li></ul><p>作为对比，下面的 YAML 所对应的模式则是结构化的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;foo bar object&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;abc&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;^a&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>anyOf</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>42</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>required</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;bar&#34;</span>]<span style=color:#bbb>
</span></span></span></code></pre></div><p>如果违反了结构化模式规则，CustomResourceDefinition 的 <code>NonStructural</code>
状况中会包含报告信息。</p><h3 id=field-pruning>字段剪裁</h3><p>CustomResourceDefinition 在集群的持久性存储
<a class=glossary-tooltip title='一致且高度可用的键值存储，用作 Kubernetes 的所有集群数据的后台数据库。' data-toggle=tooltip data-placement=top href=/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/ target=_blank aria-label=etcd>etcd</a>
中保存经过合法性检查的资源数据。
就像原生的 Kubernetes 资源，例如 <a class=glossary-tooltip title='ConfigMap 是一种 API 对象，用来将非机密性的数据保存到键值对中。使用时可以用作环境变量、命令行参数或者存储卷中的配置文件。' data-toggle=tooltip data-placement=top href=/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a>，
如果你指定了 API 服务器所无法识别的字段，则该未知字段会在保存资源之前被
<strong>剪裁（Pruned）</strong> 掉（删除）。</p><p>从 <code>apiextensions.k8s.io/v1beta1</code> 转换到 <code>apiextensions.k8s.io/v1</code> 的 CRD
可能没有结构化的模式定义，因此其 <code>spec.preserveUnknownFields</code> 可能为 <code>true</code>。</p><p>对于使用 <code>apiextensions.k8s.io/v1beta1</code> 且将 <code>spec.preserveUnknownFields</code> 设置为 <code>true</code>
创建的旧 CustomResourceDefinition 对象，有以下表现：</p><ul><li>裁剪未启用。</li><li>可以存储任意数据。</li></ul><p>为了与 <code>apiextensions.k8s.io/v1</code> 兼容，将你的定制资源定义更新为：</p><ol><li>使用结构化的 OpenAPI 模式。</li><li><code>spec.preserveUnknownFields</code> 设置为 <code>false</code>。</li></ol><p>如果你将下面的 YAML 保存到 <code>my-crontab.yaml</code> 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>someRandomField</span>:<span style=color:#bbb> </span><span style=color:#666>42</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>并创建之：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create --validate<span style=color:#666>=</span><span style=color:#a2f>false</span> -f my-crontab.yaml -o yaml
</span></span></code></pre></div><p>输出类似于：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>stable.example.com/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span>2017-05-31T12:56:35Z<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>generation</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;285&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>9423255b-4600-11e7-af6a-28d2447dc82b<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;* * * * */5&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span></code></pre></div><p>注意其中的字段 <code>someRandomField</code> 已经被剪裁掉。</p><p>本例中通过 <code>--validate=false</code> 命令行选项 关闭了客户端的合法性检查以展示 API 服务器的行为，
因为 <a href=#publish-validation-schema-in-openapi-v2>OpenAPI 合法性检查模式也会发布到</a>
客户端，<code>kubectl</code> 也会检查未知的字段并在对象被发送到 API
服务器之前就拒绝它们。</p><h4 id=controlling-pruning>控制剪裁</h4><p>默认情况下，定制资源的所有版本中的所有未规定的字段都会被剪裁掉。
通过在结构化的 OpenAPI v3 <a href=#specifying-a-structural-schema>检查模式定义</a>
中为特定字段的子树添加 <code>x-kubernetes-preserve-unknown-fields: true</code> 属性，
可以选择不对其执行剪裁操作。</p><p>例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>字段 <code>json</code> 可以保存任何 JSON 值，其中内容不会被剪裁掉。</p><p>你也可以部分地指定允许的 JSON 数据格式；例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>this is arbitrary JSON<span style=color:#bbb>
</span></span></span></code></pre></div><p>通过这样设置，JSON 中只能设置 <code>object</code> 类型的值。</p><p>对于所指定的每个属性（或 <code>additionalProperties</code>），剪裁会再次被启用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span></code></pre></div><p>对于上述定义，如果提供的数值如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span>abc<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span>def<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span></span></span></code></pre></div><p>则该值会被剪裁为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span>abc<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span>def<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span></span></span></code></pre></div><p>这意味着所指定的 <code>spec</code> 对象中的 <code>something</code> 字段被剪裁掉，而其外部的内容都被保留。</p><h3 id=intorstring>IntOrString</h3><p>模式定义中标记了 <code>x-kubernetes-int-or-string: true</code> 的节点不受前述规则 1
约束，因此下面的定义是结构化的模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-int-or-string</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>此外，所有这类节点也不再受规则 3 约束，也就是说，下面两种模式是被允许的
（注意，仅限于这两种模式，不支持添加新字段的任何其他变种）：</p><pre tabindex=0><code class=language-none data-lang=none>x-kubernetes-int-or-string: true
anyOf:
  - type: integer
  - type: string
...
</code></pre><p>和</p><pre tabindex=0><code class=language-none data-lang=none>x-kubernetes-int-or-string: true
allOf:
  - anyOf:
      - type: integer
      - type: string
  - ... # zero or more
...
</code></pre><p>在以上两种规约中，整数值和字符串值都会被认为是合法的。</p><p>在<a href=#publish-validation-schema-in-openapi-v2>合法性检查模式定义的发布时</a>，
<code>x-kubernetes-int-or-string: true</code> 会被展开为上述两种模式之一。</p><h3 id=rawextension>RawExtension</h3><p>RawExtensions（就像在
<a href=https://github.com/kubernetes/apimachinery/blob/03ac7a9ade429d715a1a46ceaa3724c18ebae54f/pkg/runtime/types.go#L94>k8s.io/apimachinery</a>
项目中 <code>runtime.RawExtension</code> 所定义的那样）
可以保存完整的 Kubernetes 对象，也就是，其中会包含 <code>apiVersion</code> 和 <code>kind</code>
字段。</p><p>通过 <code>x-kubernetes-embedded-resource: true</code> 来设定这些嵌套对象的规约
（无论是完全无限制还是部分指定都可以）是可能的。例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-embedded-resource</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>这里，字段 <code>foo</code> 包含一个完整的对象，例如：</p><pre tabindex=0><code class=language-none data-lang=none>foo:
  apiVersion: v1
  kind: Pod
  spec:
    ...
</code></pre><p>由于字段上设置了 <code>x-kubernetes-preserve-unknown-fields: true</code>，其中的内容不会
被剪裁。不过，在这个语境中，<code>x-kubernetes-preserve-unknown-fields: true</code> 的
使用是可选的。</p><p>设置了 <code>x-kubernetes-embedded-resource: true</code> 之后，<code>apiVersion</code>、<code>kind</code> 和
<code>metadata</code> 都是隐式设定并隐式完成合法性验证。</p><h2 id=serving-multiple-versions-of-a-crd>提供 CRD 的多个版本</h2><p>关于如何为你的 CustomResourceDefinition 提供多个版本的支持，
以及如何将你的对象从一个版本迁移到另一个版本，
详细信息可参阅 <a href=/zh-cn/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/>CustomResourceDefinition 的版本管理</a>。</p><h2 id=advanced-topics>高级主题</h2><h3 id=finalizers>Finalizers</h3><p><strong>Finalizer</strong> 能够让控制器实现异步的删除前（Pre-delete）回调。
与内置对象类似，定制对象也支持 Finalizer。</p><p>你可以像下面一样为定制对象添加 Finalizer：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>finalizers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- stable.example.com/finalizer<span style=color:#bbb>
</span></span></span></code></pre></div><p>自定义 Finalizer 的标识符包含一个域名、一个正向斜线和 finalizer 的名称。
任何控制器都可以在任何对象的 finalizer 列表中添加新的 finalizer。</p><p>对带有 Finalizer 的对象的第一个删除请求会为其 <code>metadata.deletionTimestamp</code>
设置一个值，但不会真的删除对象。一旦此值被设置，<code>finalizers</code> 列表中的表项只能被移除。
在列表中仍然包含 finalizer 时，无法强制删除对应的对象。</p><p>当 <code>metadata.deletionTimestamp</code> 字段被设置时，监视该对象的各个控制器会执行它们所能处理的
finalizer，并在完成处理之后将其从列表中移除。
每个控制器负责将其 finalizer 从列表中删除。</p><p><code>metadata.deletionGracePeriodSeconds</code> 的取值控制对更新的轮询周期。</p><p>一旦 finalizers 列表为空时，就意味着所有 finalizer 都被执行过，
Kubernetes 会最终删除该资源，</p><h3 id=validation>合法性检查</h3><p>定制资源是通过
<a href=https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#schemaObject>OpenAPI v3 模式定义</a>
来执行合法性检查的，当启用<a href=#validation-rules>验证规则特性</a>时，通过 <code>x-kubernetes-validations</code> 验证，
你可以通过使用<a href=/zh-cn/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook>准入控制 Webhook</a>
来添加额外的合法性检查逻辑。</p><p>此外，对模式定义存在以下限制：</p><ul><li><p>以下字段不可设置：</p><ul><li><code>definitions</code></li><li><code>dependencies</code></li><li><code>deprecated</code></li><li><code>discriminator</code></li><li><code>id</code></li><li><code>patternProperties</code></li><li><code>readOnly</code></li><li><code>writeOnly</code></li><li><code>xml</code></li><li><code>$ref</code></li></ul></li><li><p>字段 <code>uniqueItems</code> 不可设置为 <code>true</code></p></li><li><p>字段 <code>additionalProperties</code> 不可设置为 <code>false</code></p></li><li><p>字段 <code>additionalProperties</code> 与 <code>properties</code> 互斥，不可同时使用</p></li></ul><p>当<a href=#validation-rules>验证规则特性</a>被启用并且 CustomResourceDefinition
模式是一个<a href=#specifying-a-structural-schema>结构化的模式定义</a>时，
<code>x-kubernetes-validations</code>
扩展可以使用<a href=https://github.com/google/cel-spec>通用表达式语言 (CEL)</a>表达式来验证定制资源。</p><p>关于对某些 CustomResourceDefinition 特性所必需的限制，
可参见<a href=#specifying-a-structural-schema>结构化的模式定义</a>小节。</p><p>模式定义是在 CustomResourceDefinition 中设置的。在下面的例子中，
CustomResourceDefinition 对定制对象执行以下合法性检查：</p><ul><li><code>spec.cronSpec</code> 必须是一个字符串，必须是正则表达式所描述的形式；</li><li><code>spec.replicas</code> 必须是一个整数，且其最小值为 1、最大值为 10。</li></ul><p>将此 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code> 文件中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># openAPIV3Schema 是验证自定义对象的模式。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>maximum</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div><p>并创建 CustomResourceDefinition：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>对于一个创建 CronTab 类别对象的定制对象的请求而言，如果其字段中包含非法值，则
该请求会被拒绝。
在下面的例子中，定制对象中包含带非法值的字段：</p><ul><li><code>spec.cronSpec</code> 与正则表达式不匹配</li><li><code>spec.replicas</code> 数值大于 10。</li></ul><p>如果你将下面的 YAML 保存到 <code>my-crontab.yaml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * *&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>并尝试创建定制对象：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>你会看到下面的错误信息：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#888>The CronTab &#34;my-new-cron-object&#34; is invalid: []: Invalid value: map[string]interface {}{&#34;apiVersion&#34;:&#34;stable.example.com/v1&#34;, &#34;kind&#34;:&#34;CronTab&#34;, &#34;metadata&#34;:map[string]interface {}{&#34;name&#34;:&#34;my-new-cron-object&#34;, &#34;namespace&#34;:&#34;default&#34;, &#34;deletionTimestamp&#34;:interface {}(nil), &#34;deletionGracePeriodSeconds&#34;:(*int64)(nil), &#34;creationTimestamp&#34;:&#34;2017-09-05T05:20:07Z&#34;, &#34;uid&#34;:&#34;e14d79e7-91f9-11e7-a598-f0761cb232d1&#34;, &#34;clusterName&#34;:&#34;&#34;}, &#34;spec&#34;:map[string]interface {}{&#34;cronSpec&#34;:&#34;* * * *&#34;, &#34;image&#34;:&#34;my-awesome-cron-image&#34;, &#34;replicas&#34;:15}}:
</span></span></span><span style=display:flex><span><span style=color:#888>validation failure list:
</span></span></span><span style=display:flex><span><span style=color:#888>spec.cronSpec in body should match &#39;^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$&#39;
</span></span></span><span style=display:flex><span><span style=color:#888>spec.replicas in body should be less than or equal to 10
</span></span></span></code></pre></div><p>如果所有字段都包含合法值，则对象创建的请求会被接受。</p><p>将下面的 YAML 保存到 <code>my-crontab.yaml</code> 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>并创建定制对象：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span><span style=display:flex><span>crontab <span style=color:#b44>&#34;my-new-cron-object&#34;</span> created
</span></span></code></pre></div><h2 id=验证规则>验证规则</h2><div style=margin-top:10px;margin-bottom:10px><b>特性状态：</b> <code>Kubernetes v1.25 [beta]</code></div><p>验证规则从 1.25 开始处于 Beta 状态，
默认情况下，<code>CustomResourceValidationExpressions</code> <a href=/zh-cn/docs/reference/command-line-tools-reference/feature-gates/>特性门控</a>
是被启用的，以便根据<strong>验证规则</strong>来验证定制资源。
对于 <a href=/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/><code>kube-apiserver</code></a> 组件，
特性门控显式设置为 false 来禁用此特性。</p><p>这个特性只有在模式是<a href=#specifying-a-structural-schema>结构化的模式</a>时才可用。</p><p>验证规则使用<a href=https://github.com/google/cel-spec>通用表达式语言（CEL）</a>来验证定制资源的值。
验证规则使用 <code>x-kubernetes-validations</code> 扩展包含在 <code>CustomResourceDefinition</code> 模式定义中。</p><p>规则的作用域是模式定义中 <code>x-kubernetes-validations</code> 扩展所在的位置。
CEL 表达式中的 <code>self</code> 变量被绑定到限定作用域的取值。</p><p>所有验证规则都是针对当前对象的：不支持跨对象或有状态的验证规则。</p><p>例如:</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        x-kubernetes-validations:
          - rule: &#34;self.minReplicas &lt;= self.replicas&#34;
            message: &#34;replicas should be greater than or equal to minReplicas.&#34;
          - rule: &#34;self.replicas &lt;= self.maxReplicas&#34;
            message: &#34;replicas should be smaller than or equal to maxReplicas.&#34;
        properties:
          ...
          minReplicas:
            type: integer
          replicas:
            type: integer
          maxReplicas:
            type: integer
        required:
          - minReplicas
          - replicas
          - maxReplicas 
</code></pre><p>将拒绝创建这个定制资源的请求:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>minReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>20</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>maxReplicas</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>返回响应为：</p><pre tabindex=0><code>The CronTab &#34;my-new-cron-object&#34; is invalid:
* spec: Invalid value: map[string]interface {}{&#34;maxReplicas&#34;:10, &#34;minReplicas&#34;:0, &#34;replicas&#34;:20}: replicas should be smaller than or equal to maxReplicas.
</code></pre><p><code>x-kubernetes-validations</code> 可以有多条规则。</p><p><code>x-kubernetes-validations</code> 下的 <code>rule</code> 代表将由 CEL 评估的表达式。</p><p><code>message</code> 代表验证失败时显示的信息。如果消息没有设置，上述响应将是：</p><pre tabindex=0><code>The CronTab &#34;my-new-cron-object&#34; is invalid:
* spec: Invalid value: map[string]interface {}{&#34;maxReplicas&#34;:10, &#34;minReplicas&#34;:0, &#34;replicas&#34;:20}: failed rule: self.replicas &lt;= self.maxReplicas
</code></pre><p>当 CRD 被创建/更新时，验证规则被编译。
如果验证规则的编译失败，CRD 的创建/更新请求将失败。
编译过程也包括类型检查。</p><p>编译失败：</p><ul><li><p><code>no_matching_overload</code>：此函数没有参数类型的重载。</p><p>例如，像 <code>self == true</code> 这样的规则对一个整数类型的字段将得到错误：</p><pre tabindex=0><code>Invalid value: apiextensions.ValidationRule{Rule:&#34;self == true&#34;, Message:&#34;&#34;}: compilation failed: ERROR: \&lt;input&gt;:1:6: found no matching overload for &#39;_==_&#39; applied to &#39;(int, bool)&#39;
</code></pre></li></ul><ul><li><p><code>no_such_field</code>：不包含所需的字段。</p><p>例如，针对一个不存在的字段，像 <code>self.nonExistingField > 0</code> 这样的规则将返回错误：</p><pre tabindex=0><code>Invalid value: apiextensions.ValidationRule{Rule:&#34;self.nonExistingField &gt; 0&#34;, Message:&#34;&#34;}: compilation failed: ERROR: \&lt;input&gt;:1:5: undefined field &#39;nonExistingField&#39;
</code></pre></li></ul><ul><li><p><code>invalid argument</code>：对宏的无效参数。</p><p>例如，像 <code>has(self)</code> 这样的规则将返回错误：</p><pre tabindex=0><code>Invalid value: apiextensions.ValidationRule{Rule:&#34;has(self)&#34;, Message:&#34;&#34;}: compilation failed: ERROR: &lt;input&gt;:1:4: invalid argument to has() macro
</code></pre></li></ul><p>验证规则例子：</p><table><thead><tr><th>规则</th><th>目的</th></tr></thead><tbody><tr><td><code>self.minReplicas &lt;= self.replicas && self.replicas &lt;= self.maxReplicas</code></td><td>验证定义副本数的三个字段大小顺序是否正确</td></tr><tr><td><code>'Available' in self.stateCounts</code></td><td>验证 map 中是否存在键名为 <code>Available</code>的条目</td></tr><tr><td><code>(size(self.list1) == 0) != (size(self.list2) == 0)</code></td><td>验证两个 list 之一是非空的，但不是二者都非空</td></tr><tr><td><code>!('MY_KEY' in self.map1) || self['MY_KEY'].matches('^[a-zA-Z]*$')</code></td><td>如果某个特定的 key 在 map 中，验证 map 中这个 key 的 value</td></tr><tr><td><code>self.envars.filter(e, e.name = 'MY_ENV').all(e, e.value.matches('^[a-zA-Z]*$')</code></td><td>验证一个 listMap 中主键 'name' 为 'MY_ENV' 'value' 的表项，检查其取值 'value'</td></tr><tr><td><code>has(self.expired) && self.created + self.ttl &lt; self.expired</code></td><td>验证 'Expired' 日期是否晚于 'Create' 日期加上 'ttl' 持续时间</td></tr><tr><td><code>self.health.startsWith('ok')</code></td><td>验证 'health' 字符串字段有前缀 'ok'</td></tr><tr><td><code>self.widgets.exists(w, w.key == 'x' && w.foo &lt; 10)</code></td><td>验证 key 为 'x' 的 listMap 项的 'foo' 属性是否小于 10</td></tr><tr><td><code>type(self) == string ? self == '100%' : self == 1000</code></td><td>在 int 型和 string 型两种情况下验证 int-or-string 字段</td></tr><tr><td><code>self.metadata.name.startsWith(self.prefix)</code></td><td>验证对象的名称是否具有另一个字段值的前缀</td></tr><tr><td><code>self.set1.all(e, !(e in self.set2))</code></td><td>验证两个 listSet 是否不相交</td></tr><tr><td><code>size(self.names) == size(self.details) && self.names.all(n, n in self.details)</code></td><td>验证 'details' map 是由 'names' listSet 的项目所决定的。</td></tr><tr><td><code>size(self.clusters.filter(c, c.name == self.primary)) == 1</code></td><td>验证 'primary' 属性仅在 'clusters' listMap 中出现一次且只有一次</td></tr></tbody></table><p>参考：<a href=https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#evaluation>CEL 中支持的求值</a></p><ul><li><p>如果规则的作用域是某资源的根，则它可以对 CRD 的 OpenAPIv3 模式表达式中声明的任何字段进行字段选择，
以及 <code>apiVersion</code>、<code>kind</code>、<code>metadata.name</code> 和 <code>metadata.generateName</code>。
这包括在同一表达式中对 <code>spec</code> 和 <code>status</code> 的字段进行选择：</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    x-kubernetes-validations:
      - rule: &#34;self.status.availableReplicas &gt;= self.spec.minReplicas&#34;
    properties:
        spec:
          type: object
          properties:
            minReplicas:
              type: integer
            ...
        status:
          type: object
          properties:
            availableReplicas:
              type: integer
</code></pre></li></ul><ul><li><p>如果规则的作用域是具有属性的对象，那么可以通过 <code>self.field</code> 对该对象的可访问属性进行字段选择，
而字段存在与否可以通过 <code>has(self.field)</code> 来检查。
在 CEL 表达式中，Null 值的字段被视为不存在的字段。</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        x-kubernetes-validations:
          - rule: &#34;has(self.foo)&#34;
        properties:
          ...
          foo:
            type: integer
</code></pre></li></ul><ul><li><p>如果规则的作用域是一个带有 additionalProperties 的对象（即map），那么 map 的值
可以通过 <code>self[mapKey]</code> 访问，map 的包含性可以通过 <code>mapKey in self</code> 检查，
map 中的所有条目可以通过 CEL 宏和函数如 <code>self.all(...)</code> 访问。</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        x-kubernetes-validations:
          - rule: &#34;self[&#39;xyz&#39;].foo &gt; 0&#34;
        additionalProperties:
          ...
          type: object
          properties:
            foo:
              type: integer
</code></pre></li></ul><ul><li><p>如果规则的作用域是 array，则 array 的元素可以通过 <code>self[i]</code> 访问，也可以通过宏和函数访问。</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      ...
      foo:
        type: array
        x-kubernetes-validations:
          - rule: &#34;size(self) == 1&#34;
        items:
          type: string
</code></pre></li></ul><ul><li><p>如果规则的作用域为标量，则 <code>self</code> 将绑定到标量值。</p><pre tabindex=0><code class=language-none data-lang=none>  ...
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        properties:
          ...
          foo:
            type: integer
            x-kubernetes-validations:
            - rule: &#34;self &gt; 0&#34;
</code></pre></li></ul><p>例子：</p><table><thead><tr><th>规则作用域字段类型</th><th>规则示例</th></tr></thead><tbody><tr><td>根对象</td><td><code>self.status.actual &lt;= self.spec.maxDesired</code></td></tr><tr><td>对象映射</td><td><code>self.components['Widget'].priority &lt; 10</code></td></tr><tr><td>整数列表</td><td><code>self.values.all(value, value >= 0 && value &lt; 100)</code></td></tr><tr><td>字符串</td><td><code>self.startsWith('kube')</code></td></tr></tbody></table><p><code>apiVersion</code>、<code>kind</code>、<code>metadata.name</code> 和 <code>metadata.generateName</code>
始终可以从对象的根目录和任何带有 <code>x-kubernetes-embedded-resource</code> 注解的对象访问。
其他元数据属性都不可访问。</p><p>通过 <code>x-kubernetes-preserve-unknown-fields</code> 保存在定制资源中的未知数据在 CEL 表达中无法访问。
这包括：</p><ul><li><p>使用 <code>x-kubernetes-preserve-unknown-fields</code> 的对象模式保留的未知字段值。</p></li><li><p>属性模式为"未知类型（Unknown Type）"的对象属性。一个"未知类型"被递归定义为：</p><ul><li>一个没有类型的模式，<code>x-kubernetes-preserve-unknown-fields</code> 设置为 true。</li><li>一个数组，其中项目模式为"未知类型"</li><li>一个 additionalProperties 模式为"未知类型"的对象</li></ul></li></ul><p>只有 <code>[a-zA-Z_.-/][a-zA-Z0-9_.-/]*</code> 形式的属性名是可访问的。
当在表达式中访问时，可访问的属性名称会根据以下规则进行转义：</p><table><thead><tr><th>转义序列</th><th>属性名称等效为</th></tr></thead><tbody><tr><td><code>__underscores__</code></td><td><code>__</code></td></tr><tr><td><code>__dot__</code></td><td><code>.</code></td></tr><tr><td><code>__dash__</code></td><td><code>-</code></td></tr><tr><td><code>__slash__</code></td><td><code>/</code></td></tr><tr><td><code>__{keyword}__</code></td><td><a href=https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#syntax>CEL 保留关键字</a></td></tr></tbody></table><p>注意：CEL 保留关键字需要与要转义的确切属性名匹配(例如，单词 <code>sprint</code> 中的 <code>int</code> 不会转义)。</p><p>转义的例子：</p><table><thead><tr><th>属性名</th><th>转义属性名规则</th></tr></thead><tbody><tr><td>namespace</td><td><code>self.__namespace__ > 0</code></td></tr><tr><td>x-prop</td><td><code>self.x__dash__prop > 0</code></td></tr><tr><td>redact__d</td><td><code>self.redact__underscores__d > 0</code></td></tr><tr><td>string</td><td><code>self.startsWith('kube')</code></td></tr></tbody></table><p><code>set</code> 或 <code>map</code> 的 <code>x-Kubernetes-list-type</code> 的数组的等值比较会忽略元素顺序，即 <code>[1，2] == [2，1]</code>。
使用 <code>x-kubernetes-list-type</code> 对数组进行串联时，使用 List 类型的语义：</p><ul><li><p><code>set</code>：<code>X + Y</code> 执行一个并集操作，其中 <code>X</code> 中所有元素的数组位置被保留，
<code>Y</code> 中不相交的元素被追加，保留其部分顺序。</p></li><li><p><code>map</code>：<code>X + Y</code>执行合并，其中 <code>X</code> 中所有键的数组位置被保留，
但当 <code>X</code> 和 <code>Y</code> 的键集相交时，其值被 <code>Y</code> 中的值覆盖。
<code>Y</code> 中键值不相交的元素被附加，保留其部分顺序。</p></li></ul><p>以下是 OpenAPIV3 和 CEL 类型之间的声明类型映射：</p><table><thead><tr><th>OpenAPIv3 类型</th><th>CEL 类型</th></tr></thead><tbody><tr><td>带有 Properties 的对象</td><td>对象 / "消息类型"</td></tr><tr><td>带有 AdditionalProperties 的对象</td><td>map</td></tr><tr><td>带有 x-kubernetes-embedded-type 的对象</td><td>对象 / "消息类型"，'apiVersion'、'kind'、'metadata.name' 和 'metadata.generateName' 都隐式包含在模式中</td></tr><tr><td>带有 x-kubernetes-preserve-unknown-fields 的对象</td><td>对象 / "消息类型"，未知字段无法从 CEL 表达式中访问</td></tr><tr><td>x-kubernetes-int-or-string</td><td>可能是整数或字符串的动态对象，可以用 <code>type(value)</code> 来检查类型</td></tr><tr><td>数组</td><td>list</td></tr><tr><td>带有 x-kubernetes-list-type=map 的数组</td><td>列表，基于集合等值和唯一键名保证的 map 组成</td></tr><tr><td>带有 x-kubernetes-list-type=set 的数组</td><td>列表，基于集合等值和唯一键名保证的 set 组成</td></tr><tr><td>布尔值</td><td>boolean</td></tr><tr><td>数字 (各种格式)</td><td>double</td></tr><tr><td>整数 (各种格式)</td><td>int (64)</td></tr><tr><td>'null'</td><td>null_type</td></tr><tr><td>字符串</td><td>string</td></tr><tr><td>带有 format=byte （base64 编码）字符串</td><td>bytes</td></tr><tr><td>带有 format=date 字符串</td><td>timestamp (google.protobuf.Timestamp)</td></tr><tr><td>带有 format=datetime 字符串</td><td>timestamp (google.protobuf.Timestamp)</td></tr><tr><td>带有 format=duration 字符串</td><td>duration (google.protobuf.Duration)</td></tr></tbody></table><p>参考：<a href=https://github.com/google/cel-spec/blob/v0.6.0/doc/langdef.md#values>CEL 类型</a>、
<a href=https://swagger.io/specification/#data-types>OpenAPI 类型</a>、
<a href=/zh-cn/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#specifying-a-structural-schema>Kubernetes 结构化模式</a>。</p><h4 id=available-validation-functions>验证函数</h4><p>可用的函数包括：</p><ul><li>CEL 标准函数，在<a href=https://github.com/google/cel-spec/blob/v0.7.0/doc/langdef.md#list-of-standard-definitions>标准定义列表</a>中定义</li><li>CEL 标准<a href=https://github.com/google/cel-spec/blob/v0.7.0/doc/langdef.md#macros>宏</a></li><li>CEL <a href=https://pkg.go.dev/github.com/google/cel-go@v0.11.2/ext#Strings>扩展字符串函数库</a></li><li>Kubernetes <a href=https://pkg.go.dev/k8s.io/apiextensions-apiserver@v0.24.0/pkg/apiserver/schema/cel/library#pkg-functions>CEL 扩展库</a></li></ul><h4 id=转换规则>转换规则</h4><p>包含引用标识符 <code>oldSself</code> 的表达式的规则被隐式视为 <strong>转换规则（Transition Rule）</strong>。
转换规则允许模式作者阻止两个原本有效的状态之间的某些转换。例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>enum</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;low&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;medium&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;high&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;!(self == &#39;high&#39; &amp;&amp; oldSelf == &#39;low&#39;) &amp;&amp; !(self == &#39;low&#39; &amp;&amp; oldSelf == &#39;high&#39;)&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>cannot transition directly between &#39;low&#39; and &#39;high&#39;<span style=color:#bbb>
</span></span></span></code></pre></div><p>与其他规则不同，转换规则仅适用于满足以下条件的操作：</p><ul><li>更新现有对象的操作。转换规则从不适用于创建操作。</li></ul><ul><li>旧的值和新的值都存在。仍然可以通过在父节点上放置转换规则来检查值是否已被添加或移除。
转换规则从不应用于定制资源创建。当被放置在可选字段上时，转换规则将不适用于设置或取消设置该字段的更新操作。</li></ul><ul><li>被转换规则验证的模式节点的路径必须解析到一个在旧对象和新对象之间具有可比性的节点。
例如，列表项和它们的后代（<code>spec.foo[10].bar</code>）不一定能在现有对象和后来对同一对象的更新之间产生关联。</li></ul><p>如果一个模式节点包含一个永远不能应用的转换规则，在 CRD 写入时将会产生错误，例如：
"<em>path</em>: update rule <em>rule</em> cannot be set on schema because the schema or its parent
schema is not mergeable"。</p><p>转换规则只允许在模式的 <strong>可关联部分（Correlatable Portions）</strong> 中使用。
如果所有 <code>array</code> 父模式都是 <code>x-kubernetes-list-type=map</code>类型的，那么该模式的一部分就是可关联的；
任何 <code>set</code> 或者 <code>atomic</code> 数组父模式都不支持确定性地将 <code>self</code> 与 <code>oldSelf</code> 关联起来。</p><p>这是一些转换规则的例子：</p><table><caption style=display:none>转换规则样例</caption><thead><tr><th>用例</th><th>规则</th></tr></thead><tbody><tr><td>不可变</td><td><code>self.foo == oldSelf.foo</code></td></tr><tr><td>赋值后禁止修改/删除</td><td><code>oldSelf != 'bar' || self == 'bar'</code> or <code>!has(oldSelf.field) || has(self.field)</code></td></tr><tr><td>仅附加的 set</td><td><code>self.all(element, element in oldSelf)</code></td></tr><tr><td>如果之前的值为 X，则新值只能为 A 或 B，不能为 Y 或 Z</td><td><code>oldSelf != 'X' || self in ['A', 'B']</code></td></tr><tr><td>单调（非递减）计数器</td><td><code>self >= oldSelf</code></td></tr></tbody></table><h4 id=验证函数的资源使用>验证函数的资源使用</h4><p>当你创建或更新一个使用验证规则的 CustomResourceDefinition 时，
API 服务器会检查运行这些验证规则可能产生的影响。
如果一个规则的执行成本过高，API 服务器会拒绝创建或更新操作，并返回一个错误信息。</p><p>运行时也使用类似的系统来观察解释器的行动。如果解释器执行了太多的指令，规则的执行将被停止，并且会产生一个错误。</p><p>每个 CustomResourceDefinition 也被允许有一定数量的资源来完成其所有验证规则的执行。
如果在创建时估计其规则的总和超过了这个限制，那么也会发生验证错误。</p><p>如果你只指定那些无论输入量有多大都要花费相同时间的规则，你不太可能遇到验证的资源预算问题。</p><p>例如，一个断言 <code>self.foo == 1</code> 的规则本身不存在因为资源预算组验证而导致被拒绝的风险。</p><p>但是，如果 <code>foo</code> 是一个字符串，而你定义了一个验证规则 <code>self.foo.contains("someString")</code>，
这个规则需要更长的时间来执行，取决于 <code>foo</code> 有多长。</p><p>另一个例子是如果 <code>foo</code> 是一个数组，而你指定了验证规则 <code>self.foo.all(x, x > 5)</code>。
如果没有给出 <code>foo</code> 的长度限制，成本系统总是假设最坏的情况，这将发生在任何可以被迭代的事物上（list、map 等）。</p><p>因此，通过 <code>maxItems</code>，<code>maxProperties</code> 和 <code>maxLength</code> 进行限制被认为是最佳实践，
以在验证规则中处理任何内容，以防止在成本估算期间验证错误。例如，给定具有一个规则的模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.all(x, x.contains(&#39;a string&#39;))&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>API 服务器以验证预算为由拒绝该规则，并显示错误：</p><pre tabindex=0><code>spec.validation.openAPIV3Schema.properties[spec].properties[foo].x-kubernetes-validations[0].rule: Forbidden: 
CEL rule exceeded budget by more than 100x (try simplifying the rule, or adding maxItems, maxProperties, and 
maxLength where arrays, maps, and strings are used)
</code></pre><p>这个拒绝会发生是因为 <code>self.all</code> 意味着对 <code>foo</code> 中的每一个字符串调用 <code>contains()</code>，
而这又会检查给定的字符串是否包含 <code>'a string'</code>。如果没有限制，这是一个非常昂贵的规则。</p><p>如果你不指定任何验证限制，这个规则的估计成本将超过每条规则的成本限制。
但如果你在适当的地方添加限制，该规则将被允许：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxItems</span>:<span style=color:#bbb> </span><span style=color:#666>25</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>maxLength</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.all(x, x.contains(&#39;a string&#39;))&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>成本评估系统除了考虑规则本身的估计成本外，还考虑到规则将被执行的次数。
例如，下面这个规则的估计成本与前面的例子相同（尽管该规则现在被定义在单个数组项上）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>maxItems</span>:<span style=color:#bbb> </span><span style=color:#666>25</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.contains(&#39;a string&#39;))&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>maxLength</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>如果在一个列表内部的一个列表有一个使用 <code>self.all</code> 的验证规则，那就会比具有相同规则的非嵌套列表的成本高得多。
一个在非嵌套列表中被允许的规则可能需要在两个嵌套列表中设置较低的限制才能被允许。
例如，即使没有设置限制，下面的规则也是允许的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.all(x, x == 5)&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>但是同样的规则在下面的模式中（添加了一个嵌套数组）产生了一个验证错误：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>x-kubernetes-validations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>rule</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;self.all(x, x == 5)&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>这是因为 <code>foo</code> 的每一项本身就是一个数组，而每一个子数组依次调用 <code>self.all</code>。
在使用验证规则的地方，尽可能避免嵌套的列表和字典。</p><h3 id=efaulting>设置默认值</h3><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>要使用设置默认值功能，你的 CustomResourceDefinition 必须使用 API 版本 <code>apiextensions.k8s.io/v1</code>。</div><p>设置默认值的功能允许在 <a href=#validation>OpenAPI v3 合法性检查模式定义</a>中设置默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># openAPIV3Schema 是用来检查定制对象的模式定义</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;5 0 * * *&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>maximum</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div><p>使用此 CRD 定义时，<code>cronSpec</code> 和 <code>replicas</code> 都会被设置默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span></code></pre></div><p>会生成：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;5 0 * * *&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>默认值设定的行为发生在定制对象上：</p><ul><li>在向 API 服务器发送的请求中，基于请求版本的设定设置默认值；</li><li>在从 etcd 读取对象时，使用存储版本来设置默认值；</li><li>在 Mutating 准入控制插件执行非空的补丁操作时，基于准入 Webhook 对象
版本设置默认值。</li></ul><p>从 etcd 中读取数据时所应用的默认值设置不会被写回到 etcd 中。
需要通过 API 执行更新请求才能将这种方式设置的默认值写回到 etcd。</p><p>默认值一定会被剪裁（除了 <code>metadata</code> 字段的默认值设置），且必须通过所提供的模式定义的检查。</p><p>针对 <code>x-kubernetes-embedded-resource: true</code> 节点（或者包含 <code>metadata</code> 字段的结构的默认值）
的 <code>metadata</code> 字段的默认值设置不会在 CustomResourceDefinition 创建时被剪裁，
而是在处理请求的字段剪裁阶段被删除。</p><h4 id=defaulting-and-nullable>设置默认值和字段是否可为空（Nullable）</h4><p>对于未设置其 nullable 标志的字段或者将该标志设置为 <code>false</code> 的字段，其空值（Null）
会在设置默认值之前被剪裁掉。如果对应字段存在默认值，则默认值会被赋予该字段。
当 <code>nullable</code> 被设置为 <code>true</code> 时，字段的空值会被保留，且不会在设置默认值时被覆盖。</p><p>例如，给定下面的 OpenAPI 模式定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>nullable</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;default&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>nullable</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>baz</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span></code></pre></div><p>像下面这样创建一个为 <code>foo</code>、<code>bar</code> 和 <code>baz</code> 设置空值的对象时：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>baz</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>其结果会是这样：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;default&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>其中的 <code>foo</code> 字段被剪裁掉并重新设置默认值，因为该字段是不可为空的。
<code>bar</code> 字段的 <code>nullable: true</code> 使得其能够保有其空值。
<code>baz</code> 字段则被完全剪裁掉，因为该字段是不可为空的，并且没有默认值设置。</p><h3 id=publish-validation-schema-in-openapi-v2>以 OpenAPI v2 形式发布合法性检查模式</h3><p>CustomResourceDefinition 的<a href=#specifying-a-structural-schema>结构化的</a>、
<a href=#field-pruning>启用了剪裁的</a> <a href=#validation>OpenAPI v3 合法性检查模式</a>会在
Kubernetes API 服务器上作为
<a href=/zh-cn/docs/concepts/overview/kubernetes-api/#openapi-and-swagger-definitions>OpenAPI v2 规约</a>的一部分发布出来。</p><p><a href=/zh-cn/docs/reference/kubectl/>kubectl</a> 命令行工具会基于所发布的模式定义来执行客户端的合法性检查
（<code>kubectl create</code> 和 <code>kubectl apply</code>），为定制资源的模式定义提供解释（<code>kubectl explain</code>）。
所发布的模式还可被用于其他目的，例如生成客户端或者生成文档。</p><p>OpenAPI v3 合法性检查模式定义会被转换为 OpenAPI v2 模式定义，并出现在
<a href=/zh-cn/docs/concepts/overview/kubernetes-api/#openapi-and-swagger-definitions>OpenAPI v2 规范</a>的
<code>definitions</code> 和 <code>paths</code> 字段中。</p><p>在转换过程中会发生以下修改，目的是保持与 1.13 版本以前的 kubectl 工具兼容。
这些修改可以避免 kubectl 过于严格，以至于拒绝它无法理解的 OpenAPI 模式定义。
转换过程不会更改 CRD 中定义的合法性检查模式定义，因此不会影响到
API 服务器中的<a href=#validation>合法性检查</a>。</p><ol><li><p>以下字段会被移除，因为它们在 OpenAPI v2 中不支持（在将来版本中将使用 OpenAPI v3，
因而不会有这些限制）</p><ul><li>字段 <code>allOf</code>、<code>anyOf</code>、<code>oneOf</code> 和 <code>not</code> 会被删除</li></ul></li><li><p>如果设置了 <code>nullable: true</code>，我们会丢弃 <code>type</code>、<code>nullable</code>、<code>items</code> 和 <code>properties</code>
OpenAPI v2 无法表达 Nullable。为了避免 kubectl 拒绝正常的对象，这一转换是必要的。</p></li></ol><h3 id=additional-printer-columns>额外的打印列</h3><p><code>kubectl</code> 工具依赖服务器端的输出格式化。你的集群的 API 服务器决定 <code>kubectl get</code> 命令要显示的列有哪些。
你可以为 CustomResourceDefinition 定制这些要打印的列。
下面的例子添加了 <code>Spec</code>、<code>Replicas</code> 和 <code>Age</code> 列：</p><p>将此 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code> 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>additionalPrinterColumns</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Spec<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>The cron spec defining the interval a CronJob is run<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.spec.cronSpec<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Replicas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>The number of jobs launched by the CronJob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.spec.replicas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Age<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>date<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.metadata.creationTimestamp<span style=color:#bbb>
</span></span></span></code></pre></div><p>创建 CustomResourceDefinition：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>使用前文中的 <code>my-crontab.yaml</code> 创建一个实例。</p><p>启用服务器端打印输出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get crontab my-new-cron-object
</span></span></code></pre></div><p>注意输出中的 <code>NAME</code>、<code>SPEC</code>、<code>REPLICAS</code> 和 <code>AGE</code> 列：</p><pre tabindex=0><code>NAME                 SPEC        REPLICAS   AGE
my-new-cron-object   * * * * *   1          7s
</code></pre><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p><code>NAME</code> 列是隐含的，不需要在 CustomResourceDefinition 中定义。</div><h4 id=priority>优先级</h4><p>每个列都包含一个 <code>priority</code>（优先级）字段。当前，优先级用来区分标准视图（Standard
View）和宽视图（Wide View）（使用 <code>-o wide</code> 标志）中显示的列：</p><ul><li>优先级为 <code>0</code> 的列会在标准视图中显示。</li><li>优先级大于 <code>0</code> 的列只会在宽视图中显示。</li></ul><h4 id=type>类型</h4><p>列的 <code>type</code> 字段可以是以下值之一
（比较 <a href=https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#dataTypes>OpenAPI v3 数据类型</a>）：</p><ul><li><code>integer</code> – 非浮点数字</li><li><code>number</code> – 浮点数字</li><li><code>string</code> – 字符串</li><li><code>boolean</code> – <code>true</code> 或 <code>false</code></li><li><code>date</code> – 显示为以自此时间戳以来经过的时长</li></ul><p>如果定制资源中的值与列中指定的类型不匹配，该值会被忽略。
你可以通过定制资源的合法性检查来确保取值类型是正确的。</p><h4 id=format>格式</h4><p>列的 <code>format</code> 字段可以是以下值之一：</p><ul><li><code>int32</code></li><li><code>int64</code></li><li><code>float</code></li><li><code>double</code></li><li><code>byte</code></li><li><code>date</code></li><li><code>date-time</code></li><li><code>password</code></li></ul><p>列的 <code>format</code> 字段控制 <code>kubectl</code> 打印对应取值时采用的风格。</p><h3 id=subresources>子资源</h3><p>定制资源支持 <code>/status</code> 和 <code>/scale</code> 子资源。</p><p>通过在 CustomResourceDefinition 中定义 <code>status</code> 和 <code>scale</code>，
可以有选择地启用这些子资源。</p><h4 id=status-subresource>Status 子资源</h4><p>当启用了 status 子资源时，对应定制资源的 <code>/status</code> 子资源会被暴露出来。</p><ul><li><p>status 和 spec 内容分别用定制资源内的 <code>.status</code> 和 <code>.spec</code> JSON 路径来表达；</p></li><li><p>对 <code>/status</code> 子资源的 <code>PUT</code> 请求要求使用定制资源对象作为其输入，但会忽略
status 之外的所有内容。</p></li><li><p>对 <code>/status</code> 子资源的 <code>PUT</code> 请求仅对定制资源的 status 内容进行合法性检查。</p></li><li><p>对定制资源的 <code>PUT</code>、<code>POST</code>、<code>PATCH</code> 请求会忽略 status 内容的改变。</p></li><li><p>对所有变更请求，除非改变是针对 <code>.metadata</code> 或 <code>.status</code>，<code>.metadata.generation</code>
的取值都会增加。</p></li><li><p>在 CRD OpenAPI 合法性检查模式定义的根节点，只允许存在以下结构：</p><ul><li><code>description</code></li><li><code>example</code></li><li><code>exclusiveMaximum</code></li><li><code>exclusiveMinimum</code></li><li><code>externalDocs</code></li><li><code>format</code></li><li><code>items</code></li><li><code>maximum</code></li><li><code>maxItems</code></li><li><code>maxLength</code></li><li><code>minimum</code></li><li><code>minItems</code></li><li><code>minLength</code></li><li><code>multipleOf</code></li><li><code>pattern</code></li><li><code>properties</code></li><li><code>required</code></li><li><code>title</code></li><li><code>type</code></li><li><code>uniqueItems</code></li></ul></li></ul><h4 id=scale-subresource>Scale 子资源</h4><p>当启用了 scale 子资源时，定制资源的 <code>/scale</code> 子资源就被暴露出来。
针对 <code>/scale</code> 所发送的对象是 <code>autoscaling/v1.Scale</code>。</p><p>为了启用 scale 子资源，CustomResourceDefinition 定义了以下字段：</p><ul><li><p><code>specReplicasPath</code> 指定定制资源内与 <code>scale.spec.replicas</code> 对应的 JSON 路径。</p><ul><li>此字段为必需值。</li><li>只可以使用 <code>.spec</code> 下的 JSON 路径，只可使用带句点的路径。</li><li>如果定制资源的 <code>specReplicasPath</code> 下没有取值，则针对 <code>/scale</code> 子资源执行 GET
操作时会返回错误。</li></ul></li></ul><ul><li><p><code>statusReplicasPath</code> 指定定制资源内与 <code>scale.status.replicas</code> 对应的 JSON 路径。</p><ul><li>此字段为必需值。</li><li>只可以使用 <code>.status</code> 下的 JSON 路径，只可使用带句点的路径。</li><li>如果定制资源的 <code>statusReplicasPath</code> 下没有取值，则针对 <code>/scale</code>
子资源的副本个数状态值默认为 0。</li></ul></li></ul><ul><li><p><code>labelSelectorPath</code> 指定定制资源内与 <code>Scale.Status.Selector</code> 对应的 JSON 路径。</p><ul><li>此字段为可选值。</li><li>此字段必须设置才能使用 HPA。</li><li>只可以使用 <code>.status</code> 或 <code>.spec</code> 下的 JSON 路径，只可使用带句点的路径。</li><li>如果定制资源的 <code>labelSelectorPath</code> 下没有取值，则针对 <code>/scale</code>
子资源的选择算符状态值默认为空字符串。</li><li>此 JSON 路径所指向的字段必须是一个字符串字段（而不是复合的选择算符结构），
其中包含标签选择算符串行化的字符串形式。</li></ul></li></ul><p>在下面的例子中，<code>status</code> 和 <code>scale</code> 子资源都被启用。</p><p>将此 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code> 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>labelSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># subresources 描述定制资源的子资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>subresources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># status 启用 status 子资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># scale 启用 scale 子资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>scale</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># specReplicasPath 定义定制资源中对应 scale.spec.replicas 的 JSON 路径</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>specReplicasPath</span>:<span style=color:#bbb> </span>.spec.replicas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># statusReplicasPath 定义定制资源中对应 scale.status.replicas 的 JSON 路径 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>statusReplicasPath</span>:<span style=color:#bbb> </span>.status.replicas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># labelSelectorPath  定义定制资源中对应 scale.status.selector 的 JSON 路径 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>labelSelectorPath</span>:<span style=color:#bbb> </span>.status.labelSelector<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div><p>之后创建此 CustomResourceDefinition：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>CustomResourceDefinition 对象创建完毕之后，你可以创建定制对象，。</p><p>如果你将下面的 YAML 保存到 <code>my-crontab.yaml</code> 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>并创建定制对象：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>那么会创建新的、命名空间作用域的 RESTful API 端点：</p><pre tabindex=0><code class=language-none data-lang=none>/apis/stable.example.com/v1/namespaces/*/crontabs/status
</code></pre><p>和</p><pre tabindex=0><code class=language-none data-lang=none>/apis/stable.example.com/v1/namespaces/*/crontabs/scale
</code></pre><p>定制资源可以使用 <code>kubectl scale</code> 命令来扩缩其规模。
例如下面的命令将前面创建的定制资源的 <code>.spec.replicas</code> 设置为 5：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl scale --replicas<span style=color:#666>=</span><span style=color:#666>5</span> crontabs/my-new-cron-object
</span></span><span style=display:flex><span>crontabs <span style=color:#b44>&#34;my-new-cron-object&#34;</span> scaled
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get crontabs my-new-cron-object -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.spec.replicas}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#666>5</span>
</span></span></code></pre></div><p>你可以使用 <a href=/zh-cn/docs/tasks/run-application/configure-pdb/>PodDisruptionBudget</a>
来保护启用了 scale 子资源的定制资源。</p><h3 id=categories>分类</h3><p>分类（Categories）是定制资源所归属的分组资源列表（例如，<code>all</code>）。
你可以使用 <code>kubectl get &lt;分类名称></code> 来列举属于某分类的所有资源。</p><p>下面的示例在 CustomResourceDefinition 中将 <code>all</code> 添加到分类列表中，
并展示了如何使用 <code>kubectl get all</code> 来输出定制资源：</p><p>将下面的 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code> 文件中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># categories 是定制资源所归属的分类资源列表</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>categories</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- all<span style=color:#bbb>
</span></span></span></code></pre></div><p>之后创建此 CRD：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f resourcedefinition.yaml
</span></span></code></pre></div><p>创建了 CustomResourceDefinition 对象之后，你可以创建定制对象。</p><p>将下面的 YAML 保存到 <code>my-crontab.yaml</code> 中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></span></span></code></pre></div><p>并创建定制对象：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-crontab.yaml
</span></span></code></pre></div><p>你可以在使用 <code>kubectl get</code> 时指定分类：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get all
</span></span></code></pre></div><p>输出中将包含类别为 <code>CronTab</code> 的定制资源：</p><pre tabindex=0><code class=language-none data-lang=none>NAME                          AGE
crontabs/my-new-cron-object   3s
</code></pre><h2 id=接下来>接下来</h2><ul><li>阅读了解<a href=/zh-cn/docs/concepts/extend-kubernetes/api-extension/custom-resources/>定制资源</a></li><li>参阅 <a href=/docs/reference/generated/kubernetes-api/v1.25/#customresourcedefinition-v1-apiextensions-k8s-io>CustomResourceDefinition</a></li><li>参阅支持 CustomResourceDefinition 的<a href=/zh-cn/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/>多个版本</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7d2e2400f208b1637530752794e5a3bd>2 - CustomResourceDefinition 的版本</h1><p>本页介绍如何添加版本信息到
<a href=/zh-cn/docs/reference/kubernetes-api/extend-resources/custom-resource-definition-v1/>CustomResourceDefinitions</a>。
目的是标明 CustomResourceDefinitions 的稳定级别或者服务于 API 升级。
API 升级时需要在不同 API 表示形式之间进行转换。
本页还描述如何将对象从一个版本升级到另一个版本。</p><h2 id=准备开始>准备开始</h2><p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。
建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。
如果你还没有集群，你可以通过 <a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>Minikube</a>
构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p><ul><li><a href=https://killercoda.com/playgrounds/scenario/kubernetes>Killercoda</a></li><li><a href=http://labs.play-with-k8s.com/>玩转 Kubernetes</a></li></ul><p>你应该对<a href=/zh-cn/docs/concepts/extend-kubernetes/api-extension/custom-resources/>定制资源</a>有一些初步了解。</p>你的 Kubernetes 服务器版本必须不低于版本 v1.16.
要获知版本信息，请输入 <code>kubectl version</code>.<h2 id=overview>概览</h2><p>CustomResourceDefinition API 提供了引入和升级 CustomResourceDefinition 新版本所用的工作流程。</p><p>创建 CustomResourceDefinition 时，会在 CustomResourceDefinition <code>spec.versions</code>
列表设置适当的稳定级别和版本号。例如，<code>v1beta1</code> 表示第一个版本尚未稳定。
所有定制资源对象将首先用这个版本保存。</p><p>创建 CustomResourceDefinition 后，客户端可以开始使用 <code>v1beta1</code> API。</p><p>稍后可能需要添加新版本，例如 <code>v1</code>。</p><p>添加新版本：</p><ol><li>选择一种转化策略。由于定制资源对象需要能够两种版本都可用，
这意味着它们有时会以与存储版本不同的版本来提供服务。为了能够做到这一点，
有时必须在它们存储的版本和提供的版本之间进行转换。如果转换涉及模式变更，
并且需要自定义逻辑，则应该使用 Webhook 来完成。如果没有模式变更，
则可使用默认的 <code>None</code> 转换策略，为不同版本提供服务时只有 <code>apiVersion</code> 字段会被改变。</li><li>如果使用转换 Webhook，请创建并部署转换 Webhook。更多详细信息请参见
<a href=#webhook-conversion>Webhook 转换</a>。</li><li>更新 CustomResourceDefinition，将新版本设置为 <code>served：true</code>，加入到
<code>spec.versions</code> 列表。另外，还要设置 <code>spec.conversion</code> 字段为所选的转换策略。
如果使用转换 Webhook，请配置 <code>spec.conversion.webhookClientConfig</code> 来调用 Webhook。</li></ol><p>添加新版本后，客户端可以逐步迁移到新版本。
让某些客户使用旧版本的同时支持其他人使用新版本是相当安全的。</p><p>将存储的对象迁移到新版本：</p><ol><li><p>请参阅<a href=#upgrade-existing-objects-to-a-new-stored-version>将现有对象升级到新的存储版本</a>节。</p><p>对于客户来说，在将对象升级到新的存储版本之前、期间和之后使用旧版本和新版本都是安全的。</p></li></ol><p>删除旧版本：</p><ol><li>确保所有客户端都已完全迁移到新版本。
可以查看 kube-apiserver 的日志以识别仍通过旧版本进行访问的所有客户端。</li><li>在 <code>spec.versions</code> 列表中将旧版本的 <code>served</code> 设置为 <code>false</code>。
如果仍有客户端意外地使用旧版本，他们可能开始会报告采用旧版本尝试访问定制资源的错误消息。
如果发生这种情况，请将旧版本的 <code>served：true</code> 恢复，然后迁移余下的客户端使用新版本，然后重复此步骤。</li><li>确保已完成<a href=#upgrade-existing-objects-to-a-new-stored-version>将现有对象升级到新存储版本</a>的步骤。<ol><li>在 CustomResourceDefinition 的 <code>spec.versions</code> 列表中，确认新版本的
<code>storage</code> 已被设置为 <code>true</code>。</li><li>确认旧版本不在 CustomResourceDefinition <code>status.storedVersions</code> 中。</li></ol></li><li>从 CustomResourceDefinition <code>spec.versions</code> 列表中删除旧版本。</li><li>在转换 Webhooks 中放弃对旧版本的转换支持。</li></ol><h2 id=specify-multiple-versions>指定多个版本</h2><p>CustomResourceDefinition API 的 <code>versions</code> 字段可用于支持你所开发的定制资源的多个版本。
版本可以具有不同的模式，并且转换 Webhook 可以在多个版本之间转换定制资源。
在适当的情况下，Webhook 转换应遵循
<a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md>Kubernetes API 约定</a>。
具体来说，请查阅
<a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api_changes.md>API 变更文档</a>
以获取一些有用的问题和建议。</p><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>在 <code>apiextensions.k8s.io/v1beta1</code> 版本中曾经有一个 <code>version</code> 字段，
名字不叫做 <code>versions</code>。该 <code>version</code> 字段已经被废弃，成为可选项。
不过如果该字段不是空，则必须与 <code>versions</code> 字段中的第一个条目匹配。</div><p>下面的示例显示了两个版本的 CustomResourceDefinition。
第一个例子中假设所有的版本使用相同的模式而它们之间没有转换。
YAML 中的注释提供了更多背景信息。</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-1 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-1-0 role=tab aria-controls=customresourcedefinition-versioning-example-1-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-1-1 role=tab aria-controls=customresourcedefinition-versioning-example-1-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-example-1><div id=customresourcedefinition-versioning-example-1-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-1-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name 必须匹配后面 spec 中的字段，且使用格式 &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名，用于 REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 此 CustomResourceDefinition 所支持的版本列表</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 每个 version 可以通过 served 标志启用或禁止</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 有且只能有一个 version 必须被标记为存储版本</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># schema 是必需字段</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># conversion 节是 Kubernetes 1.13+ 版本引入的，其默认值为无转换，即 strategy 子字段设置为 None。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># None 转换假定所有版本采用相同的模式定义，仅仅将定制资源的 apiVersion 设置为合适的值.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，用于在命令行接口和显示时作为其别名</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是驼峰编码（CamelCased）的单数形式，用于资源清单中</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行接口中使用更短的字符串来匹配你的资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-example-1-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-1-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># 在 v1.16 中被弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name 必须匹配后面 spec 中的字段，且使用格式 &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名，用于 REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 此 CustomResourceDefinition 所支持的版本列表</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 每个 version 可以通过 served 标志启用或禁止</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 有且只能有一个 version 必须被标记为存储版本</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>validation</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># conversion 节是 Kubernetes 1.13+ 版本引入的，其默认值为无转换，即 strategy 子字段设置为 None。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># None 转换假定所有版本采用相同的模式定义，仅仅将定制资源的 apiVersion 设置为合适的值.</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，用于在命令行接口和显示时作为其别名</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是大驼峰编码（PascalCased）的单数形式，用于资源清单中</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行接口中使用更短的字符串来匹配你的资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>你可以将 CustomResourceDefinition 存储在 YAML 文件中，然后使用
<code>kubectl apply</code> 来创建它。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-versioned-crontab.yaml
</span></span></code></pre></div><p>在创建之后，API 服务器开始在 HTTP REST 端点上为每个已启用的版本提供服务。
在上面的示例中，API 版本可以在 <code>/apis/example.com/v1beta1</code> 和
<code>/apis/example.com/v1</code> 处获得。</p><h3 id=version-priority>版本优先级</h3><p>不考虑 CustomResourceDefinition 中版本被定义的顺序，kubectl
使用具有最高优先级的版本作为访问对象的默认版本。
优先级是通过解析 <strong>name</strong> 字段来确定版本号、稳定性（GA、Beta 或 Alpha）
以及该稳定性级别内的序列。</p><p>用于对版本进行排序的算法在设计上与 Kubernetes 项目对 Kubernetes 版本进行排序的方式相同。
版本以 <code>v</code> 开头跟一个数字，一个可选的 <code>beta</code> 或者 <code>alpha</code> 和一个可选的附加数字作为版本信息。
从广义上讲，版本字符串可能看起来像 <code>v2</code> 或者 <code>v2beta1</code>。
使用以下算法对版本进行排序：</p><ul><li>遵循 Kubernetes 版本模式的条目在不符合条件的条目之前进行排序。</li><li>对于遵循 Kubernetes 版本模式的条目，版本字符串的数字部分从最大到最小排序。</li><li>如果第一个数字后面有字符串 <code>beta</code> 或 <code>alpha</code>，它们首先按去掉 <code>beta</code> 或
<code>alpha</code> 之后的版本号排序（相当于 GA 版本），之后按 <code>beta</code> 先、<code>alpha</code> 后的顺序排序，</li><li>如果 <code>beta</code> 或 <code>alpha</code> 之后还有另一个数字，那么也会针对这些数字从大到小排序。</li><li>不符合上述格式的字符串按字母顺序排序，数字部分不经过特殊处理。
请注意，在下面的示例中，<code>foo1</code> 排在 <code>foo10</code> 之前。
这与遵循 Kubernetes 版本模式的条目的数字部分排序不同。</li></ul><p>如果查看以下版本排序列表，这些规则就容易懂了：</p><pre tabindex=0><code class=language-none data-lang=none>- v10
- v2
- v1
- v11beta2
- v10beta3
- v3beta1
- v12alpha1
- v11alpha2
- foo1
- foo10
</code></pre><p>对于<a href=#specify-multiple-versions>指定多个版本</a>中的示例，版本排序顺序为
<code>v1</code>，后跟着 <code>v1beta1</code>。
这导致了 kubectl 命令使用 <code>v1</code> 作为默认版本，除非所提供的对象指定了版本。</p><h3 id=version-deprecation>版本废弃</h3><div style=margin-top:10px;margin-bottom:10px><b>特性状态：</b> <code>Kubernetes v1.19 [stable]</code></div><p>从 v1.19 开始，CustomResourceDefinition 可以指示其定义的资源的特定版本已废弃。
当该资源的已废弃版本发出 API 请求时，会在 API 响应中以报头的形式返回警告消息。
如果需要，可以自定义每个不推荐使用的资源版本的警告消息。</p><p>定制的警告消息应该标明废弃的 API 组、版本和类别（kind），
并且应该标明应该使用（如果有的话）哪个 API 组、版本和类别作为替代。</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-deprecated role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-deprecated-0 role=tab aria-controls=customresourcedefinition-versioning-deprecated-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-deprecated-1 role=tab aria-controls=customresourcedefinition-versioning-deprecated-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-deprecated><div id=customresourcedefinition-versioning-deprecated-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-deprecated-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1alpha1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明此定制资源的 v1alpha1 版本已被弃用。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到警告消息头。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性设置用来覆盖返回给发送 v1alpha1 API 请求的客户端的默认警告信息。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecationWarning</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明该定制资源的 v1beta1 版本已被弃用。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到警告消息头。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 针对此版本的请求所返回的是默认的警告消息。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-deprecated-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-deprecated-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># 在 v1.16 中弃用以推荐使用  apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>validation</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1alpha1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明此定制资源的 v1alpha1 版本已被弃用。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到警告消息头。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性设置用来覆盖返回给发送 v1alpha1 API 请求的客户端的默认警告信息。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecationWarning</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明该定制资源的 v1beta1 版本已被弃用。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到警告消息头。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 针对此版本的请求所返回的是默认的警告消息。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h3 id=version-removal>版本删除</h3><p>在为所有提供旧版本自定义资源的集群将现有数据迁移到新 API 版本，并且从 CustomResourceDefinition 的
<code>status.storedVersions</code> 中删除旧版本之前，无法从 CustomResourceDefinition 清单文件中删除旧 API 版本。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明该自定义资源的 v1beta1 版本已不再提供。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到未找到的错误。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 新提供的版本应该设置为存储版本。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=webhook-conversion>Webhook 转换</h2><div style=margin-top:10px;margin-bottom:10px><b>特性状态：</b> <code>Kubernetes v1.16 [stable]</code></div><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>Webhook 转换在 Kubernetes 1.13 版本作为 Alpha 功能引入，在 Kubernetes 1.15 版本中成为 Beta 功能。
要使用此功能，应启用 <code>CustomResourceWebhookConversion</code> 特性。
在大多数集群上，这类 Beta 特性应该是自动启用的。
请参阅<a href=/zh-cn/docs/reference/command-line-tools-reference/feature-gates/>特性门控</a>文档以获得更多信息。</div><p>上面的例子在版本之间有一个 None 转换，它只在转换时设置 <code>apiVersion</code> 字段而不改变对象的其余部分。
API 服务器还支持在需要转换时调用外部服务的 webhook 转换。例如：</p><ul><li>定制资源的请求版本与其存储版本不同。</li><li>使用某版本创建了 Watch 请求，但所更改对象以另一版本存储。</li><li>定制资源的 PUT 请求所针对版本与存储版本不同。</li></ul><p>为了涵盖所有这些情况并优化 API 服务器所作的转换，转换请求可以包含多个对象，
以便减少外部调用。Webhook 应该独立执行各个转换。</p><h3 id=write-a-conversion-webhook-server>编写一个转换 Webhook 服务器</h3><p>请参考<a href=https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/main.go>定制资源转换 Webhook 服务器</a>的实现；
该实现在 Kubernetes e2e 测试中得到验证。
Webhook 处理由 API 服务器发送的 <code>ConversionReview</code> 请求，并在
<code>ConversionResponse</code> 中封装发回转换结果。
请注意，请求包含需要独立转换的定制资源列表，这些对象在被转换之后不能改变其在列表中的顺序。
该示例服务器的组织方式使其可以复用于其他转换。大多数常见代码都位于
<a href=https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/converter/framework.go>framework 文件</a>中，
只留下<a href=https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/converter/example_converter.go#L29-L80>一个函数</a>用于实现不同的转换。</p><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>转换 Webhook 服务器示例中将 <code>ClientAuth</code>
字段设置为<a href=https://github.com/kubernetes/kubernetes/tree/v1.25.3/test/images/agnhost/crd-conversion-webhook/config.go#L47-L48>空</a>，
默认为 <code>NoClientCert</code>。
这意味着 webhook 服务器没有验证客户端（也就是 API 服务器）的身份。
如果你需要双向 TLS 或者其他方式来验证客户端，
请参阅如何<a href=/zh-cn/docs/reference/access-authn-authz/extensible-admission-controllers/#authenticate-apiservers>验证 API 服务</a>。</div><h4 id=被允许的变更>被允许的变更</h4><p>转换 Webhook 不可以更改被转换对象的 <code>metadata</code> 中除 <code>labels</code> 和 <code>annotations</code>
之外的任何属性。
尝试更改 <code>name</code>、<code>UID</code> 和 <code>namespace</code> 时都会导致引起转换的请求失败。
所有其他变更都被忽略。</p><h3 id=deploy-the-conversion-webhook-service>部署转换 Webhook 服务</h3><p>用于部署转换 Webhook
的文档与<a href=/zh-cn/docs/reference/access-authn-authz/extensible-admission-controllers/#deploy_the_admission_webhook_service>准入 Webhook 服务示例</a>相同。
这里的假设是转换 Webhook 服务器被部署为 <code>default</code> 名字空间中名为
<code>example-conversion-webhook-server</code> 的服务，并在路径 <code>/crdconvert</code>
上处理请求。</p><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>当 Webhook 服务器作为一个服务被部署到 Kubernetes 集群中时，它必须通过端口 443
公开其服务（服务器本身可以使用任意端口，但是服务对象应该将它映射到端口 443）。
如果为服务器使用不同的端口，则 API 服务器和 Webhook 服务器之间的通信可能会失败。</div><h3 id=configure-crd-to-use-conversion-webhooks>配置 CustomResourceDefinition 以使用转换 Webhook</h3><p>通过修改 <code>spec</code> 中的 <code>conversion</code> 部分，可以扩展 <code>None</code> 转换示例来使用转换 Webhook。</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-2 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-2-0 role=tab aria-controls=customresourcedefinition-versioning-example-2-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-2-1 role=tab aria-controls=customresourcedefinition-versioning-example-2-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-example-2><div id=customresourcedefinition-versioning-example-2-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-2-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name 必须匹配后面 spec 中的字段，且使用格式 &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名，用于 REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 此 CustomResourceDefinition 所支持的版本列表</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 每个 version 可以通过 served 标志启用或禁止</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 有且只能有一个 version 必须被标记为存储版本</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 当不存在顶级模式定义时，每个版本（version）可以定义其自身的模式</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Webhook strategy 告诉 API 服务器调用外部 Webhook 来完成定制资源之间的转换</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 当 strategy 为 &#34;Webhook&#34; 时，webhook 属性是必需的，该属性配置将被 API 服务器调用的 Webhook 端点</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># conversionReviewVersions 标明 Webhook 所能理解或偏好使用的</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ConversionReview 对象版本。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># API 服务器所能理解的列表中的第一个版本会被发送到 Webhook</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Webhook 必须按所接收到的版本响应一个 ConversionReview 对象</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-conversion-webhook-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/crdconvert<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，用于在命令行接口和显示时作为其别名</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是驼峰编码（CamelCased）的单数形式，用于资源清单中</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行接口中使用更短的字符串来匹配你的资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-example-2-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-2-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># 在 v1.16 中被弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name 必须匹配后面 spec 中的字段，且使用格式 &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名，用于 REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 裁剪掉下面的 OpenAPI 模式中未曾定义的对象字段</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>preserveUnknownFields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 此 CustomResourceDefinition 所支持的版本列表</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 每个 version 可以通过 served 标志启用或禁止</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 有且只能有一个 version 必须被标记为存储版本</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 当不存在顶级模式定义时，每个版本（version）可以定义其自身的模式</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Webhook strategy 告诉 API 服务器调用外部 Webhook 来完成定制资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 当 strategy 为 &#34;Webhook&#34; 时，webhookClientConfig 属性是必需的</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 该属性配置将被 API 服务器调用的 Webhook 端点</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-conversion-webhook-server<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/crdconvert<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，用于在命令行接口和显示时作为其别名</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是驼峰编码（CamelCased）的单数形式，用于资源清单中</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行接口中使用更短的字符串来匹配你的资源</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>你可以将 CustomResourceDefinition 保存在 YAML 文件中，然后使用
<code>kubectl apply</code> 来应用它。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f my-versioned-crontab-with-conversion.yaml
</span></span></code></pre></div><p>在应用新更改之前，请确保转换服务器已启动并正在运行。</p><h3 id=contacting-the-webhook>调用 Webhook</h3><p>API 服务器一旦确定请求应发送到转换 Webhook，它需要知道如何调用 Webhook。
这是在 <code>webhookClientConfig</code> 中指定的 Webhook 配置。</p><p>转换 Webhook 可以通过 URL 或服务引用来调用，并且可以选择包含自定义 CA 包，
以用于验证 TLS 连接。</p><h3 id=url>URL</h3><p><code>url</code> 以标准 URL 形式给出 Webhook 的位置（<code>scheme://host:port/path</code>）。
<code>host</code> 不应引用集群中运行的服务，而应通过指定 <code>service</code> 字段来提供服务引用。
在某些 API 服务器中，<code>host</code> 可以通过外部 DNS 进行解析（即
<code>kube-apiserver</code> 无法解析集群内 DNS，那样会违反分层规则）。
<code>host</code> 也可以是 IP 地址。</p><p>请注意，除非你非常小心地在所有运行着可能调用 Webhook 的 API 服务器的主机上运行此 Webhook，
否则将 <code>localhost</code> 或 <code>127.0.0.1</code> 用作 <code>host</code> 是风险很大的。
这样的安装可能是不可移植的，或者不容易在一个新的集群中运行。</p><p>HTTP 协议必须为 <code>https</code>；URL 必须以 <code>https://</code> 开头。</p><p>尝试使用用户或基本身份验证（例如，使用 <code>user:password@</code>）是不允许的。
URL 片段（<code>#...</code>）和查询参数（<code>?...</code>）也是不允许的。</p><p>下面是为调用 URL 来执行转换 Webhook 的示例，其中期望使用系统信任根来验证
TLS 证书，因此未指定 caBundle：</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-3 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-3-0 role=tab aria-controls=customresourcedefinition-versioning-example-3-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-3-1 role=tab aria-controls=customresourcedefinition-versioning-example-3-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-example-3><div id=customresourcedefinition-versioning-example-3-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-3-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;https://my-webhook.example.com:9443/my-webhook-path&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-example-3-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-3-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># 在 v1.16 中已弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;https://my-webhook.example.com:9443/my-webhook-path&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h3 id=service-reference>服务引用</h3><p><code>webhookClientConfig</code> 内部的 <code>service</code> 段是对转换 Webhook 服务的引用。
如果 Webhook 在集群中运行，则应使用 <code>service</code> 而不是 <code>url</code>。
服务的名字空间和名称是必需的。端口是可选的，默认为 443。
路径是可选的，默认为<code>/</code>。</p><p>下面配置中，服务配置为在端口 <code>1234</code>、子路径 <code>/my-path</code> 上被调用。
例子中针对 ServerName <code>my-service-name.my-service-namespace.svc</code>，
使用自定义 CA 包验证 TLS 连接。</p><ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-4 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-4-0 role=tab aria-controls=customresourcedefinition-versioning-example-4-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-4-1 role=tab aria-controls=customresourcedefinition-versioning-example-4-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=customresourcedefinition-versioning-example-4><div id=customresourcedefinition-versioning-example-4-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-4-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-service-namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service-name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/my-path<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>1234</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=customresourcedefinition-versioning-example-4-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-4-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic>#  v1.16 中被弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-service-namespace<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service-name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/my-path<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>1234</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h2 id=webhook-request-and-response>Webhook 请求和响应</h2><h3 id=request>请求</h3><p>向 Webhook 发起请求的动词是 POST，请求的 <code>Content-Type</code> 为 <code>application/json</code>。
请求的主题为 JSON 序列化形式的
apiextensions.k8s.io API 组的 ConversionReview API 对象。</p><p>Webhook 可以在其 CustomResourceDefinition 中使用 <code>conversionReviewVersions</code>
字段设置它们接受的 <code>ConversionReview</code> 对象的版本：</p><ul class="nav nav-tabs" id=conversionreviewversions role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreviewversions-0 role=tab aria-controls=conversionreviewversions-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreviewversions-1 role=tab aria-controls=conversionreviewversions-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=conversionreviewversions><div id=conversionreviewversions-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreviewversions-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><p>创建 <code>apiextensions.k8s.io/v1</code> 版本的自定义资源定义时，
<code>conversionReviewVersions</code> 是必填字段。
Webhook 要求支持至少一个 <code>ConversionReview</code> 当前和以前的 API 服务器可以理解的版本。</p></div><div id=conversionreviewversions-1 class=tab-pane role=tabpanel aria-labelledby=conversionreviewversions-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># v1.16 已弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></span></span></code></pre></div><p>创建 apiextensions.k8s.io/v1beta1 定制资源定义时若未指定
<code>conversionReviewVersions</code>，则默认值为 v1beta1。</p></div></div><p>API 服务器将 <code>conversionReviewVersions</code> 列表中他们所支持的第一个
<code>ConversionReview</code> 资源版本发送给 Webhook。
如果列表中的版本都不被 API 服务器支持，则无法创建自定义资源定义。
如果某 API 服务器遇到之前创建的转换 Webhook 配置，并且该配置不支持
API 服务器知道如何发送的任何 <code>ConversionReview</code> 版本，调用 Webhook
的尝试会失败。</p><p>下面的示例显示了包含在 <code>ConversionReview</code> 对象中的数据，
该请求意在将 <code>CronTab</code> 对象转换为 <code>example.com/v1</code>：</p><ul class="nav nav-tabs" id=conversionreview-request role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-request-0 role=tab aria-controls=conversionreview-request-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-request-1 role=tab aria-controls=conversionreview-request-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=conversionreview-request><div id=conversionreview-request-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-request-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;request&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 用来唯一标识此转换调用的随机 UID</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 对象要转换到的目标 API 组和版本</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;desiredAPIVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 要转换的对象列表，其中可能包含一个或多个对象，版本可能相同也可能不同</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;objects&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;local-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;hostPort&#34;: </span><span style=color:#b44>&#34;localhost:1234&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;remote-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;hostPort&#34;: </span><span style=color:#b44>&#34;example.com:2345&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=conversionreview-request-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-request-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># v1.16 中已废弃以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;request&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 用来唯一标识此转换调用的随机 UID</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 对象要转换到的目标 API 组和版本</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;desiredAPIVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 要转换的对象列表，其中可能包含一个或多个对象，版本可能相同也可能不同</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;objects&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;local-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;hostPort&#34;: </span><span style=color:#b44>&#34;localhost:1234&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;remote-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;hostPort&#34;: </span><span style=color:#b44>&#34;example.com:2345&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h3 id=response>响应</h3><p>Webhook 响应包含 200 HTTP 状态代码、<code>Content-Type: application/json</code>，
在主体中包含 JSON 序列化形式的数据，在 <code>response</code> 节中给出
<code>ConversionReview</code> 对象（与发送的版本相同）。</p><p>如果转换成功，则 Webhook 应该返回包含以下字段的 <code>response</code> 节：</p><ul><li><code>uid</code>，从发送到 webhook 的 <code>request.uid</code> 复制而来</li><li><code>result</code>，设置为 <code>{"status":"Success"}}</code></li><li><code>convertedObjects</code>，包含来自 <code>request.objects</code> 的所有对象，均已转换为
<code>request.desiredVersion</code></li></ul><p>Webhook 的最简单成功响应示例：</p><ul class="nav nav-tabs" id=conversionreview-response-success role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-response-success-0 role=tab aria-controls=conversionreview-response-success-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-response-success-1 role=tab aria-controls=conversionreview-response-success-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=conversionreview-response-success><div id=conversionreview-response-success-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-response-success-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;response&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 必须与 &lt;request.uid&gt; 匹配</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;result&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;status&#34;: </span><span style=color:#b44>&#34;Success&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 这里的对象必须与 request.objects 中的对象顺序相同并且其 apiVersion 被设置为 &lt;request.desiredAPIVersion&gt;。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind、metadata.uid、metadata.name 和 metadata.namespace 等字段都不可被 Webhook 修改。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Webhook 可以更改 metadata.labels 和 metadata.annotations 字段值。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Webhook 对 metadata 中其他字段的更改都会被忽略</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;convertedObjects&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;local-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;host&#34;: </span><span style=color:#b44>&#34;localhost&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;port&#34;: </span><span style=color:#b44>&#34;1234&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;remote-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;host&#34;: </span><span style=color:#b44>&#34;example.com&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;port&#34;: </span><span style=color:#b44>&#34;2345&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=conversionreview-response-success-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-response-success-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># v1.16 中已弃用以推荐使用  apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;response&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 必须与 &lt;request.uid&gt; 匹配</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;result&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;status&#34;: </span><span style=color:#b44>&#34;Failed&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 这里的对象必须与 request.objects 中的对象顺序相同并且其 apiVersion 被设置为 &lt;request.desiredAPIVersion&gt;。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind、metadata.uid、metadata.name 和 metadata.namespace 等字段都不可被 Webhook 修改。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Webhook 可以更改 metadata.labels 和 metadata.annotations 字段值。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Webhook 对 metadata 中其他字段的更改都会被忽略。</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;convertedObjects&#34;: </span>[<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;local-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;namespace&#34;: </span><span style=color:#b44>&#34;default&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;host&#34;: </span><span style=color:#b44>&#34;localhost&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;port&#34;: </span><span style=color:#b44>&#34;1234&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;example.com/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;metadata&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;creationTimestamp&#34;: </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;name&#34;: </span><span style=color:#b44>&#34;remote-crontab&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;resourceVersion&#34;: </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;host&#34;: </span><span style=color:#b44>&#34;example.com&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>&#34;port&#34;: </span><span style=color:#b44>&#34;2345&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><p>如果转换失败，则 Webhook 应该返回包含以下字段的 <code>response</code> 节：</p><ul><li><code>uid</code>，从发送到 Webhook 的 <code>request.uid</code> 复制而来</li><li><code>result</code>，设置为 <code>{"status": "Failed"}</code></li></ul><div class="alert alert-danger warning callout" role=alert><strong>警告：</strong><p>转换失败会破坏对定制资源的读写访问，包括更新或删除资源的能力。
转换失败应尽可能避免，并且不可用于实施合法性检查约束
（应改用验证模式或 Webhook 准入插件）。</div><p>来自 Webhook 的响应示例，指示转换请求失败，并带有可选消息：</p><ul class="nav nav-tabs" id=conversionreview-response-failure role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-response-failure-0 role=tab aria-controls=conversionreview-response-failure-0 aria-selected=true>apiextensions.k8s.io/v1</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-response-failure-1 role=tab aria-controls=conversionreview-response-failure-1>apiextensions.k8s.io/v1beta1</a></li></ul><div class=tab-content id=conversionreview-response-failure><div id=conversionreview-response-failure-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-response-failure-0><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;response&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;&lt;value from request.uid&gt;&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;result&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;status&#34;: </span><span style=color:#b44>&#34;Failed&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;message&#34;: </span><span style=color:#b44>&#34;hostPort could not be parsed into a separate host and port&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div><div id=conversionreview-response-failure-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-response-failure-1><p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># v1.16 中弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;apiVersion&#34;: </span><span style=color:#b44>&#34;apiextensions.k8s.io/v1beta1&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;kind&#34;: </span><span style=color:#b44>&#34;ConversionReview&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>&#34;response&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;uid&#34;: </span><span style=color:#b44>&#34;&lt;value from request.uid&gt;&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>&#34;result&#34;: </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;status&#34;: </span><span style=color:#b44>&#34;Failed&#34;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>&#34;message&#34;: </span><span style=color:#b44>&#34;hostPort could not be parsed into a separate host and port&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div></div><h2 id=write-read-and-update-versioned-crd-objects>编写、读取和更新版本化的 CustomResourceDefinition 对象</h2><p>写入对象时，将使用写入时指定的存储版本来存储。如果存储版本发生变化，
现有对象永远不会被自动转换。然而，新创建或被更新的对象将以新的存储版本写入。
对象写入的版本不再被支持是有可能的。</p><p>当读取对象时，作为路径的一部分，你需要指定版本。
如果所指定的版本与对象的持久版本不同，Kubernetes 会按所请求的版本将对象返回，
但是在满足服务请求时，被持久化的对象既不会在磁盘上更改，
也不会以任何方式进行转换（除了 <code>apiVersion</code> 字符串被更改之外）。
你可以以当前提供的任何版本来请求对象。</p><p>如果你更新一个现有对象，它将以当前的存储版本被重写。
这是可以将对象从一个版本改到另一个版本的唯一办法。</p><p>为了说明这一点，请考虑以下假设的一系列事件：</p><ol><li>存储版本是 <code>v1beta1</code>。你创建一个对象。该对象以版本 <code>v1beta1</code> 存储。</li><li>你将为 CustomResourceDefinition 添加版本 <code>v1</code>，并将其指定为存储版本。</li><li>你使用版本 <code>v1beta1</code> 来读取你的对象，然后你再次用版本 <code>v1</code> 读取对象。
除了 apiVersion 字段之外，返回的两个对象是完全相同的。</li><li>你创建一个新对象。对象以版本 <code>v1</code> 保存在存储中。
你现在有两个对象，其中一个是 <code>v1beta1</code>，另一个是 <code>v1</code>。</li><li>你更新第一个对象。该对象现在以版本 <code>v1</code> 保存，因为 <code>v1</code> 是当前的存储版本。</li></ol><h3 id=previous-storage-versions>以前的存储版本</h3><p>API 服务器在状态字段 <code>storedVersions</code> 中记录曾被标记为存储版本的每个版本。
对象可能以任何曾被指定为存储版本的版本保存。
存储中不会出现从未成为存储版本的版本的对象。</p><h2 id=upgrade-existing-objects-to-a-new-stored-version>将现有对象升级到新的存储版本</h2><p>弃用版本并删除其支持时，请选择存储升级过程。</p><p><strong>选项 1：</strong> 使用存储版本迁移程序（Storage Version Migrator）</p><ol><li>运行<a href=https://github.com/kubernetes-sigs/kube-storage-version-migrator>存储版本迁移程序</a></li><li>从 CustomResourceDefinition 的 <code>status.storedVersions</code> 字段中去掉老的版本。</li></ol><p><strong>选项 2：</strong> 手动将现有对象升级到新的存储版本</p><p>以下是从 <code>v1beta1</code> 升级到 <code>v1</code> 的示例过程。</p><ol><li>在 CustomResourceDefinition 文件中将 <code>v1</code> 设置为存储版本，并使用 kubectl 应用它。
<code>storedVersions</code>现在是<code>v1beta1, v1</code>。</li><li>编写升级过程以列出所有现有对象并使用相同内容将其写回存储。
这会强制后端使用当前存储版本（即 <code>v1</code>）写入对象。</li><li>从 CustomResourceDefinition 的 <code>status.storedVersions</code> 字段中删除 <code>v1beta1</code>。</li></ol><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p><code>--subresource</code> 标志在 kubectl get、patch、edit 和 replace 命令中用于获取和更新所有支持它们的
API 资源的子资源、<code>status</code> 和 <code>scale</code>。此标志从 kubectl 版本 v1.24 开始可用。
以前通过 kubectl 读取子资源（如 <code>status</code>）涉及使用 <code>kubectl --raw</code>，并且根本不可能使用 kubectl 更新子资源。
从 v1.24 开始，<code>kubectl</code> 工具可用于编辑或修补有关 CRD 对象的 <code>status</code> 子资源。
请参阅<a href=/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#scale-kubectl-patch>如何使用子资源标志修补 Deployment</a>。</p><p>此页面是 Kubernetes v1.25 文档的一部分。
如果你运行的是不同版本的 Kubernetes，请查阅相应版本的文档。</p><p>以下是如何使用 <code>kubectl</code> 为一个 CRD 对象修补 <code>status</code> 子资源的示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl patch customresourcedefinitions &lt;CRD_Name&gt; --subresource<span style=color:#666>=</span><span style=color:#b44>&#39;status&#39;</span> --type<span style=color:#666>=</span><span style=color:#b44>&#39;merge&#39;</span> -p <span style=color:#b44>&#39;{&#34;status&#34;:{&#34;storedVersions&#34;:[&#34;v1&#34;]}}&#39;</span>
</span></span></code></pre></div></div></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/zh-cn/docs/home/>主页</a>
<a class=text-white href=/zh-cn/blog/>博客</a>
<a class=text-white href=/zh-cn/training/>培训</a>
<a class=text-white href=/zh-cn/partners/>合作伙伴</a>
<a class=text-white href=/zh-cn/community/>社区</a>
<a class=text-white href=/zh-cn/case-studies/>案例分析</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes 作者 | 文档发布基于 <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a> 授权许可</small><br><small class=text-white>Copyright &copy; 2023 Linux 基金会&reg;。保留所有权利。Linux 基金会已注册并使用商标。如需了解 Linux 基金会的商标列表，请访问<a href=https://www.linuxfoundation.org/trademark-usage class=light-text>商标使用页面</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>