<!doctype html><html lang=zh-cn class=no-js><head><meta name=robots content="noindex, nofollow"><link rel=alternate hreflang=en href=https://kubernetes.io/docs/concepts/windows/><link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/concepts/windows/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical type=text/html href=https://kubernetes.io/zh-cn/docs/concepts/windows/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>Kubernetes 中的 Windows | Kubernetes</title><meta property="og:title" content="Kubernetes 中的 Windows"><meta property="og:description" content="生产级别的容器编排系统"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/zh-cn/docs/concepts/windows/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="Kubernetes 中的 Windows"><meta itemprop=description content="生产级别的容器编排系统"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes 中的 Windows"><meta name=twitter:description content="生产级别的容器编排系统"><link href=/scss/main.css rel=stylesheet><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://kubernetes.io/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content=" "><meta property="og:description" content=" "><meta name=twitter:description content=" "><meta property="og:url" content="https://kubernetes.io/zh-cn/docs/concepts/windows/"><meta property="og:title" content="Kubernetes 中的 Windows"><meta name=twitter:title content="Kubernetes 中的 Windows"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/jquery-3.6.0.min.js intregrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/zh-cn/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/zh-cn/docs/>文档</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/blog/>Kubernetes 博客</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/training/>培训</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/partners/>合作伙伴</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/community/>社区</a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/zh-cn/case-studies/>案例分析</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>版本列表</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh-cn/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/zh-cn/docs/concepts/windows/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/zh-cn/docs/concepts/windows/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/zh-cn/docs/concepts/windows/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/zh-cn/docs/concepts/windows/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/zh-cn/docs/concepts/windows/>v1.21</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文 (Chinese)</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/concepts/windows/>English</a>
<a class=dropdown-item href=/ko/docs/concepts/windows/>한국어 (Korean)</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/zh-cn/docs/concepts/windows/>返回本页常规视图</a>.</p></div><h1 class=title>Kubernetes 中的 Windows</h1><ul><li>1: <a href=#pg-849246a35c3de66980f66e1b0944ceb4>Kubernetes 中的 Windows 容器</a></li><li>2: <a href=#pg-0d8bfd3be43b3580681c56f6fec9d6dc>Kubernetes 中的 Windows 容器调度指南</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-849246a35c3de66980f66e1b0944ceb4>1 - Kubernetes 中的 Windows 容器</h1><p>在许多组织中，所运行的很大一部分服务和应用是 Windows 应用。
<a href=https://aka.ms/windowscontainers>Windows 容器</a>提供了一种封装进程和包依赖项的方式，
从而简化了 DevOps 实践，令 Windows 应用程序同样遵从云原生模式。</p><p>对于同时投入基于 Windows 应用和 Linux 应用的组织而言，他们不必寻找不同的编排系统来管理其工作负载，
使其跨部署的运营效率得以大幅提升，而不必关心所用的操作系统。</p><h2 id=windows-nodes-in-k8s>Kubernetes 中的 Windows 节点</h2><p>若要在 Kubernetes 中启用对 Windows 容器的编排，可以在现有的 Linux 集群中包含 Windows 节点。
在 Kubernetes 上调度 <a class=glossary-tooltip title='Pod 表示你的集群上一组正在运行的容器。' data-toggle=tooltip data-placement=top href=/zh-cn/docs/concepts/workloads/pods/ target=_blank aria-label=Pod>Pod</a> 中的 Windows 容器与调度基于 Linux 的容器类似。</p><p>为了运行 Windows 容器，你的 Kubernetes 集群必须包含多个操作系统。
尽管你只能在 Linux 上运行<a class=glossary-tooltip title='控制平面是指容器编排层，它暴露 API 和接口来定义、部署容器和管理容器的生命周期。' data-toggle=tooltip data-placement=top href='/zh-cn/docs/reference/glossary/?all=true#term-control-plane' target=_blank aria-label=控制平面>控制平面</a>，
你可以部署运行 Windows 或 Linux 的工作节点。</p><p>支持 Windows <a class=glossary-tooltip title='Kubernetes 中的工作机器称作节点。' data-toggle=tooltip data-placement=top href=/zh-cn/docs/concepts/architecture/nodes/ target=_blank aria-label=节点>节点</a>的前提是操作系统为 Windows Server 2019。</p><p>本文使用术语 <strong>Windows 容器</strong>表示具有进程隔离能力的 Windows 容器。
Kubernetes 不支持使用
<a href=https://docs.microsoft.com/zh-cn/virtualization/windowscontainers/manage-containers/hyperv-container>Hyper-V 隔离能力</a>来运行
Windows 容器。</p><h2 id=limitations>兼容性与局限性</h2><p>某些节点层面的功能特性仅在使用特定<a href=#container-runtime>容器运行时</a>时才可用；
另外一些特性则在 Windows 节点上不可用，包括：</p><ul><li>巨页（HugePages）：Windows 容器当前不支持。</li><li>特权容器：Windows 容器当前不支持。
<a href=/zh-cn/docs/tasks/configure-pod-container/create-hostprocess-pod/>HostProcess 容器</a>提供类似功能。</li><li>TerminationGracePeriod：需要 containerD。</li></ul><p>Windows 节点并不支持共享命名空间的所有功能特性。
有关更多详细信息，请参考 <a href=#api>API 兼容性</a>。</p><p>有关 Kubernetes 测试时所使用的 Windows 版本的详细信息，请参考 <a href=#windows-os-version-support>Windows 操作系统版本兼容性</a>。</p><p>从 API 和 kubectl 的角度来看，Windows 容器的行为与基于 Linux 的容器非常相似。
然而，在本节所概述的一些关键功能上，二者存在一些显著差异。</p><h3 id=comparison-with-Linux-similarities>与 Linux 比较</h3><p>Kubernetes 关键组件在 Windows 上的工作方式与在 Linux 上相同。
本节介绍几个关键的工作负载抽象及其如何映射到 Windows。</p><ul><li><p><a href=/zh-cn/docs/concepts/workloads/pods/>Pod</a></p><p>Pod 是 Kubernetes 的基本构建块，是可以创建或部署的最小和最简单的单元。
你不可以在同一个 Pod 中部署 Windows 和 Linux 容器。
Pod 中的所有容器都调度到同一 Node 上，每个 Node 代表一个特定的平台和体系结构。
Windows 容器支持以下 Pod 能力、属性和事件：</p><ul><li><p>每个 Pod 有一个或多个容器，具有进程隔离和卷共享能力</p></li><li><p>Pod <code>status</code> 字段</p></li><li><p>就绪、存活和启动探针</p></li><li><p>postStart 和 preStop 容器生命周期回调</p></li><li><p>ConfigMap 和 Secret：作为环境变量或卷</p></li><li><p><code>emptyDir</code> 卷</p></li><li><p>命名管道形式的主机挂载</p></li><li><p>资源限制</p></li><li><p>操作系统字段：</p><p><code>.spec.os.name</code> 字段应设置为 <code>windows</code> 以表明当前 Pod 使用 Windows 容器。</p><div class="alert alert-info note callout" role=alert><strong>说明：</strong> 从 1.25 开始，<code>IdentifyPodOS</code> 特性门控进入 GA 阶段，默认启用。</div><p>如果你将 <code>.spec.os.name</code> 字段设置为 <code>windows</code>，
则你必须不能在对应 Pod 的 <code>.spec</code> 中设置以下字段：</p><ul><li><code>spec.hostPID</code></li><li><code>spec.hostIPC</code></li><li><code>spec.securityContext.seLinuxOptions</code></li><li><code>spec.securityContext.seccompProfile</code></li><li><code>spec.securityContext.fsGroup</code></li><li><code>spec.securityContext.fsGroupChangePolicy</code></li><li><code>spec.securityContext.sysctls</code></li><li><code>spec.shareProcessNamespace</code></li><li><code>spec.securityContext.runAsUser</code></li><li><code>spec.securityContext.runAsGroup</code></li><li><code>spec.securityContext.supplementalGroups</code></li><li><code>spec.containers[*].securityContext.seLinuxOptions</code></li><li><code>spec.containers[*].securityContext.seccompProfile</code></li><li><code>spec.containers[*].securityContext.capabilities</code></li><li><code>spec.containers[*].securityContext.readOnlyRootFilesystem</code></li><li><code>spec.containers[*].securityContext.privileged</code></li><li><code>spec.containers[*].securityContext.allowPrivilegeEscalation</code></li><li><code>spec.containers[*].securityContext.procMount</code></li><li><code>spec.containers[*].securityContext.runAsUser</code></li><li><code>spec.containers[*].securityContext.runAsGroup</code></li></ul><p>在上述列表中，通配符（<code>*</code>）表示列表中的所有项。
例如，<code>spec.containers[*].securityContext</code> 指代所有容器的 SecurityContext 对象。
如果指定了这些字段中的任意一个，则 API 服务器不会接受此 Pod。</p></li></ul></li></ul><ul><li><p><a href=/zh-cn/docs/concepts/workloads/controllers/>工作负载资源</a>包括：</p><ul><li>ReplicaSet</li><li>Deployment</li><li>StatefulSet</li><li>DaemonSet</li><li>Job</li><li>CronJob</li><li>ReplicationController</li></ul></li><li><a class=glossary-tooltip title='将运行在一组 Pods 上的应用程序公开为网络服务的抽象方法。' data-toggle=tooltip data-placement=top href=/zh-cn/docs/concepts/services-networking/service/ target=_blank aria-label=Services>Services</a><p>有关更多详细信息，请参考<a href=/zh-cn/docs/concepts/services-networking/windows-networking/#load-balancing-and-services>负载均衡和 Service</a>。</p></li></ul><p>Pod、工作负载资源和 Service 是在 Kubernetes 上管理 Windows 工作负载的关键元素。
然而，它们本身还不足以在动态的云原生环境中对 Windows 工作负载进行恰当的生命周期管理。
Kubernetes 还支持：</p><ul><li><code>kubectl exec</code></li><li>Pod 和容器度量指标</li><li><a class=glossary-tooltip title='Pod 水平自动扩缩器（Horizontal Pod Autoscaler）是一种 API 资源，它根据目标 CPU 利用率或自定义度量目标扩缩 Pod 副本的数量。' data-toggle=tooltip data-placement=top href=/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/ target=_blank aria-label='Pod 水平自动扩缩容'>Pod 水平自动扩缩容</a></li><li><a class=glossary-tooltip title=资源配额提供了限制每个命名空间的资源消耗总和的约束。 data-toggle=tooltip data-placement=top href=/zh-cn/docs/concepts/policy/resource-quotas/ target=_blank aria-label=资源配额>资源配额</a></li><li>调度器抢占</li></ul><h3 id=kubelet-compatibility>kubelet 的命令行选项</h3><p>某些 kubelet 命令行选项在 Windows 上的行为不同，如下所述：</p><ul><li><code>--windows-priorityclass</code> 允许你设置 kubelet 进程的调度优先级
（参考 <a href=/zh-cn/docs/concepts/configuration/windows-resource-management/#resource-management-cpu>CPU 资源管理</a>）。</li><li><code>--kube-reserved</code>、<code>--system-reserved</code> 和 <code>--eviction-hard</code> 标志更新
<a href=/zh-cn/docs/tasks/administer-cluster/reserve-compute-resources/#node-allocatable>NodeAllocatable</a>。</li><li>未实现使用 <code>--enforce-node-allocable</code> 驱逐。</li><li>未实现使用 <code>--eviction-hard</code> 和 <code>--eviction-soft</code> 驱逐。</li><li>在 Windows 节点上运行时，kubelet 没有内存或 CPU 限制。
<code>--kube-reserved</code> 和 <code>--system-reserved</code> 仅从 <code>NodeAllocatable</code> 中减去，并且不保证为工作负载提供的资源。
有关更多信息，请参考 <a href=/zh-cn/docs/concepts/configuration/windows-resource-management/#resource-reservation>Windows 节点的资源管理</a>。</li><li>未实现 <code>MemoryPressure</code> 条件。</li><li>kubelet 不会执行 OOM 驱逐操作。</li></ul><h3 id=api>API 兼容性</h3><p>由于操作系统和容器运行时的缘故，Kubernetes API 在 Windows 上的工作方式存在细微差异。
某些工作负载属性是为 Linux 设计的，无法在 Windows 上运行。</p><p>从较高的层面来看，以下操作系统概念是不同的：</p><ul><li>身份 - Linux 使用 userID（UID）和 groupID（GID），表示为整数类型。
用户名和组名是不规范的，它们只是 <code>/etc/groups</code> 或 <code>/etc/passwd</code> 中的别名，
作为 UID+GID 的后备标识。
Windows 使用更大的二进制<a href=https://docs.microsoft.com/zh-cn/windows/security/identity-protection/access-control/security-identifiers>安全标识符</a>（SID），
存放在 Windows 安全访问管理器（Security Access Manager，SAM）数据库中。
此数据库在主机和容器之间或容器之间不共享。</li><li>文件权限 - Windows 使用基于 SID 的访问控制列表，
而像 Linux 使用基于对象权限和 UID+GID 的位掩码（POSIX 系统）以及<strong>可选的</strong>访问控制列表。</li><li>文件路径 - Windows 上的约定是使用 <code>\</code> 而不是 <code>/</code>。
Go IO 库通常接受两者，能让其正常工作，但当你设置要在容器内解读的路径或命令行时，
可能需要用 <code>\</code>。</li></ul><ul><li>信号 - Windows 交互式应用处理终止的方式不同，可以实现以下一种或多种：<ul><li>UI 线程处理包括 <code>WM_CLOSE</code> 在内准确定义的消息。</li><li>控制台应用使用控制处理程序（Control Handler）处理 Ctrl-C 或 Ctrl-Break。</li><li>服务会注册可接受 <code>SERVICE_CONTROL_STOP</code> 控制码的服务控制处理程序（Service Control Handler）函数。</li></ul></li></ul><p>容器退出码遵循相同的约定，其中 0 表示成功，非零表示失败。
具体的错误码在 Windows 和 Linux 中可能不同。
但是，从 Kubernetes 组件（kubelet、kube-proxy）传递的退出码保持不变。</p><h5 id=compatibility-v1-pod-spec-containers>容器规范的字段兼容性</h5><p>以下列表记录了 Pod 容器规范在 Windows 和 Linux 之间的工作方式差异：</p><ul><li>巨页（Huge page）在 Windows 容器运行时中未实现，且不可用。
巨页需要不可为容器配置的<a href=https://docs.microsoft.com/zh-cn/windows/win32/memory/large-page-support>用户特权生效</a>。</li><li><code>requests.cpu</code> 和 <code>requests.memory</code> -
从节点可用资源中减去请求，因此请求可用于避免一个节点过量供应。
但是，请求不能用于保证已过量供应的节点中的资源。
如果运营商想要完全避免过量供应，则应将设置请求作为最佳实践应用到所有容器。</li></ul><ul><li><code>securityContext.allowPrivilegeEscalation</code> -
不能在 Windows 上使用；所有权能字都无法生效。</li><li><code>securityContext.capabilities</code> - POSIX 权能未在 Windows 上实现。</li><li><code>securityContext.privileged</code> - Windows 不支持特权容器，
可使用 <a href=/zh-cn/docs/tasks/configure-pod-container/create-hostprocess-pod/>HostProcess 容器</a>代替。</li><li><code>securityContext.procMount</code> - Windows 没有 <code>/proc</code> 文件系统。</li><li><code>securityContext.readOnlyRootFilesystem</code> -
不能在 Windows 上使用；对于容器内运行的注册表和系统进程，写入权限是必需的。</li><li><code>securityContext.runAsGroup</code> - 不能在 Windows 上使用，因为不支持 GID。</li></ul><ul><li><code>securityContext.runAsNonRoot</code> -
此设置将阻止以 <code>ContainerAdministrator</code> 身份运行容器，这是 Windows 上与 root 用户最接近的身份。</li><li><code>securityContext.runAsUser</code> - 改用 <a href=/zh-cn/docs/tasks/configure-pod-container/configure-runasusername><code>runAsUserName</code></a>。</li><li><code>securityContext.seLinuxOptions</code> - 不能在 Windows 上使用，因为 SELinux 特定于 Linux。</li><li><code>terminationMessagePath</code> - 这个字段有一些限制，因为 Windows 不支持映射单个文件。
默认值为 <code>/dev/termination-log</code>，因为默认情况下它在 Windows 上不存在，所以能生效。</li></ul><h5 id=compatibility-v1-pod>Pod 规范的字段兼容性</h5><p>以下列表记录了 Pod 规范在 Windows 和 Linux 之间的工作方式差异：</p><ul><li><code>hostIPC</code> 和 <code>hostpid</code> - 不能在 Windows 上共享主机命名空间。</li><li><code>hostNetwork</code> - Windows 操作系统不支持共享主机网络。</li><li><code>dnsPolicy</code> - Windows 不支持将 Pod <code>dnsPolicy</code> 设为 <code>ClusterFirstWithHostNet</code>，
因为未提供主机网络。Pod 始终用容器网络运行。</li><li><code>podSecurityContext</code>（参见下文）</li><li><code>shareProcessNamespace</code> - 这是一个 beta 版功能特性，依赖于 Windows 上未实现的 Linux 命名空间。
Windows 无法共享进程命名空间或容器的根文件系统（root filesystem）。
只能共享网络。</li></ul><ul><li><code>terminationGracePeriodSeconds</code> - 这在 Windows 上的 Docker 中没有完全实现，
请参考 <a href=https://github.com/moby/moby/issues/25982>GitHub issue</a>。
目前的行为是通过 CTRL_SHUTDOWN_EVENT 发送 ENTRYPOINT 进程，然后 Windows 默认等待 5 秒，
最后使用正常的 Windows 关机行为终止所有进程。
5 秒默认值实际上位于<a href=https://github.com/moby/moby/issues/25982#issuecomment-426441183>容器内</a>的 Windows 注册表中，
因此在构建容器时可以覆盖这个值。</li><li><code>volumeDevices</code> - 这是一个 beta 版功能特性，未在 Windows 上实现。
Windows 无法将原始块设备挂接到 Pod。</li><li><code>volumes</code><ul><li>如果你定义一个 <code>emptyDir</code> 卷，则你无法将卷源设为 <code>memory</code>。</li></ul></li><li>你无法为卷挂载启用 <code>mountPropagation</code>，因为这在 Windows 上不支持。</li></ul><h5 id=compatibility-v1-pod-spec-containers-securitycontext>Pod 安全上下文的字段兼容性</h5><p>Pod 的所有 <a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#security-context><code>securityContext</code></a>
字段都无法在 Windows 上生效。</p><h2 id=node-problem-detector>节点问题检测器</h2><p>节点问题检测器（参考<a href=/zh-cn/docs/tasks/debug/debug-cluster/monitor-node-health/>节点健康监测</a>）初步支持 Windows。
有关更多信息，请访问该项目的 <a href=https://github.com/kubernetes/node-problem-detector#windows>GitHub 页面</a>。</p><h3 id=pause-container>Pause 容器</h3><p>在 Kubernetes Pod 中，首先创建一个基础容器或 “pause” 容器来承载容器。
在 Linux 中，构成 Pod 的 cgroup 和命名空间维持持续存在需要一个进程；
而 pause 进程就提供了这个功能。
属于同一 Pod 的容器（包括基础容器和工作容器）共享一个公共网络端点
（相同的 IPv4 和/或 IPv6 地址，相同的网络端口空间）。
Kubernetes 使用 pause 容器以允许工作容器崩溃或重启，而不会丢失任何网络配置。</p><p>Kubernetes 维护一个多体系结构的镜像，包括对 Windows 的支持。
对于 Kubernetes v1.25，推荐的 pause 镜像为 <code>registry.k8s.io/pause:3.6</code>。
可在 GitHub 上获得<a href=https://github.com/kubernetes/kubernetes/tree/master/build/pause>源代码</a>。</p><p>Microsoft 维护一个不同的多体系结构镜像，支持 Linux 和 Windows amd64，
你可以找到的镜像类似 <code>mcr.microsoft.com/oss/kubernetes/pause:3.6</code>。
此镜像的构建与 Kubernetes 维护的镜像同源，但所有 Windows 可执行文件均由
Microsoft 进行了<a href=https://docs.microsoft.com/zh-cn/windows-hardware/drivers/install/authenticode>验证码签名</a>。
如果你正部署到一个需要签名可执行文件的生产或类生产环境，
Kubernetes 项目建议使用 Microsoft 维护的镜像。</p><h3 id=container-runtime>容器运行时</h3><p>你需要将<a class=glossary-tooltip title=容器运行时是负责运行容器的软件。 data-toggle=tooltip data-placement=top href=/zh-cn/docs/setup/production-environment/container-runtimes target=_blank aria-label=容器运行时>容器运行时</a>安装到集群中的每个节点，
这样 Pod 才能在这些节点上运行。</p><p>以下容器运行时适用于 Windows：</p><div class="alert alert-secondary callout third-party-content" role=alert><strong>说明：</strong>
本部分链接到提供 Kubernetes 所需功能的第三方项目。Kubernetes 项目作者不负责这些项目。此页面遵循<a href=https://github.com/cncf/foundation/blob/master/website-guidelines.md target=_blank>CNCF 网站指南</a>，按字母顺序列出项目。要将项目添加到此列表中，请在提交更改之前阅读<a href=/docs/contribute/style/content-guide/#third-party-content>内容指南</a>。</div><h4 id=containerd>ContainerD</h4><div style=margin-top:10px;margin-bottom:10px><b>特性状态：</b> <code>Kubernetes v1.20 [stable]</code></div><p>对于运行 Windows 的 Kubernetes 节点，你可以使用
<a class=glossary-tooltip title=强调简单性、健壮性和可移植性的一种容器运行时 data-toggle=tooltip data-placement=top href=https://containerd.io/docs/ target=_blank aria-label=ContainerD>ContainerD</a> 1.4.0+ 作为容器运行时。</p><p>学习如何<a href=/zh-cn/docs/setup/production-environment/container-runtimes/#install-containerd>在 Windows 上安装 ContainerD</a>。</p><div class="alert alert-info note callout" role=alert><strong>说明：</strong> 将 GMSA 和 containerd 一起用于访问 Windows
网络共享时存在<a href=/zh-cn/docs/tasks/configure-pod-container/configure-gmsa/#gmsa-limitations>已知限制</a>，
这需要一个内核补丁。</div><h4 id=mcr>Mirantis 容器运行时</h4><p><a href=https://docs.mirantis.com/mcr/20.10/overview.html>Mirantis 容器运行时</a>（MCR）
可作为所有 Windows Server 2019 和更高版本的容器运行时。</p><p>有关更多信息，请参考<a href=https://docs.mirantis.com/mcr/20.10/install/mcr-windows.html>在 Windows Server 上安装 MCR</a>。</p><h2 id=windows-os-version-support>Windows 操作系统版本兼容性</h2><p>在 Windows 节点上，如果主机操作系统版本必须与容器基础镜像操作系统版本匹配，
则会应用严格的兼容性规则。
仅 Windows Server 2019 作为容器操作系统时，才能完全支持 Windows 容器。</p><p>对于 Kubernetes v1.25，Windows 节点（和 Pod）的操作系统兼容性如下：</p><dl><dt>Windows Server LTSC release</dt><dd>Windows Server 2019</dd><dd>Windows Server 2022</dd><dt>Windows Server SAC release</dt><dd>Windows Server version 20H2</dd></dl><p>也适用 Kubernetes <a href=/zh-cn/releases/version-skew-policy/>版本偏差策略</a>。</p><h2 id=troubleshooting>获取帮助和故障排查</h2><p>对 Kubernetes 集群进行故障排查的主要帮助来源应始于<a href=/zh-cn/docs/tasks/debug/>故障排查</a>页面。</p><p>本节包括了一些其他特定于 Windows 的故障排查帮助。
日志是解决 Kubernetes 中问题的重要元素。
确保在任何时候向其他贡献者寻求故障排查协助时随附了日志信息。
遵照 SIG Windows
<a href=https://github.com/kubernetes/community/blob/master/sig-windows/CONTRIBUTING.md#gathering-logs>日志收集贡献指南</a>中的指示说明。</p><h3 id=report-issue-and-feature-request>报告问题和功能请求</h3><p>如果你发现疑似 bug，或者你想提出功能请求，请按照
<a href=https://github.com/kubernetes/community/blob/master/sig-windows/CONTRIBUTING.md#reporting-issues-and-feature-requests>SIG Windows 贡献指南</a>
新建一个 Issue。
你应该先搜索 issue 列表，以防之前报告过这个问题，凭你对该问题的经验添加评论，
并随附日志信息。
Kubernetes Slack 上的 SIG Windows 频道也是一个很好的途径，
可以在创建工单之前获得一些初始支持和故障排查思路。</p><h2 id=接下来>接下来</h2><h3 id=deployment-tools>部署工具</h3><p>kubeadm 工具帮助你部署 Kubernetes 集群，提供管理集群的控制平面以及运行工作负载的节点。
<a href=/zh-cn/docs/tasks/administer-cluster/kubeadm/adding-windows-nodes/>添加 Windows 节点</a>阐述了如何使用
kubeadm 将 Windows 节点部署到你的集群。</p><p>Kubernetes <a href=https://cluster-api.sigs.k8s.io/>集群 API</a> 项目也提供了自动部署 Windows 节点的方式。</p><h3 id=windows-distribution-channels>Windows 分发渠道</h3><p>有关 Windows 分发渠道的详细阐述，请参考
<a href=https://docs.microsoft.com/zh-cn/windows-server/get-started-19/servicing-channels-19>Microsoft 文档</a>。</p><p>有关支持模型在内的不同 Windows Server 服务渠道的信息，请参考
<a href=https://docs.microsoft.com/zh-cn/windows-server/get-started/servicing-channels-comparison>Windows Server 服务渠道</a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0d8bfd3be43b3580681c56f6fec9d6dc>2 - Kubernetes 中的 Windows 容器调度指南</h1><p>在许多组织中运行的服务和应用程序中，Windows 应用程序构成了很大一部分。
本指南将引导你完成在 Kubernetes 中配置和部署 Windows 容器的步骤。</p><h2 id=objectives>目标</h2><ul><li>配置 Deployment 样例以在 Windows 节点上运行 Windows 容器</li><li>在 Kubernetes 中突出 Windows 特定的功能</li></ul><h2 id=before-you-begin>在你开始之前</h2><ul><li>创建一个 Kubernetes 集群，其中包含一个控制平面和一个<a href=/zh-cn/docs/tasks/administer-cluster/kubeadm/adding-windows-nodes/>运行 Windows Server 的工作节点</a></li><li>务必请注意，在 Kubernetes 上创建和部署服务和工作负载的行为方式与 Linux 和 Windows 容器的行为方式大致相同。
与集群交互的 <a href=/zh-cn/docs/reference/kubectl/>kubectl 命令</a>是一致的。
下一小节的示例旨在帮助你快速开始使用 Windows 容器。</li></ul><h2 id=getting-started-deploying-a-windows-container>快速开始：部署 Windows 容器</h2><p>以下示例 YAML 文件部署了一个在 Windows 容器内运行的简单 Web 服务器的应用程序。</p><p>创建一个名为 <code>win-webserver.yaml</code> 的 Service 规约，其内容如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此 Service 服务的端口</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>NodePort<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>windowswebserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mcr.microsoft.com/windows/servercore:ltsc2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- powershell.exe<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- -command<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;&lt;#code used from https://gist.github.com/19WAS85/5424431#&gt; ; $$listener = New-Object System.Net.HttpListener ; $$listener.Prefixes.Add(&#39;http://*:80/&#39;) ; $$listener.Start() ; $$callerCounts = @{} ; Write-Host(&#39;Listening at http://*:80/&#39;) ; while ($$listener.IsListening) { ;$$context = $$listener.GetContext() ;$$requestUrl = $$context.Request.Url ;$$clientIP = $$context.Request.RemoteEndPoint.Address ;$$response = $$context.Response ;Write-Host &#39;&#39; ;Write-Host(&#39;&gt; {0}&#39; -f $$requestUrl) ;  ;$$count = 1 ;$$k=$$callerCounts.Get_Item($$clientIP) ;if ($$k -ne $$null) { $$count += $$k } ;$$callerCounts.Set_Item($$clientIP, $$count) ;$$ip=(Get-NetAdapter | Get-NetIpAddress); $$header=&#39;&lt;html&gt;&lt;body&gt;&lt;H1&gt;Windows Container Web Server&lt;/H1&gt;&#39; ;$$callerCountsString=&#39;&#39; ;$$callerCounts.Keys | % { $$callerCountsString+=&#39;&lt;p&gt;IP {0} callerCount {1} &#39; -f $$ip[1].IPAddress,$$callerCounts.Item($$_) } ;$$footer=&#39;&lt;/body&gt;&lt;/html&gt;&#39; ;$$content=&#39;{0}{1}{2}&#39; -f $$header,$$callerCountsString,$$footer ;Write-Output $$content ;$$buffer = [System.Text.Encoding]::UTF8.GetBytes($$content) ;$$response.ContentLength64 = $$buffer.Length ;$$response.OutputStream.Write($$buffer, 0, $$buffer.Length) ;$$response.Close() ;$$responseStatus = $$response.StatusCode ;Write-Host(&#39;&lt; {0}&#39; -f $$responseStatus)  } ; &#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>windows<span style=color:#bbb>
</span></span></span></code></pre></div><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>端口映射也是支持的，但为简单起见，此示例将容器的端口 80 直接暴露给服务。</div><ol><li><p>检查所有节点是否健康</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div></li></ol><ol><li><p>部署 Service 并监视 Pod 更新：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f win-webserver.yaml
</span></span><span style=display:flex><span>kubectl get pods -o wide -w
</span></span></code></pre></div><p>当 Service 被正确部署时，两个 Pod 都被标记为就绪（Ready）。要退出 watch 命令，请按 Ctrl+C。</p></li></ol><ol><li><p>检查部署是否成功。请验证：</p><ul><li>当执行 <code>kubectl get pods</code> 命令时，能够从 Linux 控制平面所在的节点上列出两个 Pod。</li><li>跨网络的节点到 Pod 通信，从 Linux 控制平面所在的节点上执行 <code>curl</code> 命令来访问
Pod IP 的 80 端口以检查 Web 服务器响应。</li><li>Pod 间通信，使用 <code>docker exec</code> 或 <code>kubectl exec</code>
命令进入容器，并在 Pod 之间（以及跨主机，如果你有多个 Windows 节点）相互进行 ping 操作。</li><li>Service 到 Pod 的通信，在 Linux 控制平面所在的节点以及独立的 Pod 中执行 <code>curl</code>
命令来访问虚拟的服务 IP（在 <code>kubectl get services</code> 命令下查看）。</li><li>服务发现，执行 <code>curl</code> 命令来访问带有 Kubernetes
<a href=/zh-cn/docs/concepts/services-networking/dns-pod-service/#services>默认 DNS 后缀</a>的服务名称。</li><li>入站连接，在 Linux 控制平面所在的节点上或集群外的机器上执行 <code>curl</code> 命令来访问 NodePort 服务。</li><li>出站连接，使用 <code>kubectl exec</code>，从 Pod 内部执行 <code>curl</code> 访问外部 IP。</li></ul></li></ol><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>由于当前 Windows 平台的网络堆栈限制，Windows 容器主机无法访问调度到其上的 Service 的 IP。
只有 Windows Pod 能够访问 Service IP。</div><h2 id=observability>可观察性</h2><h3 id=capturing-logs-from-workloads>捕捉来自工作负载的日志</h3><p>日志是可观察性的重要元素；它们使用户能够深入了解工作负载的运行情况，并且是解决问题的关键因素。
由于 Windows 容器和 Windows 容器中的工作负载与 Linux 容器的行为不同，因此用户很难收集日志，从而限制了操作可见性。
例如，Windows 工作负载通常配置为记录到 ETW（Windows 事件跟踪）或向应用程序事件日志推送条目。
<a href=https://github.com/microsoft/windows-container-tools/tree/master/LogMonitor>LogMonitor</a>
是一个微软开源的工具，是监视 Windows 容器内所配置的日志源的推荐方法。
LogMonitor 支持监视事件日志、ETW 提供程序和自定义应用程序日志，将它们传送到 STDOUT 以供 <code>kubectl logs &lt;pod></code> 使用。</p><p>按照 LogMonitor GitHub 页面中的说明，将其二进制文件和配置文件复制到所有容器，
并为 LogMonitor 添加必要的入口点以将日志推送到标准输出（STDOUT）。</p><h2 id=configuring-container-user>配置容器用户</h2><h3 id=using-configurable-container-usernames>使用可配置的容器用户名</h3><p>Windows 容器可以配置为使用不同于镜像默认值的用户名来运行其入口点和进程。
<a href=/zh-cn/docs/tasks/configure-pod-container/configure-runasusername/>在这里</a>了解更多信息。</p><h3 id=managing-workload-identity-with-group-managed-service-accounts>使用组托管服务帐户（GMSA）管理工作负载身份</h3><p>Windows 容器工作负载可以配置为使用组托管服务帐户（Group Managed Service Accounts，GMSA）。
组托管服务帐户是一种特定类型的活动目录（Active Directory）帐户，可提供自动密码管理、
简化的服务主体名称（Service Principal Name，SPN）管理，以及将管理委派给多个服务器上的其他管理员的能力。
配置了 GMSA 的容器可以携带使用 GMSA 配置的身份访问外部活动目录域资源。
在<a href=/zh-cn/docs/tasks/configure-pod-container/configure-gmsa/>此处</a>了解有关为 Windows 容器配置和使用 GMSA 的更多信息。</p><h2 id=taints-and-tolerations>污点和容忍度</h2><p>用户需要使用某种污点（Taint）和节点选择器的组合，以便将 Linux 和 Windows 工作负载各自调度到特定操作系统的节点。
下面概述了推荐的方法，其主要目标之一是该方法不应破坏现有 Linux 工作负载的兼容性。</p><p>从 1.25 开始，你可以（并且应该）将每个 Pod 的 <code>.spec.os.name</code> 设置为 Pod 中的容器设计所用于的操作系统。
对于运行 Linux 容器的 Pod，将 <code>.spec.os.name</code> 设置为 <code>linux</code>。
对于运行 Windows 容器的 Pod，将 <code>.spec.os.name</code> 设置为 <code>windows</code>。</p><div class="alert alert-info note callout" role=alert><strong>说明：</strong><p>从 1.25 开始，<code>IdentifyPodOS</code> 特性处于 GA 阶段，默认启用。</div><p>调度器在将 Pod 分配到节点时并不使用 <code>.spec.os.name</code> 的值。
你应该使用正常的 Kubernetes 机制<a href=/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/>将 Pod 分配给节点</a>，
以确保集群的控制平面将 Pod 放置到运行适当操作系统的节点上。</p><p><code>.spec.os.name</code> 值对 Windows Pod 的调度没有影响，
因此仍然需要污点和容忍以及节点选择器来确保 Windows Pod 落在适当的 Windows 节点。</p><h3 id=ensuring-os-specific-workloads-land-on-the-appropriate-container-host>确保特定于操作系统的工作负载落到合适的容器主机上</h3><p>用户可以使用污点（Taint）和容忍度（Toleration）确保将 Windows 容器调度至合适的主机上。
现在，所有的 Kubernetes 节点都有以下默认标签：</p><ul><li>kubernetes.io/os = [windows|linux]</li><li>kubernetes.io/arch = [amd64|arm64|...]</li></ul><p>如果 Pod 规约没有指定像 <code>"kubernetes.io/os": windows</code> 这样的 nodeSelector，
则 Pod 可以被调度到任何主机上，Windows 或 Linux。
这可能会有问题，因为 Windows 容器只能在 Windows 上运行，而 Linux 容器只能在 Linux 上运行。
最佳实践是使用 nodeSelector。</p><p>但是，我们了解到，在许多情况下，用户已经预先存在大量 Linux 容器部署，
以及现成配置的生态系统，例如社区中的 Helm Chart 包和程序化的 Pod 生成案例，例如 Operator。
在这些情况下，你可能不愿更改配置来添加节点选择器。
另一种方法是使用污点。因为 kubelet 可以在注册过程中设置污点，
所以可以很容易地修改为，当只能在 Windows 上运行时，自动添加污点。</p><p>例如：<code>--register-with-taints='os=windows:NoSchedule'</code></p><p>通过向所有 Windows 节点添加污点，任何负载都不会被调度到这些节点上（包括现有的 Linux Pod）。
为了在 Windows 节点上调度 Windows Pod，它需要 nodeSelector 和匹配合适的容忍度来选择 Windows。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>windows<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>node.kubernetes.io/windows-build</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;10.0.17763&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;os&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Equal&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;windows&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;NoSchedule&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=handling-multiple-windows-versions-in-the-same-cluster>处理同一集群中的多个 Windows 版本</h3><p>每个 Pod 使用的 Windows Server 版本必须与节点的版本匹配。
如果要在同一个集群中使用多个 Windows Server 版本，则应设置额外的节点标签和节点选择器。</p><p>Kubernetes 1.17 自动添加了一个新标签 <code>node.kubernetes.io/windows-build</code> 来简化这一点。
如果你运行的是旧版本，则建议手动将此标签添加到 Windows 节点。</p><p>此标签反映了需要匹配以实现兼容性的 Windows 主要、次要和内部版本号。
以下是目前用于每个 Windows Server 版本的值。</p><table><thead><tr><th>产品名称</th><th>构建号</th></tr></thead><tbody><tr><td>Windows Server 2019</td><td>10.0.17763</td></tr><tr><td>Windows Server, Version 20H2</td><td>10.0.19042</td></tr><tr><td>Windows Server 2022</td><td>10.0.20348</td></tr></tbody></table><h3 id=simplifying-with-runtimeclass>使用 RuntimeClass 进行简化</h3><p><a href=/zh-cn/docs/concepts/containers/runtime-class/>RuntimeClass</a> 可用于简化使用污点和容忍度的流程。
集群管理员可以创建一个用于封装这些污点和容忍度的 <code>RuntimeClass</code> 对象。</p><ol><li>将此文件保存到 <code>runtimeClasses.yml</code>。它包括针对 Windows 操作系统、架构和版本的 <code>nodeSelector</code>。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>node.k8s.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>RuntimeClass<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>windows-2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>handler</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;docker&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>scheduling</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;windows&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/arch</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;amd64&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>node.kubernetes.io/windows-build</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;10.0.17763&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>os<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Equal<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;windows&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div><ol><li>以集群管理员身份运行 <code>kubectl create -f runtimeClasses.yml</code></li><li>根据情况，向 Pod 规约中添加 <code>runtimeClassName: windows-2019</code></li></ol><p>例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>runtimeClassName</span>:<span style=color:#bbb> </span>windows-2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mcr.microsoft.com/windows/servercore/iis:windowsservercore-ltsc2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>800Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>.1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>300Mi<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb> </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span></span></span></code></pre></div></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/zh-cn/docs/home/>主页</a>
<a class=text-white href=/zh-cn/blog/>博客</a>
<a class=text-white href=/zh-cn/training/>培训</a>
<a class=text-white href=/zh-cn/partners/>合作伙伴</a>
<a class=text-white href=/zh-cn/community/>社区</a>
<a class=text-white href=/zh-cn/case-studies/>案例分析</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes 作者 | 文档发布基于 <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a> 授权许可</small><br><small class=text-white>Copyright &copy; 2023 Linux 基金会&reg;。保留所有权利。Linux 基金会已注册并使用商标。如需了解 Linux 基金会的商标列表，请访问<a href=https://www.linuxfoundation.org/trademark-usage class=light-text>商标使用页面</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script src=/js/popper-1.16.1.min.js intregrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap-4.6.1.min.js integrity=sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2 crossorigin=anonymous></script>
<script src=/js/script.js></script>
<script async src=/js/mermaid-8.13.4.min.js integrity=sha384-5hHNvPeMrNH14oM3IcQofDoBhiclNK3g2+hnEinKzQ07C4AliMeVpnvxuiwEGpaO crossorigin=anonymous></script>
<script src=/js/main.min.5c0bf7f21dc4f66485f74efbbeeff28a7e4f8cddaac1bae47043159c922ff3a3.js integrity="sha256-XAv38h3E9mSF9077vu/yin5PjN2qwbrkcEMVnJIv86M=" crossorigin=anonymous></script></body></html>